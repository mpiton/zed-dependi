<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>:root {
  --color: black;
  --bg: white;
  --head-bg: white;
  --link: #338;

  --blue: #ccf;
  --red: #fcc;
  --yellow: #ffc;
  --green: #cfc;
}

[data-theme='dark'] {
  --color: white;
  --bg: black;
  --head-bg: #333;
  --link: #aaf;

  --blue: #225;
  --red: #522;
  --yellow: #552;
  --green: #252;
}

html,
body {
  margin: 0;
  padding: 0;
  color: var(--color);
  background: var(--bg);
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: var(--head-bg);
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: var(--blue);
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: var(--red);
}
.files-list__file_medium {
  background: var(--yellow);
}
.files-list__file_high {
  background: var(--green);
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg);
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: var(--link);
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
  content: counter(line);
  margin-right: 72px;
}
.code-line {
  margin: 0;
  height: 1em;
  counter-increment: line;

  position: absolute;
  padding: 0 0.3em 0.3em 0.3em;
  display: inherit;
  width: 100%;
}
.code-line_covered {
  background: var(--green);
}
.code-line_uncovered {
  background: var(--red);
}

.code-text-container {
  position: relative;
  height: 1em;
  padding: 0.3em 0;
}

.cover-indicator {
  display: flex;
  width: 100%;
  position: absolute;
  justify-content: end;
  height: 1em;
  align-items: center;
  padding: 0 0.3em 0.3em 0.3em;
}

.cover-indicator.check-cover::after {
  content: "\2713";
  font-weight: bold;
  background-color: var(--green);
  height: 1em;
}

.cover-indicator.no-cover::after {
  content: "\2716";
  font-weight: bold;
  background-color: var(--red);
  height: 1em;
}

.stat-line-hit {
  max-width: 48px;
  overflow: hidden;
  font-weight: bold;
  margin-right: 4px;
  background-color: var(--green);
  position: relative;
  top: 0.1em;
}

#theme-toggle-label {
  margin-left: 1ch;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","backend.rs"],"content":"use std::sync::{Arc, RwLock};\n\nuse dashmap::DashMap;\nuse reqwest::Client as HttpClient;\nuse tower_lsp::jsonrpc::Result;\nuse tower_lsp::lsp_types::*;\nuse tower_lsp::{Client, LanguageServer};\n\nuse crate::cache::{HybridCache, ReadCache, WriteCache};\nuse crate::config::Config;\nuse crate::document::DocumentState;\nuse crate::file_types::FileType;\nuse crate::parsers::Parser;\nuse crate::parsers::cargo::CargoParser;\nuse crate::parsers::csharp::CsharpParser;\nuse crate::parsers::dart::DartParser;\nuse crate::parsers::go::GoParser;\nuse crate::parsers::npm::NpmParser;\nuse crate::parsers::php::PhpParser;\nuse crate::parsers::python::PythonParser;\nuse crate::parsers::ruby::RubyParser;\nuse crate::providers::code_actions::create_code_actions;\nuse crate::providers::completion::{format_release_age, get_completions};\nuse crate::providers::diagnostics::create_diagnostics;\nuse crate::providers::inlay_hints::create_inlay_hint;\nuse crate::registries::crates_io::CratesIoRegistry;\nuse crate::registries::go_proxy::GoProxyRegistry;\nuse crate::registries::http_client::create_shared_client;\nuse crate::registries::npm::NpmRegistry;\nuse crate::registries::nuget::NuGetRegistry;\nuse crate::registries::packagist::PackagistRegistry;\nuse crate::registries::pub_dev::PubDevRegistry;\nuse crate::registries::pypi::PyPiRegistry;\nuse crate::registries::rubygems::RubyGemsRegistry;\nuse crate::registries::{Registry, VersionInfo, VulnerabilitySeverity};\nuse crate::reports::{VulnerabilityReportEntry, VulnerabilitySummary, generate_markdown_report};\nuse crate::vulnerabilities::VulnerabilityQuery;\nuse crate::vulnerabilities::cache::VulnerabilityCache;\nuse crate::vulnerabilities::osv::OsvClient;\n\npub struct DependiBackend {\n    client: Client,\n    /// Configuration\n    config: RwLock\u003cConfig\u003e,\n    /// Cache for documents and their parsed state\n    documents: DashMap\u003cUrl, DocumentState\u003e,\n    /// Cache for version information (keyed by \"registry:package\")\n    version_cache: Arc\u003cHybridCache\u003e,\n    /// Parsers\n    cargo_parser: CargoParser,\n    npm_parser: NpmParser,\n    python_parser: PythonParser,\n    go_parser: GoParser,\n    php_parser: PhpParser,\n    dart_parser: DartParser,\n    csharp_parser: CsharpParser,\n    ruby_parser: RubyParser,\n    /// Registry clients\n    crates_io: Arc\u003cCratesIoRegistry\u003e,\n    npm_registry: Arc\u003cNpmRegistry\u003e,\n    pypi: Arc\u003cPyPiRegistry\u003e,\n    go_proxy: Arc\u003cGoProxyRegistry\u003e,\n    packagist: Arc\u003cPackagistRegistry\u003e,\n    pub_dev: Arc\u003cPubDevRegistry\u003e,\n    nuget: Arc\u003cNuGetRegistry\u003e,\n    rubygems: Arc\u003cRubyGemsRegistry\u003e,\n    /// Vulnerability scanning\n    osv_client: Arc\u003cOsvClient\u003e,\n    vuln_cache: Arc\u003cVulnerabilityCache\u003e,\n}\n\nimpl DependiBackend {\n    /// Create a new DependiBackend with default configuration, parsers, registry clients,\n    /// caches, and an OSV client.\n    ///\n    /// The provided `client` is used for LSP communication. A shared HTTP client is created\n    /// internally and used to construct registry clients bound to that HTTP client.\n    ///\n    /// # Examples\n    ///\n    /// ```\n    /// // Obtain an LSP `Client` from the runtime environment and pass it in:\n    /// // let client = /* LSP client */ ;\n    /// // let backend = DependiBackend::new(client);\n    /// ```\n    pub fn new(client: Client) -\u003e Self {\n        Self::with_http_client(client, None)\n    }\n\n    pub fn with_http_client(client: Client, http_client: Option\u003cArc\u003cHttpClient\u003e\u003e) -\u003e Self {\n        let http_client = http_client.unwrap_or_else(|| {\n            create_shared_client().expect(\"Failed to create shared HTTP client\")\n        });\n\n        Self {\n            client,\n            config: RwLock::new(Config::default()),\n            documents: DashMap::new(),\n            version_cache: Arc::new(HybridCache::new()),\n            cargo_parser: CargoParser::new(),\n            npm_parser: NpmParser::new(),\n            python_parser: PythonParser::new(),\n            go_parser: GoParser::new(),\n            php_parser: PhpParser::new(),\n            dart_parser: DartParser::new(),\n            csharp_parser: CsharpParser::new(),\n            ruby_parser: RubyParser::new(),\n            crates_io: Arc::new(CratesIoRegistry::with_client(Arc::clone(\u0026http_client))),\n            npm_registry: Arc::new(NpmRegistry::with_client(Arc::clone(\u0026http_client))),\n            pypi: Arc::new(PyPiRegistry::with_client(Arc::clone(\u0026http_client))),\n            go_proxy: Arc::new(GoProxyRegistry::with_client(Arc::clone(\u0026http_client))),\n            packagist: Arc::new(PackagistRegistry::with_client(Arc::clone(\u0026http_client))),\n            pub_dev: Arc::new(PubDevRegistry::with_client(Arc::clone(\u0026http_client))),\n            nuget: Arc::new(NuGetRegistry::with_client(Arc::clone(\u0026http_client))),\n            rubygems: Arc::new(RubyGemsRegistry::with_client(http_client)),\n            osv_client: Arc::new(OsvClient::default()),\n            vuln_cache: Arc::new(VulnerabilityCache::new()),\n        }\n    }\n\n    fn parse_document(\u0026self, uri: \u0026Url, content: \u0026str) -\u003e Vec\u003ccrate::parsers::Dependency\u003e {\n        match FileType::detect(uri) {\n            Some(FileType::Cargo) =\u003e self.cargo_parser.parse(content),\n            Some(FileType::Npm) =\u003e self.npm_parser.parse(content),\n            Some(FileType::Python) =\u003e self.python_parser.parse(content),\n            Some(FileType::Go) =\u003e self.go_parser.parse(content),\n            Some(FileType::Php) =\u003e self.php_parser.parse(content),\n            Some(FileType::Dart) =\u003e self.dart_parser.parse(content),\n            Some(FileType::Csharp) =\u003e self.csharp_parser.parse(content),\n            Some(FileType::Ruby) =\u003e self.ruby_parser.parse(content),\n            None =\u003e vec![],\n        }\n    }\n\n    async fn get_version_info(\n        \u0026self,\n        file_type: FileType,\n        package_name: \u0026str,\n    ) -\u003e Option\u003cVersionInfo\u003e {\n        let cache_key = file_type.cache_key(package_name);\n\n        // Check cache first\n        if let Some(cached) = self.version_cache.get(\u0026cache_key) {\n            return Some(cached);\n        }\n\n        // Fetch from appropriate registry\n        let result = match file_type {\n            FileType::Cargo =\u003e self.crates_io.get_version_info(package_name).await,\n            FileType::Npm =\u003e self.npm_registry.get_version_info(package_name).await,\n            FileType::Python =\u003e self.pypi.get_version_info(package_name).await,\n            FileType::Go =\u003e self.go_proxy.get_version_info(package_name).await,\n            FileType::Php =\u003e self.packagist.get_version_info(package_name).await,\n            FileType::Dart =\u003e self.pub_dev.get_version_info(package_name).await,\n            FileType::Csharp =\u003e self.nuget.get_version_info(package_name).await,\n            FileType::Ruby =\u003e self.rubygems.get_version_info(package_name).await,\n        };\n\n        match result {\n            Ok(info) =\u003e {\n                self.version_cache.insert(cache_key, info.clone());\n                Some(info)\n            }\n            Err(e) =\u003e {\n                tracing::warn!(\"Failed to fetch version info for {}: {}\", package_name, e);\n                None\n            }\n        }\n    }\n\n    async fn fetch_vulnerabilities_background(\n        dependencies: Vec\u003ccrate::parsers::Dependency\u003e,\n        file_type: FileType,\n        cache: Arc\u003cHybridCache\u003e,\n        osv_client: Arc\u003cOsvClient\u003e,\n        vuln_cache: Arc\u003cVulnerabilityCache\u003e,\n        client: Client,\n    ) {\n        use crate::vulnerabilities::cache::VulnCacheKey;\n\n        let ecosystem = file_type.to_ecosystem();\n\n        // Build queries for packages not in vulnerability cache\n        let queries: Vec\u003cVulnerabilityQuery\u003e = dependencies\n            .iter()\n            .filter(|dep| {\n                let vuln_key = VulnCacheKey::new(ecosystem, \u0026dep.name, \u0026dep.version);\n                !vuln_cache.contains(\u0026vuln_key)\n            })\n            .map(|dep| VulnerabilityQuery {\n                ecosystem,\n                package_name: dep.name.clone(),\n                version: dep.version.clone(),\n            })\n            .collect();\n\n        if queries.is_empty() {\n            tracing::debug!(\"Background: All vulnerability info cached, skipping OSV query\");\n            return;\n        }\n\n        tracing::info!(\n            \"Background: Querying OSV.dev for {} packages\",\n            queries.len()\n        );\n\n        // Batch query OSV.dev\n        match osv_client.query_batch(\u0026queries).await {\n            Ok(results) =\u003e {\n                let mut updated_count = 0;\n\n                // Update vulnerability cache and version_cache with results\n                for (query, result) in queries.iter().zip(results.iter()) {\n                    // Mark this package as queried in vuln_cache\n                    let vuln_key =\n                        VulnCacheKey::new(ecosystem, \u0026query.package_name, \u0026query.version);\n                    vuln_cache.insert(vuln_key);\n\n                    // Store vulnerabilities and deprecated status in version_cache\n                    let cache_key = file_type.cache_key(\u0026query.package_name);\n                    if let Some(mut info) = cache.get(\u0026cache_key) {\n                        info.vulnerabilities = result.vulnerabilities.clone();\n                        info.deprecated = result.deprecated;\n                        if result.deprecated {\n                            tracing::info!(\n                                \"Background: Package {} {} is deprecated (unmaintained)\",\n                                query.package_name,\n                                query.version\n                            );\n                        }\n                        tracing::debug!(\n                            \"Background: Updated {} {} with {} vulnerabilities, deprecated={}\",\n                            query.package_name,\n                            query.version,\n                            result.vulnerabilities.len(),\n                            result.deprecated\n                        );\n                        cache.insert(cache_key, info);\n                        updated_count += 1;\n                    } else {\n                        tracing::warn!(\n                            \"Background: Could not update vulnerabilities for {}: not found in version cache\",\n                            query.package_name\n                        );\n                    }\n                }\n                tracing::info!(\n                    \"Background: Cached vulnerability info for {} packages\",\n                    updated_count\n                );\n\n                // Refresh UI with new vulnerability data\n                tracing::debug!(\"Background: Refreshing inlay hints after vulnerability check\");\n                client\n                    .send_request::\u003crequest::InlayHintRefreshRequest\u003e(())\n                    .await\n                    .ok();\n                client\n                    .send_request::\u003crequest::WorkspaceDiagnosticRefresh\u003e(())\n                    .await\n                    .ok();\n\n                tracing::info!(\"Background: Vulnerability check complete, UI updated\");\n            }\n            Err(e) =\u003e {\n                tracing::warn!(\n                    \"Background: Failed to fetch vulnerabilities from OSV.dev: {}\",\n                    e\n                );\n            }\n        }\n    }\n\n    async fn process_document(\u0026self, uri: \u0026Url, content: \u0026str) {\n        let Some(file_type) = FileType::detect(uri) else {\n            return;\n        };\n\n        let dependencies = self.parse_document(uri, content);\n\n        tracing::info!(\n            \"Parsed {} dependencies from {}\",\n            dependencies.len(),\n            uri.path()\n        );\n\n        // Clone Arc references for async tasks\n        let crates_io = Arc::clone(\u0026self.crates_io);\n        let npm_registry = Arc::clone(\u0026self.npm_registry);\n        let pypi = Arc::clone(\u0026self.pypi);\n        let go_proxy = Arc::clone(\u0026self.go_proxy);\n        let packagist = Arc::clone(\u0026self.packagist);\n        let pub_dev = Arc::clone(\u0026self.pub_dev);\n        let nuget = Arc::clone(\u0026self.nuget);\n        let rubygems = Arc::clone(\u0026self.rubygems);\n        let cache = Arc::clone(\u0026self.version_cache);\n\n        let fetch_tasks: Vec\u003c_\u003e = dependencies\n            .iter()\n            .map(|dep| {\n                let name = dep.name.clone();\n                let cache_key = file_type.cache_key(\u0026name);\n                let crates_io = Arc::clone(\u0026crates_io);\n                let npm_registry = Arc::clone(\u0026npm_registry);\n                let pypi = Arc::clone(\u0026pypi);\n                let go_proxy = Arc::clone(\u0026go_proxy);\n                let packagist = Arc::clone(\u0026packagist);\n                let pub_dev = Arc::clone(\u0026pub_dev);\n                let nuget = Arc::clone(\u0026nuget);\n                let rubygems = Arc::clone(\u0026rubygems);\n                let cache = Arc::clone(\u0026cache);\n                async move {\n                    // Check cache first\n                    if cache.get(\u0026cache_key).is_some() {\n                        return;\n                    }\n                    // Fetch from appropriate registry\n                    let result = match file_type {\n                        FileType::Cargo =\u003e crates_io.get_version_info(\u0026name).await,\n                        FileType::Npm =\u003e npm_registry.get_version_info(\u0026name).await,\n                        FileType::Python =\u003e pypi.get_version_info(\u0026name).await,\n                        FileType::Go =\u003e go_proxy.get_version_info(\u0026name).await,\n                        FileType::Php =\u003e packagist.get_version_info(\u0026name).await,\n                        FileType::Dart =\u003e pub_dev.get_version_info(\u0026name).await,\n                        FileType::Csharp =\u003e nuget.get_version_info(\u0026name).await,\n                        FileType::Ruby =\u003e rubygems.get_version_info(\u0026name).await,\n                    };\n                    if let Ok(info) = result {\n                        cache.insert(cache_key, info);\n                    }\n                }\n            })\n            .collect();\n\n        // Run up to 5 concurrent requests\n        let semaphore = Arc::new(tokio::sync::Semaphore::new(5));\n        let handles: Vec\u003c_\u003e = fetch_tasks\n            .into_iter()\n            .map(|task| {\n                let permit = Arc::clone(\u0026semaphore);\n                tokio::spawn(async move {\n                    let _permit = permit.acquire().await;\n                    task.await\n                })\n            })\n            .collect();\n\n        // Wait for all tasks to complete\n        for handle in handles {\n            let _ = handle.await;\n        }\n\n        // Store document state IMMEDIATELY (before vulnerability check)\n        self.documents.insert(\n            uri.clone(),\n            DocumentState {\n                dependencies: dependencies.clone(),\n                file_type,\n            },\n        );\n\n        // Publish diagnostics IMMEDIATELY (versions are available, vulnerabilities will update later)\n        let (diagnostics_enabled, security_show_diags, min_severity, security_enabled) = self\n            .config\n            .read()\n            .map(|c| {\n                (\n                    c.diagnostics.enabled,\n                    c.security.show_diagnostics,\n                    if c.security.show_diagnostics {\n                        Some(c.security.min_severity_level())\n                    } else {\n                        None\n                    },\n                    c.security.enabled,\n                )\n            })\n            .unwrap_or((true, true, None, true));\n\n        if diagnostics_enabled {\n            let severity_filter = if security_show_diags {\n                min_severity\n            } else {\n                None\n            };\n            let diagnostics = create_diagnostics(\n                \u0026dependencies,\n                \u0026self.version_cache,\n                |name| file_type.cache_key(name),\n                severity_filter,\n            );\n\n            self.client\n                .publish_diagnostics(uri.clone(), diagnostics, None)\n                .await;\n        }\n\n        // Refresh inlay hints IMMEDIATELY (versions are available)\n        self.client\n            .send_request::\u003crequest::InlayHintRefreshRequest\u003e(())\n            .await\n            .ok();\n\n        // Fetch vulnerabilities from OSV.dev in BACKGROUND (non-blocking)\n        if security_enabled \u0026\u0026 !dependencies.is_empty() {\n            let dependencies_clone = dependencies.clone();\n            let cache_clone = Arc::clone(\u0026self.version_cache);\n            let osv_client_clone = Arc::clone(\u0026self.osv_client);\n            let vuln_cache_clone = Arc::clone(\u0026self.vuln_cache);\n            let client_clone = self.client.clone();\n\n            tokio::spawn(async move {\n                Self::fetch_vulnerabilities_background(\n                    dependencies_clone,\n                    file_type,\n                    cache_clone,\n                    osv_client_clone,\n                    vuln_cache_clone,\n                    client_clone,\n                )\n                .await;\n            });\n        }\n    }\n\n    /// Generate a vulnerability report for a document\n    async fn generate_vulnerability_report(\n        \u0026self,\n        arguments: \u0026[serde_json::Value],\n    ) -\u003e serde_json::Value {\n        // Parse arguments\n        let format = arguments\n            .first()\n            .and_then(|v| v.get(\"format\"))\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"json\");\n\n        let uri_str = arguments\n            .first()\n            .and_then(|v| v.get(\"uri\"))\n            .and_then(|v| v.as_str());\n\n        // Find the document\n        let (uri, doc_state) = if let Some(uri_str) = uri_str {\n            if let Ok(uri) = Url::parse(uri_str) {\n                if let Some(doc) = self.documents.get(\u0026uri) {\n                    (uri.clone(), Some((doc.file_type, doc.dependencies.clone())))\n                } else {\n                    (uri, None)\n                }\n            } else {\n                return serde_json::json!({\n                    \"error\": \"Invalid URI format\"\n                });\n            }\n        } else {\n            // Use the first open document\n            if let Some(entry) = self.documents.iter().next() {\n                (\n                    entry.key().clone(),\n                    Some((entry.value().file_type, entry.value().dependencies.clone())),\n                )\n            } else {\n                return serde_json::json!({\n                    \"error\": \"No open documents\"\n                });\n            }\n        };\n\n        let Some((file_type, dependencies)) = doc_state else {\n            return serde_json::json!({\n                \"error\": \"Document not found or not yet processed\"\n            });\n        };\n\n        // Collect vulnerabilities from the version cache\n        let mut vulnerabilities: Vec\u003cVulnerabilityReportEntry\u003e = Vec::new();\n        let mut summary = VulnerabilitySummary::default();\n\n        for dep in \u0026dependencies {\n            let cache_key = file_type.cache_key(\u0026dep.name);\n            if let Some(info) = self.version_cache.get(\u0026cache_key) {\n                for vuln in \u0026info.vulnerabilities {\n                    summary.total += 1;\n                    match vuln.severity {\n                        VulnerabilitySeverity::Critical =\u003e summary.critical += 1,\n                        VulnerabilitySeverity::High =\u003e summary.high += 1,\n                        VulnerabilitySeverity::Medium =\u003e summary.medium += 1,\n                        VulnerabilitySeverity::Low =\u003e summary.low += 1,\n                    }\n\n                    vulnerabilities.push(VulnerabilityReportEntry {\n                        package: dep.name.clone(),\n                        version: dep.version.clone(),\n                        id: vuln.id.clone(),\n                        severity: format!(\"{:?}\", vuln.severity).to_lowercase(),\n                        description: vuln.description.clone(),\n                        url: vuln.url.clone(),\n                    });\n                }\n            }\n        }\n\n        // Generate report based on format\n        match format {\n            \"markdown\" =\u003e {\n                let md = generate_markdown_report(\u0026uri, \u0026summary, \u0026vulnerabilities);\n                serde_json::json!({\n                    \"format\": \"markdown\",\n                    \"content\": md\n                })\n            }\n            _ =\u003e {\n                // Default to JSON\n                serde_json::json!({\n                    \"summary\": summary,\n                    \"vulnerabilities\": vulnerabilities,\n                    \"file\": uri.to_string()\n                })\n            }\n        }\n    }\n}\n\n#[tower_lsp::async_trait]\nimpl LanguageServer for DependiBackend {\n    async fn initialize(\u0026self, params: InitializeParams) -\u003e Result\u003cInitializeResult\u003e {\n        // Parse configuration from initialization options\n        let config = Config::from_init_options(params.initialization_options);\n        tracing::info!(\"Configuration: {:?}\", config);\n\n        // Store the configuration\n        if let Ok(mut cfg) = self.config.write() {\n            *cfg = config;\n        }\n\n        Ok(InitializeResult {\n            server_info: Some(ServerInfo {\n                name: \"dependi-lsp\".to_string(),\n                version: Some(env!(\"CARGO_PKG_VERSION\").to_string()),\n            }),\n            capabilities: ServerCapabilities {\n                text_document_sync: Some(TextDocumentSyncCapability::Kind(\n                    TextDocumentSyncKind::FULL,\n                )),\n                inlay_hint_provider: Some(OneOf::Left(true)),\n                hover_provider: Some(HoverProviderCapability::Simple(true)),\n                code_action_provider: Some(CodeActionProviderCapability::Simple(true)),\n                completion_provider: Some(CompletionOptions {\n                    trigger_characters: Some(vec![\"\\\"\".to_string(), \"=\".to_string()]),\n                    ..Default::default()\n                }),\n                execute_command_provider: Some(ExecuteCommandOptions {\n                    commands: vec![\"dependi/generateReport\".to_string()],\n                    ..Default::default()\n                }),\n                ..Default::default()\n            },\n        })\n    }\n\n    async fn initialized(\u0026self, _: InitializedParams) {\n        self.client\n            .log_message(MessageType::INFO, \"Dependi LSP initialized\")\n            .await;\n\n        // Verify all registries share the same HTTP client\n        let base_client = self.crates_io.http_client();\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.npm_registry.http_client()));\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.pypi.http_client()));\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.go_proxy.http_client()));\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.packagist.http_client()));\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.pub_dev.http_client()));\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.nuget.http_client()));\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.rubygems.http_client()));\n\n        tracing::info!(\"Dependi LSP initialized\");\n    }\n\n    async fn shutdown(\u0026self) -\u003e Result\u003c()\u003e {\n        tracing::info!(\"Dependi LSP shutting down\");\n        Ok(())\n    }\n\n    async fn did_open(\u0026self, params: DidOpenTextDocumentParams) {\n        let uri = params.text_document.uri;\n        let content = params.text_document.text;\n\n        tracing::debug!(\"Document opened: {}\", uri);\n        self.process_document(\u0026uri, \u0026content).await;\n    }\n\n    async fn did_change(\u0026self, params: DidChangeTextDocumentParams) {\n        let uri = params.text_document.uri;\n\n        // With FULL sync, we get the entire document content\n        if let Some(change) = params.content_changes.into_iter().next() {\n            tracing::debug!(\"Document changed: {}\", uri);\n            self.process_document(\u0026uri, \u0026change.text).await;\n        }\n    }\n\n    async fn did_save(\u0026self, params: DidSaveTextDocumentParams) {\n        let uri = params.text_document.uri;\n\n        // Re-process on save if we have the text\n        if let Some(text) = params.text {\n            tracing::debug!(\"Document saved: {}\", uri);\n            self.process_document(\u0026uri, \u0026text).await;\n        }\n    }\n\n    async fn did_close(\u0026self, params: DidCloseTextDocumentParams) {\n        let uri = params.text_document.uri;\n        tracing::debug!(\"Document closed: {}\", uri);\n        self.documents.remove(\u0026uri);\n\n        // Clear diagnostics for this document\n        self.client.publish_diagnostics(uri, vec![], None).await;\n    }\n\n    async fn inlay_hint(\u0026self, params: InlayHintParams) -\u003e Result\u003cOption\u003cVec\u003cInlayHint\u003e\u003e\u003e {\n        // Check if inlay hints are enabled\n        let config = self.config.read().unwrap();\n        if !config.inlay_hints.enabled {\n            return Ok(Some(vec![]));\n        }\n        let show_up_to_date = config.inlay_hints.show_up_to_date;\n        let ignored_packages = config.ignore.clone();\n        drop(config);\n\n        let uri = \u0026params.text_document.uri;\n\n        let Some(doc) = self.documents.get(uri) else {\n            return Ok(Some(vec![]));\n        };\n\n        let file_type = doc.file_type;\n        let hints: Vec\u003cInlayHint\u003e = doc\n            .dependencies\n            .iter()\n            .filter(|dep| {\n                // Only show hints for dependencies in the visible range\n                let line = dep.line;\n                line \u003e= params.range.start.line \u0026\u0026 line \u003c= params.range.end.line\n            })\n            .filter(|dep| {\n                // Skip ignored packages\n                !ignored_packages.iter().any(|pattern| {\n                    if pattern.contains('*') {\n                        let parts: Vec\u003c\u0026str\u003e = pattern.split('*').collect();\n                        if parts.len() == 2 {\n                            dep.name.starts_with(parts[0]) \u0026\u0026 dep.name.ends_with(parts[1])\n                        } else {\n                            dep.name.starts_with(parts[0])\n                        }\n                    } else {\n                        dep.name == *pattern\n                    }\n                })\n            })\n            .filter_map(|dep| {\n                let cache_key = file_type.cache_key(\u0026dep.name);\n                let version_info = self.version_cache.get(\u0026cache_key);\n                let hint = create_inlay_hint(dep, version_info.as_ref());\n\n                // Optionally filter out up-to-date hints\n                if !show_up_to_date {\n                    let label_text = match \u0026hint.label {\n                        InlayHintLabel::String(s) =\u003e s.clone(),\n                        InlayHintLabel::LabelParts(parts) =\u003e {\n                            parts.iter().map(|p| p.value.as_str()).collect()\n                        }\n                    };\n                    if label_text.contains(\"[OK]\") {\n                        return None;\n                    }\n                }\n                Some(hint)\n            })\n            .collect();\n\n        tracing::debug!(\"Returning {} inlay hints for {}\", hints.len(), uri);\n        Ok(Some(hints))\n    }\n\n    async fn hover(\u0026self, params: HoverParams) -\u003e Result\u003cOption\u003cHover\u003e\u003e {\n        let uri = \u0026params.text_document_position_params.text_document.uri;\n        let position = params.text_document_position_params.position;\n\n        let Some(doc) = self.documents.get(uri) else {\n            return Ok(None);\n        };\n\n        let file_type = doc.file_type;\n\n        // Find dependency at this position\n        let dep = doc.dependencies.iter().find(|d| {\n            d.line == position.line\n                \u0026\u0026 position.character \u003e= d.name_start\n                \u0026\u0026 position.character \u003c= d.version_end\n        });\n\n        let Some(dep) = dep.cloned() else {\n            return Ok(None);\n        };\n\n        // Drop the lock before async call\n        drop(doc);\n\n        // Get version info\n        let version_info = self.get_version_info(file_type, \u0026dep.name).await;\n\n        let content = match version_info {\n            Some(info) =\u003e {\n                let mut parts = vec![format!(\"## {}\\n\", dep.name)];\n\n                if let Some(desc) = \u0026info.description {\n                    parts.push(format!(\"{}\\n\", desc));\n                }\n\n                // Current version with release date\n                let current_date_str = info\n                    .get_release_date(\u0026dep.version)\n                    .map(|dt| format!(\" ({})\", format_release_age(dt)))\n                    .unwrap_or_default();\n                parts.push(format!(\"**Current:** {}{}\", dep.version, current_date_str));\n\n                if let Some(latest) = \u0026info.latest {\n                    let latest_date_str = info\n                        .get_release_date(latest)\n                        .map(|dt| format!(\" ({})\", format_release_age(dt)))\n                        .unwrap_or_default();\n                    parts.push(format!(\"**Latest:** {}{}\", latest, latest_date_str));\n                }\n\n                if let Some(license) = \u0026info.license {\n                    parts.push(format!(\"**License:** {}\", license));\n                }\n\n                if let Some(repo) = \u0026info.repository {\n                    parts.push(format!(\"\\n[Repository]({})\", repo));\n                }\n\n                if let Some(homepage) = \u0026info.homepage {\n                    parts.push(format!(\"[Homepage]({})\", homepage));\n                }\n\n                // Add vulnerability information if present\n                if !info.vulnerabilities.is_empty() {\n                    parts.push(format!(\n                        \"\\n### ⚠ {} Security {}\",\n                        info.vulnerabilities.len(),\n                        if info.vulnerabilities.len() == 1 {\n                            \"Vulnerability\"\n                        } else {\n                            \"Vulnerabilities\"\n                        }\n                    ));\n\n                    for vuln in \u0026info.vulnerabilities {\n                        let severity_icon = match vuln.severity {\n                            VulnerabilitySeverity::Critical =\u003e \"⚠\",\n                            VulnerabilitySeverity::High =\u003e \"▲\",\n                            VulnerabilitySeverity::Medium =\u003e \"●\",\n                            VulnerabilitySeverity::Low =\u003e \"○\",\n                        };\n                        let severity_str = match vuln.severity {\n                            VulnerabilitySeverity::Critical =\u003e \"CRITICAL\",\n                            VulnerabilitySeverity::High =\u003e \"HIGH\",\n                            VulnerabilitySeverity::Medium =\u003e \"MEDIUM\",\n                            VulnerabilitySeverity::Low =\u003e \"LOW\",\n                        };\n\n                        if let Some(url) = \u0026vuln.url {\n                            parts.push(format!(\n                                \"\\n#### [{}]({}) - {} {}\",\n                                vuln.id, url, severity_icon, severity_str\n                            ));\n                        } else {\n                            parts.push(format!(\n                                \"\\n#### {} - {} {}\",\n                                vuln.id, severity_icon, severity_str\n                            ));\n                        }\n                        parts.push(vuln.description.clone());\n                    }\n                }\n\n                parts.join(\"\\n\")\n            }\n            None =\u003e format!(\"## {}\\n\\nCould not fetch package information.\", dep.name),\n        };\n\n        Ok(Some(Hover {\n            contents: HoverContents::Markup(MarkupContent {\n                kind: MarkupKind::Markdown,\n                value: content,\n            }),\n            range: Some(Range {\n                start: Position {\n                    line: dep.line,\n                    character: dep.name_start,\n                },\n                end: Position {\n                    line: dep.line,\n                    character: dep.version_end,\n                },\n            }),\n        }))\n    }\n\n    async fn code_action(\u0026self, params: CodeActionParams) -\u003e Result\u003cOption\u003cCodeActionResponse\u003e\u003e {\n        let uri = \u0026params.text_document.uri;\n\n        let Some(doc) = self.documents.get(uri) else {\n            return Ok(Some(vec![]));\n        };\n\n        let file_type = doc.file_type;\n        let actions = create_code_actions(\n            \u0026doc.dependencies,\n            \u0026self.version_cache,\n            uri,\n            params.range,\n            file_type,\n            |name| file_type.cache_key(name),\n        );\n\n        Ok(Some(actions))\n    }\n\n    async fn completion(\u0026self, params: CompletionParams) -\u003e Result\u003cOption\u003cCompletionResponse\u003e\u003e {\n        let uri = \u0026params.text_document_position.text_document.uri;\n        let position = params.text_document_position.position;\n\n        let Some(doc) = self.documents.get(uri) else {\n            return Ok(Some(CompletionResponse::Array(vec![])));\n        };\n\n        let file_type = doc.file_type;\n        let completions =\n            get_completions(\u0026doc.dependencies, position, \u0026self.version_cache, |name| {\n                file_type.cache_key(name)\n            });\n\n        match completions {\n            Some(items) =\u003e Ok(Some(CompletionResponse::Array(items))),\n            None =\u003e Ok(Some(CompletionResponse::Array(vec![]))),\n        }\n    }\n\n    async fn execute_command(\n        \u0026self,\n        params: ExecuteCommandParams,\n    ) -\u003e Result\u003cOption\u003cserde_json::Value\u003e\u003e {\n        match params.command.as_str() {\n            \"dependi/generateReport\" =\u003e {\n                let report = self.generate_vulnerability_report(\u0026params.arguments).await;\n                Ok(Some(report))\n            }\n            _ =\u003e {\n                tracing::warn!(\"Unknown command: {}\", params.command);\n                Ok(None)\n            }\n        }\n    }\n}\n","traces":[{"line":86,"address":[14433952],"length":1,"stats":{"Line":0}},{"line":87,"address":[13104545],"length":1,"stats":{"Line":0}},{"line":90,"address":[13102528,13104286,13104324],"length":1,"stats":{"Line":0}},{"line":91,"address":[17181721,17181626],"length":1,"stats":{"Line":0}},{"line":92,"address":[13729457],"length":1,"stats":{"Line":0}},{"line":97,"address":[17181769,17181836],"length":1,"stats":{"Line":0}},{"line":98,"address":[14432011],"length":1,"stats":{"Line":0}},{"line":99,"address":[17181903,17181955],"length":1,"stats":{"Line":0}},{"line":100,"address":[13102946],"length":1,"stats":{"Line":0}},{"line":101,"address":[17182030],"length":1,"stats":{"Line":0}},{"line":102,"address":[14432237],"length":1,"stats":{"Line":0}},{"line":103,"address":[17182044],"length":1,"stats":{"Line":0}},{"line":104,"address":[14450547],"length":1,"stats":{"Line":0}},{"line":105,"address":[17182058],"length":1,"stats":{"Line":0}},{"line":106,"address":[13103025],"length":1,"stats":{"Line":0}},{"line":107,"address":[14432292],"length":1,"stats":{"Line":0}},{"line":108,"address":[14450591],"length":1,"stats":{"Line":0}},{"line":109,"address":[14432473,14432400],"length":1,"stats":{"Line":0}},{"line":110,"address":[14432529,14432602],"length":1,"stats":{"Line":0}},{"line":111,"address":[14432658,14432731],"length":1,"stats":{"Line":0}},{"line":112,"address":[14432787,14432860],"length":1,"stats":{"Line":0}},{"line":113,"address":[17182677,17182615],"length":1,"stats":{"Line":0}},{"line":114,"address":[17182725,17182787],"length":1,"stats":{"Line":0}},{"line":115,"address":[13103866,13103787],"length":1,"stats":{"Line":0}},{"line":116,"address":[13103899,13103951],"length":1,"stats":{"Line":0}},{"line":117,"address":[14433447,14433387],"length":1,"stats":{"Line":0}},{"line":121,"address":[14431168],"length":1,"stats":{"Line":0}},{"line":122,"address":[17181070,17181154],"length":1,"stats":{"Line":0}},{"line":123,"address":[13102136],"length":1,"stats":{"Line":0}},{"line":124,"address":[17181210],"length":1,"stats":{"Line":0}},{"line":125,"address":[14431408],"length":1,"stats":{"Line":0}},{"line":126,"address":[14449731],"length":1,"stats":{"Line":0}},{"line":127,"address":[14449769],"length":1,"stats":{"Line":0}},{"line":128,"address":[14449807],"length":1,"stats":{"Line":0}},{"line":129,"address":[14431557],"length":1,"stats":{"Line":0}},{"line":130,"address":[14431595],"length":1,"stats":{"Line":0}},{"line":131,"address":[13102099],"length":1,"stats":{"Line":0}},{"line":135,"address":[14431616],"length":1,"stats":{"Line":0}},{"line":140,"address":[18586092,18586365],"length":1,"stats":{"Line":0}},{"line":143,"address":[14236274,14236165],"length":1,"stats":{"Line":0}},{"line":144,"address":[14254704],"length":1,"stats":{"Line":0}},{"line":148,"address":[18586648],"length":1,"stats":{"Line":0}},{"line":149,"address":[14236557,14236869,14235942,14237951],"length":1,"stats":{"Line":0}},{"line":150,"address":[18586167,18586791,18587158,18588343],"length":1,"stats":{"Line":0}},{"line":151,"address":[12463559],"length":1,"stats":{"Line":0}},{"line":152,"address":[12463578],"length":1,"stats":{"Line":0}},{"line":153,"address":[14255689,14254997,14257420,14254314],"length":1,"stats":{"Line":0}},{"line":154,"address":[14237534,14236047,14236747,14239415],"length":1,"stats":{"Line":0}},{"line":155,"address":[14254356,14255073,14255955,14257980],"length":1,"stats":{"Line":0}},{"line":156,"address":[12771362],"length":1,"stats":{"Line":0}},{"line":159,"address":[14256511],"length":1,"stats":{"Line":0}},{"line":160,"address":[14258579],"length":1,"stats":{"Line":0}},{"line":161,"address":[18590346,18590282,18590506,18590532],"length":1,"stats":{"Line":0}},{"line":162,"address":[14258747],"length":1,"stats":{"Line":0}},{"line":164,"address":[14258502],"length":1,"stats":{"Line":0}},{"line":165,"address":[14240230,14240894,14240631],"length":1,"stats":{"Line":0}},{"line":166,"address":[13713728],"length":1,"stats":{"Line":0}},{"line":171,"address":[13104416],"length":1,"stats":{"Line":0}},{"line":181,"address":[14266436,14266234],"length":1,"stats":{"Line":0}},{"line":184,"address":[14266438,14266619],"length":1,"stats":{"Line":0}},{"line":186,"address":[14294752,14284824,14294990,14294984],"length":1,"stats":{"Line":0}},{"line":187,"address":[13747582],"length":1,"stats":{"Line":0}},{"line":188,"address":[13747662,13747722],"length":1,"stats":{"Line":0}},{"line":190,"address":[14266577,14276324,14276192,14276385,14276391],"length":1,"stats":{"Line":0}},{"line":191,"address":[18625316],"length":1,"stats":{"Line":0}},{"line":192,"address":[13747933],"length":1,"stats":{"Line":0}},{"line":193,"address":[13747962],"length":1,"stats":{"Line":0}},{"line":197,"address":[18615442,18615511],"length":1,"stats":{"Line":0}},{"line":198,"address":[14285881,14286172,14285049],"length":1,"stats":{"Line":0}},{"line":202,"address":[18615931],"length":1,"stats":{"Line":0}},{"line":208,"address":[12470203],"length":1,"stats":{"Line":0}},{"line":209,"address":[18617559],"length":1,"stats":{"Line":0}},{"line":210,"address":[18617587],"length":1,"stats":{"Line":0}},{"line":213,"address":[13740493,13740583,13745689],"length":1,"stats":{"Line":0}},{"line":215,"address":[14270713,14269393],"length":1,"stats":{"Line":0}},{"line":217,"address":[14289105,14289177],"length":1,"stats":{"Line":0}},{"line":220,"address":[13742544,13742638],"length":1,"stats":{"Line":0}},{"line":221,"address":[18621901,18619892,18619776],"length":1,"stats":{"Line":0}},{"line":222,"address":[14289744,14289634,14289725],"length":1,"stats":{"Line":0}},{"line":223,"address":[13743132],"length":1,"stats":{"Line":0}},{"line":224,"address":[13743145],"length":1,"stats":{"Line":0}},{"line":225,"address":[18620286],"length":1,"stats":{"Line":0}},{"line":231,"address":[14272775],"length":1,"stats":{"Line":0}},{"line":238,"address":[14290846],"length":1,"stats":{"Line":0}},{"line":239,"address":[14291571,14291512],"length":1,"stats":{"Line":0}},{"line":241,"address":[18620005,18622266],"length":1,"stats":{"Line":0}},{"line":247,"address":[14269763,14269432],"length":1,"stats":{"Line":0}},{"line":253,"address":[14269732,14270039,14270338],"length":1,"stats":{"Line":0}},{"line":254,"address":[14288864,14293275,14288600],"length":1,"stats":{"Line":0}},{"line":255,"address":[13741880],"length":1,"stats":{"Line":0}},{"line":256,"address":[12470225],"length":1,"stats":{"Line":0}},{"line":258,"address":[14275170,14275385,14275112],"length":1,"stats":{"Line":0}},{"line":259,"address":[14275116],"length":1,"stats":{"Line":0}},{"line":260,"address":[18624053,18623791,18615164,18623822,18623723],"length":1,"stats":{"Line":0}},{"line":263,"address":[13747259,13746982],"length":1,"stats":{"Line":0}},{"line":265,"address":[18617505],"length":1,"stats":{"Line":0}},{"line":266,"address":[14274549,14268816,14274304],"length":1,"stats":{"Line":0}},{"line":274,"address":[18594265,18591501,18591280,18595725,18591316,18591565,18591594,18591544],"length":1,"stats":{"Line":0}},{"line":275,"address":[14259816,14259983],"length":1,"stats":{"Line":0}},{"line":279,"address":[18591714],"length":1,"stats":{"Line":0}},{"line":281,"address":[18592224],"length":1,"stats":{"Line":0}},{"line":288,"address":[14242655,14242150],"length":1,"stats":{"Line":0}},{"line":289,"address":[13715482,13715585],"length":1,"stats":{"Line":0}},{"line":290,"address":[14261060,14261171],"length":1,"stats":{"Line":0}},{"line":291,"address":[13715791,13715691],"length":1,"stats":{"Line":0}},{"line":292,"address":[14243000,14243111],"length":1,"stats":{"Line":0}},{"line":293,"address":[14243114,14243225],"length":1,"stats":{"Line":0}},{"line":294,"address":[14261516,14261627],"length":1,"stats":{"Line":0}},{"line":295,"address":[14243453,14243342],"length":1,"stats":{"Line":0}},{"line":296,"address":[14243567,14243456],"length":1,"stats":{"Line":0}},{"line":298,"address":[14261858],"length":1,"stats":{"Line":0}},{"line":300,"address":[13720288,13716447,13721340,13721334],"length":1,"stats":{"Line":0}},{"line":301,"address":[18597779],"length":1,"stats":{"Line":0}},{"line":302,"address":[18597811,18597907],"length":1,"stats":{"Line":0}},{"line":303,"address":[14248072,14247998],"length":1,"stats":{"Line":0}},{"line":304,"address":[14248080,14248151],"length":1,"stats":{"Line":0}},{"line":305,"address":[14248230,14248159],"length":1,"stats":{"Line":0}},{"line":306,"address":[14248309,14248238],"length":1,"stats":{"Line":0}},{"line":307,"address":[14266676,14266605],"length":1,"stats":{"Line":0}},{"line":308,"address":[13720849,13720912],"length":1,"stats":{"Line":0}},{"line":309,"address":[14248475,14248546],"length":1,"stats":{"Line":0}},{"line":310,"address":[14266842,14266913],"length":1,"stats":{"Line":0}},{"line":311,"address":[14248633,14248714],"length":1,"stats":{"Line":0}},{"line":312,"address":[13723795,13726203,13726279,13721143,13723669,13723690,13723531,13723711,13723753,13723440,13723732,13723774,13723626],"length":1,"stats":{"Line":0}},{"line":314,"address":[14268521,14268832],"length":1,"stats":{"Line":0}},{"line":318,"address":[14250695],"length":1,"stats":{"Line":0}},{"line":319,"address":[18602463,18600440,18600200,18599800],"length":1,"stats":{"Line":0}},{"line":320,"address":[18600600,18600230,18602765,18599821],"length":1,"stats":{"Line":0}},{"line":321,"address":[14250354,14253783,14250807,14251355],"length":1,"stats":{"Line":0}},{"line":322,"address":[18603283,18599863,18600290,18600920],"length":1,"stats":{"Line":0}},{"line":323,"address":[18599884,18601080,18600320,18603524],"length":1,"stats":{"Line":0}},{"line":324,"address":[14250909,14254560,14251871,14250417],"length":1,"stats":{"Line":0}},{"line":325,"address":[14254813,14250438,14250943,14252043],"length":1,"stats":{"Line":0}},{"line":326,"address":[14250977,14250459,14252215,14255066],"length":1,"stats":{"Line":0}},{"line":328,"address":[14253458,14255478,14255311],"length":1,"stats":{"Line":0}},{"line":329,"address":[14273650],"length":1,"stats":{"Line":0}},{"line":336,"address":[18593762,18593849],"length":1,"stats":{"Line":0}},{"line":337,"address":[18593911],"length":1,"stats":{"Line":0}},{"line":339,"address":[14268371,14268342,14262505,14268144],"length":1,"stats":{"Line":0}},{"line":340,"address":[14268164,14268247],"length":1,"stats":{"Line":0}},{"line":341,"address":[13721471,13722480,13722582,13723338,13722777,13722505,13722619,13723140],"length":1,"stats":{"Line":0}},{"line":342,"address":[13722808,13722687,13722545,13722609],"length":1,"stats":{"Line":0}},{"line":343,"address":[12798048],"length":1,"stats":{"Line":0}},{"line":349,"address":[14263149,14262563,14262666],"length":1,"stats":{"Line":0}},{"line":350,"address":[14259871,14262825,14263205,14263103,14264296,14262791],"length":1,"stats":{"Line":0}},{"line":354,"address":[18594754,18594944,18594746],"length":1,"stats":{"Line":0}},{"line":355,"address":[13717717,13717667,13717646],"length":1,"stats":{"Line":0}},{"line":356,"address":[13717801],"length":1,"stats":{"Line":0}},{"line":357,"address":[14245053],"length":1,"stats":{"Line":0}},{"line":358,"address":[13717795],"length":1,"stats":{"Line":0}},{"line":363,"address":[14263627,14263683,14263538],"length":1,"stats":{"Line":0}},{"line":366,"address":[18597659,18595056,18597653,18597392],"length":1,"stats":{"Line":0}},{"line":368,"address":[14267246,14267307],"length":1,"stats":{"Line":0}},{"line":369,"address":[18597471],"length":1,"stats":{"Line":0}},{"line":370,"address":[14249168,14249059,14249096],"length":1,"stats":{"Line":0}},{"line":371,"address":[18597535,18597569],"length":1,"stats":{"Line":0}},{"line":373,"address":[14267379],"length":1,"stats":{"Line":0}},{"line":375,"address":[18597552,18597603],"length":1,"stats":{"Line":0}},{"line":378,"address":[14245307,14245360],"length":1,"stats":{"Line":0}},{"line":380,"address":[18595946,18595242],"length":1,"stats":{"Line":0}},{"line":381,"address":[13718194,13718180],"length":1,"stats":{"Line":0}},{"line":382,"address":[14263840],"length":1,"stats":{"Line":0}},{"line":384,"address":[18595290],"length":1,"stats":{"Line":0}},{"line":387,"address":[18595319],"length":1,"stats":{"Line":0}},{"line":388,"address":[13718296],"length":1,"stats":{"Line":0}},{"line":389,"address":[14249264,14245660,14249291],"length":1,"stats":{"Line":0}},{"line":393,"address":[18595454,18595651],"length":1,"stats":{"Line":0}},{"line":394,"address":[13718359,13718439],"length":1,"stats":{"Line":0}},{"line":395,"address":[14241604,14245944,14246028,14245876],"length":1,"stats":{"Line":0}},{"line":399,"address":[13718882,13718150,13719124],"length":1,"stats":{"Line":0}},{"line":400,"address":[14245506],"length":1,"stats":{"Line":0}},{"line":401,"address":[12721749],"length":1,"stats":{"Line":0}},{"line":405,"address":[14246625],"length":1,"stats":{"Line":0}},{"line":406,"address":[18596466,18596404],"length":1,"stats":{"Line":0}},{"line":407,"address":[14265046,14265129],"length":1,"stats":{"Line":0}},{"line":408,"address":[14265228,14265145],"length":1,"stats":{"Line":0}},{"line":409,"address":[18596743,18596664],"length":1,"stats":{"Line":0}},{"line":410,"address":[13719722,13719655],"length":1,"stats":{"Line":0}},{"line":412,"address":[18599027,18599134,18599333,18596834,18598988,18598873,18598848],"length":1,"stats":{"Line":0}},{"line":413,"address":[14267870,14267720],"length":1,"stats":{"Line":0}},{"line":414,"address":[18598913],"length":1,"stats":{"Line":0}},{"line":416,"address":[13722024],"length":1,"stats":{"Line":0}},{"line":417,"address":[18598940],"length":1,"stats":{"Line":0}},{"line":418,"address":[14267712],"length":1,"stats":{"Line":0}},{"line":419,"address":[14249428],"length":1,"stats":{"Line":0}},{"line":421,"address":[13722206,13722170,13722103,13722253],"length":1,"stats":{"Line":0}},{"line":427,"address":[13104368],"length":1,"stats":{"Line":0}},{"line":432,"address":[14258073],"length":1,"stats":{"Line":0}},{"line":434,"address":[14284313,14284304,14276220],"length":1,"stats":{"Line":0}},{"line":435,"address":[18614736,18614745,18606959],"length":1,"stats":{"Line":0}},{"line":438,"address":[18607192],"length":1,"stats":{"Line":0}},{"line":440,"address":[18614841,18614832,18607130],"length":1,"stats":{"Line":0}},{"line":441,"address":[13737737,13730049,13737728],"length":1,"stats":{"Line":0}},{"line":444,"address":[13731101,13731157,13730104],"length":1,"stats":{"Line":0}},{"line":445,"address":[18607379,18607316,18607279],"length":1,"stats":{"Line":0}},{"line":446,"address":[14258503,14258578],"length":1,"stats":{"Line":0}},{"line":447,"address":[14276945,14277146],"length":1,"stats":{"Line":0}},{"line":449,"address":[13730539],"length":1,"stats":{"Line":0}},{"line":452,"address":[13730257,13731339,13731301,13731404,13731784],"length":1,"stats":{"Line":0}},{"line":458,"address":[18607294,18608983,18608936],"length":1,"stats":{"Line":0}},{"line":460,"address":[14278499,14278390],"length":1,"stats":{"Line":0}},{"line":461,"address":[14260294,14260218],"length":1,"stats":{"Line":0}},{"line":464,"address":[14265490,14265445,14265559],"length":1,"stats":{"Line":0}},{"line":470,"address":[13731255,13732413],"length":1,"stats":{"Line":0}},{"line":471,"address":[14278981,14283270,14283232,14283339,14283634],"length":1,"stats":{"Line":0}},{"line":477,"address":[13732482],"length":1,"stats":{"Line":0}},{"line":478,"address":[13732555],"length":1,"stats":{"Line":0}},{"line":480,"address":[13732607],"length":1,"stats":{"Line":0}},{"line":481,"address":[14263229,14260968],"length":1,"stats":{"Line":0}},{"line":482,"address":[18612216,18612115],"length":1,"stats":{"Line":0}},{"line":483,"address":[14263438,14263543],"length":1,"stats":{"Line":0}},{"line":484,"address":[14282026,14281936,14281989],"length":1,"stats":{"Line":0}},{"line":485,"address":[14263708],"length":1,"stats":{"Line":0}},{"line":486,"address":[13735726,13735564],"length":1,"stats":{"Line":0}},{"line":487,"address":[18612796,18612642],"length":1,"stats":{"Line":0}},{"line":488,"address":[14282214,14282068],"length":1,"stats":{"Line":0}},{"line":489,"address":[14282153,14282046],"length":1,"stats":{"Line":0}},{"line":492,"address":[13736308],"length":1,"stats":{"Line":0}},{"line":493,"address":[13735635],"length":1,"stats":{"Line":0}},{"line":494,"address":[14264032],"length":1,"stats":{"Line":0}},{"line":495,"address":[18612940],"length":1,"stats":{"Line":0}},{"line":496,"address":[18613005,18613255,18613076],"length":1,"stats":{"Line":0}},{"line":497,"address":[18613279],"length":1,"stats":{"Line":0}},{"line":498,"address":[18613348],"length":1,"stats":{"Line":0}},{"line":506,"address":[14279298],"length":1,"stats":{"Line":0}},{"line":507,"address":[14280549,14279352],"length":1,"stats":{"Line":0}},{"line":508,"address":[18611326,18611261,18611172,18611223,18611557,18611624,18612012],"length":1,"stats":{"Line":0}},{"line":515,"address":[14279345,14279384,14279422,14279492,14279720,14279971,14280112,14279787,14280041,14280450],"length":1,"stats":{"Line":0}},{"line":518,"address":[18610622],"length":1,"stats":{"Line":0}},{"line":527,"address":[14286346,14281243,14286188,14280973,14281363,14286529,14286286,14280896,14282645,14281103,14286226,14281221,14286406,14286466,14281470,14287101],"length":1,"stats":{"Line":0}},{"line":529,"address":[18629958,18629741],"length":1,"stats":{"Line":0}},{"line":530,"address":[13752862,13753182,13752929],"length":1,"stats":{"Line":0}},{"line":533,"address":[14282129,14281817,14282092],"length":1,"stats":{"Line":0}},{"line":534,"address":[18630595,18631044,18630769,18631013,18630711],"length":1,"stats":{"Line":0}},{"line":537,"address":[14285743],"length":1,"stats":{"Line":0}},{"line":538,"address":[14282799],"length":1,"stats":{"Line":0}},{"line":539,"address":[13753878],"length":1,"stats":{"Line":0}},{"line":540,"address":[14282692,14282767],"length":1,"stats":{"Line":0}},{"line":542,"address":[14284331],"length":1,"stats":{"Line":0}},{"line":543,"address":[14301199],"length":1,"stats":{"Line":0}},{"line":546,"address":[13754243],"length":1,"stats":{"Line":0}},{"line":548,"address":[13754333],"length":1,"stats":{"Line":0}},{"line":549,"address":[14301914],"length":1,"stats":{"Line":0}},{"line":550,"address":[18631929,18631505,18631566,18635311],"length":1,"stats":{"Line":0}},{"line":551,"address":[14301863],"length":1,"stats":{"Line":0}},{"line":553,"address":[13755472],"length":1,"stats":{"Line":0}},{"line":554,"address":[14286728,14283806,14283867],"length":1,"stats":{"Line":0}},{"line":555,"address":[14284143],"length":1,"stats":{"Line":0}},{"line":557,"address":[18632674],"length":1,"stats":{"Line":0}},{"line":562,"address":[14434559],"length":1,"stats":{"Line":0}},{"line":563,"address":[18641701,18641543],"length":1,"stats":{"Line":0}},{"line":564,"address":[14311627],"length":1,"stats":{"Line":0}},{"line":565,"address":[12480377],"length":1,"stats":{"Line":0}},{"line":568,"address":[18641953],"length":1,"stats":{"Line":0}},{"line":569,"address":[14293847,14293926],"length":1,"stats":{"Line":0}},{"line":570,"address":[14312418],"length":1,"stats":{"Line":0}},{"line":571,"address":[14312658],"length":1,"stats":{"Line":0}},{"line":572,"address":[18642707],"length":1,"stats":{"Line":0}},{"line":573,"address":[13765819],"length":1,"stats":{"Line":0}},{"line":574,"address":[14313360],"length":1,"stats":{"Line":0}},{"line":575,"address":[14295294],"length":1,"stats":{"Line":0}},{"line":577,"address":[18643509,18643779],"length":1,"stats":{"Line":0}},{"line":580,"address":[13779502,13779550,13780091,13779431,13779899,13779328,13779509,13779366,13779595],"length":1,"stats":{"Line":0}},{"line":581,"address":[18657008,18656624,18656742],"length":1,"stats":{"Line":0}},{"line":582,"address":[18656965],"length":1,"stats":{"Line":0}},{"line":585,"address":[15231707,15231689,15231650],"length":1,"stats":{"Line":0}},{"line":586,"address":[13776613],"length":1,"stats":{"Line":0}},{"line":587,"address":[18653801],"length":1,"stats":{"Line":0}},{"line":589,"address":[14324245,14324365,14324634],"length":1,"stats":{"Line":0}},{"line":590,"address":[12478020],"length":1,"stats":{"Line":0}},{"line":593,"address":[13104671],"length":1,"stats":{"Line":0}},{"line":594,"address":[14279332],"length":1,"stats":{"Line":0}},{"line":597,"address":[14297861,14297939,14297710],"length":1,"stats":{"Line":0}},{"line":598,"address":[14298036,14298406,14298139],"length":1,"stats":{"Line":0}},{"line":599,"address":[13751455,13750898,13751765,13751903],"length":1,"stats":{"Line":0}},{"line":603,"address":[17185263],"length":1,"stats":{"Line":0}},{"line":604,"address":[18655163],"length":1,"stats":{"Line":0}},{"line":607,"address":[14325640,14325726],"length":1,"stats":{"Line":0}},{"line":608,"address":[13778574,13778305,13778202],"length":1,"stats":{"Line":0}},{"line":609,"address":[12785828],"length":1,"stats":{"Line":0}},{"line":613,"address":[13105615],"length":1,"stats":{"Line":0}},{"line":614,"address":[18657445],"length":1,"stats":{"Line":0}},{"line":615,"address":[18657903,18657533,18657644],"length":1,"stats":{"Line":0}},{"line":616,"address":[14328634,14328357],"length":1,"stats":{"Line":0}},{"line":619,"address":[12478996],"length":1,"stats":{"Line":0}},{"line":622,"address":[13761164,13758623,13758727,13758989,13760800,13758576,13760917,13758814,13758962,13761029,13761074,13760819,13761096],"length":1,"stats":{"Line":0}},{"line":624,"address":[14305948,14306045],"length":1,"stats":{"Line":0}},{"line":625,"address":[14306127,14306203],"length":1,"stats":{"Line":0}},{"line":626,"address":[14287921,14287964],"length":1,"stats":{"Line":0}},{"line":628,"address":[14288096,14287940],"length":1,"stats":{"Line":0}},{"line":629,"address":[13759374],"length":1,"stats":{"Line":0}},{"line":630,"address":[13759414],"length":1,"stats":{"Line":0}},{"line":632,"address":[14306541],"length":1,"stats":{"Line":0}},{"line":634,"address":[14288261],"length":1,"stats":{"Line":0}},{"line":635,"address":[14289727,14288379],"length":1,"stats":{"Line":0}},{"line":638,"address":[13759686,13759611],"length":1,"stats":{"Line":0}},{"line":639,"address":[18636808],"length":1,"stats":{"Line":0}},{"line":642,"address":[14306839,14309360],"length":1,"stats":{"Line":0}},{"line":644,"address":[14291087],"length":1,"stats":{"Line":0}},{"line":645,"address":[18639277],"length":1,"stats":{"Line":0}},{"line":647,"address":[14306874,14309280],"length":1,"stats":{"Line":0}},{"line":649,"address":[14291248,14291996,14292002,14291010],"length":1,"stats":{"Line":0}},{"line":650,"address":[14291306],"length":1,"stats":{"Line":0}},{"line":651,"address":[13762479],"length":1,"stats":{"Line":0}},{"line":652,"address":[18639798,18639710],"length":1,"stats":{"Line":0}},{"line":653,"address":[18640054,18639812,18639895],"length":1,"stats":{"Line":0}},{"line":655,"address":[13763010,13762694],"length":1,"stats":{"Line":0}},{"line":658,"address":[14309636],"length":1,"stats":{"Line":0}},{"line":662,"address":[18636957,18639202,18639224,18638320],"length":1,"stats":{"Line":0}},{"line":663,"address":[14290070],"length":1,"stats":{"Line":0}},{"line":664,"address":[14308550,14308443],"length":1,"stats":{"Line":0}},{"line":665,"address":[18638585,18638652],"length":1,"stats":{"Line":0}},{"line":668,"address":[13761643],"length":1,"stats":{"Line":0}},{"line":669,"address":[13761652],"length":1,"stats":{"Line":0}},{"line":670,"address":[13761865,13761786],"length":1,"stats":{"Line":0}},{"line":671,"address":[18638777],"length":1,"stats":{"Line":0}},{"line":672,"address":[13763145,13763120,13761769,13761902],"length":1,"stats":{"Line":0}},{"line":675,"address":[14290793,14290626],"length":1,"stats":{"Line":0}},{"line":676,"address":[14290857],"length":1,"stats":{"Line":0}},{"line":679,"address":[13761711],"length":1,"stats":{"Line":0}},{"line":683,"address":[14289157,14288804,14288731],"length":1,"stats":{"Line":0}},{"line":684,"address":[13760231],"length":1,"stats":{"Line":0}},{"line":687,"address":[14305058,14298572,14299708,14298142,14299855,14298254,14298362,14298546,14304998,14298080,14299734,14302504],"length":1,"stats":{"Line":0}},{"line":688,"address":[14316771],"length":1,"stats":{"Line":0}},{"line":689,"address":[18646475],"length":1,"stats":{"Line":0}},{"line":691,"address":[18646499,18646592],"length":1,"stats":{"Line":0}},{"line":692,"address":[14298717],"length":1,"stats":{"Line":0}},{"line":695,"address":[13769574,13769718],"length":1,"stats":{"Line":0}},{"line":698,"address":[14298863,14305072],"length":1,"stats":{"Line":0}},{"line":699,"address":[14323393,14323380],"length":1,"stats":{"Line":0}},{"line":700,"address":[18652994],"length":1,"stats":{"Line":0}},{"line":701,"address":[18653018],"length":1,"stats":{"Line":0}},{"line":704,"address":[14317355],"length":1,"stats":{"Line":0}},{"line":705,"address":[14317575],"length":1,"stats":{"Line":0}},{"line":709,"address":[13770062],"length":1,"stats":{"Line":0}},{"line":712,"address":[12477105],"length":1,"stats":{"Line":0}},{"line":714,"address":[14318436],"length":1,"stats":{"Line":0}},{"line":715,"address":[14300213],"length":1,"stats":{"Line":0}},{"line":716,"address":[14300225,14300924,14305016],"length":1,"stats":{"Line":0}},{"line":718,"address":[18649179],"length":1,"stats":{"Line":0}},{"line":719,"address":[13772260,13772148],"length":1,"stats":{"Line":0}},{"line":724,"address":[13772183,13772424],"length":1,"stats":{"Line":0}},{"line":725,"address":[14301631,14305473,14305456],"length":1,"stats":{"Line":0}},{"line":727,"address":[18649601,18649695],"length":1,"stats":{"Line":0}},{"line":729,"address":[14320245],"length":1,"stats":{"Line":0}},{"line":731,"address":[14320424,14320318],"length":1,"stats":{"Line":0}},{"line":732,"address":[14320451,14323472,14323489],"length":1,"stats":{"Line":0}},{"line":734,"address":[13773013,13773100],"length":1,"stats":{"Line":0}},{"line":737,"address":[13773303,13772854],"length":1,"stats":{"Line":0}},{"line":738,"address":[14302531,14302623],"length":1,"stats":{"Line":0}},{"line":741,"address":[13773346,13773548],"length":1,"stats":{"Line":0}},{"line":742,"address":[13773656,13773564],"length":1,"stats":{"Line":0}},{"line":745,"address":[14321293,14321091],"length":1,"stats":{"Line":0}},{"line":746,"address":[13773809,13773858],"length":1,"stats":{"Line":0}},{"line":750,"address":[14321336,14321498],"length":1,"stats":{"Line":0}},{"line":751,"address":[14303384],"length":1,"stats":{"Line":0}},{"line":753,"address":[18651112,18651169],"length":1,"stats":{"Line":0}},{"line":754,"address":[14321573,14321635],"length":1,"stats":{"Line":0}},{"line":755,"address":[14303320],"length":1,"stats":{"Line":0}},{"line":757,"address":[13774125],"length":1,"stats":{"Line":0}},{"line":761,"address":[14303597],"length":1,"stats":{"Line":0}},{"line":762,"address":[14303745],"length":1,"stats":{"Line":0}},{"line":763,"address":[13774630],"length":1,"stats":{"Line":0}},{"line":764,"address":[13774601],"length":1,"stats":{"Line":0}},{"line":765,"address":[14303804],"length":1,"stats":{"Line":0}},{"line":766,"address":[13774543],"length":1,"stats":{"Line":0}},{"line":768,"address":[18651774],"length":1,"stats":{"Line":0}},{"line":769,"address":[18651891],"length":1,"stats":{"Line":0}},{"line":770,"address":[14303982],"length":1,"stats":{"Line":0}},{"line":771,"address":[14303953],"length":1,"stats":{"Line":0}},{"line":772,"address":[14303924],"length":1,"stats":{"Line":0}},{"line":775,"address":[13774811],"length":1,"stats":{"Line":0}},{"line":776,"address":[14304262,14304104],"length":1,"stats":{"Line":0}},{"line":781,"address":[18652431,18652072],"length":1,"stats":{"Line":0}},{"line":786,"address":[14304525,14304769],"length":1,"stats":{"Line":0}},{"line":790,"address":[14321528,14323099],"length":1,"stats":{"Line":0}},{"line":792,"address":[18648175],"length":1,"stats":{"Line":0}},{"line":795,"address":[18648524],"length":1,"stats":{"Line":0}},{"line":796,"address":[14300427],"length":1,"stats":{"Line":0}},{"line":798,"address":[18648319],"length":1,"stats":{"Line":0}},{"line":800,"address":[13771365],"length":1,"stats":{"Line":0}},{"line":802,"address":[14318805],"length":1,"stats":{"Line":0}},{"line":803,"address":[14318821],"length":1,"stats":{"Line":0}},{"line":807,"address":[13771359],"length":1,"stats":{"Line":0}},{"line":813,"address":[17184815],"length":1,"stats":{"Line":0}},{"line":814,"address":[18640537],"length":1,"stats":{"Line":0}},{"line":816,"address":[13763441,13763523],"length":1,"stats":{"Line":0}},{"line":817,"address":[14292462,14292977],"length":1,"stats":{"Line":0}},{"line":820,"address":[18640698,18640773],"length":1,"stats":{"Line":0}},{"line":822,"address":[14292543],"length":1,"stats":{"Line":0}},{"line":823,"address":[14310896],"length":1,"stats":{"Line":0}},{"line":825,"address":[13763740],"length":1,"stats":{"Line":0}},{"line":827,"address":[14311472,14311499],"length":1,"stats":{"Line":0}},{"line":830,"address":[18640916],"length":1,"stats":{"Line":0}},{"line":833,"address":[17184399],"length":1,"stats":{"Line":0}},{"line":834,"address":[14295964],"length":1,"stats":{"Line":0}},{"line":835,"address":[14277684],"length":1,"stats":{"Line":0}},{"line":837,"address":[14296008,14296094],"length":1,"stats":{"Line":0}},{"line":838,"address":[14277893,14278823],"length":1,"stats":{"Line":0}},{"line":841,"address":[13749388,13749313],"length":1,"stats":{"Line":0}},{"line":842,"address":[18626510,18627600],"length":1,"stats":{"Line":0}},{"line":844,"address":[13750523],"length":1,"stats":{"Line":0}},{"line":847,"address":[13749497],"length":1,"stats":{"Line":0}},{"line":848,"address":[13749538],"length":1,"stats":{"Line":0}},{"line":849,"address":[14296673],"length":1,"stats":{"Line":0}},{"line":853,"address":[18645987,18644636,18644105,18644418,18645425,18645585,18644538,18644210,18644064,18645951],"length":1,"stats":{"Line":0}},{"line":857,"address":[13767409],"length":1,"stats":{"Line":0}},{"line":858,"address":[14314974],"length":1,"stats":{"Line":0}},{"line":859,"address":[15238769],"length":1,"stats":{"Line":0}},{"line":860,"address":[14316109],"length":1,"stats":{"Line":0}},{"line":863,"address":[14296781,14297093,14296719],"length":1,"stats":{"Line":0}},{"line":864,"address":[14297004],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":412},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","bin","test_dates.rs"],"content":"// Quick test to verify registry date fetching\nuse dependi_lsp::registries::{\n    Registry, crates_io::CratesIoRegistry, npm::NpmRegistry, pypi::PyPiRegistry,\n};\n\n/// Quick async test program that fetches and prints version information from multiple package registries.\n///\n/// The program queries crates.io for \"serde\", npm for \"express\", and PyPI for \"flask\".\n/// For each registry it prints a sample of the first three version strings, the total\n/// count of release dates, and a sample of the first three release dates. Errors are\n/// printed to standard output.\n///\n/// # Examples\n///\n/// ```no_run\n/// // Run the compiled binary to see registry outputs:\n/// // cargo run --bin registry_test\n/// ```\n#[tokio::main]\nasync fn main() {\n    println!(\"=== Testing crates.io (serde) ===\");\n    let registry = CratesIoRegistry::default();\n    match registry.get_version_info(\"serde\").await {\n        Ok(info) =\u003e {\n            println!(\n                \"Versions: {:?}\",\n                info.versions.iter().take(3).collect::\u003cVec\u003c_\u003e\u003e()\n            );\n            println!(\"Release dates count: {}\", info.release_dates.len());\n            println!(\n                \"Sample dates: {:?}\",\n                info.release_dates.iter().take(3).collect::\u003cVec\u003c_\u003e\u003e()\n            );\n        }\n        Err(e) =\u003e println!(\"Error: {}\", e),\n    }\n\n    println!(\"\\n=== Testing npm (express) ===\");\n    let registry = NpmRegistry::default();\n    match registry.get_version_info(\"express\").await {\n        Ok(info) =\u003e {\n            println!(\n                \"Versions: {:?}\",\n                info.versions.iter().take(3).collect::\u003cVec\u003c_\u003e\u003e()\n            );\n            println!(\"Release dates count: {}\", info.release_dates.len());\n            println!(\n                \"Sample dates: {:?}\",\n                info.release_dates.iter().take(3).collect::\u003cVec\u003c_\u003e\u003e()\n            );\n        }\n        Err(e) =\u003e println!(\"Error: {}\", e),\n    }\n\n    println!(\"\\n=== Testing PyPI (flask) ===\");\n    let registry = PyPiRegistry::default();\n    match registry.get_version_info(\"flask\").await {\n        Ok(info) =\u003e {\n            println!(\n                \"Versions: {:?}\",\n                info.versions.iter().take(3).collect::\u003cVec\u003c_\u003e\u003e()\n            );\n            println!(\"Release dates count: {}\", info.release_dates.len());\n            println!(\n                \"Sample dates: {:?}\",\n                info.release_dates.iter().take(3).collect::\u003cVec\u003c_\u003e\u003e()\n            );\n        }\n        Err(e) =\u003e println!(\"Error: {}\", e),\n    }\n}\n","traces":[{"line":20,"address":[12411062,12410672,12411056],"length":1,"stats":{"Line":0}},{"line":21,"address":[12397524,12397363],"length":1,"stats":{"Line":0}},{"line":22,"address":[12397551],"length":1,"stats":{"Line":0}},{"line":23,"address":[12397422,12397645,12397570,12397767],"length":1,"stats":{"Line":0}},{"line":24,"address":[12398096],"length":1,"stats":{"Line":0}},{"line":25,"address":[12398193,12398106],"length":1,"stats":{"Line":0}},{"line":29,"address":[12398438],"length":1,"stats":{"Line":0}},{"line":30,"address":[12398575],"length":1,"stats":{"Line":0}},{"line":35,"address":[12398006,12398858],"length":1,"stats":{"Line":0}},{"line":38,"address":[12398993,12398823],"length":1,"stats":{"Line":0}},{"line":39,"address":[12399020],"length":1,"stats":{"Line":0}},{"line":40,"address":[12399043,12399126,12399219,12397443],"length":1,"stats":{"Line":0}},{"line":41,"address":[12399542],"length":1,"stats":{"Line":0}},{"line":42,"address":[12399624,12399549],"length":1,"stats":{"Line":0}},{"line":46,"address":[12399857],"length":1,"stats":{"Line":0}},{"line":47,"address":[12400076],"length":1,"stats":{"Line":0}},{"line":52,"address":[12399455,12400271],"length":1,"stats":{"Line":0}},{"line":55,"address":[12400406,12400242],"length":1,"stats":{"Line":0}},{"line":56,"address":[12400433],"length":1,"stats":{"Line":0}},{"line":57,"address":[12400456,12400539,12400632,12397464],"length":1,"stats":{"Line":0}},{"line":58,"address":[12400955],"length":1,"stats":{"Line":0}},{"line":59,"address":[12401123],"length":1,"stats":{"Line":0}},{"line":63,"address":[12401270],"length":1,"stats":{"Line":0}},{"line":64,"address":[12401407],"length":1,"stats":{"Line":0}},{"line":69,"address":[12401681,12400868],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":25},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","cache","mod.rs"],"content":"//! Cache layer for package version information\n//!\n//! This module provides traits and implementations for caching package\n//! metadata. The cache layer uses a trait hierarchy:\n//!\n//! - **ReadCache**: For read-only cache operations\n//! - **WriteCache**: Extends ReadCache with write operations\n//!\n//! This separation allows for:\n//! - Read-only cache views for providers that don't need to write\n//! - Dependency injection with minimal interface requirements\n//! - Clear separation of concerns\n\nuse std::fmt::Display;\nuse std::sync::Arc;\nuse std::time::{Duration, Instant};\n\nuse dashmap::DashMap;\n\nuse crate::registries::VersionInfo;\n\npub mod sqlite;\n\npub use sqlite::SqliteCache;\n\n/// Trait for read-only cache operations\n///\n/// This trait defines the minimal interface for reading cached values.\n/// Implementations can provide additional write operations via the\n/// [`WriteCache`] trait.\npub trait ReadCache: Send + Sync {\n    /// Get a value from the cache\n    ///\n    /// Returns `None` if the key doesn't exist or the entry is expired.\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cVersionInfo\u003e;\n\n    /// Check if a key exists in the cache (without fetching the value)\n    #[allow(dead_code)]\n    fn contains(\u0026self, key: \u0026str) -\u003e bool {\n        self.get(key).is_some()\n    }\n}\n\n/// Trait for writeable cache operations\n///\n/// This trait extends [`ReadCache`] with the ability to insert and update\n/// cache entries. Caches that support both read and write operations should\n/// implement this trait.\npub trait WriteCache: ReadCache {\n    /// Insert a value into the cache\n    ///\n    /// If a value with the same key already exists, it will be overwritten.\n    fn insert(\u0026self, key: String, value: VersionInfo);\n\n    /// Remove a value from the cache\n    #[allow(dead_code)]\n    fn remove(\u0026self, key: \u0026str);\n\n    /// Clear all entries from the cache\n    #[allow(dead_code)]\n    fn clear(\u0026self);\n}\n\n#[deprecated(since = \"0.1.0\", note = \"Use ReadCache instead\")]\npub use ReadCache as Cache;\n\nimpl\u003cT: ReadCache\u003e ReadCache for Arc\u003cT\u003e {\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cVersionInfo\u003e {\n        (**self).get(key)\n    }\n\n    fn contains(\u0026self, key: \u0026str) -\u003e bool {\n        (**self).contains(key)\n    }\n}\n\nimpl\u003cT: WriteCache\u003e WriteCache for Arc\u003cT\u003e {\n    fn insert(\u0026self, key: String, value: VersionInfo) {\n        (**self).insert(key, value)\n    }\n\n    fn remove(\u0026self, key: \u0026str) {\n        (**self).remove(key)\n    }\n\n    fn clear(\u0026self) {\n        (**self).clear()\n    }\n}\n\n/// Default TTL for cache entries (1 hour)\nconst DEFAULT_TTL: Duration = Duration::from_secs(3600);\n\n/// Cache entry with expiration\n#[derive(Debug, Clone)]\nstruct CacheEntry {\n    data: VersionInfo,\n    inserted_at: Instant,\n    ttl: Duration,\n}\n\nimpl CacheEntry {\n    fn is_expired(\u0026self) -\u003e bool {\n        self.inserted_at.elapsed() \u003e self.ttl\n    }\n}\n\n/// In-memory cache using DashMap for thread-safety\n#[derive(Clone)]\npub struct MemoryCache {\n    entries: Arc\u003cDashMap\u003cString, CacheEntry\u003e\u003e,\n    ttl: Duration,\n}\n\nimpl Default for MemoryCache {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl MemoryCache {\n    /// Create a new cache with default TTL\n    pub fn new() -\u003e Self {\n        Self {\n            entries: Arc::new(DashMap::new()),\n            ttl: DEFAULT_TTL,\n        }\n    }\n}\n\nimpl ReadCache for MemoryCache {\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cVersionInfo\u003e {\n        self.entries.get(key).and_then(|entry| {\n            if entry.is_expired() {\n                None\n            } else {\n                Some(entry.data.clone())\n            }\n        })\n    }\n}\n\nimpl WriteCache for MemoryCache {\n    fn insert(\u0026self, key: String, value: VersionInfo) {\n        self.entries.insert(\n            key,\n            CacheEntry {\n                data: value,\n                inserted_at: Instant::now(),\n                ttl: self.ttl,\n            },\n        );\n    }\n\n    fn remove(\u0026self, key: \u0026str) {\n        self.entries.remove(key);\n    }\n\n    fn clear(\u0026self) {\n        self.entries.clear();\n    }\n}\n\nimpl MemoryCache {\n    /// Remove all expired entries from the cache\n    ///\n    /// Returns the number of entries removed.\n    pub fn cleanup_expired(\u0026self) -\u003e usize {\n        let before = self.entries.len();\n        self.entries.retain(|_, entry| !entry.is_expired());\n        let removed = before - self.entries.len();\n        if removed \u003e 0 {\n            tracing::debug!(\n                \"Cleaned up {} expired cache entries ({} remaining)\",\n                removed,\n                self.entries.len()\n            );\n        }\n        removed\n    }\n\n    /// Get statistics about the cache contents\n    ///\n    /// Returns counts of total, expired, and valid entries.\n    pub fn stats(\u0026self) -\u003e CacheStats {\n        let total = self.entries.len();\n        let expired = self.entries.iter().filter(|e| e.is_expired()).count();\n        CacheStats {\n            total_entries: total,\n            expired_entries: expired,\n            valid_entries: total.saturating_sub(expired),\n        }\n    }\n\n    /// Get the number of entries in the cache (including expired)\n    #[cfg(test)]\n    pub fn len(\u0026self) -\u003e usize {\n        self.entries.len()\n    }\n\n    /// Check if the cache is empty\n    #[cfg(test)]\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.entries.is_empty()\n    }\n\n    /// Create a new cache with custom TTL\n    #[cfg(test)]\n    pub fn with_ttl(ttl: Duration) -\u003e Self {\n        Self {\n            entries: Arc::new(DashMap::new()),\n            ttl,\n        }\n    }\n}\n\n/// Statistics about cache contents\n#[derive(Debug, Clone)]\npub struct CacheStats {\n    /// Total number of entries in the cache\n    pub total_entries: usize,\n    /// Number of expired entries\n    pub expired_entries: usize,\n    /// Number of valid (non-expired) entries\n    pub valid_entries: usize,\n}\n\nimpl Display for CacheStats {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        write!(\n            f,\n            \"CacheStats {{ total: {}, expired: {}, valid: {} }}\",\n            self.total_entries, self.expired_entries, self.valid_entries\n        )\n    }\n}\n\n/// Hybrid cache that uses memory for fast access and SQLite for persistence\npub struct HybridCache {\n    memory: MemoryCache,\n    sqlite: Option\u003cArc\u003cSqliteCache\u003e\u003e,\n}\n\nimpl Default for HybridCache {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// Cleanup interval for background task (30 minutes)\nconst CLEANUP_INTERVAL: Duration = Duration::from_secs(30 * 60);\n\nimpl HybridCache {\n    /// Create a new hybrid cache\n    pub fn new() -\u003e Self {\n        let sqlite = match SqliteCache::new() {\n            Ok(cache) =\u003e {\n                tracing::info!(\"SQLite cache initialized\");\n                Some(Arc::new(cache))\n            }\n            Err(e) =\u003e {\n                tracing::warn!(\n                    \"Failed to initialize SQLite cache, using memory only: {}\",\n                    e\n                );\n                None\n            }\n        };\n\n        let memory = MemoryCache::new();\n        Self::spawn_cleanup_task(memory.clone(), sqlite.clone());\n\n        Self { memory, sqlite }\n    }\n\n    /// Spawn a background task that periodically cleans up expired entries\n    fn spawn_cleanup_task(memory: MemoryCache, sqlite: Option\u003cArc\u003cSqliteCache\u003e\u003e) {\n        tokio::spawn(async move {\n            let mut interval = tokio::time::interval(CLEANUP_INTERVAL);\n            interval.tick().await; // Skip immediate first tick\n\n            loop {\n                interval.tick().await;\n\n                let stats = memory.stats();\n                let removed = memory.cleanup_expired();\n                if removed \u003e 0 {\n                    tracing::info!(\n                        \"Background cleanup: removed {} expired entries from memory cache (was: {})\",\n                        removed,\n                        stats\n                    );\n                }\n\n                if let Some(ref sqlite) = sqlite\n                    \u0026\u0026 let Ok(rows) = sqlite.cleanup_expired()\n                    \u0026\u0026 rows \u003e 0\n                {\n                    tracing::info!(\n                        \"Background cleanup: removed {} expired entries from SQLite cache\",\n                        rows\n                    );\n                }\n            }\n        });\n    }\n}\n\nimpl ReadCache for HybridCache {\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cVersionInfo\u003e {\n        // Fast path: check memory cache first\n        if let Some(value) = self.memory.get(key) {\n            return Some(value);\n        }\n\n        // Slow path: check SQLite cache\n        if let Some(ref sqlite) = self.sqlite\n            \u0026\u0026 let Some(value) = sqlite.get(key)\n        {\n            // Populate memory cache for future fast access\n            self.memory.insert(key.to_string(), value.clone());\n            return Some(value);\n        }\n\n        None\n    }\n}\n\nimpl WriteCache for HybridCache {\n    fn insert(\u0026self, key: String, value: VersionInfo) {\n        self.memory.insert(key.clone(), value.clone());\n        if let Some(ref sqlite) = self.sqlite {\n            sqlite.insert(key, value);\n        }\n    }\n\n    fn remove(\u0026self, key: \u0026str) {\n        self.memory.remove(key);\n        if let Some(ref sqlite) = self.sqlite {\n            sqlite.remove(key);\n        }\n    }\n\n    fn clear(\u0026self) {\n        self.memory.clear();\n        if let Some(ref sqlite) = self.sqlite {\n            sqlite.clear();\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    fn create_test_version_info() -\u003e VersionInfo {\n        VersionInfo {\n            latest: Some(\"1.0.0\".to_string()),\n            latest_prerelease: None,\n            versions: vec![\"1.0.0\".to_string()],\n            description: None,\n            homepage: None,\n            repository: None,\n            license: None,\n            vulnerabilities: vec![],\n            deprecated: false,\n            yanked: false,\n            yanked_versions: vec![],\n            release_dates: Default::default(),\n        }\n    }\n\n    #[test]\n    fn test_memory_cache_cleanup_expired() {\n        let cache = MemoryCache::with_ttl(Duration::from_millis(10));\n\n        cache.insert(\"key1\".to_string(), create_test_version_info());\n        cache.insert(\"key2\".to_string(), create_test_version_info());\n\n        assert_eq!(cache.len(), 2);\n\n        // Wait for entries to expire\n        std::thread::sleep(Duration::from_millis(20));\n\n        let removed = cache.cleanup_expired();\n        assert_eq!(removed, 2);\n        assert_eq!(cache.len(), 0);\n    }\n\n    #[test]\n    fn test_memory_cache_cleanup_partial() {\n        let cache = MemoryCache::with_ttl(Duration::from_millis(200));\n\n        cache.insert(\"key1\".to_string(), create_test_version_info());\n\n        // Wait for first entry to almost expire\n        std::thread::sleep(Duration::from_millis(150));\n\n        // Insert second entry\n        cache.insert(\"key2\".to_string(), create_test_version_info());\n\n        // Wait for first to expire but not second\n        std::thread::sleep(Duration::from_millis(100));\n\n        let removed = cache.cleanup_expired();\n        assert_eq!(removed, 1);\n        assert_eq!(cache.len(), 1);\n        assert!(cache.get(\"key2\").is_some());\n    }\n\n    #[test]\n    fn test_memory_cache_stats() {\n        let cache = MemoryCache::with_ttl(Duration::from_millis(100));\n\n        cache.insert(\"key1\".to_string(), create_test_version_info());\n        cache.insert(\"key2\".to_string(), create_test_version_info());\n\n        let stats = cache.stats();\n        assert_eq!(stats.total_entries, 2);\n        assert_eq!(stats.expired_entries, 0);\n        assert_eq!(stats.valid_entries, 2);\n\n        // Wait for expiration\n        std::thread::sleep(Duration::from_millis(150));\n\n        let stats = cache.stats();\n        assert_eq!(stats.total_entries, 2);\n        assert_eq!(stats.expired_entries, 2);\n        assert_eq!(stats.valid_entries, 0);\n    }\n\n    #[test]\n    fn test_cache_stats_display() {\n        let stats = CacheStats {\n            total_entries: 10,\n            expired_entries: 3,\n            valid_entries: 7,\n        };\n        let display = format!(\"{}\", stats);\n        assert!(display.contains(\"total: 10\"));\n        assert!(display.contains(\"expired: 3\"));\n        assert!(display.contains(\"valid: 7\"));\n    }\n\n    #[test]\n    fn test_memory_cache_is_empty() {\n        let cache = MemoryCache::with_ttl(Duration::from_secs(60));\n        assert!(cache.is_empty());\n        cache.insert(\"key\".to_string(), create_test_version_info());\n        assert!(!cache.is_empty());\n    }\n}\n","traces":[{"line":39,"address":[13497218,13497212,13497232,13497378,13497372,13497072],"length":1,"stats":{"Line":0}},{"line":40,"address":[13479544],"length":1,"stats":{"Line":0}},{"line":68,"address":[13834992,13835088],"length":1,"stats":{"Line":5}},{"line":69,"address":[13835044,13835140],"length":1,"stats":{"Line":4}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[17473984,17474210,17474482,17474256],"length":1,"stats":{"Line":3}},{"line":79,"address":[17474009,17474101,17474373,17474281],"length":1,"stats":{"Line":7}},{"line":82,"address":[17474528],"length":1,"stats":{"Line":0}},{"line":83,"address":[14977884],"length":1,"stats":{"Line":0}},{"line":86,"address":[14977280],"length":1,"stats":{"Line":0}},{"line":87,"address":[13835189],"length":1,"stats":{"Line":0}},{"line":103,"address":[19711696],"length":1,"stats":{"Line":3}},{"line":104,"address":[13829534],"length":1,"stats":{"Line":3}},{"line":116,"address":[13851728],"length":1,"stats":{"Line":0}},{"line":117,"address":[12998024],"length":1,"stats":{"Line":0}},{"line":123,"address":[12996464],"length":1,"stats":{"Line":3}},{"line":125,"address":[13832029],"length":1,"stats":{"Line":4}},{"line":132,"address":[13852400],"length":1,"stats":{"Line":5}},{"line":133,"address":[13852450],"length":1,"stats":{"Line":10}},{"line":134,"address":[13497852,13497911,13497790],"length":1,"stats":{"Line":14}},{"line":135,"address":[13468970],"length":1,"stats":{"Line":0}},{"line":137,"address":[14964694,14964654],"length":1,"stats":{"Line":10}},{"line":144,"address":[13853296,13853835,13853779],"length":1,"stats":{"Line":3}},{"line":145,"address":[13835038,13835390],"length":1,"stats":{"Line":6}},{"line":146,"address":[13853433],"length":1,"stats":{"Line":3}},{"line":147,"address":[12999867],"length":1,"stats":{"Line":3}},{"line":148,"address":[12999724],"length":1,"stats":{"Line":3}},{"line":149,"address":[13835214],"length":1,"stats":{"Line":3}},{"line":150,"address":[13853571],"length":1,"stats":{"Line":3}},{"line":155,"address":[19717840],"length":1,"stats":{"Line":0}},{"line":156,"address":[13853913],"length":1,"stats":{"Line":0}},{"line":159,"address":[13853264],"length":1,"stats":{"Line":0}},{"line":160,"address":[13834981],"length":1,"stats":{"Line":0}},{"line":168,"address":[13831376],"length":1,"stats":{"Line":2}},{"line":169,"address":[19713540],"length":1,"stats":{"Line":2}},{"line":170,"address":[14615328,14615360],"length":1,"stats":{"Line":6}},{"line":171,"address":[13849737,13849796],"length":1,"stats":{"Line":2}},{"line":172,"address":[13831498],"length":1,"stats":{"Line":2}},{"line":173,"address":[12996118],"length":1,"stats":{"Line":0}},{"line":185,"address":[13850384],"length":1,"stats":{"Line":2}},{"line":186,"address":[12996582],"length":1,"stats":{"Line":2}},{"line":187,"address":[12996613],"length":1,"stats":{"Line":6}},{"line":191,"address":[13832235],"length":1,"stats":{"Line":2}},{"line":197,"address":[12996432],"length":1,"stats":{"Line":2}},{"line":198,"address":[12996437],"length":1,"stats":{"Line":2}},{"line":203,"address":[12996736],"length":1,"stats":{"Line":2}},{"line":204,"address":[19714469],"length":1,"stats":{"Line":2}},{"line":209,"address":[12996768],"length":1,"stats":{"Line":2}},{"line":211,"address":[12996799],"length":1,"stats":{"Line":2}},{"line":229,"address":[19715296],"length":1,"stats":{"Line":2}},{"line":230,"address":[12997599],"length":1,"stats":{"Line":2}},{"line":245,"address":[12997984],"length":1,"stats":{"Line":0}},{"line":246,"address":[12997992],"length":1,"stats":{"Line":0}},{"line":255,"address":[13848750,13847984,13848718],"length":1,"stats":{"Line":0}},{"line":256,"address":[12994167],"length":1,"stats":{"Line":0}},{"line":257,"address":[13829824],"length":1,"stats":{"Line":0}},{"line":258,"address":[13829934,13829864,13830200],"length":1,"stats":{"Line":0}},{"line":259,"address":[13848445,13848680],"length":1,"stats":{"Line":0}},{"line":261,"address":[13848068],"length":1,"stats":{"Line":0}},{"line":262,"address":[13829796,13830513,13830767],"length":1,"stats":{"Line":0}},{"line":266,"address":[12995171],"length":1,"stats":{"Line":0}},{"line":270,"address":[12994859],"length":1,"stats":{"Line":0}},{"line":271,"address":[19713501,19713300,19713272,19713228],"length":1,"stats":{"Line":0}},{"line":277,"address":[13847888],"length":1,"stats":{"Line":0}},{"line":278,"address":[13467790,13465407,13465376,13465749,13465478,13465510,13466015],"length":1,"stats":{"Line":0}},{"line":279,"address":[13494381],"length":1,"stats":{"Line":0}},{"line":280,"address":[13494515,13494575,13494698,13494425],"length":1,"stats":{"Line":0}},{"line":283,"address":[12462264],"length":1,"stats":{"Line":0}},{"line":285,"address":[14962027],"length":1,"stats":{"Line":0}},{"line":286,"address":[14962054],"length":1,"stats":{"Line":0}},{"line":287,"address":[14613705],"length":1,"stats":{"Line":0}},{"line":288,"address":[14613760],"length":1,"stats":{"Line":0}},{"line":295,"address":[14962108,14962710],"length":1,"stats":{"Line":0}},{"line":296,"address":[13466990,13467094],"length":1,"stats":{"Line":0}},{"line":297,"address":[13467110],"length":1,"stats":{"Line":0}},{"line":299,"address":[14614457,14614526,14614767],"length":1,"stats":{"Line":0}},{"line":310,"address":[12998651,12998048,12998645],"length":1,"stats":{"Line":0}},{"line":312,"address":[12998104],"length":1,"stats":{"Line":0}},{"line":313,"address":[13851901],"length":1,"stats":{"Line":0}},{"line":317,"address":[12998213,12998269],"length":1,"stats":{"Line":0}},{"line":318,"address":[12998375,12998277],"length":1,"stats":{"Line":0}},{"line":321,"address":[13833818,13833921,13834057,13833890],"length":1,"stats":{"Line":0}},{"line":322,"address":[19716297],"length":1,"stats":{"Line":0}},{"line":325,"address":[13833758],"length":1,"stats":{"Line":0}},{"line":330,"address":[13852592,13853096,13853118],"length":1,"stats":{"Line":0}},{"line":331,"address":[13834445,13834334,13834789],"length":1,"stats":{"Line":0}},{"line":332,"address":[12999106],"length":1,"stats":{"Line":0}},{"line":333,"address":[12999256,12999155],"length":1,"stats":{"Line":0}},{"line":337,"address":[13834864],"length":1,"stats":{"Line":0}},{"line":338,"address":[12999441],"length":1,"stats":{"Line":0}},{"line":339,"address":[19717183],"length":1,"stats":{"Line":0}},{"line":340,"address":[12999500],"length":1,"stats":{"Line":0}},{"line":344,"address":[13852512],"length":1,"stats":{"Line":0}},{"line":345,"address":[13834237],"length":1,"stats":{"Line":0}},{"line":346,"address":[13834251],"length":1,"stats":{"Line":0}},{"line":347,"address":[13834286],"length":1,"stats":{"Line":0}}],"covered":36,"coverable":97},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","cache","sqlite.rs"],"content":"//! SQLite persistent cache for package version information with connection pooling\n\nuse std::path::PathBuf;\nuse std::sync::Arc;\n#[cfg(test)]\nuse std::sync::atomic::{AtomicU64, Ordering};\nuse std::time::{Duration, SystemTime, UNIX_EPOCH};\n\nuse r2d2::{Pool, PooledConnection};\nuse r2d2_sqlite::SqliteConnectionManager;\nuse rusqlite::params;\n\nuse crate::cache::{ReadCache, WriteCache};\nuse crate::registries::VersionInfo;\n\n/// Default TTL for cache entries (1 hour)\nconst DEFAULT_TTL_SECS: i64 = 3600;\n\n#[cfg(test)]\nstatic TEST_DB_COUNTER: AtomicU64 = AtomicU64::new(0);\n\n/// Configuration for SQLite cache pool\n#[derive(Debug, Clone)]\npub struct SqliteCacheConfig {\n    /// Maximum number of connections in the pool\n    pub max_pool_size: u32,\n    /// Minimum number of idle connections to maintain\n    pub min_idle_connections: u32,\n    /// Timeout in seconds for acquiring a connection\n    pub connection_timeout_secs: u64,\n    /// SQLite busy timeout in milliseconds\n    pub busy_timeout_ms: u32,\n    /// SQLite cache size in kilobytes\n    pub cache_size_kb: i64,\n    /// Time-to-live for cache entries in seconds\n    pub ttl_secs: i64,\n}\n\nimpl Default for SqliteCacheConfig {\n    fn default() -\u003e Self {\n        Self {\n            max_pool_size: 10,\n            min_idle_connections: 2,\n            connection_timeout_secs: 5,\n            busy_timeout_ms: 5000,\n            cache_size_kb: 64000,\n            ttl_secs: DEFAULT_TTL_SECS,\n        }\n    }\n}\n\n/// SQLite-based persistent cache with connection pooling\npub struct SqliteCache {\n    pool: Arc\u003cPool\u003cSqliteConnectionManager\u003e\u003e,\n    ttl_secs: i64,\n}\n\nimpl SqliteCache {\n    /// Create a new SQLite cache at the default location (~/.cache/dependi/cache.db)\n    pub fn new() -\u003e anyhow::Result\u003cSelf\u003e {\n        Self::with_config(SqliteCacheConfig::default())\n    }\n\n    /// Create a new SQLite cache with custom configuration\n    pub fn with_config(config: SqliteCacheConfig) -\u003e anyhow::Result\u003cSelf\u003e {\n        let cache_dir = Self::cache_dir()?;\n        std::fs::create_dir_all(\u0026cache_dir)?;\n        let db_path = cache_dir.join(\"cache.db\");\n        Self::with_path_and_config(db_path, config)\n    }\n\n    /// Create a new SQLite cache at a custom path with custom configuration\n    pub fn with_path_and_config(path: PathBuf, config: SqliteCacheConfig) -\u003e anyhow::Result\u003cSelf\u003e {\n        let busy_timeout_ms = config.busy_timeout_ms;\n        let cache_size_kb = config.cache_size_kb;\n\n        let manager = SqliteConnectionManager::file(\u0026path).with_init(move |conn| {\n            let pragmas = format!(\n                \"PRAGMA busy_timeout={};\n                 PRAGMA synchronous=NORMAL;\n                 PRAGMA cache_size=-{};\",\n                busy_timeout_ms, cache_size_kb\n            );\n            conn.execute_batch(\u0026pragmas)?;\n            Ok(())\n        });\n\n        let pool = Pool::builder()\n            .max_size(config.max_pool_size)\n            .min_idle(Some(config.min_idle_connections))\n            .connection_timeout(Duration::from_secs(config.connection_timeout_secs))\n            .idle_timeout(Some(Duration::from_secs(600)))\n            .max_lifetime(Some(Duration::from_secs(1800)))\n            .build(manager)?;\n\n        let cache = Self {\n            pool: Arc::new(pool),\n            ttl_secs: config.ttl_secs,\n        };\n\n        cache.init_schema()?;\n        cache.cleanup_expired()?;\n\n        let state = cache.pool_state();\n        tracing::debug!(\n            connections = state.connections,\n            idle = state.idle_connections,\n            \"SQLite cache pool initialized\"\n        );\n\n        Ok(cache)\n    }\n\n    /// Create an in-memory cache (for testing)\n    ///\n    /// Uses a shared in-memory database URI so all pooled connections access\n    /// the same database. Each call generates a unique database name to avoid\n    /// conflicts between tests.\n    #[cfg(test)]\n    pub fn in_memory() -\u003e anyhow::Result\u003cSelf\u003e {\n        let db_id = TEST_DB_COUNTER.fetch_add(1, Ordering::SeqCst);\n        let uri = format!(\"file:memdb{}?mode=memory\u0026cache=shared\", db_id);\n        let config = SqliteCacheConfig::default();\n\n        let manager = SqliteConnectionManager::file(\u0026uri).with_init(|conn| {\n            conn.execute_batch(\n                \"PRAGMA busy_timeout=5000;\n                 PRAGMA synchronous=NORMAL;\n                 PRAGMA cache_size=-64000;\",\n            )?;\n            Ok(())\n        });\n\n        let pool = Pool::builder().max_size(5).build(manager)?;\n\n        let cache = Self {\n            pool: Arc::new(pool),\n            ttl_secs: config.ttl_secs,\n        };\n\n        cache.init_schema_memory()?;\n        Ok(cache)\n    }\n\n    /// Initialize schema for in-memory database (no WAL mode)\n    #[cfg(test)]\n    fn init_schema_memory(\u0026self) -\u003e anyhow::Result\u003c()\u003e {\n        let conn = self.pool.get()?;\n\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS packages (\n                key TEXT PRIMARY KEY,\n                data TEXT NOT NULL,\n                inserted_at INTEGER NOT NULL,\n                ttl_secs INTEGER NOT NULL\n            )\",\n            [],\n        )?;\n        conn.execute(\n            \"CREATE INDEX IF NOT EXISTS idx_expiry ON packages(inserted_at, ttl_secs)\",\n            [],\n        )?;\n        Ok(())\n    }\n\n    /// Get the cache directory\n    fn cache_dir() -\u003e anyhow::Result\u003cPathBuf\u003e {\n        let cache_dir = dirs::cache_dir()\n            .ok_or_else(|| anyhow::anyhow!(\"Could not determine cache directory\"))?;\n        Ok(cache_dir.join(\"dependi\"))\n    }\n\n    /// Get a connection from the pool, returning None if unavailable\n    fn get_conn(\u0026self) -\u003e Option\u003cPooledConnection\u003cSqliteConnectionManager\u003e\u003e {\n        self.pool.get().ok()\n    }\n\n    /// Initialize the database schema with WAL mode\n    ///\n    /// Note: Per-connection PRAGMAs (busy_timeout, synchronous, cache_size)\n    /// are applied via with_init() on every new connection from the pool.\n    /// Only WAL mode (database-level) is set here.\n    fn init_schema(\u0026self) -\u003e anyhow::Result\u003c()\u003e {\n        let conn = self.pool.get()?;\n\n        conn.execute_batch(\"PRAGMA journal_mode=WAL;\")?;\n\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS packages (\n                key TEXT PRIMARY KEY,\n                data TEXT NOT NULL,\n                inserted_at INTEGER NOT NULL,\n                ttl_secs INTEGER NOT NULL\n            )\",\n            [],\n        )?;\n        conn.execute(\n            \"CREATE INDEX IF NOT EXISTS idx_expiry ON packages(inserted_at, ttl_secs)\",\n            [],\n        )?;\n        Ok(())\n    }\n}\n\nimpl ReadCache for SqliteCache {\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cVersionInfo\u003e {\n        let conn = self.get_conn()?;\n        let now = current_timestamp();\n\n        let result: Result\u003c(String, i64, i64), _\u003e = conn.query_row(\n            \"SELECT data, inserted_at, ttl_secs FROM packages WHERE key = ?\",\n            [key],\n            |row| Ok((row.get(0)?, row.get(1)?, row.get(2)?)),\n        );\n\n        match result {\n            Ok((data, inserted_at, ttl_secs)) =\u003e {\n                if now \u003e inserted_at + ttl_secs {\n                    let _ = conn.execute(\"DELETE FROM packages WHERE key = ?\", [key]);\n                    None\n                } else {\n                    serde_json::from_str(\u0026data).ok()\n                }\n            }\n            Err(_) =\u003e None,\n        }\n    }\n}\n\nimpl WriteCache for SqliteCache {\n    fn insert(\u0026self, key: String, value: VersionInfo) {\n        let Some(conn) = self.get_conn() else {\n            return;\n        };\n        let now = current_timestamp();\n        let data = match serde_json::to_string(\u0026value) {\n            Ok(d) =\u003e d,\n            Err(_) =\u003e return,\n        };\n\n        let _ = conn.execute(\n            \"INSERT OR REPLACE INTO packages (key, data, inserted_at, ttl_secs) VALUES (?, ?, ?, ?)\",\n            params![key, data, now, self.ttl_secs],\n        );\n    }\n\n    fn remove(\u0026self, key: \u0026str) {\n        let Some(conn) = self.get_conn() else {\n            return;\n        };\n        let _ = conn.execute(\"DELETE FROM packages WHERE key = ?\", [key]);\n    }\n\n    fn clear(\u0026self) {\n        let Some(conn) = self.get_conn() else {\n            return;\n        };\n        let _ = conn.execute(\"DELETE FROM packages\", []);\n    }\n}\n\nimpl SqliteCache {\n    /// Insert multiple values in a single transaction\n    #[cfg(test)]\n    pub fn insert_batch(\u0026self, entries: Vec\u003c(String, VersionInfo)\u003e) -\u003e anyhow::Result\u003cusize\u003e {\n        if entries.is_empty() {\n            return Ok(0);\n        }\n\n        let mut conn = self.pool.get()?;\n        let tx = conn.transaction()?;\n        let now = current_timestamp();\n        let mut count = 0;\n\n        for (key, value) in entries {\n            let data = serde_json::to_string(\u0026value)?;\n            tx.execute(\n                \"INSERT OR REPLACE INTO packages (key, data, inserted_at, ttl_secs) VALUES (?, ?, ?, ?)\",\n                params![key, data, now, self.ttl_secs],\n            )?;\n            count += 1;\n        }\n\n        tx.commit()?;\n        Ok(count)\n    }\n\n    /// Remove a value from the cache, returning whether it existed\n    #[cfg(test)]\n    pub fn remove_with_result(\u0026self, key: \u0026str) -\u003e bool {\n        let Some(conn) = self.get_conn() else {\n            return false;\n        };\n        conn.execute(\"DELETE FROM packages WHERE key = ?\", [key])\n            .map(|rows| rows \u003e 0)\n            .unwrap_or(false)\n    }\n\n    /// Clear all entries from the cache, returning the count\n    #[cfg(test)]\n    pub fn clear_with_count(\u0026self) -\u003e anyhow::Result\u003cusize\u003e {\n        let conn = self.pool.get()?;\n        let rows = conn.execute(\"DELETE FROM packages\", [])?;\n        Ok(rows)\n    }\n\n    /// Remove expired entries from the cache\n    pub fn cleanup_expired(\u0026self) -\u003e anyhow::Result\u003cusize\u003e {\n        let conn = self.pool.get()?;\n        let now = current_timestamp();\n        let rows = conn.execute(\n            \"DELETE FROM packages WHERE inserted_at + ttl_secs \u003c ?\",\n            [now],\n        )?;\n        Ok(rows)\n    }\n\n    /// Get pool statistics for monitoring\n    pub fn pool_state(\u0026self) -\u003e PoolState {\n        let state = self.pool.state();\n        PoolState {\n            connections: state.connections,\n            idle_connections: state.idle_connections,\n        }\n    }\n}\n\n/// Pool statistics for monitoring\n#[derive(Debug, Clone, Copy)]\npub struct PoolState {\n    /// Total number of connections in the pool\n    pub connections: u32,\n    /// Number of idle connections available\n    pub idle_connections: u32,\n}\n\n/// Get current Unix timestamp\nfn current_timestamp() -\u003e i64 {\n    SystemTime::now()\n        .duration_since(UNIX_EPOCH)\n        .unwrap_or_default()\n        .as_secs() as i64\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    fn create_test_version_info() -\u003e VersionInfo {\n        VersionInfo {\n            latest: Some(\"1.0.0\".to_string()),\n            latest_prerelease: None,\n            versions: vec![\"1.0.0\".to_string(), \"0.9.0\".to_string()],\n            description: Some(\"Test package\".to_string()),\n            homepage: None,\n            repository: None,\n            license: Some(\"MIT\".to_string()),\n            vulnerabilities: vec![],\n            deprecated: false,\n            yanked: false,\n            yanked_versions: vec![],\n            release_dates: Default::default(),\n        }\n    }\n\n    #[test]\n    fn test_insert_and_get() {\n        let cache = SqliteCache::in_memory().unwrap();\n        let info = create_test_version_info();\n\n        cache.insert(\"test:package\".to_string(), info.clone());\n        let retrieved = cache.get(\"test:package\");\n\n        assert!(retrieved.is_some());\n        let retrieved = retrieved.unwrap();\n        assert_eq!(retrieved.latest, info.latest);\n        assert_eq!(retrieved.versions, info.versions);\n    }\n\n    #[test]\n    fn test_get_nonexistent() {\n        let cache = SqliteCache::in_memory().unwrap();\n        let retrieved = cache.get(\"nonexistent\");\n        assert!(retrieved.is_none());\n    }\n\n    #[test]\n    fn test_overwrite() {\n        let cache = SqliteCache::in_memory().unwrap();\n\n        let info1 = VersionInfo {\n            latest: Some(\"1.0.0\".to_string()),\n            ..create_test_version_info()\n        };\n        let info2 = VersionInfo {\n            latest: Some(\"2.0.0\".to_string()),\n            ..create_test_version_info()\n        };\n\n        cache.insert(\"test:package\".to_string(), info1);\n        cache.insert(\"test:package\".to_string(), info2);\n\n        let retrieved = cache.get(\"test:package\").unwrap();\n        assert_eq!(retrieved.latest, Some(\"2.0.0\".to_string()));\n    }\n\n    #[test]\n    fn test_pool_state() {\n        let cache = SqliteCache::in_memory().unwrap();\n        let state = cache.pool_state();\n        assert!(state.connections \u003e 0);\n    }\n\n    #[test]\n    fn test_remove() {\n        let cache = SqliteCache::in_memory().unwrap();\n        let info = create_test_version_info();\n\n        cache.insert(\"test:package\".to_string(), info);\n        assert!(cache.get(\"test:package\").is_some());\n\n        let removed = cache.remove_with_result(\"test:package\");\n        assert!(removed);\n        assert!(cache.get(\"test:package\").is_none());\n\n        let removed_again = cache.remove_with_result(\"test:package\");\n        assert!(!removed_again);\n    }\n\n    #[test]\n    fn test_clear() {\n        let cache = SqliteCache::in_memory().unwrap();\n        let info = create_test_version_info();\n\n        cache.insert(\"pkg1\".to_string(), info.clone());\n        cache.insert(\"pkg2\".to_string(), info.clone());\n        cache.insert(\"pkg3\".to_string(), info);\n\n        let cleared = cache.clear_with_count().unwrap();\n        assert_eq!(cleared, 3);\n\n        assert!(cache.get(\"pkg1\").is_none());\n        assert!(cache.get(\"pkg2\").is_none());\n        assert!(cache.get(\"pkg3\").is_none());\n    }\n\n    #[test]\n    fn test_insert_batch() {\n        let cache = SqliteCache::in_memory().unwrap();\n\n        let entries: Vec\u003c(String, VersionInfo)\u003e = (0..10)\n            .map(|i| {\n                let mut info = create_test_version_info();\n                info.latest = Some(format!(\"{}.0.0\", i));\n                (format!(\"pkg{}\", i), info)\n            })\n            .collect();\n\n        let count = cache.insert_batch(entries).unwrap();\n        assert_eq!(count, 10);\n\n        for i in 0..10 {\n            let retrieved = cache.get(\u0026format!(\"pkg{}\", i)).unwrap();\n            assert_eq!(retrieved.latest, Some(format!(\"{}.0.0\", i)));\n        }\n    }\n\n    #[test]\n    fn test_insert_batch_empty() {\n        let cache = SqliteCache::in_memory().unwrap();\n        let count = cache.insert_batch(vec![]).unwrap();\n        assert_eq!(count, 0);\n    }\n\n    #[test]\n    fn test_concurrent_reads() {\n        use std::sync::Arc;\n        use std::thread;\n\n        let cache = Arc::new(SqliteCache::in_memory().unwrap());\n\n        for i in 0..20 {\n            let mut info = create_test_version_info();\n            info.latest = Some(format!(\"{}.0.0\", i));\n            cache.insert(format!(\"pkg{}\", i), info);\n        }\n\n        let handles: Vec\u003c_\u003e = (0..10)\n            .map(|thread_id| {\n                let cache = Arc::clone(\u0026cache);\n                thread::spawn(move || {\n                    for i in 0..20 {\n                        let key = format!(\"pkg{}\", i);\n                        let result = cache.get(\u0026key);\n                        assert!(\n                            result.is_some(),\n                            \"Thread {} failed to read {}\",\n                            thread_id,\n                            key\n                        );\n                    }\n                })\n            })\n            .collect();\n\n        for handle in handles {\n            handle.join().expect(\"Thread panicked\");\n        }\n    }\n\n    #[test]\n    fn test_concurrent_writes() {\n        use std::sync::Arc;\n        use std::thread;\n\n        let cache = Arc::new(SqliteCache::in_memory().unwrap());\n\n        let handles: Vec\u003c_\u003e = (0..5)\n            .map(|thread_id| {\n                let cache = Arc::clone(\u0026cache);\n                thread::spawn(move || {\n                    for i in 0..10 {\n                        let key = format!(\"thread{}:pkg{}\", thread_id, i);\n                        let mut info = create_test_version_info();\n                        info.latest = Some(format!(\"{}.{}.0\", thread_id, i));\n                        cache.insert(key, info);\n                    }\n                })\n            })\n            .collect();\n\n        for handle in handles {\n            handle.join().expect(\"Thread panicked\");\n        }\n\n        for thread_id in 0..5 {\n            for i in 0..10 {\n                let key = format!(\"thread{}:pkg{}\", thread_id, i);\n                let result = cache.get(\u0026key);\n                assert!(result.is_some(), \"Missing key: {}\", key);\n            }\n        }\n    }\n\n    #[test]\n    fn test_concurrent_mixed_operations() {\n        use std::sync::Arc;\n        use std::thread;\n\n        let cache = Arc::new(SqliteCache::in_memory().unwrap());\n\n        for i in 0..50 {\n            let mut info = create_test_version_info();\n            info.latest = Some(format!(\"{}.0.0\", i));\n            cache.insert(format!(\"pkg{}\", i), info);\n        }\n\n        let handles: Vec\u003c_\u003e = (0..10)\n            .map(|thread_id| {\n                let cache = Arc::clone(\u0026cache);\n                thread::spawn(move || {\n                    for i in 0..50 {\n                        match thread_id % 3 {\n                            0 =\u003e {\n                                let _ = cache.get(\u0026format!(\"pkg{}\", i));\n                            }\n                            1 =\u003e {\n                                let mut info = create_test_version_info();\n                                info.latest = Some(format!(\"updated-{}-{}\", thread_id, i));\n                                cache.insert(format!(\"pkg{}\", i), info);\n                            }\n                            _ =\u003e {\n                                let mut info = create_test_version_info();\n                                info.latest = Some(format!(\"new-{}-{}\", thread_id, i));\n                                cache.insert(format!(\"new-pkg-{}-{}\", thread_id, i), info);\n                            }\n                        }\n                    }\n                })\n            })\n            .collect();\n\n        for handle in handles {\n            handle.join().expect(\"Thread panicked\");\n        }\n    }\n\n    #[test]\n    fn test_config_default() {\n        let config = SqliteCacheConfig::default();\n        assert_eq!(config.max_pool_size, 10);\n        assert_eq!(config.min_idle_connections, 2);\n        assert_eq!(config.busy_timeout_ms, 5000);\n        assert_eq!(config.cache_size_kb, 64000);\n        assert_eq!(config.ttl_secs, DEFAULT_TTL_SECS);\n    }\n}\n","traces":[{"line":40,"address":[13626640],"length":1,"stats":{"Line":2}},{"line":60,"address":[13596592],"length":1,"stats":{"Line":0}},{"line":61,"address":[12843437],"length":1,"stats":{"Line":0}},{"line":65,"address":[13622048,13622514],"length":1,"stats":{"Line":0}},{"line":66,"address":[13622070],"length":1,"stats":{"Line":0}},{"line":67,"address":[13622218,13622285],"length":1,"stats":{"Line":0}},{"line":68,"address":[13622389],"length":1,"stats":{"Line":0}},{"line":69,"address":[13622458],"length":1,"stats":{"Line":0}},{"line":73,"address":[13625492,13623232,13625374],"length":1,"stats":{"Line":0}},{"line":74,"address":[12841287],"length":1,"stats":{"Line":0}},{"line":75,"address":[12841344],"length":1,"stats":{"Line":0}},{"line":77,"address":[13594498,13594420],"length":1,"stats":{"Line":0}},{"line":78,"address":[14163310],"length":1,"stats":{"Line":0}},{"line":84,"address":[13450130,13450203],"length":1,"stats":{"Line":0}},{"line":85,"address":[15085346],"length":1,"stats":{"Line":0}},{"line":88,"address":[12841822,12841692,12841477,12842168,12843331,12842084,12841952],"length":1,"stats":{"Line":0}},{"line":89,"address":[13623529],"length":1,"stats":{"Line":0}},{"line":90,"address":[12841564],"length":1,"stats":{"Line":0}},{"line":91,"address":[12843377,12841716,12841611],"length":1,"stats":{"Line":0}},{"line":92,"address":[12841846,12841744,12843359],"length":1,"stats":{"Line":0}},{"line":93,"address":[12841976,12841874,12843341],"length":1,"stats":{"Line":0}},{"line":94,"address":[12841991,12842136],"length":1,"stats":{"Line":0}},{"line":97,"address":[19250017],"length":1,"stats":{"Line":0}},{"line":98,"address":[19250099],"length":1,"stats":{"Line":0}},{"line":101,"address":[19250127,19250181,19251065],"length":1,"stats":{"Line":0}},{"line":102,"address":[19251048,19250286],"length":1,"stats":{"Line":0}},{"line":104,"address":[12842643],"length":1,"stats":{"Line":0}},{"line":105,"address":[13595815,13596133],"length":1,"stats":{"Line":0}},{"line":111,"address":[19250740],"length":1,"stats":{"Line":0}},{"line":120,"address":[12844894,12843936,12844942],"length":1,"stats":{"Line":22}},{"line":121,"address":[12843953],"length":1,"stats":{"Line":22}},{"line":122,"address":[19251793],"length":1,"stats":{"Line":14}},{"line":123,"address":[12844126],"length":1,"stats":{"Line":22}},{"line":125,"address":[14163888],"length":1,"stats":{"Line":28}},{"line":126,"address":[14163934,14164035],"length":1,"stats":{"Line":3}},{"line":131,"address":[15085711],"length":1,"stats":{"Line":10}},{"line":134,"address":[19252091,19252025,19252710],"length":1,"stats":{"Line":44}},{"line":137,"address":[12844531],"length":1,"stats":{"Line":5}},{"line":138,"address":[12844605],"length":1,"stats":{"Line":2}},{"line":141,"address":[19252483,19252429],"length":1,"stats":{"Line":11}},{"line":142,"address":[12844787],"length":1,"stats":{"Line":5}},{"line":147,"address":[12840877,12840096,12840883],"length":1,"stats":{"Line":2}},{"line":148,"address":[19247903],"length":1,"stats":{"Line":8}},{"line":150,"address":[12840870,12840392,12840338,12840547],"length":1,"stats":{"Line":10}},{"line":159,"address":[12840848,12840770,12840598],"length":1,"stats":{"Line":4}},{"line":163,"address":[12840812],"length":1,"stats":{"Line":8}},{"line":167,"address":[13597107,13596752,13597101],"length":1,"stats":{"Line":0}},{"line":168,"address":[13625724,13625792,13625697],"length":1,"stats":{"Line":0}},{"line":169,"address":[15085472,15085476],"length":1,"stats":{"Line":0}},{"line":170,"address":[13625867,13625933],"length":1,"stats":{"Line":0}},{"line":174,"address":[13625584],"length":1,"stats":{"Line":3}},{"line":175,"address":[13596694],"length":1,"stats":{"Line":3}},{"line":183,"address":[13593094,13593100,13592048],"length":1,"stats":{"Line":0}},{"line":184,"address":[13592063],"length":1,"stats":{"Line":0}},{"line":186,"address":[12835042,12835797,12835096],"length":1,"stats":{"Line":0}},{"line":188,"address":[13592549,13592734,13593075],"length":1,"stats":{"Line":0}},{"line":197,"address":[13592784,13592969,13593052],"length":1,"stats":{"Line":0}},{"line":201,"address":[13593015],"length":1,"stats":{"Line":0}},{"line":206,"address":[12846550,12845600,12846488],"length":1,"stats":{"Line":2}},{"line":207,"address":[13626739],"length":1,"stats":{"Line":2}},{"line":208,"address":[19253643,19253589],"length":1,"stats":{"Line":4}},{"line":210,"address":[13598077,13598025],"length":1,"stats":{"Line":6}},{"line":212,"address":[19253683],"length":1,"stats":{"Line":4}},{"line":213,"address":[13479838,13479808],"length":1,"stats":{"Line":8}},{"line":216,"address":[13627044],"length":1,"stats":{"Line":2}},{"line":217,"address":[12846002],"length":1,"stats":{"Line":8}},{"line":218,"address":[19254176,19253874],"length":1,"stats":{"Line":7}},{"line":219,"address":[13598375,13598486],"length":1,"stats":{"Line":0}},{"line":220,"address":[12846371],"length":1,"stats":{"Line":0}},{"line":222,"address":[12846235,12846184],"length":1,"stats":{"Line":16}},{"line":225,"address":[13598158],"length":1,"stats":{"Line":2}},{"line":231,"address":[12847619,12847668,12846816],"length":1,"stats":{"Line":2}},{"line":232,"address":[13599132,13599084],"length":1,"stats":{"Line":7}},{"line":235,"address":[19254753,19254827],"length":1,"stats":{"Line":13}},{"line":236,"address":[13628207],"length":1,"stats":{"Line":14}},{"line":237,"address":[13628309],"length":1,"stats":{"Line":2}},{"line":241,"address":[19255255,19255086],"length":1,"stats":{"Line":16}},{"line":243,"address":[13628541],"length":1,"stats":{"Line":12}},{"line":247,"address":[12847696,12847971,12847977],"length":1,"stats":{"Line":0}},{"line":248,"address":[19255535],"length":1,"stats":{"Line":0}},{"line":251,"address":[13629101,13629021],"length":1,"stats":{"Line":0}},{"line":254,"address":[13599016,13599010,13598784],"length":1,"stats":{"Line":0}},{"line":255,"address":[13598802],"length":1,"stats":{"Line":0}},{"line":258,"address":[13598880,13598947],"length":1,"stats":{"Line":0}},{"line":265,"address":[19244096,19246596,19246366],"length":1,"stats":{"Line":2}},{"line":266,"address":[12836354,12836440],"length":1,"stats":{"Line":4}},{"line":267,"address":[19244261],"length":1,"stats":{"Line":2}},{"line":270,"address":[19244246,19246560,19244306],"length":1,"stats":{"Line":4}},{"line":271,"address":[12836798,12836727,12838719],"length":1,"stats":{"Line":4}},{"line":272,"address":[12837017,12837083],"length":1,"stats":{"Line":4}},{"line":273,"address":[12837091],"length":1,"stats":{"Line":2}},{"line":275,"address":[12837284,12837103],"length":1,"stats":{"Line":4}},{"line":276,"address":[19246382,19245193,19245576],"length":1,"stats":{"Line":4}},{"line":277,"address":[19245930,19245755,19246316,19246099],"length":1,"stats":{"Line":4}},{"line":279,"address":[19245824],"length":1,"stats":{"Line":2}},{"line":281,"address":[12838358,12838413],"length":1,"stats":{"Line":2}},{"line":284,"address":[19245218,19245501],"length":1,"stats":{"Line":2}},{"line":285,"address":[12837624],"length":1,"stats":{"Line":2}},{"line":290,"address":[12841232,12840896,12841226],"length":1,"stats":{"Line":2}},{"line":291,"address":[12840943],"length":1,"stats":{"Line":2}},{"line":292,"address":[19248827],"length":1,"stats":{"Line":0}},{"line":294,"address":[12841097,12841196,12841023],"length":1,"stats":{"Line":6}},{"line":295,"address":[14163200,14163205],"length":1,"stats":{"Line":6}},{"line":301,"address":[12840064,12840070,12839488],"length":1,"stats":{"Line":2}},{"line":302,"address":[12839503],"length":1,"stats":{"Line":2}},{"line":303,"address":[12839735,12839789,12840042],"length":1,"stats":{"Line":4}},{"line":304,"address":[12839991],"length":1,"stats":{"Line":2}},{"line":308,"address":[13594279,13593616,13594273],"length":1,"stats":{"Line":0}},{"line":309,"address":[12838847],"length":1,"stats":{"Line":0}},{"line":310,"address":[12839123,12839069],"length":1,"stats":{"Line":0}},{"line":311,"address":[13594145,13594250,13593923,13593962],"length":1,"stats":{"Line":0}},{"line":313,"address":[13593954],"length":1,"stats":{"Line":0}},{"line":315,"address":[13594197],"length":1,"stats":{"Line":0}},{"line":319,"address":[13592000],"length":1,"stats":{"Line":2}},{"line":320,"address":[19242553],"length":1,"stats":{"Line":2}},{"line":338,"address":[12844960],"length":1,"stats":{"Line":10}},{"line":339,"address":[13597124],"length":1,"stats":{"Line":3}},{"line":340,"address":[13626067],"length":1,"stats":{"Line":8}},{"line":341,"address":[13597161],"length":1,"stats":{"Line":6}},{"line":342,"address":[13597180],"length":1,"stats":{"Line":13}}],"covered":67,"coverable":120},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","config.rs"],"content":"//! Configuration management for Dependi LSP\n\nuse serde::Deserialize;\n\n/// Default cache TTL (1 hour)\nconst DEFAULT_CACHE_TTL_SECS: u64 = 3600;\n\n/// Default vulnerability cache TTL (6 hours)\nconst DEFAULT_VULN_CACHE_TTL_SECS: u64 = 6 * 3600;\n\n/// LSP configuration\n#[derive(Debug, Clone, Deserialize, Default)]\n#[serde(default)]\npub struct Config {\n    /// Inlay hints configuration\n    pub inlay_hints: InlayHintsConfig,\n    /// Diagnostics configuration\n    pub diagnostics: DiagnosticsConfig,\n    /// Cache configuration\n    pub cache: CacheConfig,\n    /// Security/vulnerability configuration\n    pub security: SecurityConfig,\n    /// Packages to ignore (glob patterns)\n    #[serde(default)]\n    pub ignore: Vec\u003cString\u003e,\n}\n\n/// Inlay hints configuration\n#[derive(Debug, Clone, Deserialize)]\n#[serde(default)]\npub struct InlayHintsConfig {\n    /// Enable inlay hints\n    pub enabled: bool,\n    /// Show hints for up-to-date packages\n    pub show_up_to_date: bool,\n}\n\nimpl Default for InlayHintsConfig {\n    fn default() -\u003e Self {\n        Self {\n            enabled: true,\n            show_up_to_date: true,\n        }\n    }\n}\n\n/// Diagnostics configuration\n#[derive(Debug, Clone, Deserialize)]\n#[serde(default)]\npub struct DiagnosticsConfig {\n    /// Enable diagnostics\n    pub enabled: bool,\n}\n\nimpl Default for DiagnosticsConfig {\n    fn default() -\u003e Self {\n        Self { enabled: true }\n    }\n}\n\n/// Cache configuration\n#[derive(Debug, Clone, Deserialize)]\n#[serde(default)]\npub struct CacheConfig {\n    /// Cache TTL in seconds\n    pub ttl_secs: u64,\n}\n\nimpl Default for CacheConfig {\n    fn default() -\u003e Self {\n        Self {\n            ttl_secs: DEFAULT_CACHE_TTL_SECS,\n        }\n    }\n}\n\n/// Security/vulnerability scanning configuration\n#[derive(Debug, Clone, Deserialize)]\n#[serde(default)]\npub struct SecurityConfig {\n    /// Enable vulnerability scanning\n    pub enabled: bool,\n    /// Show vulnerabilities in inlay hints\n    pub show_in_hints: bool,\n    /// Show vulnerabilities as diagnostics\n    pub show_diagnostics: bool,\n    /// Minimum severity level to display (\"low\", \"medium\", \"high\", \"critical\")\n    pub min_severity: String,\n    /// Vulnerability cache TTL in seconds (default: 6 hours)\n    pub cache_ttl_secs: u64,\n}\n\nimpl Default for SecurityConfig {\n    fn default() -\u003e Self {\n        Self {\n            enabled: true,\n            show_in_hints: true,\n            show_diagnostics: true,\n            min_severity: \"low\".to_string(),\n            cache_ttl_secs: DEFAULT_VULN_CACHE_TTL_SECS,\n        }\n    }\n}\n\nimpl SecurityConfig {\n    /// Parse minimum severity level to VulnerabilitySeverity\n    pub fn min_severity_level(\u0026self) -\u003e crate::registries::VulnerabilitySeverity {\n        crate::registries::VulnerabilitySeverity::from_str_loose(\u0026self.min_severity)\n    }\n}\n\nimpl Config {\n    /// Parse configuration from initialization options\n    pub fn from_init_options(options: Option\u003cserde_json::Value\u003e) -\u003e Self {\n        match options {\n            Some(value) =\u003e serde_json::from_value(value).unwrap_or_default(),\n            None =\u003e Self::default(),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n\n    #[test]\n    fn test_default_config() {\n        let config = Config::default();\n        assert!(config.inlay_hints.enabled);\n        assert!(config.inlay_hints.show_up_to_date);\n        assert!(config.diagnostics.enabled);\n        assert_eq!(config.cache.ttl_secs, DEFAULT_CACHE_TTL_SECS);\n        assert!(config.ignore.is_empty());\n    }\n\n    #[test]\n    fn test_parse_from_json() {\n        let json = json!({\n            \"inlay_hints\": {\n                \"enabled\": false,\n                \"show_up_to_date\": false\n            },\n            \"diagnostics\": {\n                \"enabled\": false\n            },\n            \"cache\": {\n                \"ttl_secs\": 7200\n            },\n            \"ignore\": [\"test-*\", \"internal-pkg\"]\n        });\n\n        let config = Config::from_init_options(Some(json));\n        assert!(!config.inlay_hints.enabled);\n        assert!(!config.inlay_hints.show_up_to_date);\n        assert!(!config.diagnostics.enabled);\n        assert_eq!(config.cache.ttl_secs, 7200);\n        assert_eq!(config.ignore.len(), 2);\n    }\n\n    #[test]\n    fn test_partial_config() {\n        let json = json!({\n            \"inlay_hints\": {\n                \"enabled\": false\n            }\n        });\n\n        let config = Config::from_init_options(Some(json));\n        assert!(!config.inlay_hints.enabled);\n        // Other fields should use defaults\n        assert!(config.inlay_hints.show_up_to_date);\n        assert!(config.diagnostics.enabled);\n    }\n\n    #[test]\n    fn test_security_config_defaults() {\n        let config = SecurityConfig::default();\n        assert!(config.enabled);\n        assert!(config.show_in_hints);\n        assert!(config.show_diagnostics);\n        assert_eq!(config.min_severity, \"low\");\n        assert_eq!(config.cache_ttl_secs, DEFAULT_VULN_CACHE_TTL_SECS);\n    }\n\n    #[test]\n    fn test_security_config_from_json() {\n        let json = json!({\n            \"security\": {\n                \"enabled\": false,\n                \"show_in_hints\": false,\n                \"show_diagnostics\": false,\n                \"min_severity\": \"high\",\n                \"cache_ttl_secs\": 3600\n            }\n        });\n\n        let config = Config::from_init_options(Some(json));\n        assert!(!config.security.enabled);\n        assert!(!config.security.show_in_hints);\n        assert!(!config.security.show_diagnostics);\n        assert_eq!(config.security.min_severity, \"high\");\n        assert_eq!(config.security.cache_ttl_secs, 3600);\n    }\n\n    #[test]\n    fn test_min_severity_level_parsing() {\n        use crate::registries::VulnerabilitySeverity;\n\n        let config = SecurityConfig {\n            min_severity: \"low\".to_string(),\n            ..Default::default()\n        };\n        assert_eq!(config.min_severity_level(), VulnerabilitySeverity::Low);\n\n        let config = SecurityConfig {\n            min_severity: \"medium\".to_string(),\n            ..Default::default()\n        };\n        assert_eq!(config.min_severity_level(), VulnerabilitySeverity::Medium);\n\n        let config = SecurityConfig {\n            min_severity: \"high\".to_string(),\n            ..Default::default()\n        };\n        assert_eq!(config.min_severity_level(), VulnerabilitySeverity::High);\n\n        let config = SecurityConfig {\n            min_severity: \"critical\".to_string(),\n            ..Default::default()\n        };\n        assert_eq!(config.min_severity_level(), VulnerabilitySeverity::Critical);\n    }\n\n    #[test]\n    fn test_from_init_options_none() {\n        let config = Config::from_init_options(None);\n        assert!(config.inlay_hints.enabled);\n        assert!(config.diagnostics.enabled);\n    }\n\n    #[test]\n    fn test_from_init_options_invalid_json() {\n        let json = json!(\"invalid\");\n        let config = Config::from_init_options(Some(json));\n        assert!(config.inlay_hints.enabled);\n    }\n\n    #[test]\n    fn test_cache_config_defaults() {\n        let config = CacheConfig::default();\n        assert_eq!(config.ttl_secs, DEFAULT_CACHE_TTL_SECS);\n    }\n\n    #[test]\n    fn test_diagnostics_config_defaults() {\n        let config = DiagnosticsConfig::default();\n        assert!(config.enabled);\n    }\n\n    #[test]\n    fn test_inlay_hints_config_defaults() {\n        let config = InlayHintsConfig::default();\n        assert!(config.enabled);\n        assert!(config.show_up_to_date);\n    }\n}\n","traces":[{"line":39,"address":[15088928],"length":1,"stats":{"Line":2}},{"line":55,"address":[29957150],"length":1,"stats":{"Line":7}},{"line":69,"address":[29957152],"length":1,"stats":{"Line":2}},{"line":93,"address":[25956385],"length":1,"stats":{"Line":0}},{"line":94,"address":[13714720],"length":1,"stats":{"Line":2}},{"line":99,"address":[13714733],"length":1,"stats":{"Line":2}},{"line":105,"address":[29956485,29956480],"length":1,"stats":{"Line":0}},{"line":107,"address":[13683120],"length":1,"stats":{"Line":2}},{"line":108,"address":[13385445],"length":1,"stats":{"Line":2}},{"line":114,"address":[13683152],"length":1,"stats":{"Line":3}},{"line":115,"address":[13683173],"length":1,"stats":{"Line":4}},{"line":116,"address":[13683199],"length":1,"stats":{"Line":2}},{"line":117,"address":[13683273],"length":1,"stats":{"Line":2}}],"covered":11,"coverable":13},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","document.rs"],"content":"//! Document state and parsing logic\n//!\n//! This module handles document state management and dependency parsing\n//! for different file types.\n\nuse crate::file_types::FileType;\nuse crate::parsers::Dependency;\n\n/// State of a parsed dependency document.\n///\n/// Stores the parsed dependencies and detected file type for a document\n/// that has been opened in the editor.\npub struct DocumentState {\n    /// List of dependencies extracted from the document.\n    pub dependencies: Vec\u003cDependency\u003e,\n    /// The detected file type (determines which parser/registry to use).\n    pub file_type: FileType,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","file_types.rs"],"content":"//! File type detection and ecosystem mapping\n//!\n//! This module handles detection of dependency file types from URIs\n//! and provides mappings to ecosystems and cache keys.\n\nuse tower_lsp::lsp_types::Url;\n\nuse crate::vulnerabilities::Ecosystem;\n\n/// Supported dependency file types.\n///\n/// Each variant corresponds to a specific package manager ecosystem\n/// and determines which parser and registry client to use.\n#[derive(Debug, Clone, Copy, PartialEq)]\npub enum FileType {\n    /// Rust packages (Cargo.toml)\n    Cargo,\n    /// JavaScript/Node.js packages (package.json)\n    Npm,\n    /// Python packages (requirements.txt, pyproject.toml)\n    Python,\n    /// Go modules (go.mod)\n    Go,\n    /// PHP packages (composer.json)\n    Php,\n    /// Dart/Flutter packages (pubspec.yaml)\n    Dart,\n    /// C#/.NET packages (*.csproj)\n    Csharp,\n    /// Ruby gems (Gemfile)\n    Ruby,\n}\n\nimpl FileType {\n    /// Detect the file type from a document URI.\n    ///\n    /// Returns `Some(FileType)` if the URI matches a known dependency file pattern,\n    /// or `None` if the file type is not recognized.\n    pub fn detect(uri: \u0026Url) -\u003e Option\u003cSelf\u003e {\n        let path = uri.path();\n        if path.ends_with(\"Cargo.toml\") {\n            Some(FileType::Cargo)\n        } else if path.ends_with(\"package.json\") {\n            Some(FileType::Npm)\n        } else if path.ends_with(\"requirements.txt\")\n            || path.ends_with(\"requirements-dev.txt\")\n            || path.ends_with(\"requirements-test.txt\")\n            || path.ends_with(\"pyproject.toml\")\n        {\n            Some(FileType::Python)\n        } else if path.ends_with(\"go.mod\") {\n            Some(FileType::Go)\n        } else if path.ends_with(\"composer.json\") {\n            Some(FileType::Php)\n        } else if path.ends_with(\"pubspec.yaml\") {\n            Some(FileType::Dart)\n        } else if path.ends_with(\".csproj\") {\n            Some(FileType::Csharp)\n        } else if path.ends_with(\"Gemfile\") {\n            Some(FileType::Ruby)\n        } else {\n            None\n        }\n    }\n\n    /// Convert to the corresponding vulnerability ecosystem identifier.\n    ///\n    /// Used for querying the OSV.dev API with the correct ecosystem.\n    pub fn to_ecosystem(self) -\u003e Ecosystem {\n        match self {\n            FileType::Cargo =\u003e Ecosystem::CratesIo,\n            FileType::Npm =\u003e Ecosystem::Npm,\n            FileType::Python =\u003e Ecosystem::PyPI,\n            FileType::Go =\u003e Ecosystem::Go,\n            FileType::Php =\u003e Ecosystem::Packagist,\n            FileType::Dart =\u003e Ecosystem::Pub,\n            FileType::Csharp =\u003e Ecosystem::NuGet,\n            FileType::Ruby =\u003e Ecosystem::RubyGems,\n        }\n    }\n\n    /// Generate a cache key for a package.\n    ///\n    /// The cache key includes the registry prefix (e.g., \"crates:\", \"npm:\")\n    /// to avoid collisions between packages with the same name in different ecosystems.\n    pub fn cache_key(self, package_name: \u0026str) -\u003e String {\n        match self {\n            FileType::Cargo =\u003e format!(\"crates:{}\", package_name),\n            FileType::Npm =\u003e format!(\"npm:{}\", package_name),\n            FileType::Python =\u003e format!(\"pypi:{}\", package_name),\n            FileType::Go =\u003e format!(\"go:{}\", package_name),\n            FileType::Php =\u003e format!(\"packagist:{}\", package_name),\n            FileType::Dart =\u003e format!(\"pub:{}\", package_name),\n            FileType::Csharp =\u003e format!(\"nuget:{}\", package_name),\n            FileType::Ruby =\u003e format!(\"rubygems:{}\", package_name),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_detect_cargo() {\n        let uri = Url::parse(\"file:///project/Cargo.toml\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Cargo));\n    }\n\n    #[test]\n    fn test_detect_npm() {\n        let uri = Url::parse(\"file:///project/package.json\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Npm));\n    }\n\n    #[test]\n    fn test_detect_python_requirements() {\n        let uri = Url::parse(\"file:///project/requirements.txt\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Python));\n\n        let uri = Url::parse(\"file:///project/requirements-dev.txt\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Python));\n    }\n\n    #[test]\n    fn test_detect_pyproject() {\n        let uri = Url::parse(\"file:///project/pyproject.toml\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Python));\n    }\n\n    #[test]\n    fn test_detect_go() {\n        let uri = Url::parse(\"file:///project/go.mod\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Go));\n    }\n\n    #[test]\n    fn test_detect_php() {\n        let uri = Url::parse(\"file:///project/composer.json\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Php));\n    }\n\n    #[test]\n    fn test_detect_dart() {\n        let uri = Url::parse(\"file:///project/pubspec.yaml\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Dart));\n    }\n\n    #[test]\n    fn test_detect_csharp() {\n        let uri = Url::parse(\"file:///project/MyProject.csproj\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Csharp));\n    }\n\n    #[test]\n    fn test_detect_ruby() {\n        let uri = Url::parse(\"file:///project/Gemfile\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Ruby));\n    }\n\n    #[test]\n    fn test_detect_unknown() {\n        let uri = Url::parse(\"file:///project/unknown.txt\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), None);\n    }\n\n    #[test]\n    fn test_to_ecosystem() {\n        assert_eq!(FileType::Cargo.to_ecosystem(), Ecosystem::CratesIo);\n        assert_eq!(FileType::Npm.to_ecosystem(), Ecosystem::Npm);\n        assert_eq!(FileType::Python.to_ecosystem(), Ecosystem::PyPI);\n        assert_eq!(FileType::Go.to_ecosystem(), Ecosystem::Go);\n        assert_eq!(FileType::Php.to_ecosystem(), Ecosystem::Packagist);\n        assert_eq!(FileType::Dart.to_ecosystem(), Ecosystem::Pub);\n        assert_eq!(FileType::Csharp.to_ecosystem(), Ecosystem::NuGet);\n        assert_eq!(FileType::Ruby.to_ecosystem(), Ecosystem::RubyGems);\n    }\n\n    #[test]\n    fn test_cache_key() {\n        assert_eq!(FileType::Cargo.cache_key(\"serde\"), \"crates:serde\");\n        assert_eq!(FileType::Npm.cache_key(\"lodash\"), \"npm:lodash\");\n        assert_eq!(FileType::Python.cache_key(\"requests\"), \"pypi:requests\");\n        assert_eq!(\n            FileType::Go.cache_key(\"github.com/gin-gonic/gin\"),\n            \"go:github.com/gin-gonic/gin\"\n        );\n    }\n}\n","traces":[{"line":39,"address":[12953488],"length":1,"stats":{"Line":4}},{"line":40,"address":[14315913],"length":1,"stats":{"Line":4}},{"line":41,"address":[14316006,14315945],"length":1,"stats":{"Line":6}},{"line":42,"address":[12953585],"length":1,"stats":{"Line":2}},{"line":43,"address":[14316050,14315977],"length":1,"stats":{"Line":5}},{"line":44,"address":[14334333],"length":1,"stats":{"Line":2}},{"line":45,"address":[19256325,19256398],"length":1,"stats":{"Line":6}},{"line":46,"address":[19256369],"length":1,"stats":{"Line":4}},{"line":47,"address":[14334397],"length":1,"stats":{"Line":6}},{"line":48,"address":[14334429],"length":1,"stats":{"Line":2}},{"line":50,"address":[14334377],"length":1,"stats":{"Line":2}},{"line":51,"address":[12953818,12953757],"length":1,"stats":{"Line":7}},{"line":52,"address":[14334517],"length":1,"stats":{"Line":2}},{"line":53,"address":[14334566,14334493],"length":1,"stats":{"Line":5}},{"line":54,"address":[14316273],"length":1,"stats":{"Line":2}},{"line":55,"address":[12953833,12953903],"length":1,"stats":{"Line":5}},{"line":56,"address":[14334602],"length":1,"stats":{"Line":2}},{"line":57,"address":[19256594,19256664],"length":1,"stats":{"Line":5}},{"line":58,"address":[14316355],"length":1,"stats":{"Line":2}},{"line":59,"address":[14334655,14334619],"length":1,"stats":{"Line":5}},{"line":60,"address":[12953953],"length":1,"stats":{"Line":2}},{"line":62,"address":[14334650],"length":1,"stats":{"Line":2}},{"line":69,"address":[19256096],"length":1,"stats":{"Line":2}},{"line":70,"address":[14334087],"length":1,"stats":{"Line":2}},{"line":71,"address":[12953414],"length":1,"stats":{"Line":2}},{"line":72,"address":[12953421],"length":1,"stats":{"Line":2}},{"line":73,"address":[14315844],"length":1,"stats":{"Line":2}},{"line":74,"address":[14315851],"length":1,"stats":{"Line":2}},{"line":75,"address":[14315858],"length":1,"stats":{"Line":2}},{"line":76,"address":[14334153],"length":1,"stats":{"Line":2}},{"line":77,"address":[12953456],"length":1,"stats":{"Line":2}},{"line":78,"address":[14334167],"length":1,"stats":{"Line":2}},{"line":86,"address":[12953968],"length":1,"stats":{"Line":2}},{"line":87,"address":[14334709],"length":1,"stats":{"Line":2}},{"line":88,"address":[12954036],"length":1,"stats":{"Line":2}},{"line":89,"address":[14316572],"length":1,"stats":{"Line":2}},{"line":90,"address":[12954294],"length":1,"stats":{"Line":2}},{"line":91,"address":[14316848],"length":1,"stats":{"Line":2}},{"line":92,"address":[14316986],"length":1,"stats":{"Line":0}},{"line":93,"address":[14317124],"length":1,"stats":{"Line":0}},{"line":94,"address":[14317262],"length":1,"stats":{"Line":0}},{"line":95,"address":[14317400],"length":1,"stats":{"Line":0}}],"covered":38,"coverable":42},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","lib.rs"],"content":"//! Dependi LSP - Language Server for dependency management\n//!\n//! This crate provides a Language Server Protocol implementation for\n//! managing dependencies in various package managers (Cargo, npm, etc.)\n\npub mod backend;\npub mod cache;\npub mod config;\npub mod document;\npub mod file_types;\npub mod parsers;\npub mod providers;\npub mod registries;\npub mod reports;\npub mod utils;\npub mod vulnerabilities;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","main.rs"],"content":"mod backend;\nmod cache;\nmod config;\nmod document;\nmod file_types;\nmod parsers;\nmod providers;\nmod registries;\nmod reports;\nmod utils;\nmod vulnerabilities;\n\nuse std::path::PathBuf;\nuse std::process::ExitCode;\n\nuse clap::{Parser, Subcommand};\nuse tower_lsp::{LspService, Server};\nuse tracing_subscriber::{EnvFilter, layer::SubscriberExt, util::SubscriberInitExt};\n\nuse crate::backend::DependiBackend;\n\n#[derive(Parser)]\n#[command(name = \"dependi-lsp\")]\n#[command(about = \"Language server for dependency management\", long_about = None)]\n#[command(version)]\nstruct Cli {\n    #[command(subcommand)]\n    command: Option\u003cCommands\u003e,\n}\n\n#[derive(Subcommand)]\nenum Commands {\n    /// Start the LSP server (default behavior)\n    Lsp,\n    /// Scan a file for vulnerabilities and exit with code 1 if found\n    Scan {\n        /// Path to the dependency file to scan\n        #[arg(short, long)]\n        file: PathBuf,\n\n        /// Output format: json, markdown, or summary\n        #[arg(short, long, default_value = \"summary\")]\n        output: String,\n\n        /// Minimum severity level to report (low, medium, high, critical)\n        #[arg(short, long, default_value = \"low\")]\n        min_severity: String,\n\n        /// Exit with code 1 if vulnerabilities are found\n        #[arg(long, default_value = \"true\")]\n        fail_on_vulns: bool,\n    },\n}\n\n#[tokio::main]\nasync fn main() -\u003e ExitCode {\n    let cli = Cli::parse();\n\n    // Initialize tracing\n    tracing_subscriber::registry()\n        .with(EnvFilter::try_from_default_env().unwrap_or_else(|_| EnvFilter::new(\"info\")))\n        .with(tracing_subscriber::fmt::layer().with_writer(std::io::stderr))\n        .init();\n\n    match cli.command {\n        Some(Commands::Scan {\n            file,\n            output,\n            min_severity,\n            fail_on_vulns,\n        }) =\u003e run_scan(file, output, min_severity, fail_on_vulns).await,\n        Some(Commands::Lsp) | None =\u003e {\n            run_lsp().await;\n            ExitCode::SUCCESS\n        }\n    }\n}\n\nasync fn run_lsp() {\n    tracing::info!(\"Starting Dependi LSP server\");\n\n    let stdin = tokio::io::stdin();\n    let stdout = tokio::io::stdout();\n\n    let (service, socket) = LspService::new(DependiBackend::new);\n    Server::new(stdin, stdout, socket).serve(service).await;\n}\n\nasync fn run_scan(\n    file: PathBuf,\n    output: String,\n    min_severity: String,\n    fail_on_vulns: bool,\n) -\u003e ExitCode {\n    use crate::parsers::{\n        Parser, cargo::CargoParser, csharp::CsharpParser, dart::DartParser, go::GoParser,\n        npm::NpmParser, php::PhpParser, python::PythonParser,\n    };\n    use crate::registries::VulnerabilitySeverity;\n    use crate::vulnerabilities::{Ecosystem, VulnerabilityQuery, osv::OsvClient};\n\n    // Read file (using async I/O)\n    let content = match tokio::fs::read_to_string(\u0026file).await {\n        Ok(c) =\u003e c,\n        Err(e) =\u003e {\n            eprintln!(\"Error reading file: {}\", e);\n            return ExitCode::FAILURE;\n        }\n    };\n\n    let file_name = file.file_name().and_then(|n| n.to_str()).unwrap_or(\"\");\n\n    // Detect file type and parse\n    let (dependencies, ecosystem) = if file_name == \"Cargo.toml\" {\n        (CargoParser::new().parse(\u0026content), Ecosystem::CratesIo)\n    } else if file_name == \"package.json\" {\n        (NpmParser::new().parse(\u0026content), Ecosystem::Npm)\n    } else if file_name == \"requirements.txt\" || file_name == \"pyproject.toml\" {\n        (PythonParser::new().parse(\u0026content), Ecosystem::PyPI)\n    } else if file_name == \"go.mod\" {\n        (GoParser::new().parse(\u0026content), Ecosystem::Go)\n    } else if file_name == \"composer.json\" {\n        (PhpParser::new().parse(\u0026content), Ecosystem::Packagist)\n    } else if file_name == \"pubspec.yaml\" {\n        (DartParser::new().parse(\u0026content), Ecosystem::Pub)\n    } else if file_name.ends_with(\".csproj\") {\n        (CsharpParser::new().parse(\u0026content), Ecosystem::NuGet)\n    } else {\n        eprintln!(\"Unsupported file type: {}\", file_name);\n        return ExitCode::FAILURE;\n    };\n\n    if dependencies.is_empty() {\n        println!(\"No dependencies found in {}\", file.display());\n        return ExitCode::SUCCESS;\n    }\n\n    eprintln!(\n        \"Scanning {} dependencies in {}...\",\n        dependencies.len(),\n        file.display()\n    );\n\n    // Build vulnerability queries\n    let queries: Vec\u003cVulnerabilityQuery\u003e = dependencies\n        .iter()\n        .map(|dep| VulnerabilityQuery {\n            ecosystem,\n            package_name: dep.name.clone(),\n            version: dep.version.clone(),\n        })\n        .collect();\n\n    // Query OSV.dev\n    let osv_client = OsvClient::default();\n    let results = match osv_client.query_batch(\u0026queries).await {\n        Ok(r) =\u003e r,\n        Err(e) =\u003e {\n            eprintln!(\"Error querying OSV.dev: {}\", e);\n            return ExitCode::FAILURE;\n        }\n    };\n\n    // Parse minimum severity using shared method\n    let min_sev = VulnerabilitySeverity::from_str_loose(\u0026min_severity);\n\n    // Filter and collect vulnerabilities\n    let mut total_vulns = 0;\n    let mut critical_count = 0;\n    let mut high_count = 0;\n    let mut medium_count = 0;\n    let mut low_count = 0;\n    let mut vuln_details: Vec\u003cserde_json::Value\u003e = Vec::new();\n\n    for (dep, result) in dependencies.iter().zip(results.iter()) {\n        for vuln in \u0026result.vulnerabilities {\n            // Filter by severity using shared method\n            if !vuln.severity.meets_threshold(\u0026min_sev) {\n                continue;\n            }\n\n            total_vulns += 1;\n            match vuln.severity {\n                VulnerabilitySeverity::Critical =\u003e critical_count += 1,\n                VulnerabilitySeverity::High =\u003e high_count += 1,\n                VulnerabilitySeverity::Medium =\u003e medium_count += 1,\n                VulnerabilitySeverity::Low =\u003e low_count += 1,\n            }\n\n            vuln_details.push(serde_json::json!({\n                \"package\": dep.name,\n                \"version\": dep.version,\n                \"id\": vuln.id,\n                \"severity\": vuln.severity.as_str(),\n                \"description\": vuln.description,\n                \"url\": vuln.url\n            }));\n        }\n    }\n\n    // Output results\n    match output.as_str() {\n        \"json\" =\u003e {\n            let report = serde_json::json!({\n                \"file\": file.display().to_string(),\n                \"summary\": {\n                    \"total\": total_vulns,\n                    \"critical\": critical_count,\n                    \"high\": high_count,\n                    \"medium\": medium_count,\n                    \"low\": low_count\n                },\n                \"vulnerabilities\": vuln_details\n            });\n            println!(\"{}\", serde_json::to_string_pretty(\u0026report).unwrap());\n        }\n        \"markdown\" =\u003e {\n            println!(\"# Vulnerability Report\\n\");\n            println!(\"**File**: {}\", file.display());\n            println!(\"**Date**: {}\\n\", chrono::Local::now().format(\"%Y-%m-%d\"));\n            println!(\"## Summary\\n\");\n            println!(\"| Severity | Count |\");\n            println!(\"|----------|-------|\");\n            println!(\"| ⚠ Critical | {} |\", critical_count);\n            println!(\"| ▲ High | {} |\", high_count);\n            println!(\"| ● Medium | {} |\", medium_count);\n            println!(\"| ○ Low | {} |\", low_count);\n            println!(\"| **Total** | **{}** |\\n\", total_vulns);\n\n            if !vuln_details.is_empty() {\n                println!(\"## Vulnerabilities\\n\");\n                for vuln in \u0026vuln_details {\n                    let severity_icon = match vuln[\"severity\"].as_str().unwrap_or(\"low\") {\n                        \"critical\" =\u003e \"⚠\",\n                        \"high\" =\u003e \"▲\",\n                        \"medium\" =\u003e \"●\",\n                        _ =\u003e \"○\",\n                    };\n                    println!(\n                        \"### {}@{}\\n\",\n                        vuln[\"package\"].as_str().unwrap_or(\"\"),\n                        vuln[\"version\"].as_str().unwrap_or(\"\")\n                    );\n                    if let Some(url) = vuln[\"url\"].as_str() {\n                        println!(\n                            \"- **[{}]({})** ({} {}): {}\",\n                            vuln[\"id\"].as_str().unwrap_or(\"\"),\n                            url,\n                            severity_icon,\n                            vuln[\"severity\"].as_str().unwrap_or(\"\").to_uppercase(),\n                            vuln[\"description\"].as_str().unwrap_or(\"\")\n                        );\n                    } else {\n                        println!(\n                            \"- **{}** ({} {}): {}\",\n                            vuln[\"id\"].as_str().unwrap_or(\"\"),\n                            severity_icon,\n                            vuln[\"severity\"].as_str().unwrap_or(\"\").to_uppercase(),\n                            vuln[\"description\"].as_str().unwrap_or(\"\")\n                        );\n                    }\n                    println!();\n                }\n            }\n        }\n        _ =\u003e {\n            // Summary format\n            println!(\"Vulnerability Scan Results for {}\\n\", file.display());\n            println!(\"  ⚠ Critical: {}\", critical_count);\n            println!(\"  ▲ High:     {}\", high_count);\n            println!(\"  ● Medium:   {}\", medium_count);\n            println!(\"  ○ Low:      {}\", low_count);\n            println!(\"  ─────────────\");\n            println!(\"  Total:      {}\\n\", total_vulns);\n\n            if total_vulns == 0 {\n                println!(\"[OK] No vulnerabilities found!\");\n            } else {\n                println!(\"⚠ {} vulnerabilities found!\", total_vulns);\n            }\n        }\n    }\n\n    // Exit code\n    if fail_on_vulns \u0026\u0026 total_vulns \u003e 0 {\n        ExitCode::FAILURE\n    } else {\n        ExitCode::SUCCESS\n    }\n}\n","traces":[{"line":56,"address":[20310736,20311126,20311132],"length":1,"stats":{"Line":0}},{"line":57,"address":[15530587],"length":1,"stats":{"Line":0}},{"line":60,"address":[15530908,15531042,15530743],"length":1,"stats":{"Line":0}},{"line":61,"address":[15530813,15530840,15530778,15530940,15531577,15532224,15532240],"length":1,"stats":{"Line":0}},{"line":62,"address":[15530978,15530971,15531543,15531071],"length":1,"stats":{"Line":0}},{"line":65,"address":[15531169],"length":1,"stats":{"Line":0}},{"line":66,"address":[15531630,15530653,15531488,15531391],"length":1,"stats":{"Line":0}},{"line":73,"address":[15531246,15531414,15531854,15530668],"length":1,"stats":{"Line":0}},{"line":74,"address":[15531990],"length":1,"stats":{"Line":0}},{"line":79,"address":[15532496,15532336,15532361,15533649,15533868,15532454],"length":1,"stats":{"Line":0}},{"line":80,"address":[15532542,15532401,15532756],"length":1,"stats":{"Line":0}},{"line":82,"address":[15532734],"length":1,"stats":{"Line":0}},{"line":83,"address":[15532987],"length":1,"stats":{"Line":0}},{"line":85,"address":[15533136,15533067],"length":1,"stats":{"Line":0}},{"line":86,"address":[15533680,15533246,15532481,15533484],"length":1,"stats":{"Line":0}},{"line":89,"address":[20311184],"length":1,"stats":{"Line":0}},{"line":103,"address":[15356940],"length":1,"stats":{"Line":0}},{"line":104,"address":[15534888],"length":1,"stats":{"Line":0}},{"line":105,"address":[15534826],"length":1,"stats":{"Line":0}},{"line":106,"address":[15534850,15538009],"length":1,"stats":{"Line":0}},{"line":107,"address":[15538078],"length":1,"stats":{"Line":0}},{"line":111,"address":[15550640,15550654,15535044,15534950],"length":1,"stats":{"Line":0}},{"line":114,"address":[15536898,15535221,15536005],"length":1,"stats":{"Line":0}},{"line":115,"address":[15535306,15536773],"length":1,"stats":{"Line":0}},{"line":116,"address":[15536760,15535274,15535323],"length":1,"stats":{"Line":0}},{"line":117,"address":[15535369,15536635],"length":1,"stats":{"Line":0}},{"line":118,"address":[15535337,15535386,15535449,15536622],"length":1,"stats":{"Line":0}},{"line":119,"address":[15536497,15535432],"length":1,"stats":{"Line":0}},{"line":120,"address":[15536484,15535463],"length":1,"stats":{"Line":0}},{"line":121,"address":[15536359,15535548],"length":1,"stats":{"Line":0}},{"line":122,"address":[15535516,15536346,15535565],"length":1,"stats":{"Line":0}},{"line":123,"address":[15535611,15536221],"length":1,"stats":{"Line":0}},{"line":124,"address":[15535579,15535628,15536208],"length":1,"stats":{"Line":0}},{"line":125,"address":[15535686,15536083],"length":1,"stats":{"Line":0}},{"line":126,"address":[15535642,15535703],"length":1,"stats":{"Line":0}},{"line":127,"address":[15535751,15535872],"length":1,"stats":{"Line":0}},{"line":129,"address":[15535717,15535758],"length":1,"stats":{"Line":0}},{"line":130,"address":[15535827],"length":1,"stats":{"Line":0}},{"line":133,"address":[15536058,15536957],"length":1,"stats":{"Line":0}},{"line":134,"address":[15537001,15537777],"length":1,"stats":{"Line":0}},{"line":135,"address":[15537932],"length":1,"stats":{"Line":0}},{"line":138,"address":[15537055],"length":1,"stats":{"Line":0}},{"line":145,"address":[15537320,15537443],"length":1,"stats":{"Line":0}},{"line":147,"address":[15550615,15537413,15550416,15550548,15550609],"length":1,"stats":{"Line":0}},{"line":148,"address":[15550452],"length":1,"stats":{"Line":0}},{"line":149,"address":[15550461],"length":1,"stats":{"Line":0}},{"line":150,"address":[15550490],"length":1,"stats":{"Line":0}},{"line":155,"address":[15537473],"length":1,"stats":{"Line":0}},{"line":156,"address":[15356961],"length":1,"stats":{"Line":0}},{"line":157,"address":[15538446],"length":1,"stats":{"Line":0}},{"line":158,"address":[15538388],"length":1,"stats":{"Line":0}},{"line":159,"address":[15538412,15550212],"length":1,"stats":{"Line":0}},{"line":160,"address":[15550281],"length":1,"stats":{"Line":0}},{"line":165,"address":[15538510,15538593],"length":1,"stats":{"Line":0}},{"line":168,"address":[15538621],"length":1,"stats":{"Line":0}},{"line":169,"address":[15538632],"length":1,"stats":{"Line":0}},{"line":170,"address":[15538643],"length":1,"stats":{"Line":0}},{"line":171,"address":[15538654],"length":1,"stats":{"Line":0}},{"line":172,"address":[15538665],"length":1,"stats":{"Line":0}},{"line":173,"address":[15538676],"length":1,"stats":{"Line":0}},{"line":175,"address":[15538703,15538793],"length":1,"stats":{"Line":0}},{"line":176,"address":[15539148,15547851],"length":1,"stats":{"Line":0}},{"line":178,"address":[15547956],"length":1,"stats":{"Line":0}},{"line":182,"address":[15547989,15548053],"length":1,"stats":{"Line":0}},{"line":183,"address":[15548023],"length":1,"stats":{"Line":0}},{"line":184,"address":[15548133,15548275],"length":1,"stats":{"Line":0}},{"line":185,"address":[15548241,15548113],"length":1,"stats":{"Line":0}},{"line":186,"address":[15548207,15548093],"length":1,"stats":{"Line":0}},{"line":187,"address":[15548161,15548073],"length":1,"stats":{"Line":0}},{"line":190,"address":[15548196,15549215,15549776,15548963,15549450,15548343,15548641,15548305,15549297,15549521,15548712,15549147,15549705,15548413,15548896],"length":1,"stats":{"Line":0}},{"line":194,"address":[15549195,15549265],"length":1,"stats":{"Line":0}},{"line":202,"address":[15539182],"length":1,"stats":{"Line":0}},{"line":203,"address":[15539247],"length":1,"stats":{"Line":0}},{"line":204,"address":[15545276,15539336,15545134,15544569,15544641,15544761,15544531,15544788,15545210,15545504,15545079,15546067,15546251,15546317,15546647,15546713,15547636,15545567,15545751,15545817,15546001],"length":1,"stats":{"Line":0}},{"line":205,"address":[15544620,15544695],"length":1,"stats":{"Line":0}},{"line":215,"address":[15546947,15546998],"length":1,"stats":{"Line":0}},{"line":217,"address":[15539302,15539353],"length":1,"stats":{"Line":0}},{"line":218,"address":[15540348,15539394],"length":1,"stats":{"Line":0}},{"line":219,"address":[15540375],"length":1,"stats":{"Line":0}},{"line":220,"address":[15540573],"length":1,"stats":{"Line":0}},{"line":221,"address":[15540782],"length":1,"stats":{"Line":0}},{"line":222,"address":[15540827],"length":1,"stats":{"Line":0}},{"line":223,"address":[15540872],"length":1,"stats":{"Line":0}},{"line":224,"address":[15540925],"length":1,"stats":{"Line":0}},{"line":225,"address":[15541029],"length":1,"stats":{"Line":0}},{"line":226,"address":[15541133],"length":1,"stats":{"Line":0}},{"line":227,"address":[15541237],"length":1,"stats":{"Line":0}},{"line":228,"address":[15541341],"length":1,"stats":{"Line":0}},{"line":230,"address":[15541445],"length":1,"stats":{"Line":0}},{"line":231,"address":[15541476],"length":1,"stats":{"Line":0}},{"line":232,"address":[15541521],"length":1,"stats":{"Line":0}},{"line":233,"address":[15541690],"length":1,"stats":{"Line":0}},{"line":234,"address":[15541933,15541852],"length":1,"stats":{"Line":0}},{"line":235,"address":[15541907,15542020,15541972],"length":1,"stats":{"Line":0}},{"line":236,"address":[15542091,15541994,15542056],"length":1,"stats":{"Line":0}},{"line":237,"address":[15542062],"length":1,"stats":{"Line":0}},{"line":239,"address":[15542285],"length":1,"stats":{"Line":0}},{"line":244,"address":[15542607],"length":1,"stats":{"Line":0}},{"line":245,"address":[15543348,15543179],"length":1,"stats":{"Line":0}},{"line":254,"address":[15542821,15543740],"length":1,"stats":{"Line":0}},{"line":262,"address":[15543703,15544507],"length":1,"stats":{"Line":0}},{"line":268,"address":[15539367,15539439],"length":1,"stats":{"Line":0}},{"line":269,"address":[15539602],"length":1,"stats":{"Line":0}},{"line":270,"address":[15539706],"length":1,"stats":{"Line":0}},{"line":271,"address":[15539810],"length":1,"stats":{"Line":0}},{"line":272,"address":[15539914],"length":1,"stats":{"Line":0}},{"line":273,"address":[15540010],"length":1,"stats":{"Line":0}},{"line":274,"address":[15540063],"length":1,"stats":{"Line":0}},{"line":276,"address":[15540159],"length":1,"stats":{"Line":0}},{"line":277,"address":[15540230,15540169],"length":1,"stats":{"Line":0}},{"line":279,"address":[15540277,15540203],"length":1,"stats":{"Line":0}},{"line":285,"address":[15540259,15547222],"length":1,"stats":{"Line":0}},{"line":286,"address":[15547234],"length":1,"stats":{"Line":0}},{"line":288,"address":[15547214],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":114},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","cargo.rs"],"content":"//! Parser for Cargo.toml files using structured TOML parsing\n\nuse super::{Dependency, Parser};\nuse taplo::dom::Node;\nuse taplo::parser::parse;\n\n/// Parser for Rust Cargo.toml dependency files\n#[derive(Debug, Default)]\npub struct CargoParser;\n\nimpl CargoParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for CargoParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let parsed = parse(content);\n\n        // If there are critical parse errors, return empty\n        if parsed.errors.iter().any(|e| e.message.contains(\"expected\")) {\n            return Vec::new();\n        }\n\n        let dom = parsed.into_dom();\n\n        let mut dependencies = Vec::new();\n\n        // Define dependency sections to parse: (section_name, is_dev)\n        let sections = [\n            (\"dependencies\", false),\n            (\"dev-dependencies\", true),\n            (\"build-dependencies\", false),\n        ];\n\n        for (section_name, is_dev) in sections {\n            // Parse regular section dependencies (e.g., [dependencies])\n            if let Some(section) = dom.get(section_name).as_table() {\n                let entries = section.entries().read();\n                for (key, value) in entries.iter() {\n                    let name = key.value().to_string();\n                    if let Some(dep) = parse_dependency(\u0026name, value, content, is_dev) {\n                        dependencies.push(dep);\n                    }\n                }\n            }\n\n            // Parse table-style dependencies (e.g., [dependencies.reqwest])\n            let pattern = format!(\"{}.*\", section_name);\n            if let Ok(keys) = pattern.parse::\u003ctaplo::dom::Keys\u003e()\n                \u0026\u0026 let Ok(matches) = dom.find_all_matches(keys, false)\n            {\n                for (key_path, node) in matches {\n                    // Extract the dependency name from the key path\n                    let key_str = key_path.to_string();\n                    let name = key_str\n                        .split('.')\n                        .next_back()\n                        .unwrap_or(\u0026key_str)\n                        .to_string();\n\n                    // For table dependencies, look for the version key\n                    if let Some(table) = node.as_table()\n                        \u0026\u0026 let Some(version_node) = table.get(\"version\")\n                        \u0026\u0026 let Some(version_str) = version_node.as_str()\n                    {\n                        let version = version_str.value().to_string();\n                        let optional = table\n                            .get(\"optional\")\n                            .and_then(|n| n.as_bool().map(|b| b.value()))\n                            .unwrap_or(false);\n\n                        if let Some((line, name_start, name_end, version_start, version_end)) =\n                            find_table_dependency_positions(content, \u0026name, \u0026version)\n                        {\n                            dependencies.push(Dependency {\n                                name,\n                                version,\n                                line,\n                                name_start,\n                                name_end,\n                                version_start,\n                                version_end,\n                                dev: is_dev,\n                                optional,\n                            });\n                        }\n                    }\n                }\n            }\n        }\n\n        dependencies\n    }\n}\n\n/// Parse a single dependency from a TOML node\nfn parse_dependency(name: \u0026str, node: \u0026Node, content: \u0026str, is_dev: bool) -\u003e Option\u003cDependency\u003e {\n    match node {\n        Node::Str(s) =\u003e {\n            // Simple dependency: name = \"1.0.0\"\n            let version = s.value().to_string();\n            let (line, name_start, name_end, version_start, version_end) =\n                find_simple_dependency_positions(content, name, \u0026version)?;\n\n            Some(Dependency {\n                name: name.to_string(),\n                version,\n                line,\n                name_start,\n                name_end,\n                version_start,\n                version_end,\n                dev: is_dev,\n                optional: false,\n            })\n        }\n        Node::Table(table) =\u003e {\n            // Inline table: name = { version = \"1.0.0\", ... }\n            let version_node = table.get(\"version\")?;\n            let version_str = version_node.as_str()?;\n            let version = version_str.value().to_string();\n\n            let optional = table\n                .get(\"optional\")\n                .and_then(|n| n.as_bool().map(|b| b.value()))\n                .unwrap_or(false);\n\n            let (line, name_start, name_end, version_start, version_end) =\n                find_inline_table_positions(content, name, \u0026version)?;\n\n            Some(Dependency {\n                name: name.to_string(),\n                version,\n                line,\n                name_start,\n                name_end,\n                version_start,\n                version_end,\n                dev: is_dev,\n                optional,\n            })\n        }\n        _ =\u003e None,\n    }\n}\n\n/// Find positions for a simple dependency: `name = \"version\"`\nfn find_simple_dependency_positions(\n    content: \u0026str,\n    name: \u0026str,\n    version: \u0026str,\n) -\u003e Option\u003c(u32, u32, u32, u32, u32)\u003e {\n    for (line_idx, line) in content.lines().enumerate() {\n        // Look for pattern: name = \"version\" or name = 'version'\n        let trimmed = line.trim();\n        if !trimmed.starts_with(name) {\n            continue;\n        }\n\n        // Check if this line has the exact name followed by =\n        let after_name = trimmed[name.len()..].trim_start();\n        if !after_name.starts_with('=') {\n            continue;\n        }\n\n        // Check for simple string value (not inline table)\n        let after_eq = after_name[1..].trim_start();\n        if after_eq.starts_with('{') {\n            continue; // This is an inline table, skip\n        }\n\n        // Check if version is in this line\n        if !line.contains(version) {\n            continue;\n        }\n\n        // Calculate positions\n        let name_start = line.find(name)? as u32;\n        let name_end = name_start + name.len() as u32;\n\n        // Find version position (inside quotes)\n        let version_start = line.find(version)? as u32;\n        let version_end = version_start + version.len() as u32;\n\n        return Some((\n            line_idx as u32,\n            name_start,\n            name_end,\n            version_start,\n            version_end,\n        ));\n    }\n    None\n}\n\n/// Find positions for an inline table dependency: `name = { version = \"1.0.0\", ... }`\nfn find_inline_table_positions(\n    content: \u0026str,\n    name: \u0026str,\n    version: \u0026str,\n) -\u003e Option\u003c(u32, u32, u32, u32, u32)\u003e {\n    for (line_idx, line) in content.lines().enumerate() {\n        let trimmed = line.trim();\n        if !trimmed.starts_with(name) {\n            continue;\n        }\n\n        // Check if this line has the name followed by = and {\n        let after_name = trimmed[name.len()..].trim_start();\n        if !after_name.starts_with('=') {\n            continue;\n        }\n\n        let after_eq = after_name[1..].trim_start();\n        if !after_eq.starts_with('{') {\n            continue;\n        }\n\n        // Check if version is in this line\n        if !line.contains(version) {\n            continue;\n        }\n\n        // Calculate positions\n        let name_start = line.find(name)? as u32;\n        let name_end = name_start + name.len() as u32;\n\n        // Find version position (inside quotes after \"version =\")\n        let version_start = line.find(version)? as u32;\n        let version_end = version_start + version.len() as u32;\n\n        return Some((\n            line_idx as u32,\n            name_start,\n            name_end,\n            version_start,\n            version_end,\n        ));\n    }\n    None\n}\n\n/// Find positions for a table dependency: `[dependencies.name]` with `version = \"x.y.z\"`\nfn find_table_dependency_positions(\n    content: \u0026str,\n    name: \u0026str,\n    version: \u0026str,\n) -\u003e Option\u003c(u32, u32, u32, u32, u32)\u003e {\n    let mut found_table = false;\n    let mut name_start = 0u32;\n    let mut name_end = 0u32;\n\n    for (line_idx, line) in content.lines().enumerate() {\n        let trimmed = line.trim();\n\n        // Look for the table header containing the dependency name\n        if trimmed.starts_with('[') \u0026\u0026 trimmed.ends_with(']') \u0026\u0026 trimmed.contains(name) {\n            // Check if this is a dependencies table\n            let inner = \u0026trimmed[1..trimmed.len() - 1];\n            if inner.contains(\"dependencies.\") \u0026\u0026 inner.ends_with(name) {\n                found_table = true;\n                // Name position is in the header after the last dot\n                if let Some(dot_pos) = line.rfind('.') {\n                    name_start = (dot_pos + 1) as u32;\n                    name_end = (line.len() - 1) as u32; // Before the closing ]\n                }\n                continue;\n            }\n        }\n\n        // If we found the table, look for version = \"x.y.z\"\n        if found_table {\n            // Check if we hit a new section\n            if trimmed.starts_with('[') {\n                break;\n            }\n\n            if trimmed.starts_with(\"version\") \u0026\u0026 line.contains(version) {\n                let version_start = line.find(version)? as u32;\n                let version_end = version_start + version.len() as u32;\n                return Some((\n                    line_idx as u32,\n                    name_start,\n                    name_end,\n                    version_start,\n                    version_end,\n                ));\n            }\n        }\n    }\n    None\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_simple_dependency() {\n        let parser = CargoParser::new();\n        let content = r#\"\n[dependencies]\nserde = \"1.0.0\"\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"serde\");\n        assert_eq!(deps[0].version, \"1.0.0\");\n        assert!(!deps[0].dev);\n    }\n\n    #[test]\n    fn test_inline_table_dependency() {\n        let parser = CargoParser::new();\n        let content = r#\"\n[dependencies]\nserde = { version = \"1.0.0\", features = [\"derive\"] }\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"serde\");\n        assert_eq!(deps[0].version, \"1.0.0\");\n    }\n\n    #[test]\n    fn test_dev_dependencies() {\n        let parser = CargoParser::new();\n        let content = r#\"\n[dev-dependencies]\ntokio-test = \"0.4\"\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"tokio-test\");\n        assert!(deps[0].dev);\n    }\n\n    #[test]\n    fn test_multiple_sections() {\n        let parser = CargoParser::new();\n        let content = r#\"\n[package]\nname = \"test\"\n\n[dependencies]\nserde = \"1.0\"\ntokio = { version = \"1.0\", features = [\"full\"] }\n\n[dev-dependencies]\ncriterion = \"0.5\"\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 3);\n\n        let serde = deps.iter().find(|d| d.name == \"serde\").unwrap();\n        assert_eq!(serde.version, \"1.0\");\n        assert!(!serde.dev);\n\n        let tokio = deps.iter().find(|d| d.name == \"tokio\").unwrap();\n        assert_eq!(tokio.version, \"1.0\");\n        assert!(!tokio.dev);\n\n        let criterion = deps.iter().find(|d| d.name == \"criterion\").unwrap();\n        assert_eq!(criterion.version, \"0.5\");\n        assert!(criterion.dev);\n    }\n\n    #[test]\n    fn test_table_dependency() {\n        let parser = CargoParser::new();\n        let content = r#\"\n[dependencies.reqwest]\nversion = \"0.12\"\nfeatures = [\"json\"]\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"reqwest\");\n        assert_eq!(deps[0].version, \"0.12\");\n    }\n\n    #[test]\n    fn test_optional_dependency() {\n        let parser = CargoParser::new();\n        let content = r#\"\n[dependencies]\noptional-dep = { version = \"1.0\", optional = true }\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert!(deps[0].optional);\n    }\n}\n","traces":[{"line":18,"address":[13773568,13775816,13778658],"length":1,"stats":{"Line":6}},{"line":19,"address":[14459109],"length":1,"stats":{"Line":7}},{"line":22,"address":[13024528,13024553],"length":1,"stats":{"Line":10}},{"line":23,"address":[13773983],"length":1,"stats":{"Line":0}},{"line":26,"address":[18570248,18570357],"length":1,"stats":{"Line":10}},{"line":28,"address":[18570381],"length":1,"stats":{"Line":6}},{"line":31,"address":[18570537],"length":1,"stats":{"Line":6}},{"line":32,"address":[12895168],"length":1,"stats":{"Line":6}},{"line":33,"address":[13774127],"length":1,"stats":{"Line":6}},{"line":34,"address":[14459618],"length":1,"stats":{"Line":7}},{"line":37,"address":[12895512,12895598,12895369],"length":1,"stats":{"Line":22}},{"line":39,"address":[12895830,12895678,12895925],"length":1,"stats":{"Line":22}},{"line":40,"address":[12895980,12896029],"length":1,"stats":{"Line":13}},{"line":41,"address":[14460492,14460571],"length":1,"stats":{"Line":13}},{"line":42,"address":[13775362,13775481],"length":1,"stats":{"Line":13}},{"line":43,"address":[12896560,12896674],"length":1,"stats":{"Line":13}},{"line":44,"address":[12896833,12896862],"length":1,"stats":{"Line":7}},{"line":50,"address":[14460891,14461278],"length":1,"stats":{"Line":6}},{"line":51,"address":[13776115,13775930,13776013],"length":1,"stats":{"Line":9}},{"line":52,"address":[13776333,13776147,13776250],"length":1,"stats":{"Line":10}},{"line":54,"address":[18572677,18572905,18572770],"length":1,"stats":{"Line":9}},{"line":56,"address":[12897749],"length":1,"stats":{"Line":3}},{"line":57,"address":[12897956],"length":1,"stats":{"Line":3}},{"line":60,"address":[12898131],"length":1,"stats":{"Line":3}},{"line":64,"address":[13777224,13777300],"length":1,"stats":{"Line":9}},{"line":65,"address":[12898454,12898392],"length":1,"stats":{"Line":8}},{"line":66,"address":[14463027,14462954],"length":1,"stats":{"Line":8}},{"line":68,"address":[13777626,13777679],"length":1,"stats":{"Line":6}},{"line":69,"address":[12898866],"length":1,"stats":{"Line":3}},{"line":71,"address":[13024606,13024720,13024729,13024592],"length":1,"stats":{"Line":13}},{"line":74,"address":[14463311],"length":1,"stats":{"Line":4}},{"line":77,"address":[12899186,12899341],"length":1,"stats":{"Line":4}},{"line":78,"address":[14463534],"length":1,"stats":{"Line":2}},{"line":79,"address":[18574410],"length":1,"stats":{"Line":2}},{"line":94,"address":[12895748],"length":1,"stats":{"Line":4}},{"line":99,"address":[14454997,14454989,14453536],"length":1,"stats":{"Line":6}},{"line":100,"address":[13768206],"length":1,"stats":{"Line":6}},{"line":101,"address":[14453838],"length":1,"stats":{"Line":5}},{"line":103,"address":[12889497],"length":1,"stats":{"Line":5}},{"line":104,"address":[13768439,13769643],"length":1,"stats":{"Line":5}},{"line":107,"address":[14455424],"length":1,"stats":{"Line":5}},{"line":108,"address":[12890938],"length":1,"stats":{"Line":4}},{"line":109,"address":[12890994],"length":1,"stats":{"Line":4}},{"line":119,"address":[13768278],"length":1,"stats":{"Line":3}},{"line":121,"address":[14453754,14453929],"length":1,"stats":{"Line":5}},{"line":122,"address":[14454061,14453988,14454995],"length":1,"stats":{"Line":8}},{"line":123,"address":[13768703],"length":1,"stats":{"Line":3}},{"line":125,"address":[14454347],"length":1,"stats":{"Line":3}},{"line":127,"address":[14454304],"length":1,"stats":{"Line":13}},{"line":130,"address":[12889998],"length":1,"stats":{"Line":3}},{"line":133,"address":[13769297],"length":1,"stats":{"Line":3}},{"line":134,"address":[13769188],"length":1,"stats":{"Line":4}},{"line":135,"address":[14454705],"length":1,"stats":{"Line":4}},{"line":145,"address":[13768252],"length":1,"stats":{"Line":0}},{"line":150,"address":[12893536],"length":1,"stats":{"Line":5}},{"line":155,"address":[14458080,14457997],"length":1,"stats":{"Line":10}},{"line":157,"address":[14458196],"length":1,"stats":{"Line":5}},{"line":158,"address":[12893875],"length":1,"stats":{"Line":5}},{"line":163,"address":[12893924],"length":1,"stats":{"Line":5}},{"line":164,"address":[14458366],"length":1,"stats":{"Line":6}},{"line":169,"address":[14458396],"length":1,"stats":{"Line":4}},{"line":170,"address":[14458447],"length":1,"stats":{"Line":4}},{"line":175,"address":[12894118],"length":1,"stats":{"Line":4}},{"line":180,"address":[14458521],"length":1,"stats":{"Line":4}},{"line":181,"address":[12894357,12894253],"length":1,"stats":{"Line":4}},{"line":184,"address":[12894307,12894375],"length":1,"stats":{"Line":4}},{"line":185,"address":[13773336,13773473],"length":1,"stats":{"Line":4}},{"line":187,"address":[18569742],"length":1,"stats":{"Line":4}},{"line":195,"address":[14458263],"length":1,"stats":{"Line":0}},{"line":199,"address":[14455616],"length":1,"stats":{"Line":3}},{"line":204,"address":[18566688,18566605],"length":1,"stats":{"Line":6}},{"line":205,"address":[13770452],"length":1,"stats":{"Line":3}},{"line":206,"address":[13770499],"length":1,"stats":{"Line":3}},{"line":211,"address":[18566900],"length":1,"stats":{"Line":3}},{"line":212,"address":[14456078],"length":1,"stats":{"Line":4}},{"line":216,"address":[18567004],"length":1,"stats":{"Line":4}},{"line":217,"address":[13770703],"length":1,"stats":{"Line":4}},{"line":222,"address":[18567095],"length":1,"stats":{"Line":4}},{"line":227,"address":[14456234],"length":1,"stats":{"Line":4}},{"line":228,"address":[14456335,14456439],"length":1,"stats":{"Line":4}},{"line":231,"address":[18567284,18567352],"length":1,"stats":{"Line":4}},{"line":232,"address":[13771186,13771049],"length":1,"stats":{"Line":4}},{"line":234,"address":[13771105],"length":1,"stats":{"Line":4}},{"line":242,"address":[18566871],"length":1,"stats":{"Line":2}},{"line":246,"address":[13771200],"length":1,"stats":{"Line":5}},{"line":251,"address":[13771296],"length":1,"stats":{"Line":4}},{"line":252,"address":[12892392],"length":1,"stats":{"Line":4}},{"line":253,"address":[13771315],"length":1,"stats":{"Line":4}},{"line":255,"address":[14456782,14456865],"length":1,"stats":{"Line":9}},{"line":256,"address":[14456981],"length":1,"stats":{"Line":4}},{"line":259,"address":[12892650,12892712],"length":1,"stats":{"Line":12}},{"line":261,"address":[13771683,13771798],"length":1,"stats":{"Line":2}},{"line":262,"address":[13771771,13771831],"length":1,"stats":{"Line":4}},{"line":263,"address":[13771856],"length":1,"stats":{"Line":2}},{"line":265,"address":[14457320,14457770,14457873],"length":1,"stats":{"Line":6}},{"line":266,"address":[13772393,13772330],"length":1,"stats":{"Line":2}},{"line":267,"address":[18568761,18568720,18568773],"length":1,"stats":{"Line":4}},{"line":274,"address":[12892683],"length":1,"stats":{"Line":4}},{"line":276,"address":[13771924],"length":1,"stats":{"Line":2}},{"line":280,"address":[12893041],"length":1,"stats":{"Line":2}},{"line":281,"address":[12893129],"length":1,"stats":{"Line":2}},{"line":282,"address":[18568639,18568496],"length":1,"stats":{"Line":2}},{"line":283,"address":[13772210],"length":1,"stats":{"Line":2}},{"line":284,"address":[12893280],"length":1,"stats":{"Line":2}},{"line":285,"address":[14457652],"length":1,"stats":{"Line":2}},{"line":286,"address":[13772203],"length":1,"stats":{"Line":2}},{"line":293,"address":[13771584],"length":1,"stats":{"Line":4}}],"covered":104,"coverable":107},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","csharp.rs"],"content":"//! Parser for C# .csproj files (NuGet PackageReference format)\n\nuse super::{Dependency, Parser};\n\n/// Parser for C# .csproj files\n#[derive(Debug, Default)]\npub struct CsharpParser;\n\nimpl CsharpParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for CsharpParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let mut dependencies = Vec::new();\n\n        for (line_idx, line) in content.lines().enumerate() {\n            let line_num = line_idx as u32;\n            let trimmed = line.trim();\n\n            // Look for PackageReference elements\n            // Format 1: \u003cPackageReference Include=\"Package\" Version=\"1.0.0\" /\u003e\n            // Format 2: \u003cPackageReference Include=\"Package\"\u003e\u003cVersion\u003e1.0.0\u003c/Version\u003e\u003c/PackageReference\u003e\n            if trimmed.contains(\"\u003cPackageReference\")\n                \u0026\u0026 trimmed.contains(\"Include=\")\n                \u0026\u0026 let Some(dep) = parse_package_reference(line, line_num)\n            {\n                dependencies.push(dep);\n            }\n        }\n\n        dependencies\n    }\n}\n\n/// Parse a PackageReference XML element\nfn parse_package_reference(line: \u0026str, line_num: u32) -\u003e Option\u003cDependency\u003e {\n    // Extract Include attribute (package name)\n    let include_start = line.find(\"Include=\\\"\")? + 9;\n    let include_content = \u0026line[include_start..];\n    let include_end = include_content.find('\"')?;\n    let name = \u0026include_content[..include_end];\n\n    // Try to find Version attribute on same line\n    let version = if let Some(version_attr_start) = line.find(\"Version=\\\"\") {\n        let version_content = \u0026line[version_attr_start + 9..];\n        let version_end = version_content.find('\"')?;\n        version_content[..version_end].to_string()\n    } else if let Some(version_elem_start) = line.find(\"\u003cVersion\u003e\") {\n        // Format: \u003cVersion\u003e1.0.0\u003c/Version\u003e\n        let version_content = \u0026line[version_elem_start + 9..];\n        let version_end = version_content.find('\u003c')?;\n        version_content[..version_end].to_string()\n    } else {\n        // Version might be centrally managed (Directory.Packages.props)\n        // Skip for now\n        return None;\n    };\n\n    // Calculate positions\n    let name_pattern = format!(\"\\\"{}\\\"\", name);\n    let name_pos = line.find(\u0026name_pattern)?;\n    let name_start = (name_pos + 1) as u32;\n    let name_end = name_start + name.len() as u32;\n\n    let version_start = line.find(\u0026version)? as u32;\n    let version_end = version_start + version.len() as u32;\n\n    Some(Dependency {\n        name: name.to_string(),\n        version,\n        line: line_num,\n        name_start,\n        name_end,\n        version_start,\n        version_end,\n        dev: false, // NuGet doesn't have explicit dev dependencies in .csproj\n        optional: false,\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_self_closing() {\n        let content = r#\"\n\u003cProject Sdk=\"Microsoft.NET.Sdk\"\u003e\n  \u003cPropertyGroup\u003e\n    \u003cTargetFramework\u003enet8.0\u003c/TargetFramework\u003e\n  \u003c/PropertyGroup\u003e\n  \u003cItemGroup\u003e\n    \u003cPackageReference Include=\"Newtonsoft.Json\" Version=\"13.0.3\" /\u003e\n    \u003cPackageReference Include=\"Serilog\" Version=\"3.1.1\" /\u003e\n  \u003c/ItemGroup\u003e\n\u003c/Project\u003e\n\"#;\n        let parser = CsharpParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n\n        let newtonsoft = deps.iter().find(|d| d.name == \"Newtonsoft.Json\").unwrap();\n        assert_eq!(newtonsoft.version, \"13.0.3\");\n\n        let serilog = deps.iter().find(|d| d.name == \"Serilog\").unwrap();\n        assert_eq!(serilog.version, \"3.1.1\");\n    }\n\n    #[test]\n    fn test_parse_expanded_format() {\n        let content = r#\"\n\u003cProject Sdk=\"Microsoft.NET.Sdk\"\u003e\n  \u003cItemGroup\u003e\n    \u003cPackageReference Include=\"Microsoft.Extensions.Logging\" Version=\"8.0.0\" /\u003e\n  \u003c/ItemGroup\u003e\n\u003c/Project\u003e\n\"#;\n        let parser = CsharpParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"Microsoft.Extensions.Logging\");\n        assert_eq!(deps[0].version, \"8.0.0\");\n    }\n\n    #[test]\n    fn test_version_positions() {\n        let content = r#\"\n\u003cProject\u003e\n  \u003cItemGroup\u003e\n    \u003cPackageReference Include=\"Serilog\" Version=\"3.1.1\" /\u003e\n  \u003c/ItemGroup\u003e\n\u003c/Project\u003e\n\"#;\n        let parser = CsharpParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 1);\n        let dep = \u0026deps[0];\n        assert!(dep.version_start \u003e dep.name_end);\n    }\n\n    #[test]\n    fn test_skip_no_version() {\n        let content = r#\"\n\u003cProject Sdk=\"Microsoft.NET.Sdk\"\u003e\n  \u003cItemGroup\u003e\n    \u003cPackageReference Include=\"Newtonsoft.Json\" /\u003e\n    \u003cPackageReference Include=\"Serilog\" Version=\"3.1.1\" /\u003e\n  \u003c/ItemGroup\u003e\n\u003c/Project\u003e\n\"#;\n        let parser = CsharpParser::new();\n        let deps = parser.parse(content);\n\n        // Should only find Serilog (Newtonsoft.Json has no version)\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"Serilog\");\n    }\n\n    #[test]\n    fn test_multiple_item_groups() {\n        let content = r#\"\n\u003cProject Sdk=\"Microsoft.NET.Sdk\"\u003e\n  \u003cItemGroup\u003e\n    \u003cPackageReference Include=\"Package1\" Version=\"1.0.0\" /\u003e\n  \u003c/ItemGroup\u003e\n  \u003cItemGroup Condition=\"'$(Configuration)'=='Debug'\"\u003e\n    \u003cPackageReference Include=\"Package2\" Version=\"2.0.0\" /\u003e\n  \u003c/ItemGroup\u003e\n\u003c/Project\u003e\n\"#;\n        let parser = CsharpParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n    }\n}\n","traces":[{"line":16,"address":[16506659,16506653,16505952],"length":1,"stats":{"Line":2}},{"line":17,"address":[14455523],"length":1,"stats":{"Line":2}},{"line":19,"address":[14455555,14455603],"length":1,"stats":{"Line":9}},{"line":20,"address":[14455803],"length":1,"stats":{"Line":6}},{"line":21,"address":[14484738,14484812],"length":1,"stats":{"Line":14}},{"line":26,"address":[14846420],"length":1,"stats":{"Line":8}},{"line":27,"address":[14846470],"length":1,"stats":{"Line":8}},{"line":28,"address":[16506500],"length":1,"stats":{"Line":8}},{"line":30,"address":[14485084],"length":1,"stats":{"Line":5}},{"line":34,"address":[16506309],"length":1,"stats":{"Line":4}},{"line":39,"address":[14484268,14482000,14484274],"length":1,"stats":{"Line":8}},{"line":41,"address":[14453163,14453428],"length":1,"stats":{"Line":8}},{"line":42,"address":[14453322],"length":1,"stats":{"Line":8}},{"line":43,"address":[14843916,14843992],"length":1,"stats":{"Line":8}},{"line":44,"address":[14453492],"length":1,"stats":{"Line":8}},{"line":47,"address":[16502527],"length":1,"stats":{"Line":8}},{"line":48,"address":[14453601,14453830,14453724],"length":1,"stats":{"Line":12}},{"line":49,"address":[14844317,14844393],"length":1,"stats":{"Line":7}},{"line":50,"address":[14844432],"length":1,"stats":{"Line":7}},{"line":51,"address":[14482571,14482908],"length":1,"stats":{"Line":2}},{"line":53,"address":[14844604,14844537,14844704],"length":1,"stats":{"Line":0}},{"line":54,"address":[14483036,14483112],"length":1,"stats":{"Line":0}},{"line":55,"address":[14483149],"length":1,"stats":{"Line":0}},{"line":59,"address":[16503016],"length":1,"stats":{"Line":2}},{"line":63,"address":[14454305,14453937],"length":1,"stats":{"Line":12}},{"line":64,"address":[16504291,16503417,16503488],"length":1,"stats":{"Line":10}},{"line":65,"address":[14483531,14483592],"length":1,"stats":{"Line":3}},{"line":66,"address":[14454693,14454763,14454636],"length":1,"stats":{"Line":7}},{"line":68,"address":[14483662,14483719,14484226],"length":1,"stats":{"Line":7}},{"line":69,"address":[14845512,14845433],"length":1,"stats":{"Line":5}},{"line":71,"address":[14845604],"length":1,"stats":{"Line":3}},{"line":72,"address":[14454953],"length":1,"stats":{"Line":4}},{"line":73,"address":[14455040],"length":1,"stats":{"Line":4}}],"covered":30,"coverable":33},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","dart.rs"],"content":"//! Parser for Dart/Flutter pubspec.yaml files\n\nuse super::{Dependency, Parser};\n\n/// Parser for Dart pubspec.yaml dependency files\n#[derive(Debug, Default)]\npub struct DartParser;\n\nimpl DartParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for DartParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let mut dependencies = Vec::new();\n        let mut current_section: Option\u003cDependencySection\u003e = None;\n        let mut in_nested_block = false;\n\n        for (line_idx, line) in content.lines().enumerate() {\n            let line_num = line_idx as u32;\n            let trimmed = line.trim();\n\n            // Skip comments and empty lines\n            if trimmed.is_empty() || trimmed.starts_with('#') {\n                continue;\n            }\n\n            // Check for section headers (no indentation, ends with :)\n            if !line.starts_with(' ') \u0026\u0026 !line.starts_with('\\t') \u0026\u0026 trimmed.ends_with(':') {\n                let section_name = trimmed.trim_end_matches(':');\n                current_section = match section_name {\n                    \"dependencies\" =\u003e Some(DependencySection::Dependencies),\n                    \"dev_dependencies\" =\u003e Some(DependencySection::DevDependencies),\n                    \"dependency_overrides\" =\u003e Some(DependencySection::DependencyOverrides),\n                    _ =\u003e None,\n                };\n                in_nested_block = false;\n                continue;\n            }\n\n            // Only process if we're in a dependency section\n            let Some(section) = \u0026current_section else {\n                continue;\n            };\n\n            // Check if we're exiting the section (new top-level key)\n            if !line.starts_with(' ') \u0026\u0026 !line.starts_with('\\t') {\n                current_section = None;\n                continue;\n            }\n\n            // Skip if we're in a nested block (git, path, sdk dependencies)\n            if in_nested_block {\n                // Check if this line is less indented than before (exit nested)\n                let indent = line.len() - line.trim_start().len();\n                if indent \u003c= 2 {\n                    in_nested_block = false;\n                } else {\n                    continue;\n                }\n            }\n\n            // Parse dependency line\n            if let Some(dep) = parse_dart_dependency_line(line, line_num, section.is_dev()) {\n                // Check if this is a complex dependency (sdk, git, path)\n                if is_complex_dependency(trimmed) {\n                    in_nested_block = true;\n                    continue;\n                }\n\n                // Skip Flutter SDK dependencies\n                if is_flutter_sdk_dependency(\u0026dep.name) {\n                    continue;\n                }\n\n                dependencies.push(dep);\n            } else if trimmed.ends_with(':') \u0026\u0026 !trimmed.contains(' ') {\n                // This is a package name without version on same line\n                // Could be a complex dependency\n                in_nested_block = true;\n            }\n        }\n\n        dependencies\n    }\n}\n\n#[derive(Debug, Clone, Copy)]\nenum DependencySection {\n    Dependencies,\n    DevDependencies,\n    DependencyOverrides,\n}\n\nimpl DependencySection {\n    fn is_dev(\u0026self) -\u003e bool {\n        matches!(self, DependencySection::DevDependencies)\n    }\n}\n\n/// Parse a single dependency line in YAML format\nfn parse_dart_dependency_line(line: \u0026str, line_num: u32, dev: bool) -\u003e Option\u003cDependency\u003e {\n    let trimmed = line.trim();\n\n    // Skip if it doesn't contain a colon\n    if !trimmed.contains(':') {\n        return None;\n    }\n\n    let colon_pos = trimmed.find(':')?;\n    let name = trimmed[..colon_pos].trim();\n    let version_part = trimmed[colon_pos + 1..].trim();\n\n    // Skip if no version (could be a complex dependency)\n    if version_part.is_empty() {\n        return None;\n    }\n\n    // Skip if it's a complex dependency (starts with { or contains special keys)\n    if version_part.starts_with('{') || !version_part.starts_with('^') \u0026\u0026 version_part.contains(':')\n    {\n        return None;\n    }\n\n    // Clean the version (remove quotes if present)\n    let version = version_part\n        .trim_matches('\"')\n        .trim_matches('\\'')\n        .to_string();\n\n    // Skip if version is empty or looks like a path/git/sdk reference\n    if version.is_empty() || version.starts_with('/') || version.starts_with('.') {\n        return None;\n    }\n\n    // Calculate positions\n    let name_start = line.find(name)? as u32;\n    let name_end = name_start + name.len() as u32;\n    let version_start = line.find(\u0026version)? as u32;\n    let version_end = version_start + version.len() as u32;\n\n    Some(Dependency {\n        name: name.to_string(),\n        version,\n        line: line_num,\n        name_start,\n        name_end,\n        version_start,\n        version_end,\n        dev,\n        optional: false,\n    })\n}\n\n/// Check if a line indicates a complex dependency (git, path, sdk)\nfn is_complex_dependency(line: \u0026str) -\u003e bool {\n    let trimmed = line.trim();\n    trimmed.ends_with(':') \u0026\u0026 !trimmed.contains(' ')\n        || trimmed.contains(\"sdk:\")\n        || trimmed.contains(\"git:\")\n        || trimmed.contains(\"path:\")\n        || trimmed.contains(\"hosted:\")\n}\n\n/// Check if a package is a Flutter SDK dependency\nfn is_flutter_sdk_dependency(name: \u0026str) -\u003e bool {\n    matches!(\n        name,\n        \"flutter\"\n            | \"flutter_test\"\n            | \"flutter_localizations\"\n            | \"flutter_driver\"\n            | \"flutter_web_plugins\"\n    )\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_simple_dependencies() {\n        let content = r#\"\nname: my_app\nversion: 1.0.0\n\ndependencies:\n  http: ^1.0.0\n  provider: ^6.0.0\n\ndev_dependencies:\n  mockito: ^5.4.0\n\"#;\n        let parser = DartParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 3);\n\n        let http = deps.iter().find(|d| d.name == \"http\").unwrap();\n        assert_eq!(http.version, \"^1.0.0\");\n        assert!(!http.dev);\n\n        let mockito = deps.iter().find(|d| d.name == \"mockito\").unwrap();\n        assert!(mockito.dev);\n    }\n\n    #[test]\n    fn test_skip_flutter_sdk() {\n        let content = r#\"\ndependencies:\n  flutter:\n    sdk: flutter\n  http: ^1.0.0\n\ndev_dependencies:\n  flutter_test:\n    sdk: flutter\n  mockito: ^5.4.0\n\"#;\n        let parser = DartParser::new();\n        let deps = parser.parse(content);\n\n        // Should only find http and mockito, not flutter or flutter_test\n        assert_eq!(deps.len(), 2);\n        assert!(deps.iter().any(|d| d.name == \"http\"));\n        assert!(deps.iter().any(|d| d.name == \"mockito\"));\n        assert!(!deps.iter().any(|d| d.name == \"flutter\"));\n        assert!(!deps.iter().any(|d| d.name == \"flutter_test\"));\n    }\n\n    #[test]\n    fn test_skip_git_dependencies() {\n        let content = r#\"\ndependencies:\n  http: ^1.0.0\n  custom_pkg:\n    git:\n      url: https://github.com/user/repo.git\n      ref: main\n  provider: ^6.0.0\n\"#;\n        let parser = DartParser::new();\n        let deps = parser.parse(content);\n\n        // Should only find http and provider\n        assert_eq!(deps.len(), 2);\n        assert!(deps.iter().any(|d| d.name == \"http\"));\n        assert!(deps.iter().any(|d| d.name == \"provider\"));\n    }\n\n    #[test]\n    fn test_version_positions() {\n        let content = r#\"\ndependencies:\n  http: ^1.0.0\n\"#;\n        let parser = DartParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 1);\n        let http = \u0026deps[0];\n        assert_eq!(http.name, \"http\");\n        assert!(http.version_start \u003e http.name_end);\n    }\n\n    #[test]\n    fn test_quoted_versions() {\n        let content = r#\"\ndependencies:\n  http: \"^1.0.0\"\n  provider: '^6.0.0'\n\"#;\n        let parser = DartParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n        assert_eq!(deps[0].version, \"^1.0.0\");\n        assert_eq!(deps[1].version, \"^6.0.0\");\n    }\n\n    #[test]\n    fn test_dependency_overrides() {\n        let content = r#\"\ndependencies:\n  http: ^1.0.0\n\ndependency_overrides:\n  http: ^1.1.0\n\"#;\n        let parser = DartParser::new();\n        let deps = parser.parse(content);\n\n        // Should find both (override and regular)\n        assert_eq!(deps.len(), 2);\n    }\n}\n","traces":[{"line":16,"address":[13858560,13858478,13856560],"length":1,"stats":{"Line":3}},{"line":17,"address":[12961823],"length":1,"stats":{"Line":4}},{"line":18,"address":[13856664],"length":1,"stats":{"Line":2}},{"line":19,"address":[13856672],"length":1,"stats":{"Line":5}},{"line":21,"address":[13856739,13856688],"length":1,"stats":{"Line":8}},{"line":22,"address":[12962140],"length":1,"stats":{"Line":7}},{"line":23,"address":[12962147,12962245],"length":1,"stats":{"Line":11}},{"line":26,"address":[13838803],"length":1,"stats":{"Line":5}},{"line":31,"address":[13838900,13839006],"length":1,"stats":{"Line":12}},{"line":32,"address":[13857362],"length":1,"stats":{"Line":7}},{"line":33,"address":[13857587],"length":1,"stats":{"Line":9}},{"line":34,"address":[13857496,13857430],"length":1,"stats":{"Line":11}},{"line":35,"address":[13857473,13857510,13857549],"length":1,"stats":{"Line":11}},{"line":36,"address":[13857579,13857563,13857526],"length":1,"stats":{"Line":6}},{"line":37,"address":[12962761],"length":1,"stats":{"Line":0}},{"line":39,"address":[17282585],"length":1,"stats":{"Line":3}},{"line":44,"address":[17282238,17282622],"length":1,"stats":{"Line":11}},{"line":49,"address":[12962838,12962920],"length":1,"stats":{"Line":3}},{"line":50,"address":[12962926],"length":1,"stats":{"Line":0}},{"line":55,"address":[12963122,12962904],"length":1,"stats":{"Line":11}},{"line":57,"address":[13857785,13857902],"length":1,"stats":{"Line":2}},{"line":58,"address":[12963083],"length":1,"stats":{"Line":2}},{"line":59,"address":[13839634],"length":1,"stats":{"Line":2}},{"line":66,"address":[12962947,12963622,12963154],"length":1,"stats":{"Line":18}},{"line":68,"address":[13858126,13858221],"length":1,"stats":{"Line":9}},{"line":69,"address":[13858252],"length":1,"stats":{"Line":0}},{"line":74,"address":[17283259,17283219],"length":1,"stats":{"Line":9}},{"line":78,"address":[13858296],"length":1,"stats":{"Line":7}},{"line":79,"address":[13840200,13839888,13840142,13840267,13839865,13840123,13840155],"length":1,"stats":{"Line":11}},{"line":82,"address":[13858547],"length":1,"stats":{"Line":2}},{"line":86,"address":[12962186],"length":1,"stats":{"Line":5}},{"line":98,"address":[17278592],"length":1,"stats":{"Line":9}},{"line":99,"address":[17278597],"length":1,"stats":{"Line":3}},{"line":104,"address":[13837986,13836160,13837992],"length":1,"stats":{"Line":2}},{"line":105,"address":[13854558],"length":1,"stats":{"Line":7}},{"line":108,"address":[17279209],"length":1,"stats":{"Line":3}},{"line":109,"address":[13836336],"length":1,"stats":{"Line":0}},{"line":112,"address":[13836367,13836446],"length":1,"stats":{"Line":8}},{"line":113,"address":[12960013],"length":1,"stats":{"Line":4}},{"line":114,"address":[12960077,12960194],"length":1,"stats":{"Line":8}},{"line":117,"address":[13836664],"length":1,"stats":{"Line":4}},{"line":118,"address":[12960248],"length":1,"stats":{"Line":2}},{"line":122,"address":[17279717,17279599,17279658],"length":1,"stats":{"Line":10}},{"line":124,"address":[12960307],"length":1,"stats":{"Line":0}},{"line":134,"address":[12960578,12960499,12960434],"length":1,"stats":{"Line":9}},{"line":135,"address":[13855330],"length":1,"stats":{"Line":0}},{"line":139,"address":[13837207,13837984],"length":1,"stats":{"Line":5}},{"line":140,"address":[17280244,17280331],"length":1,"stats":{"Line":5}},{"line":141,"address":[17280838,17280314,17280361],"length":1,"stats":{"Line":9}},{"line":142,"address":[17280556,17280475],"length":1,"stats":{"Line":5}},{"line":144,"address":[12961289],"length":1,"stats":{"Line":4}},{"line":145,"address":[13837663],"length":1,"stats":{"Line":5}},{"line":146,"address":[12961241],"length":1,"stats":{"Line":5}},{"line":158,"address":[12959248],"length":1,"stats":{"Line":4}},{"line":159,"address":[17278638],"length":1,"stats":{"Line":6}},{"line":160,"address":[13854132,13854060,13854117],"length":1,"stats":{"Line":3}},{"line":161,"address":[13835796],"length":1,"stats":{"Line":7}},{"line":162,"address":[13854148],"length":1,"stats":{"Line":3}},{"line":163,"address":[13854179],"length":1,"stats":{"Line":6}},{"line":164,"address":[13835922],"length":1,"stats":{"Line":4}},{"line":168,"address":[13835968],"length":1,"stats":{"Line":3}},{"line":169,"address":[13836044],"length":1,"stats":{"Line":0}}],"covered":55,"coverable":62},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","go.rs"],"content":"//! Parser for Go module files (go.mod)\n\nuse super::{Dependency, Parser};\n\n/// Parser for Go go.mod dependency files\n#[derive(Debug, Default)]\npub struct GoParser;\n\nimpl GoParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for GoParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let mut dependencies = Vec::new();\n        let mut in_require_block = false;\n\n        for (line_idx, line) in content.lines().enumerate() {\n            let line_num = line_idx as u32;\n            let trimmed = line.trim();\n\n            // Skip empty lines and comments\n            if trimmed.is_empty() || trimmed.starts_with(\"//\") {\n                continue;\n            }\n\n            // Check for require block start\n            if trimmed == \"require (\" {\n                in_require_block = true;\n                continue;\n            }\n\n            // Check for block end\n            if trimmed == \")\" {\n                in_require_block = false;\n                continue;\n            }\n\n            // Parse single-line require: require github.com/pkg/errors v0.9.1\n            if trimmed.starts_with(\"require \") \u0026\u0026 !trimmed.contains(\"(\") {\n                let rest = \u0026trimmed[8..]; // Skip \"require \"\n                if let Some(dep) = parse_require_line(line, rest, line_num) {\n                    dependencies.push(dep);\n                }\n                continue;\n            }\n\n            // Parse lines inside require block\n            if in_require_block \u0026\u0026 let Some(dep) = parse_require_line(line, trimmed, line_num) {\n                dependencies.push(dep);\n            }\n        }\n\n        dependencies\n    }\n}\n\n/// Parse a require line (either standalone or inside a block)\n/// Format: module/path v1.2.3 [// indirect]\nfn parse_require_line(line: \u0026str, content: \u0026str, line_num: u32) -\u003e Option\u003cDependency\u003e {\n    let trimmed = content.trim();\n\n    // Skip empty lines, comments, and replace directives\n    if trimmed.is_empty() || trimmed.starts_with(\"//\") || trimmed.starts_with(\"replace\") {\n        return None;\n    }\n\n    // Remove inline comment (// indirect or other comments)\n    let is_indirect = trimmed.contains(\"// indirect\");\n    let without_comment = if let Some(pos) = trimmed.find(\"//\") {\n        trimmed[..pos].trim()\n    } else {\n        trimmed\n    };\n\n    // Split into module path and version\n    let parts: Vec\u003c\u0026str\u003e = without_comment.split_whitespace().collect();\n    if parts.len() \u003c 2 {\n        return None;\n    }\n\n    let module_path = parts[0];\n    let version = parts[1];\n\n    // Version must start with 'v'\n    if !version.starts_with('v') {\n        return None;\n    }\n\n    // Calculate positions in the original line\n    let name_start = line.find(module_path)? as u32;\n    let name_end = name_start + module_path.len() as u32;\n    let version_start = line.find(version)? as u32;\n    let version_end = version_start + version.len() as u32;\n\n    Some(Dependency {\n        name: module_path.to_string(),\n        version: version.to_string(),\n        line: line_num,\n        name_start,\n        name_end,\n        version_start,\n        version_end,\n        dev: false,\n        optional: is_indirect, // Mark indirect dependencies as optional\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_simple_require() {\n        let parser = GoParser::new();\n        let content = r#\"\nmodule example.com/mymodule\n\ngo 1.21\n\nrequire github.com/pkg/errors v0.9.1\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"github.com/pkg/errors\");\n        assert_eq!(deps[0].version, \"v0.9.1\");\n        assert!(!deps[0].optional);\n    }\n\n    #[test]\n    fn test_require_block() {\n        let parser = GoParser::new();\n        let content = r#\"\nmodule example.com/mymodule\n\ngo 1.21\n\nrequire (\n    github.com/gin-gonic/gin v1.9.1\n    golang.org/x/text v0.14.0\n)\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 2);\n\n        let gin = deps.iter().find(|d| d.name.contains(\"gin\")).unwrap();\n        assert_eq!(gin.version, \"v1.9.1\");\n\n        let text = deps.iter().find(|d| d.name.contains(\"text\")).unwrap();\n        assert_eq!(text.version, \"v0.14.0\");\n    }\n\n    #[test]\n    fn test_indirect_dependency() {\n        let parser = GoParser::new();\n        let content = r#\"\nrequire (\n    github.com/direct/dep v1.0.0\n    github.com/indirect/dep v2.0.0 // indirect\n)\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 2);\n\n        let direct = deps.iter().find(|d| d.name.contains(\"direct\")).unwrap();\n        assert!(!direct.optional);\n\n        let indirect = deps.iter().find(|d| d.name.contains(\"indirect\")).unwrap();\n        assert!(indirect.optional);\n    }\n\n    #[test]\n    fn test_multiple_require_blocks() {\n        let parser = GoParser::new();\n        let content = r#\"\nrequire (\n    github.com/pkg/a v1.0.0\n)\n\nrequire (\n    github.com/pkg/b v2.0.0\n)\n\nrequire github.com/pkg/c v3.0.0\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 3);\n    }\n\n    #[test]\n    fn test_version_position() {\n        let parser = GoParser::new();\n        let content = \"require github.com/pkg/errors v0.9.1\";\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n\n        let dep = \u0026deps[0];\n        // \"require \" is 8 chars (0-7)\n        // \"github.com/pkg/errors\" is 21 chars (8-28), so name_end = 29\n        // \" \" is at position 29\n        // \"v0.9.1\" is 6 chars (30-35), so version_end = 36\n        assert_eq!(dep.name_start, 8);\n        assert_eq!(dep.name_end, 29);\n        assert_eq!(dep.version_start, 30);\n        assert_eq!(dep.version_end, 36);\n    }\n\n    #[test]\n    fn test_skip_replace_directives() {\n        let parser = GoParser::new();\n        let content = r#\"\nrequire github.com/old/pkg v1.0.0\n\nreplace github.com/old/pkg =\u003e github.com/new/pkg v2.0.0\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"github.com/old/pkg\");\n    }\n}\n","traces":[{"line":16,"address":[12989197,12989203,12988000],"length":1,"stats":{"Line":2}},{"line":17,"address":[14451875],"length":1,"stats":{"Line":2}},{"line":18,"address":[14451899],"length":1,"stats":{"Line":2}},{"line":20,"address":[14451915,14451963],"length":1,"stats":{"Line":6}},{"line":21,"address":[14481091],"length":1,"stats":{"Line":3}},{"line":22,"address":[14481169,14481098],"length":1,"stats":{"Line":6}},{"line":25,"address":[14452257],"length":1,"stats":{"Line":3}},{"line":30,"address":[15968587],"length":1,"stats":{"Line":3}},{"line":31,"address":[14481353],"length":1,"stats":{"Line":3}},{"line":36,"address":[15968627,15968674],"length":1,"stats":{"Line":10}},{"line":37,"address":[15968723],"length":1,"stats":{"Line":3}},{"line":42,"address":[15968740,15968680,15968765],"length":1,"stats":{"Line":12}},{"line":43,"address":[14481514],"length":1,"stats":{"Line":4}},{"line":44,"address":[14452684],"length":1,"stats":{"Line":4}},{"line":45,"address":[14452812],"length":1,"stats":{"Line":4}},{"line":51,"address":[14481442,14481784],"length":1,"stats":{"Line":5}},{"line":52,"address":[15969249],"length":1,"stats":{"Line":2}},{"line":56,"address":[12988365],"length":1,"stats":{"Line":6}},{"line":62,"address":[14451684,14451700,14449920],"length":1,"stats":{"Line":3}},{"line":63,"address":[14450045],"length":1,"stats":{"Line":2}},{"line":66,"address":[12986280,12986371],"length":1,"stats":{"Line":5}},{"line":67,"address":[15965473],"length":1,"stats":{"Line":0}},{"line":71,"address":[14479145],"length":1,"stats":{"Line":3}},{"line":72,"address":[12986459],"length":1,"stats":{"Line":5}},{"line":73,"address":[14450347],"length":1,"stats":{"Line":2}},{"line":75,"address":[14450405],"length":1,"stats":{"Line":4}},{"line":79,"address":[12986613],"length":1,"stats":{"Line":5}},{"line":80,"address":[14450570,14450499],"length":1,"stats":{"Line":11}},{"line":81,"address":[14479550],"length":1,"stats":{"Line":0}},{"line":84,"address":[14479504,14479576],"length":1,"stats":{"Line":12}},{"line":85,"address":[14479615],"length":1,"stats":{"Line":5}},{"line":88,"address":[15966091],"length":1,"stats":{"Line":7}},{"line":89,"address":[14479733],"length":1,"stats":{"Line":0}},{"line":93,"address":[14450852,14451695,14450902],"length":1,"stats":{"Line":12}},{"line":94,"address":[12987305,12987212],"length":1,"stats":{"Line":5}},{"line":95,"address":[14451100,14451151,14451690],"length":1,"stats":{"Line":12}},{"line":96,"address":[12987451,12987532],"length":1,"stats":{"Line":7}},{"line":98,"address":[14480414],"length":1,"stats":{"Line":5}},{"line":99,"address":[14451333],"length":1,"stats":{"Line":5}},{"line":100,"address":[14451383],"length":1,"stats":{"Line":7}}],"covered":37,"coverable":40},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","mod.rs"],"content":"//! Parsers for dependency files (Cargo.toml, package.json, etc.)\n\nuse serde::{Deserialize, Serialize};\n\n/// Represents a dependency extracted from a manifest file\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Dependency {\n    /// Package name\n    pub name: String,\n    /// Version specifier (e.g., \"1.0.0\", \"^1.0\", \"\u003e=1,\u003c2\")\n    pub version: String,\n    /// Line number in the file (0-indexed)\n    pub line: u32,\n    /// Column where the package name starts\n    pub name_start: u32,\n    /// Column where the package name ends\n    pub name_end: u32,\n    /// Column where the version string starts\n    pub version_start: u32,\n    /// Column where the version string ends\n    pub version_end: u32,\n    /// Whether this is a dev dependency\n    pub dev: bool,\n    /// Whether this dependency is optional\n    pub optional: bool,\n}\n\n/// Trait for parsing dependency files\npub trait Parser: Send + Sync {\n    /// Parse the given file content and extract dependencies\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e;\n}\n\npub mod cargo;\npub mod csharp;\npub mod dart;\npub mod go;\npub mod npm;\npub mod php;\npub mod python;\npub mod ruby;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","npm.rs"],"content":"//! Parser for package.json files\n\nuse super::{Dependency, Parser};\n\n/// Parser for npm package.json dependency files\n#[derive(Debug, Default)]\npub struct NpmParser;\n\nimpl NpmParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for NpmParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let mut dependencies = Vec::new();\n\n        // Track which section we're in\n        let mut current_section: Option\u003cDependencyType\u003e = None;\n        let mut section_brace_depth = 0;\n        let mut in_section_object = false;\n\n        for (line_idx, line) in content.lines().enumerate() {\n            let line_num = line_idx as u32;\n            let trimmed = line.trim();\n\n            // Check for section headers first\n            if let Some(section) = detect_section(trimmed) {\n                current_section = Some(section);\n                // Count braces after the section name to determine if we're in the object\n                let section_start = if trimmed.contains(\"devDependencies\") {\n                    trimmed.find(\"devDependencies\").unwrap() + \"devDependencies\".len()\n                } else if trimmed.contains(\"peerDependencies\") {\n                    trimmed.find(\"peerDependencies\").unwrap() + \"peerDependencies\".len()\n                } else if trimmed.contains(\"optionalDependencies\") {\n                    trimmed.find(\"optionalDependencies\").unwrap() + \"optionalDependencies\".len()\n                } else if trimmed.contains(\"dependencies\") {\n                    trimmed.find(\"dependencies\").unwrap() + \"dependencies\".len()\n                } else {\n                    0\n                };\n\n                let after_section = \u0026trimmed[section_start..];\n                if after_section.contains('{') {\n                    in_section_object = true;\n                    section_brace_depth = 1;\n\n                    // Handle inline dependencies on the same line as section header\n                    // e.g., {\"dependencies\": {\"pkg\": \"1.0.0\"}}\n                    if let Some(brace_pos) = after_section.find('{') {\n                        let deps_content = \u0026after_section[brace_pos + 1..];\n                        // Try to parse dependencies from this content\n                        for dep in parse_inline_dependencies(deps_content, line_num, section) {\n                            dependencies.push(dep);\n                        }\n                    }\n                }\n                continue;\n            }\n\n            // If we're looking for the opening brace of a section\n            if current_section.is_some()\n                \u0026\u0026 !in_section_object\n                \u0026\u0026 (trimmed.starts_with('{') || trimmed == \"{\")\n            {\n                in_section_object = true;\n                section_brace_depth = 1;\n                continue;\n            }\n\n            // Track brace depth within section\n            if in_section_object {\n                for ch in trimmed.chars() {\n                    match ch {\n                        '{' =\u003e section_brace_depth += 1,\n                        '}' =\u003e {\n                            section_brace_depth -= 1;\n                            if section_brace_depth == 0 {\n                                current_section = None;\n                                in_section_object = false;\n                            }\n                        }\n                        _ =\u003e {}\n                    }\n                }\n            }\n\n            // Parse dependency lines within sections\n            if let Some(section) = current_section\n                \u0026\u0026 in_section_object\n                \u0026\u0026 let Some(dep) = parse_dependency_line(line, line_num, section)\n            {\n                dependencies.push(dep);\n            }\n        }\n\n        dependencies\n    }\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\nenum DependencyType {\n    Normal,\n    Dev,\n    Peer,\n    Optional,\n}\n\n/// Parse inline dependencies from a single line content\n/// e.g., \"pkg\": \"1.0.0\", \"pkg2\": \"2.0.0\"}}\nfn parse_inline_dependencies(\n    content: \u0026str,\n    line_num: u32,\n    dep_type: DependencyType,\n) -\u003e Vec\u003cDependency\u003e {\n    let mut deps = Vec::new();\n    let mut remaining = content;\n\n    while let Some(first_quote) = remaining.find('\"') {\n        let after_first = \u0026remaining[first_quote + 1..];\n        let Some(name_end) = after_first.find('\"') else {\n            break;\n        };\n        let name = \u0026after_first[..name_end];\n\n        // Skip if it looks like a section header or closing\n        if name.ends_with(\"ependencies\") || name.is_empty() {\n            remaining = \u0026after_first[name_end + 1..];\n            continue;\n        }\n\n        // Find colon and version\n        let after_name = \u0026after_first[name_end + 1..];\n        let Some(colon_pos) = after_name.find(':') else {\n            remaining = after_name;\n            continue;\n        };\n\n        let after_colon = \u0026after_name[colon_pos + 1..];\n        let Some(version_quote_start) = after_colon.find('\"') else {\n            remaining = after_colon;\n            continue;\n        };\n\n        let version_content = \u0026after_colon[version_quote_start + 1..];\n        let Some(version_end) = version_content.find('\"') else {\n            remaining = version_content;\n            continue;\n        };\n\n        let version = \u0026version_content[..version_end];\n\n        deps.push(Dependency {\n            name: name.to_string(),\n            version: version.to_string(),\n            line: line_num,\n            name_start: 0, // Approximate for inline\n            name_end: 0,\n            version_start: 0,\n            version_end: 0,\n            dev: dep_type == DependencyType::Dev,\n            optional: dep_type == DependencyType::Optional || dep_type == DependencyType::Peer,\n        });\n\n        remaining = \u0026version_content[version_end + 1..];\n    }\n\n    deps\n}\n\nfn detect_section(line: \u0026str) -\u003e Option\u003cDependencyType\u003e {\n    let line = line.trim();\n\n    if line.contains(\"\\\"dependencies\\\"\") \u0026\u0026 !line.contains(\"\\\"devDependencies\\\"\") {\n        Some(DependencyType::Normal)\n    } else if line.contains(\"\\\"devDependencies\\\"\") {\n        Some(DependencyType::Dev)\n    } else if line.contains(\"\\\"peerDependencies\\\"\") {\n        Some(DependencyType::Peer)\n    } else if line.contains(\"\\\"optionalDependencies\\\"\") {\n        Some(DependencyType::Optional)\n    } else {\n        None\n    }\n}\n\nfn parse_dependency_line(\n    line: \u0026str,\n    line_num: u32,\n    dep_type: DependencyType,\n) -\u003e Option\u003cDependency\u003e {\n    // Match pattern: \"package-name\": \"version\"\n    // Find the first quoted string (package name)\n    let first_quote = line.find('\"')?;\n    let after_first = \u0026line[first_quote + 1..];\n    let name_end = after_first.find('\"')?;\n    let name = \u0026after_first[..name_end];\n\n    // Skip if it looks like a section header\n    if name.ends_with(\"ependencies\") {\n        return None;\n    }\n\n    // Find the colon\n    let colon_pos = line.find(':')?;\n\n    // Find the version string (after the colon)\n    let after_colon = \u0026line[colon_pos + 1..];\n    let version_first_quote = after_colon.find('\"')?;\n    let version_start_in_after = version_first_quote + 1;\n    let after_version_quote = \u0026after_colon[version_start_in_after..];\n    let version_end_in_after = after_version_quote.find('\"')?;\n    let version = \u0026after_version_quote[..version_end_in_after];\n\n    // Calculate absolute positions\n    let name_start = (first_quote + 1) as u32;\n    let name_end_pos = name_start + name.len() as u32;\n\n    let version_abs_start = (colon_pos + 1 + version_start_in_after) as u32;\n    let version_abs_end = version_abs_start + version.len() as u32;\n\n    Some(Dependency {\n        name: name.to_string(),\n        version: version.to_string(),\n        line: line_num,\n        name_start,\n        name_end: name_end_pos,\n        version_start: version_abs_start,\n        version_end: version_abs_end,\n        dev: dep_type == DependencyType::Dev,\n        optional: dep_type == DependencyType::Optional || dep_type == DependencyType::Peer,\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_simple_dependencies() {\n        let parser = NpmParser::new();\n        let content = r#\"{\n  \"name\": \"my-app\",\n  \"dependencies\": {\n    \"react\": \"^18.2.0\",\n    \"lodash\": \"4.17.21\"\n  }\n}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 2);\n\n        let react = deps.iter().find(|d| d.name == \"react\").unwrap();\n        assert_eq!(react.version, \"^18.2.0\");\n        assert!(!react.dev);\n\n        let lodash = deps.iter().find(|d| d.name == \"lodash\").unwrap();\n        assert_eq!(lodash.version, \"4.17.21\");\n    }\n\n    #[test]\n    fn test_dev_dependencies() {\n        let parser = NpmParser::new();\n        let content = r#\"{\n  \"devDependencies\": {\n    \"typescript\": \"^5.0.0\",\n    \"jest\": \"^29.0.0\"\n  }\n}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 2);\n\n        for dep in \u0026deps {\n            assert!(dep.dev);\n        }\n    }\n\n    #[test]\n    fn test_multiple_sections() {\n        let parser = NpmParser::new();\n        let content = r#\"{\n  \"name\": \"test\",\n  \"dependencies\": {\n    \"express\": \"^4.18.0\"\n  },\n  \"devDependencies\": {\n    \"nodemon\": \"^3.0.0\"\n  },\n  \"peerDependencies\": {\n    \"react\": \"^18.0.0\"\n  }\n}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 3);\n\n        let express = deps.iter().find(|d| d.name == \"express\").unwrap();\n        assert!(!express.dev);\n        assert!(!express.optional);\n\n        let nodemon = deps.iter().find(|d| d.name == \"nodemon\").unwrap();\n        assert!(nodemon.dev);\n\n        let react = deps.iter().find(|d| d.name == \"react\").unwrap();\n        assert!(react.optional); // peer deps marked as optional\n    }\n\n    #[test]\n    fn test_scoped_packages() {\n        let parser = NpmParser::new();\n        let content = r#\"{\n  \"dependencies\": {\n    \"@types/node\": \"^20.0.0\",\n    \"@babel/core\": \"^7.22.0\"\n  }\n}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 2);\n\n        let types_node = deps.iter().find(|d| d.name == \"@types/node\").unwrap();\n        assert_eq!(types_node.version, \"^20.0.0\");\n\n        let babel = deps.iter().find(|d| d.name == \"@babel/core\").unwrap();\n        assert_eq!(babel.version, \"^7.22.0\");\n    }\n\n    #[test]\n    fn test_version_ranges() {\n        let parser = NpmParser::new();\n        let content = r#\"{\n  \"dependencies\": {\n    \"pkg1\": \"^1.0.0\",\n    \"pkg2\": \"~2.0.0\",\n    \"pkg3\": \"\u003e=3.0.0 \u003c4.0.0\",\n    \"pkg4\": \"1.0.0 - 2.0.0\",\n    \"pkg5\": \"*\"\n  }\n}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 5);\n\n        assert_eq!(\n            deps.iter().find(|d| d.name == \"pkg1\").unwrap().version,\n            \"^1.0.0\"\n        );\n        assert_eq!(\n            deps.iter().find(|d| d.name == \"pkg3\").unwrap().version,\n            \"\u003e=3.0.0 \u003c4.0.0\"\n        );\n        assert_eq!(deps.iter().find(|d| d.name == \"pkg5\").unwrap().version, \"*\");\n    }\n\n    #[test]\n    fn test_inline_format() {\n        let parser = NpmParser::new();\n        let content = r#\"{\"dependencies\": {\"pkg\": \"1.0.0\"}}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"pkg\");\n        assert_eq!(deps[0].version, \"1.0.0\");\n    }\n}\n","traces":[{"line":16,"address":[19965494,19966258,19963088],"length":1,"stats":{"Line":4}},{"line":17,"address":[14177935],"length":1,"stats":{"Line":3}},{"line":20,"address":[14697932],"length":1,"stats":{"Line":4}},{"line":21,"address":[14196264],"length":1,"stats":{"Line":4}},{"line":22,"address":[14697951],"length":1,"stats":{"Line":3}},{"line":24,"address":[14178054,14178003],"length":1,"stats":{"Line":9}},{"line":25,"address":[14698223],"length":1,"stats":{"Line":6}},{"line":26,"address":[14698328,14698230],"length":1,"stats":{"Line":9}},{"line":29,"address":[14196672],"length":1,"stats":{"Line":3}},{"line":30,"address":[14178476],"length":1,"stats":{"Line":3}},{"line":32,"address":[14698443,14698521,14699565],"length":1,"stats":{"Line":10}},{"line":33,"address":[14197902,14196905,14197793],"length":1,"stats":{"Line":6}},{"line":34,"address":[14196859,14196970,14197751],"length":1,"stats":{"Line":10}},{"line":35,"address":[14699424,14699315,14698690],"length":1,"stats":{"Line":6}},{"line":36,"address":[19964521,19963892,19964003],"length":1,"stats":{"Line":9}},{"line":37,"address":[14197501,14197139,14197610],"length":1,"stats":{"Line":0}},{"line":38,"address":[14698890,14698872,14698761,14699128],"length":1,"stats":{"Line":13}},{"line":39,"address":[14699024,14699133,14698892],"length":1,"stats":{"Line":11}},{"line":41,"address":[14178922],"length":1,"stats":{"Line":0}},{"line":44,"address":[14178991,14179651],"length":1,"stats":{"Line":12}},{"line":45,"address":[19964887],"length":1,"stats":{"Line":8}},{"line":46,"address":[14198020],"length":1,"stats":{"Line":5}},{"line":47,"address":[14198028],"length":1,"stats":{"Line":8}},{"line":51,"address":[14198039],"length":1,"stats":{"Line":5}},{"line":52,"address":[19965041],"length":1,"stats":{"Line":8}},{"line":54,"address":[14198246,14198427],"length":1,"stats":{"Line":12}},{"line":55,"address":[14180256,14180305],"length":1,"stats":{"Line":4}},{"line":63,"address":[14196817,14198611],"length":1,"stats":{"Line":10}},{"line":64,"address":[14700281],"length":1,"stats":{"Line":5}},{"line":65,"address":[14180355,14180459],"length":1,"stats":{"Line":0}},{"line":67,"address":[14180431],"length":1,"stats":{"Line":0}},{"line":68,"address":[14198727],"length":1,"stats":{"Line":0}},{"line":73,"address":[14198617],"length":1,"stats":{"Line":5}},{"line":74,"address":[14180504],"length":1,"stats":{"Line":7}},{"line":75,"address":[19965860],"length":1,"stats":{"Line":5}},{"line":76,"address":[14199221,14199265],"length":1,"stats":{"Line":0}},{"line":78,"address":[14700968,14700885,14700946],"length":1,"stats":{"Line":12}},{"line":79,"address":[19966201,19966253],"length":1,"stats":{"Line":12}},{"line":80,"address":[14700989],"length":1,"stats":{"Line":7}},{"line":81,"address":[14700997],"length":1,"stats":{"Line":5}},{"line":90,"address":[14198756,14198990],"length":1,"stats":{"Line":12}},{"line":91,"address":[14180720],"length":1,"stats":{"Line":5}},{"line":92,"address":[19965945],"length":1,"stats":{"Line":7}},{"line":94,"address":[14199189],"length":1,"stats":{"Line":8}},{"line":98,"address":[14178309],"length":1,"stats":{"Line":7}},{"line":112,"address":[14697376,14697484,14695056],"length":1,"stats":{"Line":9}},{"line":117,"address":[14175151],"length":1,"stats":{"Line":5}},{"line":118,"address":[14175181],"length":1,"stats":{"Line":9}},{"line":120,"address":[14175305,14177396,14175197],"length":1,"stats":{"Line":16}},{"line":121,"address":[14695330,14695467],"length":1,"stats":{"Line":4}},{"line":122,"address":[14175596],"length":1,"stats":{"Line":2}},{"line":125,"address":[14175718],"length":1,"stats":{"Line":2}},{"line":128,"address":[14194094,14194211],"length":1,"stats":{"Line":4}},{"line":129,"address":[19961114,19962654],"length":1,"stats":{"Line":0}},{"line":134,"address":[14194225],"length":1,"stats":{"Line":2}},{"line":135,"address":[14176090],"length":1,"stats":{"Line":2}},{"line":136,"address":[14696201],"length":1,"stats":{"Line":0}},{"line":137,"address":[14176238],"length":1,"stats":{"Line":0}},{"line":140,"address":[14194555,14194472],"length":1,"stats":{"Line":4}},{"line":141,"address":[19961603],"length":1,"stats":{"Line":2}},{"line":142,"address":[14176508],"length":1,"stats":{"Line":0}},{"line":143,"address":[14696503],"length":1,"stats":{"Line":0}},{"line":146,"address":[19961780,19961697],"length":1,"stats":{"Line":4}},{"line":147,"address":[14696629],"length":1,"stats":{"Line":2}},{"line":148,"address":[19962012],"length":1,"stats":{"Line":0}},{"line":152,"address":[19962059,19961974],"length":1,"stats":{"Line":4}},{"line":154,"address":[14697098],"length":1,"stats":{"Line":2}},{"line":155,"address":[14195152],"length":1,"stats":{"Line":2}},{"line":156,"address":[19962120],"length":1,"stats":{"Line":2}},{"line":162,"address":[14696935],"length":1,"stats":{"Line":2}},{"line":163,"address":[14177023],"length":1,"stats":{"Line":2}},{"line":166,"address":[14177289],"length":1,"stats":{"Line":2}},{"line":169,"address":[14193709],"length":1,"stats":{"Line":5}},{"line":172,"address":[14191280],"length":1,"stats":{"Line":5}},{"line":173,"address":[14173006],"length":1,"stats":{"Line":4}},{"line":175,"address":[14693084,14693020],"length":1,"stats":{"Line":8}},{"line":176,"address":[14173122],"length":1,"stats":{"Line":3}},{"line":177,"address":[14173067,14173174],"length":1,"stats":{"Line":7}},{"line":178,"address":[14173169],"length":1,"stats":{"Line":3}},{"line":179,"address":[14191502,14191433],"length":1,"stats":{"Line":8}},{"line":180,"address":[19958441],"length":1,"stats":{"Line":3}},{"line":181,"address":[19958460,19958417,19958453],"length":1,"stats":{"Line":8}},{"line":182,"address":[14173223],"length":1,"stats":{"Line":0}},{"line":184,"address":[14693200],"length":1,"stats":{"Line":5}},{"line":188,"address":[14191520,14193336,14193342],"length":1,"stats":{"Line":5}},{"line":195,"address":[14191621],"length":1,"stats":{"Line":7}},{"line":196,"address":[14191717,14191871],"length":1,"stats":{"Line":5}},{"line":197,"address":[14693511,14693587],"length":1,"stats":{"Line":7}},{"line":198,"address":[14191935],"length":1,"stats":{"Line":5}},{"line":201,"address":[14173698],"length":1,"stats":{"Line":7}},{"line":202,"address":[14192087],"length":1,"stats":{"Line":0}},{"line":206,"address":[14192113,14192024],"length":1,"stats":{"Line":5}},{"line":209,"address":[14173857,14174001],"length":1,"stats":{"Line":8}},{"line":210,"address":[14173946,14174022],"length":1,"stats":{"Line":6}},{"line":211,"address":[14174049,14174189],"length":1,"stats":{"Line":8}},{"line":212,"address":[14694069],"length":1,"stats":{"Line":6}},{"line":213,"address":[19959362,19959438],"length":1,"stats":{"Line":8}},{"line":214,"address":[14174247],"length":1,"stats":{"Line":6}},{"line":217,"address":[14174294,14174368],"length":1,"stats":{"Line":8}},{"line":218,"address":[14192704,14192678,14192631],"length":1,"stats":{"Line":14}},{"line":220,"address":[14174521,14174439,14174397],"length":1,"stats":{"Line":14}},{"line":221,"address":[19959723,19959781,19959837],"length":1,"stats":{"Line":14}},{"line":223,"address":[14694835],"length":1,"stats":{"Line":6}},{"line":224,"address":[14174561],"length":1,"stats":{"Line":6}},{"line":225,"address":[14174606],"length":1,"stats":{"Line":8}},{"line":231,"address":[14174667],"length":1,"stats":{"Line":6}},{"line":232,"address":[14174734],"length":1,"stats":{"Line":8}}],"covered":93,"coverable":107},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","php.rs"],"content":"//! Parser for PHP Composer files (composer.json)\n\nuse super::{Dependency, Parser};\n\n/// Parser for PHP composer.json dependency files\n#[derive(Debug, Default)]\npub struct PhpParser;\n\nimpl PhpParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for PhpParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let mut dependencies = Vec::new();\n        let mut current_section: Option\u003cDependencyType\u003e = None;\n        let mut section_brace_depth = 0;\n        let mut in_section_object = false;\n\n        for (line_idx, line) in content.lines().enumerate() {\n            let line_num = line_idx as u32;\n            let trimmed = line.trim();\n\n            // Detect section start\n            if let Some(section) = detect_section(trimmed) {\n                current_section = Some(section);\n                // Check if the object starts on the same line\n                if trimmed.contains('{') {\n                    in_section_object = true;\n                    section_brace_depth = 1;\n\n                    // Try to parse inline dependencies on the same line\n                    if let Some(brace_pos) = trimmed.find('{') {\n                        let after_brace = \u0026trimmed[brace_pos + 1..];\n                        if let Some(deps) =\n                            parse_inline_dependencies(after_brace, line_num, section, line)\n                        {\n                            dependencies.extend(deps);\n                        }\n                    }\n                }\n                continue;\n            }\n\n            // Track brace depth for current section\n            if in_section_object {\n                for ch in trimmed.chars() {\n                    match ch {\n                        '{' =\u003e section_brace_depth += 1,\n                        '}' =\u003e {\n                            section_brace_depth -= 1;\n                            if section_brace_depth == 0 {\n                                current_section = None;\n                                in_section_object = false;\n                            }\n                        }\n                        _ =\u003e {}\n                    }\n                }\n            }\n\n            // Skip if not in a dependency section\n            let dep_type = match current_section {\n                Some(dt) =\u003e dt,\n                None =\u003e continue,\n            };\n\n            // Parse dependency line\n            if let Some(dep) = parse_dependency_line(line, line_num, dep_type) {\n                dependencies.push(dep);\n            }\n        }\n\n        dependencies\n    }\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\nenum DependencyType {\n    Normal,\n    Dev,\n}\n\n/// Detect which section we're entering\nfn detect_section(line: \u0026str) -\u003e Option\u003cDependencyType\u003e {\n    if line.contains(\"\\\"require\\\"\") \u0026\u0026 !line.contains(\"\\\"require-dev\\\"\") {\n        Some(DependencyType::Normal)\n    } else if line.contains(\"\\\"require-dev\\\"\") {\n        Some(DependencyType::Dev)\n    } else {\n        None\n    }\n}\n\n/// Parse inline dependencies (multiple on same line)\nfn parse_inline_dependencies(\n    content: \u0026str,\n    line_num: u32,\n    dep_type: DependencyType,\n    full_line: \u0026str,\n) -\u003e Option\u003cVec\u003cDependency\u003e\u003e {\n    let mut deps = Vec::new();\n\n    // Simple parsing for inline format: \"pkg\": \"^1.0\", \"pkg2\": \"^2.0\"\n    let parts: Vec\u003c\u0026str\u003e = content.split(',').collect();\n\n    for part in parts {\n        if let Some(dep) = parse_dependency_from_pair(part.trim(), line_num, dep_type, full_line) {\n            deps.push(dep);\n        }\n    }\n\n    if deps.is_empty() { None } else { Some(deps) }\n}\n\n/// Parse a single dependency line: \"vendor/package\": \"^1.0.0\"\nfn parse_dependency_line(\n    line: \u0026str,\n    line_num: u32,\n    dep_type: DependencyType,\n) -\u003e Option\u003cDependency\u003e {\n    let trimmed = line.trim();\n\n    // Must contain a colon (key: value)\n    if !trimmed.contains(':') {\n        return None;\n    }\n\n    parse_dependency_from_pair(trimmed, line_num, dep_type, line)\n}\n\n/// Parse a \"name\": \"version\" pair\nfn parse_dependency_from_pair(\n    pair: \u0026str,\n    line_num: u32,\n    dep_type: DependencyType,\n    full_line: \u0026str,\n) -\u003e Option\u003cDependency\u003e {\n    // Find the colon separator\n    let colon_pos = pair.find(':')?;\n\n    let name_part = \u0026pair[..colon_pos];\n    let version_part = \u0026pair[colon_pos + 1..];\n\n    // Extract name from quotes\n    let name = extract_quoted_string(name_part)?;\n\n    // Skip PHP extensions and PHP itself\n    if name == \"php\" || name.starts_with(\"ext-\") {\n        return None;\n    }\n\n    // Extract version from quotes\n    let version = extract_quoted_string(version_part)?;\n\n    // Calculate positions in the original line\n    let name_start = full_line.find(\u0026name)? as u32;\n    let name_end = name_start + name.len() as u32;\n    let version_start = full_line.rfind(\u0026version)? as u32;\n    let version_end = version_start + version.len() as u32;\n\n    Some(Dependency {\n        name,\n        version,\n        line: line_num,\n        name_start,\n        name_end,\n        version_start,\n        version_end,\n        dev: dep_type == DependencyType::Dev,\n        optional: false,\n    })\n}\n\n/// Extract a string value from a quoted string\nfn extract_quoted_string(s: \u0026str) -\u003e Option\u003cString\u003e {\n    let trimmed = s.trim();\n\n    // Find the first quote\n    let start_quote = trimmed.find('\"')?;\n    let after_quote = \u0026trimmed[start_quote + 1..];\n\n    // Find the closing quote\n    let end_quote = after_quote.find('\"')?;\n\n    Some(after_quote[..end_quote].to_string())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_simple_dependencies() {\n        let parser = PhpParser::new();\n        let content = r#\"\n{\n    \"name\": \"myproject\",\n    \"require\": {\n        \"php\": \"\u003e=8.1\",\n        \"laravel/framework\": \"^10.0\",\n        \"guzzlehttp/guzzle\": \"^7.0\"\n    }\n}\n\"#;\n        let deps = parser.parse(content);\n        // Should have laravel and guzzle, not php\n        assert_eq!(deps.len(), 2);\n\n        let laravel = deps.iter().find(|d| d.name.contains(\"laravel\")).unwrap();\n        assert_eq!(laravel.version, \"^10.0\");\n        assert!(!laravel.dev);\n    }\n\n    #[test]\n    fn test_dev_dependencies() {\n        let parser = PhpParser::new();\n        let content = r#\"\n{\n    \"require\": {\n        \"laravel/framework\": \"^10.0\"\n    },\n    \"require-dev\": {\n        \"phpunit/phpunit\": \"^10.0\",\n        \"mockery/mockery\": \"^1.5\"\n    }\n}\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 3);\n\n        let laravel = deps.iter().find(|d| d.name.contains(\"laravel\")).unwrap();\n        assert!(!laravel.dev);\n\n        let phpunit = deps.iter().find(|d| d.name.contains(\"phpunit\")).unwrap();\n        assert!(phpunit.dev);\n\n        let mockery = deps.iter().find(|d| d.name.contains(\"mockery\")).unwrap();\n        assert!(mockery.dev);\n    }\n\n    #[test]\n    fn test_skip_extensions() {\n        let parser = PhpParser::new();\n        let content = r#\"\n{\n    \"require\": {\n        \"php\": \"\u003e=8.1\",\n        \"ext-json\": \"*\",\n        \"ext-mbstring\": \"*\",\n        \"laravel/framework\": \"^10.0\"\n    }\n}\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"laravel/framework\");\n    }\n\n    #[test]\n    fn test_version_constraints() {\n        let parser = PhpParser::new();\n        let content = r#\"\n{\n    \"require\": {\n        \"vendor/exact\": \"1.0.0\",\n        \"vendor/caret\": \"^1.0\",\n        \"vendor/tilde\": \"~1.0\",\n        \"vendor/range\": \"\u003e=1.0 \u003c2.0\"\n    }\n}\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 4);\n\n        let exact = deps.iter().find(|d| d.name.contains(\"exact\")).unwrap();\n        assert_eq!(exact.version, \"1.0.0\");\n\n        let caret = deps.iter().find(|d| d.name.contains(\"caret\")).unwrap();\n        assert_eq!(caret.version, \"^1.0\");\n    }\n\n    #[test]\n    fn test_version_position() {\n        let parser = PhpParser::new();\n        let content = r#\"{\n    \"require\": {\n        \"vendor/pkg\": \"^1.0.0\"\n    }\n}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n\n        let dep = \u0026deps[0];\n        assert_eq!(dep.name, \"vendor/pkg\");\n        assert_eq!(dep.version, \"^1.0.0\");\n    }\n}\n","traces":[{"line":16,"address":[12571405,12571411,12569792],"length":1,"stats":{"Line":6}},{"line":17,"address":[13764815],"length":1,"stats":{"Line":7}},{"line":18,"address":[13793776],"length":1,"stats":{"Line":6}},{"line":19,"address":[17302276],"length":1,"stats":{"Line":7}},{"line":20,"address":[12569903],"length":1,"stats":{"Line":7}},{"line":22,"address":[17302350,17302303],"length":1,"stats":{"Line":14}},{"line":23,"address":[12570175],"length":1,"stats":{"Line":5}},{"line":24,"address":[12570182,12570280],"length":1,"stats":{"Line":12}},{"line":27,"address":[12570312],"length":1,"stats":{"Line":7}},{"line":28,"address":[17302773],"length":1,"stats":{"Line":7}},{"line":30,"address":[13765407,13765364],"length":1,"stats":{"Line":9}},{"line":31,"address":[13765426],"length":1,"stats":{"Line":2}},{"line":32,"address":[17302850],"length":1,"stats":{"Line":7}},{"line":35,"address":[13794373],"length":1,"stats":{"Line":2}},{"line":36,"address":[12570563],"length":1,"stats":{"Line":7}},{"line":37,"address":[17303080],"length":1,"stats":{"Line":2}},{"line":40,"address":[12570814],"length":1,"stats":{"Line":0}},{"line":48,"address":[12570416],"length":1,"stats":{"Line":7}},{"line":49,"address":[13765844],"length":1,"stats":{"Line":2}},{"line":50,"address":[12571028],"length":1,"stats":{"Line":7}},{"line":51,"address":[12571260,12571304],"length":1,"stats":{"Line":0}},{"line":53,"address":[13766317,13766339,13766256],"length":1,"stats":{"Line":10}},{"line":54,"address":[12571348,12571400],"length":1,"stats":{"Line":10}},{"line":55,"address":[13795288],"length":1,"stats":{"Line":8}},{"line":56,"address":[13766368],"length":1,"stats":{"Line":2}},{"line":65,"address":[13794726],"length":1,"stats":{"Line":5}},{"line":66,"address":[12571077],"length":1,"stats":{"Line":2}},{"line":71,"address":[12571104],"length":1,"stats":{"Line":7}},{"line":72,"address":[13766204],"length":1,"stats":{"Line":8}},{"line":76,"address":[12570221],"length":1,"stats":{"Line":2}},{"line":87,"address":[17297792],"length":1,"stats":{"Line":5}},{"line":88,"address":[12565783,12565847],"length":1,"stats":{"Line":14}},{"line":89,"address":[13760797],"length":1,"stats":{"Line":2}},{"line":90,"address":[13760823,13760816,13760742],"length":1,"stats":{"Line":12}},{"line":91,"address":[13789746],"length":1,"stats":{"Line":2}},{"line":93,"address":[13789739],"length":1,"stats":{"Line":7}},{"line":98,"address":[13762399,13762405,13761456],"length":1,"stats":{"Line":7}},{"line":104,"address":[17298688],"length":1,"stats":{"Line":2}},{"line":107,"address":[12566692,12566753],"length":1,"stats":{"Line":9}},{"line":109,"address":[17298812,17298986],"length":1,"stats":{"Line":9}},{"line":110,"address":[13761969,13762220],"length":1,"stats":{"Line":9}},{"line":111,"address":[12567442],"length":1,"stats":{"Line":0}},{"line":115,"address":[13790936],"length":1,"stats":{"Line":7}},{"line":119,"address":[17298352],"length":1,"stats":{"Line":2}},{"line":124,"address":[12566391],"length":1,"stats":{"Line":7}},{"line":127,"address":[17298454],"length":1,"stats":{"Line":2}},{"line":128,"address":[13761370],"length":1,"stats":{"Line":0}},{"line":131,"address":[12566490],"length":1,"stats":{"Line":7}},{"line":135,"address":[12567488,12569367,12569476],"length":1,"stats":{"Line":7}},{"line":142,"address":[17299664],"length":1,"stats":{"Line":2}},{"line":144,"address":[13791632],"length":1,"stats":{"Line":2}},{"line":145,"address":[17299844,17300033],"length":1,"stats":{"Line":7}},{"line":148,"address":[17300054,17299959],"length":1,"stats":{"Line":2}},{"line":151,"address":[13792055,13791978,13792128],"length":1,"stats":{"Line":12}},{"line":152,"address":[12568223],"length":1,"stats":{"Line":4}},{"line":156,"address":[17300347,17301482],"length":1,"stats":{"Line":2}},{"line":159,"address":[17301448,17300532,17300600],"length":1,"stats":{"Line":10}},{"line":160,"address":[13792659,13792568],"length":1,"stats":{"Line":8}},{"line":161,"address":[12568752,12568799,12569395],"length":1,"stats":{"Line":10}},{"line":162,"address":[13792959,13792807],"length":1,"stats":{"Line":2}},{"line":164,"address":[13793061],"length":1,"stats":{"Line":2}},{"line":165,"address":[17300991],"length":1,"stats":{"Line":8}},{"line":166,"address":[13763965],"length":1,"stats":{"Line":2}},{"line":172,"address":[13792933],"length":1,"stats":{"Line":8}},{"line":178,"address":[12565904],"length":1,"stats":{"Line":7}},{"line":179,"address":[12565963],"length":1,"stats":{"Line":2}},{"line":182,"address":[12566000],"length":1,"stats":{"Line":7}},{"line":183,"address":[13790051,13789929],"length":1,"stats":{"Line":2}},{"line":186,"address":[13761077,13761141],"length":1,"stats":{"Line":7}},{"line":188,"address":[13761171],"length":1,"stats":{"Line":2}}],"covered":66,"coverable":70},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","python.rs"],"content":"//! Parser for Python dependency files (requirements.txt, pyproject.toml)\n\nuse super::{Dependency, Parser};\n\n/// Parser for Python dependency files\n#[derive(Debug, Default)]\npub struct PythonParser;\n\nimpl PythonParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for PythonParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        // Detect file type based on content\n        if content.trim_start().starts_with('[')\n            || content.contains(\"[project]\")\n            || content.contains(\"[tool.poetry\")\n        {\n            parse_pyproject_toml(content)\n        } else {\n            parse_requirements_txt(content)\n        }\n    }\n}\n\n/// Parse requirements.txt format\n/// Format: package==1.0.0, package\u003e=1.0.0, package~=1.0.0, etc.\nfn parse_requirements_txt(content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n    let mut dependencies = Vec::new();\n\n    for (line_idx, line) in content.lines().enumerate() {\n        let line_num = line_idx as u32;\n        let trimmed = line.trim();\n\n        // Skip empty lines, comments, and special directives\n        if trimmed.is_empty()\n            || trimmed.starts_with('#')\n            || trimmed.starts_with('-')  // -r, -e, -c, etc.\n            || trimmed.starts_with(\"--\")\n        // --index-url, etc.\n        {\n            continue;\n        }\n\n        // Skip URL dependencies (package @ https://...)\n        if trimmed.contains(\" @ \") {\n            continue;\n        }\n\n        if let Some(dep) = parse_requirement_line(line, line_num, false) {\n            dependencies.push(dep);\n        }\n    }\n\n    dependencies\n}\n\n/// Parse a single requirement line\nfn parse_requirement_line(line: \u0026str, line_num: u32, dev: bool) -\u003e Option\u003cDependency\u003e {\n    let trimmed = line.trim();\n\n    // Remove inline comments\n    let without_comment = if let Some(pos) = trimmed.find('#') {\n        \u0026trimmed[..pos]\n    } else {\n        trimmed\n    };\n    let without_comment = without_comment.trim();\n\n    if without_comment.is_empty() {\n        return None;\n    }\n\n    // Extract package name (before version specifier or extras)\n    // Operators: ==, \u003e=, \u003c=, !=, ~=, \u003e, \u003c, ===\n    let operators = [\"===\", \"==\", \"\u003e=\", \"\u003c=\", \"!=\", \"~=\", \"\u003e\", \"\u003c\"];\n\n    let mut name_end_pos = without_comment.len();\n    let mut version_op_pos = None;\n    let mut version_op_len = 0;\n\n    for op in \u0026operators {\n        if let Some(pos) = without_comment.find(op)\n            \u0026\u0026 pos \u003c name_end_pos\n        {\n            name_end_pos = pos;\n            version_op_pos = Some(pos);\n            version_op_len = op.len();\n        }\n    }\n\n    // Handle extras: package[extra1,extra2]\u003e=1.0\n    let name_part = \u0026without_comment[..name_end_pos];\n    let name = if let Some(bracket_pos) = name_part.find('[') {\n        \u0026name_part[..bracket_pos]\n    } else {\n        name_part\n    };\n    let name = name.trim();\n\n    if name.is_empty() {\n        return None;\n    }\n\n    // Extract version\n    let version = if let Some(op_pos) = version_op_pos {\n        let version_part = \u0026without_comment[op_pos + version_op_len..];\n        // Handle comma-separated version constraints: \u003e=1.0,\u003c2.0\n        let version = if let Some(comma_pos) = version_part.find(',') {\n            \u0026version_part[..comma_pos]\n        } else {\n            version_part\n        };\n        // Remove environment markers: ; python_version \u003e= \"3.8\"\n        let version = if let Some(semi_pos) = version.find(';') {\n            \u0026version[..semi_pos]\n        } else {\n            version\n        };\n        version.trim().to_string()\n    } else {\n        // No version specified\n        return None;\n    };\n\n    if version.is_empty() {\n        return None;\n    }\n\n    // Calculate positions\n    let name_start = line.find(name)? as u32;\n    let name_end = name_start + name.len() as u32;\n\n    // Find version position in the original line\n    let version_start = line.find(\u0026version)? as u32;\n    let version_end = version_start + version.len() as u32;\n\n    Some(Dependency {\n        name: name.to_string(),\n        version,\n        line: line_num,\n        name_start,\n        name_end,\n        version_start,\n        version_end,\n        dev,\n        optional: false,\n    })\n}\n\n/// Parse pyproject.toml format (PEP 621 + Poetry)\nfn parse_pyproject_toml(content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n    let mut dependencies = Vec::new();\n\n    // Parse using toml crate for structure, but we need line positions\n    // So we'll do a hybrid approach: parse TOML for structure, then find positions manually\n\n    let table: toml::Table = match content.parse() {\n        Ok(t) =\u003e t,\n        Err(_) =\u003e return dependencies,\n    };\n\n    // PEP 621: [project.dependencies] array of strings\n    if let Some(project) = table.get(\"project\").and_then(|v| v.as_table()) {\n        // [project.dependencies]\n        if let Some(deps) = project.get(\"dependencies\").and_then(|v| v.as_array()) {\n            for dep_str in deps.iter().filter_map(|v| v.as_str()) {\n                if let Some((name, version)) = parse_pep508_dependency(dep_str)\n                    \u0026\u0026 let Some(dep) = find_dependency_position(content, \u0026name, \u0026version, false)\n                {\n                    dependencies.push(dep);\n                }\n            }\n        }\n\n        // [project.optional-dependencies]\n        if let Some(optional_deps) = project\n            .get(\"optional-dependencies\")\n            .and_then(|v| v.as_table())\n        {\n            for (_group, deps) in optional_deps {\n                if let Some(deps_array) = deps.as_array() {\n                    for dep_str in deps_array.iter().filter_map(|v| v.as_str()) {\n                        if let Some((name, version)) = parse_pep508_dependency(dep_str)\n                            \u0026\u0026 let Some(dep) =\n                                find_dependency_position(content, \u0026name, \u0026version, true)\n                        {\n                            dependencies.push(dep);\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    // Poetry: [tool.poetry.dependencies] table\n    if let Some(tool) = table.get(\"tool\").and_then(|v| v.as_table())\n        \u0026\u0026 let Some(poetry) = tool.get(\"poetry\").and_then(|v| v.as_table())\n    {\n        // [tool.poetry.dependencies]\n        if let Some(deps) = poetry.get(\"dependencies\").and_then(|v| v.as_table()) {\n            for (name, value) in deps {\n                // Skip python itself\n                if name == \"python\" {\n                    continue;\n                }\n                if let Some(version) = extract_poetry_version(value)\n                    \u0026\u0026 let Some(dep) =\n                        find_poetry_dependency_position(content, name, \u0026version, false)\n                {\n                    dependencies.push(dep);\n                }\n            }\n        }\n\n        // [tool.poetry.dev-dependencies] (Poetry \u003c 1.2)\n        if let Some(deps) = poetry.get(\"dev-dependencies\").and_then(|v| v.as_table()) {\n            for (name, value) in deps {\n                if let Some(version) = extract_poetry_version(value)\n                    \u0026\u0026 let Some(dep) =\n                        find_poetry_dependency_position(content, name, \u0026version, true)\n                {\n                    dependencies.push(dep);\n                }\n            }\n        }\n\n        // [tool.poetry.group.dev.dependencies] (Poetry \u003e= 1.2)\n        if let Some(groups) = poetry.get(\"group\").and_then(|v| v.as_table()) {\n            for (group_name, group_value) in groups {\n                let is_dev = group_name == \"dev\" || group_name == \"test\";\n                if let Some(group_table) = group_value.as_table()\n                    \u0026\u0026 let Some(deps) = group_table.get(\"dependencies\").and_then(|v| v.as_table())\n                {\n                    for (name, value) in deps {\n                        if let Some(version) = extract_poetry_version(value)\n                            \u0026\u0026 let Some(dep) =\n                                find_poetry_dependency_position(content, name, \u0026version, is_dev)\n                        {\n                            dependencies.push(dep);\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    dependencies\n}\n\n/// Parse PEP 508 dependency string: \"package\u003e=1.0.0\" or \"package[extra]\u003e=1.0.0\"\nfn parse_pep508_dependency(dep_str: \u0026str) -\u003e Option\u003c(String, String)\u003e {\n    let trimmed = dep_str.trim();\n\n    // Remove environment markers\n    let without_markers = if let Some(semi_pos) = trimmed.find(';') {\n        \u0026trimmed[..semi_pos]\n    } else {\n        trimmed\n    };\n    let without_markers = without_markers.trim();\n\n    // Find version operator\n    let operators = [\"===\", \"==\", \"\u003e=\", \"\u003c=\", \"!=\", \"~=\", \"\u003e\", \"\u003c\"];\n    let mut op_pos = None;\n    let mut op_len = 0;\n\n    for op in \u0026operators {\n        if let Some(pos) = without_markers.find(op)\n            \u0026\u0026 (op_pos.is_none() || pos \u003c op_pos.unwrap())\n        {\n            op_pos = Some(pos);\n            op_len = op.len();\n        }\n    }\n\n    let op_pos = op_pos?;\n\n    // Extract name (handle extras)\n    let name_part = \u0026without_markers[..op_pos];\n    let name = if let Some(bracket_pos) = name_part.find('[') {\n        \u0026name_part[..bracket_pos]\n    } else {\n        name_part\n    };\n    let name = name.trim();\n\n    // Extract version\n    let version_part = \u0026without_markers[op_pos + op_len..];\n    let version = if let Some(comma_pos) = version_part.find(',') {\n        \u0026version_part[..comma_pos]\n    } else {\n        version_part\n    };\n    let version = version.trim();\n\n    if name.is_empty() || version.is_empty() {\n        return None;\n    }\n\n    Some((name.to_string(), version.to_string()))\n}\n\n/// Extract version from Poetry dependency value\nfn extract_poetry_version(value: \u0026toml::Value) -\u003e Option\u003cString\u003e {\n    match value {\n        toml::Value::String(s) =\u003e Some(s.clone()),\n        toml::Value::Table(t) =\u003e t\n            .get(\"version\")\n            .and_then(|v| v.as_str())\n            .map(|s| s.to_string()),\n        _ =\u003e None,\n    }\n}\n\n/// Find position of a dependency in PEP 621 format (array of strings)\nfn find_dependency_position(\n    content: \u0026str,\n    name: \u0026str,\n    version: \u0026str,\n    dev: bool,\n) -\u003e Option\u003cDependency\u003e {\n    for (line_idx, line) in content.lines().enumerate() {\n        // Look for the dependency string in an array\n        if line.contains(name) \u0026\u0026 line.contains(version) {\n            // Check it's likely a dependency line (contains quotes and version operator)\n            if line.contains('\"') || line.contains('\\'') {\n                let line_num = line_idx as u32;\n\n                // Find name position\n                let name_start = line.find(name)? as u32;\n                let name_end = name_start + name.len() as u32;\n\n                // Find version position\n                let version_start = line.find(version)? as u32;\n                let version_end = version_start + version.len() as u32;\n\n                return Some(Dependency {\n                    name: name.to_string(),\n                    version: version.to_string(),\n                    line: line_num,\n                    name_start,\n                    name_end,\n                    version_start,\n                    version_end,\n                    dev,\n                    optional: dev, // optional-dependencies are optional\n                });\n            }\n        }\n    }\n    None\n}\n\n/// Find position of a Poetry dependency (table format)\nfn find_poetry_dependency_position(\n    content: \u0026str,\n    name: \u0026str,\n    version: \u0026str,\n    dev: bool,\n) -\u003e Option\u003cDependency\u003e {\n    for (line_idx, line) in content.lines().enumerate() {\n        let trimmed = line.trim();\n\n        // Poetry format: name = \"version\" or name = { version = \"...\" }\n        if trimmed.starts_with(name) \u0026\u0026 trimmed.contains('=') {\n            // Check this line contains the version\n            if line.contains(version) {\n                let line_num = line_idx as u32;\n\n                // Find name position\n                let name_start = line.find(name)? as u32;\n                let name_end = name_start + name.len() as u32;\n\n                // Find version position (inside quotes)\n                let version_start = line.find(version)? as u32;\n                let version_end = version_start + version.len() as u32;\n\n                return Some(Dependency {\n                    name: name.to_string(),\n                    version: version.to_string(),\n                    line: line_num,\n                    name_start,\n                    name_end,\n                    version_start,\n                    version_end,\n                    dev,\n                    optional: false,\n                });\n            }\n        }\n    }\n    None\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_requirements_simple() {\n        let parser = PythonParser::new();\n        let content = r#\"\nflask==2.0.0\nrequests\u003e=2.25.0\ndjango~=4.0\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 3);\n\n        let flask = deps.iter().find(|d| d.name == \"flask\").unwrap();\n        assert_eq!(flask.version, \"2.0.0\");\n\n        let requests = deps.iter().find(|d| d.name == \"requests\").unwrap();\n        assert_eq!(requests.version, \"2.25.0\");\n\n        let django = deps.iter().find(|d| d.name == \"django\").unwrap();\n        assert_eq!(django.version, \"4.0\");\n    }\n\n    #[test]\n    fn test_requirements_with_extras() {\n        let parser = PythonParser::new();\n        let content = \"uvicorn[standard]\u003e=0.20.0\";\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"uvicorn\");\n        assert_eq!(deps[0].version, \"0.20.0\");\n    }\n\n    #[test]\n    fn test_requirements_with_comments() {\n        let parser = PythonParser::new();\n        let content = r#\"\n# This is a comment\nflask==2.0.0  # inline comment\n# Another comment\nrequests\u003e=2.25.0\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 2);\n    }\n\n    #[test]\n    fn test_requirements_skip_special() {\n        let parser = PythonParser::new();\n        let content = r#\"\n-r other.txt\n-e git+https://github.com/user/repo.git\n--index-url https://pypi.org/simple\nflask==2.0.0\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"flask\");\n    }\n\n    #[test]\n    fn test_pyproject_pep621() {\n        let parser = PythonParser::new();\n        let content = r#\"\n[project]\nname = \"myproject\"\ndependencies = [\n    \"flask\u003e=2.0.0\",\n    \"requests~=2.25.0\",\n]\n\n[project.optional-dependencies]\ndev = [\n    \"pytest\u003e=7.0.0\",\n]\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 3);\n\n        let flask = deps.iter().find(|d| d.name == \"flask\").unwrap();\n        assert_eq!(flask.version, \"2.0.0\");\n        assert!(!flask.dev);\n\n        let pytest = deps.iter().find(|d| d.name == \"pytest\").unwrap();\n        assert_eq!(pytest.version, \"7.0.0\");\n        assert!(pytest.dev);\n    }\n\n    #[test]\n    fn test_pyproject_poetry() {\n        let parser = PythonParser::new();\n        let content = r#\"\n[tool.poetry]\nname = \"myproject\"\n\n[tool.poetry.dependencies]\npython = \"^3.9\"\nflask = \"^2.0.0\"\nrequests = { version = \"^2.25.0\", optional = true }\n\n[tool.poetry.dev-dependencies]\npytest = \"^7.0.0\"\n\"#;\n        let deps = parser.parse(content);\n        // Should have flask, requests, pytest (python is skipped)\n        assert_eq!(deps.len(), 3);\n\n        let flask = deps.iter().find(|d| d.name == \"flask\").unwrap();\n        assert_eq!(flask.version, \"^2.0.0\");\n        assert!(!flask.dev);\n\n        let pytest = deps.iter().find(|d| d.name == \"pytest\").unwrap();\n        assert_eq!(pytest.version, \"^7.0.0\");\n        assert!(pytest.dev);\n    }\n\n    #[test]\n    fn test_version_position() {\n        let parser = PythonParser::new();\n        let content = \"flask==2.0.0\";\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n\n        let dep = \u0026deps[0];\n        assert_eq!(dep.name_start, 0);\n        assert_eq!(dep.name_end, 5);\n        assert_eq!(dep.version_start, 7);\n        assert_eq!(dep.version_end, 12);\n    }\n}\n","traces":[{"line":16,"address":[14478640],"length":1,"stats":{"Line":2}},{"line":18,"address":[14449765],"length":1,"stats":{"Line":3}},{"line":19,"address":[14449800],"length":1,"stats":{"Line":2}},{"line":20,"address":[14449854],"length":1,"stats":{"Line":3}},{"line":22,"address":[13433406],"length":1,"stats":{"Line":3}},{"line":24,"address":[14449890],"length":1,"stats":{"Line":3}},{"line":31,"address":[14444672,14445505,14445511],"length":1,"stats":{"Line":3}},{"line":32,"address":[14444715],"length":1,"stats":{"Line":4}},{"line":34,"address":[13428371,13428327],"length":1,"stats":{"Line":6}},{"line":35,"address":[14444995],"length":1,"stats":{"Line":3}},{"line":36,"address":[13428652,13428578],"length":1,"stats":{"Line":8}},{"line":39,"address":[14445108],"length":1,"stats":{"Line":6}},{"line":40,"address":[14474071],"length":1,"stats":{"Line":3}},{"line":41,"address":[13428763],"length":1,"stats":{"Line":6}},{"line":42,"address":[14445231],"length":1,"stats":{"Line":3}},{"line":49,"address":[14445282],"length":1,"stats":{"Line":6}},{"line":53,"address":[13428924],"length":1,"stats":{"Line":3}},{"line":54,"address":[14474404],"length":1,"stats":{"Line":7}},{"line":58,"address":[14473957],"length":1,"stats":{"Line":3}},{"line":62,"address":[19032947,19032953,19030400],"length":1,"stats":{"Line":6}},{"line":63,"address":[19030510],"length":1,"stats":{"Line":3}},{"line":66,"address":[14471065,14471167],"length":1,"stats":{"Line":8}},{"line":67,"address":[14471138],"length":1,"stats":{"Line":2}},{"line":69,"address":[14471185],"length":1,"stats":{"Line":5}},{"line":71,"address":[13425873],"length":1,"stats":{"Line":5}},{"line":73,"address":[19030748],"length":1,"stats":{"Line":3}},{"line":74,"address":[14442654],"length":1,"stats":{"Line":0}},{"line":79,"address":[13425961],"length":1,"stats":{"Line":5}},{"line":81,"address":[14471505],"length":1,"stats":{"Line":3}},{"line":82,"address":[19031006],"length":1,"stats":{"Line":6}},{"line":83,"address":[14471530],"length":1,"stats":{"Line":3}},{"line":85,"address":[13426271,13426214],"length":1,"stats":{"Line":9}},{"line":86,"address":[14473492,14473588,14471693],"length":1,"stats":{"Line":15}},{"line":87,"address":[14473513],"length":1,"stats":{"Line":6}},{"line":89,"address":[14444612],"length":1,"stats":{"Line":3}},{"line":90,"address":[14473548],"length":1,"stats":{"Line":6}},{"line":91,"address":[14473568],"length":1,"stats":{"Line":3}},{"line":96,"address":[14471754],"length":1,"stats":{"Line":3}},{"line":97,"address":[19031299,19031401],"length":1,"stats":{"Line":8}},{"line":98,"address":[13426556],"length":1,"stats":{"Line":2}},{"line":100,"address":[19031419],"length":1,"stats":{"Line":3}},{"line":102,"address":[14471949],"length":1,"stats":{"Line":5}},{"line":104,"address":[14472008],"length":1,"stats":{"Line":3}},{"line":105,"address":[14443113],"length":1,"stats":{"Line":0}},{"line":109,"address":[19031503,19031545],"length":1,"stats":{"Line":8}},{"line":110,"address":[13426825,13426919,13426745],"length":1,"stats":{"Line":10}},{"line":112,"address":[13426993,13426948,13426876],"length":1,"stats":{"Line":7}},{"line":113,"address":[14443366],"length":1,"stats":{"Line":0}},{"line":115,"address":[14443413],"length":1,"stats":{"Line":3}},{"line":118,"address":[13427027,13427145],"length":1,"stats":{"Line":7}},{"line":119,"address":[14472430],"length":1,"stats":{"Line":0}},{"line":121,"address":[13427147],"length":1,"stats":{"Line":3}},{"line":123,"address":[13427179],"length":1,"stats":{"Line":7}},{"line":126,"address":[13426783],"length":1,"stats":{"Line":0}},{"line":129,"address":[14472619,14472560],"length":1,"stats":{"Line":10}},{"line":130,"address":[14472686],"length":1,"stats":{"Line":0}},{"line":134,"address":[14472657,14473471,14472714],"length":1,"stats":{"Line":10}},{"line":135,"address":[19032322,19032409],"length":1,"stats":{"Line":3}},{"line":138,"address":[13427576,13427623,13428111],"length":1,"stats":{"Line":10}},{"line":139,"address":[14444232,14444151],"length":1,"stats":{"Line":7}},{"line":141,"address":[14444341],"length":1,"stats":{"Line":3}},{"line":142,"address":[14473141],"length":1,"stats":{"Line":3}},{"line":143,"address":[13427879],"length":1,"stats":{"Line":7}},{"line":155,"address":[14470664,14464176,14466031],"length":1,"stats":{"Line":3}},{"line":156,"address":[13419015],"length":1,"stats":{"Line":3}},{"line":161,"address":[14435352,14435412],"length":1,"stats":{"Line":6}},{"line":162,"address":[14435528],"length":1,"stats":{"Line":3}},{"line":163,"address":[13419152],"length":1,"stats":{"Line":0}},{"line":167,"address":[14464631,14464722],"length":1,"stats":{"Line":10}},{"line":169,"address":[13508105,13508096],"length":1,"stats":{"Line":8}},{"line":170,"address":[19897129,19897104],"length":1,"stats":{"Line":8}},{"line":171,"address":[14436419],"length":1,"stats":{"Line":2}},{"line":172,"address":[14436688,14436535],"length":1,"stats":{"Line":4}},{"line":174,"address":[14465832],"length":1,"stats":{"Line":2}},{"line":180,"address":[19025628],"length":1,"stats":{"Line":2}},{"line":182,"address":[13420789],"length":1,"stats":{"Line":6}},{"line":184,"address":[14437203],"length":1,"stats":{"Line":2}},{"line":185,"address":[14466310],"length":1,"stats":{"Line":2}},{"line":186,"address":[19897024,19897049],"length":1,"stats":{"Line":6}},{"line":187,"address":[14437798],"length":1,"stats":{"Line":2}},{"line":188,"address":[14467123],"length":1,"stats":{"Line":2}},{"line":189,"address":[19026382,19026535],"length":1,"stats":{"Line":4}},{"line":191,"address":[14467211],"length":1,"stats":{"Line":2}},{"line":200,"address":[13419611,13422138],"length":1,"stats":{"Line":8}},{"line":201,"address":[13537065,13537056],"length":1,"stats":{"Line":8}},{"line":204,"address":[14438766],"length":1,"stats":{"Line":6}},{"line":205,"address":[14438948,14438887],"length":1,"stats":{"Line":4}},{"line":207,"address":[13422752],"length":1,"stats":{"Line":2}},{"line":210,"address":[19027634],"length":1,"stats":{"Line":2}},{"line":211,"address":[14439505],"length":1,"stats":{"Line":2}},{"line":212,"address":[14439262,14439377],"length":1,"stats":{"Line":4}},{"line":214,"address":[19028061],"length":1,"stats":{"Line":2}},{"line":220,"address":[14702937,14702928],"length":1,"stats":{"Line":8}},{"line":221,"address":[13423443,13423382],"length":1,"stats":{"Line":4}},{"line":222,"address":[14468919],"length":1,"stats":{"Line":2}},{"line":223,"address":[13423942],"length":1,"stats":{"Line":2}},{"line":224,"address":[14469114,14469007],"length":1,"stats":{"Line":4}},{"line":226,"address":[14440402],"length":1,"stats":{"Line":2}},{"line":232,"address":[14469409,14468709],"length":1,"stats":{"Line":4}},{"line":233,"address":[14469495],"length":1,"stats":{"Line":0}},{"line":234,"address":[13424374],"length":1,"stats":{"Line":0}},{"line":235,"address":[14469789],"length":1,"stats":{"Line":0}},{"line":236,"address":[14469869],"length":1,"stats":{"Line":0}},{"line":238,"address":[19029486],"length":1,"stats":{"Line":0}},{"line":239,"address":[14470162],"length":1,"stats":{"Line":0}},{"line":240,"address":[13425140],"length":1,"stats":{"Line":0}},{"line":241,"address":[14470336,14470247],"length":1,"stats":{"Line":0}},{"line":243,"address":[14441612],"length":1,"stats":{"Line":0}},{"line":251,"address":[19027071],"length":1,"stats":{"Line":2}},{"line":255,"address":[19035519,19033920,19035513],"length":1,"stats":{"Line":2}},{"line":256,"address":[13429181],"length":1,"stats":{"Line":2}},{"line":259,"address":[13429326,13429224],"length":1,"stats":{"Line":2}},{"line":260,"address":[14445729],"length":1,"stats":{"Line":0}},{"line":262,"address":[14474704],"length":1,"stats":{"Line":2}},{"line":264,"address":[14474720],"length":1,"stats":{"Line":2}},{"line":267,"address":[14445839],"length":1,"stats":{"Line":2}},{"line":268,"address":[19034439],"length":1,"stats":{"Line":2}},{"line":269,"address":[19034451],"length":1,"stats":{"Line":2}},{"line":271,"address":[14446109,14446079],"length":1,"stats":{"Line":4}},{"line":272,"address":[13430851,13429760,13430716],"length":1,"stats":{"Line":6}},{"line":273,"address":[13430737],"length":1,"stats":{"Line":2}},{"line":275,"address":[14447246],"length":1,"stats":{"Line":2}},{"line":276,"address":[14447266],"length":1,"stats":{"Line":2}},{"line":280,"address":[19034617],"length":1,"stats":{"Line":2}},{"line":283,"address":[14446337],"length":1,"stats":{"Line":2}},{"line":284,"address":[14475310,14475406],"length":1,"stats":{"Line":2}},{"line":285,"address":[14446449],"length":1,"stats":{"Line":0}},{"line":287,"address":[14446490],"length":1,"stats":{"Line":2}},{"line":289,"address":[14475434],"length":1,"stats":{"Line":2}},{"line":292,"address":[19034939,19035063],"length":1,"stats":{"Line":2}},{"line":293,"address":[14446750,14446639,14446705],"length":1,"stats":{"Line":2}},{"line":294,"address":[14446721],"length":1,"stats":{"Line":0}},{"line":296,"address":[13430327],"length":1,"stats":{"Line":2}},{"line":298,"address":[14475706],"length":1,"stats":{"Line":2}},{"line":300,"address":[14446835],"length":1,"stats":{"Line":2}},{"line":301,"address":[14475801],"length":1,"stats":{"Line":0}},{"line":304,"address":[14446901],"length":1,"stats":{"Line":2}},{"line":308,"address":[19030192],"length":1,"stats":{"Line":2}},{"line":309,"address":[14441800],"length":1,"stats":{"Line":2}},{"line":310,"address":[14470800],"length":1,"stats":{"Line":2}},{"line":311,"address":[14441926],"length":1,"stats":{"Line":2}},{"line":313,"address":[13537129,13537120],"length":1,"stats":{"Line":6}},{"line":314,"address":[19897334,19897312],"length":1,"stats":{"Line":6}},{"line":315,"address":[19030268],"length":1,"stats":{"Line":0}},{"line":320,"address":[13431987,13431993,13430864],"length":1,"stats":{"Line":2}},{"line":326,"address":[14447494,14447417],"length":1,"stats":{"Line":4}},{"line":328,"address":[14447620,14447686],"length":1,"stats":{"Line":4}},{"line":330,"address":[19036095],"length":1,"stats":{"Line":2}},{"line":331,"address":[14476713],"length":1,"stats":{"Line":2}},{"line":334,"address":[14476720],"length":1,"stats":{"Line":2}},{"line":335,"address":[14476925,14476821],"length":1,"stats":{"Line":2}},{"line":338,"address":[14448015,14447947],"length":1,"stats":{"Line":2}},{"line":339,"address":[14476991,14477084],"length":1,"stats":{"Line":2}},{"line":341,"address":[14477172],"length":1,"stats":{"Line":2}},{"line":342,"address":[13431673],"length":1,"stats":{"Line":2}},{"line":343,"address":[14477080],"length":1,"stats":{"Line":2}},{"line":355,"address":[13431208],"length":1,"stats":{"Line":0}},{"line":359,"address":[14449608,14448448,14449602],"length":1,"stats":{"Line":2}},{"line":365,"address":[13432223,13432140],"length":1,"stats":{"Line":4}},{"line":366,"address":[14448771],"length":1,"stats":{"Line":2}},{"line":369,"address":[14448818,14448874],"length":1,"stats":{"Line":4}},{"line":371,"address":[14477845],"length":1,"stats":{"Line":2}},{"line":372,"address":[14477889],"length":1,"stats":{"Line":2}},{"line":375,"address":[19037352],"length":1,"stats":{"Line":2}},{"line":376,"address":[13432636,13432743],"length":1,"stats":{"Line":2}},{"line":379,"address":[14449194,14449126],"length":1,"stats":{"Line":2}},{"line":380,"address":[14449341,14449245],"length":1,"stats":{"Line":2}},{"line":382,"address":[13432995],"length":1,"stats":{"Line":2}},{"line":383,"address":[13432855],"length":1,"stats":{"Line":2}},{"line":384,"address":[14449337],"length":1,"stats":{"Line":2}},{"line":396,"address":[14448838],"length":1,"stats":{"Line":0}}],"covered":148,"coverable":171},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","ruby.rs"],"content":"//! Parser for Ruby Gemfile files\n//!\n//! Supports:\n//! - Gemfile format (Bundler)\n//! - gem declarations with version constraints\n//! - group blocks for development dependencies\n\nuse super::{Dependency, Parser};\n\n/// Parser for Ruby Gemfile dependency files\n#[derive(Debug, Default)]\npub struct RubyParser;\n\nimpl RubyParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for RubyParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let mut dependencies = Vec::new();\n        let mut in_dev_group = false;\n        let mut group_depth = 0;\n\n        for (line_idx, line) in content.lines().enumerate() {\n            let line_num = line_idx as u32;\n            let trimmed = line.trim();\n\n            // Skip comments and empty lines\n            if trimmed.is_empty() || trimmed.starts_with('#') {\n                continue;\n            }\n\n            // Track group blocks for dev dependencies\n            if trimmed.starts_with(\"group\") {\n                let is_dev = trimmed.contains(\":development\")\n                    || trimmed.contains(\":test\")\n                    || trimmed.contains(\"'development'\")\n                    || trimmed.contains(\"\\\"development\\\"\")\n                    || trimmed.contains(\"'test'\")\n                    || trimmed.contains(\"\\\"test\\\"\");\n\n                if trimmed.contains(\"do\") {\n                    group_depth += 1;\n                    if is_dev {\n                        in_dev_group = true;\n                    }\n                }\n                continue;\n            }\n\n            // Track end of blocks\n            if trimmed == \"end\" {\n                if group_depth \u003e 0 {\n                    group_depth -= 1;\n                    if group_depth == 0 {\n                        in_dev_group = false;\n                    }\n                }\n                continue;\n            }\n\n            // Parse gem declarations\n            if let Some(dep) = parse_gem_declaration(line, line_num, in_dev_group) {\n                dependencies.push(dep);\n            }\n        }\n\n        dependencies\n    }\n}\n\n/// Parse a gem declaration from a line\nfn parse_gem_declaration(line: \u0026str, line_num: u32, dev: bool) -\u003e Option\u003cDependency\u003e {\n    let trimmed = line.trim();\n\n    // Must start with 'gem'\n    if !trimmed.starts_with(\"gem \") \u0026\u0026 !trimmed.starts_with(\"gem(\") {\n        return None;\n    }\n\n    // Extract the part after 'gem'\n    let after_gem = if trimmed.starts_with(\"gem(\") {\n        trimmed.strip_prefix(\"gem(\")?.trim_end_matches(')')\n    } else {\n        trimmed.strip_prefix(\"gem \")?\n    };\n\n    // Split by comma to get arguments\n    let args: Vec\u003c\u0026str\u003e = split_gem_args(after_gem);\n\n    if args.is_empty() {\n        return None;\n    }\n\n    // First argument is the gem name (quoted)\n    let name = args[0].trim().trim_matches(|c| c == '\\'' || c == '\"');\n\n    // Second argument (if present) is the version constraint\n    let version = if args.len() \u003e 1 {\n        let version_arg = args[1].trim();\n        // Skip if it's a hash option (like require: false, git: ...)\n        if version_arg.contains(':')\n            \u0026\u0026 !version_arg.starts_with('\\'')\n            \u0026\u0026 !version_arg.starts_with('\"')\n        {\n            return None; // No version, has options like git: or path:\n        }\n        version_arg\n            .trim_matches(|c| c == '\\'' || c == '\"')\n            .to_string()\n    } else {\n        return None; // No version specified\n    };\n\n    // Skip if version looks like a hash key (path, git, etc.)\n    if version.is_empty() || version.contains(':') {\n        return None;\n    }\n\n    // Calculate positions in the original line\n    let name_start = find_string_position(line, name)? as u32;\n    let name_end = name_start + name.len() as u32;\n    let version_start = find_string_position(line, \u0026version)? as u32;\n    let version_end = version_start + version.len() as u32;\n\n    Some(Dependency {\n        name: name.to_string(),\n        version,\n        line: line_num,\n        name_start,\n        name_end,\n        version_start,\n        version_end,\n        dev,\n        optional: false,\n    })\n}\n\n/// Split gem arguments respecting quotes\nfn split_gem_args(s: \u0026str) -\u003e Vec\u003c\u0026str\u003e {\n    let mut args = Vec::new();\n    let mut start = 0;\n    let mut in_quotes = false;\n    let mut quote_char = ' ';\n\n    for (i, c) in s.char_indices() {\n        match c {\n            '\\'' | '\"' if !in_quotes =\u003e {\n                in_quotes = true;\n                quote_char = c;\n            }\n            c if c == quote_char \u0026\u0026 in_quotes =\u003e {\n                in_quotes = false;\n            }\n            ',' if !in_quotes =\u003e {\n                let arg = s[start..i].trim();\n                if !arg.is_empty() {\n                    args.push(arg);\n                }\n                start = i + 1;\n            }\n            _ =\u003e {}\n        }\n    }\n\n    // Don't forget the last argument\n    let last_arg = s[start..].trim();\n    if !last_arg.is_empty() {\n        // Stop at hash options\n        if let Some(hash_start) = last_arg.find([':', '{']) {\n            let before_hash = last_arg[..hash_start].trim();\n            if !before_hash.is_empty()\n                \u0026\u0026 (before_hash.starts_with('\\'') || before_hash.starts_with('\"'))\n            {\n                args.push(before_hash);\n            }\n        } else {\n            args.push(last_arg);\n        }\n    }\n\n    args\n}\n\n/// Find the position of a string in a line (accounting for quotes)\nfn find_string_position(line: \u0026str, needle: \u0026str) -\u003e Option\u003cusize\u003e {\n    // Look for the string within quotes\n    for quote in \u0026['\\'', '\"'] {\n        let quoted = format!(\"{}{}{}\", quote, needle, quote);\n        if let Some(pos) = line.find(\u0026quoted) {\n            return Some(pos + 1); // Skip the opening quote\n        }\n    }\n    // Fallback to direct search\n    line.find(needle)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_simple_gem() {\n        let parser = RubyParser::new();\n        let content = r#\"\nsource 'https://rubygems.org'\n\ngem 'rails', '~\u003e 7.0'\ngem 'pg', '~\u003e 1.4'\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n        assert_eq!(deps[0].name, \"rails\");\n        assert_eq!(deps[0].version, \"~\u003e 7.0\");\n        assert!(!deps[0].dev);\n        assert_eq!(deps[1].name, \"pg\");\n        assert_eq!(deps[1].version, \"~\u003e 1.4\");\n    }\n\n    #[test]\n    fn test_gem_with_version_operators() {\n        let parser = RubyParser::new();\n        let content = r#\"\ngem 'devise', '\u003e= 4.0'\ngem 'rspec', '~\u003e 3.0'\ngem 'rails', '~\u003e 7.0.0'\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 3);\n        assert_eq!(deps[0].name, \"devise\");\n        assert_eq!(deps[0].version, \"\u003e= 4.0\");\n        assert_eq!(deps[1].name, \"rspec\");\n        assert_eq!(deps[1].version, \"~\u003e 3.0\");\n        assert_eq!(deps[2].name, \"rails\");\n        assert_eq!(deps[2].version, \"~\u003e 7.0.0\");\n    }\n\n    #[test]\n    fn test_dev_dependencies_in_group() {\n        let parser = RubyParser::new();\n        let content = r#\"\nsource 'https://rubygems.org'\n\ngem 'rails', '~\u003e 7.0'\n\ngroup :development, :test do\n  gem 'rspec-rails', '~\u003e 6.0'\n  gem 'factory_bot_rails', '~\u003e 6.2'\nend\n\ngem 'pg', '~\u003e 1.4'\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 4);\n\n        let rails = deps.iter().find(|d| d.name == \"rails\").unwrap();\n        assert!(!rails.dev);\n\n        let rspec = deps.iter().find(|d| d.name == \"rspec-rails\").unwrap();\n        assert!(rspec.dev);\n\n        let factory_bot = deps.iter().find(|d| d.name == \"factory_bot_rails\").unwrap();\n        assert!(factory_bot.dev);\n\n        let pg = deps.iter().find(|d| d.name == \"pg\").unwrap();\n        assert!(!pg.dev);\n    }\n\n    #[test]\n    fn test_skip_git_and_path_gems() {\n        let parser = RubyParser::new();\n        let content = r#\"\ngem 'rails', '~\u003e 7.0'\ngem 'my_gem', git: 'https://github.com/user/my_gem.git'\ngem 'local_gem', path: '../local_gem'\ngem 'pg', '~\u003e 1.4'\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n        assert_eq!(deps[0].name, \"rails\");\n        assert_eq!(deps[1].name, \"pg\");\n    }\n\n    #[test]\n    fn test_skip_comments_and_empty_lines() {\n        let parser = RubyParser::new();\n        let content = r#\"\n# This is a comment\nsource 'https://rubygems.org'\n\n# Another comment\ngem 'rails', '~\u003e 7.0'\n\n# gem 'old_gem', '1.0'\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"rails\");\n    }\n\n    #[test]\n    fn test_gem_with_require_option() {\n        let parser = RubyParser::new();\n        let content = r#\"\ngem 'rails', '~\u003e 7.0'\ngem 'bootsnap', '~\u003e 1.16', require: false\ngem 'pg', '~\u003e 1.4'\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 3);\n        assert_eq!(deps[0].name, \"rails\");\n        assert_eq!(deps[1].name, \"bootsnap\");\n        assert_eq!(deps[1].version, \"~\u003e 1.16\");\n        assert_eq!(deps[2].name, \"pg\");\n    }\n\n    #[test]\n    fn test_double_quoted_gems() {\n        let parser = RubyParser::new();\n        let content = r#\"\ngem \"rails\", \"~\u003e 7.0\"\ngem \"pg\", \"~\u003e 1.4\"\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n        assert_eq!(deps[0].name, \"rails\");\n        assert_eq!(deps[0].version, \"~\u003e 7.0\");\n    }\n\n    #[test]\n    fn test_version_positions() {\n        let parser = RubyParser::new();\n        let content = \"gem 'rails', '~\u003e 7.0'\\n\";\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 1);\n        let dep = \u0026deps[0];\n\n        // Verify positions are valid\n        assert!(dep.name_start \u003c dep.name_end);\n        assert!(dep.version_start \u003c dep.version_end);\n        assert!(dep.name_end \u003c dep.version_start);\n\n        // Verify name position\n        let name_slice = \u0026content[dep.name_start as usize..dep.name_end as usize];\n        assert_eq!(name_slice, \"rails\");\n\n        // Verify version position\n        let version_slice = \u0026content[dep.version_start as usize..dep.version_end as usize];\n        assert_eq!(version_slice, \"~\u003e 7.0\");\n    }\n\n    #[test]\n    fn test_exact_version() {\n        let parser = RubyParser::new();\n        let content = \"gem 'nokogiri', '1.15.4'\\n\";\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"nokogiri\");\n        assert_eq!(deps[0].version, \"1.15.4\");\n    }\n\n    #[test]\n    fn test_test_group() {\n        let parser = RubyParser::new();\n        let content = r#\"\ngem 'rails', '~\u003e 7.0'\n\ngroup :test do\n  gem 'rspec', '~\u003e 3.12'\nend\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n\n        let rspec = deps.iter().find(|d| d.name == \"rspec\").unwrap();\n        assert!(rspec.dev);\n    }\n}\n","traces":[{"line":21,"address":[14460992,14462344,14462350],"length":1,"stats":{"Line":3}},{"line":22,"address":[14461043],"length":1,"stats":{"Line":5}},{"line":23,"address":[14489995],"length":1,"stats":{"Line":5}},{"line":24,"address":[12657516],"length":1,"stats":{"Line":6}},{"line":26,"address":[14461136,14461088],"length":1,"stats":{"Line":12}},{"line":27,"address":[14490264],"length":1,"stats":{"Line":7}},{"line":28,"address":[14722062,14721991],"length":1,"stats":{"Line":12}},{"line":31,"address":[14490358],"length":1,"stats":{"Line":5}},{"line":36,"address":[12657961],"length":1,"stats":{"Line":7}},{"line":37,"address":[14490907,14490858,14490532],"length":1,"stats":{"Line":9}},{"line":38,"address":[12658432,12658372],"length":1,"stats":{"Line":4}},{"line":39,"address":[14722646],"length":1,"stats":{"Line":0}},{"line":40,"address":[14490983],"length":1,"stats":{"Line":0}},{"line":41,"address":[14722752],"length":1,"stats":{"Line":0}},{"line":42,"address":[12658601],"length":1,"stats":{"Line":0}},{"line":44,"address":[12658657],"length":1,"stats":{"Line":2}},{"line":45,"address":[12658749,12658713],"length":1,"stats":{"Line":2}},{"line":46,"address":[14462339,14462298],"length":1,"stats":{"Line":5}},{"line":47,"address":[14462334],"length":1,"stats":{"Line":2}},{"line":54,"address":[14461574,14461654],"length":1,"stats":{"Line":15}},{"line":55,"address":[14490623],"length":1,"stats":{"Line":3}},{"line":56,"address":[14461896,14461861],"length":1,"stats":{"Line":3}},{"line":57,"address":[14461884,14461921],"length":1,"stats":{"Line":6}},{"line":58,"address":[12658352],"length":1,"stats":{"Line":3}},{"line":65,"address":[12658151,12658114],"length":1,"stats":{"Line":12}},{"line":66,"address":[14722493],"length":1,"stats":{"Line":16}},{"line":70,"address":[14490298],"length":1,"stats":{"Line":11}},{"line":75,"address":[14489819,14487360,14489825],"length":1,"stats":{"Line":10}},{"line":76,"address":[12655006],"length":1,"stats":{"Line":10}},{"line":79,"address":[14458585],"length":1,"stats":{"Line":12}},{"line":80,"address":[14458699],"length":1,"stats":{"Line":4}},{"line":84,"address":[14487591],"length":1,"stats":{"Line":7}},{"line":85,"address":[14458839,14459063],"length":1,"stats":{"Line":0}},{"line":87,"address":[14458933,14458744],"length":1,"stats":{"Line":8}},{"line":91,"address":[14719263],"length":1,"stats":{"Line":10}},{"line":93,"address":[12655647,12655500],"length":1,"stats":{"Line":27}},{"line":94,"address":[14719511],"length":1,"stats":{"Line":0}},{"line":98,"address":[12655725,12655653],"length":1,"stats":{"Line":57}},{"line":101,"address":[12655848],"length":1,"stats":{"Line":16}},{"line":102,"address":[12655978,12655912],"length":1,"stats":{"Line":29}},{"line":104,"address":[14488536],"length":1,"stats":{"Line":13}},{"line":105,"address":[12656156],"length":1,"stats":{"Line":0}},{"line":106,"address":[12656208],"length":1,"stats":{"Line":0}},{"line":108,"address":[14720068],"length":1,"stats":{"Line":0}},{"line":111,"address":[14459660],"length":1,"stats":{"Line":45}},{"line":114,"address":[14488371],"length":1,"stats":{"Line":2}},{"line":118,"address":[14488860,14488939,14488795],"length":1,"stats":{"Line":42}},{"line":119,"address":[14459977],"length":1,"stats":{"Line":0}},{"line":123,"address":[12657331,12656523],"length":1,"stats":{"Line":16}},{"line":124,"address":[14489154,14489225],"length":1,"stats":{"Line":13}},{"line":125,"address":[14460343,14460865,14460280],"length":1,"stats":{"Line":29}},{"line":126,"address":[14460488,14460569],"length":1,"stats":{"Line":16}},{"line":128,"address":[12657120],"length":1,"stats":{"Line":13}},{"line":129,"address":[14489478],"length":1,"stats":{"Line":13}},{"line":130,"address":[12657072],"length":1,"stats":{"Line":16}},{"line":142,"address":[14485152,14486658,14486652],"length":1,"stats":{"Line":11}},{"line":143,"address":[14716551],"length":1,"stats":{"Line":10}},{"line":144,"address":[12652772],"length":1,"stats":{"Line":12}},{"line":145,"address":[14456324],"length":1,"stats":{"Line":10}},{"line":146,"address":[14716604],"length":1,"stats":{"Line":12}},{"line":148,"address":[12652811,12652862],"length":1,"stats":{"Line":22}},{"line":149,"address":[14716877,14717698],"length":1,"stats":{"Line":20}},{"line":150,"address":[12653837,12653881,12653849],"length":1,"stats":{"Line":22}},{"line":151,"address":[14457399],"length":1,"stats":{"Line":10}},{"line":152,"address":[12653867],"length":1,"stats":{"Line":12}},{"line":154,"address":[14717713,14717615],"length":1,"stats":{"Line":24}},{"line":155,"address":[14717723],"length":1,"stats":{"Line":10}},{"line":157,"address":[12653924],"length":1,"stats":{"Line":12}},{"line":158,"address":[14486430],"length":1,"stats":{"Line":10}},{"line":159,"address":[14486535],"length":1,"stats":{"Line":12}},{"line":160,"address":[12654098,12654144],"length":1,"stats":{"Line":22}},{"line":162,"address":[14457704,14457665,14457691],"length":1,"stats":{"Line":22}},{"line":169,"address":[14716939],"length":1,"stats":{"Line":10}},{"line":170,"address":[12653262],"length":1,"stats":{"Line":12}},{"line":172,"address":[14485921,14485773],"length":1,"stats":{"Line":23}},{"line":173,"address":[14457137,14457055],"length":1,"stats":{"Line":8}},{"line":174,"address":[12653656],"length":1,"stats":{"Line":2}},{"line":175,"address":[14457324,14457231],"length":1,"stats":{"Line":4}},{"line":177,"address":[14717573,14717605],"length":1,"stats":{"Line":0}},{"line":180,"address":[14457102,14457338],"length":1,"stats":{"Line":25}},{"line":184,"address":[14485862],"length":1,"stats":{"Line":11}},{"line":188,"address":[14457744,14458405,14458411],"length":1,"stats":{"Line":13}},{"line":190,"address":[12654251,12654273],"length":1,"stats":{"Line":29}},{"line":191,"address":[12654342],"length":1,"stats":{"Line":16}},{"line":192,"address":[14487064,14487193],"length":1,"stats":{"Line":29}},{"line":193,"address":[14458311,14458352,14458385],"length":1,"stats":{"Line":29}},{"line":197,"address":[14458167],"length":1,"stats":{"Line":0}}],"covered":75,"coverable":87},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","providers","code_actions.rs"],"content":"//! Code actions provider for updating dependencies\n\nuse std::collections::HashMap;\n\nuse tower_lsp::lsp_types::*;\n\nuse crate::cache::ReadCache;\nuse crate::file_types::FileType;\nuse crate::parsers::Dependency;\nuse crate::providers::inlay_hints::{VersionStatus, compare_versions};\n\n/// Type of semantic version update\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum VersionUpdateType {\n    Major,\n    Minor,\n    Patch,\n    PreRelease,\n}\n\nimpl VersionUpdateType {\n    pub fn prefix(\u0026self) -\u003e \u0026'static str {\n        match self {\n            VersionUpdateType::Major =\u003e \"⚠ MAJOR\",\n            VersionUpdateType::Minor =\u003e \"+ minor\",\n            VersionUpdateType::Patch =\u003e \"· patch\",\n            VersionUpdateType::PreRelease =\u003e \"* prerelease\",\n        }\n    }\n\n    pub fn is_preferred(\u0026self) -\u003e bool {\n        !matches!(self, VersionUpdateType::Major)\n    }\n}\n\n/// Determine the type of version update between current and new version\npub fn compare_update_type(current: \u0026str, new: \u0026str) -\u003e VersionUpdateType {\n    let current_normalized = normalize_version(current);\n    let new_normalized = normalize_version(new);\n\n    match (\n        semver::Version::parse(\u0026current_normalized),\n        semver::Version::parse(\u0026new_normalized),\n    ) {\n        (Ok(current_ver), Ok(new_ver)) =\u003e {\n            if !new_ver.pre.is_empty() \u0026\u0026 current_ver.pre.is_empty() {\n                VersionUpdateType::PreRelease\n            } else if current_ver.major != new_ver.major {\n                VersionUpdateType::Major\n            } else if current_ver.minor != new_ver.minor {\n                VersionUpdateType::Minor\n            } else if current_ver.patch != new_ver.patch {\n                VersionUpdateType::Patch\n            } else {\n                VersionUpdateType::PreRelease\n            }\n        }\n        _ =\u003e VersionUpdateType::Patch,\n    }\n}\n\nfn normalize_version(version: \u0026str) -\u003e String {\n    let version = version.trim();\n    let version = version\n        .strip_prefix(\"~\u003e\")\n        .or_else(|| version.strip_prefix('^'))\n        .or_else(|| version.strip_prefix('~'))\n        .or_else(|| version.strip_prefix(\"\u003e=\"))\n        .or_else(|| version.strip_prefix(\"\u003c=\"))\n        .or_else(|| version.strip_prefix('\u003e'))\n        .or_else(|| version.strip_prefix('\u003c'))\n        .or_else(|| version.strip_prefix('='))\n        .or_else(|| version.strip_prefix('v'))\n        .unwrap_or(version)\n        .trim();\n\n    let version = version.split(',').next().unwrap_or(version).trim();\n\n    let parts: Vec\u003c\u0026str\u003e = version.split('.').collect();\n    match parts.len() {\n        1 =\u003e format!(\"{}.0.0\", parts[0]),\n        2 =\u003e format!(\"{}.{}.0\", parts[0], parts[1]),\n        _ =\u003e version.to_string(),\n    }\n}\n\n/// Create code actions for dependencies in the given range\npub fn create_code_actions(\n    dependencies: \u0026[Dependency],\n    cache: \u0026impl ReadCache,\n    uri: \u0026Url,\n    range: Range,\n    file_type: FileType,\n    cache_key_fn: impl Fn(\u0026str) -\u003e String,\n) -\u003e Vec\u003cCodeActionOrCommand\u003e {\n    let mut actions: Vec\u003cCodeActionOrCommand\u003e = dependencies\n        .iter()\n        .filter(|dep| dep.line \u003e= range.start.line \u0026\u0026 dep.line \u003c= range.end.line)\n        .filter_map(|dep| create_update_action(dep, cache, uri, file_type, \u0026cache_key_fn))\n        .collect();\n\n    if let Some(update_all) =\n        create_update_all_action(dependencies, cache, uri, file_type, \u0026cache_key_fn)\n    {\n        actions.insert(0, update_all);\n    }\n\n    actions\n}\n\n/// Create an \"Update to X.Y.Z\" code action for a dependency\nfn create_update_action(\n    dep: \u0026Dependency,\n    cache: \u0026impl ReadCache,\n    uri: \u0026Url,\n    file_type: FileType,\n    cache_key_fn: impl Fn(\u0026str) -\u003e String,\n) -\u003e Option\u003cCodeActionOrCommand\u003e {\n    let cache_key = cache_key_fn(\u0026dep.name);\n    let version_info = cache.get(\u0026cache_key)?;\n\n    match compare_versions(\u0026dep.version, \u0026version_info) {\n        VersionStatus::UpdateAvailable(new_version) =\u003e {\n            let update_type = compare_update_type(\u0026dep.version, \u0026new_version);\n            let new_text = format_version(\u0026new_version, file_type);\n\n            let edit = TextEdit {\n                range: Range {\n                    start: Position {\n                        line: dep.line,\n                        character: dep.version_start,\n                    },\n                    end: Position {\n                        line: dep.line,\n                        character: dep.version_end,\n                    },\n                },\n                new_text,\n            };\n\n            let mut changes = HashMap::new();\n            changes.insert(uri.clone(), vec![edit]);\n\n            let title = format!(\n                \"{}: Update {} to {}\",\n                update_type.prefix(),\n                dep.name,\n                new_version\n            );\n\n            Some(CodeActionOrCommand::CodeAction(CodeAction {\n                title,\n                kind: Some(CodeActionKind::QUICKFIX),\n                diagnostics: None,\n                edit: Some(WorkspaceEdit {\n                    changes: Some(changes),\n                    document_changes: None,\n                    change_annotations: None,\n                }),\n                command: None,\n                is_preferred: Some(update_type.is_preferred()),\n                disabled: None,\n                data: None,\n            }))\n        }\n        VersionStatus::UpToDate | VersionStatus::Unknown =\u003e None,\n    }\n}\n\n/// Create an \"Update All Dependencies\" code action when 2+ updates are available\nfn create_update_all_action(\n    dependencies: \u0026[Dependency],\n    cache: \u0026impl ReadCache,\n    uri: \u0026Url,\n    file_type: FileType,\n    cache_key_fn: impl Fn(\u0026str) -\u003e String,\n) -\u003e Option\u003cCodeActionOrCommand\u003e {\n    let outdated_deps: Vec\u003c(\u0026Dependency, String)\u003e = dependencies\n        .iter()\n        .filter_map(|dep| {\n            let cache_key = cache_key_fn(\u0026dep.name);\n            let version_info = cache.get(\u0026cache_key)?;\n\n            match compare_versions(\u0026dep.version, \u0026version_info) {\n                VersionStatus::UpdateAvailable(new_version) =\u003e Some((dep, new_version)),\n                _ =\u003e None,\n            }\n        })\n        .collect();\n\n    if outdated_deps.len() \u003c 2 {\n        return None;\n    }\n\n    let edits: Vec\u003cTextEdit\u003e = outdated_deps\n        .iter()\n        .map(|(dep, new_version)| {\n            let new_text = format_version(new_version, file_type);\n            TextEdit {\n                range: Range {\n                    start: Position {\n                        line: dep.line,\n                        character: dep.version_start,\n                    },\n                    end: Position {\n                        line: dep.line,\n                        character: dep.version_end,\n                    },\n                },\n                new_text,\n            }\n        })\n        .collect();\n\n    let mut changes = HashMap::new();\n    changes.insert(uri.clone(), edits);\n\n    let count = outdated_deps.len();\n    let title = format!(\"Update all {} dependencies\", count);\n\n    Some(CodeActionOrCommand::CodeAction(CodeAction {\n        title,\n        kind: Some(CodeActionKind::QUICKFIX),\n        diagnostics: None,\n        edit: Some(WorkspaceEdit {\n            changes: Some(changes),\n            document_changes: None,\n            change_annotations: None,\n        }),\n        command: None,\n        is_preferred: Some(false),\n        disabled: None,\n        data: None,\n    }))\n}\n\n/// Format version string based on file type\nfn format_version(version: \u0026str, file_type: FileType) -\u003e String {\n    match file_type {\n        FileType::Cargo | FileType::Npm | FileType::Php =\u003e {\n            // Keep the version as-is - the range already includes the quotes in these formats\n            version.to_string()\n        }\n        FileType::Python =\u003e {\n            // Python uses operators like == or \u003e=\n            // Just replace the version number\n            version.to_string()\n        }\n        FileType::Go =\u003e {\n            // Go versions start with 'v'\n            if version.starts_with('v') {\n                version.to_string()\n            } else {\n                format!(\"v{}\", version)\n            }\n        }\n        FileType::Dart =\u003e {\n            // Dart pubspec.yaml uses caret syntax (^1.0.0) or simple versions\n            version.to_string()\n        }\n        FileType::Csharp =\u003e {\n            // C# .csproj uses simple version strings\n            version.to_string()\n        }\n        FileType::Ruby =\u003e {\n            // Ruby Gemfile uses operators like ~\u003e or \u003e=\n            version.to_string()\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::cache::{MemoryCache, WriteCache};\n    use crate::registries::VersionInfo;\n\n    fn create_test_dependency(name: \u0026str, version: \u0026str, line: u32) -\u003e Dependency {\n        Dependency {\n            name: name.to_string(),\n            version: version.to_string(),\n            line,\n            name_start: 0,\n            name_end: name.len() as u32,\n            version_start: name.len() as u32 + 4,\n            version_end: name.len() as u32 + 4 + version.len() as u32,\n            dev: false,\n            optional: false,\n        }\n    }\n\n    #[test]\n    fn test_create_update_action() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 1);\n        match \u0026actions[0] {\n            CodeActionOrCommand::CodeAction(action) =\u003e {\n                assert!(action.title.contains(\"Update serde to 2.0.0\"));\n                assert_eq!(action.kind, Some(CodeActionKind::QUICKFIX));\n            }\n            _ =\u003e panic!(\"Expected CodeAction\"),\n        }\n    }\n\n    #[test]\n    fn test_no_action_when_up_to_date() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 0);\n    }\n\n    #[test]\n    fn test_format_version() {\n        assert_eq!(format_version(\"1.0.0\", FileType::Cargo), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Npm), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Python), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Go), \"v1.0.0\");\n        assert_eq!(format_version(\"v1.0.0\", FileType::Go), \"v1.0.0\");\n    }\n\n    #[test]\n    fn test_update_all_action_with_multiple_outdated() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n        cache.insert(\n            \"test:tokio\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.36.0\".to_string()),\n                ..Default::default()\n            },\n        );\n        cache.insert(\n            \"test:reqwest\".to_string(),\n            VersionInfo {\n                latest: Some(\"0.12.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![\n            create_test_dependency(\"serde\", \"1.0.0\", 5),\n            create_test_dependency(\"tokio\", \"1.35.0\", 6),\n            create_test_dependency(\"reqwest\", \"0.11.0\", 7),\n        ];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 4);\n        match \u0026actions[0] {\n            CodeActionOrCommand::CodeAction(action) =\u003e {\n                assert!(action.title.contains(\"Update all 3 dependencies\"));\n                assert_eq!(action.kind, Some(CodeActionKind::QUICKFIX));\n                assert_eq!(action.is_preferred, Some(false));\n\n                if let Some(edit) = \u0026action.edit {\n                    if let Some(changes) = \u0026edit.changes {\n                        let edits = changes.get(\u0026uri).unwrap();\n                        assert_eq!(edits.len(), 3);\n                    } else {\n                        panic!(\"Expected changes in workspace edit\");\n                    }\n                } else {\n                    panic!(\"Expected edit in code action\");\n                }\n            }\n            _ =\u003e panic!(\"Expected CodeAction\"),\n        }\n    }\n\n    #[test]\n    fn test_update_all_action_not_shown_for_single_outdated() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n        cache.insert(\n            \"test:tokio\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.35.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![\n            create_test_dependency(\"serde\", \"1.0.0\", 5),\n            create_test_dependency(\"tokio\", \"1.35.0\", 6),\n        ];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 1);\n        match \u0026actions[0] {\n            CodeActionOrCommand::CodeAction(action) =\u003e {\n                assert!(!action.title.contains(\"Update all\"));\n                assert!(action.title.contains(\"Update serde to 2.0.0\"));\n            }\n            _ =\u003e panic!(\"Expected CodeAction\"),\n        }\n    }\n\n    #[test]\n    fn test_update_all_action_not_shown_when_all_up_to_date() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n        cache.insert(\n            \"test:tokio\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.35.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![\n            create_test_dependency(\"serde\", \"1.0.0\", 5),\n            create_test_dependency(\"tokio\", \"1.35.0\", 6),\n        ];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 0);\n    }\n\n    #[test]\n    fn test_version_update_type_major() {\n        let update_type = compare_update_type(\"1.0.0\", \"2.0.0\");\n        assert_eq!(update_type, VersionUpdateType::Major);\n        assert_eq!(update_type.prefix(), \"⚠ MAJOR\");\n        assert!(!update_type.is_preferred());\n    }\n\n    #[test]\n    fn test_version_update_type_minor() {\n        let update_type = compare_update_type(\"1.5.0\", \"1.6.0\");\n        assert_eq!(update_type, VersionUpdateType::Minor);\n        assert_eq!(update_type.prefix(), \"+ minor\");\n        assert!(update_type.is_preferred());\n    }\n\n    #[test]\n    fn test_version_update_type_patch() {\n        let update_type = compare_update_type(\"1.5.0\", \"1.5.1\");\n        assert_eq!(update_type, VersionUpdateType::Patch);\n        assert_eq!(update_type.prefix(), \"· patch\");\n        assert!(update_type.is_preferred());\n    }\n\n    #[test]\n    fn test_version_update_type_prerelease() {\n        let update_type = compare_update_type(\"1.5.0\", \"1.5.1-alpha.1\");\n        assert_eq!(update_type, VersionUpdateType::PreRelease);\n        assert_eq!(update_type.prefix(), \"* prerelease\");\n        assert!(update_type.is_preferred());\n    }\n\n    #[test]\n    fn test_version_update_type_with_prefixes() {\n        assert_eq!(\n            compare_update_type(\"^1.0.0\", \"2.0.0\"),\n            VersionUpdateType::Major\n        );\n        assert_eq!(\n            compare_update_type(\"~1.5.0\", \"1.6.0\"),\n            VersionUpdateType::Minor\n        );\n        assert_eq!(\n            compare_update_type(\"\u003e=1.5.0\", \"1.5.1\"),\n            VersionUpdateType::Patch\n        );\n        // Ruby pessimistic constraint\n        assert_eq!(\n            compare_update_type(\"~\u003e 7.0\", \"8.1.1\"),\n            VersionUpdateType::Major\n        );\n        assert_eq!(\n            compare_update_type(\"~\u003e 4.9\", \"4.9.4\"),\n            VersionUpdateType::Patch\n        );\n    }\n\n    #[test]\n    fn test_version_update_type_invalid_semver() {\n        let update_type = compare_update_type(\"invalid\", \"also-invalid\");\n        assert_eq!(update_type, VersionUpdateType::Patch);\n    }\n\n    #[test]\n    fn test_code_action_title_with_major_update() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 1);\n        match \u0026actions[0] {\n            CodeActionOrCommand::CodeAction(action) =\u003e {\n                assert!(action.title.contains(\"⚠ MAJOR\"));\n                assert!(action.title.contains(\"Update serde to 2.0.0\"));\n                assert_eq!(action.is_preferred, Some(false));\n            }\n            _ =\u003e panic!(\"Expected CodeAction\"),\n        }\n    }\n\n    #[test]\n    fn test_code_action_title_with_minor_update() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:tokio\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.36.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"tokio\", \"1.35.0\", 5)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 1);\n        match \u0026actions[0] {\n            CodeActionOrCommand::CodeAction(action) =\u003e {\n                assert!(action.title.contains(\"+ minor\"));\n                assert!(action.title.contains(\"Update tokio to 1.36.0\"));\n                assert_eq!(action.is_preferred, Some(true));\n            }\n            _ =\u003e panic!(\"Expected CodeAction\"),\n        }\n    }\n\n    #[test]\n    fn test_code_action_title_with_patch_update() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:reqwest\".to_string(),\n            VersionInfo {\n                latest: Some(\"0.12.1\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"reqwest\", \"0.12.0\", 5)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 1);\n        match \u0026actions[0] {\n            CodeActionOrCommand::CodeAction(action) =\u003e {\n                assert!(action.title.contains(\"· patch\"));\n                assert!(action.title.contains(\"Update reqwest to 0.12.1\"));\n                assert_eq!(action.is_preferred, Some(true));\n            }\n            _ =\u003e panic!(\"Expected CodeAction\"),\n        }\n    }\n\n    #[test]\n    fn test_format_version_all_file_types() {\n        assert_eq!(format_version(\"1.0.0\", FileType::Cargo), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Npm), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Python), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Go), \"v1.0.0\");\n        assert_eq!(format_version(\"v1.0.0\", FileType::Go), \"v1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Php), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Dart), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Csharp), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Ruby), \"1.0.0\");\n    }\n\n    #[test]\n    fn test_normalize_version_with_partial_versions() {\n        let normalized = super::normalize_version(\"1\");\n        assert_eq!(normalized, \"1.0.0\");\n\n        let normalized = super::normalize_version(\"1.2\");\n        assert_eq!(normalized, \"1.2.0\");\n\n        let normalized = super::normalize_version(\"1.2.3\");\n        assert_eq!(normalized, \"1.2.3\");\n    }\n\n    #[test]\n    fn test_normalize_version_with_range_operators() {\n        let normalized = super::normalize_version(\"\u003e=1.0.0, \u003c2.0.0\");\n        assert_eq!(normalized, \"1.0.0\");\n\n        let normalized = super::normalize_version(\"\u003c=1.5.0\");\n        assert_eq!(normalized, \"1.5.0\");\n\n        let normalized = super::normalize_version(\"\u003e1.0.0\");\n        assert_eq!(normalized, \"1.0.0\");\n\n        let normalized = super::normalize_version(\"\u003c2.0.0\");\n        assert_eq!(normalized, \"2.0.0\");\n\n        let normalized = super::normalize_version(\"=1.0.0\");\n        assert_eq!(normalized, \"1.0.0\");\n    }\n\n    #[test]\n    fn test_filter_deps_outside_range() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 50)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 0);\n    }\n\n    #[test]\n    fn test_no_action_when_cache_empty() {\n        let cache = MemoryCache::new();\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 0);\n    }\n}\n","traces":[{"line":22,"address":[13021376],"length":1,"stats":{"Line":2}},{"line":23,"address":[13021381],"length":1,"stats":{"Line":3}},{"line":24,"address":[13050340],"length":1,"stats":{"Line":2}},{"line":25,"address":[13050363],"length":1,"stats":{"Line":2}},{"line":26,"address":[13050386],"length":1,"stats":{"Line":2}},{"line":27,"address":[14554649],"length":1,"stats":{"Line":2}},{"line":31,"address":[13050272],"length":1,"stats":{"Line":3}},{"line":32,"address":[13050277],"length":1,"stats":{"Line":4}},{"line":37,"address":[13051632,13052519,13052763],"length":1,"stats":{"Line":2}},{"line":38,"address":[15112522],"length":1,"stats":{"Line":2}},{"line":39,"address":[13051731],"length":1,"stats":{"Line":2}},{"line":41,"address":[13052064,13051960],"length":1,"stats":{"Line":6}},{"line":42,"address":[13051849,13051784],"length":1,"stats":{"Line":5}},{"line":43,"address":[13051941,13051873],"length":1,"stats":{"Line":7}},{"line":45,"address":[13052095],"length":1,"stats":{"Line":2}},{"line":46,"address":[13052328,13052204,13052275],"length":1,"stats":{"Line":8}},{"line":47,"address":[13023406],"length":1,"stats":{"Line":2}},{"line":48,"address":[13023376,13023455],"length":1,"stats":{"Line":5}},{"line":49,"address":[14556582],"length":1,"stats":{"Line":2}},{"line":50,"address":[14556614,14556562],"length":1,"stats":{"Line":5}},{"line":51,"address":[14556609],"length":1,"stats":{"Line":2}},{"line":52,"address":[13023457,13023496,13023489],"length":1,"stats":{"Line":5}},{"line":53,"address":[14556623],"length":1,"stats":{"Line":2}},{"line":55,"address":[14556616],"length":1,"stats":{"Line":0}},{"line":58,"address":[14556258],"length":1,"stats":{"Line":2}},{"line":62,"address":[15112440,15112446,15111312],"length":1,"stats":{"Line":2}},{"line":63,"address":[13021579],"length":1,"stats":{"Line":2}},{"line":66,"address":[15111445],"length":1,"stats":{"Line":10}},{"line":67,"address":[14539134,14539120],"length":1,"stats":{"Line":12}},{"line":68,"address":[13014014,13014000],"length":1,"stats":{"Line":12}},{"line":69,"address":[13021728],"length":1,"stats":{"Line":8}},{"line":70,"address":[15111529],"length":1,"stats":{"Line":6}},{"line":71,"address":[14456414,14456400],"length":1,"stats":{"Line":6}},{"line":72,"address":[13050731],"length":1,"stats":{"Line":6}},{"line":73,"address":[13013712,13013726],"length":1,"stats":{"Line":6}},{"line":74,"address":[13021853],"length":1,"stats":{"Line":2}},{"line":77,"address":[13050835],"length":1,"stats":{"Line":2}},{"line":79,"address":[15111811],"length":1,"stats":{"Line":2}},{"line":80,"address":[15111925,15111854],"length":1,"stats":{"Line":4}},{"line":81,"address":[15111981,15112059],"length":1,"stats":{"Line":4}},{"line":82,"address":[15112016,15112212],"length":1,"stats":{"Line":4}},{"line":83,"address":[14555811,14555343],"length":1,"stats":{"Line":4}},{"line":88,"address":[13014174,13014048,13014603],"length":1,"stats":{"Line":20}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[13014224,13014624,13014644],"length":1,"stats":{"Line":60}},{"line":99,"address":[14463088,14463043,14463283,14462276,14463808,14462723,14461748,14458036,14463008,14462688,14462803,14463248,14463443,14464128,14460156,14463843,14464323,14463408,14463123,14457508,14464163,14464288,14459620,14462768,14460692,14463488,14456980,14459092,14458564,14463523,14464208,14464243,14461220],"length":1,"stats":{"Line":56}},{"line":102,"address":[14540348,14540878,14541934,14543518,14539806,14544574,14545102,14542990,14541406,14542462,14544046],"length":1,"stats":{"Line":30}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[13014532,13014601],"length":1,"stats":{"Line":4}},{"line":108,"address":[13043495],"length":1,"stats":{"Line":20}},{"line":112,"address":[14565770,14562288,14553200,14559408,14571978,14578032,14562512,14547146,14575082,14571600,14571824,14550250,14568874,14565616,14578186,14568720,14556304,14556458,14574928,14580912,14556080,14559562,14553354,14565392,14568496,14577808,14552976,14546992,14559184,14574704,14549872,14562666,14550096],"length":1,"stats":{"Line":18}},{"line":119,"address":[13043917,13043819],"length":1,"stats":{"Line":36}},{"line":120,"address":[13044040,13043952],"length":1,"stats":{"Line":36}},{"line":122,"address":[14575441,14575540,14578644,14572337,14566129,14556916,14547604,14569233,14550609,14556817,14560020,14553713,14572436,14566228,14569332,14578545,14563025,14547505,14553812,14559921,14563124,14550708],"length":1,"stats":{"Line":32}},{"line":123,"address":[14563230,14560126,14550814,14553918,14572542,14569438,14566334,14578750,14557022,14575646,14547710],"length":1,"stats":{"Line":12}},{"line":124,"address":[13015657,13015558],"length":1,"stats":{"Line":24}},{"line":125,"address":[13015728],"length":1,"stats":{"Line":12}},{"line":128,"address":[13015801],"length":1,"stats":{"Line":12}},{"line":141,"address":[13015885],"length":1,"stats":{"Line":12}},{"line":142,"address":[13015953,13017805,13016014,13016044],"length":1,"stats":{"Line":24}},{"line":144,"address":[13016402],"length":1,"stats":{"Line":12}},{"line":146,"address":[14472087,14468983,14475191,14487607,14484503,14465879,14496919,14490711,14493815,14478295,14481399],"length":1,"stats":{"Line":12}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[13017218],"length":1,"stats":{"Line":12}},{"line":152,"address":[13016647],"length":1,"stats":{"Line":12}},{"line":153,"address":[13016679],"length":1,"stats":{"Line":12}},{"line":154,"address":[14475567,14497295,14484879,14481775,14494191,14491087,14472463,14469359,14478671,14487983,14466255],"length":1,"stats":{"Line":12}},{"line":155,"address":[14481911,14491223,14475703,14485015,14488119,14494327,14497431,14472599,14469495,14466391,14478807],"length":1,"stats":{"Line":12}},{"line":156,"address":[13016727],"length":1,"stats":{"Line":12}},{"line":157,"address":[13045759],"length":1,"stats":{"Line":12}},{"line":158,"address":[14469483,14485003,14491211,14497419,14478795,14481899,14475691,14488107,14494315,14466379,14472587],"length":1,"stats":{"Line":12}},{"line":160,"address":[14558583,14574103,14549271,14580311,14567895,14552375,14577207,14555479,14564791,14570999,14561687],"length":1,"stats":{"Line":12}},{"line":161,"address":[14472930,14469767,14466722,14479079,14485287,14485346,14472871,14482242,14497762,14488450,14469826,14466663,14491495,14475975,14479138,14482183,14491554,14494599,14488391,14476034,14494658,14497703],"length":1,"stats":{"Line":24}},{"line":162,"address":[13017202],"length":1,"stats":{"Line":12}},{"line":163,"address":[14555574,14558678,14567990,14574198,14549366,14552470,14577302,14561782,14564886,14580406,14571094],"length":1,"stats":{"Line":12}},{"line":166,"address":[13044434],"length":1,"stats":{"Line":6}},{"line":171,"address":[14498646,14503893,14507552,14502128,14507686,14502262,14512933,14507509,14509360,14518357,14511125,14513110,14505878,14503936,14498512,14514918,14514741,14516726,14511302,14516592,14516549,14502085,14505701,14512976,14500277,14500454,14500320,14509317,14511168,14514784,14504070,14505744,14509494],"length":1,"stats":{"Line":20}},{"line":178,"address":[14504039,14513079,14514887,14500423,14507655,14509463,14516695,14505847,14511271,14502231,14498615],"length":1,"stats":{"Line":20}},{"line":180,"address":[14603302,14601766,14599422,14604051,14605971,14609811,14609830,14588574,14604070,14610579,14607744,14602560,14603283,14595806,14610816,14583150,14606976,14601747,14606739,14609088,14610598,14608486,14603328,14597614,14609856,14605203,14608467,14607699,14584958,14581342,14605990,14601024,14586766,14593998,14611558,14611539,14605248,14590382,14605222,14604480,14607718,14606016,14606758,14592190],"length":1,"stats":{"Line":40}},{"line":181,"address":[13020035],"length":1,"stats":{"Line":20}},{"line":182,"address":[13020095,13020177],"length":1,"stats":{"Line":40}},{"line":184,"address":[14606455,14605600,14601376,14601463,14603680,14607328,14610295,14602999,14606368,14603767,14607415,14604919,14610208,14611255,14609527,14611168,14608096,14609440,14602912,14605687,14604832,14608183],"length":1,"stats":{"Line":36}},{"line":185,"address":[14606528,14607488,14611328,14601536,14605760,14608256,14610368,14603072,14604992,14609600,14603840],"length":1,"stats":{"Line":14}},{"line":186,"address":[14519070,14521758,14528670,14522718,14523678,14525214,14520030,14524446,14520798,14526558,14527326],"length":1,"stats":{"Line":6}},{"line":191,"address":[13047185,13047112],"length":1,"stats":{"Line":40}},{"line":192,"address":[14511505,14515121,14498849,14502465,14507889,14500657,14504273,14516929,14513313,14509697,14506081],"length":1,"stats":{"Line":18}},{"line":195,"address":[13047191],"length":1,"stats":{"Line":2}},{"line":197,"address":[13018367,13019792,13019833],"length":1,"stats":{"Line":6}},{"line":198,"address":[13048775],"length":1,"stats":{"Line":2}},{"line":199,"address":[13019933],"length":1,"stats":{"Line":2}},{"line":200,"address":[13048844],"length":1,"stats":{"Line":2}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[14528866,14525602,14525410,14519266,14520994,14525794,14527522,14527714,14521954,14522914,14527906],"length":1,"stats":{"Line":2}},{"line":203,"address":[13048826],"length":1,"stats":{"Line":2}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[13048832],"length":1,"stats":{"Line":2}},{"line":207,"address":[14602485,14604213,14601909,14604405,14602293,14609013,14610741,14606901,14608821,14602101,14608629],"length":1,"stats":{"Line":2}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[14599677,14592445,14597869,14583405,14590637,14588829,14581597,14594253,14587021,14596061,14585213],"length":1,"stats":{"Line":2}},{"line":216,"address":[13047478,13047430],"length":1,"stats":{"Line":4}},{"line":218,"address":[14502804,14504612,14515460,14508228,14517268,14513652,14500996,14506420,14510036,14511844,14499188],"length":1,"stats":{"Line":2}},{"line":219,"address":[13018697],"length":1,"stats":{"Line":2}},{"line":221,"address":[14587844,14595076,14589652,14596884,14593268,14598692,14586036,14582420,14600500,14591460,14584228],"length":1,"stats":{"Line":2}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[14583780,14589204,14585588,14596436,14581972,14598244,14591012,14594628,14592820,14587396,14600052],"length":1,"stats":{"Line":2}},{"line":224,"address":[13018864],"length":1,"stats":{"Line":2}},{"line":225,"address":[13047920],"length":1,"stats":{"Line":2}},{"line":226,"address":[13018872],"length":1,"stats":{"Line":2}},{"line":227,"address":[13018968],"length":1,"stats":{"Line":2}},{"line":228,"address":[14591168,14582128,14589360,14592976,14587552,14585744,14583936,14600208,14596592,14598400,14594784],"length":1,"stats":{"Line":2}},{"line":230,"address":[14499772,14510620,14501580,14514236,14503388,14512428,14516044,14507004,14508812,14505196,14517852],"length":1,"stats":{"Line":2}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[13019256],"length":1,"stats":{"Line":2}},{"line":233,"address":[13048192],"length":1,"stats":{"Line":2}},{"line":238,"address":[14554128],"length":1,"stats":{"Line":3}},{"line":239,"address":[14554164],"length":1,"stats":{"Line":3}},{"line":242,"address":[14554200],"length":1,"stats":{"Line":3}},{"line":247,"address":[13049983],"length":1,"stats":{"Line":4}},{"line":251,"address":[13021073],"length":1,"stats":{"Line":4}},{"line":252,"address":[13021309],"length":1,"stats":{"Line":4}},{"line":254,"address":[13021184],"length":1,"stats":{"Line":4}},{"line":259,"address":[13050037],"length":1,"stats":{"Line":2}},{"line":263,"address":[13021132],"length":1,"stats":{"Line":2}},{"line":267,"address":[13021155],"length":1,"stats":{"Line":2}}],"covered":115,"coverable":125},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","providers","completion.rs"],"content":"//! Completion provider for version suggestions\n\nuse chrono::{DateTime, Utc};\nuse tower_lsp::lsp_types::*;\n\nuse crate::cache::ReadCache;\nuse crate::parsers::Dependency;\n\n/// Format a release date as a human-readable age string\npub fn format_release_age(released_at: DateTime\u003cUtc\u003e) -\u003e String {\n    let now = Utc::now();\n    let duration = now.signed_duration_since(released_at);\n\n    let days = duration.num_days();\n    if days \u003c 0 {\n        return \"just now\".to_string();\n    }\n\n    if days == 0 {\n        let hours = duration.num_hours();\n        if hours == 0 {\n            let mins = duration.num_minutes();\n            if mins \u003c 1 {\n                return \"just now\".to_string();\n            }\n            return format!(\"{} min{} ago\", mins, if mins == 1 { \"\" } else { \"s\" });\n        }\n        return format!(\"{} hour{} ago\", hours, if hours == 1 { \"\" } else { \"s\" });\n    }\n\n    if days == 1 {\n        return \"yesterday\".to_string();\n    }\n\n    if days \u003c 7 {\n        return format!(\"{} days ago\", days);\n    }\n\n    if days \u003c 30 {\n        let weeks = days / 7;\n        return format!(\"{} week{} ago\", weeks, if weeks == 1 { \"\" } else { \"s\" });\n    }\n\n    if days \u003c 365 {\n        let months = days / 30;\n        return format!(\"{} month{} ago\", months, if months == 1 { \"\" } else { \"s\" });\n    }\n\n    let years = days / 365;\n    format!(\"{} year{} ago\", years, if years == 1 { \"\" } else { \"s\" })\n}\n\n/// Get completions for a position in the document\npub fn get_completions(\n    dependencies: \u0026[Dependency],\n    position: Position,\n    cache: \u0026impl ReadCache,\n    cache_key_fn: impl Fn(\u0026str) -\u003e String,\n) -\u003e Option\u003cVec\u003cCompletionItem\u003e\u003e {\n    // Find if we're inside a version field\n    let dep = dependencies.iter().find(|d| {\n        d.line == position.line\n            \u0026\u0026 position.character \u003e= d.version_start\n            \u0026\u0026 position.character \u003c= d.version_end\n    })?;\n\n    let cache_key = cache_key_fn(\u0026dep.name);\n    let version_info = cache.get(\u0026cache_key)?;\n\n    // Return the last 10 versions as completions\n    let items: Vec\u003cCompletionItem\u003e = version_info\n        .versions\n        .iter()\n        .take(10)\n        .enumerate()\n        .map(|(i, version)| {\n            let is_latest = i == 0;\n            let release_date = version_info.get_release_date(version);\n\n            // Build detail string with version and optional release age\n            let detail = match release_date {\n                Some(dt) =\u003e {\n                    let age = format_release_age(dt);\n                    if is_latest {\n                        format!(\"{} [Latest] - {}\", version, age)\n                    } else {\n                        format!(\"{} - {}\", version, age)\n                    }\n                }\n                None =\u003e {\n                    if is_latest {\n                        format!(\"{} [Latest]\", version)\n                    } else {\n                        format!(\"Version {}\", version)\n                    }\n                }\n            };\n\n            // Build documentation with more details\n            let documentation = {\n                let mut doc = String::new();\n                if is_latest {\n                    doc.push_str(\"**Latest stable version**\\n\\n\");\n                }\n                if let Some(dt) = release_date {\n                    let date_str = dt.format(\"%Y-%m-%d\").to_string();\n                    let age = format_release_age(dt);\n                    doc.push_str(\u0026format!(\"Released: {} ({})\", date_str, age));\n                }\n                if doc.is_empty() {\n                    None\n                } else {\n                    Some(Documentation::MarkupContent(MarkupContent {\n                        kind: MarkupKind::Markdown,\n                        value: doc,\n                    }))\n                }\n            };\n\n            CompletionItem {\n                label: version.clone(),\n                kind: Some(CompletionItemKind::CONSTANT),\n                detail: Some(detail),\n                documentation,\n                sort_text: Some(format!(\"{:04}\", i)), // Ensures correct ordering\n                insert_text: Some(version.clone()),\n                insert_text_format: Some(InsertTextFormat::PLAIN_TEXT),\n                ..Default::default()\n            }\n        })\n        .collect();\n\n    Some(items)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::cache::{MemoryCache, WriteCache};\n    use crate::registries::VersionInfo;\n    use chrono::Duration;\n    use std::collections::HashMap;\n\n    fn create_test_dependency(name: \u0026str, version: \u0026str, line: u32) -\u003e Dependency {\n        Dependency {\n            name: name.to_string(),\n            version: version.to_string(),\n            line,\n            name_start: 0,\n            name_end: name.len() as u32,\n            version_start: name.len() as u32 + 4,\n            version_end: name.len() as u32 + 4 + version.len() as u32,\n            dev: false,\n            optional: false,\n        }\n    }\n\n    #[test]\n    fn test_format_release_age_minutes() {\n        let now = Utc::now();\n        let released = now - Duration::minutes(30);\n        let age = format_release_age(released);\n        assert_eq!(age, \"30 mins ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_hours() {\n        let now = Utc::now();\n        let released = now - Duration::hours(5);\n        let age = format_release_age(released);\n        assert_eq!(age, \"5 hours ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_yesterday() {\n        let now = Utc::now();\n        let released = now - Duration::days(1);\n        let age = format_release_age(released);\n        assert_eq!(age, \"yesterday\");\n    }\n\n    #[test]\n    fn test_format_release_age_days() {\n        let now = Utc::now();\n        let released = now - Duration::days(5);\n        let age = format_release_age(released);\n        assert_eq!(age, \"5 days ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_weeks() {\n        let now = Utc::now();\n        let released = now - Duration::days(14);\n        let age = format_release_age(released);\n        assert_eq!(age, \"2 weeks ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_months() {\n        let now = Utc::now();\n        let released = now - Duration::days(60);\n        let age = format_release_age(released);\n        assert_eq!(age, \"2 months ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_years() {\n        let now = Utc::now();\n        let released = now - Duration::days(400);\n        let age = format_release_age(released);\n        assert_eq!(age, \"1 year ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_just_now() {\n        let now = Utc::now();\n        let age = format_release_age(now);\n        assert_eq!(age, \"just now\");\n    }\n\n    #[test]\n    fn test_get_completions() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.200\".to_string()),\n                versions: vec![\n                    \"1.0.200\".to_string(),\n                    \"1.0.199\".to_string(),\n                    \"1.0.198\".to_string(),\n                ],\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        // Position inside the version field\n        let position = Position {\n            line: 5,\n            character: 13, // Within version_start to version_end\n        };\n\n        let completions = get_completions(\u0026deps, position, \u0026cache, |name| format!(\"test:{}\", name));\n\n        assert!(completions.is_some());\n        let items = completions.unwrap();\n        assert_eq!(items.len(), 3);\n        assert_eq!(items[0].label, \"1.0.200\");\n        assert_eq!(items[1].label, \"1.0.199\");\n    }\n\n    #[test]\n    fn test_get_completions_with_release_dates() {\n        let cache = MemoryCache::new();\n        let now = Utc::now();\n        let mut release_dates = HashMap::new();\n        release_dates.insert(\"1.0.200\".to_string(), now - Duration::days(2));\n        release_dates.insert(\"1.0.199\".to_string(), now - Duration::days(10));\n\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.200\".to_string()),\n                versions: vec![\n                    \"1.0.200\".to_string(),\n                    \"1.0.199\".to_string(),\n                    \"1.0.198\".to_string(),\n                ],\n                release_dates,\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let position = Position {\n            line: 5,\n            character: 13,\n        };\n\n        let completions = get_completions(\u0026deps, position, \u0026cache, |name| format!(\"test:{}\", name));\n\n        assert!(completions.is_some());\n        let items = completions.unwrap();\n        assert_eq!(items.len(), 3);\n\n        // First item should have [Latest] and release date\n        assert!(items[0].detail.as_ref().unwrap().contains(\"[Latest]\"));\n        assert!(items[0].detail.as_ref().unwrap().contains(\"2 days ago\"));\n\n        // Second item should have release date but not [Latest]\n        assert!(!items[1].detail.as_ref().unwrap().contains(\"[Latest]\"));\n        assert!(items[1].detail.as_ref().unwrap().contains(\"1 week ago\"));\n\n        // Third item has no release date\n        assert!(!items[2].detail.as_ref().unwrap().contains(\"[Latest]\"));\n        assert_eq!(items[2].detail.as_ref().unwrap(), \"Version 1.0.198\");\n    }\n\n    #[test]\n    fn test_no_completions_outside_version() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.200\".to_string()),\n                versions: vec![\"1.0.200\".to_string()],\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        // Position outside the version field\n        let position = Position {\n            line: 5,\n            character: 0, // At the start, not in version\n        };\n\n        let completions = get_completions(\u0026deps, position, \u0026cache, |name| format!(\"test:{}\", name));\n\n        assert!(completions.is_none());\n    }\n\n    #[test]\n    fn test_no_completions_wrong_line() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.200\".to_string()),\n                versions: vec![\"1.0.200\".to_string()],\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let position = Position {\n            line: 10, // Wrong line\n            character: 13,\n        };\n\n        let completions = get_completions(\u0026deps, position, \u0026cache, |name| format!(\"test:{}\", name));\n\n        assert!(completions.is_none());\n    }\n\n    #[test]\n    fn test_no_completions_no_cache() {\n        let cache = MemoryCache::new();\n        let deps = vec![create_test_dependency(\"unknown\", \"1.0.0\", 5)];\n        let position = Position {\n            line: 5,\n            character: 13,\n        };\n\n        let completions = get_completions(\u0026deps, position, \u0026cache, |name| format!(\"test:{}\", name));\n\n        assert!(completions.is_none());\n    }\n\n    #[test]\n    fn test_format_release_age_1_hour() {\n        let now = Utc::now();\n        let released = now - Duration::hours(1);\n        let age = format_release_age(released);\n        assert_eq!(age, \"1 hour ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_1_minute() {\n        let now = Utc::now();\n        let released = now - Duration::minutes(1);\n        let age = format_release_age(released);\n        assert_eq!(age, \"1 min ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_1_week() {\n        let now = Utc::now();\n        let released = now - Duration::days(7);\n        let age = format_release_age(released);\n        assert_eq!(age, \"1 week ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_1_month() {\n        let now = Utc::now();\n        let released = now - Duration::days(30);\n        let age = format_release_age(released);\n        assert_eq!(age, \"1 month ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_future_date() {\n        let now = Utc::now();\n        let released = now + Duration::days(5);\n        let age = format_release_age(released);\n        assert_eq!(age, \"just now\");\n    }\n\n    #[test]\n    fn test_completions_many_versions() {\n        let cache = MemoryCache::new();\n        let versions: Vec\u003cString\u003e = (0..20).map(|i| format!(\"1.0.{}\", 20 - i)).collect();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.20\".to_string()),\n                versions,\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let position = Position {\n            line: 5,\n            character: 13,\n        };\n\n        let completions = get_completions(\u0026deps, position, \u0026cache, |name| format!(\"test:{}\", name));\n\n        assert!(completions.is_some());\n        let items = completions.unwrap();\n        assert_eq!(items.len(), 10);\n    }\n}\n","traces":[{"line":10,"address":[15525632],"length":1,"stats":{"Line":2}},{"line":11,"address":[14187445],"length":1,"stats":{"Line":2}},{"line":12,"address":[14169173],"length":1,"stats":{"Line":4}},{"line":14,"address":[14187537],"length":1,"stats":{"Line":3}},{"line":15,"address":[14187552],"length":1,"stats":{"Line":4}},{"line":16,"address":[15525781],"length":1,"stats":{"Line":2}},{"line":19,"address":[14187560],"length":1,"stats":{"Line":3}},{"line":20,"address":[14169309],"length":1,"stats":{"Line":4}},{"line":21,"address":[14187612],"length":1,"stats":{"Line":4}},{"line":22,"address":[14169351],"length":1,"stats":{"Line":2}},{"line":23,"address":[12939173],"length":1,"stats":{"Line":2}},{"line":24,"address":[14169407],"length":1,"stats":{"Line":2}},{"line":26,"address":[14169430,14169393],"length":1,"stats":{"Line":4}},{"line":28,"address":[15526182,15525871],"length":1,"stats":{"Line":4}},{"line":31,"address":[12939141],"length":1,"stats":{"Line":2}},{"line":32,"address":[14169952],"length":1,"stats":{"Line":2}},{"line":35,"address":[15526470],"length":1,"stats":{"Line":2}},{"line":36,"address":[14188288],"length":1,"stats":{"Line":2}},{"line":39,"address":[15526478],"length":1,"stats":{"Line":2}},{"line":40,"address":[14170874,14170150,14170910],"length":1,"stats":{"Line":5}},{"line":41,"address":[14170923,14170897],"length":1,"stats":{"Line":5}},{"line":44,"address":[15526632],"length":1,"stats":{"Line":2}},{"line":45,"address":[14170558,14170594,14170209],"length":1,"stats":{"Line":4}},{"line":46,"address":[12940414,12940388],"length":1,"stats":{"Line":4}},{"line":49,"address":[14170183,14170242,14170278],"length":1,"stats":{"Line":4}},{"line":50,"address":[14188579,14188553],"length":1,"stats":{"Line":4}},{"line":54,"address":[14906187,14900544,14903339,14903498,14906346,14904320,14901488,14907131,14906224,14902432,14904283,14905280,14902395,14904456,14901451,14902554,14905243,14903376,14901610,14905402,14900666],"length":1,"stats":{"Line":12}},{"line":61,"address":[14900717,14903475,14904310,14905270,14905453,14902422,14906397,14905379,14901587,14903366,14904507,14919152,14919040,14907158,14919376,14919488,14935280,14919264,14904433,14902605,14903549,14906323,14901661,14911088,14906214,14900643,14901478,14902531],"length":1,"stats":{"Line":40}},{"line":62,"address":[14919409,14919060,14919396,14919521,14919073,14935300,14919172,14911121,14935313,14919508,14919284,14919185,14911108,14919297],"length":1,"stats":{"Line":16}},{"line":63,"address":[14187362],"length":1,"stats":{"Line":10}},{"line":64,"address":[14919226,14919562,14919338,14935354,14911162,14919114,14919450],"length":1,"stats":{"Line":8}},{"line":67,"address":[14182718],"length":1,"stats":{"Line":8}},{"line":68,"address":[14906602,14906686,14901950,14901866,14903754,14905742,14901006,14902810,14904712,14902894,14903838,14904796,14900922,14905658],"length":1,"stats":{"Line":16}},{"line":71,"address":[14183037],"length":1,"stats":{"Line":6}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[14911241,14905130,14907018,14913088,14933248,14919600,14927481,14907209,14935236,14915161,14917008,14902282,14901338,14923561,14925408,14919641,14923520,14918996,14909056,14904170,14927396,14927440,14929328,14906074,14921488,14907168,14931316,14931360,14903226,14915120,14915076,14911044,14923476,14931401,14911200],"length":1,"stats":{"Line":18}},{"line":77,"address":[14165203],"length":1,"stats":{"Line":6}},{"line":78,"address":[19062745,19066777,19079097,19083017,19086937,19075065,19070697],"length":1,"stats":{"Line":6}},{"line":81,"address":[14183560],"length":1,"stats":{"Line":6}},{"line":82,"address":[14923727,14919807,14911407,14927647,14907375,14931567,14915327],"length":1,"stats":{"Line":2}},{"line":83,"address":[14919831,14923751,14931591,14927671,14907399,14911431,14915351],"length":1,"stats":{"Line":2}},{"line":84,"address":[19080036,19083166,19083956,19063684,19062894,19067716,19087086,19087876,19076004,19079246,19066926,19070846,19071636,19075214],"length":1,"stats":{"Line":4}},{"line":85,"address":[19067311,19079631,19063279,19071231,19075599,19063536,19071488,19067568,19075856,19079888,19083551,19087471,19083808,19087728],"length":1,"stats":{"Line":4}},{"line":87,"address":[14184001,14184139],"length":1,"stats":{"Line":4}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[14165393,14165544],"length":1,"stats":{"Line":12}},{"line":92,"address":[14165549],"length":1,"stats":{"Line":4}},{"line":94,"address":[19087113,19062921,19079273,19083193,19066953,19075241,19070873],"length":1,"stats":{"Line":6}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[14931968,14920208,14907776,14924128,14911808,14915728,14928048],"length":1,"stats":{"Line":6}},{"line":102,"address":[14928566,14912326,14908294,14916246,14924646,14932486,14920726],"length":1,"stats":{"Line":6}},{"line":103,"address":[14916287,14928607,14932527,14912438,14932598,14928678,14916358,14908406,14924687,14908335,14920838,14920767,14912367,14924758],"length":1,"stats":{"Line":12}},{"line":105,"address":[14166330,14166228],"length":1,"stats":{"Line":8}},{"line":106,"address":[19067977,19063872,19084217,19084144,19088064,19076265,19080224,19080297,19063945,19071824,19071897,19088137,19067904,19076192],"length":1,"stats":{"Line":4}},{"line":107,"address":[14166549],"length":1,"stats":{"Line":2}},{"line":108,"address":[19080464,19080551,19068231,19084384,19088304,19072151,19088391,19076519,19076432,19068144,19072064,19064112,19064199,19084471],"length":1,"stats":{"Line":4}},{"line":110,"address":[14167008,14167266,14166401],"length":1,"stats":{"Line":18}},{"line":111,"address":[14185556],"length":1,"stats":{"Line":6}},{"line":113,"address":[14909132,14925484,14933324,14913164,14921564,14929404,14917084],"length":1,"stats":{"Line":6}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[14167018],"length":1,"stats":{"Line":6}},{"line":120,"address":[14930254,14909982,14917934,14914014,14934174,14926334,14922414],"length":1,"stats":{"Line":6}},{"line":121,"address":[14913402,14933562,14929726,14909370,14913486,14917322,14929642,14933646,14921802,14909454,14917406,14925722,14921886,14925806],"length":1,"stats":{"Line":12}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[14925814,14909462,14917414,14929734,14913494,14921894,14933654],"length":1,"stats":{"Line":6}},{"line":124,"address":[14185766],"length":1,"stats":{"Line":6}},{"line":125,"address":[14185819,14185887],"length":1,"stats":{"Line":12}},{"line":126,"address":[14186049,14186114],"length":1,"stats":{"Line":12}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[14167874],"length":1,"stats":{"Line":6}},{"line":133,"address":[14164976],"length":1,"stats":{"Line":6}}],"covered":65,"coverable":71},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","providers","diagnostics.rs"],"content":"//! Diagnostics provider for outdated dependencies and vulnerabilities\n\nuse tower_lsp::lsp_types::*;\n\nuse crate::cache::ReadCache;\nuse crate::parsers::Dependency;\nuse crate::providers::inlay_hints::{VersionStatus, compare_versions, is_local_dependency};\nuse crate::registries::{VersionInfo, Vulnerability, VulnerabilitySeverity};\nuse crate::utils::truncate_string;\n\n/// Create diagnostics for a list of dependencies\n///\n/// The `min_severity` parameter filters vulnerabilities to only show those\n/// at or above the specified severity level.\npub fn create_diagnostics(\n    dependencies: \u0026[Dependency],\n    cache: \u0026impl ReadCache,\n    cache_key_fn: impl Fn(\u0026str) -\u003e String,\n    min_severity: Option\u003cVulnerabilitySeverity\u003e,\n) -\u003e Vec\u003cDiagnostic\u003e {\n    let mut diagnostics = Vec::new();\n\n    for dep in dependencies {\n        // Show informational diagnostic for local/path dependencies\n        if is_local_dependency(\u0026dep.version) {\n            diagnostics.push(create_local_dependency_diagnostic(dep));\n            continue;\n        }\n\n        // Add outdated version diagnostic\n        if let Some(diag) = create_outdated_diagnostic(dep, cache, \u0026cache_key_fn) {\n            diagnostics.push(diag);\n        }\n\n        let cache_key = cache_key_fn(\u0026dep.name);\n        if let Some(version_info) = cache.get(\u0026cache_key) {\n            // Add yanked version diagnostic (highest priority)\n            if version_info.is_version_yanked(\u0026dep.version) {\n                tracing::debug!(\n                    \"Package {} {} is yanked, creating diagnostic\",\n                    dep.name,\n                    dep.version\n                );\n                diagnostics.push(create_yanked_diagnostic(dep, \u0026version_info));\n            } else if version_info.deprecated {\n                // Add deprecation diagnostic\n                tracing::debug!(\n                    \"Package {} {} is deprecated, creating diagnostic\",\n                    dep.name,\n                    dep.version\n                );\n                diagnostics.push(create_deprecation_diagnostic(dep, \u0026version_info));\n            } else {\n                // Add vulnerability diagnostic (summary) only if not deprecated or yanked\n                let filtered_vulns: Vec\u003c_\u003e = version_info\n                    .vulnerabilities\n                    .iter()\n                    .filter(|vuln| {\n                        min_severity\n                            .as_ref()\n                            .map(|min| meets_severity_threshold(\u0026vuln.severity, min))\n                            .unwrap_or(true)\n                    })\n                    .collect();\n\n                if !filtered_vulns.is_empty() {\n                    diagnostics.push(create_vulnerability_summary_diagnostic(\n                        dep,\n                        \u0026filtered_vulns,\n                    ));\n                }\n            }\n        }\n    }\n\n    diagnostics\n}\n\n/// Check if a vulnerability severity meets the minimum threshold\nfn meets_severity_threshold(severity: \u0026VulnerabilitySeverity, min: \u0026VulnerabilitySeverity) -\u003e bool {\n    severity.meets_threshold(min)\n}\n\n/// Create a diagnostic for an outdated dependency\nfn create_outdated_diagnostic(\n    dep: \u0026Dependency,\n    cache: \u0026impl ReadCache,\n    cache_key_fn: impl Fn(\u0026str) -\u003e String,\n) -\u003e Option\u003cDiagnostic\u003e {\n    let cache_key = cache_key_fn(\u0026dep.name);\n    let version_info = cache.get(\u0026cache_key)?;\n\n    match compare_versions(\u0026dep.version, \u0026version_info) {\n        VersionStatus::UpdateAvailable(new_version) =\u003e Some(Diagnostic {\n            range: Range {\n                start: Position {\n                    line: dep.line,\n                    character: dep.version_start,\n                },\n                end: Position {\n                    line: dep.line,\n                    character: dep.version_end,\n                },\n            },\n            severity: Some(DiagnosticSeverity::HINT),\n            code: Some(NumberOrString::String(\"outdated\".to_string())),\n            source: Some(\"dependi\".to_string()),\n            message: format!(\"Update available: {} -\u003e {}\", dep.version, new_version),\n            related_information: None,\n            tags: None,\n            code_description: None,\n            data: None,\n        }),\n        VersionStatus::UpToDate | VersionStatus::Unknown =\u003e None,\n    }\n}\n\n/// Create a diagnostic for a local/path dependency\nfn create_local_dependency_diagnostic(dep: \u0026Dependency) -\u003e Diagnostic {\n    Diagnostic {\n        range: Range {\n            start: Position {\n                line: dep.line,\n                character: dep.version_start,\n            },\n            end: Position {\n                line: dep.line,\n                character: dep.version_end,\n            },\n        },\n        severity: Some(DiagnosticSeverity::HINT),\n        code: Some(NumberOrString::String(\"local\".to_string())),\n        source: Some(\"dependi\".to_string()),\n        message: \"→ Local\".to_string(),\n        related_information: None,\n        tags: None,\n        code_description: None,\n        data: None,\n    }\n}\n\n/// Create a diagnostic for a deprecated package\nfn create_deprecation_diagnostic(dep: \u0026Dependency, version_info: \u0026VersionInfo) -\u003e Diagnostic {\n    let mut message = format!(\n        \"The package '{}' is deprecated. Consider migrating to an alternative.\",\n        dep.name\n    );\n\n    if let Some(latest) = \u0026version_info.latest {\n        message.push_str(\u0026format!(\n            \" Latest version: {} (may not be deprecated).\",\n            latest\n        ));\n    }\n\n    let mut related_info = Vec::new();\n\n    if let Some(homepage) = \u0026version_info.homepage {\n        related_info.push(DiagnosticRelatedInformation {\n            location: Location {\n                uri: Url::parse(homepage).unwrap_or_else(|_| {\n                    Url::parse(\"https://example.com\").expect(\"Invalid fallback URL\")\n                }),\n                range: Range::default(),\n            },\n            message: \"Visit package homepage\".to_string(),\n        });\n    }\n\n    if let Some(repo) = \u0026version_info.repository {\n        related_info.push(DiagnosticRelatedInformation {\n            location: Location {\n                uri: Url::parse(repo).unwrap_or_else(|_| {\n                    Url::parse(\"https://github.com\").expect(\"Invalid fallback URL\")\n                }),\n                range: Range::default(),\n            },\n            message: \"View repository for migration guide\".to_string(),\n        });\n    }\n\n    Diagnostic {\n        range: Range {\n            start: Position {\n                line: dep.line,\n                character: dep.version_start,\n            },\n            end: Position {\n                line: dep.line,\n                character: dep.version_end,\n            },\n        },\n        severity: Some(DiagnosticSeverity::WARNING),\n        code: Some(NumberOrString::String(\"deprecated-package\".to_string())),\n        source: Some(\"dependi\".to_string()),\n        message,\n        related_information: if related_info.is_empty() {\n            None\n        } else {\n            Some(related_info)\n        },\n        tags: None,\n        code_description: None,\n        data: None,\n    }\n}\n\n/// Create a diagnostic for a yanked version\nfn create_yanked_diagnostic(dep: \u0026Dependency, version_info: \u0026VersionInfo) -\u003e Diagnostic {\n    let mut message = format!(\n        \"The version '{}' of '{}' has been yanked from crates.io and should not be used.\",\n        dep.version, dep.name\n    );\n\n    if let Some(latest) = \u0026version_info.latest {\n        message.push_str(\u0026format!(\" Update to {}.\", latest));\n    }\n\n    let crates_io_url = format!(\"https://crates.io/crates/{}\", dep.name);\n    let mut related_info = vec![DiagnosticRelatedInformation {\n        location: Location {\n            uri: Url::parse(\u0026crates_io_url)\n                .unwrap_or_else(|_| Url::parse(\"https://crates.io\").expect(\"Invalid fallback URL\")),\n            range: Range::default(),\n        },\n        message: \"View package on crates.io\".to_string(),\n    }];\n\n    if let Some(repo) = \u0026version_info.repository {\n        related_info.push(DiagnosticRelatedInformation {\n            location: Location {\n                uri: Url::parse(repo).unwrap_or_else(|_| {\n                    Url::parse(\"https://github.com\").expect(\"Invalid fallback URL\")\n                }),\n                range: Range::default(),\n            },\n            message: \"View repository for more information\".to_string(),\n        });\n    }\n\n    Diagnostic {\n        range: Range {\n            start: Position {\n                line: dep.line,\n                character: dep.version_start,\n            },\n            end: Position {\n                line: dep.line,\n                character: dep.version_end,\n            },\n        },\n        severity: Some(DiagnosticSeverity::WARNING),\n        code: Some(NumberOrString::String(\"yanked-version\".to_string())),\n        source: Some(\"dependi\".to_string()),\n        message,\n        related_information: Some(related_info),\n        tags: None,\n        code_description: Some(CodeDescription {\n            href: Url::parse(\u0026crates_io_url)\n                .unwrap_or_else(|_| Url::parse(\"https://crates.io\").expect(\"Invalid fallback URL\")),\n        }),\n        data: None,\n    }\n}\n\n/// Create a summary diagnostic for multiple vulnerabilities\nfn create_vulnerability_summary_diagnostic(\n    dep: \u0026Dependency,\n    vulns: \u0026[\u0026Vulnerability],\n) -\u003e Diagnostic {\n    let count = vulns.len();\n\n    // Use the highest severity among all vulnerabilities\n    let severity_to_num = |s: \u0026VulnerabilitySeverity| match s {\n        VulnerabilitySeverity::Critical =\u003e 4,\n        VulnerabilitySeverity::High =\u003e 3,\n        VulnerabilitySeverity::Medium =\u003e 2,\n        VulnerabilitySeverity::Low =\u003e 1,\n    };\n    let max_severity = vulns\n        .iter()\n        .map(|v| \u0026v.severity)\n        .max_by_key(|s| severity_to_num(s))\n        .unwrap_or(\u0026VulnerabilitySeverity::Low);\n\n    let diagnostic_severity = match max_severity {\n        VulnerabilitySeverity::Critical | VulnerabilitySeverity::High =\u003e DiagnosticSeverity::ERROR,\n        VulnerabilitySeverity::Medium =\u003e DiagnosticSeverity::WARNING,\n        VulnerabilitySeverity::Low =\u003e DiagnosticSeverity::HINT,\n    };\n\n    // Build summary message\n    let vuln_word = if count == 1 { \"vuln\" } else { \"vulns\" };\n    let vuln_ids: Vec\u003c_\u003e = vulns.iter().map(|v| v.id.as_str()).collect();\n    let message = format!(\"⚠ {} {}: {}\", count, vuln_word, vuln_ids.join(\", \"));\n\n    // Collect related information for all vulnerabilities\n    let related_info: Vec\u003c_\u003e = vulns\n        .iter()\n        .filter_map(|vuln| {\n            vuln.url.as_ref().map(|url| DiagnosticRelatedInformation {\n                location: Location {\n                    uri: Url::parse(url).unwrap_or_else(|_| {\n                        Url::parse(\"https://osv.dev\").expect(\"Invalid fallback URL\")\n                    }),\n                    range: Range::default(),\n                },\n                message: format!(\"{}: {}\", vuln.id, truncate_string(\u0026vuln.description, 80)),\n            })\n        })\n        .collect();\n\n    Diagnostic {\n        range: Range {\n            start: Position {\n                line: dep.line,\n                character: dep.version_start,\n            },\n            end: Position {\n                line: dep.line,\n                character: dep.version_end,\n            },\n        },\n        severity: Some(diagnostic_severity),\n        code: Some(NumberOrString::String(format!(\"{}-vulns\", count))),\n        source: Some(\"dependi-security\".to_string()),\n        message,\n        related_information: if related_info.is_empty() {\n            None\n        } else {\n            Some(related_info)\n        },\n        tags: None,\n        code_description: vulns.first().and_then(|v| {\n            v.url\n                .as_ref()\n                .and_then(|url| Url::parse(url).ok().map(|href| CodeDescription { href }))\n        }),\n        data: None,\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::cache::{MemoryCache, WriteCache};\n    use crate::registries::VersionInfo;\n\n    fn create_test_dependency(name: \u0026str, version: \u0026str, line: u32) -\u003e Dependency {\n        Dependency {\n            name: name.to_string(),\n            version: version.to_string(),\n            line,\n            name_start: 0,\n            name_end: name.len() as u32,\n            version_start: name.len() as u32 + 4,\n            version_end: name.len() as u32 + 4 + version.len() as u32,\n            dev: false,\n            optional: false,\n        }\n    }\n\n    #[test]\n    fn test_create_diagnostic_outdated() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        assert_eq!(diagnostics.len(), 1);\n        assert!(diagnostics[0].message.contains(\"2.0.0\"));\n        assert_eq!(diagnostics[0].severity, Some(DiagnosticSeverity::HINT));\n    }\n\n    #[test]\n    fn test_no_diagnostic_up_to_date() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        assert_eq!(diagnostics.len(), 0);\n    }\n\n    #[test]\n    fn test_no_diagnostic_no_cache() {\n        let cache = MemoryCache::new();\n        let deps = vec![create_test_dependency(\"unknown\", \"1.0.0\", 5)];\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        assert_eq!(diagnostics.len(), 0);\n    }\n\n    #[test]\n    fn test_severity_filtering() {\n        assert!(meets_severity_threshold(\n            \u0026VulnerabilitySeverity::Critical,\n            \u0026VulnerabilitySeverity::Low\n        ));\n        assert!(meets_severity_threshold(\n            \u0026VulnerabilitySeverity::High,\n            \u0026VulnerabilitySeverity::Medium\n        ));\n        assert!(!meets_severity_threshold(\n            \u0026VulnerabilitySeverity::Low,\n            \u0026VulnerabilitySeverity::High\n        ));\n        assert!(meets_severity_threshold(\n            \u0026VulnerabilitySeverity::Medium,\n            \u0026VulnerabilitySeverity::Medium\n        ));\n    }\n\n    #[test]\n    fn test_deprecated_diagnostic() {\n        let deps = vec![create_test_dependency(\"old-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:old-dep\".to_string(),\n            VersionInfo {\n                deprecated: true,\n                latest: Some(\"2.0.0\".to_string()),\n                homepage: Some(\"https://example.com\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let deprecation_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"deprecated\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(deprecation_diags.len(), 1);\n        assert!(deprecation_diags[0].message.contains(\"deprecated\"));\n        assert_eq!(\n            deprecation_diags[0].severity,\n            Some(DiagnosticSeverity::WARNING)\n        );\n        assert!(deprecation_diags[0].related_information.is_some());\n    }\n\n    #[test]\n    fn test_no_deprecated_diagnostic_for_active() {\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                deprecated: false,\n                latest: Some(\"1.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let deprecation_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"deprecated\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(deprecation_diags.len(), 0);\n    }\n\n    #[test]\n    fn test_deprecated_with_vulnerabilities() {\n        let deps = vec![create_test_dependency(\"vuln-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:vuln-dep\".to_string(),\n            VersionInfo {\n                deprecated: true,\n                vulnerabilities: vec![Vulnerability {\n                    id: \"CVE-2024-1234\".to_string(),\n                    severity: VulnerabilitySeverity::High,\n                    description: \"Test vulnerability\".to_string(),\n                    url: None,\n                }],\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let deprecation_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"deprecated\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.starts_with(\"CVE\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(deprecation_diags.len(), 1);\n        assert_eq!(\n            vuln_diags.len(),\n            0,\n            \"Deprecated packages should not show individual vulnerability diagnostics\"\n        );\n    }\n\n    #[test]\n    fn test_yanked_diagnostic() {\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                yanked_versions: vec![\"1.0.0\".to_string()],\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let yanked_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"yanked\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(yanked_diags.len(), 1);\n        assert!(yanked_diags[0].message.contains(\"yanked\"));\n        assert_eq!(yanked_diags[0].severity, Some(DiagnosticSeverity::WARNING));\n    }\n\n    #[test]\n    fn test_no_yanked_diagnostic_for_non_yanked() {\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                yanked_versions: vec![\"0.9.0\".to_string()],\n                latest: Some(\"1.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let yanked_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"yanked\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(yanked_diags.len(), 0);\n    }\n\n    #[test]\n    fn test_yanked_priority_over_deprecated_diagnostic() {\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                yanked_versions: vec![\"1.0.0\".to_string()],\n                deprecated: true,\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let yanked_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"yanked\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        let deprecated_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"deprecated\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(yanked_diags.len(), 1, \"Should show yanked diagnostic\");\n        assert_eq!(\n            deprecated_diags.len(),\n            0,\n            \"Yanked packages should not show deprecated diagnostic\"\n        );\n    }\n\n    #[test]\n    fn test_yanked_priority_over_vulnerabilities_diagnostic() {\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                yanked_versions: vec![\"1.0.0\".to_string()],\n                vulnerabilities: vec![Vulnerability {\n                    id: \"CVE-2024-1234\".to_string(),\n                    severity: VulnerabilitySeverity::High,\n                    description: \"Test vulnerability\".to_string(),\n                    url: None,\n                }],\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let yanked_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"yanked\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.starts_with(\"CVE\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(yanked_diags.len(), 1, \"Should show yanked diagnostic\");\n        assert_eq!(\n            vuln_diags.len(),\n            0,\n            \"Yanked packages should not show vulnerability diagnostics\"\n        );\n    }\n\n    #[test]\n    fn test_local_dependency_diagnostic() {\n        let deps = vec![create_test_dependency(\"local-crate\", \"../local\", 5)];\n        let cache = MemoryCache::new();\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        assert_eq!(diagnostics.len(), 1);\n        assert!(diagnostics[0].message.contains(\"Local\"));\n        assert_eq!(diagnostics[0].severity, Some(DiagnosticSeverity::HINT));\n    }\n\n    #[test]\n    fn test_vulnerability_summary_diagnostic() {\n        let deps = vec![create_test_dependency(\"vuln-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:vuln-dep\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                vulnerabilities: vec![\n                    Vulnerability {\n                        id: \"CVE-2024-1234\".to_string(),\n                        severity: VulnerabilitySeverity::High,\n                        description: \"High severity vulnerability\".to_string(),\n                        url: Some(\"https://osv.dev/CVE-2024-1234\".to_string()),\n                    },\n                    Vulnerability {\n                        id: \"CVE-2024-5678\".to_string(),\n                        severity: VulnerabilitySeverity::Medium,\n                        description: \"Medium severity vulnerability\".to_string(),\n                        url: None,\n                    },\n                ],\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"vulns\")))\n            })\n            .collect();\n\n        assert_eq!(vuln_diags.len(), 1);\n        assert!(vuln_diags[0].message.contains(\"2 vulns\"));\n        assert_eq!(vuln_diags[0].severity, Some(DiagnosticSeverity::ERROR));\n        assert!(vuln_diags[0].related_information.is_some());\n    }\n\n    #[test]\n    fn test_vulnerability_severity_filtering() {\n        let deps = vec![create_test_dependency(\"vuln-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:vuln-dep\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                vulnerabilities: vec![\n                    Vulnerability {\n                        id: \"CVE-2024-LOW\".to_string(),\n                        severity: VulnerabilitySeverity::Low,\n                        description: \"Low severity\".to_string(),\n                        url: None,\n                    },\n                    Vulnerability {\n                        id: \"CVE-2024-HIGH\".to_string(),\n                        severity: VulnerabilitySeverity::High,\n                        description: \"High severity\".to_string(),\n                        url: None,\n                    },\n                ],\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\n            \u0026deps,\n            \u0026cache,\n            |name| format!(\"test:{}\", name),\n            Some(VulnerabilitySeverity::High),\n        );\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"vulns\")))\n            })\n            .collect();\n\n        assert_eq!(vuln_diags.len(), 1);\n        assert!(vuln_diags[0].message.contains(\"1 vuln\"));\n    }\n\n    #[test]\n    fn test_deprecation_diagnostic_with_repository() {\n        let deps = vec![create_test_dependency(\"old-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:old-dep\".to_string(),\n            VersionInfo {\n                deprecated: true,\n                latest: Some(\"2.0.0\".to_string()),\n                repository: Some(\"https://github.com/user/old-dep\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let deprecation_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"deprecated\")))\n            })\n            .collect();\n\n        assert_eq!(deprecation_diags.len(), 1);\n        assert!(deprecation_diags[0].related_information.is_some());\n        let related = deprecation_diags[0].related_information.as_ref().unwrap();\n        assert!(!related.is_empty());\n    }\n\n    #[test]\n    fn test_yanked_diagnostic_with_repository() {\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                yanked_versions: vec![\"1.0.0\".to_string()],\n                latest: Some(\"2.0.0\".to_string()),\n                repository: Some(\"https://github.com/serde-rs/serde\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let yanked_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"yanked\")))\n            })\n            .collect();\n\n        assert_eq!(yanked_diags.len(), 1);\n        assert!(yanked_diags[0].related_information.is_some());\n        let related = yanked_diags[0].related_information.as_ref().unwrap();\n        assert_eq!(related.len(), 2);\n    }\n\n    #[test]\n    fn test_vulnerability_low_severity_hint() {\n        let deps = vec![create_test_dependency(\"vuln-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:vuln-dep\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                vulnerabilities: vec![Vulnerability {\n                    id: \"CVE-2024-LOW\".to_string(),\n                    severity: VulnerabilitySeverity::Low,\n                    description: \"Low severity\".to_string(),\n                    url: None,\n                }],\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"vulns\")))\n            })\n            .collect();\n\n        assert_eq!(vuln_diags.len(), 1);\n        assert_eq!(vuln_diags[0].severity, Some(DiagnosticSeverity::HINT));\n    }\n\n    #[test]\n    fn test_vulnerability_medium_severity_warning() {\n        let deps = vec![create_test_dependency(\"vuln-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:vuln-dep\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                vulnerabilities: vec![Vulnerability {\n                    id: \"CVE-2024-MED\".to_string(),\n                    severity: VulnerabilitySeverity::Medium,\n                    description: \"Medium severity\".to_string(),\n                    url: None,\n                }],\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"vulns\")))\n            })\n            .collect();\n\n        assert_eq!(vuln_diags.len(), 1);\n        assert_eq!(vuln_diags[0].severity, Some(DiagnosticSeverity::WARNING));\n    }\n\n    #[test]\n    fn test_vulnerability_critical_severity_error() {\n        let deps = vec![create_test_dependency(\"vuln-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:vuln-dep\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                vulnerabilities: vec![Vulnerability {\n                    id: \"CVE-2024-CRIT\".to_string(),\n                    severity: VulnerabilitySeverity::Critical,\n                    description: \"Critical severity\".to_string(),\n                    url: None,\n                }],\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"vulns\")))\n            })\n            .collect();\n\n        assert_eq!(vuln_diags.len(), 1);\n        assert_eq!(vuln_diags[0].severity, Some(DiagnosticSeverity::ERROR));\n    }\n}\n","traces":[{"line":15,"address":[13061648,13061756,13063177],"length":1,"stats":{"Line":36}},{"line":21,"address":[18717177,18735769,18762345,18757033,18741097,18722489,18749065,18733113,18743753,18746409,18725145,18751721,18754377,18759689,18727801,18719833,18730457,18714521,18738433],"length":1,"stats":{"Line":36}},{"line":23,"address":[13061807,13061891],"length":1,"stats":{"Line":72}},{"line":25,"address":[13090933,13091035],"length":1,"stats":{"Line":72}},{"line":26,"address":[13062189,13064403],"length":1,"stats":{"Line":4}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[13062211,13062154],"length":1,"stats":{"Line":68}},{"line":32,"address":[18752254,18746942,18736302,18738966,18754948,18720366,18728334,18728372,18760222,18754910,18762878,18715054,18725716,18741630,18752292,18717748,18757566,18733684,18717710,18736340,18762916,18723022,18744286,18723060,18720404,18733646,18715092,18749636,18757604,18741668,18725678,18739004,18746980,18749598,18744324,18730990,18731028,18760260],"length":1,"stats":{"Line":28}},{"line":35,"address":[13607693,13626358,13591757,13591814,13613005,13620989,13615726,13597069,13594470,13615669,13618333,13628957,13599725,13607750,13634326,13631613,13626301,13586502,13605037,13629014,13631670,13613062,13621046,13623645,13594413,13634269,13602438,13623702,13602381,13610349,13618390,13589158,13586445,13589101,13599782,13605094,13610406,13597126],"length":1,"stats":{"Line":68}},{"line":36,"address":[13591829,13621160,13631685,13613077,13602453,13613176,13618405,13629128,13586517,13589272,13634341,13615840,13615741,13626373,13594584,13594485,13605208,13631784,13597240,13589173,13634440,13599797,13591928,13605109,13602552,13618504,13607864,13623717,13610421,13599896,13629029,13607765,13586616,13623816,13621061,13626472,13597141,13610520],"length":1,"stats":{"Line":68}},{"line":38,"address":[13091510,13091619],"length":1,"stats":{"Line":64}},{"line":39,"address":[13064061,13062742,13063800],"length":1,"stats":{"Line":16}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[13614653,13607015,13604029,13628279,13633591,13620311,13604359,13609341,13612327,13635917,13601703,13606685,13593405,13627949,13590749,13591079,13588423,13596061,13630935,13636247,13599047,13617655,13611997,13625293,13614983,13609671,13622967,13598717,13617323,13625623,13630605,13633261,13601373,13622637,13596391,13588093,13593735,13619981],"length":1,"stats":{"Line":16}},{"line":45,"address":[13062730],"length":1,"stats":{"Line":24}},{"line":47,"address":[13063190,13063451,13062808],"length":1,"stats":{"Line":12}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[13590483,13603431,13611731,13606419,13601107,13609075,13627351,13619383,13624695,13600775,13590151,13619715,13635319,13625027,13611399,13603763,13622371,13592807,13587827,13630007,13630339,13627683,13608743,13632663,13593139,13617057,13587495,13614387,13622039,13632995,13635651,13598451,13606087,13614055,13595463,13595795,13598119,13616725],"length":1,"stats":{"Line":12}},{"line":55,"address":[13062773],"length":1,"stats":{"Line":18}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[18758150,18715638,18726262,18752838,18765232,18765808,18766128,18720950,18765392,18766288,18766640,18767616,18723606,18767104,18767888,18742214,18747526,18765680,18766016,18765504,18755494,18731574,18750182,18736886,18765568,18765120,18763462,18728918,18767680,18767264,18744870,18718294,18765056,18765744,18766800,18734230,18760806,18739550],"length":1,"stats":{"Line":28}},{"line":59,"address":[13639186,13636482,13636658,13636834,13638690,13638434,13637394,13638226,13639074,13637874,13638754,13636546,13636306,13637714,13636770,13637090,13637602,13636418,13638962],"length":1,"stats":{"Line":10}},{"line":60,"address":[13093493],"length":1,"stats":{"Line":10}},{"line":61,"address":[13093536,13093550,13093506],"length":1,"stats":{"Line":14}},{"line":62,"address":[13093515],"length":1,"stats":{"Line":10}},{"line":66,"address":[13063029,13062952],"length":1,"stats":{"Line":36}},{"line":67,"address":[13629697,13632353,13635009,13621729,13587185,13597809,13613745,13627041,13619073,13595153,13624385,13592497,13600465,13611089,13608433,13616415,13589841,13603121,13605777],"length":1,"stats":{"Line":10}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[13063035],"length":1,"stats":{"Line":10}},{"line":76,"address":[13062048],"length":1,"stats":{"Line":36}},{"line":80,"address":[13030832],"length":1,"stats":{"Line":2}},{"line":81,"address":[13071454],"length":1,"stats":{"Line":2}},{"line":85,"address":[13653225,13666018,13648242,13669385,13667769,13664402,13646761,13648377,13658073,13661305,13659616,13649993,13654841,13643394,13666153,13651474,13648304,13646626,13649858,13654706,13640297,13661170,13664537,13645145,13653152,13659554,13641913,13658000,13656457,13659689,13667634,13669312,13670866,13640224,13662921,13643456,13653090,13656384,13651536,13651609,13669250,13643529,13666080,13649920,13645010,13662848,13662786,13646688,13656322,13641840,13667696,13641778,13645072,13661232,13664464,13657938,13654768],"length":1,"stats":{"Line":34}},{"line":90,"address":[13649976,13648435,13662904,13640280,13640355,13651592,13643587,13646744,13646819,13659747,13643512,13664595,13667752,13662979,13653208,13661288,13656440,13648360,13654899,13658056,13658131,13666136,13653283,13664520,13641896,13645128,13667827,13661363,13651667,13656515,13659672,13666211,13645203,13669368,13669443,13650051,13641971,13654824],"length":1,"stats":{"Line":68}},{"line":91,"address":[13640370,13651763,13646834,13653379,13654995,13664610,13658227,13663075,13645218,13653298,13667923,13650147,13656611,13659843,13643683,13645299,13654914,13662994,13658146,13641986,13640451,13669539,13643602,13661378,13664691,13666226,13650066,13656530,13669458,13646915,13651682,13666307,13661459,13667842,13642067,13659762,13648450,13648531],"length":1,"stats":{"Line":68}},{"line":93,"address":[18782160,18775783,18772464,18782247,18783776,18783863,18770935,18775696,18769232,18780631,18793559,18795088,18796791,18798407,18795175,18796704,18774167,18788624,18770848,18785479,18769319,18772551,18779015,18787008,18778928,18777312,18793472,18777399,18788711,18780544,18790240,18798320,18785392,18791856,18791943,18787095,18790327,18774080],"length":1,"stats":{"Line":64}},{"line":94,"address":[13094451,13095052],"length":1,"stats":{"Line":28}},{"line":95,"address":[13094492],"length":1,"stats":{"Line":14}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[13065555],"length":1,"stats":{"Line":14}},{"line":98,"address":[13094486],"length":1,"stats":{"Line":14}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[13661841,13660225,13668305,13644065,13640833,13669921,13663457,13652145,13653761,13665073,13656993,13655377,13642449,13650529,13645681,13647297,13666689,13658609,13648913],"length":1,"stats":{"Line":14}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[13660331,13647328,13652251,13666720,13644171,13665179,13645712,13647403,13668411,13644096,13649019,13642480,13666795,13658640,13658715,13640939,13640864,13660256,13669952,13653867,13650635,13665104,13663488,13655483,13668336,13661947,13657024,13661872,13642555,13655408,13663563,13648944,13650560,13645787,13652176,13670027,13657099,13653792],"length":1,"stats":{"Line":28}},{"line":107,"address":[13668555,13655627,13650699,13652315,13662091,13644235,13647467,13645931,13663707,13642619,13649163,13653931,13662011,13663627,13670091,13665243,13645851,13657163,13649083,13658859,13644315,13666939,13654011,13652395,13642699,13655547,13660475,13658779,13665323,13657243,13668475,13670171,13647547,13641003,13650779,13641083,13666859,13660395],"length":1,"stats":{"Line":28}},{"line":108,"address":[13652518,13650811,13645963,13657366,13647579,13654043,13670203,13649286,13646054,13662214,13650902,13642822,13668678,13658891,13655750,13660598,13663830,13644347,13665355,13665446,13641206,13660507,13642731,13652427,13670294,13644438,13641115,13647670,13649195,13654134,13657275,13663739,13658982,13666971,13655659,13662123,13668587,13667062],"length":1,"stats":{"Line":28}},{"line":109,"address":[13095020],"length":1,"stats":{"Line":14}},{"line":110,"address":[13659148,13655916,13660764,13644604,13652684,13662380,13667228,13668844,13657532,13670460,13642988,13641372,13649452,13646220,13651068,13647836,13654300,13663996,13665612],"length":1,"stats":{"Line":14}},{"line":111,"address":[18781316,18779700,18795860,18797476,18773236,18770004,18786164,18782932,18784548,18799092,18794244,18791012,18789396,18787780,18774852,18778084,18771620,18776468,18792628],"length":1,"stats":{"Line":14}},{"line":112,"address":[18786172,18789404,18779708,18784556,18770012,18774860,18776476,18773244,18791020,18794252,18782940,18787788,18771628,18795868,18778092,18792636,18781324,18797484,18799100],"length":1,"stats":{"Line":14}},{"line":114,"address":[13094428],"length":1,"stats":{"Line":18}},{"line":119,"address":[13033600,13034306,13034312],"length":1,"stats":{"Line":2}},{"line":121,"address":[13074258],"length":1,"stats":{"Line":2}},{"line":132,"address":[13074274],"length":1,"stats":{"Line":2}},{"line":133,"address":[13103343,13103278],"length":1,"stats":{"Line":4}},{"line":134,"address":[13033823],"length":1,"stats":{"Line":2}},{"line":143,"address":[13074195,13072036,13071472],"length":1,"stats":{"Line":4}},{"line":144,"address":[13100443],"length":1,"stats":{"Line":4}},{"line":149,"address":[13100595],"length":1,"stats":{"Line":4}},{"line":150,"address":[15093413,15093499,15093683],"length":1,"stats":{"Line":12}},{"line":156,"address":[13100688],"length":1,"stats":{"Line":2}},{"line":158,"address":[13072047],"length":1,"stats":{"Line":2}},{"line":159,"address":[13031932],"length":1,"stats":{"Line":2}},{"line":160,"address":[13031745],"length":1,"stats":{"Line":2}},{"line":161,"address":[18799648],"length":1,"stats":{"Line":4}},{"line":162,"address":[13095621],"length":1,"stats":{"Line":0}},{"line":164,"address":[13072310],"length":1,"stats":{"Line":2}},{"line":166,"address":[13031857],"length":1,"stats":{"Line":2}},{"line":170,"address":[15094397,15093816],"length":1,"stats":{"Line":4}},{"line":171,"address":[15094799],"length":1,"stats":{"Line":2}},{"line":172,"address":[13101876],"length":1,"stats":{"Line":2}},{"line":173,"address":[13095504],"length":1,"stats":{"Line":4}},{"line":174,"address":[13066597],"length":1,"stats":{"Line":0}},{"line":176,"address":[13072897],"length":1,"stats":{"Line":2}},{"line":178,"address":[13073060],"length":1,"stats":{"Line":2}},{"line":183,"address":[13072768],"length":1,"stats":{"Line":2}},{"line":194,"address":[13102239,13101724],"length":1,"stats":{"Line":4}},{"line":195,"address":[15095110,15095035],"length":1,"stats":{"Line":4}},{"line":197,"address":[15095187,15095246,15095356],"length":1,"stats":{"Line":9}},{"line":209,"address":[13100332,13097088,13097746],"length":1,"stats":{"Line":2}},{"line":210,"address":[13068206],"length":1,"stats":{"Line":4}},{"line":215,"address":[13068427],"length":1,"stats":{"Line":5}},{"line":216,"address":[15090195,15090298],"length":1,"stats":{"Line":14}},{"line":219,"address":[13027939,13028232],"length":1,"stats":{"Line":15}},{"line":220,"address":[13069028,13068934,13069377,13071399,13068995],"length":1,"stats":{"Line":24}},{"line":221,"address":[13098118],"length":1,"stats":{"Line":8}},{"line":222,"address":[13069090,13069011],"length":1,"stats":{"Line":16}},{"line":223,"address":[13028501],"length":1,"stats":{"Line":8}},{"line":224,"address":[13069139],"length":1,"stats":{"Line":8}},{"line":226,"address":[13069302],"length":1,"stats":{"Line":8}},{"line":229,"address":[13029076],"length":1,"stats":{"Line":8}},{"line":230,"address":[13070182],"length":1,"stats":{"Line":2}},{"line":231,"address":[13098923],"length":1,"stats":{"Line":2}},{"line":232,"address":[13093568],"length":1,"stats":{"Line":4}},{"line":233,"address":[13093589],"length":1,"stats":{"Line":0}},{"line":235,"address":[13029336],"length":1,"stats":{"Line":2}},{"line":237,"address":[15091787],"length":1,"stats":{"Line":2}},{"line":242,"address":[13069774],"length":1,"stats":{"Line":6}},{"line":253,"address":[13070358,13069802],"length":1,"stats":{"Line":12}},{"line":254,"address":[13099350,13099425],"length":1,"stats":{"Line":12}},{"line":256,"address":[13099497],"length":1,"stats":{"Line":6}},{"line":258,"address":[15092464],"length":1,"stats":{"Line":8}},{"line":267,"address":[13036403,13034336,13036497],"length":1,"stats":{"Line":4}},{"line":271,"address":[13075032],"length":1,"stats":{"Line":4}},{"line":274,"address":[13066858,13066848],"length":1,"stats":{"Line":15}},{"line":275,"address":[13066919],"length":1,"stats":{"Line":2}},{"line":276,"address":[13671389],"length":1,"stats":{"Line":3}},{"line":277,"address":[13671379],"length":1,"stats":{"Line":2}},{"line":278,"address":[13066889],"length":1,"stats":{"Line":2}},{"line":282,"address":[13096010,13096000],"length":1,"stats":{"Line":16}},{"line":283,"address":[13671200,13671213],"length":1,"stats":{"Line":19}},{"line":284,"address":[15096755],"length":1,"stats":{"Line":8}},{"line":286,"address":[15096775],"length":1,"stats":{"Line":8}},{"line":287,"address":[13104113],"length":1,"stats":{"Line":5}},{"line":288,"address":[15096820],"length":1,"stats":{"Line":2}},{"line":289,"address":[13034519],"length":1,"stats":{"Line":2}},{"line":293,"address":[13104124],"length":1,"stats":{"Line":9}},{"line":294,"address":[13034630],"length":1,"stats":{"Line":24}},{"line":295,"address":[13075399,13075324],"length":1,"stats":{"Line":15}},{"line":300,"address":[13066768],"length":1,"stats":{"Line":15}},{"line":301,"address":[13067104,13066796,13067804,13067729,13067798],"length":1,"stats":{"Line":13}},{"line":302,"address":[18800358],"length":1,"stats":{"Line":2}},{"line":303,"address":[13067936,13067155],"length":1,"stats":{"Line":2}},{"line":304,"address":[13067957],"length":1,"stats":{"Line":0}},{"line":306,"address":[13096146],"length":1,"stats":{"Line":2}},{"line":308,"address":[13671807,13671722],"length":1,"stats":{"Line":4}},{"line":314,"address":[13075914],"length":1,"stats":{"Line":8}},{"line":324,"address":[13035278],"length":1,"stats":{"Line":8}},{"line":325,"address":[13104954,13104886],"length":1,"stats":{"Line":16}},{"line":326,"address":[13035526,13035601],"length":1,"stats":{"Line":16}},{"line":328,"address":[13076408,13076518,13076337],"length":1,"stats":{"Line":18}},{"line":334,"address":[13067008],"length":1,"stats":{"Line":24}}],"covered":121,"coverable":138},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","providers","inlay_hints.rs"],"content":"//! Inlay hints provider for dependency versions\n\nuse tower_lsp::lsp_types::{InlayHint, InlayHintKind, InlayHintLabel, Position};\n\nuse crate::parsers::Dependency;\nuse crate::registries::{VersionInfo, VulnerabilitySeverity};\nuse crate::utils::truncate_string;\n\n/// Result of comparing a dependency version with the latest available\n#[derive(Debug, Clone)]\npub enum VersionStatus {\n    /// Version is up to date\n    UpToDate,\n    /// Update available to the given version\n    UpdateAvailable(String),\n    /// Could not determine version status\n    Unknown,\n}\n\n/// Generate an inlay hint for a dependency\npub fn create_inlay_hint(dep: \u0026Dependency, version_info: Option\u003c\u0026VersionInfo\u003e) -\u003e InlayHint {\n    let status = match version_info {\n        Some(info) =\u003e compare_versions(\u0026dep.version, info),\n        None =\u003e VersionStatus::Unknown,\n    };\n\n    // Check for vulnerabilities and deprecation\n    let vuln_count = version_info\n        .map(|info| info.vulnerabilities.len())\n        .unwrap_or(0);\n\n    let is_deprecated = version_info.map(|info| info.deprecated).unwrap_or(false);\n\n    if is_deprecated {\n        tracing::debug!(\"Package {} {} is deprecated\", dep.name, dep.version);\n    }\n\n    let (label, tooltip) = create_hint_label_and_tooltip(\u0026status, vuln_count, dep, version_info);\n\n    InlayHint {\n        position: Position {\n            line: dep.line,\n            character: dep.version_end + 1,\n        },\n        label: InlayHintLabel::String(format!(\" {}\", label)),\n        kind: Some(InlayHintKind::PARAMETER),\n        text_edits: None,\n        tooltip: tooltip.map(tower_lsp::lsp_types::InlayHintTooltip::String),\n        padding_left: Some(true),\n        padding_right: None,\n        data: None,\n    }\n}\n\n/// Create label and tooltip based on version status and vulnerabilities\nfn create_hint_label_and_tooltip(\n    status: \u0026VersionStatus,\n    vuln_count: usize,\n    dep: \u0026Dependency,\n    version_info: Option\u003c\u0026VersionInfo\u003e,\n) -\u003e (String, Option\u003cString\u003e) {\n    // Handle local dependencies first (highest priority - no registry lookup needed)\n    if is_local_dependency(\u0026dep.version) {\n        let tooltip = format!(\n            \"**Local Dependency**\\n\\n\\\n            \\\"{}\\\" is a local/path dependency.\\n\\n\\\n            Version info is not available for local packages.\\n\\n\\\n            This is expected for dependencies using:\\n\\\n            • path = \\\"./...\\\"\\n\\\n            • git = \\\"https://...\\\"\\n\\\n            • git = \\\"git@...\\\"\\n\\\n            • github:owner/repo\",\n            dep.name\n        );\n        return (\"→ Local\".to_string(), Some(tooltip));\n    }\n\n    tracing::debug!(\n        \"Not a local dependency: {} with version '{}'\",\n        dep.name,\n        dep.version\n    );\n\n    // Handle yanked versions (highest priority - critical issue)\n    if let Some(info) = version_info\n        \u0026\u0026 info.is_version_yanked(\u0026dep.version)\n    {\n        let yanked_label = \"⊘ Yanked\".to_string();\n        let yanked_tooltip = format_yanked_tooltip(dep, info);\n\n        return match status {\n            VersionStatus::UpdateAvailable(latest) =\u003e {\n                let label = format!(\"{} -\u003e {}\", yanked_label, latest);\n                let tooltip = format!(\n                    \"{}\\n\\n---\\n**Update available:** {} -\u003e {}\",\n                    yanked_tooltip, dep.version, latest\n                );\n                (label, Some(tooltip))\n            }\n            _ =\u003e (yanked_label, Some(yanked_tooltip)),\n        };\n    }\n\n    // Handle deprecation (second highest priority)\n    if let Some(info) = version_info\n        \u0026\u0026 info.deprecated\n    {\n        let dep_label = \"⚠ Deprecated\".to_string();\n        let dep_tooltip = format_deprecation_tooltip(dep, info);\n\n        // Combine with update info if available\n        return match status {\n            VersionStatus::UpdateAvailable(latest) =\u003e {\n                let label = format!(\"{} -\u003e {}\", dep_label, latest);\n                let tooltip = format!(\n                    \"{}\\n\\n---\\n**Update available:** {} -\u003e {}\",\n                    dep_tooltip, dep.version, latest\n                );\n                (label, Some(tooltip))\n            }\n            _ =\u003e (dep_label, Some(dep_tooltip)),\n        };\n    }\n\n    // Handle vulnerabilities\n    if vuln_count \u003e 0 {\n        let vuln_label = format!(\n            \"⚠ {} {}\",\n            vuln_count,\n            if vuln_count == 1 { \"vuln\" } else { \"vulns\" }\n        );\n        let vuln_tooltip = format_vulnerability_tooltip(version_info.unwrap());\n\n        // Combine with update info if available\n        return match status {\n            VersionStatus::UpdateAvailable(latest) =\u003e {\n                let label = format!(\"{} -\u003e {}\", vuln_label, latest);\n                let tooltip = format!(\n                    \"{}\\n\\n---\\n**Update available:** {} -\u003e {}\",\n                    vuln_tooltip, dep.version, latest\n                );\n                (label, Some(tooltip))\n            }\n            _ =\u003e (vuln_label, Some(vuln_tooltip)),\n        };\n    }\n\n    // No vulnerabilities - show version status\n    match status {\n        VersionStatus::UpToDate =\u003e (\"✓\".to_string(), Some(\"Up to date\".to_string())),\n        VersionStatus::UpdateAvailable(latest) =\u003e {\n            let label = format!(\"-\u003e {}\", latest);\n            let tooltip = format!(\"Update available: {} -\u003e {}\", dep.version, latest);\n            (label, Some(tooltip))\n        }\n        VersionStatus::Unknown =\u003e {\n            let tooltip = format!(\n                \"**Could not fetch version info**\\n\\n\\\n                Possible causes:\\n\\\n                • Network error - check internet connection\\n\\\n                • Package not found - verify spelling\\n\\\n                • Rate limiting - wait and retry\\n\\\n                • Registry down - try again later\\n\\n\\\n                **Troubleshooting:**\\n\\\n                1. Check your network connection\\n\\\n                2. Verify the package name \\\"{}\\\" is spelled correctly\\n\\\n                3. Search for the package on the registry\\n\\\n                4. If recently published, wait a few minutes for indexing\",\n                dep.name\n            );\n            (\"? Unknown\".to_string(), Some(tooltip))\n        }\n    }\n}\n\n/// Format vulnerability details for tooltip\nfn format_vulnerability_tooltip(info: \u0026VersionInfo) -\u003e String {\n    let count = info.vulnerabilities.len();\n    let mut lines = vec![format!(\n        \"**⚠ {} {} Found**\\n\",\n        count,\n        if count == 1 {\n            \"Vulnerability\"\n        } else {\n            \"Vulnerabilities\"\n        }\n    )];\n\n    for (i, vuln) in info.vulnerabilities.iter().take(5).enumerate() {\n        let severity_icon = match vuln.severity {\n            VulnerabilitySeverity::Critical =\u003e \"⚠ CRITICAL\",\n            VulnerabilitySeverity::High =\u003e \"▲ HIGH\",\n            VulnerabilitySeverity::Medium =\u003e \"● MEDIUM\",\n            VulnerabilitySeverity::Low =\u003e \"○ LOW\",\n        };\n\n        lines.push(format!(\n            \"{}. **{}** ({})\\n   {}\",\n            i + 1,\n            vuln.id,\n            severity_icon,\n            truncate_string(\u0026vuln.description, 100)\n        ));\n\n        if let Some(url) = \u0026vuln.url {\n            lines.push(format!(\"   [View Advisory]({})\", url));\n        }\n    }\n\n    if info.vulnerabilities.len() \u003e 5 {\n        lines.push(format!(\n            \"\\n... and {} more vulnerabilities\",\n            info.vulnerabilities.len() - 5\n        ));\n    }\n\n    lines.join(\"\\n\")\n}\n\n/// Format deprecation warning for tooltip\nfn format_deprecation_tooltip(dep: \u0026Dependency, info: \u0026VersionInfo) -\u003e String {\n    let mut lines = vec![\n        format!(\n            \"**⚠ PACKAGE DEPRECATED**\\n\\nThe package \\\"{}\\\" is deprecated.\",\n            dep.name\n        ),\n        \"\".to_string(),\n        \"**Why was it deprecated?**\".to_string(),\n        \"• Superseded by a better alternative\".to_string(),\n        \"• Has unresolved critical bugs\".to_string(),\n        \"• Known security vulnerabilities\".to_string(),\n        \"• No longer maintained\".to_string(),\n        \"• Has been renamed\".to_string(),\n        \"\".to_string(),\n        \"**What should you do?**\".to_string(),\n    ];\n\n    if let Some(homepage) = \u0026info.homepage {\n        lines.push(format!(\"• Check the package homepage: {}\", homepage));\n    }\n\n    if let Some(repo) = \u0026info.repository {\n        lines.push(format!(\n            \"• View the repository for more information: {}\",\n            repo\n        ));\n    }\n\n    lines.push(\"• Search for an alternative package on the registry\".to_string());\n\n    if let Some(latest) = \u0026info.latest {\n        lines.push(format!(\n            \"• Consider the latest version: {} (may not be deprecated)\",\n            latest\n        ));\n    }\n\n    lines.join(\"\\n\")\n}\n\n/// Format yanked version warning for tooltip\nfn format_yanked_tooltip(dep: \u0026Dependency, info: \u0026VersionInfo) -\u003e String {\n    let mut lines = vec![\n        format!(\n            \"**⊘ YANKED VERSION**\\n\\nThe version \\\"{}\\\" of \\\"{}\\\" has been yanked from crates.io.\",\n            dep.version, dep.name\n        ),\n        \"\".to_string(),\n        \"**Why was it yanked?**\".to_string(),\n        \"A yanked version typically has:\".to_string(),\n        \"• Critical bugs that break functionality\".to_string(),\n        \"• Security vulnerabilities\".to_string(),\n        \"• Published by mistake\".to_string(),\n        \"• Corrupted or incomplete package\".to_string(),\n        \"\".to_string(),\n        \"**What should you do?**\".to_string(),\n    ];\n\n    if let Some(latest) = \u0026info.latest {\n        lines.push(format!(\"• Update to the latest version: {}\", latest));\n    }\n\n    if let Some(repo) = \u0026info.repository {\n        lines.push(format!(\"• Check the repository for more info: {}\", repo));\n    }\n\n    lines.push(format!(\n        \"• View on crates.io: https://crates.io/crates/{}\",\n        dep.name\n    ));\n\n    lines.join(\"\\n\")\n}\n\n/// Check if a dependency version string indicates a local/path dependency\npub fn is_local_dependency(version: \u0026str) -\u003e bool {\n    // Path-based dependencies\n    version.starts_with(\"./\")\n        || version.starts_with(\"../\")\n        || version.starts_with('/')\n        // File protocol (npm uses \"file:\" not \"file://\")\n        || version.starts_with(\"file:\")\n        // Git dependencies\n        || version.starts_with(\"git+\")\n        || version.starts_with(\"git@\")\n        || version.starts_with(\"git:\")\n        // URL-based (git repos)\n        || version.starts_with(\"https://\")\n        || version.starts_with(\"http://\")\n        // Platform shortcuts (npm/yarn)\n        || version.starts_with(\"github:\")\n        || version.starts_with(\"gitlab:\")\n        || version.starts_with(\"bitbucket:\")\n        // Yarn/pnpm workspace protocols\n        || version.starts_with(\"workspace:\")\n        || version.starts_with(\"link:\")\n        || version.starts_with(\"portal:\")\n        // npm aliases\n        || version.starts_with(\"npm:\")\n}\n\n/// Compare a dependency version with the latest available\npub fn compare_versions(current: \u0026str, info: \u0026VersionInfo) -\u003e VersionStatus {\n    let Some(latest) = \u0026info.latest else {\n        return VersionStatus::Unknown;\n    };\n\n    // Normalize versions for comparison\n    let current_normalized = normalize_version(current);\n    let latest_normalized = normalize_version(latest);\n\n    // Parse as semver for proper comparison\n    match (\n        semver::Version::parse(\u0026current_normalized),\n        semver::Version::parse(\u0026latest_normalized),\n    ) {\n        (Ok(current_ver), Ok(latest_ver)) =\u003e {\n            if current_ver \u003e= latest_ver {\n                VersionStatus::UpToDate\n            } else {\n                VersionStatus::UpdateAvailable(latest.clone())\n            }\n        }\n        _ =\u003e {\n            // Fallback to string comparison if semver parsing fails\n            if current_normalized == latest_normalized {\n                VersionStatus::UpToDate\n            } else {\n                VersionStatus::UpdateAvailable(latest.clone())\n            }\n        }\n    }\n}\n\n/// Normalize a version string for comparison\n/// Handles version specifiers like ^, ~, \u003e=, etc.\nfn normalize_version(version: \u0026str) -\u003e String {\n    let version = version.trim();\n\n    // Remove common prefixes\n    let version = version\n        .strip_prefix('^')\n        .or_else(|| version.strip_prefix('~'))\n        .or_else(|| version.strip_prefix(\"\u003e=\"))\n        .or_else(|| version.strip_prefix(\"\u003c=\"))\n        .or_else(|| version.strip_prefix('\u003e'))\n        .or_else(|| version.strip_prefix('\u003c'))\n        .or_else(|| version.strip_prefix('='))\n        .unwrap_or(version);\n\n    // Handle version ranges like \"\u003e=1.0, \u003c2.0\" - take the first part\n    let version = version.split(',').next().unwrap_or(version).trim();\n\n    // Ensure we have at least major.minor.patch\n    let parts: Vec\u003c\u0026str\u003e = version.split('.').collect();\n    match parts.len() {\n        1 =\u003e format!(\"{}.0.0\", parts[0]),\n        2 =\u003e format!(\"{}.{}.0\", parts[0], parts[1]),\n        _ =\u003e version.to_string(),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::registries::Vulnerability;\n\n    fn make_version_info(latest: \u0026str) -\u003e VersionInfo {\n        VersionInfo {\n            latest: Some(latest.to_string()),\n            ..Default::default()\n        }\n    }\n\n    fn make_test_dep(name: \u0026str, version: \u0026str) -\u003e Dependency {\n        Dependency {\n            name: name.to_string(),\n            version: version.to_string(),\n            line: 5,\n            name_start: 0,\n            name_end: name.len() as u32,\n            version_start: name.len() as u32 + 4,\n            version_end: name.len() as u32 + 4 + version.len() as u32,\n            dev: false,\n            optional: false,\n        }\n    }\n\n    #[test]\n    fn test_compare_versions_up_to_date() {\n        let info = make_version_info(\"1.0.0\");\n        assert!(matches!(\n            compare_versions(\"1.0.0\", \u0026info),\n            VersionStatus::UpToDate\n        ));\n    }\n\n    #[test]\n    fn test_compare_versions_update_available() {\n        let info = make_version_info(\"2.0.0\");\n        match compare_versions(\"1.0.0\", \u0026info) {\n            VersionStatus::UpdateAvailable(v) =\u003e assert_eq!(v, \"2.0.0\"),\n            _ =\u003e panic!(\"Expected UpdateAvailable\"),\n        }\n    }\n\n    #[test]\n    fn test_compare_versions_with_caret() {\n        let info = make_version_info(\"1.5.0\");\n        match compare_versions(\"^1.0\", \u0026info) {\n            VersionStatus::UpdateAvailable(v) =\u003e assert_eq!(v, \"1.5.0\"),\n            _ =\u003e panic!(\"Expected UpdateAvailable\"),\n        }\n    }\n\n    #[test]\n    fn test_compare_versions_with_tilde() {\n        let info = make_version_info(\"1.0.5\");\n        match compare_versions(\"~1.0.0\", \u0026info) {\n            VersionStatus::UpdateAvailable(v) =\u003e assert_eq!(v, \"1.0.5\"),\n            _ =\u003e panic!(\"Expected UpdateAvailable\"),\n        }\n    }\n\n    #[test]\n    fn test_normalize_version() {\n        assert_eq!(normalize_version(\"1.0.0\"), \"1.0.0\");\n        assert_eq!(normalize_version(\"^1.0\"), \"1.0.0\");\n        assert_eq!(normalize_version(\"~1.0.0\"), \"1.0.0\");\n        assert_eq!(normalize_version(\"\u003e=1.0, \u003c2.0\"), \"1.0.0\");\n        assert_eq!(normalize_version(\"1\"), \"1.0.0\");\n        assert_eq!(normalize_version(\"1.2\"), \"1.2.0\");\n    }\n\n    #[test]\n    fn test_create_inlay_hint_up_to_date() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = make_version_info(\"1.0.0\");\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        assert_eq!(hint.position.line, 5);\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e assert!(s.contains(\"✓\")),\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_create_inlay_hint_update_available() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = make_version_info(\"2.0.0\");\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"-\u003e\"));\n                assert!(s.contains(\"2.0.0\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_deprecated_inlay_hint() {\n        let dep = make_test_dep(\"old-dep\", \"1.0.0\");\n        let info = VersionInfo {\n            deprecated: true,\n            latest: Some(\"2.0.0\".to_string()),\n            description: Some(\"Superseded by new-package\".to_string()),\n            homepage: Some(\"https://example.com\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Deprecated\"));\n                assert!(s.contains(\"⚠\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_deprecated_with_update() {\n        let dep = make_test_dep(\"old-dep\", \"1.0.0\");\n        let info = VersionInfo {\n            deprecated: true,\n            latest: Some(\"2.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Deprecated\"));\n                assert!(s.contains(\"2.0.0\"));\n                assert!(s.contains(\"-\u003e\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_no_deprecated_warning() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            deprecated: false,\n            latest: Some(\"1.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(!s.contains(\"Deprecated\"));\n                assert!(!s.contains(\"⚠\"));\n                assert!(s.contains(\"✓\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_vulnerability_label_singular() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            latest: Some(\"1.0.0\".to_string()),\n            vulnerabilities: vec![Vulnerability {\n                id: \"CVE-2024-1234\".to_string(),\n                severity: VulnerabilitySeverity::High,\n                description: \"Test vulnerability\".to_string(),\n                url: None,\n            }],\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(\n                    s.contains(\"⚠ 1 vuln\"),\n                    \"Expected '⚠ 1 vuln' in label, got: {}\",\n                    s\n                );\n                assert!(\n                    !s.contains(\"vulns\"),\n                    \"Should use singular 'vuln', got: {}\",\n                    s\n                );\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_vulnerability_label_plural() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            latest: Some(\"1.0.0\".to_string()),\n            vulnerabilities: vec![\n                Vulnerability {\n                    id: \"CVE-2024-1234\".to_string(),\n                    severity: VulnerabilitySeverity::High,\n                    description: \"Test vulnerability 1\".to_string(),\n                    url: None,\n                },\n                Vulnerability {\n                    id: \"CVE-2024-5678\".to_string(),\n                    severity: VulnerabilitySeverity::Medium,\n                    description: \"Test vulnerability 2\".to_string(),\n                    url: None,\n                },\n            ],\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(\n                    s.contains(\"⚠ 2 vulns\"),\n                    \"Expected '⚠ 2 vulns' in label, got: {}\",\n                    s\n                );\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_vulnerability_with_update_label() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            latest: Some(\"2.0.0\".to_string()),\n            vulnerabilities: vec![\n                Vulnerability {\n                    id: \"CVE-2024-1234\".to_string(),\n                    severity: VulnerabilitySeverity::High,\n                    description: \"Test vulnerability 1\".to_string(),\n                    url: None,\n                },\n                Vulnerability {\n                    id: \"CVE-2024-5678\".to_string(),\n                    severity: VulnerabilitySeverity::Medium,\n                    description: \"Test vulnerability 2\".to_string(),\n                    url: None,\n                },\n            ],\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(\n                    s.contains(\"⚠ 2 vulns\"),\n                    \"Expected '⚠ 2 vulns' in label, got: {}\",\n                    s\n                );\n                assert!(\n                    s.contains(\"-\u003e 2.0.0\"),\n                    \"Expected '-\u003e 2.0.0' in label, got: {}\",\n                    s\n                );\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_deprecated_priority_over_vulnerabilities() {\n        let dep = make_test_dep(\"dep\", \"1.0.0\");\n        let info = VersionInfo {\n            deprecated: true,\n            latest: None,\n            vulnerabilities: vec![Vulnerability {\n                id: \"CVE-2024-1234\".to_string(),\n                severity: VulnerabilitySeverity::High,\n                description: \"Test vulnerability\".to_string(),\n                url: None,\n            }],\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Deprecated\"));\n                assert!(!s.contains(\"vuln\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_yanked_inlay_hint() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            yanked_versions: vec![\"1.0.0\".to_string()],\n            latest: Some(\"2.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Yanked\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_yanked_with_update() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            yanked_versions: vec![\"1.0.0\".to_string()],\n            latest: Some(\"2.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Yanked\"));\n                assert!(s.contains(\"2.0.0\"));\n                assert!(s.contains(\"-\u003e\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_no_yanked_warning() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            yanked_versions: vec![\"0.9.0\".to_string()],\n            latest: Some(\"1.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(!s.contains(\"Yanked\"));\n                assert!(s.contains(\"✓\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_yanked_priority_over_deprecated() {\n        let dep = make_test_dep(\"dep\", \"1.0.0\");\n        let info = VersionInfo {\n            yanked_versions: vec![\"1.0.0\".to_string()],\n            deprecated: true,\n            latest: Some(\"2.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Yanked\"));\n                assert!(!s.contains(\"Deprecated\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_yanked_priority_over_vulnerabilities() {\n        let dep = make_test_dep(\"dep\", \"1.0.0\");\n        let info = VersionInfo {\n            yanked_versions: vec![\"1.0.0\".to_string()],\n            vulnerabilities: vec![Vulnerability {\n                id: \"CVE-2024-1234\".to_string(),\n                severity: VulnerabilitySeverity::High,\n                description: \"Test vulnerability\".to_string(),\n                url: None,\n            }],\n            latest: Some(\"2.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Yanked\"));\n                assert!(!s.contains(\"⚠\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_is_local_dependency() {\n        // Path-based\n        assert!(is_local_dependency(\"./my-lib\"));\n        assert!(is_local_dependency(\"../other-lib\"));\n        assert!(is_local_dependency(\"/absolute/path\"));\n\n        // File protocol (npm style)\n        assert!(is_local_dependency(\"file:./my-local-lib\"));\n        assert!(is_local_dependency(\"file:../shared\"));\n        assert!(is_local_dependency(\"file:///absolute/path\"));\n\n        // Git dependencies\n        assert!(is_local_dependency(\"git+https://github.com/user/repo\"));\n        assert!(is_local_dependency(\"git@github.com:user/repo.git\"));\n        assert!(is_local_dependency(\"git://github.com/user/repo.git\"));\n\n        // URL-based\n        assert!(is_local_dependency(\"https://github.com/user/repo\"));\n        assert!(is_local_dependency(\"http://example.com/repo.tgz\"));\n\n        // Platform shortcuts\n        assert!(is_local_dependency(\"github:user/repo\"));\n        assert!(is_local_dependency(\"gitlab:user/repo\"));\n        assert!(is_local_dependency(\"bitbucket:user/repo\"));\n\n        // Workspace protocols\n        assert!(is_local_dependency(\"workspace:*\"));\n        assert!(is_local_dependency(\"link:./my-lib\"));\n        assert!(is_local_dependency(\"portal:./my-lib\"));\n        assert!(is_local_dependency(\"npm:lodash@^4.0.0\"));\n\n        // Not local - regular versions\n        assert!(!is_local_dependency(\"1.0.0\"));\n        assert!(!is_local_dependency(\"^1.0\"));\n        assert!(!is_local_dependency(\"~1.0.0\"));\n        assert!(!is_local_dependency(\"\u003e=1.0, \u003c2.0\"));\n        assert!(!is_local_dependency(\"*\"));\n        assert!(!is_local_dependency(\"latest\"));\n    }\n\n    #[test]\n    fn test_npm_local_deps_detection() {\n        use crate::parsers::{Parser, npm::NpmParser};\n\n        let content = r#\"{\n  \"dependencies\": {\n    \"express\": \"^4.17.0\",\n    \"my-local-lib\": \"file:./my-local-lib\",\n    \"shared-utils\": \"../shared-utils\",\n    \"git-package\": \"git+https://github.com/user/repo.git\",\n    \"github-dep\": \"github:owner/project\"\n  }\n}\"#;\n\n        let parser = NpmParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 5);\n\n        for dep in \u0026deps {\n            println!(\"Dep: {} @ '{}'\", dep.name, dep.version);\n            let is_local = is_local_dependency(\u0026dep.version);\n            println!(\"  -\u003e is_local: {}\", is_local);\n        }\n\n        let my_local = deps.iter().find(|d| d.name == \"my-local-lib\").unwrap();\n        assert!(\n            is_local_dependency(\u0026my_local.version),\n            \"file:./my-local-lib should be local, got version: '{}'\",\n            my_local.version\n        );\n\n        let shared = deps.iter().find(|d| d.name == \"shared-utils\").unwrap();\n        assert!(\n            is_local_dependency(\u0026shared.version),\n            \"../shared-utils should be local, got version: '{}'\",\n            shared.version\n        );\n\n        let git_pkg = deps.iter().find(|d| d.name == \"git-package\").unwrap();\n        assert!(\n            is_local_dependency(\u0026git_pkg.version),\n            \"git+https://... should be local, got version: '{}'\",\n            git_pkg.version\n        );\n\n        let github = deps.iter().find(|d| d.name == \"github-dep\").unwrap();\n        assert!(\n            is_local_dependency(\u0026github.version),\n            \"github:... should be local, got version: '{}'\",\n            github.version\n        );\n\n        let express = deps.iter().find(|d| d.name == \"express\").unwrap();\n        assert!(\n            !is_local_dependency(\u0026express.version),\n            \"^4.17.0 should NOT be local\"\n        );\n    }\n\n    #[test]\n    fn test_unknown_status_local_dependency() {\n        let dep = make_test_dep(\"my-local-lib\", \"./my-local-lib\");\n        let hint = create_inlay_hint(\u0026dep, None);\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(\n                    s.contains(\"→\") || s.contains(\"Local\"),\n                    \"Expected → Local in label, got: {}\",\n                    s\n                );\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n\n        if let Some(tower_lsp::lsp_types::InlayHintTooltip::String(tooltip)) = hint.tooltip {\n            assert!(tooltip.contains(\"Local Dependency\"));\n            assert!(tooltip.contains(\"my-local-lib\"));\n        } else {\n            panic!(\"Expected string tooltip\");\n        }\n    }\n\n    #[test]\n    fn test_unknown_status_network_error() {\n        let dep = make_test_dep(\"unknown-package\", \"1.0.0\");\n        let hint = create_inlay_hint(\u0026dep, None);\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"?\"), \"Expected ? in label, got: {}\", s);\n                assert!(!s.contains(\"Local\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n\n        if let Some(tower_lsp::lsp_types::InlayHintTooltip::String(tooltip)) = hint.tooltip {\n            assert!(tooltip.contains(\"Could not fetch version info\"));\n            assert!(tooltip.contains(\"unknown-package\"));\n            assert!(tooltip.contains(\"Troubleshooting\"));\n        } else {\n            panic!(\"Expected string tooltip\");\n        }\n    }\n\n    #[test]\n    fn test_unknown_status_git_dependency() {\n        let dep = make_test_dep(\"git-dep\", \"git@github.com:user/repo.git\");\n        let hint = create_inlay_hint(\u0026dep, None);\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(\n                    s.contains(\"→\") || s.contains(\"Local\"),\n                    \"Expected → Local in label, got: {}\",\n                    s\n                );\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n}\n","traces":[{"line":21,"address":[20390992,20392626,20392695],"length":1,"stats":{"Line":3}},{"line":22,"address":[20391033],"length":1,"stats":{"Line":3}},{"line":23,"address":[14146933],"length":1,"stats":{"Line":4}},{"line":24,"address":[13083722],"length":1,"stats":{"Line":5}},{"line":28,"address":[14147005,14147113],"length":1,"stats":{"Line":11}},{"line":29,"address":[14165301],"length":1,"stats":{"Line":16}},{"line":32,"address":[13530917,13530912],"length":1,"stats":{"Line":16}},{"line":34,"address":[14165472],"length":1,"stats":{"Line":6}},{"line":35,"address":[14147232],"length":1,"stats":{"Line":2}},{"line":38,"address":[13083921,13084514],"length":1,"stats":{"Line":7}},{"line":45,"address":[14147926,14148014],"length":1,"stats":{"Line":6}},{"line":48,"address":[13084899],"length":1,"stats":{"Line":5}},{"line":56,"address":[14159240,14157088,14159327],"length":1,"stats":{"Line":5}},{"line":63,"address":[14157170],"length":1,"stats":{"Line":5}},{"line":64,"address":[20401330],"length":1,"stats":{"Line":4}},{"line":75,"address":[14163505,14157418],"length":1,"stats":{"Line":8}},{"line":78,"address":[14175531,14175740,14175929],"length":1,"stats":{"Line":11}},{"line":85,"address":[13094240,13094625],"length":1,"stats":{"Line":11}},{"line":86,"address":[14158007],"length":1,"stats":{"Line":6}},{"line":88,"address":[13094712],"length":1,"stats":{"Line":4}},{"line":89,"address":[13094770,13094826],"length":1,"stats":{"Line":9}},{"line":91,"address":[14176484],"length":1,"stats":{"Line":7}},{"line":92,"address":[14158251],"length":1,"stats":{"Line":5}},{"line":93,"address":[13094905,13095239],"length":1,"stats":{"Line":12}},{"line":94,"address":[13095390,13095505],"length":1,"stats":{"Line":12}},{"line":98,"address":[13095699],"length":1,"stats":{"Line":7}},{"line":100,"address":[13094959],"length":1,"stats":{"Line":0}},{"line":105,"address":[14176322,14177647],"length":1,"stats":{"Line":11}},{"line":106,"address":[14177668],"length":1,"stats":{"Line":5}},{"line":108,"address":[13096047],"length":1,"stats":{"Line":2}},{"line":109,"address":[14177755,14177811],"length":1,"stats":{"Line":6}},{"line":112,"address":[20403577],"length":1,"stats":{"Line":5}},{"line":113,"address":[13096224],"length":1,"stats":{"Line":3}},{"line":114,"address":[13096240,13096574],"length":1,"stats":{"Line":5}},{"line":115,"address":[20404133,20404248],"length":1,"stats":{"Line":7}},{"line":119,"address":[20404442],"length":1,"stats":{"Line":3}},{"line":121,"address":[14159656],"length":1,"stats":{"Line":2}},{"line":126,"address":[13096027],"length":1,"stats":{"Line":4}},{"line":127,"address":[20406069],"length":1,"stats":{"Line":2}},{"line":130,"address":[14161959,14160732],"length":1,"stats":{"Line":5}},{"line":132,"address":[14180501,14180586],"length":1,"stats":{"Line":9}},{"line":135,"address":[14180609],"length":1,"stats":{"Line":6}},{"line":136,"address":[14180664],"length":1,"stats":{"Line":2}},{"line":137,"address":[20406434,20406768],"length":1,"stats":{"Line":4}},{"line":138,"address":[13099511,13099626],"length":1,"stats":{"Line":4}},{"line":142,"address":[14163186],"length":1,"stats":{"Line":2}},{"line":144,"address":[14162446],"length":1,"stats":{"Line":4}},{"line":149,"address":[14160752,14160671],"length":1,"stats":{"Line":4}},{"line":150,"address":[14179480,14179042],"length":1,"stats":{"Line":3}},{"line":151,"address":[13097466],"length":1,"stats":{"Line":3}},{"line":152,"address":[14179137],"length":1,"stats":{"Line":3}},{"line":153,"address":[14179700,14179273],"length":1,"stats":{"Line":6}},{"line":154,"address":[14161563],"length":1,"stats":{"Line":3}},{"line":157,"address":[13097673],"length":1,"stats":{"Line":3}},{"line":171,"address":[20405204,20405833],"length":1,"stats":{"Line":6}},{"line":177,"address":[13093693,13091488,13093699],"length":1,"stats":{"Line":6}},{"line":178,"address":[20398946],"length":1,"stats":{"Line":6}},{"line":179,"address":[14173270,14173677,14173172,14175373],"length":1,"stats":{"Line":10}},{"line":182,"address":[20398986,20399024],"length":1,"stats":{"Line":8}},{"line":183,"address":[13091589],"length":1,"stats":{"Line":2}},{"line":185,"address":[20399026],"length":1,"stats":{"Line":4}},{"line":189,"address":[14173646,14173750],"length":1,"stats":{"Line":12}},{"line":190,"address":[14155769],"length":1,"stats":{"Line":6}},{"line":191,"address":[14156282],"length":1,"stats":{"Line":0}},{"line":192,"address":[14174541],"length":1,"stats":{"Line":6}},{"line":193,"address":[14174512],"length":1,"stats":{"Line":4}},{"line":194,"address":[14174483],"length":1,"stats":{"Line":0}},{"line":197,"address":[14156438],"length":1,"stats":{"Line":6}},{"line":199,"address":[20400361,20400417],"length":1,"stats":{"Line":6}},{"line":202,"address":[14174637,14174689],"length":1,"stats":{"Line":12}},{"line":205,"address":[20400880],"length":1,"stats":{"Line":6}},{"line":206,"address":[13093534],"length":1,"stats":{"Line":0}},{"line":210,"address":[13092446],"length":1,"stats":{"Line":2}},{"line":211,"address":[14155989,14155942],"length":1,"stats":{"Line":0}},{"line":213,"address":[14155878,14155969],"length":1,"stats":{"Line":0}},{"line":217,"address":[14155838,14156139],"length":1,"stats":{"Line":12}},{"line":221,"address":[14170800,14173068,14173074],"length":1,"stats":{"Line":3}},{"line":222,"address":[14171349,14170853,14172221,14170895,14171205,14171421,14171562,14171675,14173087,14171133,14171061,14171493,14171634,14171277],"length":1,"stats":{"Line":8}},{"line":223,"address":[13089332,13089268],"length":1,"stats":{"Line":8}},{"line":227,"address":[14171033],"length":1,"stats":{"Line":4}},{"line":228,"address":[14152814],"length":1,"stats":{"Line":5}},{"line":229,"address":[13089570],"length":1,"stats":{"Line":4}},{"line":230,"address":[13089642],"length":1,"stats":{"Line":5}},{"line":231,"address":[14171318],"length":1,"stats":{"Line":4}},{"line":232,"address":[20397194],"length":1,"stats":{"Line":5}},{"line":233,"address":[14171462],"length":1,"stats":{"Line":4}},{"line":234,"address":[14171534],"length":1,"stats":{"Line":5}},{"line":235,"address":[14171603],"length":1,"stats":{"Line":4}},{"line":238,"address":[13090564,13090634],"length":1,"stats":{"Line":6}},{"line":239,"address":[14153967,14154099],"length":1,"stats":{"Line":4}},{"line":242,"address":[14154233,14153999],"length":1,"stats":{"Line":3}},{"line":243,"address":[14172598,14172537],"length":1,"stats":{"Line":0}},{"line":249,"address":[14154276,14154439],"length":1,"stats":{"Line":6}},{"line":251,"address":[13091151],"length":1,"stats":{"Line":4}},{"line":252,"address":[14154534,14154589],"length":1,"stats":{"Line":6}},{"line":258,"address":[20398824,20398653],"length":1,"stats":{"Line":4}},{"line":262,"address":[14150288,14152488,14152482],"length":1,"stats":{"Line":3}},{"line":263,"address":[20396593,20395131,20394771,20394699,20395059,20394915,20395272,20394437,20394502,20394843,20394987,20395200,20395313,20395854],"length":1,"stats":{"Line":9}},{"line":264,"address":[13087131,13087047],"length":1,"stats":{"Line":7}},{"line":268,"address":[14168867],"length":1,"stats":{"Line":3}},{"line":269,"address":[14168936],"length":1,"stats":{"Line":5}},{"line":270,"address":[14169008],"length":1,"stats":{"Line":3}},{"line":271,"address":[14169080],"length":1,"stats":{"Line":5}},{"line":272,"address":[20394956],"length":1,"stats":{"Line":3}},{"line":273,"address":[20395028],"length":1,"stats":{"Line":5}},{"line":274,"address":[14151008],"length":1,"stats":{"Line":3}},{"line":275,"address":[20395172],"length":1,"stats":{"Line":5}},{"line":276,"address":[14169437],"length":1,"stats":{"Line":3}},{"line":279,"address":[14151780,14151715],"length":1,"stats":{"Line":10}},{"line":280,"address":[14151796,14151928],"length":1,"stats":{"Line":10}},{"line":283,"address":[20396154,20395920],"length":1,"stats":{"Line":5}},{"line":284,"address":[13088823,13088761],"length":1,"stats":{"Line":0}},{"line":287,"address":[14170398,14170557],"length":1,"stats":{"Line":12}},{"line":292,"address":[20396485],"length":1,"stats":{"Line":7}},{"line":296,"address":[20393808],"length":1,"stats":{"Line":3}},{"line":298,"address":[14168078,14168023],"length":1,"stats":{"Line":6}},{"line":299,"address":[14149766],"length":1,"stats":{"Line":5}},{"line":300,"address":[13086497],"length":1,"stats":{"Line":5}},{"line":302,"address":[14168121],"length":1,"stats":{"Line":5}},{"line":304,"address":[13086552],"length":1,"stats":{"Line":5}},{"line":305,"address":[14168183],"length":1,"stats":{"Line":6}},{"line":306,"address":[20394022],"length":1,"stats":{"Line":6}},{"line":308,"address":[13086649],"length":1,"stats":{"Line":6}},{"line":309,"address":[14149996],"length":1,"stats":{"Line":6}},{"line":311,"address":[20394127],"length":1,"stats":{"Line":6}},{"line":312,"address":[13086754],"length":1,"stats":{"Line":6}},{"line":313,"address":[14150101],"length":1,"stats":{"Line":6}},{"line":315,"address":[13086824],"length":1,"stats":{"Line":6}},{"line":316,"address":[13086859],"length":1,"stats":{"Line":6}},{"line":317,"address":[20394302],"length":1,"stats":{"Line":5}},{"line":319,"address":[13086929],"length":1,"stats":{"Line":6}},{"line":323,"address":[14164673,14165122,14163600],"length":1,"stats":{"Line":7}},{"line":324,"address":[14145376],"length":1,"stats":{"Line":3}},{"line":325,"address":[14145497],"length":1,"stats":{"Line":2}},{"line":329,"address":[14163753],"length":1,"stats":{"Line":7}},{"line":330,"address":[14163862,14163763],"length":1,"stats":{"Line":22}},{"line":333,"address":[14164186,14164056],"length":1,"stats":{"Line":19}},{"line":334,"address":[14163874,14163942],"length":1,"stats":{"Line":20}},{"line":335,"address":[14163969,14164037],"length":1,"stats":{"Line":25}},{"line":337,"address":[14145929],"length":1,"stats":{"Line":14}},{"line":338,"address":[13082773,13082852,13082900],"length":1,"stats":{"Line":23}},{"line":339,"address":[14146155],"length":1,"stats":{"Line":4}},{"line":341,"address":[14146175,14146131],"length":1,"stats":{"Line":20}},{"line":346,"address":[13083175,13083217,13083127,13082616],"length":1,"stats":{"Line":0}},{"line":347,"address":[13083162],"length":1,"stats":{"Line":0}},{"line":349,"address":[14164738,14164694],"length":1,"stats":{"Line":0}},{"line":357,"address":[13085312,13086386,13086380],"length":1,"stats":{"Line":3}},{"line":358,"address":[14148651],"length":1,"stats":{"Line":7}},{"line":363,"address":[12949424,12949438],"length":1,"stats":{"Line":13}},{"line":364,"address":[15959392,15959406],"length":1,"stats":{"Line":17}},{"line":365,"address":[15959454,15959440],"length":1,"stats":{"Line":13}},{"line":366,"address":[14148793],"length":1,"stats":{"Line":18}},{"line":367,"address":[14148818],"length":1,"stats":{"Line":22}},{"line":368,"address":[14148843],"length":1,"stats":{"Line":33}},{"line":369,"address":[14148868],"length":1,"stats":{"Line":9}},{"line":372,"address":[14148911],"length":1,"stats":{"Line":12}},{"line":375,"address":[13085751],"length":1,"stats":{"Line":9}},{"line":376,"address":[13085865,13085794],"length":1,"stats":{"Line":21}},{"line":377,"address":[14149225,14149303],"length":1,"stats":{"Line":4}},{"line":378,"address":[14149260,14149456],"length":1,"stats":{"Line":4}},{"line":379,"address":[14149211,14149679],"length":1,"stats":{"Line":22}}],"covered":150,"coverable":161},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","providers","mod.rs"],"content":"//! LSP feature providers (inlay hints, diagnostics, hover, etc.)\n\npub mod code_actions;\npub mod completion;\npub mod diagnostics;\npub mod inlay_hints;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","crates_io.rs"],"content":"//! # crates.io Registry Client\n//!\n//! This module implements a client for the [crates.io](https://crates.io) registry,\n//! the official Rust package registry managed by the Rust Foundation.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://crates.io/api/v1`\n//! - **API Version**: v1 (stable)\n//!\n//! ## Rate Limiting\n//!\n//! The crates.io API enforces **strict rate limits** to protect the service.\n//! This client implements a built-in rate limiter that enforces **1 request per second**.\n//!\n//! **Exceeding the rate limit may result in IP-based blocking.**\n//!\n//! ## API Endpoints Used\n//!\n//! ### Fetch Crate Info\n//!\n//! - **Endpoint**: `GET /api/v1/crates/{crate_name}`\n//! - **Response**: JSON containing crate metadata and all versions\n//! - **Fields**:\n//!   - `crate.max_stable_version`: Latest stable release\n//!   - `crate.description`: Package description\n//!   - `crate.homepage`: Optional homepage URL\n//!   - `crate.repository`: Optional repository URL\n//!   - `versions[]`: Array of all published versions\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: Semver with optional pre-release tags (`-alpha`, `-beta`, `-rc`)\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00Z`)\n//! - **Yanked versions**: Marked with `yanked: true` in versions array\n//! - **License**: Per-version field (SPDX expression)\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Name normalization**: Underscores and hyphens are equivalent (`foo-bar` = `foo_bar`)\n//! - **Case sensitivity**: Names are case-insensitive but stored lowercase\n//! - **404 responses**: Returned for both \"not found\" and \"private crates\"\n//! - **Yanked versions**: Still available but marked; users are warned\n//! - **Features**: `features` field lists Cargo feature flags (not exposed by this client)\n//!\n//! ## Error Handling\n//!\n//! - **Rate limiting**: Client-side enforcement (1 req/s)\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: Non-success status codes return an error\n//!\n//! ## External References\n//!\n//! - [crates.io Data Access](https://crates.io/data-access)\n//! - [crates.io Policies](https://crates.io/policies)\n//! - [Crate Metadata Schema](https://doc.rust-lang.org/cargo/reference/registry-index.html)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\nuse std::time::{Duration, Instant};\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\nuse tokio::sync::Mutex;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_rust;\nuse super::{Registry, VersionInfo};\n\n/// Rate limiter to respect crates.io's 1 request/second limit\nstruct RateLimiter {\n    last_request: Instant,\n    min_interval: Duration,\n}\n\nimpl RateLimiter {\n    fn new(requests_per_second: f64) -\u003e Self {\n        Self {\n            last_request: Instant::now() - Duration::from_secs(10),\n            min_interval: Duration::from_secs_f64(1.0 / requests_per_second),\n        }\n    }\n\n    async fn wait(\u0026mut self) {\n        let elapsed = self.last_request.elapsed();\n        if elapsed \u003c self.min_interval {\n            tokio::time::sleep(self.min_interval - elapsed).await;\n        }\n        self.last_request = Instant::now();\n    }\n}\n\n/// Client for the crates.io registry\npub struct CratesIoRegistry {\n    client: Arc\u003cClient\u003e,\n    rate_limiter: Arc\u003cMutex\u003cRateLimiter\u003e\u003e,\n    base_url: String,\n}\n\nimpl CratesIoRegistry {\n    /// Creates a CratesIoRegistry that uses the provided shared HTTP client.\n    ///\n    /// The registry will use the given `client` for all HTTP requests, enforce a\n    /// default rate limit of 1 request per second, and target the crates.io API\n    /// base URL.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::crates_io::CratesIoRegistry;\n    /// use dependi_lsp::registries::http_client::create_shared_client;\n    ///\n    /// let client = create_shared_client().expect(\"failed to create client\");\n    /// let registry = CratesIoRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            rate_limiter: Arc::new(Mutex::new(RateLimiter::new(1.0))),\n            base_url: \"https://crates.io/api/v1\".to_string(),\n        }\n    }\n}\n\nimpl Default for CratesIoRegistry {\n    /// Creates a `CratesIoRegistry` configured with a shared HTTP client and default rate limiting.\n    ///\n    /// The registry is initialized with a shared `reqwest::Client`, a 1 request/second rate limiter,\n    /// and the default crates.io API base URL.\n    ///\n    /// # Panics\n    ///\n    /// This function will panic if creating the shared HTTP client fails.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::crates_io::CratesIoRegistry;\n    ///\n    /// let _registry = CratesIoRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// API response structures\n#[derive(Debug, Deserialize)]\nstruct CrateResponse {\n    #[serde(rename = \"crate\")]\n    crate_info: CrateInfo,\n    versions: Vec\u003cVersionEntry\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct CrateInfo {\n    description: Option\u003cString\u003e,\n    homepage: Option\u003cString\u003e,\n    repository: Option\u003cString\u003e,\n    max_stable_version: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct VersionEntry {\n    num: String,\n    yanked: bool,\n    license: Option\u003cString\u003e,\n    created_at: Option\u003cString\u003e,\n}\n\nimpl Registry for CratesIoRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // Rate limiting\n        {\n            let mut limiter = self.rate_limiter.lock().await;\n            limiter.wait().await;\n        }\n\n        let url = format!(\"{}/crates/{}\", self.base_url, package_name);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch crate info for {}: {}\",\n                package_name,\n                response.status()\n            );\n        }\n\n        let crate_response: CrateResponse = response.json().await?;\n\n        // Find latest stable version (not yanked, no prerelease)\n        let latest_stable = crate_response\n            .crate_info\n            .max_stable_version\n            .clone()\n            .or_else(|| {\n                crate_response\n                    .versions\n                    .iter()\n                    .find(|v| !v.yanked \u0026\u0026 !is_prerelease_rust(\u0026v.num))\n                    .map(|v| v.num.clone())\n            });\n\n        // Find latest prerelease\n        let latest_prerelease = crate_response\n            .versions\n            .iter()\n            .find(|v| !v.yanked \u0026\u0026 is_prerelease_rust(\u0026v.num))\n            .map(|v| v.num.clone());\n\n        // Get all versions (not yanked)\n        let versions: Vec\u003cString\u003e = crate_response\n            .versions\n            .iter()\n            .filter(|v| !v.yanked)\n            .map(|v| v.num.clone())\n            .collect();\n\n        // Get license from latest version\n        let license = crate_response\n            .versions\n            .first()\n            .and_then(|v| v.license.clone());\n\n        // Collect all yanked versions\n        let yanked_versions: Vec\u003cString\u003e = crate_response\n            .versions\n            .iter()\n            .filter(|v| v.yanked)\n            .map(|v| v.num.clone())\n            .collect();\n\n        // Collect release dates for all versions\n        let release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = crate_response\n            .versions\n            .iter()\n            .filter_map(|v| {\n                v.created_at.as_ref().and_then(|date_str| {\n                    DateTime::parse_from_rfc3339(date_str)\n                        .ok()\n                        .map(|dt| (v.num.clone(), dt.with_timezone(\u0026Utc)))\n                })\n            })\n            .collect();\n\n        // Check if latest version is yanked (kept for backwards compatibility)\n        let yanked = crate_response.versions.first().is_some_and(|v| v.yanked);\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease,\n            versions,\n            description: crate_response.crate_info.description,\n            homepage: crate_response.crate_info.homepage,\n            repository: crate_response.crate_info.repository,\n            license,\n            vulnerabilities: vec![], // Filled by OSV\n            deprecated: false,       // Filled by OSV\n            yanked,\n            yanked_versions,\n            release_dates,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_rust(\"1.0.0-alpha\"));\n        assert!(is_prerelease_rust(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_rust(\"1.0.0-rc1\"));\n        assert!(!is_prerelease_rust(\"1.0.0\"));\n        assert!(!is_prerelease_rust(\"2.3.4\"));\n    }\n}\n","traces":[{"line":78,"address":[14044144],"length":1,"stats":{"Line":3}},{"line":80,"address":[14062458],"length":1,"stats":{"Line":3}},{"line":81,"address":[14062523],"length":1,"stats":{"Line":3}},{"line":85,"address":[15034792,15034784],"length":1,"stats":{"Line":0}},{"line":86,"address":[14024552,14024688],"length":1,"stats":{"Line":0}},{"line":87,"address":[13344758],"length":1,"stats":{"Line":0}},{"line":88,"address":[19725044,19725194,19725363],"length":1,"stats":{"Line":0}},{"line":90,"address":[13345161,13344798],"length":1,"stats":{"Line":0}},{"line":118,"address":[15035093,15035099,15034816],"length":1,"stats":{"Line":3}},{"line":121,"address":[15034859,15034903],"length":1,"stats":{"Line":6}},{"line":122,"address":[15034954],"length":1,"stats":{"Line":3}},{"line":144,"address":[14064000],"length":1,"stats":{"Line":2}},{"line":145,"address":[14064014],"length":1,"stats":{"Line":2}},{"line":174,"address":[14044064],"length":1,"stats":{"Line":2}},{"line":175,"address":[14044069],"length":1,"stats":{"Line":2}},{"line":178,"address":[19718196,19717936,19717998,19718153,19718409,19718217,19718819,19718238,19718267],"length":1,"stats":{"Line":0}},{"line":181,"address":[12494415],"length":1,"stats":{"Line":0}},{"line":182,"address":[12494430],"length":1,"stats":{"Line":0}},{"line":185,"address":[13338662],"length":1,"stats":{"Line":0}},{"line":187,"address":[19719475,19718225,19719315,19719224,19720521],"length":1,"stats":{"Line":0}},{"line":189,"address":[14019352,14019284],"length":1,"stats":{"Line":0}},{"line":190,"address":[14019522],"length":1,"stats":{"Line":0}},{"line":197,"address":[12752235],"length":1,"stats":{"Line":0}},{"line":204,"address":[14039048,14042112],"length":1,"stats":{"Line":0}},{"line":205,"address":[14042144],"length":1,"stats":{"Line":0}},{"line":207,"address":[19724027],"length":1,"stats":{"Line":0}},{"line":208,"address":[19724042,19724387,19724368],"length":1,"stats":{"Line":0}},{"line":209,"address":[19724576,19724060,19724560],"length":1,"stats":{"Line":0}},{"line":213,"address":[13341003,13341130],"length":1,"stats":{"Line":0}},{"line":216,"address":[19724275,19724256,19721522],"length":1,"stats":{"Line":0}},{"line":217,"address":[19724224,19724240,19721553],"length":1,"stats":{"Line":0}},{"line":220,"address":[13341208],"length":1,"stats":{"Line":0}},{"line":223,"address":[14021167,14023392,14023402],"length":1,"stats":{"Line":0}},{"line":224,"address":[14023680,14023715,14021210],"length":1,"stats":{"Line":0}},{"line":228,"address":[14021280],"length":1,"stats":{"Line":0}},{"line":231,"address":[14039695,14042032,14042048],"length":1,"stats":{"Line":0}},{"line":234,"address":[19721954],"length":1,"stats":{"Line":0}},{"line":237,"address":[19724090,19722067,19724080],"length":1,"stats":{"Line":0}},{"line":238,"address":[14023459,14021594,14023424],"length":1,"stats":{"Line":0}},{"line":242,"address":[14039932],"length":1,"stats":{"Line":0}},{"line":245,"address":[14040046,14041856],"length":1,"stats":{"Line":0}},{"line":246,"address":[14042256,14041892],"length":1,"stats":{"Line":0}},{"line":247,"address":[13344042],"length":1,"stats":{"Line":0}},{"line":248,"address":[14024029],"length":1,"stats":{"Line":0}},{"line":249,"address":[14042343,14042448,14042471],"length":1,"stats":{"Line":0}},{"line":255,"address":[14042208,14040179,14042213,14040096],"length":1,"stats":{"Line":0}},{"line":257,"address":[13342455],"length":1,"stats":{"Line":0}},{"line":258,"address":[14040228],"length":1,"stats":{"Line":0}},{"line":259,"address":[14040268],"length":1,"stats":{"Line":0}},{"line":260,"address":[19722480],"length":1,"stats":{"Line":0}},{"line":261,"address":[13342152],"length":1,"stats":{"Line":0}},{"line":262,"address":[14040388],"length":1,"stats":{"Line":0}},{"line":263,"address":[14040428],"length":1,"stats":{"Line":0}},{"line":264,"address":[14040468],"length":1,"stats":{"Line":0}},{"line":265,"address":[14022220],"length":1,"stats":{"Line":0}},{"line":268,"address":[14022287],"length":1,"stats":{"Line":0}},{"line":269,"address":[14022319],"length":1,"stats":{"Line":0}}],"covered":10,"coverable":57},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","go_proxy.rs"],"content":"//! # Go Module Proxy Client\n//!\n//! This module implements a client for the [Go Module Proxy](https://proxy.golang.org),\n//! the official module mirror and checksum database for Go modules.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://proxy.golang.org`\n//! - **API Version**: Module Proxy Protocol (stable)\n//! - **Authentication**: Not required for public modules\n//! - **GOPROXY**: Supports custom proxy URLs via environment variable\n//!\n//! ## Rate Limiting\n//!\n//! The Go proxy does not publish official rate limits but implements:\n//!\n//! - **Fair use policy**: No hard limits for normal usage\n//! - **CDN caching**: Most requests are served from cache\n//! - **Best practice**: Respect cache headers\n//!\n//! ## API Endpoints Used\n//!\n//! ### List Versions\n//!\n//! - **Endpoint**: `GET /{module}/@v/list`\n//! - **Response**: Plain text, one version per line\n//! - **Example**: `v1.0.0\\nv1.0.1\\nv1.1.0`\n//!\n//! ### Get Latest Version\n//!\n//! - **Endpoint**: `GET /{module}/@latest`\n//! - **Response**: JSON with version and timestamp\n//! - **Fields**:\n//!   - `Version`: Version string (e.g., `v1.2.3`)\n//!   - `Time`: RFC 3339 timestamp\n//!\n//! ### Get Version Info\n//!\n//! - **Endpoint**: `GET /{module}/@v/{version}.info`\n//! - **Response**: JSON with version metadata\n//! - **Fields**:\n//!   - `Version`: Canonical version string\n//!   - `Time`: RFC 3339 release timestamp\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: Semver with `v` prefix required (`v1.0.0`, `v2.0.0-rc1`)\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00Z`)\n//! - **Module paths**: May contain version suffix for v2+ (`/v2`, `/v3`)\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Module path encoding**: Uppercase letters become `!` + lowercase\n//!   (`github.com/Azure/sdk` → `github.com/!azure/sdk`)\n//! - **Major version suffixes**: v2+ modules have path suffix (`module/v2`)\n//! - **Pseudo-versions**: Auto-generated for commits without tags\n//!   (`v0.0.0-20210101000000-abcdef123456`)\n//! - **Private modules**: Not available on public proxy; require `GOPRIVATE`\n//! - **Checksum database**: `sum.golang.org` verifies module integrity\n//! - **Retracted versions**: Marked in `go.mod` but still listed\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found, 410 for gone/retracted\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [Go Module Proxy Protocol](https://go.dev/ref/mod#module-proxy)\n//! - [Module Version Numbering](https://go.dev/ref/mod#versions)\n//! - [Checksum Database](https://sum.golang.org/)\n//! - [GOPROXY Environment Variable](https://go.dev/ref/mod#environment-variables)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_go;\nuse super::{Registry, VersionInfo};\n\n/// Client for the Go module proxy\npub struct GoProxyRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl GoProxyRegistry {\n    /// Creates a GoProxyRegistry that uses the provided shared HTTP client and the default Go proxy base URL.\n    ///\n    /// `client` is the shared `reqwest::Client` used for all outgoing HTTP requests to the Go proxy.\n    /// The returned registry is configured with `base_url` set to `https://proxy.golang.org`.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::go_proxy::GoProxyRegistry;\n    ///\n    /// let client = Arc::new(reqwest::Client::new());\n    /// let _registry = GoProxyRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://proxy.golang.org\".to_string(),\n        }\n    }\n}\n\nimpl Default for GoProxyRegistry {\n    /// Creates a GoProxyRegistry configured with a shared HTTP client.\n    ///\n    /// The registry's HTTP client is produced by `create_shared_client`.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::go_proxy::GoProxyRegistry;\n    ///\n    /// let registry = GoProxyRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// Go proxy API response for version info\n#[derive(Debug, Deserialize)]\nstruct VersionInfoResponse {\n    #[serde(rename = \"Version\")]\n    version: String,\n    #[serde(rename = \"Time\")]\n    time: Option\u003cString\u003e,\n}\n\nimpl Registry for GoProxyRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, module_path: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // Encode module path for URL\n        // Go proxy requires case-encoding: uppercase letters become ! followed by lowercase\n        let encoded_path = encode_module_path(module_path);\n\n        // Fetch list of versions\n        let versions = self.fetch_versions(\u0026encoded_path).await.unwrap_or_default();\n\n        // Fetch latest version info\n        let latest = self.fetch_latest(\u0026encoded_path).await.ok();\n\n        // Sort versions in descending order\n        let mut sorted_versions = versions.clone();\n        sorted_versions.sort_by(|a, b| compare_go_versions(b, a));\n\n        // Find latest stable version (no prerelease suffix)\n        let latest_stable = latest.as_ref().map(|l| l.version.clone()).or_else(|| {\n            sorted_versions\n                .iter()\n                .find(|v| !is_prerelease_go(v))\n                .cloned()\n        });\n\n        // Find latest prerelease\n        let latest_prerelease = sorted_versions\n            .iter()\n            .find(|v| is_prerelease_go(v))\n            .cloned();\n\n        // Build repository URL for common hosts\n        let repository =\n            if module_path.starts_with(\"github.com/\") || module_path.starts_with(\"gitlab.com/\") {\n                Some(format!(\"https://{}\", module_path))\n            } else {\n                None\n            };\n\n        // Fetch release dates for versions (fetch info for each version in parallel)\n        let release_dates = self\n            .fetch_version_times(\u0026encoded_path, \u0026sorted_versions)\n            .await;\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease,\n            versions: sorted_versions,\n            description: None, // Go proxy doesn't provide descriptions\n            homepage: None,\n            repository,\n            license: None,           // Would need to fetch go.mod or LICENSE file\n            vulnerabilities: vec![], // TODO: Integrate vuln.go.dev\n            deprecated: false,\n            yanked: false,\n            yanked_versions: vec![], // Not applicable to Go\n            release_dates,\n        })\n    }\n}\n\nimpl GoProxyRegistry {\n    /// Fetch list of available versions\n    async fn fetch_versions(\u0026self, encoded_path: \u0026str) -\u003e anyhow::Result\u003cVec\u003cString\u003e\u003e {\n        let url = format!(\"{}/{}/@v/list\", self.base_url, encoded_path);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch versions for {}: {}\",\n                encoded_path,\n                response.status()\n            );\n        }\n\n        let text = response.text().await?;\n        let versions: Vec\u003cString\u003e = text.lines().map(|s| s.trim().to_string()).collect();\n\n        Ok(versions)\n    }\n\n    /// Fetch latest version info\n    async fn fetch_latest(\u0026self, encoded_path: \u0026str) -\u003e anyhow::Result\u003cVersionInfoResponse\u003e {\n        let url = format!(\"{}/{}/@latest\", self.base_url, encoded_path);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch latest for {}: {}\",\n                encoded_path,\n                response.status()\n            );\n        }\n\n        let info: VersionInfoResponse = response.json().await?;\n        Ok(info)\n    }\n\n    /// Fetch version info for a specific version\n    async fn fetch_version_info(\n        \u0026self,\n        encoded_path: \u0026str,\n        version: \u0026str,\n    ) -\u003e Option\u003cVersionInfoResponse\u003e {\n        let url = format!(\"{}/{}/@v/{}.info\", self.base_url, encoded_path, version);\n\n        let response = self.client.get(\u0026url).send().await.ok()?;\n\n        if !response.status().is_success() {\n            return None;\n        }\n\n        response.json().await.ok()\n    }\n\n    /// Fetch release times for a list of versions (limited to first 10 for performance)\n    async fn fetch_version_times(\n        \u0026self,\n        encoded_path: \u0026str,\n        versions: \u0026[String],\n    ) -\u003e HashMap\u003cString, DateTime\u003cUtc\u003e\u003e {\n        use futures::future::join_all;\n\n        let futures: Vec\u003c_\u003e = versions\n            .iter()\n            .take(10)\n            .map(|v| async move {\n                self.fetch_version_info(encoded_path, v)\n                    .await\n                    .and_then(|info| {\n                        info.time.as_ref().and_then(|time_str| {\n                            DateTime::parse_from_rfc3339(time_str)\n                                .ok()\n                                .map(|dt| (v.clone(), dt.with_timezone(\u0026Utc)))\n                        })\n                    })\n            })\n            .collect();\n\n        let results = join_all(futures).await;\n        results.into_iter().flatten().collect()\n    }\n}\n\n/// Encode module path for Go proxy URL\n/// Uppercase letters are replaced with ! followed by lowercase\nfn encode_module_path(path: \u0026str) -\u003e String {\n    let mut result = String::with_capacity(path.len() * 2);\n\n    for ch in path.chars() {\n        if ch.is_ascii_uppercase() {\n            result.push('!');\n            result.push(ch.to_ascii_lowercase());\n        } else {\n            result.push(ch);\n        }\n    }\n\n    result\n}\n\n/// Compare Go versions for sorting\nfn compare_go_versions(a: \u0026str, b: \u0026str) -\u003e std::cmp::Ordering {\n    // Strip 'v' prefix if present\n    let a_stripped = a.strip_prefix('v').unwrap_or(a);\n    let b_stripped = b.strip_prefix('v').unwrap_or(b);\n\n    // Try parsing as semver\n    match (\n        semver::Version::parse(a_stripped),\n        semver::Version::parse(b_stripped),\n    ) {\n        (Ok(va), Ok(vb)) =\u003e va.cmp(\u0026vb),\n        _ =\u003e {\n            // Fallback to string comparison\n            compare_version_strings(a_stripped, b_stripped)\n        }\n    }\n}\n\n/// Simple version string comparison\nfn compare_version_strings(a: \u0026str, b: \u0026str) -\u003e std::cmp::Ordering {\n    let parse_parts = |s: \u0026str| -\u003e Vec\u003cu64\u003e {\n        s.split(|c: char| !c.is_ascii_digit())\n            .filter_map(|p| p.parse().ok())\n            .collect()\n    };\n\n    let parts_a = parse_parts(a);\n    let parts_b = parse_parts(b);\n\n    for (pa, pb) in parts_a.iter().zip(parts_b.iter()) {\n        match pa.cmp(pb) {\n            std::cmp::Ordering::Equal =\u003e continue,\n            other =\u003e return other,\n        }\n    }\n\n    parts_a.len().cmp(\u0026parts_b.len())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_encode_module_path() {\n        assert_eq!(\n            encode_module_path(\"github.com/Azure/azure-sdk-for-go\"),\n            \"github.com/!azure/azure-sdk-for-go\"\n        );\n        assert_eq!(\n            encode_module_path(\"github.com/gin-gonic/gin\"),\n            \"github.com/gin-gonic/gin\"\n        );\n        assert_eq!(encode_module_path(\"golang.org/x/text\"), \"golang.org/x/text\");\n    }\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_go(\"v1.0.0-rc1\"));\n        assert!(is_prerelease_go(\"v2.0.0-beta.1\"));\n        assert!(is_prerelease_go(\"v3.0.0-alpha\"));\n        assert!(!is_prerelease_go(\"v1.0.0\"));\n        assert!(!is_prerelease_go(\"v2.3.4\"));\n    }\n\n    #[test]\n    fn test_compare_go_versions() {\n        use std::cmp::Ordering;\n\n        assert_eq!(compare_go_versions(\"v1.0.0\", \"v2.0.0\"), Ordering::Less);\n        assert_eq!(compare_go_versions(\"v2.0.0\", \"v1.0.0\"), Ordering::Greater);\n        assert_eq!(compare_go_versions(\"v1.0.0\", \"v1.0.0\"), Ordering::Equal);\n        assert_eq!(compare_go_versions(\"v1.10.0\", \"v1.9.0\"), Ordering::Greater);\n    }\n}\n","traces":[{"line":107,"address":[14336394,14336256,14336388],"length":1,"stats":{"Line":2}},{"line":110,"address":[20350199],"length":1,"stats":{"Line":2}},{"line":127,"address":[13009344],"length":1,"stats":{"Line":0}},{"line":128,"address":[14339518],"length":1,"stats":{"Line":0}},{"line":142,"address":[13006080],"length":1,"stats":{"Line":2}},{"line":143,"address":[14336181],"length":1,"stats":{"Line":2}},{"line":146,"address":[14496247,14496297,14497066,14496204,14496559,14496032,14496094,14496268],"length":1,"stats":{"Line":0}},{"line":149,"address":[14496179],"length":1,"stats":{"Line":0}},{"line":152,"address":[12492815],"length":1,"stats":{"Line":0}},{"line":155,"address":[12492830],"length":1,"stats":{"Line":0}},{"line":158,"address":[13108895,13108814],"length":1,"stats":{"Line":0}},{"line":159,"address":[20357043,20357132,20359520,20359557],"length":1,"stats":{"Line":0}},{"line":162,"address":[20357147,20359616,20359632,20359648,20357215],"length":1,"stats":{"Line":0}},{"line":163,"address":[14471120],"length":1,"stats":{"Line":0}},{"line":164,"address":[14500060],"length":1,"stats":{"Line":0}},{"line":165,"address":[20359708,20359744,20359758],"length":1,"stats":{"Line":0}},{"line":166,"address":[13111502],"length":1,"stats":{"Line":0}},{"line":170,"address":[14497684,14497852,14497799],"length":1,"stats":{"Line":0}},{"line":172,"address":[20357407,20359486,20359472],"length":1,"stats":{"Line":0}},{"line":176,"address":[14498289,14497969,14497882,14498056],"length":1,"stats":{"Line":0}},{"line":178,"address":[14498132,14498025],"length":1,"stats":{"Line":0}},{"line":180,"address":[13109502],"length":1,"stats":{"Line":0}},{"line":184,"address":[14498471,14498698,14498099],"length":1,"stats":{"Line":0}},{"line":185,"address":[13109799,13109540],"length":1,"stats":{"Line":0}},{"line":186,"address":[14498436,14496276,14498535,14498794,14498504],"length":1,"stats":{"Line":0}},{"line":188,"address":[14499155],"length":1,"stats":{"Line":0}},{"line":189,"address":[14498820],"length":1,"stats":{"Line":0}},{"line":190,"address":[13110262],"length":1,"stats":{"Line":0}},{"line":191,"address":[14498888],"length":1,"stats":{"Line":0}},{"line":192,"address":[13110334],"length":1,"stats":{"Line":0}},{"line":193,"address":[20358486],"length":1,"stats":{"Line":0}},{"line":194,"address":[13110350],"length":1,"stats":{"Line":0}},{"line":195,"address":[14498976],"length":1,"stats":{"Line":0}},{"line":196,"address":[14470056],"length":1,"stats":{"Line":0}},{"line":199,"address":[14499047],"length":1,"stats":{"Line":0}},{"line":200,"address":[14499107],"length":1,"stats":{"Line":0}},{"line":207,"address":[13006336,13006354],"length":1,"stats":{"Line":0}},{"line":208,"address":[13114036,13114190],"length":1,"stats":{"Line":0}},{"line":210,"address":[15215679],"length":1,"stats":{"Line":0}},{"line":212,"address":[14503661,14503723],"length":1,"stats":{"Line":0}},{"line":213,"address":[13115072,13115171],"length":1,"stats":{"Line":0}},{"line":220,"address":[14473866,14476032,14474864,14475208,14475345],"length":1,"stats":{"Line":0}},{"line":221,"address":[14505024,14504750,14504673,14505077],"length":1,"stats":{"Line":0}},{"line":223,"address":[14504811],"length":1,"stats":{"Line":0}},{"line":227,"address":[20360004,20360473,20359840,20361470,20360076,20359887,20360047],"length":1,"stats":{"Line":0}},{"line":228,"address":[14471659,14471505],"length":1,"stats":{"Line":0}},{"line":230,"address":[13113294,13112123,13111890,13112204,13112363],"length":1,"stats":{"Line":0}},{"line":232,"address":[13112745,13112807],"length":1,"stats":{"Line":0}},{"line":233,"address":[14501583,14501484],"length":1,"stats":{"Line":0}},{"line":240,"address":[14500519,14501508,14501852,14501988,14502508],"length":1,"stats":{"Line":0}},{"line":241,"address":[13113719],"length":1,"stats":{"Line":0}},{"line":245,"address":[14336512],"length":1,"stats":{"Line":0}},{"line":250,"address":[20364674,20364833],"length":1,"stats":{"Line":0}},{"line":252,"address":[13117773,13117106,13116956,13116611,13116881],"length":1,"stats":{"Line":0}},{"line":254,"address":[20365623,20365682],"length":1,"stats":{"Line":0}},{"line":255,"address":[14477426],"length":1,"stats":{"Line":0}},{"line":258,"address":[12471157],"length":1,"stats":{"Line":0}},{"line":262,"address":[14336576],"length":1,"stats":{"Line":0}},{"line":272,"address":[14507811,14508431,14508099,14507712,14507776,14507728,14507898,14507194,14507940],"length":1,"stats":{"Line":0}},{"line":273,"address":[20367560,20367147,20367343,20367311],"length":1,"stats":{"Line":0}},{"line":274,"address":[14479151,14479098,14479202,14479404,14478997],"length":1,"stats":{"Line":0}},{"line":275,"address":[14479520,14479656,14479424],"length":1,"stats":{"Line":0}},{"line":276,"address":[20367856,20367812,20367749],"length":1,"stats":{"Line":0}},{"line":277,"address":[13119754],"length":1,"stats":{"Line":0}},{"line":278,"address":[13119773],"length":1,"stats":{"Line":0}},{"line":279,"address":[14479767,14479815,14479792],"length":1,"stats":{"Line":0}},{"line":285,"address":[14507098,14507250,14507383],"length":1,"stats":{"Line":0}},{"line":286,"address":[20366901],"length":1,"stats":{"Line":0}},{"line":292,"address":[14336640,14337100,14337094],"length":1,"stats":{"Line":2}},{"line":293,"address":[13006571,13006636],"length":1,"stats":{"Line":2}},{"line":295,"address":[13006619,13006700],"length":1,"stats":{"Line":4}},{"line":296,"address":[13006879,13006820],"length":1,"stats":{"Line":4}},{"line":297,"address":[13006914],"length":1,"stats":{"Line":2}},{"line":298,"address":[14318774],"length":1,"stats":{"Line":2}},{"line":300,"address":[14337013,14337049],"length":1,"stats":{"Line":4}},{"line":304,"address":[13006841],"length":1,"stats":{"Line":2}},{"line":308,"address":[14318832,14319740,14319891],"length":1,"stats":{"Line":2}},{"line":310,"address":[20351083],"length":1,"stats":{"Line":2}},{"line":311,"address":[14319027],"length":1,"stats":{"Line":2}},{"line":314,"address":[14337634,14337497],"length":1,"stats":{"Line":4}},{"line":315,"address":[14319110],"length":1,"stats":{"Line":2}},{"line":316,"address":[13007321],"length":1,"stats":{"Line":2}},{"line":318,"address":[14319377],"length":1,"stats":{"Line":2}},{"line":321,"address":[20351938,20351520],"length":1,"stats":{"Line":0}},{"line":327,"address":[13008240,13009050,13009056],"length":1,"stats":{"Line":0}},{"line":328,"address":[14480032],"length":1,"stats":{"Line":0}},{"line":329,"address":[14509025,14509165,14509152],"length":1,"stats":{"Line":0}},{"line":330,"address":[14509088,14509107,14509036],"length":1,"stats":{"Line":0}},{"line":334,"address":[20352376],"length":1,"stats":{"Line":0}},{"line":335,"address":[14320237],"length":1,"stats":{"Line":0}},{"line":337,"address":[13008432,13008512],"length":1,"stats":{"Line":0}},{"line":338,"address":[13008989,13008811],"length":1,"stats":{"Line":0}},{"line":340,"address":[14320876],"length":1,"stats":{"Line":0}},{"line":344,"address":[14320693],"length":1,"stats":{"Line":0}}],"covered":19,"coverable":94},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","http_client.rs"],"content":"//! Shared HTTP client for all registry clients.\n//!\n//! This module provides a shared HTTP client with proper configuration\n//! for connection pooling, HTTP/2, and timeout handling. Sharing a single\n//! client across all registries enables:\n//!\n//! - Connection reuse across different registries\n//! - HTTP/2 multiplexing where supported\n//! - Reduced TLS handshake overhead\n//! - Shared DNS cache\n//! - Lower memory footprint\n\nuse std::sync::Arc;\nuse std::time::Duration;\n\nuse reqwest::Client;\n\nconst USER_AGENT: \u0026str = concat!(\n    \"dependi-lsp/\",\n    env!(\"CARGO_PKG_VERSION\"),\n    \" (https://github.com/mpiton/zed-dependi)\"\n);\n\nconst DEFAULT_TIMEOUT: Duration = Duration::from_secs(10);\nconst POOL_IDLE_TIMEOUT: Duration = Duration::from_secs(90);\nconst CONNECT_TIMEOUT: Duration = Duration::from_secs(5);\n\npub fn create_shared_client() -\u003e anyhow::Result\u003cArc\u003cClient\u003e\u003e {\n    let client = Client::builder()\n        .user_agent(USER_AGENT)\n        .timeout(DEFAULT_TIMEOUT)\n        .connect_timeout(CONNECT_TIMEOUT)\n        .pool_idle_timeout(POOL_IDLE_TIMEOUT)\n        .pool_max_idle_per_host(10)\n        .tcp_keepalive(Duration::from_secs(60))\n        .build()?;\n\n    Ok(Arc::new(client))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::registries::Registry;\n    use crate::registries::crates_io::CratesIoRegistry;\n    use crate::registries::go_proxy::GoProxyRegistry;\n    use crate::registries::npm::NpmRegistry;\n    use crate::registries::nuget::NuGetRegistry;\n    use crate::registries::packagist::PackagistRegistry;\n    use crate::registries::pub_dev::PubDevRegistry;\n    use crate::registries::pypi::PyPiRegistry;\n    use crate::registries::rubygems::RubyGemsRegistry;\n\n    #[test]\n    fn test_create_shared_client() {\n        let client = create_shared_client().expect(\"Failed to create client\");\n        assert!(Arc::strong_count(\u0026client) == 1);\n    }\n\n    #[test]\n    fn test_client_can_be_cloned() {\n        let client = create_shared_client().expect(\"Failed to create client\");\n        let client2 = Arc::clone(\u0026client);\n        assert!(Arc::strong_count(\u0026client) == 2);\n        drop(client2);\n        assert!(Arc::strong_count(\u0026client) == 1);\n    }\n\n    #[test]\n    fn test_registries_share_client_instance() {\n        let shared_client = create_shared_client().expect(\"Failed to create client\");\n        let client_ptr = Arc::as_ptr(\u0026shared_client);\n\n        let crates_io = CratesIoRegistry::with_client(Arc::clone(\u0026shared_client));\n        let npm = NpmRegistry::with_client(Arc::clone(\u0026shared_client));\n        let pypi = PyPiRegistry::with_client(Arc::clone(\u0026shared_client));\n        let go_proxy = GoProxyRegistry::with_client(Arc::clone(\u0026shared_client));\n        let packagist = PackagistRegistry::with_client(Arc::clone(\u0026shared_client));\n        let pub_dev = PubDevRegistry::with_client(Arc::clone(\u0026shared_client));\n        let nuget = NuGetRegistry::with_client(Arc::clone(\u0026shared_client));\n        let rubygems = RubyGemsRegistry::with_client(Arc::clone(\u0026shared_client));\n\n        assert_eq!(Arc::as_ptr(\u0026crates_io.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026npm.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026pypi.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026go_proxy.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026packagist.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026pub_dev.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026nuget.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026rubygems.http_client()), client_ptr);\n\n        assert_eq!(Arc::strong_count(\u0026shared_client), 9);\n    }\n\n    #[test]\n    fn test_default_registries_create_separate_clients() {\n        let crates_io = CratesIoRegistry::default();\n        let npm = NpmRegistry::default();\n\n        assert_ne!(\n            Arc::as_ptr(\u0026crates_io.http_client()),\n            Arc::as_ptr(\u0026npm.http_client())\n        );\n    }\n}\n","traces":[{"line":28,"address":[13012294,13012323,13011712],"length":1,"stats":{"Line":2}},{"line":29,"address":[13012129,13012162,13011734,13012089,13012032],"length":1,"stats":{"Line":19}},{"line":30,"address":[13332161],"length":1,"stats":{"Line":3}},{"line":31,"address":[13011816],"length":1,"stats":{"Line":3}},{"line":32,"address":[13011863],"length":1,"stats":{"Line":3}},{"line":33,"address":[13011899],"length":1,"stats":{"Line":5}},{"line":35,"address":[13012040,13011966,13012329,13011982],"length":1,"stats":{"Line":10}},{"line":38,"address":[13012254,13012188],"length":1,"stats":{"Line":12}}],"covered":8,"coverable":8},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","mod.rs"],"content":"//! # Package Registry Clients\n//!\n//! This module provides clients for fetching package version information from\n//! various package registries across different programming ecosystems.\n//!\n//! ## Supported Registries\n//!\n//! | Registry | Ecosystem | Module |\n//! |----------|-----------|--------|\n//! | [crates.io](https://crates.io) | Rust | [`crates_io`] |\n//! | [npm](https://www.npmjs.com) | Node.js/JavaScript | [`npm`] |\n//! | [PyPI](https://pypi.org) | Python | [`pypi`] |\n//! | [Go Proxy](https://proxy.golang.org) | Go | [`go_proxy`] |\n//! | [Packagist](https://packagist.org) | PHP/Composer | [`packagist`] |\n//! | [pub.dev](https://pub.dev) | Dart/Flutter | [`pub_dev`] |\n//! | [NuGet](https://www.nuget.org) | .NET | [`nuget`] |\n//! | [RubyGems](https://rubygems.org) | Ruby | [`rubygems`] |\n//!\n//! ## Architecture\n//!\n//! All registry clients implement the [`Registry`] trait, providing a unified\n//! interface for fetching package metadata:\n//!\n//! ```ignore\n//! pub trait Registry: Send + Sync {\n//!     async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e;\n//!     fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e;\n//! }\n//! ```\n//!\n//! ## Shared HTTP Client\n//!\n//! Registry clients share a single HTTP client via [`http_client::create_shared_client`]\n//! for connection pooling, HTTP/2 multiplexing, and reduced memory footprint.\n//!\n//! ## Common Return Type\n//!\n//! All registries return [`VersionInfo`] containing:\n//!\n//! - **Latest stable version**: The most recent non-prerelease version\n//! - **Latest prerelease**: The most recent prerelease version (if any)\n//! - **All versions**: Complete list of available versions\n//! - **Metadata**: Description, homepage, repository, license\n//! - **Status**: Deprecated, yanked flags\n//! - **Release dates**: Publish timestamps for each version\n//!\n//! ## Vulnerability Detection\n//!\n//! Vulnerability information is populated separately via the OSV API\n//! (see `vulnerabilities` module), not by the registry clients themselves.\n//!\n//! ## Rate Limiting\n//!\n//! Each registry has different rate limiting policies:\n//!\n//! | Registry | Rate Limit | Notes |\n//! |----------|------------|-------|\n//! | crates.io | 1 req/s | **Strict** - client-side enforced |\n//! | npm | ≤1 req/s recommended | No official limit; IP blocking for abuse |\n//! | PyPI | No official limit | CDN-cached; be respectful |\n//! | Go Proxy | Fair use | No hard limit |\n//! | Packagist | ~60/min | CDN-cached |\n//! | pub.dev | ~100/min | CDN-cached |\n//! | NuGet | Fair use | CDN-cached |\n//! | RubyGems | Varies by endpoint | ~10 req/s typical; blocking for abuse |\n//!\n//! ## Usage\n//!\n//! ```ignore\n//! use dependi_lsp::registries::{Registry, crates_io::CratesIoRegistry};\n//!\n//! let registry = CratesIoRegistry::default();\n//! let info = registry.get_version_info(\"serde\").await?;\n//! println!(\"Latest: {:?}\", info.latest);\n//! ```\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::{Deserialize, Serialize};\n\n/// Information about a package version from a registry\n#[derive(Debug, Clone, Serialize, Deserialize, Default)]\npub struct VersionInfo {\n    /// Latest stable version\n    pub latest: Option\u003cString\u003e,\n    /// Latest prerelease version\n    pub latest_prerelease: Option\u003cString\u003e,\n    /// All available versions\n    pub versions: Vec\u003cString\u003e,\n    /// Package description\n    pub description: Option\u003cString\u003e,\n    /// Homepage URL\n    pub homepage: Option\u003cString\u003e,\n    /// Repository URL (GitHub, etc.)\n    pub repository: Option\u003cString\u003e,\n    /// SPDX license identifier\n    pub license: Option\u003cString\u003e,\n    /// Known vulnerabilities\n    pub vulnerabilities: Vec\u003cVulnerability\u003e,\n    /// Whether the package is deprecated\n    pub deprecated: bool,\n    /// Whether the version is yanked (Rust specific) - deprecated, use yanked_versions instead\n    pub yanked: bool,\n    /// List of yanked version numbers (Rust specific)\n    pub yanked_versions: Vec\u003cString\u003e,\n    /// Release dates for each version (version string -\u003e DateTime)\n    #[serde(default)]\n    pub release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e,\n}\n\nimpl VersionInfo {\n    /// Check if a specific version is yanked\n    pub fn is_version_yanked(\u0026self, version: \u0026str) -\u003e bool {\n        let normalized = normalize_version_for_yanked_check(version);\n        self.yanked_versions\n            .iter()\n            .any(|v| normalize_version_for_yanked_check(v) == normalized)\n    }\n\n    /// Get the release date for a specific version\n    pub fn get_release_date(\u0026self, version: \u0026str) -\u003e Option\u003cDateTime\u003cUtc\u003e\u003e {\n        self.release_dates.get(version).copied()\n    }\n}\n\n/// Normalize version for yanked check comparison\n/// Removes common prefixes like ^, ~, \u003e=, etc.\nfn normalize_version_for_yanked_check(version: \u0026str) -\u003e String {\n    let version = version.trim();\n    version\n        .strip_prefix('^')\n        .or_else(|| version.strip_prefix('~'))\n        .or_else(|| version.strip_prefix(\"\u003e=\"))\n        .or_else(|| version.strip_prefix(\"\u003c=\"))\n        .or_else(|| version.strip_prefix('\u003e'))\n        .or_else(|| version.strip_prefix('\u003c'))\n        .or_else(|| version.strip_prefix('='))\n        .unwrap_or(version)\n        .split(',')\n        .next()\n        .unwrap_or(version)\n        .trim()\n        .to_string()\n}\n\n/// Vulnerability information\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Vulnerability {\n    /// CVE or advisory ID\n    pub id: String,\n    /// Severity level\n    pub severity: VulnerabilitySeverity,\n    /// Description of the vulnerability\n    pub description: String,\n    /// URL for more information\n    pub url: Option\u003cString\u003e,\n}\n\n/// Vulnerability severity levels\n#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq)]\npub enum VulnerabilitySeverity {\n    Low,\n    Medium,\n    High,\n    Critical,\n}\n\nimpl VulnerabilitySeverity {\n    /// Get numeric rank for severity comparison (higher = more severe)\n    pub fn rank(\u0026self) -\u003e u8 {\n        match self {\n            VulnerabilitySeverity::Low =\u003e 1,\n            VulnerabilitySeverity::Medium =\u003e 2,\n            VulnerabilitySeverity::High =\u003e 3,\n            VulnerabilitySeverity::Critical =\u003e 4,\n        }\n    }\n\n    /// Check if this severity meets or exceeds a minimum threshold\n    pub fn meets_threshold(\u0026self, min: \u0026Self) -\u003e bool {\n        self.rank() \u003e= min.rank()\n    }\n\n    /// Parse severity from string (case-insensitive)\n    pub fn from_str_loose(s: \u0026str) -\u003e Self {\n        match s.to_lowercase().as_str() {\n            \"critical\" =\u003e VulnerabilitySeverity::Critical,\n            \"high\" =\u003e VulnerabilitySeverity::High,\n            \"medium\" =\u003e VulnerabilitySeverity::Medium,\n            _ =\u003e VulnerabilitySeverity::Low,\n        }\n    }\n\n    /// Get lowercase string representation\n    pub fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            VulnerabilitySeverity::Low =\u003e \"low\",\n            VulnerabilitySeverity::Medium =\u003e \"medium\",\n            VulnerabilitySeverity::High =\u003e \"high\",\n            VulnerabilitySeverity::Critical =\u003e \"critical\",\n        }\n    }\n}\n\n/// Trait for registry clients\n/// Note: async_fn_in_trait is allowed because this trait is internal and already bounds Send + Sync\n#[allow(async_fn_in_trait)]\npub trait Registry: Send + Sync {\n    /// Get version information for a package\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e;\n\n    /// Get a reference to the HTTP client used by this registry\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e;\n}\n\npub mod crates_io;\npub mod go_proxy;\npub mod http_client;\npub mod npm;\npub mod nuget;\npub mod packagist;\npub mod pub_dev;\npub mod pypi;\npub mod rubygems;\npub mod version_utils;\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_severity_rank() {\n        assert_eq!(VulnerabilitySeverity::Low.rank(), 1);\n        assert_eq!(VulnerabilitySeverity::Medium.rank(), 2);\n        assert_eq!(VulnerabilitySeverity::High.rank(), 3);\n        assert_eq!(VulnerabilitySeverity::Critical.rank(), 4);\n    }\n\n    #[test]\n    fn test_severity_meets_threshold() {\n        // Critical meets all thresholds\n        assert!(VulnerabilitySeverity::Critical.meets_threshold(\u0026VulnerabilitySeverity::Low));\n        assert!(VulnerabilitySeverity::Critical.meets_threshold(\u0026VulnerabilitySeverity::Medium));\n        assert!(VulnerabilitySeverity::Critical.meets_threshold(\u0026VulnerabilitySeverity::High));\n        assert!(VulnerabilitySeverity::Critical.meets_threshold(\u0026VulnerabilitySeverity::Critical));\n\n        // Low only meets Low threshold\n        assert!(VulnerabilitySeverity::Low.meets_threshold(\u0026VulnerabilitySeverity::Low));\n        assert!(!VulnerabilitySeverity::Low.meets_threshold(\u0026VulnerabilitySeverity::Medium));\n        assert!(!VulnerabilitySeverity::Low.meets_threshold(\u0026VulnerabilitySeverity::High));\n        assert!(!VulnerabilitySeverity::Low.meets_threshold(\u0026VulnerabilitySeverity::Critical));\n\n        // High meets Low, Medium, and High thresholds\n        assert!(VulnerabilitySeverity::High.meets_threshold(\u0026VulnerabilitySeverity::Low));\n        assert!(VulnerabilitySeverity::High.meets_threshold(\u0026VulnerabilitySeverity::Medium));\n        assert!(VulnerabilitySeverity::High.meets_threshold(\u0026VulnerabilitySeverity::High));\n        assert!(!VulnerabilitySeverity::High.meets_threshold(\u0026VulnerabilitySeverity::Critical));\n    }\n\n    #[test]\n    fn test_severity_from_str_loose() {\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"critical\"),\n            VulnerabilitySeverity::Critical\n        );\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"CRITICAL\"),\n            VulnerabilitySeverity::Critical\n        );\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"high\"),\n            VulnerabilitySeverity::High\n        );\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"HIGH\"),\n            VulnerabilitySeverity::High\n        );\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"medium\"),\n            VulnerabilitySeverity::Medium\n        );\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"low\"),\n            VulnerabilitySeverity::Low\n        );\n        // Unknown strings default to Low\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"unknown\"),\n            VulnerabilitySeverity::Low\n        );\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"\"),\n            VulnerabilitySeverity::Low\n        );\n    }\n\n    #[test]\n    fn test_severity_as_str() {\n        assert_eq!(VulnerabilitySeverity::Low.as_str(), \"low\");\n        assert_eq!(VulnerabilitySeverity::Medium.as_str(), \"medium\");\n        assert_eq!(VulnerabilitySeverity::High.as_str(), \"high\");\n        assert_eq!(VulnerabilitySeverity::Critical.as_str(), \"critical\");\n    }\n\n    #[test]\n    fn test_is_version_yanked() {\n        let info = VersionInfo {\n            yanked_versions: vec![\"1.0.0\".to_string(), \"1.0.1\".to_string()],\n            ..Default::default()\n        };\n\n        assert!(info.is_version_yanked(\"1.0.0\"));\n        assert!(info.is_version_yanked(\"1.0.1\"));\n        assert!(!info.is_version_yanked(\"1.0.2\"));\n        assert!(!info.is_version_yanked(\"2.0.0\"));\n    }\n\n    #[test]\n    fn test_is_version_yanked_with_prefixes() {\n        let info = VersionInfo {\n            yanked_versions: vec![\"1.0.0\".to_string()],\n            ..Default::default()\n        };\n\n        assert!(info.is_version_yanked(\"^1.0.0\"));\n        assert!(info.is_version_yanked(\"~1.0.0\"));\n        assert!(info.is_version_yanked(\"\u003e=1.0.0\"));\n        assert!(info.is_version_yanked(\"=1.0.0\"));\n    }\n\n    #[test]\n    fn test_is_version_yanked_empty() {\n        let info = VersionInfo::default();\n\n        assert!(!info.is_version_yanked(\"1.0.0\"));\n    }\n}\n","traces":[{"line":116,"address":[18576144,18576343,18576349],"length":1,"stats":{"Line":3}},{"line":117,"address":[13055872],"length":1,"stats":{"Line":3}},{"line":118,"address":[18576186,18576287],"length":1,"stats":{"Line":26}},{"line":120,"address":[13716416,13716446],"length":1,"stats":{"Line":16}},{"line":124,"address":[13084656],"length":1,"stats":{"Line":2}},{"line":125,"address":[14834644],"length":1,"stats":{"Line":2}},{"line":131,"address":[13056656],"length":1,"stats":{"Line":4}},{"line":132,"address":[13085638],"length":1,"stats":{"Line":5}},{"line":135,"address":[13692048,13692062],"length":1,"stats":{"Line":16}},{"line":136,"address":[13085724],"length":1,"stats":{"Line":18}},{"line":137,"address":[16552576,16552590],"length":1,"stats":{"Line":19}},{"line":138,"address":[18577141],"length":1,"stats":{"Line":21}},{"line":139,"address":[13692096,13692110],"length":1,"stats":{"Line":30}},{"line":140,"address":[16552528,16552542],"length":1,"stats":{"Line":35}},{"line":141,"address":[13085834],"length":1,"stats":{"Line":12}},{"line":144,"address":[13085886],"length":1,"stats":{"Line":14}},{"line":173,"address":[13085360],"length":1,"stats":{"Line":2}},{"line":174,"address":[14835285],"length":1,"stats":{"Line":2}},{"line":175,"address":[13085396],"length":1,"stats":{"Line":2}},{"line":176,"address":[14835323],"length":1,"stats":{"Line":2}},{"line":177,"address":[13085410],"length":1,"stats":{"Line":2}},{"line":178,"address":[13085417],"length":1,"stats":{"Line":2}},{"line":183,"address":[13085296],"length":1,"stats":{"Line":2}},{"line":184,"address":[13056387],"length":1,"stats":{"Line":2}},{"line":188,"address":[13056064,13056351,13056357],"length":1,"stats":{"Line":2}},{"line":189,"address":[13056170,13056084],"length":1,"stats":{"Line":4}},{"line":190,"address":[13056252,13056186],"length":1,"stats":{"Line":4}},{"line":191,"address":[13085157,13085230,13085191],"length":1,"stats":{"Line":6}},{"line":192,"address":[13056279,13056326,13056313],"length":1,"stats":{"Line":6}},{"line":193,"address":[14835167],"length":1,"stats":{"Line":2}},{"line":198,"address":[14835360],"length":1,"stats":{"Line":2}},{"line":199,"address":[13085445],"length":1,"stats":{"Line":2}},{"line":200,"address":[13085476],"length":1,"stats":{"Line":2}},{"line":201,"address":[13056571],"length":1,"stats":{"Line":2}},{"line":202,"address":[13056594],"length":1,"stats":{"Line":2}},{"line":203,"address":[13056617],"length":1,"stats":{"Line":2}}],"covered":36,"coverable":36},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","npm.rs"],"content":"//! # npm Registry Client\n//!\n//! This module implements a client for the [npm](https://www.npmjs.com) registry,\n//! the default package registry for Node.js and JavaScript packages.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://registry.npmjs.org`\n//! - **API Version**: Registry API (stable)\n//! - **Authentication**: Bearer token from `.npmrc` (optional)\n//! - **CORS**: Enabled for browser-based access\n//!\n//! ## Rate Limiting\n//!\n//! npm does **not** enforce hard rate limits on read operations, but implements:\n//!\n//! - **IP-based blocking**: For abusive behavior patterns\n//! - **Cloudflare protection**: May trigger CAPTCHA for suspicious traffic\n//! - **Best practice**: Keep requests under 100/minute for bulk operations\n//!\n//! ## API Endpoints Used\n//!\n//! ### Fetch Package Info\n//!\n//! - **Endpoint**: `GET /{package-name}`\n//! - **Scoped packages**: `GET /@scope%2fpackage-name` (URL encoded `/`)\n//! - **Response**: JSON with full package metadata\n//! - **Fields**:\n//!   - `dist-tags.latest`: Current stable version\n//!   - `dist-tags.next`: Latest prerelease (if exists)\n//!   - `versions{}`: Map of version string to version metadata\n//!   - `time{}`: Map of version string to publish timestamp\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: Semver with optional prerelease (`-alpha`, `-beta`, `-canary`)\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00.000Z`)\n//! - **Deprecated packages**: `deprecated` field in version metadata (string message)\n//! - **License**: Can be string or object with `type` field\n//! - **Repository**: Can be string or object with `url` field\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Scoped packages**: Must URL-encode the slash (`@scope/pkg` → `@scope%2fpkg`)\n//! - **Repository URL formats**: May include `git+https://`, `git://`, or `.git` suffix\n//! - **Large packages**: May have thousands of versions (e.g., lodash)\n//! - **Unpublished packages**: Return 404 but may have been available previously\n//! - **Private packages**: Require authentication; return 401/403 without token\n//! - **Engines field**: Contains Node.js version constraints (not exposed by this client)\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found, 401/403 for auth issues\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [npm Registry API](https://github.com/npm/registry/blob/main/docs/REGISTRY-API.md)\n//! - [Package Metadata Specification](https://github.com/npm/registry/blob/main/docs/responses/package-metadata.md)\n//! - [npm CLI Documentation](https://docs.npmjs.com/cli)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_npm;\nuse super::{Registry, VersionInfo};\n\n/// Client for the npm registry\npub struct NpmRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl NpmRegistry {\n    /// Constructs an NpmRegistry that uses the provided shared HTTP client and the default npm registry base URL.\n    ///\n    /// The supplied `client` is used for all HTTP requests performed by the registry; the base URL is set to\n    /// `https://registry.npmjs.org`.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::npm::NpmRegistry;\n    ///\n    /// let client = Arc::new(reqwest::Client::new());\n    /// let registry = NpmRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://registry.npmjs.org\".to_string(),\n        }\n    }\n}\n\nimpl Default for NpmRegistry {\n    /// Creates a default NpmRegistry configured with a shared HTTP client and the standard npm registry base URL.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::npm::NpmRegistry;\n    ///\n    /// let registry = NpmRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// API response structures\n#[derive(Debug, Deserialize)]\nstruct PackageResponse {\n    description: Option\u003cString\u003e,\n    homepage: Option\u003cString\u003e,\n    repository: Option\u003cRepository\u003e,\n    license: Option\u003cLicenseField\u003e,\n    #[serde(rename = \"dist-tags\")]\n    dist_tags: Option\u003cDistTags\u003e,\n    versions: Option\u003cHashMap\u003cString, VersionMetadata\u003e\u003e,\n    time: Option\u003cHashMap\u003cString, String\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\n#[serde(untagged)]\nenum Repository {\n    String(String),\n    Object { url: Option\u003cString\u003e },\n}\n\nimpl Repository {\n    fn url(\u0026self) -\u003e Option\u003cString\u003e {\n        match self {\n            Repository::String(s) =\u003e Some(normalize_repo_url(s)),\n            Repository::Object { url } =\u003e url.as_ref().map(|u| normalize_repo_url(u)),\n        }\n    }\n}\n\n#[derive(Debug, Deserialize)]\n#[serde(untagged)]\nenum LicenseField {\n    String(String),\n    Object { r#type: Option\u003cString\u003e },\n}\n\nimpl LicenseField {\n    fn as_string(\u0026self) -\u003e Option\u003cString\u003e {\n        match self {\n            LicenseField::String(s) =\u003e Some(s.clone()),\n            LicenseField::Object { r#type } =\u003e r#type.clone(),\n        }\n    }\n}\n\n#[derive(Debug, Deserialize)]\nstruct DistTags {\n    latest: Option\u003cString\u003e,\n    next: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct VersionMetadata {\n    deprecated: Option\u003cString\u003e,\n}\n\nfn normalize_repo_url(url: \u0026str) -\u003e String {\n    // Convert git+https://github.com/user/repo.git to https://github.com/user/repo\n    let url = url\n        .strip_prefix(\"git+\")\n        .unwrap_or(url)\n        .strip_suffix(\".git\")\n        .unwrap_or(url);\n\n    // Convert git://github.com to https://github.com\n    if url.starts_with(\"git://\") {\n        return url.replace(\"git://\", \"https://\");\n    }\n\n    url.to_string()\n}\n\nimpl Registry for NpmRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // Handle scoped packages (@scope/name -\u003e @scope%2fname)\n        let encoded_name = if package_name.starts_with('@') {\n            package_name.replace('/', \"%2f\")\n        } else {\n            package_name.to_string()\n        };\n\n        let url = format!(\"{}/{}\", self.base_url, encoded_name);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch package info for {}: {}\",\n                package_name,\n                response.status()\n            );\n        }\n\n        let pkg: PackageResponse = response.json().await?;\n\n        // Get latest version from dist-tags\n        let latest = pkg.dist_tags.as_ref().and_then(|t| t.latest.clone());\n\n        // Get all versions\n        let versions: Vec\u003cString\u003e = pkg\n            .versions\n            .as_ref()\n            .map(|v| {\n                let mut versions: Vec\u003cString\u003e = v.keys().cloned().collect();\n                // Sort versions in descending order (newest first)\n                versions.sort_by(|a, b| {\n                    match (semver::Version::parse(a), semver::Version::parse(b)) {\n                        (Ok(va), Ok(vb)) =\u003e vb.cmp(\u0026va),\n                        _ =\u003e b.cmp(a),\n                    }\n                });\n                versions\n            })\n            .unwrap_or_default();\n\n        // Find latest prerelease\n        let latest_prerelease = pkg\n            .dist_tags\n            .as_ref()\n            .and_then(|t| t.next.clone())\n            .or_else(|| versions.iter().find(|v| is_prerelease_npm(v)).cloned());\n\n        // Check if latest version is deprecated\n        let deprecated = pkg\n            .versions\n            .as_ref()\n            .and_then(|v| latest.as_ref().and_then(|l| v.get(l)))\n            .is_some_and(|m| m.deprecated.is_some());\n\n        // Get repository URL\n        let repository = pkg.repository.as_ref().and_then(|r| r.url());\n\n        // Parse release dates from the time field (excluding \"created\" and \"modified\" keys)\n        let release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = pkg\n            .time\n            .as_ref()\n            .map(|time_map| {\n                time_map\n                    .iter()\n                    .filter(|(k, _)| *k != \"created\" \u0026\u0026 *k != \"modified\")\n                    .filter_map(|(version, date_str)| {\n                        DateTime::parse_from_rfc3339(date_str)\n                            .ok()\n                            .map(|dt| (version.clone(), dt.with_timezone(\u0026Utc)))\n                    })\n                    .collect()\n            })\n            .unwrap_or_default();\n\n        Ok(VersionInfo {\n            latest,\n            latest_prerelease,\n            versions,\n            description: pkg.description,\n            homepage: pkg.homepage,\n            repository,\n            license: pkg.license.and_then(|l| l.as_string()),\n            vulnerabilities: vec![], // TODO: Integrate npm audit\n            deprecated,\n            yanked: false,\n            yanked_versions: vec![], // Not applicable to npm\n            release_dates,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_npm(\"1.0.0-alpha\"));\n        assert!(is_prerelease_npm(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_npm(\"1.0.0-rc.1\"));\n        assert!(is_prerelease_npm(\"18.3.0-canary\"));\n        assert!(!is_prerelease_npm(\"1.0.0\"));\n        assert!(!is_prerelease_npm(\"2.3.4\"));\n    }\n\n    #[test]\n    fn test_normalize_repo_url() {\n        assert_eq!(\n            normalize_repo_url(\"git+https://github.com/user/repo.git\"),\n            \"https://github.com/user/repo\"\n        );\n        assert_eq!(\n            normalize_repo_url(\"git://github.com/user/repo\"),\n            \"https://github.com/user/repo\"\n        );\n        assert_eq!(\n            normalize_repo_url(\"https://github.com/user/repo\"),\n            \"https://github.com/user/repo\"\n        );\n    }\n\n    #[test]\n    fn test_repository_string_variant() {\n        let repo = Repository::String(\"git+https://github.com/user/repo.git\".to_string());\n        assert_eq!(repo.url(), Some(\"https://github.com/user/repo\".to_string()));\n    }\n\n    #[test]\n    fn test_repository_object_variant() {\n        let repo = Repository::Object {\n            url: Some(\"git://github.com/user/repo\".to_string()),\n        };\n        assert_eq!(repo.url(), Some(\"https://github.com/user/repo\".to_string()));\n    }\n\n    #[test]\n    fn test_repository_object_none() {\n        let repo = Repository::Object { url: None };\n        assert_eq!(repo.url(), None);\n    }\n\n    #[test]\n    fn test_license_field_string() {\n        let license = LicenseField::String(\"MIT\".to_string());\n        assert_eq!(license.as_string(), Some(\"MIT\".to_string()));\n    }\n\n    #[test]\n    fn test_license_field_object() {\n        let license = LicenseField::Object {\n            r#type: Some(\"Apache-2.0\".to_string()),\n        };\n        assert_eq!(license.as_string(), Some(\"Apache-2.0\".to_string()));\n    }\n\n    #[test]\n    fn test_license_field_object_none() {\n        let license = LicenseField::Object { r#type: None };\n        assert_eq!(license.as_string(), None);\n    }\n\n    #[test]\n    fn test_scoped_package_url_encoding() {\n        let package_name = \"@types/node\";\n        let encoded = if package_name.starts_with('@') {\n            package_name.replace('/', \"%2f\")\n        } else {\n            package_name.to_string()\n        };\n        assert_eq!(encoded, \"@types%2fnode\");\n    }\n\n    #[test]\n    fn test_normal_package_no_encoding() {\n        let package_name = \"lodash\";\n        let encoded = if package_name.starts_with('@') {\n            package_name.replace('/', \"%2f\")\n        } else {\n            package_name.to_string()\n        };\n        assert_eq!(encoded, \"lodash\");\n    }\n}\n","traces":[{"line":95,"address":[17972976,17972982,17972848],"length":1,"stats":{"Line":2}},{"line":98,"address":[14230279],"length":1,"stats":{"Line":2}},{"line":113,"address":[14214128],"length":1,"stats":{"Line":2}},{"line":114,"address":[13870158],"length":1,"stats":{"Line":2}},{"line":139,"address":[17972656],"length":1,"stats":{"Line":3}},{"line":140,"address":[13867831],"length":1,"stats":{"Line":4}},{"line":141,"address":[13867878],"length":1,"stats":{"Line":2}},{"line":142,"address":[15975694,15975664],"length":1,"stats":{"Line":8}},{"line":155,"address":[17973040],"length":1,"stats":{"Line":2}},{"line":156,"address":[14212199],"length":1,"stats":{"Line":5}},{"line":157,"address":[17973102],"length":1,"stats":{"Line":2}},{"line":158,"address":[14212217],"length":1,"stats":{"Line":4}},{"line":174,"address":[14212304],"length":1,"stats":{"Line":2}},{"line":178,"address":[14212388],"length":1,"stats":{"Line":2}},{"line":180,"address":[14212434],"length":1,"stats":{"Line":2}},{"line":183,"address":[17973330],"length":1,"stats":{"Line":2}},{"line":184,"address":[14212526],"length":1,"stats":{"Line":3}},{"line":187,"address":[14212503],"length":1,"stats":{"Line":3}},{"line":191,"address":[14232496],"length":1,"stats":{"Line":2}},{"line":192,"address":[14232501],"length":1,"stats":{"Line":2}},{"line":195,"address":[13461312,13461545,13461374,13461588,13461617,13462272,13463381],"length":1,"stats":{"Line":0}},{"line":197,"address":[14371083,14371231],"length":1,"stats":{"Line":0}},{"line":198,"address":[13432779,13432884],"length":1,"stats":{"Line":0}},{"line":200,"address":[13432749,13432819],"length":1,"stats":{"Line":0}},{"line":203,"address":[13432837,13432942],"length":1,"stats":{"Line":0}},{"line":205,"address":[14371143,14371585,14371672,14371858,14372877],"length":1,"stats":{"Line":0}},{"line":207,"address":[14372267,14372335],"length":1,"stats":{"Line":0}},{"line":208,"address":[13462935,13462836],"length":1,"stats":{"Line":0}},{"line":215,"address":[13432668,13434330,13434467,13433932],"length":1,"stats":{"Line":0}},{"line":218,"address":[14376016,14376000,14373387,14373305],"length":1,"stats":{"Line":0}},{"line":221,"address":[14373402],"length":1,"stats":{"Line":0}},{"line":224,"address":[13463980,13466486,13466480,13466256],"length":1,"stats":{"Line":0}},{"line":225,"address":[16004822],"length":1,"stats":{"Line":0}},{"line":227,"address":[14376189,14376448,14376120,14377119,14377254],"length":1,"stats":{"Line":0}},{"line":228,"address":[16005600,16005350],"length":1,"stats":{"Line":0}},{"line":229,"address":[16005628],"length":1,"stats":{"Line":0}},{"line":230,"address":[13467542,13467933],"length":1,"stats":{"Line":0}},{"line":233,"address":[13466446],"length":1,"stats":{"Line":0}},{"line":238,"address":[14373519],"length":1,"stats":{"Line":0}},{"line":241,"address":[16004560,16002497,16004576],"length":1,"stats":{"Line":0}},{"line":242,"address":[13466848,13468254,13468240,13464131,13466880],"length":1,"stats":{"Line":0}},{"line":245,"address":[16002543,16002649],"length":1,"stats":{"Line":0}},{"line":248,"address":[14375746,14377616,14375728,14373721,14377630],"length":1,"stats":{"Line":0}},{"line":249,"address":[14376281,14376272,14373738],"length":1,"stats":{"Line":0}},{"line":252,"address":[16004672,16002666,16002723,16004656],"length":1,"stats":{"Line":0}},{"line":255,"address":[16002738],"length":1,"stats":{"Line":0}},{"line":258,"address":[13466656,13464459],"length":1,"stats":{"Line":0}},{"line":260,"address":[16005176],"length":1,"stats":{"Line":0}},{"line":261,"address":[16005186,16006288,16006320],"length":1,"stats":{"Line":0}},{"line":262,"address":[13467165,13467120,13466707],"length":1,"stats":{"Line":0}},{"line":263,"address":[13438247],"length":1,"stats":{"Line":0}},{"line":264,"address":[13438266],"length":1,"stats":{"Line":0}},{"line":265,"address":[13468311,13467220,13468288],"length":1,"stats":{"Line":0}},{"line":267,"address":[14375700],"length":1,"stats":{"Line":0}},{"line":271,"address":[13436100],"length":1,"stats":{"Line":0}},{"line":272,"address":[14373943],"length":1,"stats":{"Line":0}},{"line":273,"address":[14373983],"length":1,"stats":{"Line":0}},{"line":274,"address":[16002919],"length":1,"stats":{"Line":0}},{"line":275,"address":[13464625],"length":1,"stats":{"Line":0}},{"line":276,"address":[14374103],"length":1,"stats":{"Line":0}},{"line":277,"address":[13435777],"length":1,"stats":{"Line":0}},{"line":278,"address":[14374183,14375904,14375920],"length":1,"stats":{"Line":0}},{"line":279,"address":[13464856],"length":1,"stats":{"Line":0}},{"line":282,"address":[13435988],"length":1,"stats":{"Line":0}},{"line":283,"address":[13436052],"length":1,"stats":{"Line":0}}],"covered":20,"coverable":65},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","nuget.rs"],"content":"//! # NuGet Registry Client\n//!\n//! This module implements a client for [NuGet Gallery](https://www.nuget.org),\n//! the package manager for .NET packages.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://api.nuget.org/v3`\n//! - **API Version**: v3 (NuGet Server API)\n//! - **Authentication**: API key for publishing (not needed for reading)\n//! - **CORS**: Limited support\n//!\n//! ## Rate Limiting\n//!\n//! NuGet does not publish hard rate limits but implements:\n//!\n//! - **Fair use policy**: No hard limits for normal usage\n//! - **CDN caching**: Most responses served from Azure CDN\n//! - **Best practice**: Use conditional requests\n//!\n//! ## API Endpoints Used\n//!\n//! ### Package Registration (Metadata)\n//!\n//! - **Endpoint**: `GET /registration5-semver1/{package-id-lower}/index.json`\n//! - **Response**: JSON with registration pages containing version metadata\n//! - **Fields**:\n//!   - `items[]`: Array of registration pages\n//!   - `items[].items[]`: Array of version entries (may require fetching page)\n//!   - `catalogEntry.version`: Version string\n//!   - `catalogEntry.description`: Package description\n//!   - `catalogEntry.projectUrl`: Project homepage\n//!   - `catalogEntry.licenseExpression`: SPDX license\n//!   - `catalogEntry.listed`: Whether version is listed (unlisted = hidden)\n//!   - `catalogEntry.deprecation`: Deprecation info if deprecated\n//!   - `catalogEntry.published`: RFC 3339 publish timestamp\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: Semver with optional prerelease (`1.0.0`, `2.0.0-preview.1`)\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00+00:00`)\n//! - **Unlisted packages**: `listed: false` (hidden from search but downloadable)\n//! - **Deprecated packages**: `deprecation` object present\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Package ID case**: IDs are case-insensitive but URLs use lowercase\n//! - **Paged responses**: Large packages may have items in separate pages\n//! - **Version ranges**: Uses NuGet version range syntax `[1.0.0,2.0.0)`\n//! - **Framework targeting**: Packages may target multiple .NET versions\n//! - **Dependency groups**: Dependencies organized by target framework\n//! - **Unlisted vs deprecated**: Unlisted hides from search; deprecated shows warning\n//! - **License**: Either `licenseExpression` (SPDX) or `licenseUrl` (legacy)\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [NuGet Server API](https://learn.microsoft.com/en-us/nuget/api/overview)\n//! - [Package Metadata Resource](https://learn.microsoft.com/en-us/nuget/api/registration-base-url-resource)\n//! - [NuGet Versioning](https://learn.microsoft.com/en-us/nuget/concepts/package-versioning)\n//! - [Version Ranges](https://learn.microsoft.com/en-us/nuget/concepts/package-versioning#version-ranges)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_nuget;\nuse super::{Registry, VersionInfo};\n\n/// Client for the NuGet registry\npub struct NuGetRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl NuGetRegistry {\n    /// Constructs a NuGetRegistry configured to use the NuGet v3 API with the provided shared HTTP client.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::nuget::NuGetRegistry;\n    ///\n    /// let client = Arc::new(reqwest::Client::new());\n    /// let _registry = NuGetRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://api.nuget.org/v3\".to_string(),\n        }\n    }\n}\n\nimpl Default for NuGetRegistry {\n    /// Creates a `NuGetRegistry` configured with a shared HTTP client targeting the NuGet v3 API.\n    ///\n    /// Panics if creating the shared HTTP client fails.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::nuget::NuGetRegistry;\n    ///\n    /// let _reg = NuGetRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// NuGet API response structures\n#[derive(Debug, Deserialize)]\nstruct NuGetRegistrationResponse {\n    items: Vec\u003cNuGetRegistrationPage\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct NuGetRegistrationPage {\n    items: Option\u003cVec\u003cNuGetRegistrationLeaf\u003e\u003e,\n    #[serde(rename = \"@id\")]\n    id: String,\n}\n\n#[derive(Debug, Deserialize, Clone)]\nstruct NuGetRegistrationLeaf {\n    #[serde(rename = \"catalogEntry\")]\n    catalog_entry: NuGetCatalogEntry,\n}\n\n#[derive(Debug, Deserialize, Clone)]\nstruct NuGetCatalogEntry {\n    version: String,\n    description: Option\u003cString\u003e,\n    #[serde(rename = \"projectUrl\")]\n    project_url: Option\u003cString\u003e,\n    #[serde(rename = \"licenseExpression\")]\n    license_expression: Option\u003cString\u003e,\n    #[serde(rename = \"licenseUrl\")]\n    license_url: Option\u003cString\u003e,\n    #[serde(default)]\n    listed: Option\u003cbool\u003e,\n    #[serde(default)]\n    deprecation: Option\u003cNuGetDeprecation\u003e,\n    published: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize, Clone)]\nstruct NuGetDeprecation {\n    #[serde(rename = \"message\")]\n    _message: Option\u003cString\u003e,\n    #[serde(rename = \"reasons\")]\n    _reasons: Option\u003cVec\u003cString\u003e\u003e,\n}\n\nimpl Registry for NuGetRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // NuGet uses lowercase package IDs in URLs\n        let package_id = package_name.to_lowercase();\n\n        // Get registration index\n        let url = format!(\n            \"{}/registration5-semver1/{}/index.json\",\n            self.base_url, package_id\n        );\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch package info for {}: {}\",\n                package_name,\n                response.status()\n            );\n        }\n\n        let registration: NuGetRegistrationResponse = response.json().await?;\n\n        // Collect all versions from all pages\n        let mut all_versions: Vec\u003cNuGetCatalogEntry\u003e = Vec::new();\n\n        for page in \u0026registration.items {\n            if let Some(items) = \u0026page.items {\n                for leaf in items {\n                    all_versions.push(leaf.catalog_entry.clone());\n                }\n            } else {\n                // Need to fetch the page content\n                let page_response = self.client.get(\u0026page.id).send().await?;\n                if page_response.status().is_success() {\n                    let page_data: NuGetRegistrationPage = page_response.json().await?;\n                    if let Some(items) = page_data.items {\n                        for leaf in items {\n                            all_versions.push(leaf.catalog_entry.clone());\n                        }\n                    }\n                }\n            }\n        }\n\n        // Sort versions descending\n        all_versions.sort_by(|a, b| {\n            match (\n                semver::Version::parse(\u0026a.version),\n                semver::Version::parse(\u0026b.version),\n            ) {\n                (Ok(va), Ok(vb)) =\u003e vb.cmp(\u0026va),\n                _ =\u003e b.version.cmp(\u0026a.version),\n            }\n        });\n\n        // Filter listed versions\n        let versions: Vec\u003cString\u003e = all_versions\n            .iter()\n            .filter(|entry| entry.listed.unwrap_or(true))\n            .map(|entry| entry.version.clone())\n            .collect();\n\n        // Find latest stable version\n        let latest_stable = versions.iter().find(|v| !is_prerelease_nuget(v)).cloned();\n\n        // Find latest prerelease\n        let latest_prerelease = versions.iter().find(|v| is_prerelease_nuget(v)).cloned();\n\n        // Get metadata from latest version\n        let latest_entry = all_versions.first();\n\n        // Check deprecation\n        let deprecated = latest_entry.and_then(|e| e.deprecation.as_ref()).is_some();\n\n        // Collect release dates\n        let release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = all_versions\n            .iter()\n            .filter_map(|e| {\n                e.published.as_ref().and_then(|time_str| {\n                    DateTime::parse_from_rfc3339(time_str)\n                        .ok()\n                        .map(|dt| (e.version.clone(), dt.with_timezone(\u0026Utc)))\n                })\n            })\n            .collect();\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease,\n            versions,\n            description: latest_entry.and_then(|e| e.description.clone()),\n            homepage: latest_entry.and_then(|e| e.project_url.clone()),\n            repository: None, // NuGet doesn't expose repository URL directly\n            license: latest_entry\n                .and_then(|e| e.license_expression.clone().or(e.license_url.clone())),\n            vulnerabilities: vec![], // Will be filled by OSV\n            deprecated,\n            yanked: false,\n            yanked_versions: vec![], // Not applicable to NuGet\n            release_dates,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_nuget(\"1.0.0-alpha\"));\n        assert!(is_prerelease_nuget(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_nuget(\"1.0.0-preview\"));\n        assert!(is_prerelease_nuget(\"1.0.0-rc.1\"));\n        assert!(is_prerelease_nuget(\"1.0.0-Alpha\"));\n        assert!(!is_prerelease_nuget(\"1.0.0\"));\n        assert!(!is_prerelease_nuget(\"2.0.0\"));\n    }\n}\n","traces":[{"line":97,"address":[13503412,13503280,13503418],"length":1,"stats":{"Line":2}},{"line":100,"address":[13532231],"length":1,"stats":{"Line":2}},{"line":117,"address":[13534432],"length":1,"stats":{"Line":0}},{"line":118,"address":[14162654],"length":1,"stats":{"Line":0}},{"line":167,"address":[14163136],"length":1,"stats":{"Line":2}},{"line":168,"address":[13506005],"length":1,"stats":{"Line":2}},{"line":171,"address":[14015392,14015600,14017395,14015643,14016289,14015664,14015685,14015454,14015714],"length":1,"stats":{"Line":0}},{"line":173,"address":[13997287],"length":1,"stats":{"Line":0}},{"line":176,"address":[14015764,14015871],"length":1,"stats":{"Line":0}},{"line":181,"address":[12749252],"length":1,"stats":{"Line":0}},{"line":183,"address":[14016752,14016823],"length":1,"stats":{"Line":0}},{"line":184,"address":[14735760,14735650],"length":1,"stats":{"Line":0}},{"line":191,"address":[12749275],"length":1,"stats":{"Line":0}},{"line":194,"address":[19659017],"length":1,"stats":{"Line":0}},{"line":196,"address":[14736622,14737961,14736720,14736736],"length":1,"stats":{"Line":0}},{"line":197,"address":[14019364,14021803,14019220],"length":1,"stats":{"Line":0}},{"line":198,"address":[14003523,14003589],"length":1,"stats":{"Line":0}},{"line":199,"address":[14740529],"length":1,"stats":{"Line":0}},{"line":203,"address":[12799349],"length":1,"stats":{"Line":0}},{"line":204,"address":[14741109,14741174],"length":1,"stats":{"Line":0}},{"line":205,"address":[14734493,14736804,14737114,14736834,14741222],"length":1,"stats":{"Line":0}},{"line":206,"address":[14000279],"length":1,"stats":{"Line":0}},{"line":207,"address":[14018759,14018644,14018894],"length":1,"stats":{"Line":0}},{"line":208,"address":[14737665,14737768],"length":1,"stats":{"Line":0}},{"line":216,"address":[14019429,14024394,14023584,14024259],"length":1,"stats":{"Line":0}},{"line":217,"address":[19664458,19664326,19664576],"length":1,"stats":{"Line":0}},{"line":218,"address":[14023654],"length":1,"stats":{"Line":0}},{"line":219,"address":[19664439,19664372],"length":1,"stats":{"Line":0}},{"line":221,"address":[14742332],"length":1,"stats":{"Line":0}},{"line":222,"address":[14742290,14742681],"length":1,"stats":{"Line":0}},{"line":227,"address":[14001210],"length":1,"stats":{"Line":0}},{"line":229,"address":[14023536,14023550,14019626],"length":1,"stats":{"Line":0}},{"line":230,"address":[14001381,14004803,14004768],"length":1,"stats":{"Line":0}},{"line":234,"address":[14019839,14023182,14023168,14019739],"length":1,"stats":{"Line":0}},{"line":237,"address":[19661148,19665502,19661048,19665488],"length":1,"stats":{"Line":0}},{"line":240,"address":[19661269,19661356],"length":1,"stats":{"Line":0}},{"line":243,"address":[19661387,19665344,19665353],"length":1,"stats":{"Line":0}},{"line":246,"address":[14020400],"length":1,"stats":{"Line":0}},{"line":248,"address":[14020493,14023456],"length":1,"stats":{"Line":0}},{"line":249,"address":[19665300,19665584],"length":1,"stats":{"Line":0}},{"line":250,"address":[14743162],"length":1,"stats":{"Line":0}},{"line":251,"address":[19665645],"length":1,"stats":{"Line":0}},{"line":252,"address":[14743232,14743255,14743206],"length":1,"stats":{"Line":0}},{"line":257,"address":[14002790],"length":1,"stats":{"Line":0}},{"line":258,"address":[14739147],"length":1,"stats":{"Line":0}},{"line":259,"address":[14020603],"length":1,"stats":{"Line":0}},{"line":260,"address":[19661691],"length":1,"stats":{"Line":0}},{"line":261,"address":[19661739,19665536,19665552],"length":1,"stats":{"Line":0}},{"line":262,"address":[14004848,14002466,14004832],"length":1,"stats":{"Line":0}},{"line":263,"address":[14020832],"length":1,"stats":{"Line":0}},{"line":265,"address":[14741792,14741712,14741736,14739424],"length":1,"stats":{"Line":0}},{"line":266,"address":[14020903],"length":1,"stats":{"Line":0}},{"line":269,"address":[14002675],"length":1,"stats":{"Line":0}},{"line":270,"address":[14002742],"length":1,"stats":{"Line":0}}],"covered":4,"coverable":54},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","packagist.rs"],"content":"//! # Packagist Registry Client\n//!\n//! This module implements a client for [Packagist](https://packagist.org),\n//! the main Composer repository for PHP packages.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://repo.packagist.org`\n//! - **API Version**: p2 (Package API v2)\n//! - **Authentication**: Optional API token for private packages\n//! - **CORS**: Enabled for browser-based access\n//!\n//! ## Rate Limiting\n//!\n//! Packagist enforces rate limits to protect the service:\n//!\n//! - **Standard limit**: ~60 requests per minute per IP\n//! - **CDN caching**: Most package data served from CDN\n//! - **Best practice**: Use `If-Modified-Since` headers\n//!\n//! ## API Endpoints Used\n//!\n//! ### Fetch Package Info (p2 API)\n//!\n//! - **Endpoint**: `GET /p2/{vendor}/{package}.json`\n//! - **Response**: JSON with package metadata and all versions\n//! - **Fields**:\n//!   - `packages.{name}[]`: Array of version entries\n//!   - `version`: Version string\n//!   - `description`: Package description\n//!   - `homepage`: Homepage URL\n//!   - `license[]`: Array of license identifiers\n//!   - `source.url`: Repository URL\n//!   - `abandoned`: Deprecation status (bool or replacement package name)\n//!   - `time`: RFC 3339 release timestamp\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: Semver with optional `v` prefix and stability flags\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00+00:00`)\n//! - **Dev versions**: `dev-master`, `dev-main`, `1.0.x-dev` (filtered out)\n//! - **Abandoned packages**: `abandoned` field is truthy (bool or string)\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Package naming**: Must be `vendor/package` format (e.g., `laravel/framework`)\n//! - **Dev branches**: Prefixed with `dev-` or suffixed with `-dev` (excluded)\n//! - **Stability flags**: `@stable`, `@RC`, `@beta`, `@alpha`, `@dev`\n//! - **Version aliases**: May have `branch-alias` in `extra` field\n//! - **Abandoned packages**: Can specify replacement package name as string\n//! - **Multiple licenses**: Array of SPDX identifiers\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found\n//! - **Invalid names**: Error returned if not `vendor/package` format\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [Packagist API](https://packagist.org/apidoc)\n//! - [Composer Version Constraints](https://getcomposer.org/doc/articles/versions.md)\n//! - [Composer Repositories](https://getcomposer.org/doc/05-repositories.md)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_php;\nuse super::{Registry, VersionInfo};\n\n/// Client for the Packagist registry\npub struct PackagistRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl PackagistRegistry {\n    /// Creates a PackagistRegistry configured with the given shared HTTP client and the default Packagist API base URL.\n    ///\n    /// The registry's base URL is set to `https://repo.packagist.org`.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::packagist::PackagistRegistry;\n    ///\n    /// let client = Arc::new(reqwest::Client::new());\n    /// let registry = PackagistRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://repo.packagist.org\".to_string(),\n        }\n    }\n}\n\nimpl Default for PackagistRegistry {\n    /// Create a PackagistRegistry configured with a shared HTTP client and the default Packagist API base URL.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::packagist::PackagistRegistry;\n    ///\n    /// let _registry = PackagistRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// Packagist API response structures\n#[derive(Debug, Deserialize)]\nstruct PackagistResponse {\n    packages: HashMap\u003cString, Vec\u003cVersionEntry\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Deserialize)]\nstruct VersionEntry {\n    version: String,\n    description: Option\u003cString\u003e,\n    homepage: Option\u003cString\u003e,\n    license: Option\u003cVec\u003cString\u003e\u003e,\n    source: Option\u003cSourceInfo\u003e,\n    /// Can be bool or string (replacement package name). We only care if it's truthy.\n    abandoned: Option\u003cserde_json::Value\u003e,\n    /// Release time\n    time: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Deserialize)]\nstruct SourceInfo {\n    url: Option\u003cString\u003e,\n}\n\nimpl Registry for PackagistRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // Package name format: vendor/package\n        if !package_name.contains('/') {\n            anyhow::bail!(\n                \"Invalid package name: {} (expected vendor/package)\",\n                package_name\n            );\n        }\n\n        let url = format!(\"{}/p2/{}.json\", self.base_url, package_name);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch package info for {}: {}\",\n                package_name,\n                response.status()\n            );\n        }\n\n        let packagist_response: PackagistResponse = response.json().await?;\n\n        // Get versions for this package\n        let entries = packagist_response\n            .packages\n            .get(package_name)\n            .cloned()\n            .unwrap_or_default();\n\n        // Filter out dev versions and sort\n        let mut versions: Vec\u003cString\u003e = entries\n            .iter()\n            .filter(|e| !is_dev_version(\u0026e.version))\n            .map(|e| e.version.clone())\n            .collect();\n\n        // Sort versions in descending order\n        versions.sort_by(|a, b| compare_packagist_versions(b, a));\n\n        // Find latest stable version\n        let latest_stable = versions.iter().find(|v| !is_prerelease_php(v)).cloned();\n\n        // Find latest prerelease\n        let latest_prerelease = versions.iter().find(|v| is_prerelease_php(v)).cloned();\n\n        // Get metadata from first (latest) entry\n        let latest_entry = entries.first();\n\n        let description = latest_entry.and_then(|e| e.description.clone());\n        let homepage = latest_entry.and_then(|e| e.homepage.clone());\n        let license = latest_entry\n            .and_then(|e| e.license.as_ref())\n            .and_then(|l| l.first())\n            .cloned();\n        let repository = latest_entry\n            .and_then(|e| e.source.as_ref())\n            .and_then(|s| s.url.clone())\n            .map(|url| normalize_repo_url(\u0026url));\n\n        // Check if deprecated/abandoned (truthy value = abandoned)\n        let deprecated = latest_entry\n            .and_then(|e| e.abandoned.as_ref())\n            .is_some_and(|v| !matches!(v, serde_json::Value::Bool(false)));\n\n        // Collect release dates\n        let release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = entries\n            .iter()\n            .filter_map(|e| {\n                e.time.as_ref().and_then(|time_str| {\n                    DateTime::parse_from_rfc3339(time_str)\n                        .ok()\n                        .map(|dt| (e.version.clone(), dt.with_timezone(\u0026Utc)))\n                })\n            })\n            .collect();\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease,\n            versions,\n            description,\n            homepage,\n            repository,\n            license,\n            vulnerabilities: vec![], // TODO: Check PHP Security Advisories\n            deprecated,\n            yanked: false,\n            yanked_versions: vec![], // Not applicable to Packagist\n            release_dates,\n        })\n    }\n}\n\n/// Check if a version is a dev version (e.g., dev-master, dev-main)\nfn is_dev_version(version: \u0026str) -\u003e bool {\n    version.starts_with(\"dev-\") || version.ends_with(\"-dev\")\n}\n\n/// Compare Packagist versions for sorting\nfn compare_packagist_versions(a: \u0026str, b: \u0026str) -\u003e std::cmp::Ordering {\n    // Strip 'v' prefix if present\n    let a_stripped = a.strip_prefix('v').unwrap_or(a);\n    let b_stripped = b.strip_prefix('v').unwrap_or(b);\n\n    // Try parsing as semver\n    match (\n        semver::Version::parse(a_stripped),\n        semver::Version::parse(b_stripped),\n    ) {\n        (Ok(va), Ok(vb)) =\u003e va.cmp(\u0026vb),\n        _ =\u003e {\n            // Fallback to string comparison\n            compare_version_strings(a_stripped, b_stripped)\n        }\n    }\n}\n\n/// Simple version string comparison\nfn compare_version_strings(a: \u0026str, b: \u0026str) -\u003e std::cmp::Ordering {\n    let parse_parts = |s: \u0026str| -\u003e Vec\u003cu64\u003e {\n        s.split(|c: char| !c.is_ascii_digit())\n            .filter_map(|p| p.parse().ok())\n            .collect()\n    };\n\n    let parts_a = parse_parts(a);\n    let parts_b = parse_parts(b);\n\n    for (pa, pb) in parts_a.iter().zip(parts_b.iter()) {\n        match pa.cmp(pb) {\n            std::cmp::Ordering::Equal =\u003e continue,\n            other =\u003e return other,\n        }\n    }\n\n    parts_a.len().cmp(\u0026parts_b.len())\n}\n\n/// Normalize repository URL\nfn normalize_repo_url(url: \u0026str) -\u003e String {\n    let url = url\n        .strip_prefix(\"git+\")\n        .unwrap_or(url)\n        .strip_suffix(\".git\")\n        .unwrap_or(url);\n\n    if url.starts_with(\"git://\") {\n        url.replace(\"git://\", \"https://\")\n    } else {\n        url.to_string()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_is_dev_version() {\n        assert!(is_dev_version(\"dev-master\"));\n        assert!(is_dev_version(\"dev-main\"));\n        assert!(is_dev_version(\"1.0.x-dev\"));\n        assert!(!is_dev_version(\"1.0.0\"));\n        assert!(!is_dev_version(\"v2.3.4\"));\n    }\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_php(\"1.0.0-alpha\"));\n        assert!(is_prerelease_php(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_php(\"1.0.0-RC1\"));\n        assert!(is_prerelease_php(\"dev-master\"));\n        assert!(!is_prerelease_php(\"1.0.0\"));\n        assert!(!is_prerelease_php(\"v2.3.4\"));\n    }\n\n    #[test]\n    fn test_compare_packagist_versions() {\n        use std::cmp::Ordering;\n\n        assert_eq!(compare_packagist_versions(\"1.0.0\", \"2.0.0\"), Ordering::Less);\n        assert_eq!(\n            compare_packagist_versions(\"v2.0.0\", \"v1.0.0\"),\n            Ordering::Greater\n        );\n        assert_eq!(\n            compare_packagist_versions(\"1.0.0\", \"1.0.0\"),\n            Ordering::Equal\n        );\n    }\n\n    #[test]\n    fn test_normalize_repo_url() {\n        assert_eq!(\n            normalize_repo_url(\"git+https://github.com/user/repo.git\"),\n            \"https://github.com/user/repo\"\n        );\n        assert_eq!(\n            normalize_repo_url(\"git://github.com/user/repo\"),\n            \"https://github.com/user/repo\"\n        );\n        assert_eq!(\n            normalize_repo_url(\"https://github.com/user/repo\"),\n            \"https://github.com/user/repo\"\n        );\n    }\n}\n","traces":[{"line":97,"address":[14025504,14025636,14025642],"length":1,"stats":{"Line":2}},{"line":100,"address":[14007239],"length":1,"stats":{"Line":2}},{"line":115,"address":[14011472],"length":1,"stats":{"Line":0}},{"line":116,"address":[14011486],"length":1,"stats":{"Line":0}},{"line":145,"address":[14007040],"length":1,"stats":{"Line":2}},{"line":146,"address":[16704053],"length":1,"stats":{"Line":2}},{"line":149,"address":[15564928,15565161,15567041,15565204,15565233,15564990,15565983],"length":1,"stats":{"Line":0}},{"line":151,"address":[13388559,13388411],"length":1,"stats":{"Line":0}},{"line":152,"address":[14405246,14405165],"length":1,"stats":{"Line":0}},{"line":158,"address":[14423496,14423757],"length":1,"stats":{"Line":0}},{"line":160,"address":[15567009,15565831,15565744,15566017,15565191],"length":1,"stats":{"Line":0}},{"line":162,"address":[13389774,13389706],"length":1,"stats":{"Line":0}},{"line":163,"address":[13389932,13389825],"length":1,"stats":{"Line":0}},{"line":170,"address":[14428544,14425115,14424756,14423372,14425255],"length":1,"stats":{"Line":0}},{"line":175,"address":[15567457],"length":1,"stats":{"Line":0}},{"line":180,"address":[14407521],"length":1,"stats":{"Line":0}},{"line":182,"address":[14411086,14411072,14407667],"length":1,"stats":{"Line":0}},{"line":183,"address":[14425998,14429043,14429008],"length":1,"stats":{"Line":0}},{"line":187,"address":[15570885,15567900,15570848,15567808],"length":1,"stats":{"Line":0}},{"line":190,"address":[14426171,14429422,14429408,14426254],"length":1,"stats":{"Line":0}},{"line":193,"address":[14408187,14410798,14410784,14408087],"length":1,"stats":{"Line":0}},{"line":196,"address":[15568312,15568380],"length":1,"stats":{"Line":0}},{"line":198,"address":[14410464,14408405,14408461,14410480],"length":1,"stats":{"Line":0}},{"line":199,"address":[15570320,15568473,15568531,15570336],"length":1,"stats":{"Line":0}},{"line":201,"address":[14411049,14408547,14411040],"length":1,"stats":{"Line":0}},{"line":202,"address":[14410697,14408614,14410688],"length":1,"stats":{"Line":0}},{"line":205,"address":[14410841,14410832,14408667],"length":1,"stats":{"Line":0}},{"line":206,"address":[14427025,14428864,14428880],"length":1,"stats":{"Line":0}},{"line":207,"address":[14428635,14428608,14427044],"length":1,"stats":{"Line":0}},{"line":210,"address":[14427165],"length":1,"stats":{"Line":0}},{"line":211,"address":[14410617,14408796,14410608],"length":1,"stats":{"Line":0}},{"line":212,"address":[15570528,15570538,15568822],"length":1,"stats":{"Line":0}},{"line":215,"address":[13392134],"length":1,"stats":{"Line":0}},{"line":217,"address":[14408956,14410864],"length":1,"stats":{"Line":0}},{"line":218,"address":[14429188,14429456],"length":1,"stats":{"Line":0}},{"line":219,"address":[13394410],"length":1,"stats":{"Line":0}},{"line":220,"address":[14429517],"length":1,"stats":{"Line":0}},{"line":221,"address":[13394454,13394480,13394503],"length":1,"stats":{"Line":0}},{"line":226,"address":[15569395],"length":1,"stats":{"Line":0}},{"line":227,"address":[14427292],"length":1,"stats":{"Line":0}},{"line":228,"address":[13392268],"length":1,"stats":{"Line":0}},{"line":229,"address":[15569028],"length":1,"stats":{"Line":0}},{"line":230,"address":[14427412],"length":1,"stats":{"Line":0}},{"line":231,"address":[14409164],"length":1,"stats":{"Line":0}},{"line":232,"address":[13392428],"length":1,"stats":{"Line":0}},{"line":233,"address":[14409244],"length":1,"stats":{"Line":0}},{"line":234,"address":[14409284],"length":1,"stats":{"Line":0}},{"line":237,"address":[14427635],"length":1,"stats":{"Line":0}},{"line":238,"address":[15569347],"length":1,"stats":{"Line":0}},{"line":244,"address":[16704256],"length":1,"stats":{"Line":2}},{"line":245,"address":[14007143],"length":1,"stats":{"Line":2}},{"line":249,"address":[12580143,12579992,12579088],"length":1,"stats":{"Line":2}},{"line":251,"address":[12579147],"length":1,"stats":{"Line":2}},{"line":252,"address":[16705795],"length":1,"stats":{"Line":2}},{"line":255,"address":[12579461,12579598],"length":1,"stats":{"Line":4}},{"line":256,"address":[14008774],"length":1,"stats":{"Line":2}},{"line":257,"address":[16705929],"length":1,"stats":{"Line":2}},{"line":259,"address":[12579629],"length":1,"stats":{"Line":2}},{"line":262,"address":[14008996,14009414],"length":1,"stats":{"Line":0}},{"line":268,"address":[14008470,14008476,14007648],"length":1,"stats":{"Line":0}},{"line":269,"address":[14411792],"length":1,"stats":{"Line":0}},{"line":270,"address":[13395197,13395057,13395184],"length":1,"stats":{"Line":0}},{"line":271,"address":[14430259,14430156,14430240],"length":1,"stats":{"Line":0}},{"line":275,"address":[14026040],"length":1,"stats":{"Line":0}},{"line":276,"address":[12578397],"length":1,"stats":{"Line":0}},{"line":278,"address":[14007920,14007840],"length":1,"stats":{"Line":0}},{"line":279,"address":[14008231,14008409],"length":1,"stats":{"Line":0}},{"line":281,"address":[16705536],"length":1,"stats":{"Line":0}},{"line":285,"address":[14026533],"length":1,"stats":{"Line":0}},{"line":289,"address":[14007376],"length":1,"stats":{"Line":2}},{"line":292,"address":[14025748],"length":1,"stats":{"Line":2}},{"line":294,"address":[12578114],"length":1,"stats":{"Line":2}},{"line":296,"address":[12578146],"length":1,"stats":{"Line":2}},{"line":297,"address":[14007598],"length":1,"stats":{"Line":2}},{"line":299,"address":[14007575],"length":1,"stats":{"Line":2}}],"covered":19,"coverable":75},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","pub_dev.rs"],"content":"//! # pub.dev Registry Client\n//!\n//! This module implements a client for [pub.dev](https://pub.dev),\n//! the official package repository for Dart and Flutter packages.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://pub.dev/api`\n//! - **API Version**: REST API (stable)\n//! - **Authentication**: OAuth2 for private packages (not implemented)\n//! - **CORS**: Enabled for browser-based access\n//!\n//! ## Rate Limiting\n//!\n//! pub.dev enforces rate limits:\n//!\n//! - **Standard limit**: ~100 requests per minute per IP\n//! - **CDN caching**: Responses cached at edge\n//! - **Best practice**: Respect `Cache-Control` headers\n//!\n//! ## API Endpoints Used\n//!\n//! ### Fetch Package Info\n//!\n//! - **Endpoint**: `GET /api/packages/{package-name}`\n//! - **Response**: JSON with package metadata and all versions\n//! - **Fields**:\n//!   - `name`: Package name\n//!   - `latest`: Latest version info with pubspec\n//!   - `versions[]`: Array of all versions\n//!   - `versions[].version`: Version string\n//!   - `versions[].pubspec`: Parsed pubspec.yaml contents\n//!   - `versions[].retracted`: Whether version is retracted\n//!   - `versions[].published`: RFC 3339 publish timestamp\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: Semver (`1.0.0`, `2.0.0-dev.1`)\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00.000Z`)\n//! - **Retracted versions**: `retracted: true` (equivalent to yanked)\n//! - **Discontinued packages**: `discontinued: true` in pubspec\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **SDK constraints**: `environment.sdk` in pubspec specifies Dart version\n//! - **Flutter constraints**: `environment.flutter` for Flutter SDK version\n//! - **Retracted versions**: Similar to yanked; still downloadable with warning\n//! - **Discontinued packages**: Marked in pubspec, may suggest replacement\n//! - **Null safety**: Packages may indicate null-safety migration status\n//! - **Platform support**: Flutter packages may specify platform compatibility\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [pub.dev API](https://pub.dev/help/api)\n//! - [Pubspec Format](https://dart.dev/tools/pub/pubspec)\n//! - [Version Constraints](https://dart.dev/tools/pub/dependencies#version-constraints)\n//! - [Package Scoring](https://pub.dev/help/scoring)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_dart;\nuse super::{Registry, VersionInfo};\n\n/// Client for the pub.dev registry\npub struct PubDevRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl PubDevRegistry {\n    /// Creates a `PubDevRegistry` configured to use the given shared HTTP client.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::pub_dev::PubDevRegistry;\n    ///\n    /// let client = Arc::new(reqwest::Client::new());\n    /// let _registry = PubDevRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://pub.dev/api\".to_string(),\n        }\n    }\n}\n\nimpl Default for PubDevRegistry {\n    /// Constructs a PubDevRegistry using a shared HTTP client created by `create_shared_client`.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::pub_dev::PubDevRegistry;\n    ///\n    /// let registry = PubDevRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// pub.dev API response structures\n#[derive(Debug, Deserialize)]\nstruct PubPackageResponse {\n    #[serde(rename = \"name\")]\n    _name: String,\n    latest: PubVersionInfo,\n    versions: Vec\u003cPubVersionInfo\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct PubVersionInfo {\n    version: String,\n    pubspec: PubPubspec,\n    #[serde(default)]\n    retracted: bool,\n    published: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct PubPubspec {\n    description: Option\u003cString\u003e,\n    homepage: Option\u003cString\u003e,\n    repository: Option\u003cString\u003e,\n    #[serde(default)]\n    discontinued: bool,\n}\n\nimpl Registry for PubDevRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        let url = format!(\"{}/packages/{}\", self.base_url, package_name);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch package info for {}: {}\",\n                package_name,\n                response.status()\n            );\n        }\n\n        let pkg: PubPackageResponse = response.json().await?;\n\n        // Get all versions (not retracted)\n        let versions: Vec\u003cString\u003e = pkg\n            .versions\n            .iter()\n            .filter(|v| !v.retracted)\n            .map(|v| v.version.clone())\n            .collect();\n\n        // Find latest stable version\n        let latest_stable = versions\n            .iter()\n            .find(|v| !is_prerelease_dart(v))\n            .cloned()\n            .or_else(|| Some(pkg.latest.version.clone()));\n\n        // Find latest prerelease\n        let latest_prerelease = versions.iter().find(|v| is_prerelease_dart(v)).cloned();\n\n        // Collect release dates\n        let release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = pkg\n            .versions\n            .iter()\n            .filter_map(|v| {\n                v.published.as_ref().and_then(|time_str| {\n                    DateTime::parse_from_rfc3339(time_str)\n                        .ok()\n                        .map(|dt| (v.version.clone(), dt.with_timezone(\u0026Utc)))\n                })\n            })\n            .collect();\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease,\n            versions,\n            description: pkg.latest.pubspec.description,\n            homepage: pkg.latest.pubspec.homepage,\n            repository: pkg.latest.pubspec.repository,\n            license: None,           // pub.dev doesn't expose license in API\n            vulnerabilities: vec![], // Will be filled by OSV\n            deprecated: pkg.latest.pubspec.discontinued,\n            yanked: pkg.latest.retracted,\n            yanked_versions: vec![], // Not applicable to pub.dev\n            release_dates,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_dart(\"1.0.0-dev.1\"));\n        assert!(is_prerelease_dart(\"1.0.0-alpha\"));\n        assert!(is_prerelease_dart(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_dart(\"1.0.0-rc.1\"));\n        assert!(!is_prerelease_dart(\"1.0.0\"));\n        assert!(!is_prerelease_dart(\"2.0.0\"));\n    }\n}\n","traces":[{"line":94,"address":[16704112,16704240,16704246],"length":1,"stats":{"Line":2}},{"line":97,"address":[13124535],"length":1,"stats":{"Line":2}},{"line":112,"address":[13402688],"length":1,"stats":{"Line":0}},{"line":113,"address":[13402702],"length":1,"stats":{"Line":0}},{"line":145,"address":[13401344],"length":1,"stats":{"Line":2}},{"line":146,"address":[13401349],"length":1,"stats":{"Line":2}},{"line":149,"address":[13430322,13430304],"length":1,"stats":{"Line":0}},{"line":150,"address":[12585965,12585811],"length":1,"stats":{"Line":0}},{"line":152,"address":[13405968,13407327,13405732,13406257,13406059],"length":1,"stats":{"Line":0}},{"line":154,"address":[13406742,13406674],"length":1,"stats":{"Line":0}},{"line":155,"address":[12587028],"length":1,"stats":{"Line":0}},{"line":162,"address":[15257794],"length":1,"stats":{"Line":0}},{"line":165,"address":[12587898],"length":1,"stats":{"Line":0}},{"line":168,"address":[13410400,13407960,13410410],"length":1,"stats":{"Line":0}},{"line":169,"address":[13379075,13381584,13381619],"length":1,"stats":{"Line":0}},{"line":173,"address":[13408198,13408073],"length":1,"stats":{"Line":0}},{"line":175,"address":[13410304,13410318,13408214],"length":1,"stats":{"Line":0}},{"line":177,"address":[13381648,13381667,13379334],"length":1,"stats":{"Line":0}},{"line":180,"address":[13379377,13381424,13381438,13379465],"length":1,"stats":{"Line":0}},{"line":183,"address":[19221276],"length":1,"stats":{"Line":0}},{"line":186,"address":[13379679,13381504],"length":1,"stats":{"Line":0}},{"line":187,"address":[13410468,13410656],"length":1,"stats":{"Line":0}},{"line":188,"address":[13381770],"length":1,"stats":{"Line":0}},{"line":189,"address":[12590717],"length":1,"stats":{"Line":0}},{"line":190,"address":[13381815,13381863,13381840],"length":1,"stats":{"Line":0}},{"line":195,"address":[12589136],"length":1,"stats":{"Line":0}},{"line":196,"address":[12588685],"length":1,"stats":{"Line":0}},{"line":197,"address":[13379769],"length":1,"stats":{"Line":0}},{"line":198,"address":[13379809],"length":1,"stats":{"Line":0}},{"line":199,"address":[19221541],"length":1,"stats":{"Line":0}},{"line":200,"address":[13408817],"length":1,"stats":{"Line":0}},{"line":201,"address":[13379929],"length":1,"stats":{"Line":0}},{"line":202,"address":[13408907],"length":1,"stats":{"Line":0}},{"line":203,"address":[13379987],"length":1,"stats":{"Line":0}},{"line":204,"address":[12589002],"length":1,"stats":{"Line":0}},{"line":205,"address":[13408989],"length":1,"stats":{"Line":0}},{"line":206,"address":[13380072],"length":1,"stats":{"Line":0}},{"line":207,"address":[13380140],"length":1,"stats":{"Line":0}}],"covered":4,"coverable":38},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","pypi.rs"],"content":"//! # PyPI Registry Client\n//!\n//! This module implements a client for [PyPI](https://pypi.org) (Python Package Index),\n//! the official third-party software repository for Python packages.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://pypi.org/pypi`\n//! - **API Version**: JSON API (stable)\n//! - **Authentication**: Not required for public packages\n//! - **CORS**: Enabled for browser-based access\n//!\n//! ## Rate Limiting\n//!\n//! PyPI enforces rate limits to protect the service:\n//!\n//! - **Standard limit**: ~20 requests per second per IP\n//! - **Blocking**: Aggressive crawlers may be blocked\n//! - **Best practice**: Use `If-Modified-Since` headers for caching\n//! - **CDN**: Responses are served via Fastly CDN\n//!\n//! ## API Endpoints Used\n//!\n//! ### Fetch Package Info\n//!\n//! - **Endpoint**: `GET /pypi/{package-name}/json`\n//! - **Response**: JSON with project metadata and all releases\n//! - **Fields**:\n//!   - `info.version`: Latest version\n//!   - `info.summary`: Package description\n//!   - `info.home_page`: Homepage URL\n//!   - `info.license`: License string\n//!   - `info.project_urls`: Map of URL types to URLs\n//!   - `info.classifiers`: Trove classifiers for categorization\n//!   - `releases{}`: Map of version string to release files\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: PEP 440 compliant (`1.0.0`, `1.0.0a1`, `1.0.0.dev1`)\n//! - **Date format**: ISO 8601 without timezone (`2024-01-15T10:30:00`)\n//! - **Yanked releases**: `yanked: true` in release file info\n//! - **Deprecated projects**: `Development Status :: 7 - Inactive` classifier\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Name normalization**: Case-insensitive; underscores, hyphens, and dots\n//!   are all equivalent per [PEP 503](https://peps.python.org/pep-0503/)\n//!   (`Flask` = `flask` = `FLASK`, `typing_extensions` = `typing-extensions`)\n//! - **Project vs release metadata**: Some fields are project-level, others per-release\n//! - **Classifiers**: Used for deprecation status, Python version support, etc.\n//! - **requires_python**: Version constraint for Python interpreter (not exposed)\n//! - **Yanked releases**: Still downloadable but with warning\n//! - **Version ordering**: Uses PEP 440 ordering, not simple semver\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [PyPI JSON API](https://docs.pypi.org/api/json/)\n//! - [PEP 503 - Simple Repository API](https://peps.python.org/pep-0503/)\n//! - [PEP 440 - Version Identification](https://peps.python.org/pep-0440/)\n//! - [Trove Classifiers](https://pypi.org/classifiers/)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, NaiveDateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_python;\nuse super::{Registry, VersionInfo};\n\n/// Client for the PyPI registry\npub struct PyPiRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl PyPiRegistry {\n    /// Constructs a PyPiRegistry using the provided shared HTTP client.\n    ///\n    /// The returned registry is configured with the default PyPI API base URL (`https://pypi.org/pypi`).\n    ///\n    /// # Parameters\n    ///\n    /// - `client` — shared HTTP client used for performing requests to the PyPI API.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::pypi::PyPiRegistry;\n    /// use dependi_lsp::registries::http_client::create_shared_client;\n    ///\n    /// let client = create_shared_client().expect(\"failed to create client\");\n    /// let registry = PyPiRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://pypi.org/pypi\".to_string(),\n        }\n    }\n}\n\nimpl Default for PyPiRegistry {\n    /// Creates a PyPiRegistry configured with a shared HTTP client and the default PyPI base URL.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::pypi::PyPiRegistry;\n    ///\n    /// let _registry = PyPiRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// PyPI API response structures\n#[derive(Debug, Deserialize)]\nstruct PyPiResponse {\n    info: PackageInfo,\n    releases: HashMap\u003cString, Vec\u003cReleaseFile\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct PackageInfo {\n    /// Latest version\n    version: String,\n    /// Package description\n    summary: Option\u003cString\u003e,\n    /// Homepage URL\n    home_page: Option\u003cString\u003e,\n    /// License string\n    license: Option\u003cString\u003e,\n    /// Project URLs (may contain Repository, Homepage, etc.)\n    project_urls: Option\u003cHashMap\u003cString, String\u003e\u003e,\n    /// Classifiers (can be used to detect deprecated packages)\n    classifiers: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct ReleaseFile {\n    /// Whether this file has been yanked\n    yanked: Option\u003cbool\u003e,\n    /// Upload time for this file (ISO 8601 format without timezone)\n    upload_time: Option\u003cString\u003e,\n}\n\nimpl Registry for PyPiRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // Normalize package name (PyPI is case-insensitive, uses lowercase)\n        let normalized_name = normalize_package_name(package_name);\n\n        let url = format!(\"{}/{}/json\", self.base_url, normalized_name);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch package info for {}: {}\",\n                package_name,\n                response.status()\n            );\n        }\n\n        let pypi_response: PyPiResponse = response.json().await?;\n\n        // Get all versions sorted by semver (newest first)\n        let mut versions: Vec\u003cString\u003e = pypi_response\n            .releases\n            .iter()\n            .filter(|(_, files)| {\n                // Filter out yanked versions\n                !files.iter().any(|f| f.yanked.unwrap_or(false))\n            })\n            .map(|(version, _)| version.clone())\n            .collect();\n\n        // Sort versions in descending order\n        versions.sort_by(|a, b| compare_python_versions(b, a));\n\n        // Find latest stable version (non-prerelease)\n        let latest_stable = versions\n            .iter()\n            .find(|v| !is_prerelease_python(v))\n            .cloned()\n            .or_else(|| Some(pypi_response.info.version.clone()));\n\n        // Find latest prerelease\n        let latest_prerelease = versions.iter().find(|v| is_prerelease_python(v)).cloned();\n\n        // Extract repository URL from project_urls\n        let repository = pypi_response.info.project_urls.as_ref().and_then(|urls| {\n            urls.get(\"Repository\")\n                .or_else(|| urls.get(\"Source\"))\n                .or_else(|| urls.get(\"Source Code\"))\n                .or_else(|| urls.get(\"GitHub\"))\n                .cloned()\n        });\n\n        // Extract homepage\n        let homepage = pypi_response.info.home_page.clone().or_else(|| {\n            pypi_response\n                .info\n                .project_urls\n                .as_ref()\n                .and_then(|urls| urls.get(\"Homepage\").cloned())\n        });\n\n        // Check if deprecated (via classifiers)\n        let deprecated = pypi_response\n            .info\n            .classifiers\n            .as_ref()\n            .is_some_and(|classifiers| {\n                classifiers\n                    .iter()\n                    .any(|c| c.contains(\"Development Status :: 7 - Inactive\"))\n            });\n\n        // Extract release dates from releases (use the first file's upload_time for each version)\n        let release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = pypi_response\n            .releases\n            .iter()\n            .filter_map(|(version, files)| {\n                files\n                    .first()\n                    .and_then(|f| f.upload_time.as_ref())\n                    .and_then(|time_str| parse_pypi_datetime(time_str))\n                    .map(|dt| (version.clone(), dt))\n            })\n            .collect();\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease,\n            versions,\n            description: pypi_response.info.summary,\n            homepage,\n            repository,\n            license: pypi_response.info.license,\n            vulnerabilities: vec![], // TODO: Integrate Safety/OSV\n            deprecated,\n            yanked: false,\n            yanked_versions: vec![], // Not applicable to PyPI\n            release_dates,\n        })\n    }\n}\n\n/// Parse PyPI datetime format (ISO 8601 without timezone, assumed UTC)\nfn parse_pypi_datetime(s: \u0026str) -\u003e Option\u003cDateTime\u003cUtc\u003e\u003e {\n    NaiveDateTime::parse_from_str(s, \"%Y-%m-%dT%H:%M:%S\")\n        .or_else(|_| NaiveDateTime::parse_from_str(s, \"%Y-%m-%d %H:%M:%S\"))\n        .ok()\n        .map(|naive| naive.and_utc())\n}\n\n/// Normalize Python package name according to PEP 503\n/// - Lowercase\n/// - Replace underscores and dots with hyphens\nfn normalize_package_name(name: \u0026str) -\u003e String {\n    name.to_lowercase().replace(['_', '.'], \"-\")\n}\n\n/// Compare Python versions for sorting\n/// Returns Ordering for descending sort (newer versions first)\nfn compare_python_versions(a: \u0026str, b: \u0026str) -\u003e std::cmp::Ordering {\n    // Try parsing as semver first\n    match (semver::Version::parse(a), semver::Version::parse(b)) {\n        (Ok(va), Ok(vb)) =\u003e va.cmp(\u0026vb),\n        _ =\u003e {\n            // Fallback to simple string comparison with version-aware logic\n            compare_version_strings(a, b)\n        }\n    }\n}\n\n/// Simple version string comparison\nfn compare_version_strings(a: \u0026str, b: \u0026str) -\u003e std::cmp::Ordering {\n    let parse_parts = |s: \u0026str| -\u003e Vec\u003cu64\u003e {\n        s.split(|c: char| !c.is_ascii_digit())\n            .filter_map(|p| p.parse().ok())\n            .collect()\n    };\n\n    let parts_a = parse_parts(a);\n    let parts_b = parse_parts(b);\n\n    for (pa, pb) in parts_a.iter().zip(parts_b.iter()) {\n        match pa.cmp(pb) {\n            std::cmp::Ordering::Equal =\u003e continue,\n            other =\u003e return other,\n        }\n    }\n\n    parts_a.len().cmp(\u0026parts_b.len())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_normalize_package_name() {\n        assert_eq!(normalize_package_name(\"Flask\"), \"flask\");\n        assert_eq!(normalize_package_name(\"ruamel.yaml\"), \"ruamel-yaml\");\n        assert_eq!(\n            normalize_package_name(\"typing_extensions\"),\n            \"typing-extensions\"\n        );\n        assert_eq!(normalize_package_name(\"Pillow\"), \"pillow\");\n    }\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_python(\"1.0.0a1\"));\n        assert!(is_prerelease_python(\"1.0.0b2\"));\n        assert!(is_prerelease_python(\"1.0.0rc1\"));\n        assert!(is_prerelease_python(\"1.0.0.dev1\"));\n        assert!(is_prerelease_python(\"2.0.0alpha\"));\n        assert!(is_prerelease_python(\"2.0.0beta\"));\n        assert!(!is_prerelease_python(\"1.0.0\"));\n        assert!(!is_prerelease_python(\"2.3.4\"));\n    }\n\n    #[test]\n    fn test_compare_python_versions() {\n        use std::cmp::Ordering;\n\n        assert_eq!(compare_python_versions(\"1.0.0\", \"2.0.0\"), Ordering::Less);\n        assert_eq!(compare_python_versions(\"2.0.0\", \"1.0.0\"), Ordering::Greater);\n        assert_eq!(compare_python_versions(\"1.0.0\", \"1.0.0\"), Ordering::Equal);\n        assert_eq!(\n            compare_python_versions(\"1.10.0\", \"1.9.0\"),\n            Ordering::Greater\n        );\n    }\n}\n","traces":[{"line":104,"address":[17099856,17099984,17099990],"length":1,"stats":{"Line":2}},{"line":107,"address":[12941511],"length":1,"stats":{"Line":2}},{"line":122,"address":[13011248],"length":1,"stats":{"Line":0}},{"line":123,"address":[13011262],"length":1,"stats":{"Line":0}},{"line":159,"address":[12944816],"length":1,"stats":{"Line":2}},{"line":160,"address":[13040261],"length":1,"stats":{"Line":2}},{"line":163,"address":[17104722,17104704],"length":1,"stats":{"Line":0}},{"line":165,"address":[12997595],"length":1,"stats":{"Line":0}},{"line":167,"address":[12969671,12969568],"length":1,"stats":{"Line":0}},{"line":169,"address":[12490975],"length":1,"stats":{"Line":0}},{"line":171,"address":[12970592,12970524],"length":1,"stats":{"Line":0}},{"line":172,"address":[12970643,12970754],"length":1,"stats":{"Line":0}},{"line":179,"address":[12748658],"length":1,"stats":{"Line":0}},{"line":182,"address":[12971648],"length":1,"stats":{"Line":0}},{"line":185,"address":[12975054,12975040,12971727],"length":1,"stats":{"Line":0}},{"line":187,"address":[12975344,12975361,12975066],"length":1,"stats":{"Line":0}},{"line":189,"address":[13067096,13064146,13067056],"length":1,"stats":{"Line":0}},{"line":193,"address":[12971816,12974853,12974816,12971896],"length":1,"stats":{"Line":0}},{"line":196,"address":[13000083,13000185],"length":1,"stats":{"Line":0}},{"line":198,"address":[13002944,13000201,13002958],"length":1,"stats":{"Line":0}},{"line":200,"address":[14530816,14530835,14528069],"length":1,"stats":{"Line":0}},{"line":203,"address":[14530576,14530590,14528084,14528172],"length":1,"stats":{"Line":0}},{"line":206,"address":[13002768,13000483,13000561],"length":1,"stats":{"Line":0}},{"line":207,"address":[13067150],"length":1,"stats":{"Line":0}},{"line":208,"address":[13067829,13067174,13067824],"length":1,"stats":{"Line":0}},{"line":209,"address":[13003776,13003781,13002836],"length":1,"stats":{"Line":0}},{"line":210,"address":[13003573,13002849,13003568],"length":1,"stats":{"Line":0}},{"line":211,"address":[13002863],"length":1,"stats":{"Line":0}},{"line":215,"address":[12972412,12974528,12972488],"length":1,"stats":{"Line":0}},{"line":219,"address":[12974560],"length":1,"stats":{"Line":0}},{"line":220,"address":[13066909,13067648,13067678],"length":1,"stats":{"Line":0}},{"line":224,"address":[13000707,13000796],"length":1,"stats":{"Line":0}},{"line":228,"address":[14528543,14530896],"length":1,"stats":{"Line":0}},{"line":229,"address":[12974473],"length":1,"stats":{"Line":0}},{"line":230,"address":[13067253],"length":1,"stats":{"Line":0}},{"line":231,"address":[13067269,13067545,13067520],"length":1,"stats":{"Line":0}},{"line":235,"address":[13000805],"length":1,"stats":{"Line":0}},{"line":238,"address":[13000832,13003296,13003341],"length":1,"stats":{"Line":0}},{"line":239,"address":[13066983],"length":1,"stats":{"Line":0}},{"line":240,"address":[14530754],"length":1,"stats":{"Line":0}},{"line":241,"address":[14530762,14531344,14531353],"length":1,"stats":{"Line":0}},{"line":242,"address":[14531582,14531552,14530770],"length":1,"stats":{"Line":0}},{"line":243,"address":[12975271,12975226,12975248],"length":1,"stats":{"Line":0}},{"line":247,"address":[13001341],"length":1,"stats":{"Line":0}},{"line":248,"address":[13000886],"length":1,"stats":{"Line":0}},{"line":249,"address":[13000926],"length":1,"stats":{"Line":0}},{"line":250,"address":[13000966],"length":1,"stats":{"Line":0}},{"line":251,"address":[13001006],"length":1,"stats":{"Line":0}},{"line":252,"address":[12972870],"length":1,"stats":{"Line":0}},{"line":253,"address":[13001086],"length":1,"stats":{"Line":0}},{"line":254,"address":[13065260],"length":1,"stats":{"Line":0}},{"line":255,"address":[13001166],"length":1,"stats":{"Line":0}},{"line":258,"address":[12973053],"length":1,"stats":{"Line":0}},{"line":259,"address":[14529035],"length":1,"stats":{"Line":0}},{"line":265,"address":[12941632],"length":1,"stats":{"Line":0}},{"line":266,"address":[12941665],"length":1,"stats":{"Line":0}},{"line":267,"address":[12950748,12950720],"length":1,"stats":{"Line":0}},{"line":269,"address":[14507308,14507296],"length":1,"stats":{"Line":0}},{"line":275,"address":[12941948,12941954,12941760],"length":1,"stats":{"Line":2}},{"line":276,"address":[13037192],"length":1,"stats":{"Line":2}},{"line":281,"address":[17101004,17100336,17101139],"length":1,"stats":{"Line":2}},{"line":283,"address":[13008753,13008516],"length":1,"stats":{"Line":4}},{"line":284,"address":[13008781],"length":1,"stats":{"Line":2}},{"line":287,"address":[13038058,13037667],"length":1,"stats":{"Line":0}},{"line":293,"address":[13039196,13039190,13038368],"length":1,"stats":{"Line":0}},{"line":294,"address":[14507600],"length":1,"stats":{"Line":0}},{"line":295,"address":[12979360,12979297,12979373],"length":1,"stats":{"Line":0}},{"line":296,"address":[12979411,12979308,12979392],"length":1,"stats":{"Line":0}},{"line":300,"address":[13038472],"length":1,"stats":{"Line":0}},{"line":301,"address":[13038509],"length":1,"stats":{"Line":0}},{"line":303,"address":[12943216,12943136],"length":1,"stats":{"Line":0}},{"line":304,"address":[12943515,12943693],"length":1,"stats":{"Line":0}},{"line":306,"address":[13010220],"length":1,"stats":{"Line":0}},{"line":310,"address":[13010037],"length":1,"stats":{"Line":0}}],"covered":9,"coverable":74},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","rubygems.rs"],"content":"//! # RubyGems Registry Client\n//!\n//! This module implements a client for [RubyGems.org](https://rubygems.org),\n//! the Ruby community's gem hosting service.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://rubygems.org/api/v1`\n//! - **API Version**: v1 (stable)\n//! - **Authentication**: API key for publishing (not needed for reading)\n//! - **CORS**: Enabled for browser-based access\n//!\n//! ## Rate Limiting\n//!\n//! RubyGems enforces rate limits:\n//!\n//! - **Standard limit**: ~10 requests per second per IP\n//! - **Blocking**: Aggressive crawlers may be blocked\n//! - **Best practice**: Use `If-Modified-Since` headers\n//!\n//! ## API Endpoints Used\n//!\n//! ### Fetch Gem Info\n//!\n//! - **Endpoint**: `GET /api/v1/gems/{gem-name}.json`\n//! - **Response**: JSON with gem metadata (latest version)\n//! - **Fields**:\n//!   - `version`: Latest version string\n//!   - `info`: Gem description\n//!   - `licenses[]`: Array of license identifiers\n//!   - `homepage_uri`: Homepage URL\n//!   - `source_code_uri`: Repository URL\n//!   - `project_uri`: RubyGems project page\n//!   - `version_created_at`: RFC 3339 release timestamp\n//!\n//! ### Fetch All Versions\n//!\n//! - **Endpoint**: `GET /api/v1/versions/{gem-name}.json`\n//! - **Response**: JSON array of version entries\n//! - **Fields**:\n//!   - `number`: Version string\n//!   - `created_at`: RFC 3339 publish timestamp\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: RubyGems versioning (`1.0.0`, `2.0.0.pre.1`)\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00.000Z`)\n//! - **Prerelease**: Versions containing `.pre`, `.alpha`, `.beta`, `.rc`\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Version ordering**: RubyGems uses its own ordering (not strictly semver)\n//! - **Yanked gems**: Available via separate endpoint (not implemented)\n//! - **Platform gems**: May have platform suffix (`-java`, `-x86_64-linux`)\n//! - **Prerelease format**: Uses `.pre.1` format (not `-pre.1`)\n//! - **No deprecation flag**: RubyGems API doesn't expose deprecation status\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [RubyGems API](https://guides.rubygems.org/rubygems-org-api/)\n//! - [Gem Specification](https://guides.rubygems.org/specification-reference/)\n//! - [Version Format](https://guides.rubygems.org/patterns/#semantic-versioning)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::{Registry, VersionInfo};\n\n/// Client for the RubyGems.org registry\npub struct RubyGemsRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl RubyGemsRegistry {\n    /// Creates a RubyGemsRegistry that uses the provided shared HTTP client.\n    ///\n    /// The provided `client` will be used for all HTTP requests to the RubyGems API. The registry's\n    /// base API URL is set to `https://rubygems.org/api/v1`.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::rubygems::RubyGemsRegistry;\n    ///\n    /// let client = Arc::new(reqwest::Client::new());\n    /// let _registry = RubyGemsRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://rubygems.org/api/v1\".to_string(),\n        }\n    }\n}\n\nimpl Default for RubyGemsRegistry {\n    /// Creates a `RubyGemsRegistry` configured with the shared HTTP client used by the module.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::rubygems::RubyGemsRegistry;\n    ///\n    /// let registry = RubyGemsRegistry::default();\n    /// // `registry` is ready to query the RubyGems API.\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n/// RubyGems API response for a gem\n#[derive(Debug, Deserialize)]\nstruct GemResponse {\n    #[serde(rename = \"name\")]\n    _name: String,\n    version: String,\n    info: Option\u003cString\u003e,\n    licenses: Option\u003cVec\u003cString\u003e\u003e,\n    homepage_uri: Option\u003cString\u003e,\n    source_code_uri: Option\u003cString\u003e,\n    project_uri: Option\u003cString\u003e,\n    version_created_at: Option\u003cString\u003e,\n}\n\n/// RubyGems API response for version list\n#[derive(Debug, Deserialize)]\nstruct VersionResponse {\n    number: String,\n    created_at: Option\u003cString\u003e,\n}\n\nimpl Registry for RubyGemsRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // Fetch gem info (contains latest version)\n        let gem_url = format!(\"{}/gems/{}.json\", self.base_url, package_name);\n        let gem_response = self.client.get(\u0026gem_url).send().await?;\n\n        if !gem_response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch gem info for {}: {}\",\n                package_name,\n                gem_response.status()\n            );\n        }\n\n        let gem: GemResponse = gem_response.json().await?;\n\n        // Fetch all versions with dates\n        let versions_url = format!(\"{}/versions/{}.json\", self.base_url, package_name);\n        let (versions, release_dates) = match self.client.get(\u0026versions_url).send().await {\n            Ok(response) if response.status().is_success() =\u003e {\n                let version_list: Vec\u003cVersionResponse\u003e = response.json().await.unwrap_or_default();\n                let versions: Vec\u003cString\u003e = version_list.iter().map(|v| v.number.clone()).collect();\n                let dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = version_list\n                    .into_iter()\n                    .filter_map(|v| {\n                        v.created_at.as_ref().and_then(|time_str| {\n                            DateTime::parse_from_rfc3339(time_str)\n                                .ok()\n                                .map(|dt| (v.number.clone(), dt.with_timezone(\u0026Utc)))\n                        })\n                    })\n                    .collect();\n                (versions, dates)\n            }\n            _ =\u003e {\n                // Fallback to just latest version with its date\n                let mut dates = HashMap::new();\n                if let Some(time_str) = \u0026gem.version_created_at\n                    \u0026\u0026 let Ok(dt) = DateTime::parse_from_rfc3339(time_str)\n                {\n                    dates.insert(gem.version.clone(), dt.with_timezone(\u0026Utc));\n                }\n                (vec![gem.version.clone()], dates)\n            }\n        };\n\n        // Use the latest version from gem info\n        let latest_stable = Some(gem.version.clone());\n\n        // Get license (first one if multiple)\n        let license = gem.licenses.and_then(|l| l.into_iter().next());\n\n        // Get repository URL (prefer source_code_uri, fallback to homepage)\n        let repository = gem.source_code_uri.or_else(|| gem.homepage_uri.clone());\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease: None,\n            versions,\n            description: gem.info,\n            homepage: gem.homepage_uri.or(gem.project_uri),\n            repository,\n            license,\n            vulnerabilities: vec![], // Will be filled by OSV\n            deprecated: false,       // RubyGems doesn't have a deprecation flag in API\n            yanked: false,\n            yanked_versions: vec![], // Not applicable to RubyGems\n            release_dates,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    #[test]\n    fn test_rubygems_url_format() {\n        let base_url = \"https://rubygems.org/api/v1\";\n        let name = \"rails\";\n        let url = format!(\"{}/gems/{}.json\", base_url, name);\n        assert_eq!(url, \"https://rubygems.org/api/v1/gems/rails.json\");\n    }\n}\n","traces":[{"line":101,"address":[13129584,13129718,13129712],"length":1,"stats":{"Line":2}},{"line":104,"address":[13129607],"length":1,"stats":{"Line":2}},{"line":120,"address":[14210880],"length":1,"stats":{"Line":0}},{"line":121,"address":[14210894],"length":1,"stats":{"Line":0}},{"line":147,"address":[13129040],"length":1,"stats":{"Line":2}},{"line":148,"address":[14209893],"length":1,"stats":{"Line":2}},{"line":151,"address":[14202674,14200622,14200957,14200986,14200915,14200872,14200560,14201466,14200936],"length":1,"stats":{"Line":0}},{"line":153,"address":[14201036,14200827],"length":1,"stats":{"Line":0}},{"line":154,"address":[13822310,13822892,13822694,13822594,13824004],"length":1,"stats":{"Line":0}},{"line":156,"address":[18269771,18269700],"length":1,"stats":{"Line":0}},{"line":157,"address":[14183766,14183911],"length":1,"stats":{"Line":0}},{"line":164,"address":[14182635,14184400,14183813,14184254],"length":1,"stats":{"Line":0}},{"line":167,"address":[18270991,18270883],"length":1,"stats":{"Line":0}},{"line":168,"address":[15259553],"length":1,"stats":{"Line":0}},{"line":169,"address":[13825581,13825485],"length":1,"stats":{"Line":0}},{"line":170,"address":[14200965,14205436,14204401,14204347],"length":1,"stats":{"Line":0}},{"line":171,"address":[13830067,13827053,13826985,13830032],"length":1,"stats":{"Line":0}},{"line":172,"address":[14205852],"length":1,"stats":{"Line":0}},{"line":174,"address":[13830005,13827243,13829888],"length":1,"stats":{"Line":0}},{"line":175,"address":[14190494,14190559,14190608],"length":1,"stats":{"Line":0}},{"line":176,"address":[18276538],"length":1,"stats":{"Line":0}},{"line":177,"address":[14190669],"length":1,"stats":{"Line":0}},{"line":178,"address":[13830208,13830182,13830231],"length":1,"stats":{"Line":0}},{"line":182,"address":[14187729],"length":1,"stats":{"Line":0}},{"line":186,"address":[14204127],"length":1,"stats":{"Line":0}},{"line":187,"address":[14204503,14204923],"length":1,"stats":{"Line":0}},{"line":188,"address":[14204566,14204662],"length":1,"stats":{"Line":0}},{"line":190,"address":[18272620,18272451,18272526,18272428],"length":1,"stats":{"Line":0}},{"line":192,"address":[13826281,13825909,13826723],"length":1,"stats":{"Line":0}},{"line":197,"address":[14206348,14206214],"length":1,"stats":{"Line":0}},{"line":200,"address":[14190350,14188100,14190336,14188215],"length":1,"stats":{"Line":0}},{"line":203,"address":[13829840,13829857,13827759,13827877],"length":1,"stats":{"Line":0}},{"line":205,"address":[14207168],"length":1,"stats":{"Line":0}},{"line":206,"address":[13827885],"length":1,"stats":{"Line":0}},{"line":207,"address":[14188403],"length":1,"stats":{"Line":0}},{"line":208,"address":[14188411],"length":1,"stats":{"Line":0}},{"line":209,"address":[14188451],"length":1,"stats":{"Line":0}},{"line":210,"address":[18274406],"length":1,"stats":{"Line":0}},{"line":211,"address":[14206917],"length":1,"stats":{"Line":0}},{"line":212,"address":[14188669],"length":1,"stats":{"Line":0}},{"line":213,"address":[14188709],"length":1,"stats":{"Line":0}},{"line":216,"address":[14188772],"length":1,"stats":{"Line":0}},{"line":217,"address":[14188832],"length":1,"stats":{"Line":0}}],"covered":4,"coverable":43},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","version_utils.rs"],"content":"//! Version parsing and comparison utilities for registry clients.\n//!\n//! This module provides common version-related functions used across\n//! different package registries, with support for registry-specific\n//! behavior where needed.\n\n/// Checks if a Rust crate version is a prerelease.\n///\n/// Uses semver-compatible prerelease detection. A version is considered\n/// a prerelease if it contains a hyphen (prerelease separator) or common\n/// prerelease identifiers.\npub fn is_prerelease_rust(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains('-') || v.contains(\"alpha\") || v.contains(\"beta\") || v.contains(\"rc\")\n}\n\n/// Checks if an npm package version is a prerelease.\n///\n/// npm-specific prerelease identifiers include `canary` and `next` tags\n/// in addition to common patterns.\npub fn is_prerelease_npm(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains('-')\n        || v.contains(\"alpha\")\n        || v.contains(\"beta\")\n        || v.contains(\"rc\")\n        || v.contains(\"canary\")\n        || v.contains(\"next\")\n}\n\n/// Checks if a PyPI package version is a prerelease.\n///\n/// Python-specific prerelease identifiers per PEP 440, including\n/// shorthand notation like `a1` for alpha and `b2` for beta.\n/// Note: Post-releases (`.postN`) are stable releases per PEP 440.\npub fn is_prerelease_python(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains(\"dev\")\n        || v.contains(\"alpha\")\n        || v.contains(\"beta\")\n        || v.contains(\"rc\")\n        || (v.contains('a') \u0026\u0026 v.chars().last().is_some_and(|c| c.is_ascii_digit()))\n        || (v.contains('b') \u0026\u0026 v.chars().last().is_some_and(|c| c.is_ascii_digit()))\n        || v.contains(\".dev\")\n}\n\n/// Checks if a Go module version is a prerelease.\n///\n/// Go uses semver-like versions with hyphenated prerelease suffixes.\npub fn is_prerelease_go(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains(\"-rc\") || v.contains(\"-alpha\") || v.contains(\"-beta\") || v.contains(\"-pre\")\n}\n\n/// Checks if a PHP Composer package version is a prerelease.\n///\n/// Composer-specific stability flags including `dev` and common\n/// prerelease identifiers.\npub fn is_prerelease_php(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains(\"alpha\")\n        || v.contains(\"beta\")\n        || v.contains(\"rc\")\n        || v.contains(\"-rc\")\n        || v.contains(\"dev\")\n}\n\n/// Checks if a Dart/Flutter package version is a prerelease.\n///\n/// Dart uses semver with hyphenated prerelease suffixes and common\n/// prerelease identifiers.\npub fn is_prerelease_dart(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains('-')\n        || v.contains(\"dev\")\n        || v.contains(\"alpha\")\n        || v.contains(\"beta\")\n        || v.contains(\"rc\")\n}\n\n/// Checks if a NuGet package version is a prerelease.\n///\n/// NuGet-specific prerelease identifiers include `preview` in addition\n/// to common patterns.\npub fn is_prerelease_nuget(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains('-')\n        || v.contains(\"alpha\")\n        || v.contains(\"beta\")\n        || v.contains(\"preview\")\n        || v.contains(\"rc\")\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_is_prerelease_rust() {\n        assert!(is_prerelease_rust(\"1.0.0-alpha\"));\n        assert!(is_prerelease_rust(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_rust(\"1.0.0-rc1\"));\n        assert!(is_prerelease_rust(\"1.0.0-ALPHA\"));\n        assert!(!is_prerelease_rust(\"1.0.0\"));\n        assert!(!is_prerelease_rust(\"2.3.4\"));\n    }\n\n    #[test]\n    fn test_is_prerelease_npm() {\n        assert!(is_prerelease_npm(\"1.0.0-alpha\"));\n        assert!(is_prerelease_npm(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_npm(\"1.0.0-rc.1\"));\n        assert!(is_prerelease_npm(\"18.3.0-canary\"));\n        assert!(is_prerelease_npm(\"1.0.0-next.0\"));\n        assert!(!is_prerelease_npm(\"1.0.0\"));\n        assert!(!is_prerelease_npm(\"2.3.4\"));\n    }\n\n    #[test]\n    fn test_is_prerelease_python() {\n        assert!(is_prerelease_python(\"1.0.0a1\"));\n        assert!(is_prerelease_python(\"1.0.0b2\"));\n        assert!(is_prerelease_python(\"1.0.0rc1\"));\n        assert!(is_prerelease_python(\"1.0.0.dev1\"));\n        assert!(is_prerelease_python(\"2.0.0alpha\"));\n        assert!(is_prerelease_python(\"2.0.0beta\"));\n        assert!(!is_prerelease_python(\"1.0.0.post1\")); // post-releases are stable per PEP 440\n        assert!(!is_prerelease_python(\"1.0.0\"));\n        assert!(!is_prerelease_python(\"2.3.4\"));\n    }\n\n    #[test]\n    fn test_is_prerelease_go() {\n        assert!(is_prerelease_go(\"v1.0.0-rc1\"));\n        assert!(is_prerelease_go(\"v2.0.0-beta.1\"));\n        assert!(is_prerelease_go(\"v3.0.0-alpha\"));\n        assert!(is_prerelease_go(\"v1.0.0-pre.1\"));\n        assert!(!is_prerelease_go(\"v1.0.0\"));\n        assert!(!is_prerelease_go(\"v2.3.4\"));\n    }\n\n    #[test]\n    fn test_is_prerelease_php() {\n        assert!(is_prerelease_php(\"1.0.0-alpha\"));\n        assert!(is_prerelease_php(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_php(\"1.0.0-RC1\"));\n        assert!(is_prerelease_php(\"dev-master\"));\n        assert!(!is_prerelease_php(\"1.0.0\"));\n        assert!(!is_prerelease_php(\"v2.3.4\"));\n    }\n\n    #[test]\n    fn test_is_prerelease_dart() {\n        assert!(is_prerelease_dart(\"1.0.0-dev.1\"));\n        assert!(is_prerelease_dart(\"1.0.0-alpha\"));\n        assert!(is_prerelease_dart(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_dart(\"1.0.0-rc.1\"));\n        assert!(!is_prerelease_dart(\"1.0.0\"));\n        assert!(!is_prerelease_dart(\"2.0.0\"));\n    }\n\n    #[test]\n    fn test_is_prerelease_nuget() {\n        assert!(is_prerelease_nuget(\"1.0.0-alpha\"));\n        assert!(is_prerelease_nuget(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_nuget(\"1.0.0-preview\"));\n        assert!(is_prerelease_nuget(\"1.0.0-rc.1\"));\n        assert!(is_prerelease_nuget(\"1.0.0-Alpha\"));\n        assert!(!is_prerelease_nuget(\"1.0.0\"));\n        assert!(!is_prerelease_nuget(\"2.0.0\"));\n    }\n}\n","traces":[{"line":12,"address":[14444943,14444544,14444937],"length":1,"stats":{"Line":2}},{"line":13,"address":[14444573],"length":1,"stats":{"Line":2}},{"line":14,"address":[13006153,13006085],"length":1,"stats":{"Line":4}},{"line":21,"address":[12977712,12978312,12978306],"length":1,"stats":{"Line":2}},{"line":22,"address":[12977741],"length":1,"stats":{"Line":2}},{"line":23,"address":[12977857,12977912,12977774],"length":1,"stats":{"Line":6}},{"line":24,"address":[14711031,14711071],"length":1,"stats":{"Line":4}},{"line":25,"address":[12977980],"length":1,"stats":{"Line":2}},{"line":26,"address":[12978056],"length":1,"stats":{"Line":2}},{"line":27,"address":[14443268],"length":1,"stats":{"Line":2}},{"line":28,"address":[14443344],"length":1,"stats":{"Line":2}},{"line":36,"address":[14446419,14446425,14445488],"length":1,"stats":{"Line":2}},{"line":37,"address":[14713517],"length":1,"stats":{"Line":2}},{"line":38,"address":[13007038,13007121,13007195],"length":1,"stats":{"Line":8}},{"line":39,"address":[12980548,12980600],"length":1,"stats":{"Line":4}},{"line":40,"address":[14445787],"length":1,"stats":{"Line":4}},{"line":41,"address":[13007369],"length":1,"stats":{"Line":3}},{"line":42,"address":[12863136,12863140],"length":1,"stats":{"Line":10}},{"line":43,"address":[14446052,14446181,14446244],"length":1,"stats":{"Line":15}},{"line":44,"address":[14446219,14446348],"length":1,"stats":{"Line":6}},{"line":50,"address":[12977686,12977280,12977680],"length":1,"stats":{"Line":2}},{"line":51,"address":[14442445],"length":1,"stats":{"Line":2}},{"line":52,"address":[12977401,12977333],"length":1,"stats":{"Line":4}},{"line":59,"address":[14711985,14711991,14711472],"length":1,"stats":{"Line":2}},{"line":60,"address":[14711501],"length":1,"stats":{"Line":2}},{"line":61,"address":[14443667,14443528,14443605],"length":1,"stats":{"Line":6}},{"line":62,"address":[14443690,14443650],"length":1,"stats":{"Line":4}},{"line":63,"address":[13005223],"length":1,"stats":{"Line":2}},{"line":64,"address":[14443811],"length":1,"stats":{"Line":2}},{"line":65,"address":[13005375],"length":1,"stats":{"Line":2}},{"line":72,"address":[13005504,13006010,13006016],"length":1,"stats":{"Line":2}},{"line":73,"address":[13005533],"length":1,"stats":{"Line":2}},{"line":74,"address":[12978936,12979068,12979013],"length":1,"stats":{"Line":6}},{"line":75,"address":[13005675,13005715],"length":1,"stats":{"Line":5}},{"line":76,"address":[12979136],"length":1,"stats":{"Line":4}},{"line":77,"address":[14444348],"length":1,"stats":{"Line":2}},{"line":78,"address":[13005912],"length":1,"stats":{"Line":3}},{"line":85,"address":[14445472,14444960,14445466],"length":1,"stats":{"Line":2}},{"line":86,"address":[14712989],"length":1,"stats":{"Line":2}},{"line":87,"address":[14445016,14445093,14445148],"length":1,"stats":{"Line":6}},{"line":88,"address":[14445171,14445131],"length":1,"stats":{"Line":4}},{"line":89,"address":[14445216],"length":1,"stats":{"Line":2}},{"line":90,"address":[13006780],"length":1,"stats":{"Line":2}},{"line":91,"address":[13006856],"length":1,"stats":{"Line":3}}],"covered":44,"coverable":44},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","reports.rs"],"content":"//! Vulnerability report generation\n//!\n//! This module handles the generation of vulnerability reports\n//! in various formats (JSON, Markdown).\n\nuse serde::{Deserialize, Serialize};\nuse tower_lsp::lsp_types::Url;\n\n/// Summary of vulnerabilities grouped by severity level.\n///\n/// Used to provide an overview of the vulnerability scan results.\n#[derive(Debug, Clone, Default, Serialize, Deserialize)]\npub struct VulnerabilitySummary {\n    /// Total number of vulnerabilities found.\n    pub total: u32,\n    /// Number of critical severity vulnerabilities.\n    pub critical: u32,\n    /// Number of high severity vulnerabilities.\n    pub high: u32,\n    /// Number of medium severity vulnerabilities.\n    pub medium: u32,\n    /// Number of low severity vulnerabilities.\n    pub low: u32,\n}\n\n/// A single vulnerability entry in a report.\n///\n/// Contains all relevant information about a vulnerability affecting a package.\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct VulnerabilityReportEntry {\n    /// Name of the affected package.\n    pub package: String,\n    /// Version of the affected package.\n    pub version: String,\n    /// Vulnerability identifier (e.g., CVE-2021-1234, GHSA-xxxx).\n    pub id: String,\n    /// Severity level (critical, high, medium, low).\n    pub severity: String,\n    /// Human-readable description of the vulnerability.\n    pub description: String,\n    /// URL for more information about the vulnerability.\n    pub url: Option\u003cString\u003e,\n}\n\n/// Generate a Markdown-formatted vulnerability report.\n///\n/// Creates a human-readable report with a summary table and detailed\n/// vulnerability entries grouped by package.\npub fn generate_markdown_report(\n    uri: \u0026Url,\n    summary: \u0026VulnerabilitySummary,\n    vulnerabilities: \u0026[VulnerabilityReportEntry],\n) -\u003e String {\n    let mut lines = vec![\n        \"# Vulnerability Report\".to_string(),\n        String::new(),\n        format!(\"**File**: {}\", uri.path()),\n        format!(\"**Date**: {}\", chrono::Local::now().format(\"%Y-%m-%d\")),\n        String::new(),\n        \"## Summary\".to_string(),\n        \"| Severity | Count |\".to_string(),\n        \"|----------|-------|\".to_string(),\n        format!(\"| ⚠ Critical | {} |\", summary.critical),\n        format!(\"| ▲ High | {} |\", summary.high),\n        format!(\"| ● Medium | {} |\", summary.medium),\n        format!(\"| ○ Low | {} |\", summary.low),\n        format!(\"| **Total** | **{}** |\", summary.total),\n        String::new(),\n    ];\n\n    if !vulnerabilities.is_empty() {\n        lines.push(\"## Vulnerabilities\".to_string());\n        lines.push(String::new());\n\n        let mut current_package = String::new();\n        let mut current_version = String::new();\n        for vuln in vulnerabilities {\n            if vuln.package != current_package || vuln.version != current_version {\n                current_package = vuln.package.clone();\n                current_version = vuln.version.clone();\n                lines.push(format!(\"### {}@{}\", vuln.package, vuln.version));\n                lines.push(String::new());\n            }\n\n            let severity_icon = match vuln.severity.as_str() {\n                \"critical\" =\u003e \"⚠\",\n                \"high\" =\u003e \"▲\",\n                \"medium\" =\u003e \"●\",\n                _ =\u003e \"○\",\n            };\n\n            if let Some(url) = \u0026vuln.url {\n                lines.push(format!(\n                    \"- **[{}]({})** ({} {}): {}\",\n                    vuln.id,\n                    url,\n                    severity_icon,\n                    vuln.severity.to_uppercase(),\n                    vuln.description\n                ));\n            } else {\n                lines.push(format!(\n                    \"- **{}** ({} {}): {}\",\n                    vuln.id,\n                    severity_icon,\n                    vuln.severity.to_uppercase(),\n                    vuln.description\n                ));\n            }\n        }\n    } else {\n        lines.push(\"## No vulnerabilities found\".to_string());\n        lines.push(String::new());\n        lines.push(\"✅ All dependencies are free of known security vulnerabilities.\".to_string());\n    }\n\n    lines.join(\"\\n\")\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_generate_markdown_report_with_vulnerabilities() {\n        let uri = Url::parse(\"file:///project/Cargo.toml\").unwrap();\n        let summary = VulnerabilitySummary {\n            total: 2,\n            critical: 1,\n            high: 1,\n            medium: 0,\n            low: 0,\n        };\n        let vulnerabilities = vec![\n            VulnerabilityReportEntry {\n                package: \"serde\".to_string(),\n                version: \"1.0.0\".to_string(),\n                id: \"CVE-2021-1234\".to_string(),\n                severity: \"critical\".to_string(),\n                description: \"Critical vulnerability\".to_string(),\n                url: Some(\"https://example.com/cve\".to_string()),\n            },\n            VulnerabilityReportEntry {\n                package: \"tokio\".to_string(),\n                version: \"1.0.0\".to_string(),\n                id: \"CVE-2021-5678\".to_string(),\n                severity: \"high\".to_string(),\n                description: \"High vulnerability\".to_string(),\n                url: None,\n            },\n        ];\n\n        let report = generate_markdown_report(\u0026uri, \u0026summary, \u0026vulnerabilities);\n\n        assert!(report.contains(\"# Vulnerability Report\"));\n        assert!(report.contains(\"**File**: /project/Cargo.toml\"));\n        assert!(report.contains(\"| ⚠ Critical | 1 |\"));\n        assert!(report.contains(\"| ▲ High | 1 |\"));\n        assert!(report.contains(\"### serde@1.0.0\"));\n        assert!(report.contains(\"### tokio@1.0.0\"));\n        assert!(report.contains(\"CVE-2021-1234\"));\n        assert!(report.contains(\"CVE-2021-5678\"));\n    }\n\n    #[test]\n    fn test_generate_markdown_report_same_package_different_versions() {\n        let uri = Url::parse(\"file:///project/Cargo.toml\").unwrap();\n        let summary = VulnerabilitySummary {\n            total: 2,\n            critical: 1,\n            high: 1,\n            medium: 0,\n            low: 0,\n        };\n        let vulnerabilities = vec![\n            VulnerabilityReportEntry {\n                package: \"serde\".to_string(),\n                version: \"1.0.0\".to_string(),\n                id: \"CVE-2021-1111\".to_string(),\n                severity: \"critical\".to_string(),\n                description: \"Old version vulnerability\".to_string(),\n                url: None,\n            },\n            VulnerabilityReportEntry {\n                package: \"serde\".to_string(),\n                version: \"2.0.0\".to_string(),\n                id: \"CVE-2021-2222\".to_string(),\n                severity: \"high\".to_string(),\n                description: \"New version vulnerability\".to_string(),\n                url: None,\n            },\n        ];\n\n        let report = generate_markdown_report(\u0026uri, \u0026summary, \u0026vulnerabilities);\n\n        assert!(report.contains(\"### serde@1.0.0\"));\n        assert!(report.contains(\"### serde@2.0.0\"));\n        assert!(report.contains(\"CVE-2021-1111\"));\n        assert!(report.contains(\"CVE-2021-2222\"));\n    }\n\n    #[test]\n    fn test_generate_markdown_report_no_vulnerabilities() {\n        let uri = Url::parse(\"file:///project/Cargo.toml\").unwrap();\n        let summary = VulnerabilitySummary::default();\n        let vulnerabilities = vec![];\n\n        let report = generate_markdown_report(\u0026uri, \u0026summary, \u0026vulnerabilities);\n\n        assert!(report.contains(\"# Vulnerability Report\"));\n        assert!(report.contains(\"## No vulnerabilities found\"));\n        assert!(report.contains(\"✅ All dependencies are free of known security vulnerabilities.\"));\n    }\n}\n","traces":[{"line":49,"address":[17152352,17157057,17157714],"length":1,"stats":{"Line":2}},{"line":54,"address":[13928314,13928757,13927393,13929119,13927799,13928574,13929278,13932706,13928394,13927496,13928095,13927572,13928940,13929860,13927437,13928170,13929322,13928242],"length":1,"stats":{"Line":8}},{"line":55,"address":[13927406],"length":1,"stats":{"Line":5}},{"line":56,"address":[14596797],"length":1,"stats":{"Line":4}},{"line":57,"address":[14596853,14596937],"length":1,"stats":{"Line":9}},{"line":58,"address":[13946068,13946131],"length":1,"stats":{"Line":9}},{"line":59,"address":[14597377],"length":1,"stats":{"Line":5}},{"line":60,"address":[13946427],"length":1,"stats":{"Line":4}},{"line":61,"address":[13928211],"length":1,"stats":{"Line":4}},{"line":62,"address":[13946571],"length":1,"stats":{"Line":5}},{"line":63,"address":[13928435,13928363],"length":1,"stats":{"Line":9}},{"line":64,"address":[17153576,17153651],"length":1,"stats":{"Line":9}},{"line":65,"address":[14598015,14598090],"length":1,"stats":{"Line":9}},{"line":66,"address":[13947272,13947197],"length":1,"stats":{"Line":9}},{"line":67,"address":[14598381,14598452],"length":1,"stats":{"Line":9}},{"line":68,"address":[13929271],"length":1,"stats":{"Line":4}},{"line":71,"address":[14599127,14599205],"length":1,"stats":{"Line":9}},{"line":72,"address":[13929995,13929930],"length":1,"stats":{"Line":8}},{"line":73,"address":[13930030],"length":1,"stats":{"Line":4}},{"line":75,"address":[13948360],"length":1,"stats":{"Line":3}},{"line":76,"address":[13930087],"length":1,"stats":{"Line":3}},{"line":77,"address":[13930238,13930154],"length":1,"stats":{"Line":6}},{"line":78,"address":[17155479,17155551,17155373],"length":1,"stats":{"Line":6}},{"line":79,"address":[13930507,13930568,13930587],"length":1,"stats":{"Line":4}},{"line":80,"address":[13948990,13949032],"length":1,"stats":{"Line":3}},{"line":81,"address":[13930859],"length":1,"stats":{"Line":3}},{"line":82,"address":[14600354],"length":1,"stats":{"Line":3}},{"line":85,"address":[13931130,13930544],"length":1,"stats":{"Line":6}},{"line":86,"address":[14600485,14600419],"length":1,"stats":{"Line":6}},{"line":87,"address":[14600462,14600560,14600521],"length":1,"stats":{"Line":8}},{"line":88,"address":[13931355,13931264,13931320],"length":1,"stats":{"Line":0}},{"line":89,"address":[13931326],"length":1,"stats":{"Line":0}},{"line":92,"address":[17156411],"length":1,"stats":{"Line":3}},{"line":93,"address":[13949862,13949744],"length":1,"stats":{"Line":4}},{"line":98,"address":[13931542,13931468],"length":1,"stats":{"Line":4}},{"line":102,"address":[13950371,13949785],"length":1,"stats":{"Line":4}},{"line":106,"address":[13931508,13932052],"length":1,"stats":{"Line":4}},{"line":112,"address":[14601755,14599242],"length":1,"stats":{"Line":4}},{"line":113,"address":[13950809],"length":1,"stats":{"Line":2}},{"line":114,"address":[13932555],"length":1,"stats":{"Line":2}},{"line":117,"address":[13932639,13930416],"length":1,"stats":{"Line":4}}],"covered":39,"coverable":41},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","utils.rs"],"content":"//! Common utility functions used across the LSP implementation.\n\n/// Truncates a string to a maximum character count with ellipsis.\n///\n/// This function properly handles UTF-8 strings by counting characters,\n/// not bytes. If the string needs truncation, an ellipsis (\"...\") is\n/// appended and counted toward the maximum length.\n///\n/// # Arguments\n///\n/// * `s` - The string to truncate\n/// * `max_chars` - Maximum number of characters to display (including ellipsis)\n///\n/// # Returns\n///\n/// The truncated string, or the original string if it fits within `max_chars`.\npub fn truncate_string(s: \u0026str, max_chars: usize) -\u003e String {\n    let char_count = s.chars().count();\n    if char_count \u003c= max_chars {\n        return s.to_string();\n    }\n\n    let keep_chars = max_chars.saturating_sub(3);\n    let truncated: String = s.chars().take(keep_chars).collect();\n    format!(\"{}...\", truncated)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_no_truncation_needed() {\n        assert_eq!(truncate_string(\"hello\", 10), \"hello\");\n        assert_eq!(truncate_string(\"\", 10), \"\");\n        assert_eq!(truncate_string(\"hello\", 5), \"hello\");\n    }\n\n    #[test]\n    fn test_ascii_truncation() {\n        assert_eq!(truncate_string(\"hello world\", 8), \"hello...\");\n        assert_eq!(truncate_string(\"abcdefghij\", 7), \"abcd...\");\n    }\n\n    #[test]\n    fn test_edge_cases() {\n        assert_eq!(truncate_string(\"hello\", 3), \"...\");\n        assert_eq!(truncate_string(\"hello\", 4), \"h...\");\n        assert_eq!(truncate_string(\"ab\", 1), \"...\");\n        assert_eq!(truncate_string(\"a\", 0), \"...\");\n    }\n\n    #[test]\n    fn test_utf8_japanese() {\n        // \"日本語\" = 3 characters, 9 bytes\n        assert_eq!(truncate_string(\"日本語\", 10), \"日本語\");\n        assert_eq!(truncate_string(\"日本語\", 3), \"日本語\");\n        // \"日本語test\" = 7 characters\n        // truncate to 6 means keep 3 + \"...\" = 6 total\n        assert_eq!(truncate_string(\"日本語test\", 6), \"日本語...\");\n        // 7 chars \u003c= 8, so no truncation needed\n        assert_eq!(truncate_string(\"日本語test\", 8), \"日本語test\");\n        // 7 chars \u003c= 7, so no truncation needed\n        assert_eq!(truncate_string(\"日本語test\", 7), \"日本語test\");\n        // truncate to 5 means keep 2 + \"...\" = 5\n        assert_eq!(truncate_string(\"日本語test\", 5), \"日本...\");\n    }\n\n    #[test]\n    fn test_utf8_emoji() {\n        // \"hello\" = 5 characters, fits in 8\n        assert_eq!(truncate_string(\"hello\", 8), \"hello\");\n        // \"hello world\" = 11 characters, truncate to 8 means keep 5 + \"...\"\n        let emoji_str = \"hello world\";\n        assert_eq!(truncate_string(emoji_str, 8), \"hello...\");\n    }\n\n    #[test]\n    fn test_mixed_content() {\n        assert_eq!(truncate_string(\"Hello 日本\", 10), \"Hello 日本\");\n        assert_eq!(truncate_string(\"Hello 日本語 world\", 12), \"Hello 日本語...\");\n    }\n}\n","traces":[{"line":17,"address":[13690054,13690060,13689648],"length":1,"stats":{"Line":2}},{"line":18,"address":[13840856],"length":1,"stats":{"Line":2}},{"line":19,"address":[13840885],"length":1,"stats":{"Line":2}},{"line":20,"address":[13859319],"length":1,"stats":{"Line":2}},{"line":23,"address":[13840900],"length":1,"stats":{"Line":2}},{"line":24,"address":[13840928],"length":1,"stats":{"Line":4}},{"line":25,"address":[13841083,13840989],"length":1,"stats":{"Line":9}}],"covered":7,"coverable":7},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","vulnerabilities","cache.rs"],"content":"//! Vulnerability cache for tracking queried packages\n//!\n//! Tracks which packages have been queried for vulnerabilities to avoid\n//! redundant API calls. The actual vulnerability data is stored in the\n//! version cache alongside version information.\n\nuse std::fmt::Display;\nuse std::sync::Arc;\nuse std::time::{Duration, Instant};\n\nuse dashmap::DashMap;\n\nuse super::Ecosystem;\n\n/// Default TTL for vulnerability cache (6 hours)\nconst DEFAULT_VULN_CACHE_TTL: Duration = Duration::from_secs(6 * 3600);\n\n/// Cache key for vulnerability lookups\n#[derive(Debug, Clone, Hash, PartialEq, Eq)]\npub struct VulnCacheKey {\n    /// Target ecosystem\n    pub ecosystem: Ecosystem,\n    /// Package name\n    pub package_name: String,\n    /// Package version\n    pub version: String,\n}\n\nimpl VulnCacheKey {\n    /// Create a new cache key\n    pub fn new(ecosystem: Ecosystem, package_name: \u0026str, version: \u0026str) -\u003e Self {\n        Self {\n            ecosystem,\n            package_name: package_name.to_string(),\n            version: version.to_string(),\n        }\n    }\n}\n\n/// Tracks when a package was queried for vulnerabilities\nstruct VulnCacheEntry {\n    /// When the entry was inserted\n    inserted_at: Instant,\n}\n\n/// Cleanup interval for background task (30 minutes)\nconst CLEANUP_INTERVAL: Duration = Duration::from_secs(30 * 60);\n\n/// Tracks which packages have been queried for vulnerabilities\n///\n/// This is a \"seen set\" with TTL - it prevents redundant API calls to OSV.dev\n/// by tracking which package@version combinations have already been queried.\n/// The actual vulnerability data is stored in the version cache.\n#[derive(Clone)]\npub struct VulnerabilityCache {\n    /// Cache entries (package key -\u003e query timestamp)\n    entries: Arc\u003cDashMap\u003cVulnCacheKey, VulnCacheEntry\u003e\u003e,\n    /// Cache TTL\n    ttl: Duration,\n}\n\nimpl VulnerabilityCache {\n    /// Create a new cache with default TTL (6 hours) and spawn background cleanup\n    pub fn new() -\u003e Self {\n        let cache = Self {\n            entries: Arc::new(DashMap::new()),\n            ttl: DEFAULT_VULN_CACHE_TTL,\n        };\n        Self::spawn_cleanup_task(cache.clone());\n        cache\n    }\n\n    fn spawn_cleanup_task(cache: VulnerabilityCache) {\n        tokio::spawn(async move {\n            let mut interval = tokio::time::interval(CLEANUP_INTERVAL);\n            interval.tick().await; // Skip immediate first tick\n\n            loop {\n                interval.tick().await;\n\n                let stats = cache.stats();\n                let removed = cache.cleanup_expired();\n                if removed \u003e 0 {\n                    tracing::info!(\n                        \"Background cleanup: removed {} expired entries from vulnerability cache (was: {})\",\n                        removed,\n                        stats\n                    );\n                }\n            }\n        });\n    }\n\n    /// Create a cache with custom TTL in seconds (no background cleanup for tests)\n    #[cfg(test)]\n    pub fn with_ttl(ttl_secs: u64) -\u003e Self {\n        Self {\n            entries: Arc::new(DashMap::new()),\n            ttl: Duration::from_secs(ttl_secs),\n        }\n    }\n\n    /// Mark a package as having been queried for vulnerabilities\n    pub fn insert(\u0026self, key: VulnCacheKey) {\n        self.entries.insert(\n            key,\n            VulnCacheEntry {\n                inserted_at: Instant::now(),\n            },\n        );\n    }\n\n    /// Check if a package has been queried (and the query hasn't expired)\n    pub fn contains(\u0026self, key: \u0026VulnCacheKey) -\u003e bool {\n        self.entries\n            .get(key)\n            .is_some_and(|entry| entry.inserted_at.elapsed() \u003c self.ttl)\n    }\n\n    /// Clear all entries from cache\n    #[cfg(test)]\n    pub fn clear(\u0026self) {\n        self.entries.clear();\n    }\n\n    /// Get the number of entries in the cache\n    #[cfg(test)]\n    pub fn len(\u0026self) -\u003e usize {\n        self.entries.len()\n    }\n\n    /// Check if the cache is empty\n    #[cfg(test)]\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.entries.is_empty()\n    }\n\n    pub fn cleanup_expired(\u0026self) -\u003e usize {\n        let before = self.entries.len();\n        self.entries\n            .retain(|_, entry| entry.inserted_at.elapsed() \u003c self.ttl);\n        let removed = before - self.entries.len();\n        if removed \u003e 0 {\n            tracing::debug!(\n                \"Cleaned up {} expired vulnerability cache entries ({} remaining)\",\n                removed,\n                self.entries.len()\n            );\n        }\n        removed\n    }\n\n    pub fn stats(\u0026self) -\u003e VulnCacheStats {\n        let total = self.entries.len();\n        let expired = self\n            .entries\n            .iter()\n            .filter(|e| e.inserted_at.elapsed() \u003e= self.ttl)\n            .count();\n        VulnCacheStats {\n            total_entries: total,\n            expired_entries: expired,\n            valid_entries: total.saturating_sub(expired),\n        }\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct VulnCacheStats {\n    pub total_entries: usize,\n    pub expired_entries: usize,\n    pub valid_entries: usize,\n}\n\nimpl Display for VulnCacheStats {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        write!(\n            f,\n            \"VulnCacheStats {{ total: {}, expired: {}, valid: {} }}\",\n            self.total_entries, self.expired_entries, self.valid_entries\n        )\n    }\n}\n\nimpl Default for VulnerabilityCache {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_cache_insert_and_contains() {\n        let cache = VulnerabilityCache::with_ttl(3600);\n        let key = VulnCacheKey::new(Ecosystem::Npm, \"lodash\", \"4.17.0\");\n\n        assert!(!cache.contains(\u0026key));\n        cache.insert(key.clone());\n        assert!(cache.contains(\u0026key));\n    }\n\n    #[test]\n    fn test_cache_clear() {\n        let cache = VulnerabilityCache::with_ttl(3600);\n        let key = VulnCacheKey::new(Ecosystem::PyPI, \"requests\", \"2.28.0\");\n\n        cache.insert(key.clone());\n        assert_eq!(cache.len(), 1);\n\n        cache.clear();\n        assert!(cache.is_empty());\n    }\n\n    #[test]\n    fn test_cache_with_custom_ttl() {\n        let cache = VulnerabilityCache::with_ttl(3600);\n        assert_eq!(cache.ttl, Duration::from_secs(3600));\n    }\n\n    #[test]\n    fn test_vuln_cache_cleanup_expired() {\n        // Use 10ms TTL for fast test\n        let cache = VulnerabilityCache::with_ttl(0); // 0 seconds = immediate expiry\n        let key1 = VulnCacheKey::new(Ecosystem::Npm, \"pkg1\", \"1.0.0\");\n        let key2 = VulnCacheKey::new(Ecosystem::Npm, \"pkg2\", \"1.0.0\");\n\n        cache.insert(key1);\n        cache.insert(key2);\n\n        assert_eq!(cache.len(), 2);\n\n        // Wait for expiration\n        std::thread::sleep(Duration::from_millis(10));\n\n        let removed = cache.cleanup_expired();\n        assert_eq!(removed, 2);\n        assert_eq!(cache.len(), 0);\n    }\n\n    #[test]\n    fn test_vuln_cache_stats() {\n        let cache = VulnerabilityCache::with_ttl(0); // Immediate expiry\n        let key1 = VulnCacheKey::new(Ecosystem::Npm, \"pkg1\", \"1.0.0\");\n        let key2 = VulnCacheKey::new(Ecosystem::Npm, \"pkg2\", \"1.0.0\");\n\n        cache.insert(key1);\n        cache.insert(key2);\n\n        // Wait for expiration\n        std::thread::sleep(Duration::from_millis(10));\n\n        let stats = cache.stats();\n        assert_eq!(stats.total_entries, 2);\n        assert_eq!(stats.expired_entries, 2);\n        assert_eq!(stats.valid_entries, 0);\n    }\n\n    #[test]\n    fn test_vuln_cache_stats_display() {\n        let stats = VulnCacheStats {\n            total_entries: 5,\n            expired_entries: 2,\n            valid_entries: 3,\n        };\n        let display = format!(\"{}\", stats);\n        assert!(display.contains(\"total: 5\"));\n        assert!(display.contains(\"expired: 2\"));\n        assert!(display.contains(\"valid: 3\"));\n    }\n}\n","traces":[{"line":31,"address":[16268102,16267856,16268108],"length":1,"stats":{"Line":8}},{"line":34,"address":[14401735],"length":1,"stats":{"Line":4}},{"line":35,"address":[16267982],"length":1,"stats":{"Line":8}},{"line":64,"address":[13080432,13080612,13080618],"length":1,"stats":{"Line":0}},{"line":66,"address":[13109377],"length":1,"stats":{"Line":0}},{"line":69,"address":[16268954,16268997],"length":1,"stats":{"Line":0}},{"line":70,"address":[13080578],"length":1,"stats":{"Line":0}},{"line":73,"address":[14402560],"length":1,"stats":{"Line":0}},{"line":74,"address":[13109284],"length":1,"stats":{"Line":0}},{"line":75,"address":[12991473],"length":1,"stats":{"Line":0}},{"line":76,"address":[12991670,12991757,12991517,12991597],"length":1,"stats":{"Line":0}},{"line":79,"address":[12991981,12991538,12992002,12991948,12992827],"length":1,"stats":{"Line":0}},{"line":81,"address":[13956753],"length":1,"stats":{"Line":0}},{"line":82,"address":[13975069],"length":1,"stats":{"Line":0}},{"line":83,"address":[13975102],"length":1,"stats":{"Line":0}},{"line":84,"address":[13956829],"length":1,"stats":{"Line":0}},{"line":96,"address":[14403456,14403602,14403596],"length":1,"stats":{"Line":8}},{"line":98,"address":[14403489],"length":1,"stats":{"Line":9}},{"line":99,"address":[14403514],"length":1,"stats":{"Line":10}},{"line":104,"address":[13109760,13109996],"length":1,"stats":{"Line":6}},{"line":105,"address":[13109946,13109774],"length":1,"stats":{"Line":14}},{"line":106,"address":[13109842],"length":1,"stats":{"Line":6}},{"line":108,"address":[13080959],"length":1,"stats":{"Line":6}},{"line":114,"address":[16269552],"length":1,"stats":{"Line":2}},{"line":115,"address":[13081127],"length":1,"stats":{"Line":2}},{"line":116,"address":[16269587],"length":1,"stats":{"Line":2}},{"line":117,"address":[13975920,13975952],"length":1,"stats":{"Line":6}},{"line":122,"address":[14402864],"length":1,"stats":{"Line":2}},{"line":123,"address":[14402869],"length":1,"stats":{"Line":2}},{"line":128,"address":[14402640],"length":1,"stats":{"Line":4}},{"line":129,"address":[14402645],"length":1,"stats":{"Line":4}},{"line":134,"address":[16269632],"length":1,"stats":{"Line":2}},{"line":135,"address":[14403429],"length":1,"stats":{"Line":2}},{"line":138,"address":[13108624],"length":1,"stats":{"Line":2}},{"line":139,"address":[14401940],"length":1,"stats":{"Line":2}},{"line":140,"address":[13108677],"length":1,"stats":{"Line":2}},{"line":141,"address":[13079763],"length":1,"stats":{"Line":6}},{"line":142,"address":[14402051,14401994],"length":1,"stats":{"Line":2}},{"line":143,"address":[16268249],"length":1,"stats":{"Line":2}},{"line":144,"address":[13108984,13108787],"length":1,"stats":{"Line":1}},{"line":153,"address":[13080640],"length":1,"stats":{"Line":2}},{"line":154,"address":[13080676],"length":1,"stats":{"Line":2}},{"line":155,"address":[13080708],"length":1,"stats":{"Line":2}},{"line":158,"address":[13109660],"length":1,"stats":{"Line":6}},{"line":163,"address":[13080780],"length":1,"stats":{"Line":2}},{"line":176,"address":[13081968],"length":1,"stats":{"Line":2}},{"line":177,"address":[13081999],"length":1,"stats":{"Line":2}},{"line":186,"address":[13082384],"length":1,"stats":{"Line":0}},{"line":187,"address":[13082392],"length":1,"stats":{"Line":0}}],"covered":34,"coverable":49},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","vulnerabilities","mod.rs"],"content":"//! Vulnerability scanning for dependencies\n//!\n//! This module provides vulnerability detection using OSV.dev API\n//! as the primary source for all ecosystems.\n\npub mod cache;\npub mod osv;\n\n/// Ecosystem identifiers for vulnerability sources\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub enum Ecosystem {\n    /// Rust crates (crates.io)\n    CratesIo,\n    /// JavaScript/Node packages (npm)\n    Npm,\n    /// Python packages (PyPI)\n    PyPI,\n    /// Go modules\n    Go,\n    /// PHP packages (Packagist)\n    Packagist,\n    /// Dart/Flutter packages (pub.dev)\n    Pub,\n    /// .NET packages (NuGet)\n    NuGet,\n    /// Ruby gems (RubyGems.org)\n    RubyGems,\n}\n\nimpl Ecosystem {\n    /// Convert to OSV.dev ecosystem string\n    pub fn as_osv_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Ecosystem::CratesIo =\u003e \"crates.io\",\n            Ecosystem::Npm =\u003e \"npm\",\n            Ecosystem::PyPI =\u003e \"PyPI\",\n            Ecosystem::Go =\u003e \"Go\",\n            Ecosystem::Packagist =\u003e \"Packagist\",\n            Ecosystem::Pub =\u003e \"Pub\",\n            Ecosystem::NuGet =\u003e \"NuGet\",\n            Ecosystem::RubyGems =\u003e \"RubyGems\",\n        }\n    }\n}\n\n/// Query for vulnerability lookup\n#[derive(Debug, Clone)]\npub struct VulnerabilityQuery {\n    /// Package name\n    pub package_name: String,\n    /// Package version (normalized, without ^ or ~ prefixes)\n    pub version: String,\n    /// Target ecosystem\n    pub ecosystem: Ecosystem,\n}\n","traces":[{"line":32,"address":[13034880],"length":1,"stats":{"Line":2}},{"line":33,"address":[12976725],"length":1,"stats":{"Line":2}},{"line":34,"address":[13367268],"length":1,"stats":{"Line":2}},{"line":35,"address":[13034942],"length":1,"stats":{"Line":2}},{"line":36,"address":[13034968],"length":1,"stats":{"Line":2}},{"line":37,"address":[12976831],"length":1,"stats":{"Line":2}},{"line":38,"address":[12976854],"length":1,"stats":{"Line":2}},{"line":39,"address":[12976877],"length":1,"stats":{"Line":2}},{"line":40,"address":[12976900],"length":1,"stats":{"Line":2}},{"line":41,"address":[12976923],"length":1,"stats":{"Line":0}}],"covered":9,"coverable":10},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","vulnerabilities","osv.rs"],"content":"//! OSV.dev API client for vulnerability data\n//!\n//! OSV (Open Source Vulnerabilities) provides a unified API for querying\n//! vulnerability data across multiple ecosystems.\n\nuse std::sync::Arc;\nuse std::time::Duration;\n\nuse reqwest::Client;\nuse serde::{Deserialize, Serialize};\n\nuse super::VulnerabilityQuery;\nuse crate::registries::{Vulnerability, VulnerabilitySeverity};\n\nconst OSV_API_BASE: \u0026str = \"https://api.osv.dev/v1\";\n\n/// Result of a vulnerability query\n#[derive(Debug, Clone, Default)]\npub struct QueryResult {\n    pub vulnerabilities: Vec\u003cVulnerability\u003e,\n    pub deprecated: bool,\n}\n\n/// OSV.dev API client\npub struct OsvClient {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl OsvClient {\n    pub fn new() -\u003e anyhow::Result\u003cSelf\u003e {\n        let client = Client::builder()\n            .user_agent(\"dependi-lsp (https://github.com/mathieu/zed-dependi)\")\n            .timeout(Duration::from_secs(30))\n            .build()?;\n\n        Ok(Self {\n            client: Arc::new(client),\n            base_url: OSV_API_BASE.to_string(),\n        })\n    }\n\n    fn convert_vulnerability(osv: \u0026OsvVulnerability) -\u003e Vulnerability {\n        let id = osv\n            .aliases\n            .as_ref()\n            .and_then(|a| a.iter().find(|id| id.starts_with(\"CVE-\")))\n            .cloned()\n            .unwrap_or_else(|| osv.id.clone());\n\n        let severity = osv\n            .severity\n            .as_ref()\n            .and_then(|s| s.first())\n            .map(|s| parse_cvss_severity(\u0026s.score))\n            .unwrap_or(VulnerabilitySeverity::Medium);\n\n        let description = osv\n            .summary\n            .clone()\n            .or_else(|| osv.details.clone())\n            .unwrap_or_else(|| format!(\"Vulnerability {}\", osv.id));\n\n        let url = osv.references.as_ref().and_then(|refs| {\n            refs.iter()\n                .find(|r| r._ref_type == \"ADVISORY\" || r._ref_type == \"WEB\")\n                .map(|r| r.url.clone())\n        });\n\n        Vulnerability {\n            id,\n            severity,\n            description,\n            url,\n        }\n    }\n}\n\nimpl Default for OsvClient {\n    fn default() -\u003e Self {\n        Self::new().expect(\"Failed to create OsvClient\")\n    }\n}\n\nfn parse_cvss_severity(score: \u0026str) -\u003e VulnerabilitySeverity {\n    if let Ok(score) = score.parse::\u003cf64\u003e() {\n        return match score {\n            s if s \u003e= 9.0 =\u003e VulnerabilitySeverity::Critical,\n            s if s \u003e= 7.0 =\u003e VulnerabilitySeverity::High,\n            s if s \u003e= 4.0 =\u003e VulnerabilitySeverity::Medium,\n            _ =\u003e VulnerabilitySeverity::Low,\n        };\n    }\n\n    if score.starts_with(\"CVSS:\") {\n        return VulnerabilitySeverity::Medium;\n    }\n\n    VulnerabilitySeverity::Medium\n}\n\nimpl OsvClient {\n    pub async fn query_batch(\n        \u0026self,\n        queries: \u0026[VulnerabilityQuery],\n    ) -\u003e anyhow::Result\u003cVec\u003cQueryResult\u003e\u003e {\n        if queries.is_empty() {\n            return Ok(vec![]);\n        }\n\n        let request = OsvBatchRequest {\n            queries: queries\n                .iter()\n                .map(|q| OsvQueryRequest {\n                    package: OsvPackage {\n                        name: q.package_name.clone(),\n                        ecosystem: q.ecosystem.as_osv_str().to_string(),\n                    },\n                    version: Some(q.version.clone()),\n                })\n                .collect(),\n        };\n\n        let url = format!(\"{}/querybatch\", self.base_url);\n        let response = self.client.post(\u0026url).json(\u0026request).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\"OSV API batch error: {}\", response.status());\n        }\n\n        let batch_response: OsvBatchResponse = response.json().await?;\n\n        let mut results = Vec::new();\n\n        for r in \u0026batch_response.results {\n            let vulnerabilities = r\n                .vulns\n                .as_ref()\n                .unwrap_or(\u0026vec![])\n                .iter()\n                .map(Self::convert_vulnerability)\n                .collect();\n\n            let rustsec_ids: Vec\u003cString\u003e = r\n                .vulns\n                .as_ref()\n                .unwrap_or(\u0026vec![])\n                .iter()\n                .filter(|v| v.id.starts_with(\"RUSTSEC-\"))\n                .map(|v| v.id.clone())\n                .collect();\n\n            let has_unmaintained = self.check_rustsec_unmaintained(\u0026rustsec_ids).await;\n\n            results.push(QueryResult {\n                vulnerabilities,\n                deprecated: has_unmaintained,\n            });\n        }\n\n        Ok(results)\n    }\n\n    async fn check_rustsec_unmaintained(\u0026self, ids: \u0026[String]) -\u003e bool {\n        if ids.is_empty() {\n            return false;\n        }\n\n        tracing::debug!(\n            \"Checking {} RUSTSEC advisories for unmaintained status\",\n            ids.len()\n        );\n\n        // Spawn all tasks in parallel\n        let tasks: Vec\u003c_\u003e = ids\n            .iter()\n            .map(|id| {\n                let url = format!(\"{}/vulns/{}\", self.base_url, id);\n                let client = Arc::clone(\u0026self.client);\n                let id_clone = id.clone();\n\n                tokio::spawn(async move {\n                    let response = match client.get(\u0026url).send().await {\n                        Ok(r) =\u003e r,\n                        Err(e) =\u003e {\n                            tracing::warn!(\"Failed to fetch advisory {}: {}\", id_clone, e);\n                            return false;\n                        }\n                    };\n\n                    let details: Option\u003cOsvVulnerabilityDetails\u003e = match response.json().await {\n                        Ok(d) =\u003e d,\n                        Err(e) =\u003e {\n                            tracing::warn!(\"Failed to parse advisory {}: {}\", id_clone, e);\n                            return false;\n                        }\n                    };\n\n                    let is_unmaintained = details.as_ref().is_some_and(|v| {\n                        // Check summary for \"maintained\" or \"deprecated\" keywords\n                        let summary_match = v.summary.as_ref().is_some_and(|s| {\n                            let lower = s.to_lowercase();\n                            lower.contains(\"maintained\") || lower.contains(\"deprecated\")\n                        });\n\n                        // Check database_specific.informational for \"unmaintained\"\n                        let informational_match = v.affected.as_ref().is_some_and(|affected| {\n                            affected.iter().any(|a| {\n                                a.database_specific.as_ref().is_some_and(|db| {\n                                    db.informational\n                                        .as_ref()\n                                        .is_some_and(|i| i == \"unmaintained\")\n                                })\n                            })\n                        });\n\n                        summary_match || informational_match\n                    });\n\n                    if is_unmaintained {\n                        tracing::info!(\n                            \"Advisory {} indicates unmaintained package: {}\",\n                            id_clone,\n                            details\n                                .as_ref()\n                                .and_then(|v| v.summary.as_ref())\n                                .unwrap_or(\u0026String::new())\n                        );\n                    }\n\n                    is_unmaintained\n                })\n            })\n            .collect();\n\n        // Wait for ALL tasks to complete in parallel using join_all\n        let results = futures::future::join_all(tasks).await;\n\n        // Check if any task returned true (found unmaintained package)\n        results.into_iter().any(|r| r.unwrap_or(false))\n    }\n}\n\n#[derive(Debug, Serialize)]\nstruct OsvQueryRequest {\n    package: OsvPackage,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    version: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize)]\nstruct OsvPackage {\n    name: String,\n    ecosystem: String,\n}\n\n#[derive(Debug, Serialize)]\nstruct OsvBatchRequest {\n    queries: Vec\u003cOsvQueryRequest\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvQueryResponse {\n    vulns: Option\u003cVec\u003cOsvVulnerability\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvBatchResponse {\n    results: Vec\u003cOsvQueryResponse\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvVulnerability {\n    id: String,\n    summary: Option\u003cString\u003e,\n    details: Option\u003cString\u003e,\n    severity: Option\u003cVec\u003cOsvSeverity\u003e\u003e,\n    references: Option\u003cVec\u003cOsvReference\u003e\u003e,\n    aliases: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvSeverity {\n    #[serde(rename = \"type\")]\n    _type: String,\n    score: String,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvReference {\n    #[serde(rename = \"type\")]\n    _ref_type: String,\n    url: String,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvVulnerabilityDetails {\n    summary: Option\u003cString\u003e,\n    affected: Option\u003cVec\u003cOsvAffected\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvAffected {\n    database_specific: Option\u003cOsvDatabaseSpecific\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvDatabaseSpecific {\n    informational: Option\u003cString\u003e,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::vulnerabilities::Ecosystem;\n\n    #[test]\n    fn test_parse_cvss_severity() {\n        assert_eq!(parse_cvss_severity(\"9.8\"), VulnerabilitySeverity::Critical);\n        assert_eq!(parse_cvss_severity(\"9.0\"), VulnerabilitySeverity::Critical);\n        assert_eq!(parse_cvss_severity(\"7.5\"), VulnerabilitySeverity::High);\n        assert_eq!(parse_cvss_severity(\"5.0\"), VulnerabilitySeverity::Medium);\n        assert_eq!(parse_cvss_severity(\"3.0\"), VulnerabilitySeverity::Low);\n        assert_eq!(parse_cvss_severity(\"0.0\"), VulnerabilitySeverity::Low);\n        assert_eq!(\n            parse_cvss_severity(\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H\"),\n            VulnerabilitySeverity::Medium\n        );\n    }\n\n    #[test]\n    fn test_ecosystem_osv_str() {\n        assert_eq!(Ecosystem::CratesIo.as_osv_str(), \"crates.io\");\n        assert_eq!(Ecosystem::Npm.as_osv_str(), \"npm\");\n        assert_eq!(Ecosystem::PyPI.as_osv_str(), \"PyPI\");\n        assert_eq!(Ecosystem::Go.as_osv_str(), \"Go\");\n        assert_eq!(Ecosystem::Packagist.as_osv_str(), \"Packagist\");\n        assert_eq!(Ecosystem::Pub.as_osv_str(), \"Pub\");\n        assert_eq!(Ecosystem::NuGet.as_osv_str(), \"NuGet\");\n    }\n\n    #[test]\n    fn test_convert_vulnerability() {\n        let osv = OsvVulnerability {\n            id: \"GHSA-xxxx-xxxx-xxxx\".to_string(),\n            summary: Some(\"Test vulnerability\".to_string()),\n            details: None,\n            severity: Some(vec![OsvSeverity {\n                _type: \"CVSS_V3\".to_string(),\n                score: \"7.5\".to_string(),\n            }]),\n            references: Some(vec![OsvReference {\n                _ref_type: \"ADVISORY\".to_string(),\n                url: \"https://example.com/advisory\".to_string(),\n            }]),\n            aliases: Some(vec![\"CVE-2021-12345\".to_string()]),\n        };\n\n        let vuln = OsvClient::convert_vulnerability(\u0026osv);\n\n        assert_eq!(vuln.id, \"CVE-2021-12345\");\n        assert_eq!(vuln.severity, VulnerabilitySeverity::High);\n        assert_eq!(vuln.description, \"Test vulnerability\");\n        assert_eq!(vuln.url, Some(\"https://example.com/advisory\".to_string()));\n    }\n\n    #[test]\n    fn test_unmaintained_detection() {\n        let rustsec_vuln = OsvVulnerability {\n            id: \"RUSTSEC-2025-0057\".to_string(),\n            summary: Some(\"fxhash - no longer maintained\".to_string()),\n            details: None,\n            severity: None,\n            references: None,\n            aliases: None,\n        };\n\n        let is_unmaintained = rustsec_vuln.id.starts_with(\"RUSTSEC\")\n            \u0026\u0026 rustsec_vuln.summary.as_ref().is_some_and(|s| {\n                s.to_lowercase().contains(\"maintained\") || s.to_lowercase().contains(\"deprecated\")\n            });\n\n        assert!(is_unmaintained);\n\n        let normal_vuln = OsvVulnerability {\n            id: \"CVE-2024-1234\".to_string(),\n            summary: Some(\"Buffer overflow vulnerability\".to_string()),\n            details: None,\n            severity: None,\n            references: None,\n            aliases: None,\n        };\n\n        let is_not_unmaintained = normal_vuln.id.starts_with(\"RUSTSEC\")\n            \u0026\u0026 normal_vuln.summary.as_ref().is_some_and(|s| {\n                s.to_lowercase().contains(\"maintained\") || s.to_lowercase().contains(\"deprecated\")\n            });\n\n        assert!(!is_not_unmaintained);\n    }\n\n    #[tokio::test]\n    async fn test_fxhash_deprecated_detection() {\n        let client = OsvClient::new().unwrap();\n\n        let query = VulnerabilityQuery {\n            ecosystem: crate::vulnerabilities::Ecosystem::CratesIo,\n            package_name: \"fxhash\".to_string(),\n            version: \"0.2.1\".to_string(),\n        };\n\n        let results = client.query_batch(\u0026[query]).await.unwrap();\n\n        assert!(!results.is_empty());\n\n        let result = \u0026results[0];\n        assert!(!result.vulnerabilities.is_empty());\n        assert!(result.deprecated, \"fxhash should be marked as deprecated\");\n\n        let vuln = \u0026result.vulnerabilities[0];\n        assert!(vuln.id.starts_with(\"RUSTSEC\"));\n    }\n}\n","traces":[{"line":31,"address":[13001184,13001788,13001782],"length":1,"stats":{"Line":2}},{"line":32,"address":[14605320,14605377,14605169,14605422,14605448],"length":1,"stats":{"Line":8}},{"line":34,"address":[14605254,14605799,14605270,14605328],"length":1,"stats":{"Line":4}},{"line":37,"address":[13001650],"length":1,"stats":{"Line":2}},{"line":38,"address":[14706193,14706124],"length":1,"stats":{"Line":4}},{"line":39,"address":[14605555],"length":1,"stats":{"Line":2}},{"line":43,"address":[14705745,14705120,14705739],"length":1,"stats":{"Line":2}},{"line":44,"address":[14705158],"length":1,"stats":{"Line":2}},{"line":47,"address":[14633398],"length":1,"stats":{"Line":10}},{"line":49,"address":[14604511],"length":1,"stats":{"Line":6}},{"line":51,"address":[14633465,14633603],"length":1,"stats":{"Line":4}},{"line":54,"address":[15756096,15756105],"length":1,"stats":{"Line":6}},{"line":55,"address":[15755936,15755945],"length":1,"stats":{"Line":6}},{"line":56,"address":[14633571],"length":1,"stats":{"Line":2}},{"line":58,"address":[14604682],"length":1,"stats":{"Line":2}},{"line":61,"address":[15756273,15756256],"length":1,"stats":{"Line":6}},{"line":62,"address":[15756149,15756128],"length":1,"stats":{"Line":6}},{"line":64,"address":[12933040],"length":1,"stats":{"Line":6}},{"line":65,"address":[15755870],"length":1,"stats":{"Line":2}},{"line":66,"address":[12992992,12992810,12993011],"length":1,"stats":{"Line":6}},{"line":67,"address":[12779664,12779648,12779530],"length":1,"stats":{"Line":6}},{"line":80,"address":[13003728],"length":1,"stats":{"Line":0}},{"line":81,"address":[14708862],"length":1,"stats":{"Line":0}},{"line":85,"address":[14633056],"length":1,"stats":{"Line":2}},{"line":86,"address":[14604157,14604222],"length":1,"stats":{"Line":4}},{"line":88,"address":[13000376,13000314],"length":1,"stats":{"Line":4}},{"line":89,"address":[13000344,13000415],"length":1,"stats":{"Line":4}},{"line":90,"address":[14705053,14705007],"length":1,"stats":{"Line":4}},{"line":91,"address":[14705046],"length":1,"stats":{"Line":2}},{"line":95,"address":[14604194],"length":1,"stats":{"Line":2}},{"line":103,"address":[14633296],"length":1,"stats":{"Line":2}},{"line":107,"address":[12774560,12774719],"length":1,"stats":{"Line":4}},{"line":108,"address":[12775364,12774772],"length":1,"stats":{"Line":0}},{"line":124,"address":[12987991,12987912],"length":1,"stats":{"Line":4}},{"line":125,"address":[12927907,12928860,12928489,12929838,12928391],"length":1,"stats":{"Line":6}},{"line":127,"address":[12929289,12929360],"length":1,"stats":{"Line":4}},{"line":128,"address":[12929517,12929411],"length":1,"stats":{"Line":0}},{"line":131,"address":[12723176],"length":1,"stats":{"Line":4}},{"line":133,"address":[12990003],"length":1,"stats":{"Line":2}},{"line":135,"address":[12931103,12930368,12930474],"length":1,"stats":{"Line":6}},{"line":136,"address":[12778038,12778151],"length":1,"stats":{"Line":4}},{"line":139,"address":[12777955],"length":1,"stats":{"Line":2}},{"line":141,"address":[12991288],"length":1,"stats":{"Line":2}},{"line":144,"address":[12931788,12931920],"length":1,"stats":{"Line":4}},{"line":147,"address":[12991403],"length":1,"stats":{"Line":2}},{"line":149,"address":[12778640,12778654,12778354],"length":1,"stats":{"Line":6}},{"line":150,"address":[12992387,12991593,12992352],"length":1,"stats":{"Line":6}},{"line":153,"address":[12931965,12927949,12930590,12930624],"length":1,"stats":{"Line":6}},{"line":155,"address":[12990666,12990619],"length":1,"stats":{"Line":4}},{"line":156,"address":[12777493],"length":1,"stats":{"Line":2}},{"line":161,"address":[12777777],"length":1,"stats":{"Line":2}},{"line":164,"address":[12993088,12993281,12994109,12993230,12993119,12994471],"length":1,"stats":{"Line":8}},{"line":165,"address":[12933503,12933612],"length":1,"stats":{"Line":4}},{"line":166,"address":[12780119],"length":1,"stats":{"Line":0}},{"line":169,"address":[12933974,12933660,12933917,12933618],"length":1,"stats":{"Line":4}},{"line":177,"address":[12780675,12781748,12781200,12781742],"length":1,"stats":{"Line":4}},{"line":178,"address":[12994505],"length":1,"stats":{"Line":2}},{"line":179,"address":[12994776,12994707],"length":1,"stats":{"Line":4}},{"line":180,"address":[12994792],"length":1,"stats":{"Line":2}},{"line":182,"address":[12781919,12783566,12781888,12782264,12781570,12782031,12784994,12781988],"length":1,"stats":{"Line":8}},{"line":183,"address":[12995598,12995245,12995302,12995404],"length":1,"stats":{"Line":6}},{"line":184,"address":[12782616],"length":1,"stats":{"Line":2}},{"line":185,"address":[12995817],"length":1,"stats":{"Line":0}},{"line":186,"address":[12936121,12936823,12936528],"length":1,"stats":{"Line":0}},{"line":187,"address":[12783193],"length":1,"stats":{"Line":0}},{"line":191,"address":[12782039,12782810,12783580,12782704],"length":1,"stats":{"Line":6}},{"line":192,"address":[12997206],"length":1,"stats":{"Line":2}},{"line":193,"address":[12937447],"length":1,"stats":{"Line":0}},{"line":194,"address":[12998753,12997175,12998500],"length":1,"stats":{"Line":0}},{"line":195,"address":[12785351],"length":1,"stats":{"Line":0}},{"line":199,"address":[12937669,12939696,12937590],"length":1,"stats":{"Line":6}},{"line":201,"address":[12939920,12940158,12940164,12939710],"length":1,"stats":{"Line":4}},{"line":202,"address":[12939929],"length":1,"stats":{"Line":2}},{"line":203,"address":[12940023,12939961],"length":1,"stats":{"Line":4}},{"line":207,"address":[12939856,12939740],"length":1,"stats":{"Line":4}},{"line":208,"address":[12940176,12939865],"length":1,"stats":{"Line":4}},{"line":209,"address":[12940224,12940201],"length":1,"stats":{"Line":4}},{"line":211,"address":[12999945],"length":1,"stats":{"Line":2}},{"line":212,"address":[12940256,12940265,12940242],"length":1,"stats":{"Line":6}},{"line":217,"address":[12999488],"length":1,"stats":{"Line":2}},{"line":220,"address":[12937706],"length":1,"stats":{"Line":2}},{"line":221,"address":[12997859,12997921,12997460],"length":1,"stats":{"Line":2}},{"line":224,"address":[12938201],"length":1,"stats":{"Line":0}},{"line":225,"address":[12997770],"length":1,"stats":{"Line":0}},{"line":226,"address":[15762809,15762800,15761099],"length":1,"stats":{"Line":0}},{"line":227,"address":[12997823],"length":1,"stats":{"Line":0}},{"line":231,"address":[12937717],"length":1,"stats":{"Line":2}},{"line":237,"address":[12780883,12780024,12780721],"length":1,"stats":{"Line":4}},{"line":240,"address":[12935360,12935382,12934630],"length":1,"stats":{"Line":6}}],"covered":74,"coverable":89},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","tests","integration_test.rs"],"content":"//! Integration tests for dependi-lsp\n\nuse dependi_lsp::cache::{MemoryCache, ReadCache, WriteCache};\nuse dependi_lsp::parsers::Parser;\nuse dependi_lsp::parsers::cargo::CargoParser;\nuse dependi_lsp::parsers::npm::NpmParser;\nuse dependi_lsp::providers::inlay_hints::create_inlay_hint;\nuse dependi_lsp::registries::VersionInfo;\n\n/// Test parsing a realistic Cargo.toml file\n#[test]\nfn test_parse_realistic_cargo_toml() {\n    let content = r#\"\n[package]\nname = \"my-awesome-app\"\nversion = \"0.1.0\"\nedition = \"2024\"\nlicense = \"MIT\"\n\n[dependencies]\ntokio = { version = \"1.35\", features = [\"full\"] }\nserde = { version = \"1.0\", features = [\"derive\"] }\nserde_json = \"1.0\"\nreqwest = { version = \"0.12\", features = [\"json\", \"rustls-tls\"], default-features = false }\nanyhow = \"1\"\nthiserror = \"2\"\ntracing = \"0.1\"\n\n[dev-dependencies]\ntokio-test = \"0.4\"\ncriterion = { version = \"0.5\", features = [\"html_reports\"] }\n\n[build-dependencies]\ncc = \"1.0\"\n\"#;\n\n    let parser = CargoParser::new();\n    let deps = parser.parse(content);\n\n    // Should find all dependencies\n    assert_eq!(deps.len(), 10);\n\n    // Check regular dependencies\n    let tokio = deps.iter().find(|d| d.name == \"tokio\").unwrap();\n    assert_eq!(tokio.version, \"1.35\");\n    assert!(!tokio.dev);\n\n    let serde_json = deps.iter().find(|d| d.name == \"serde_json\").unwrap();\n    assert_eq!(serde_json.version, \"1.0\");\n\n    // Check dev dependencies\n    let tokio_test = deps.iter().find(|d| d.name == \"tokio-test\").unwrap();\n    assert!(tokio_test.dev);\n\n    let criterion = deps.iter().find(|d| d.name == \"criterion\").unwrap();\n    assert!(criterion.dev);\n    assert_eq!(criterion.version, \"0.5\");\n\n    // Check build dependencies (treated as regular for now)\n    let cc = deps.iter().find(|d| d.name == \"cc\").unwrap();\n    assert_eq!(cc.version, \"1.0\");\n}\n\n/// Test parsing a realistic package.json file\n#[test]\nfn test_parse_realistic_package_json() {\n    let content = r#\"{\n  \"name\": \"my-react-app\",\n  \"version\": \"1.0.0\",\n  \"description\": \"A sample React application\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"start\": \"react-scripts start\",\n    \"build\": \"react-scripts build\",\n    \"test\": \"react-scripts test\"\n  },\n  \"dependencies\": {\n    \"react\": \"^18.2.0\",\n    \"react-dom\": \"^18.2.0\",\n    \"axios\": \"^1.6.0\",\n    \"@tanstack/react-query\": \"^5.0.0\",\n    \"lodash\": \"^4.17.21\"\n  },\n  \"devDependencies\": {\n    \"@types/react\": \"^18.2.0\",\n    \"@types/react-dom\": \"^18.2.0\",\n    \"typescript\": \"^5.3.0\",\n    \"@testing-library/react\": \"^14.0.0\",\n    \"prettier\": \"^3.1.0\"\n  },\n  \"peerDependencies\": {\n    \"react\": \"\u003e=16.8.0\"\n  }\n}\"#;\n\n    let parser = NpmParser::new();\n    let deps = parser.parse(content);\n\n    // Should find all dependencies\n    assert_eq!(deps.len(), 11);\n\n    // Check regular dependencies\n    let react = deps\n        .iter()\n        .find(|d| d.name == \"react\" \u0026\u0026 !d.optional)\n        .unwrap();\n    assert_eq!(react.version, \"^18.2.0\");\n    assert!(!react.dev);\n\n    // Check scoped packages\n    let react_query = deps\n        .iter()\n        .find(|d| d.name == \"@tanstack/react-query\")\n        .unwrap();\n    assert_eq!(react_query.version, \"^5.0.0\");\n\n    // Check dev dependencies\n    let typescript = deps.iter().find(|d| d.name == \"typescript\").unwrap();\n    assert!(typescript.dev);\n    assert_eq!(typescript.version, \"^5.3.0\");\n\n    // Check peer dependencies (marked as optional)\n    let peer_react = deps\n        .iter()\n        .find(|d| d.name == \"react\" \u0026\u0026 d.optional)\n        .unwrap();\n    assert_eq!(peer_react.version, \"\u003e=16.8.0\");\n}\n\n/// Test cache integration\n#[test]\nfn test_cache_integration() {\n    let cache = MemoryCache::new();\n\n    // Insert some version info\n    let serde_info = VersionInfo {\n        latest: Some(\"1.0.200\".to_string()),\n        latest_prerelease: None,\n        versions: vec![\"1.0.200\".to_string(), \"1.0.199\".to_string()],\n        description: Some(\"A serialization framework\".to_string()),\n        homepage: None,\n        repository: Some(\"https://github.com/serde-rs/serde\".to_string()),\n        license: Some(\"MIT OR Apache-2.0\".to_string()),\n        vulnerabilities: vec![],\n        deprecated: false,\n        yanked: false,\n        yanked_versions: vec![],\n        release_dates: Default::default(),\n    };\n\n    cache.insert(\"crates:serde\".to_string(), serde_info.clone());\n\n    // Retrieve and verify\n    let retrieved = cache.get(\"crates:serde\").unwrap();\n    assert_eq!(retrieved.latest, Some(\"1.0.200\".to_string()));\n    assert_eq!(retrieved.license, Some(\"MIT OR Apache-2.0\".to_string()));\n\n    // Test cache miss\n    assert!(cache.get(\"crates:nonexistent\").is_none());\n}\n\n/// Test inlay hint generation with various scenarios\n#[test]\nfn test_inlay_hint_generation() {\n    use dependi_lsp::parsers::Dependency;\n\n    // Up-to-date dependency\n    let dep_up_to_date = Dependency {\n        name: \"serde\".to_string(),\n        version: \"1.0.200\".to_string(),\n        line: 5,\n        name_start: 0,\n        name_end: 5,\n        version_start: 9,\n        version_end: 18,\n        dev: false,\n        optional: false,\n    };\n\n    let info_up_to_date = VersionInfo {\n        latest: Some(\"1.0.200\".to_string()),\n        ..Default::default()\n    };\n\n    let hint = create_inlay_hint(\u0026dep_up_to_date, Some(\u0026info_up_to_date));\n    match hint.label {\n        tower_lsp::lsp_types::InlayHintLabel::String(s) =\u003e {\n            assert!(s.contains(\"✓\"), \"Expected checkmark for up-to-date dep\");\n        }\n        _ =\u003e panic!(\"Expected string label\"),\n    }\n\n    // Outdated dependency\n    let dep_outdated = Dependency {\n        name: \"tokio\".to_string(),\n        version: \"1.0.0\".to_string(),\n        line: 6,\n        name_start: 0,\n        name_end: 5,\n        version_start: 9,\n        version_end: 16,\n        dev: false,\n        optional: false,\n    };\n\n    let info_outdated = VersionInfo {\n        latest: Some(\"1.35.0\".to_string()),\n        ..Default::default()\n    };\n\n    let hint = create_inlay_hint(\u0026dep_outdated, Some(\u0026info_outdated));\n    match hint.label {\n        tower_lsp::lsp_types::InlayHintLabel::String(s) =\u003e {\n            assert!(s.contains(\"-\u003e\"), \"Expected arrow for outdated dep\");\n            assert!(s.contains(\"1.35.0\"), \"Expected latest version in hint\");\n        }\n        _ =\u003e panic!(\"Expected string label\"),\n    }\n\n    // Unknown version (no info) - shows ? Unknown with troubleshooting tooltip\n    let hint = create_inlay_hint(\u0026dep_outdated, None);\n    match hint.label {\n        tower_lsp::lsp_types::InlayHintLabel::String(s) =\u003e {\n            assert!(\n                s.contains(\"? Unknown\"),\n                \"Expected question mark for unknown/error status\"\n            );\n        }\n        _ =\u003e panic!(\"Expected string label\"),\n    }\n}\n\n/// Test parsing dependencies with various version specifiers\n#[test]\nfn test_version_specifier_parsing() {\n    let cargo_content = r#\"\n[dependencies]\ncaret = \"^1.0\"\ntilde = \"~1.0.0\"\nexact = \"=1.0.0\"\nrange = \"\u003e=1.0, \u003c2.0\"\nwildcard = \"1.*\"\n\"#;\n\n    let parser = CargoParser::new();\n    let deps = parser.parse(cargo_content);\n\n    assert_eq!(deps.len(), 5);\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"caret\").unwrap().version,\n        \"^1.0\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"tilde\").unwrap().version,\n        \"~1.0.0\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"exact\").unwrap().version,\n        \"=1.0.0\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"range\").unwrap().version,\n        \"\u003e=1.0, \u003c2.0\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"wildcard\").unwrap().version,\n        \"1.*\"\n    );\n}\n\n/// Test parsing npm packages with various version formats\n#[test]\nfn test_npm_version_formats() {\n    let content = r#\"{\n  \"dependencies\": {\n    \"caret\": \"^1.0.0\",\n    \"tilde\": \"~1.0.0\",\n    \"range\": \"\u003e=1.0.0 \u003c2.0.0\",\n    \"hyphen\": \"1.0.0 - 2.0.0\",\n    \"exact\": \"1.0.0\",\n    \"latest\": \"*\",\n    \"tag\": \"latest\"\n  }\n}\"#;\n\n    let parser = NpmParser::new();\n    let deps = parser.parse(content);\n\n    assert_eq!(deps.len(), 7);\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"caret\").unwrap().version,\n        \"^1.0.0\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"range\").unwrap().version,\n        \"\u003e=1.0.0 \u003c2.0.0\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"latest\").unwrap().version,\n        \"*\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"tag\").unwrap().version,\n        \"latest\"\n    );\n}\n\n/// Test that positions are correctly tracked\n#[test]\nfn test_dependency_positions() {\n    let content = r#\"[dependencies]\nserde = \"1.0.0\"\ntokio = { version = \"1.35\" }\n\"#;\n\n    let parser = CargoParser::new();\n    let deps = parser.parse(content);\n\n    // serde should be on line 1 (0-indexed)\n    let serde = deps.iter().find(|d| d.name == \"serde\").unwrap();\n    assert_eq!(serde.line, 1);\n\n    // tokio should be on line 2\n    let tokio = deps.iter().find(|d| d.name == \"tokio\").unwrap();\n    assert_eq!(tokio.line, 2);\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = {"files":[{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","backend.rs"],"content":"use std::sync::{Arc, RwLock};\n\nuse dashmap::DashMap;\nuse reqwest::Client as HttpClient;\nuse tower_lsp::jsonrpc::Result;\nuse tower_lsp::lsp_types::*;\nuse tower_lsp::{Client, LanguageServer};\n\nuse crate::cache::{HybridCache, ReadCache, WriteCache};\nuse crate::config::Config;\nuse crate::document::DocumentState;\nuse crate::file_types::FileType;\nuse crate::parsers::Parser;\nuse crate::parsers::cargo::CargoParser;\nuse crate::parsers::csharp::CsharpParser;\nuse crate::parsers::dart::DartParser;\nuse crate::parsers::go::GoParser;\nuse crate::parsers::npm::NpmParser;\nuse crate::parsers::php::PhpParser;\nuse crate::parsers::python::PythonParser;\nuse crate::parsers::ruby::RubyParser;\nuse crate::providers::code_actions::create_code_actions;\nuse crate::providers::completion::{format_release_age, get_completions};\nuse crate::providers::diagnostics::create_diagnostics;\nuse crate::providers::inlay_hints::create_inlay_hint;\nuse crate::registries::crates_io::CratesIoRegistry;\nuse crate::registries::go_proxy::GoProxyRegistry;\nuse crate::registries::http_client::create_shared_client;\nuse crate::registries::npm::NpmRegistry;\nuse crate::registries::nuget::NuGetRegistry;\nuse crate::registries::packagist::PackagistRegistry;\nuse crate::registries::pub_dev::PubDevRegistry;\nuse crate::registries::pypi::PyPiRegistry;\nuse crate::registries::rubygems::RubyGemsRegistry;\nuse crate::registries::{Registry, VersionInfo, VulnerabilitySeverity};\nuse crate::reports::{VulnerabilityReportEntry, VulnerabilitySummary, generate_markdown_report};\nuse crate::vulnerabilities::VulnerabilityQuery;\nuse crate::vulnerabilities::cache::VulnerabilityCache;\nuse crate::vulnerabilities::osv::OsvClient;\n\npub struct DependiBackend {\n    client: Client,\n    /// Configuration\n    config: RwLock\u003cConfig\u003e,\n    /// Cache for documents and their parsed state\n    documents: DashMap\u003cUrl, DocumentState\u003e,\n    /// Cache for version information (keyed by \"registry:package\")\n    version_cache: Arc\u003cHybridCache\u003e,\n    /// Parsers\n    cargo_parser: CargoParser,\n    npm_parser: NpmParser,\n    python_parser: PythonParser,\n    go_parser: GoParser,\n    php_parser: PhpParser,\n    dart_parser: DartParser,\n    csharp_parser: CsharpParser,\n    ruby_parser: RubyParser,\n    /// Registry clients\n    crates_io: Arc\u003cCratesIoRegistry\u003e,\n    npm_registry: Arc\u003cNpmRegistry\u003e,\n    pypi: Arc\u003cPyPiRegistry\u003e,\n    go_proxy: Arc\u003cGoProxyRegistry\u003e,\n    packagist: Arc\u003cPackagistRegistry\u003e,\n    pub_dev: Arc\u003cPubDevRegistry\u003e,\n    nuget: Arc\u003cNuGetRegistry\u003e,\n    rubygems: Arc\u003cRubyGemsRegistry\u003e,\n    /// Vulnerability scanning\n    osv_client: Arc\u003cOsvClient\u003e,\n    vuln_cache: Arc\u003cVulnerabilityCache\u003e,\n}\n\nimpl DependiBackend {\n    /// Create a new DependiBackend with default configuration, parsers, registry clients,\n    /// caches, and an OSV client.\n    ///\n    /// The provided `client` is used for LSP communication. A shared HTTP client is created\n    /// internally and used to construct registry clients bound to that HTTP client.\n    ///\n    /// # Examples\n    ///\n    /// ```\n    /// // Obtain an LSP `Client` from the runtime environment and pass it in:\n    /// // let client = /* LSP client */ ;\n    /// // let backend = DependiBackend::new(client);\n    /// ```\n    pub fn new(client: Client) -\u003e Self {\n        Self::with_http_client(client, None)\n    }\n\n    pub fn with_http_client(client: Client, http_client: Option\u003cArc\u003cHttpClient\u003e\u003e) -\u003e Self {\n        let http_client = http_client.unwrap_or_else(|| {\n            create_shared_client().expect(\"Failed to create shared HTTP client\")\n        });\n\n        Self {\n            client,\n            config: RwLock::new(Config::default()),\n            documents: DashMap::new(),\n            version_cache: Arc::new(HybridCache::new()),\n            cargo_parser: CargoParser::new(),\n            npm_parser: NpmParser::new(),\n            python_parser: PythonParser::new(),\n            go_parser: GoParser::new(),\n            php_parser: PhpParser::new(),\n            dart_parser: DartParser::new(),\n            csharp_parser: CsharpParser::new(),\n            ruby_parser: RubyParser::new(),\n            crates_io: Arc::new(CratesIoRegistry::with_client(Arc::clone(\u0026http_client))),\n            npm_registry: Arc::new(NpmRegistry::with_client(Arc::clone(\u0026http_client))),\n            pypi: Arc::new(PyPiRegistry::with_client(Arc::clone(\u0026http_client))),\n            go_proxy: Arc::new(GoProxyRegistry::with_client(Arc::clone(\u0026http_client))),\n            packagist: Arc::new(PackagistRegistry::with_client(Arc::clone(\u0026http_client))),\n            pub_dev: Arc::new(PubDevRegistry::with_client(Arc::clone(\u0026http_client))),\n            nuget: Arc::new(NuGetRegistry::with_client(Arc::clone(\u0026http_client))),\n            rubygems: Arc::new(RubyGemsRegistry::with_client(http_client)),\n            osv_client: Arc::new(OsvClient::default()),\n            vuln_cache: Arc::new(VulnerabilityCache::new()),\n        }\n    }\n\n    fn parse_document(\u0026self, uri: \u0026Url, content: \u0026str) -\u003e Vec\u003ccrate::parsers::Dependency\u003e {\n        match FileType::detect(uri) {\n            Some(FileType::Cargo) =\u003e self.cargo_parser.parse(content),\n            Some(FileType::Npm) =\u003e self.npm_parser.parse(content),\n            Some(FileType::Python) =\u003e self.python_parser.parse(content),\n            Some(FileType::Go) =\u003e self.go_parser.parse(content),\n            Some(FileType::Php) =\u003e self.php_parser.parse(content),\n            Some(FileType::Dart) =\u003e self.dart_parser.parse(content),\n            Some(FileType::Csharp) =\u003e self.csharp_parser.parse(content),\n            Some(FileType::Ruby) =\u003e self.ruby_parser.parse(content),\n            None =\u003e vec![],\n        }\n    }\n\n    async fn get_version_info(\n        \u0026self,\n        file_type: FileType,\n        package_name: \u0026str,\n    ) -\u003e Option\u003cVersionInfo\u003e {\n        let cache_key = file_type.cache_key(package_name);\n\n        // Check cache first\n        if let Some(cached) = self.version_cache.get(\u0026cache_key) {\n            return Some(cached);\n        }\n\n        // Fetch from appropriate registry\n        let result = match file_type {\n            FileType::Cargo =\u003e self.crates_io.get_version_info(package_name).await,\n            FileType::Npm =\u003e self.npm_registry.get_version_info(package_name).await,\n            FileType::Python =\u003e self.pypi.get_version_info(package_name).await,\n            FileType::Go =\u003e self.go_proxy.get_version_info(package_name).await,\n            FileType::Php =\u003e self.packagist.get_version_info(package_name).await,\n            FileType::Dart =\u003e self.pub_dev.get_version_info(package_name).await,\n            FileType::Csharp =\u003e self.nuget.get_version_info(package_name).await,\n            FileType::Ruby =\u003e self.rubygems.get_version_info(package_name).await,\n        };\n\n        match result {\n            Ok(info) =\u003e {\n                self.version_cache.insert(cache_key, info.clone());\n                Some(info)\n            }\n            Err(e) =\u003e {\n                tracing::warn!(\"Failed to fetch version info for {}: {}\", package_name, e);\n                None\n            }\n        }\n    }\n\n    async fn fetch_vulnerabilities_background(\n        dependencies: Vec\u003ccrate::parsers::Dependency\u003e,\n        file_type: FileType,\n        cache: Arc\u003cHybridCache\u003e,\n        osv_client: Arc\u003cOsvClient\u003e,\n        vuln_cache: Arc\u003cVulnerabilityCache\u003e,\n        client: Client,\n    ) {\n        use crate::vulnerabilities::cache::VulnCacheKey;\n\n        let ecosystem = file_type.to_ecosystem();\n\n        // Build queries for packages not in vulnerability cache\n        let queries: Vec\u003cVulnerabilityQuery\u003e = dependencies\n            .iter()\n            .filter(|dep| {\n                let vuln_key = VulnCacheKey::new(ecosystem, \u0026dep.name, \u0026dep.version);\n                !vuln_cache.contains(\u0026vuln_key)\n            })\n            .map(|dep| VulnerabilityQuery {\n                ecosystem,\n                package_name: dep.name.clone(),\n                version: dep.version.clone(),\n            })\n            .collect();\n\n        if queries.is_empty() {\n            tracing::debug!(\"Background: All vulnerability info cached, skipping OSV query\");\n            return;\n        }\n\n        tracing::info!(\n            \"Background: Querying OSV.dev for {} packages\",\n            queries.len()\n        );\n\n        // Batch query OSV.dev\n        match osv_client.query_batch(\u0026queries).await {\n            Ok(results) =\u003e {\n                let mut updated_count = 0;\n\n                // Update vulnerability cache and version_cache with results\n                for (query, result) in queries.iter().zip(results.iter()) {\n                    // Mark this package as queried in vuln_cache\n                    let vuln_key =\n                        VulnCacheKey::new(ecosystem, \u0026query.package_name, \u0026query.version);\n                    vuln_cache.insert(vuln_key);\n\n                    // Store vulnerabilities and deprecated status in version_cache\n                    let cache_key = file_type.cache_key(\u0026query.package_name);\n                    if let Some(mut info) = cache.get(\u0026cache_key) {\n                        info.vulnerabilities = result.vulnerabilities.clone();\n                        info.deprecated = result.deprecated;\n                        if result.deprecated {\n                            tracing::info!(\n                                \"Background: Package {} {} is deprecated (unmaintained)\",\n                                query.package_name,\n                                query.version\n                            );\n                        }\n                        tracing::debug!(\n                            \"Background: Updated {} {} with {} vulnerabilities, deprecated={}\",\n                            query.package_name,\n                            query.version,\n                            result.vulnerabilities.len(),\n                            result.deprecated\n                        );\n                        cache.insert(cache_key, info);\n                        updated_count += 1;\n                    } else {\n                        tracing::warn!(\n                            \"Background: Could not update vulnerabilities for {}: not found in version cache\",\n                            query.package_name\n                        );\n                    }\n                }\n                tracing::info!(\n                    \"Background: Cached vulnerability info for {} packages\",\n                    updated_count\n                );\n\n                // Refresh UI with new vulnerability data\n                tracing::debug!(\"Background: Refreshing inlay hints after vulnerability check\");\n                client\n                    .send_request::\u003crequest::InlayHintRefreshRequest\u003e(())\n                    .await\n                    .ok();\n                client\n                    .send_request::\u003crequest::WorkspaceDiagnosticRefresh\u003e(())\n                    .await\n                    .ok();\n\n                tracing::info!(\"Background: Vulnerability check complete, UI updated\");\n            }\n            Err(e) =\u003e {\n                tracing::warn!(\n                    \"Background: Failed to fetch vulnerabilities from OSV.dev: {}\",\n                    e\n                );\n            }\n        }\n    }\n\n    async fn process_document(\u0026self, uri: \u0026Url, content: \u0026str) {\n        let Some(file_type) = FileType::detect(uri) else {\n            return;\n        };\n\n        let dependencies = self.parse_document(uri, content);\n\n        tracing::info!(\n            \"Parsed {} dependencies from {}\",\n            dependencies.len(),\n            uri.path()\n        );\n\n        // Clone Arc references for async tasks\n        let crates_io = Arc::clone(\u0026self.crates_io);\n        let npm_registry = Arc::clone(\u0026self.npm_registry);\n        let pypi = Arc::clone(\u0026self.pypi);\n        let go_proxy = Arc::clone(\u0026self.go_proxy);\n        let packagist = Arc::clone(\u0026self.packagist);\n        let pub_dev = Arc::clone(\u0026self.pub_dev);\n        let nuget = Arc::clone(\u0026self.nuget);\n        let rubygems = Arc::clone(\u0026self.rubygems);\n        let cache = Arc::clone(\u0026self.version_cache);\n\n        let fetch_tasks: Vec\u003c_\u003e = dependencies\n            .iter()\n            .map(|dep| {\n                let name = dep.name.clone();\n                let cache_key = file_type.cache_key(\u0026name);\n                let crates_io = Arc::clone(\u0026crates_io);\n                let npm_registry = Arc::clone(\u0026npm_registry);\n                let pypi = Arc::clone(\u0026pypi);\n                let go_proxy = Arc::clone(\u0026go_proxy);\n                let packagist = Arc::clone(\u0026packagist);\n                let pub_dev = Arc::clone(\u0026pub_dev);\n                let nuget = Arc::clone(\u0026nuget);\n                let rubygems = Arc::clone(\u0026rubygems);\n                let cache = Arc::clone(\u0026cache);\n                async move {\n                    // Check cache first\n                    if cache.get(\u0026cache_key).is_some() {\n                        return;\n                    }\n                    // Fetch from appropriate registry\n                    let result = match file_type {\n                        FileType::Cargo =\u003e crates_io.get_version_info(\u0026name).await,\n                        FileType::Npm =\u003e npm_registry.get_version_info(\u0026name).await,\n                        FileType::Python =\u003e pypi.get_version_info(\u0026name).await,\n                        FileType::Go =\u003e go_proxy.get_version_info(\u0026name).await,\n                        FileType::Php =\u003e packagist.get_version_info(\u0026name).await,\n                        FileType::Dart =\u003e pub_dev.get_version_info(\u0026name).await,\n                        FileType::Csharp =\u003e nuget.get_version_info(\u0026name).await,\n                        FileType::Ruby =\u003e rubygems.get_version_info(\u0026name).await,\n                    };\n                    if let Ok(info) = result {\n                        cache.insert(cache_key, info);\n                    }\n                }\n            })\n            .collect();\n\n        // Run up to 5 concurrent requests\n        let semaphore = Arc::new(tokio::sync::Semaphore::new(5));\n        let handles: Vec\u003c_\u003e = fetch_tasks\n            .into_iter()\n            .map(|task| {\n                let permit = Arc::clone(\u0026semaphore);\n                tokio::spawn(async move {\n                    let _permit = permit.acquire().await;\n                    task.await\n                })\n            })\n            .collect();\n\n        // Wait for all tasks to complete\n        for handle in handles {\n            let _ = handle.await;\n        }\n\n        // Store document state IMMEDIATELY (before vulnerability check)\n        self.documents.insert(\n            uri.clone(),\n            DocumentState {\n                dependencies: dependencies.clone(),\n                file_type,\n            },\n        );\n\n        // Publish diagnostics IMMEDIATELY (versions are available, vulnerabilities will update later)\n        let (diagnostics_enabled, security_show_diags, min_severity, security_enabled) = self\n            .config\n            .read()\n            .map(|c| {\n                (\n                    c.diagnostics.enabled,\n                    c.security.show_diagnostics,\n                    if c.security.show_diagnostics {\n                        Some(c.security.min_severity_level())\n                    } else {\n                        None\n                    },\n                    c.security.enabled,\n                )\n            })\n            .unwrap_or((true, true, None, true));\n\n        if diagnostics_enabled {\n            let severity_filter = if security_show_diags {\n                min_severity\n            } else {\n                None\n            };\n            let diagnostics = create_diagnostics(\n                \u0026dependencies,\n                \u0026self.version_cache,\n                |name| file_type.cache_key(name),\n                severity_filter,\n            );\n\n            self.client\n                .publish_diagnostics(uri.clone(), diagnostics, None)\n                .await;\n        }\n\n        // Refresh inlay hints IMMEDIATELY (versions are available)\n        self.client\n            .send_request::\u003crequest::InlayHintRefreshRequest\u003e(())\n            .await\n            .ok();\n\n        // Fetch vulnerabilities from OSV.dev in BACKGROUND (non-blocking)\n        if security_enabled \u0026\u0026 !dependencies.is_empty() {\n            let dependencies_clone = dependencies.clone();\n            let cache_clone = Arc::clone(\u0026self.version_cache);\n            let osv_client_clone = Arc::clone(\u0026self.osv_client);\n            let vuln_cache_clone = Arc::clone(\u0026self.vuln_cache);\n            let client_clone = self.client.clone();\n\n            tokio::spawn(async move {\n                Self::fetch_vulnerabilities_background(\n                    dependencies_clone,\n                    file_type,\n                    cache_clone,\n                    osv_client_clone,\n                    vuln_cache_clone,\n                    client_clone,\n                )\n                .await;\n            });\n        }\n    }\n\n    /// Generate a vulnerability report for a document\n    async fn generate_vulnerability_report(\n        \u0026self,\n        arguments: \u0026[serde_json::Value],\n    ) -\u003e serde_json::Value {\n        // Parse arguments\n        let format = arguments\n            .first()\n            .and_then(|v| v.get(\"format\"))\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"json\");\n\n        let uri_str = arguments\n            .first()\n            .and_then(|v| v.get(\"uri\"))\n            .and_then(|v| v.as_str());\n\n        // Find the document\n        let (uri, doc_state) = if let Some(uri_str) = uri_str {\n            if let Ok(uri) = Url::parse(uri_str) {\n                if let Some(doc) = self.documents.get(\u0026uri) {\n                    (uri.clone(), Some((doc.file_type, doc.dependencies.clone())))\n                } else {\n                    (uri, None)\n                }\n            } else {\n                return serde_json::json!({\n                    \"error\": \"Invalid URI format\"\n                });\n            }\n        } else {\n            // Use the first open document\n            if let Some(entry) = self.documents.iter().next() {\n                (\n                    entry.key().clone(),\n                    Some((entry.value().file_type, entry.value().dependencies.clone())),\n                )\n            } else {\n                return serde_json::json!({\n                    \"error\": \"No open documents\"\n                });\n            }\n        };\n\n        let Some((file_type, dependencies)) = doc_state else {\n            return serde_json::json!({\n                \"error\": \"Document not found or not yet processed\"\n            });\n        };\n\n        // Collect vulnerabilities from the version cache\n        let mut vulnerabilities: Vec\u003cVulnerabilityReportEntry\u003e = Vec::new();\n        let mut summary = VulnerabilitySummary::default();\n\n        for dep in \u0026dependencies {\n            let cache_key = file_type.cache_key(\u0026dep.name);\n            if let Some(info) = self.version_cache.get(\u0026cache_key) {\n                for vuln in \u0026info.vulnerabilities {\n                    summary.total += 1;\n                    match vuln.severity {\n                        VulnerabilitySeverity::Critical =\u003e summary.critical += 1,\n                        VulnerabilitySeverity::High =\u003e summary.high += 1,\n                        VulnerabilitySeverity::Medium =\u003e summary.medium += 1,\n                        VulnerabilitySeverity::Low =\u003e summary.low += 1,\n                    }\n\n                    vulnerabilities.push(VulnerabilityReportEntry {\n                        package: dep.name.clone(),\n                        version: dep.version.clone(),\n                        id: vuln.id.clone(),\n                        severity: format!(\"{:?}\", vuln.severity).to_lowercase(),\n                        description: vuln.description.clone(),\n                        url: vuln.url.clone(),\n                    });\n                }\n            }\n        }\n\n        // Generate report based on format\n        match format {\n            \"markdown\" =\u003e {\n                let md = generate_markdown_report(\u0026uri, \u0026summary, \u0026vulnerabilities);\n                serde_json::json!({\n                    \"format\": \"markdown\",\n                    \"content\": md\n                })\n            }\n            _ =\u003e {\n                // Default to JSON\n                serde_json::json!({\n                    \"summary\": summary,\n                    \"vulnerabilities\": vulnerabilities,\n                    \"file\": uri.to_string()\n                })\n            }\n        }\n    }\n}\n\n#[tower_lsp::async_trait]\nimpl LanguageServer for DependiBackend {\n    async fn initialize(\u0026self, params: InitializeParams) -\u003e Result\u003cInitializeResult\u003e {\n        // Parse configuration from initialization options\n        let config = Config::from_init_options(params.initialization_options);\n        tracing::info!(\"Configuration: {:?}\", config);\n\n        // Store the configuration\n        if let Ok(mut cfg) = self.config.write() {\n            *cfg = config;\n        }\n\n        Ok(InitializeResult {\n            server_info: Some(ServerInfo {\n                name: \"dependi-lsp\".to_string(),\n                version: Some(env!(\"CARGO_PKG_VERSION\").to_string()),\n            }),\n            capabilities: ServerCapabilities {\n                text_document_sync: Some(TextDocumentSyncCapability::Kind(\n                    TextDocumentSyncKind::FULL,\n                )),\n                inlay_hint_provider: Some(OneOf::Left(true)),\n                hover_provider: Some(HoverProviderCapability::Simple(true)),\n                code_action_provider: Some(CodeActionProviderCapability::Simple(true)),\n                completion_provider: Some(CompletionOptions {\n                    trigger_characters: Some(vec![\"\\\"\".to_string(), \"=\".to_string()]),\n                    ..Default::default()\n                }),\n                execute_command_provider: Some(ExecuteCommandOptions {\n                    commands: vec![\"dependi/generateReport\".to_string()],\n                    ..Default::default()\n                }),\n                ..Default::default()\n            },\n        })\n    }\n\n    async fn initialized(\u0026self, _: InitializedParams) {\n        self.client\n            .log_message(MessageType::INFO, \"Dependi LSP initialized\")\n            .await;\n\n        // Verify all registries share the same HTTP client\n        let base_client = self.crates_io.http_client();\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.npm_registry.http_client()));\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.pypi.http_client()));\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.go_proxy.http_client()));\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.packagist.http_client()));\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.pub_dev.http_client()));\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.nuget.http_client()));\n        debug_assert!(Arc::ptr_eq(\u0026base_client, \u0026self.rubygems.http_client()));\n\n        tracing::info!(\"Dependi LSP initialized\");\n    }\n\n    async fn shutdown(\u0026self) -\u003e Result\u003c()\u003e {\n        tracing::info!(\"Dependi LSP shutting down\");\n        Ok(())\n    }\n\n    async fn did_open(\u0026self, params: DidOpenTextDocumentParams) {\n        let uri = params.text_document.uri;\n        let content = params.text_document.text;\n\n        tracing::debug!(\"Document opened: {}\", uri);\n        self.process_document(\u0026uri, \u0026content).await;\n    }\n\n    async fn did_change(\u0026self, params: DidChangeTextDocumentParams) {\n        let uri = params.text_document.uri;\n\n        // With FULL sync, we get the entire document content\n        if let Some(change) = params.content_changes.into_iter().next() {\n            tracing::debug!(\"Document changed: {}\", uri);\n            self.process_document(\u0026uri, \u0026change.text).await;\n        }\n    }\n\n    async fn did_save(\u0026self, params: DidSaveTextDocumentParams) {\n        let uri = params.text_document.uri;\n\n        // Re-process on save if we have the text\n        if let Some(text) = params.text {\n            tracing::debug!(\"Document saved: {}\", uri);\n            self.process_document(\u0026uri, \u0026text).await;\n        }\n    }\n\n    async fn did_close(\u0026self, params: DidCloseTextDocumentParams) {\n        let uri = params.text_document.uri;\n        tracing::debug!(\"Document closed: {}\", uri);\n        self.documents.remove(\u0026uri);\n\n        // Clear diagnostics for this document\n        self.client.publish_diagnostics(uri, vec![], None).await;\n    }\n\n    async fn inlay_hint(\u0026self, params: InlayHintParams) -\u003e Result\u003cOption\u003cVec\u003cInlayHint\u003e\u003e\u003e {\n        // Check if inlay hints are enabled\n        let config = self.config.read().unwrap();\n        if !config.inlay_hints.enabled {\n            return Ok(Some(vec![]));\n        }\n        let show_up_to_date = config.inlay_hints.show_up_to_date;\n        let ignored_packages = config.ignore.clone();\n        drop(config);\n\n        let uri = \u0026params.text_document.uri;\n\n        let Some(doc) = self.documents.get(uri) else {\n            return Ok(Some(vec![]));\n        };\n\n        let file_type = doc.file_type;\n        let hints: Vec\u003cInlayHint\u003e = doc\n            .dependencies\n            .iter()\n            .filter(|dep| {\n                // Only show hints for dependencies in the visible range\n                let line = dep.line;\n                line \u003e= params.range.start.line \u0026\u0026 line \u003c= params.range.end.line\n            })\n            .filter(|dep| {\n                // Skip ignored packages\n                !ignored_packages.iter().any(|pattern| {\n                    if pattern.contains('*') {\n                        let parts: Vec\u003c\u0026str\u003e = pattern.split('*').collect();\n                        if parts.len() == 2 {\n                            dep.name.starts_with(parts[0]) \u0026\u0026 dep.name.ends_with(parts[1])\n                        } else {\n                            dep.name.starts_with(parts[0])\n                        }\n                    } else {\n                        dep.name == *pattern\n                    }\n                })\n            })\n            .filter_map(|dep| {\n                let cache_key = file_type.cache_key(\u0026dep.name);\n                let version_info = self.version_cache.get(\u0026cache_key);\n                let hint = create_inlay_hint(dep, version_info.as_ref());\n\n                // Optionally filter out up-to-date hints\n                if !show_up_to_date {\n                    let label_text = match \u0026hint.label {\n                        InlayHintLabel::String(s) =\u003e s.clone(),\n                        InlayHintLabel::LabelParts(parts) =\u003e {\n                            parts.iter().map(|p| p.value.as_str()).collect()\n                        }\n                    };\n                    if label_text.contains(\"[OK]\") {\n                        return None;\n                    }\n                }\n                Some(hint)\n            })\n            .collect();\n\n        tracing::debug!(\"Returning {} inlay hints for {}\", hints.len(), uri);\n        Ok(Some(hints))\n    }\n\n    async fn hover(\u0026self, params: HoverParams) -\u003e Result\u003cOption\u003cHover\u003e\u003e {\n        let uri = \u0026params.text_document_position_params.text_document.uri;\n        let position = params.text_document_position_params.position;\n\n        let Some(doc) = self.documents.get(uri) else {\n            return Ok(None);\n        };\n\n        let file_type = doc.file_type;\n\n        // Find dependency at this position\n        let dep = doc.dependencies.iter().find(|d| {\n            d.line == position.line\n                \u0026\u0026 position.character \u003e= d.name_start\n                \u0026\u0026 position.character \u003c= d.version_end\n        });\n\n        let Some(dep) = dep.cloned() else {\n            return Ok(None);\n        };\n\n        // Drop the lock before async call\n        drop(doc);\n\n        // Get version info\n        let version_info = self.get_version_info(file_type, \u0026dep.name).await;\n\n        let content = match version_info {\n            Some(info) =\u003e {\n                let mut parts = vec![format!(\"## {}\\n\", dep.name)];\n\n                if let Some(desc) = \u0026info.description {\n                    parts.push(format!(\"{}\\n\", desc));\n                }\n\n                // Current version with release date\n                let current_date_str = info\n                    .get_release_date(\u0026dep.version)\n                    .map(|dt| format!(\" ({})\", format_release_age(dt)))\n                    .unwrap_or_default();\n                parts.push(format!(\"**Current:** {}{}\", dep.version, current_date_str));\n\n                if let Some(latest) = \u0026info.latest {\n                    let latest_date_str = info\n                        .get_release_date(latest)\n                        .map(|dt| format!(\" ({})\", format_release_age(dt)))\n                        .unwrap_or_default();\n                    parts.push(format!(\"**Latest:** {}{}\", latest, latest_date_str));\n                }\n\n                if let Some(license) = \u0026info.license {\n                    parts.push(format!(\"**License:** {}\", license));\n                }\n\n                if let Some(repo) = \u0026info.repository {\n                    parts.push(format!(\"\\n[Repository]({})\", repo));\n                }\n\n                if let Some(homepage) = \u0026info.homepage {\n                    parts.push(format!(\"[Homepage]({})\", homepage));\n                }\n\n                // Add vulnerability information if present\n                if !info.vulnerabilities.is_empty() {\n                    parts.push(format!(\n                        \"\\n### ⚠ {} Security {}\",\n                        info.vulnerabilities.len(),\n                        if info.vulnerabilities.len() == 1 {\n                            \"Vulnerability\"\n                        } else {\n                            \"Vulnerabilities\"\n                        }\n                    ));\n\n                    for vuln in \u0026info.vulnerabilities {\n                        let severity_icon = match vuln.severity {\n                            VulnerabilitySeverity::Critical =\u003e \"⚠\",\n                            VulnerabilitySeverity::High =\u003e \"▲\",\n                            VulnerabilitySeverity::Medium =\u003e \"●\",\n                            VulnerabilitySeverity::Low =\u003e \"○\",\n                        };\n                        let severity_str = match vuln.severity {\n                            VulnerabilitySeverity::Critical =\u003e \"CRITICAL\",\n                            VulnerabilitySeverity::High =\u003e \"HIGH\",\n                            VulnerabilitySeverity::Medium =\u003e \"MEDIUM\",\n                            VulnerabilitySeverity::Low =\u003e \"LOW\",\n                        };\n\n                        if let Some(url) = \u0026vuln.url {\n                            parts.push(format!(\n                                \"\\n#### [{}]({}) - {} {}\",\n                                vuln.id, url, severity_icon, severity_str\n                            ));\n                        } else {\n                            parts.push(format!(\n                                \"\\n#### {} - {} {}\",\n                                vuln.id, severity_icon, severity_str\n                            ));\n                        }\n                        parts.push(vuln.description.clone());\n                    }\n                }\n\n                parts.join(\"\\n\")\n            }\n            None =\u003e format!(\"## {}\\n\\nCould not fetch package information.\", dep.name),\n        };\n\n        Ok(Some(Hover {\n            contents: HoverContents::Markup(MarkupContent {\n                kind: MarkupKind::Markdown,\n                value: content,\n            }),\n            range: Some(Range {\n                start: Position {\n                    line: dep.line,\n                    character: dep.name_start,\n                },\n                end: Position {\n                    line: dep.line,\n                    character: dep.version_end,\n                },\n            }),\n        }))\n    }\n\n    async fn code_action(\u0026self, params: CodeActionParams) -\u003e Result\u003cOption\u003cCodeActionResponse\u003e\u003e {\n        let uri = \u0026params.text_document.uri;\n\n        let Some(doc) = self.documents.get(uri) else {\n            return Ok(Some(vec![]));\n        };\n\n        let file_type = doc.file_type;\n        let actions = create_code_actions(\n            \u0026doc.dependencies,\n            \u0026self.version_cache,\n            uri,\n            params.range,\n            file_type,\n            |name| file_type.cache_key(name),\n        );\n\n        Ok(Some(actions))\n    }\n\n    async fn completion(\u0026self, params: CompletionParams) -\u003e Result\u003cOption\u003cCompletionResponse\u003e\u003e {\n        let uri = \u0026params.text_document_position.text_document.uri;\n        let position = params.text_document_position.position;\n\n        let Some(doc) = self.documents.get(uri) else {\n            return Ok(Some(CompletionResponse::Array(vec![])));\n        };\n\n        let file_type = doc.file_type;\n        let completions =\n            get_completions(\u0026doc.dependencies, position, \u0026self.version_cache, |name| {\n                file_type.cache_key(name)\n            });\n\n        match completions {\n            Some(items) =\u003e Ok(Some(CompletionResponse::Array(items))),\n            None =\u003e Ok(Some(CompletionResponse::Array(vec![]))),\n        }\n    }\n\n    async fn execute_command(\n        \u0026self,\n        params: ExecuteCommandParams,\n    ) -\u003e Result\u003cOption\u003cserde_json::Value\u003e\u003e {\n        match params.command.as_str() {\n            \"dependi/generateReport\" =\u003e {\n                let report = self.generate_vulnerability_report(\u0026params.arguments).await;\n                Ok(Some(report))\n            }\n            _ =\u003e {\n                tracing::warn!(\"Unknown command: {}\", params.command);\n                Ok(None)\n            }\n        }\n    }\n}\n","traces":[{"line":86,"address":[14433952],"length":1,"stats":{"Line":0}},{"line":87,"address":[19085681],"length":1,"stats":{"Line":0}},{"line":90,"address":[19083664,19085422,19085460],"length":1,"stats":{"Line":0}},{"line":91,"address":[13094794,13094889],"length":1,"stats":{"Line":0}},{"line":92,"address":[18601745],"length":1,"stats":{"Line":0}},{"line":97,"address":[13095004,13094937],"length":1,"stats":{"Line":0}},{"line":98,"address":[14432011],"length":1,"stats":{"Line":0}},{"line":99,"address":[13095071,13095123],"length":1,"stats":{"Line":0}},{"line":100,"address":[19084082],"length":1,"stats":{"Line":0}},{"line":101,"address":[13095198],"length":1,"stats":{"Line":0}},{"line":102,"address":[14432237],"length":1,"stats":{"Line":0}},{"line":103,"address":[13095212],"length":1,"stats":{"Line":0}},{"line":104,"address":[14450547],"length":1,"stats":{"Line":0}},{"line":105,"address":[13095226],"length":1,"stats":{"Line":0}},{"line":106,"address":[19084161],"length":1,"stats":{"Line":0}},{"line":107,"address":[14432292],"length":1,"stats":{"Line":0}},{"line":108,"address":[14450591],"length":1,"stats":{"Line":0}},{"line":109,"address":[14432473,14432400],"length":1,"stats":{"Line":0}},{"line":110,"address":[14432602,14432529],"length":1,"stats":{"Line":0}},{"line":111,"address":[14432658,14432731],"length":1,"stats":{"Line":0}},{"line":112,"address":[14432860,14432787],"length":1,"stats":{"Line":0}},{"line":113,"address":[13095783,13095845],"length":1,"stats":{"Line":0}},{"line":114,"address":[13095955,13095893],"length":1,"stats":{"Line":0}},{"line":115,"address":[19084923,19085002],"length":1,"stats":{"Line":0}},{"line":116,"address":[19085035,19085087],"length":1,"stats":{"Line":0}},{"line":117,"address":[14433387,14433447],"length":1,"stats":{"Line":0}},{"line":121,"address":[14431168],"length":1,"stats":{"Line":0}},{"line":122,"address":[13094322,13094238],"length":1,"stats":{"Line":0}},{"line":123,"address":[19083272],"length":1,"stats":{"Line":0}},{"line":124,"address":[13094378],"length":1,"stats":{"Line":0}},{"line":125,"address":[14431408],"length":1,"stats":{"Line":0}},{"line":126,"address":[14449731],"length":1,"stats":{"Line":0}},{"line":127,"address":[14449769],"length":1,"stats":{"Line":0}},{"line":128,"address":[14449807],"length":1,"stats":{"Line":0}},{"line":129,"address":[14431557],"length":1,"stats":{"Line":0}},{"line":130,"address":[14431595],"length":1,"stats":{"Line":0}},{"line":131,"address":[19083235],"length":1,"stats":{"Line":0}},{"line":135,"address":[14431616],"length":1,"stats":{"Line":0}},{"line":140,"address":[13687325,13687052],"length":1,"stats":{"Line":0}},{"line":143,"address":[14236274,14236165],"length":1,"stats":{"Line":0}},{"line":144,"address":[14254704],"length":1,"stats":{"Line":0}},{"line":148,"address":[13687608],"length":1,"stats":{"Line":0}},{"line":149,"address":[14235942,14237951,14236557,14236869],"length":1,"stats":{"Line":0}},{"line":150,"address":[13688118,13687751,13687127,13689303],"length":1,"stats":{"Line":0}},{"line":151,"address":[15193543],"length":1,"stats":{"Line":0}},{"line":152,"address":[18581393,18582584,18584069,18582043],"length":1,"stats":{"Line":0}},{"line":153,"address":[14255689,14254997,14254314,14257420],"length":1,"stats":{"Line":0}},{"line":154,"address":[14237534,14239415,14236747,14236047],"length":1,"stats":{"Line":0}},{"line":155,"address":[14257980,14255073,14254356,14255955],"length":1,"stats":{"Line":0}},{"line":156,"address":[12771362],"length":1,"stats":{"Line":0}},{"line":159,"address":[14256511],"length":1,"stats":{"Line":0}},{"line":160,"address":[14258579],"length":1,"stats":{"Line":0}},{"line":161,"address":[13691466,13691242,13691492,13691306],"length":1,"stats":{"Line":0}},{"line":162,"address":[14258747],"length":1,"stats":{"Line":0}},{"line":164,"address":[14258502],"length":1,"stats":{"Line":0}},{"line":165,"address":[14240894,14240230,14240631],"length":1,"stats":{"Line":0}},{"line":166,"address":[18586016],"length":1,"stats":{"Line":0}},{"line":171,"address":[19085552],"length":1,"stats":{"Line":0}},{"line":181,"address":[14266436,14266234],"length":1,"stats":{"Line":0}},{"line":184,"address":[14266438,14266619],"length":1,"stats":{"Line":0}},{"line":186,"address":[14294990,14294752,14284824,14294984],"length":1,"stats":{"Line":0}},{"line":187,"address":[18620110],"length":1,"stats":{"Line":0}},{"line":188,"address":[18620190,18620250],"length":1,"stats":{"Line":0}},{"line":190,"address":[14276192,14276324,14266577,14276385,14276391],"length":1,"stats":{"Line":0}},{"line":191,"address":[13725988],"length":1,"stats":{"Line":0}},{"line":192,"address":[18620509],"length":1,"stats":{"Line":0}},{"line":193,"address":[18620538],"length":1,"stats":{"Line":0}},{"line":197,"address":[13716471,13716402],"length":1,"stats":{"Line":0}},{"line":198,"address":[14286172,14285049,14285881],"length":1,"stats":{"Line":0}},{"line":202,"address":[13716891],"length":1,"stats":{"Line":0}},{"line":208,"address":[18610306,18611040,18611371,18612406],"length":1,"stats":{"Line":0}},{"line":209,"address":[13718519],"length":1,"stats":{"Line":0}},{"line":210,"address":[13718547],"length":1,"stats":{"Line":0}},{"line":213,"address":[18612781,18617977,18612871],"length":1,"stats":{"Line":0}},{"line":215,"address":[14269393,14270713],"length":1,"stats":{"Line":0}},{"line":217,"address":[14289177,14289105],"length":1,"stats":{"Line":0}},{"line":220,"address":[18614926,18614832],"length":1,"stats":{"Line":0}},{"line":221,"address":[13722861,13720852,13720736],"length":1,"stats":{"Line":0}},{"line":222,"address":[14289744,14289634,14289725],"length":1,"stats":{"Line":0}},{"line":223,"address":[18615420],"length":1,"stats":{"Line":0}},{"line":224,"address":[18615433],"length":1,"stats":{"Line":0}},{"line":225,"address":[13721246],"length":1,"stats":{"Line":0}},{"line":231,"address":[14272775],"length":1,"stats":{"Line":0}},{"line":238,"address":[14290846],"length":1,"stats":{"Line":0}},{"line":239,"address":[14291512,14291571],"length":1,"stats":{"Line":0}},{"line":241,"address":[13720965,13723226],"length":1,"stats":{"Line":0}},{"line":247,"address":[14269763,14269432],"length":1,"stats":{"Line":0}},{"line":253,"address":[14270039,14270338,14269732],"length":1,"stats":{"Line":0}},{"line":254,"address":[14288600,14293275,14288864],"length":1,"stats":{"Line":0}},{"line":255,"address":[18614168],"length":1,"stats":{"Line":0}},{"line":256,"address":[18610327,18618843,18614457,18614389,18618609],"length":1,"stats":{"Line":0}},{"line":258,"address":[14275385,14275112,14275170],"length":1,"stats":{"Line":0}},{"line":259,"address":[14275116],"length":1,"stats":{"Line":0}},{"line":260,"address":[13724751,13724782,13725013,13724683,13716124],"length":1,"stats":{"Line":0}},{"line":263,"address":[18619547,18619270],"length":1,"stats":{"Line":0}},{"line":265,"address":[13718465],"length":1,"stats":{"Line":0}},{"line":266,"address":[14268816,14274304,14274549],"length":1,"stats":{"Line":0}},{"line":274,"address":[13692276,13692525,13692554,13692461,13692240,13696685,13692504,13695225],"length":1,"stats":{"Line":0}},{"line":275,"address":[14259983,14259816],"length":1,"stats":{"Line":0}},{"line":279,"address":[13692674],"length":1,"stats":{"Line":0}},{"line":281,"address":[13692698,13693255,13692777,13693088],"length":1,"stats":{"Line":0}},{"line":288,"address":[14242655,14242150],"length":1,"stats":{"Line":0}},{"line":289,"address":[18587873,18587770],"length":1,"stats":{"Line":0}},{"line":290,"address":[14261171,14261060],"length":1,"stats":{"Line":0}},{"line":291,"address":[18588079,18587979],"length":1,"stats":{"Line":0}},{"line":292,"address":[14243111,14243000],"length":1,"stats":{"Line":0}},{"line":293,"address":[14243114,14243225],"length":1,"stats":{"Line":0}},{"line":294,"address":[14261627,14261516],"length":1,"stats":{"Line":0}},{"line":295,"address":[14243342,14243453],"length":1,"stats":{"Line":0}},{"line":296,"address":[14243567,14243456],"length":1,"stats":{"Line":0}},{"line":298,"address":[14261858],"length":1,"stats":{"Line":0}},{"line":300,"address":[18593958,18593964,18588735,18592912],"length":1,"stats":{"Line":0}},{"line":301,"address":[13698403],"length":1,"stats":{"Line":0}},{"line":302,"address":[13698435,13698531],"length":1,"stats":{"Line":0}},{"line":303,"address":[14247998,14248072],"length":1,"stats":{"Line":0}},{"line":304,"address":[14248151,14248080],"length":1,"stats":{"Line":0}},{"line":305,"address":[14248230,14248159],"length":1,"stats":{"Line":0}},{"line":306,"address":[14248238,14248309],"length":1,"stats":{"Line":0}},{"line":307,"address":[14266605,14266676],"length":1,"stats":{"Line":0}},{"line":308,"address":[18593536,18593473],"length":1,"stats":{"Line":0}},{"line":309,"address":[14248546,14248475],"length":1,"stats":{"Line":0}},{"line":310,"address":[14266842,14266913],"length":1,"stats":{"Line":0}},{"line":311,"address":[14248714,14248633],"length":1,"stats":{"Line":0}},{"line":312,"address":[18595018,18594768,18594859,18597607,18597531,18595123,18595039,18594997,18595060,18593767,18595081,18594954,18595102],"length":1,"stats":{"Line":0}},{"line":314,"address":[14268832,14268521],"length":1,"stats":{"Line":0}},{"line":318,"address":[14250695],"length":1,"stats":{"Line":0}},{"line":319,"address":[13704383,13701720,13702120,13702360],"length":1,"stats":{"Line":0}},{"line":320,"address":[13704685,13702150,13701741,13702520],"length":1,"stats":{"Line":0}},{"line":321,"address":[14253783,14250354,14250807,14251355],"length":1,"stats":{"Line":0}},{"line":322,"address":[13701783,13705203,13702840,13702210],"length":1,"stats":{"Line":0}},{"line":323,"address":[13705444,13702240,13703000,13701804],"length":1,"stats":{"Line":0}},{"line":324,"address":[14250909,14250417,14251871,14254560],"length":1,"stats":{"Line":0}},{"line":325,"address":[14254813,14250943,14252043,14250438],"length":1,"stats":{"Line":0}},{"line":326,"address":[14255066,14250459,14250977,14252215],"length":1,"stats":{"Line":0}},{"line":328,"address":[14255311,14253458,14255478],"length":1,"stats":{"Line":0}},{"line":329,"address":[14273650],"length":1,"stats":{"Line":0}},{"line":336,"address":[13694722,13694809],"length":1,"stats":{"Line":0}},{"line":337,"address":[13694871],"length":1,"stats":{"Line":0}},{"line":339,"address":[14268144,14268342,14262505,14268371],"length":1,"stats":{"Line":0}},{"line":340,"address":[14268164,14268247],"length":1,"stats":{"Line":0}},{"line":341,"address":[18600784,18601444,18601081,18594639,18601642,18600923,18600809,18600886],"length":1,"stats":{"Line":0}},{"line":342,"address":[18600849,18600991,18600913,18601112],"length":1,"stats":{"Line":0}},{"line":343,"address":[12798048],"length":1,"stats":{"Line":0}},{"line":349,"address":[14262666,14263149,14262563],"length":1,"stats":{"Line":0}},{"line":350,"address":[14263103,14259871,14264296,14262825,14263205,14262791],"length":1,"stats":{"Line":0}},{"line":354,"address":[13695714,13695706,13695904],"length":1,"stats":{"Line":0}},{"line":355,"address":[18589955,18590005,18589934],"length":1,"stats":{"Line":0}},{"line":356,"address":[18590089],"length":1,"stats":{"Line":0}},{"line":357,"address":[14245053],"length":1,"stats":{"Line":0}},{"line":358,"address":[18590083],"length":1,"stats":{"Line":0}},{"line":363,"address":[14263683,14263538,14263627],"length":1,"stats":{"Line":0}},{"line":366,"address":[13699664,13699925,13696016,13699931],"length":1,"stats":{"Line":0}},{"line":368,"address":[14267246,14267307],"length":1,"stats":{"Line":0}},{"line":369,"address":[13699743],"length":1,"stats":{"Line":0}},{"line":370,"address":[14249059,14249168,14249096],"length":1,"stats":{"Line":0}},{"line":371,"address":[13699807,13699841],"length":1,"stats":{"Line":0}},{"line":373,"address":[14267379],"length":1,"stats":{"Line":0}},{"line":375,"address":[13699875,13699824],"length":1,"stats":{"Line":0}},{"line":378,"address":[14245360,14245307],"length":1,"stats":{"Line":0}},{"line":380,"address":[13696906,13696202],"length":1,"stats":{"Line":0}},{"line":381,"address":[18590482,18590468],"length":1,"stats":{"Line":0}},{"line":382,"address":[14263840],"length":1,"stats":{"Line":0}},{"line":384,"address":[13696250],"length":1,"stats":{"Line":0}},{"line":387,"address":[13696279],"length":1,"stats":{"Line":0}},{"line":388,"address":[18590584],"length":1,"stats":{"Line":0}},{"line":389,"address":[14249264,14249291,14245660],"length":1,"stats":{"Line":0}},{"line":393,"address":[13696414,13696611],"length":1,"stats":{"Line":0}},{"line":394,"address":[18590647,18590727],"length":1,"stats":{"Line":0}},{"line":395,"address":[14246028,14245876,14241604,14245944],"length":1,"stats":{"Line":0}},{"line":399,"address":[18591170,18590438,18591412],"length":1,"stats":{"Line":0}},{"line":400,"address":[14245506],"length":1,"stats":{"Line":0}},{"line":401,"address":[12721749],"length":1,"stats":{"Line":0}},{"line":405,"address":[14246625],"length":1,"stats":{"Line":0}},{"line":406,"address":[13697426,13697364],"length":1,"stats":{"Line":0}},{"line":407,"address":[14265129,14265046],"length":1,"stats":{"Line":0}},{"line":408,"address":[14265145,14265228],"length":1,"stats":{"Line":0}},{"line":409,"address":[13697624,13697703],"length":1,"stats":{"Line":0}},{"line":410,"address":[18591943,18592010],"length":1,"stats":{"Line":0}},{"line":412,"address":[13700179,13700000,13700286,13697794,13700140,13700485,13700025],"length":1,"stats":{"Line":0}},{"line":413,"address":[14267870,14267720],"length":1,"stats":{"Line":0}},{"line":414,"address":[13700065],"length":1,"stats":{"Line":0}},{"line":416,"address":[18594120],"length":1,"stats":{"Line":0}},{"line":417,"address":[13700092],"length":1,"stats":{"Line":0}},{"line":418,"address":[14267712],"length":1,"stats":{"Line":0}},{"line":419,"address":[14249428],"length":1,"stats":{"Line":0}},{"line":421,"address":[18594199,18594349,18594266,18594302],"length":1,"stats":{"Line":0}},{"line":427,"address":[19085504],"length":1,"stats":{"Line":0}},{"line":432,"address":[14258073],"length":1,"stats":{"Line":0}},{"line":434,"address":[14276220,14284313,14284304],"length":1,"stats":{"Line":0}},{"line":435,"address":[13707919,13715769,13715760],"length":1,"stats":{"Line":0}},{"line":438,"address":[13708152],"length":1,"stats":{"Line":0}},{"line":440,"address":[13708090,13715705,13715696],"length":1,"stats":{"Line":0}},{"line":441,"address":[18609984,18609993,18602337],"length":1,"stats":{"Line":0}},{"line":444,"address":[18602392,18603445,18603389],"length":1,"stats":{"Line":0}},{"line":445,"address":[13708239,13708276,13708339],"length":1,"stats":{"Line":0}},{"line":446,"address":[14258503,14258578],"length":1,"stats":{"Line":0}},{"line":447,"address":[14276945,14277146],"length":1,"stats":{"Line":0}},{"line":449,"address":[18602827],"length":1,"stats":{"Line":0}},{"line":452,"address":[18603692,18603589,18603627,18604072,18602545],"length":1,"stats":{"Line":0}},{"line":458,"address":[13708254,13709943,13709896],"length":1,"stats":{"Line":0}},{"line":460,"address":[14278390,14278499],"length":1,"stats":{"Line":0}},{"line":461,"address":[14260294,14260218],"length":1,"stats":{"Line":0}},{"line":464,"address":[14265490,14265445,14265559],"length":1,"stats":{"Line":0}},{"line":470,"address":[18603543,18604701],"length":1,"stats":{"Line":0}},{"line":471,"address":[14283339,14283634,14278981,14283270,14283232],"length":1,"stats":{"Line":0}},{"line":477,"address":[18604770],"length":1,"stats":{"Line":0}},{"line":478,"address":[18604843],"length":1,"stats":{"Line":0}},{"line":480,"address":[18604895],"length":1,"stats":{"Line":0}},{"line":481,"address":[14260968,14263229],"length":1,"stats":{"Line":0}},{"line":482,"address":[13713176,13713075],"length":1,"stats":{"Line":0}},{"line":483,"address":[14263543,14263438],"length":1,"stats":{"Line":0}},{"line":484,"address":[14282026,14281989,14281936],"length":1,"stats":{"Line":0}},{"line":485,"address":[14263708],"length":1,"stats":{"Line":0}},{"line":486,"address":[18608014,18607852],"length":1,"stats":{"Line":0}},{"line":487,"address":[13713602,13713756],"length":1,"stats":{"Line":0}},{"line":488,"address":[14282068,14282214],"length":1,"stats":{"Line":0}},{"line":489,"address":[14282046,14282153],"length":1,"stats":{"Line":0}},{"line":492,"address":[18608596],"length":1,"stats":{"Line":0}},{"line":493,"address":[18607923],"length":1,"stats":{"Line":0}},{"line":494,"address":[14264032],"length":1,"stats":{"Line":0}},{"line":495,"address":[13713900],"length":1,"stats":{"Line":0}},{"line":496,"address":[13713965,13714215,13714036],"length":1,"stats":{"Line":0}},{"line":497,"address":[13714239],"length":1,"stats":{"Line":0}},{"line":498,"address":[13714308],"length":1,"stats":{"Line":0}},{"line":506,"address":[14279298],"length":1,"stats":{"Line":0}},{"line":507,"address":[14280549,14279352],"length":1,"stats":{"Line":0}},{"line":508,"address":[13712286,13712132,13712221,13712584,13712517,13712972,13712183],"length":1,"stats":{"Line":0}},{"line":515,"address":[14280112,14279720,14279384,14279787,14280450,14279422,14279345,14279492,14279971,14280041],"length":1,"stats":{"Line":0}},{"line":518,"address":[13711582],"length":1,"stats":{"Line":0}},{"line":527,"address":[14287101,14280896,14281243,14286529,14286226,14281221,14280973,14281363,14286188,14286406,14286466,14282645,14286346,14286286,14281103,14281470],"length":1,"stats":{"Line":0}},{"line":529,"address":[13730918,13730701],"length":1,"stats":{"Line":0}},{"line":530,"address":[18625217,18625470,18625150],"length":1,"stats":{"Line":0}},{"line":533,"address":[14282129,14281817,14282092],"length":1,"stats":{"Line":0}},{"line":534,"address":[13731973,13731671,13731555,13732004,13731729],"length":1,"stats":{"Line":0}},{"line":537,"address":[14285743],"length":1,"stats":{"Line":0}},{"line":538,"address":[14282799],"length":1,"stats":{"Line":0}},{"line":539,"address":[18626166],"length":1,"stats":{"Line":0}},{"line":540,"address":[14282767,14282692],"length":1,"stats":{"Line":0}},{"line":542,"address":[14284331],"length":1,"stats":{"Line":0}},{"line":543,"address":[14301199],"length":1,"stats":{"Line":0}},{"line":546,"address":[18626531],"length":1,"stats":{"Line":0}},{"line":548,"address":[18626621],"length":1,"stats":{"Line":0}},{"line":549,"address":[14301914],"length":1,"stats":{"Line":0}},{"line":550,"address":[13732885,13732465,13736259,13732526],"length":1,"stats":{"Line":0}},{"line":551,"address":[14301863],"length":1,"stats":{"Line":0}},{"line":553,"address":[18627772],"length":1,"stats":{"Line":0}},{"line":554,"address":[14286728,14283867,14283806],"length":1,"stats":{"Line":0}},{"line":555,"address":[14284143],"length":1,"stats":{"Line":0}},{"line":557,"address":[13733622],"length":1,"stats":{"Line":0}},{"line":562,"address":[14434559],"length":1,"stats":{"Line":0}},{"line":563,"address":[13742503,13742661],"length":1,"stats":{"Line":0}},{"line":564,"address":[14311627],"length":1,"stats":{"Line":0}},{"line":565,"address":[18636870,18636968,18636915,18636794],"length":1,"stats":{"Line":0}},{"line":568,"address":[13742913],"length":1,"stats":{"Line":0}},{"line":569,"address":[14293847,14293926],"length":1,"stats":{"Line":0}},{"line":570,"address":[14312418],"length":1,"stats":{"Line":0}},{"line":571,"address":[14312658],"length":1,"stats":{"Line":0}},{"line":572,"address":[13743667],"length":1,"stats":{"Line":0}},{"line":573,"address":[18638107],"length":1,"stats":{"Line":0}},{"line":574,"address":[14313360],"length":1,"stats":{"Line":0}},{"line":575,"address":[14295294],"length":1,"stats":{"Line":0}},{"line":577,"address":[13744469,13744739],"length":1,"stats":{"Line":0}},{"line":580,"address":[18651719,18651883,18651790,18651654,18651797,18651838,18652379,18651616,18652187],"length":1,"stats":{"Line":0}},{"line":581,"address":[13757584,13757968,13757702],"length":1,"stats":{"Line":0}},{"line":582,"address":[13757925],"length":1,"stats":{"Line":0}},{"line":585,"address":[12472626,12472683,12472665],"length":1,"stats":{"Line":0}},{"line":586,"address":[18648901],"length":1,"stats":{"Line":0}},{"line":587,"address":[13754761],"length":1,"stats":{"Line":0}},{"line":589,"address":[14324245,14324365,14324634],"length":1,"stats":{"Line":0}},{"line":590,"address":[15216564],"length":1,"stats":{"Line":0}},{"line":593,"address":[19087071],"length":1,"stats":{"Line":0}},{"line":594,"address":[14279332],"length":1,"stats":{"Line":0}},{"line":597,"address":[14297939,14297861,14297710],"length":1,"stats":{"Line":0}},{"line":598,"address":[14298036,14298139,14298406],"length":1,"stats":{"Line":0}},{"line":599,"address":[15218404],"length":1,"stats":{"Line":0}},{"line":603,"address":[13097663],"length":1,"stats":{"Line":0}},{"line":604,"address":[13756123],"length":1,"stats":{"Line":0}},{"line":607,"address":[14325726,14325640],"length":1,"stats":{"Line":0}},{"line":608,"address":[18650490,18650862,18650593],"length":1,"stats":{"Line":0}},{"line":609,"address":[12785828],"length":1,"stats":{"Line":0}},{"line":613,"address":[18653673,18652464,18653907,18652742,18653869,18652489],"length":1,"stats":{"Line":0}},{"line":614,"address":[13758405],"length":1,"stats":{"Line":0}},{"line":615,"address":[13758863,13758604,13758493],"length":1,"stats":{"Line":0}},{"line":616,"address":[14328634,14328357],"length":1,"stats":{"Line":0}},{"line":619,"address":[18652769,18653710,18653464,18653350],"length":1,"stats":{"Line":0}},{"line":622,"address":[19087279],"length":1,"stats":{"Line":0}},{"line":624,"address":[14305948,14306045],"length":1,"stats":{"Line":0}},{"line":625,"address":[14306203,14306127],"length":1,"stats":{"Line":0}},{"line":626,"address":[14287921,14287964],"length":1,"stats":{"Line":0}},{"line":628,"address":[14288096,14287940],"length":1,"stats":{"Line":0}},{"line":629,"address":[18631662],"length":1,"stats":{"Line":0}},{"line":630,"address":[18631702],"length":1,"stats":{"Line":0}},{"line":632,"address":[14306541],"length":1,"stats":{"Line":0}},{"line":634,"address":[14288261],"length":1,"stats":{"Line":0}},{"line":635,"address":[14289727,14288379],"length":1,"stats":{"Line":0}},{"line":638,"address":[18631899,18631974],"length":1,"stats":{"Line":0}},{"line":639,"address":[13737768],"length":1,"stats":{"Line":0}},{"line":642,"address":[14309360,14306839],"length":1,"stats":{"Line":0}},{"line":644,"address":[14291087],"length":1,"stats":{"Line":0}},{"line":645,"address":[13740317],"length":1,"stats":{"Line":0}},{"line":647,"address":[14306874,14309280],"length":1,"stats":{"Line":0}},{"line":649,"address":[14291996,14291248,14291010,14292002],"length":1,"stats":{"Line":0}},{"line":650,"address":[14291306],"length":1,"stats":{"Line":0}},{"line":651,"address":[18634815],"length":1,"stats":{"Line":0}},{"line":652,"address":[13740710,13740622],"length":1,"stats":{"Line":0}},{"line":653,"address":[13740966,13740724,13740807],"length":1,"stats":{"Line":0}},{"line":655,"address":[18635030,18635346],"length":1,"stats":{"Line":0}},{"line":658,"address":[14309636],"length":1,"stats":{"Line":0}},{"line":662,"address":[13739360,13740242,13737917,13740264],"length":1,"stats":{"Line":0}},{"line":663,"address":[14290070],"length":1,"stats":{"Line":0}},{"line":664,"address":[14308443,14308550],"length":1,"stats":{"Line":0}},{"line":665,"address":[13739692,13739625],"length":1,"stats":{"Line":0}},{"line":668,"address":[18633851],"length":1,"stats":{"Line":0}},{"line":669,"address":[18633860],"length":1,"stats":{"Line":0}},{"line":670,"address":[18633994,18634073],"length":1,"stats":{"Line":0}},{"line":671,"address":[13739817],"length":1,"stats":{"Line":0}},{"line":672,"address":[18633977,18634665,18634110,18634640],"length":1,"stats":{"Line":0}},{"line":675,"address":[14290793,14290626],"length":1,"stats":{"Line":0}},{"line":676,"address":[14290857],"length":1,"stats":{"Line":0}},{"line":679,"address":[18633919],"length":1,"stats":{"Line":0}},{"line":683,"address":[14289157,14288731,14288804],"length":1,"stats":{"Line":0}},{"line":684,"address":[18632519],"length":1,"stats":{"Line":0}},{"line":687,"address":[14299734,14299855,14299708,14298254,14302504,14298546,14298572,14304998,14298362,14298142,14305058,14298080],"length":1,"stats":{"Line":0}},{"line":688,"address":[14316771],"length":1,"stats":{"Line":0}},{"line":689,"address":[13747435],"length":1,"stats":{"Line":0}},{"line":691,"address":[13747459,13747552],"length":1,"stats":{"Line":0}},{"line":692,"address":[14298717],"length":1,"stats":{"Line":0}},{"line":695,"address":[18642006,18641862],"length":1,"stats":{"Line":0}},{"line":698,"address":[14298863,14305072],"length":1,"stats":{"Line":0}},{"line":699,"address":[14323380,14323393],"length":1,"stats":{"Line":0}},{"line":700,"address":[13754226],"length":1,"stats":{"Line":0}},{"line":701,"address":[13754250],"length":1,"stats":{"Line":0}},{"line":704,"address":[14317355],"length":1,"stats":{"Line":0}},{"line":705,"address":[14317575],"length":1,"stats":{"Line":0}},{"line":709,"address":[18642350],"length":1,"stats":{"Line":0}},{"line":712,"address":[18641452,18643051,18642595],"length":1,"stats":{"Line":0}},{"line":714,"address":[14318436],"length":1,"stats":{"Line":0}},{"line":715,"address":[14300213],"length":1,"stats":{"Line":0}},{"line":716,"address":[14305016,14300225,14300924],"length":1,"stats":{"Line":0}},{"line":718,"address":[13750131],"length":1,"stats":{"Line":0}},{"line":719,"address":[18644444,18644556],"length":1,"stats":{"Line":0}},{"line":724,"address":[18644479,18644720],"length":1,"stats":{"Line":0}},{"line":725,"address":[14305456,14301631,14305473],"length":1,"stats":{"Line":0}},{"line":727,"address":[13750647,13750553],"length":1,"stats":{"Line":0}},{"line":729,"address":[14320245],"length":1,"stats":{"Line":0}},{"line":731,"address":[14320318,14320424],"length":1,"stats":{"Line":0}},{"line":732,"address":[14320451,14323472,14323489],"length":1,"stats":{"Line":0}},{"line":734,"address":[18645396,18645309],"length":1,"stats":{"Line":0}},{"line":737,"address":[18645150,18645599],"length":1,"stats":{"Line":0}},{"line":738,"address":[14302531,14302623],"length":1,"stats":{"Line":0}},{"line":741,"address":[18645642,18645844],"length":1,"stats":{"Line":0}},{"line":742,"address":[18645952,18645860],"length":1,"stats":{"Line":0}},{"line":745,"address":[14321293,14321091],"length":1,"stats":{"Line":0}},{"line":746,"address":[18646105,18646154],"length":1,"stats":{"Line":0}},{"line":750,"address":[14321336,14321498],"length":1,"stats":{"Line":0}},{"line":751,"address":[14303384],"length":1,"stats":{"Line":0}},{"line":753,"address":[13752064,13752121],"length":1,"stats":{"Line":0}},{"line":754,"address":[14321635,14321573],"length":1,"stats":{"Line":0}},{"line":755,"address":[14303320],"length":1,"stats":{"Line":0}},{"line":757,"address":[18646421],"length":1,"stats":{"Line":0}},{"line":761,"address":[14303597],"length":1,"stats":{"Line":0}},{"line":762,"address":[14303745],"length":1,"stats":{"Line":0}},{"line":763,"address":[18646926],"length":1,"stats":{"Line":0}},{"line":764,"address":[18646897],"length":1,"stats":{"Line":0}},{"line":765,"address":[14303804],"length":1,"stats":{"Line":0}},{"line":766,"address":[18646839],"length":1,"stats":{"Line":0}},{"line":768,"address":[13752726],"length":1,"stats":{"Line":0}},{"line":769,"address":[13752843],"length":1,"stats":{"Line":0}},{"line":770,"address":[14303982],"length":1,"stats":{"Line":0}},{"line":771,"address":[14303953],"length":1,"stats":{"Line":0}},{"line":772,"address":[14303924],"length":1,"stats":{"Line":0}},{"line":775,"address":[18647107],"length":1,"stats":{"Line":0}},{"line":776,"address":[14304104,14304262],"length":1,"stats":{"Line":0}},{"line":781,"address":[13753024,13753383],"length":1,"stats":{"Line":0}},{"line":786,"address":[14304769,14304525],"length":1,"stats":{"Line":0}},{"line":790,"address":[14321528,14323099],"length":1,"stats":{"Line":0}},{"line":792,"address":[13749135],"length":1,"stats":{"Line":0}},{"line":795,"address":[13749484],"length":1,"stats":{"Line":0}},{"line":796,"address":[14300427],"length":1,"stats":{"Line":0}},{"line":798,"address":[13749279],"length":1,"stats":{"Line":0}},{"line":800,"address":[18643653],"length":1,"stats":{"Line":0}},{"line":802,"address":[14318805],"length":1,"stats":{"Line":0}},{"line":803,"address":[14318821],"length":1,"stats":{"Line":0}},{"line":807,"address":[18643647],"length":1,"stats":{"Line":0}},{"line":813,"address":[13097215],"length":1,"stats":{"Line":0}},{"line":814,"address":[13741497],"length":1,"stats":{"Line":0}},{"line":816,"address":[18635729,18635811],"length":1,"stats":{"Line":0}},{"line":817,"address":[14292462,14292977],"length":1,"stats":{"Line":0}},{"line":820,"address":[13741658,13741733],"length":1,"stats":{"Line":0}},{"line":822,"address":[14292543],"length":1,"stats":{"Line":0}},{"line":823,"address":[14310896],"length":1,"stats":{"Line":0}},{"line":825,"address":[18636028],"length":1,"stats":{"Line":0}},{"line":827,"address":[14311499,14311472],"length":1,"stats":{"Line":0}},{"line":830,"address":[13741876],"length":1,"stats":{"Line":0}},{"line":833,"address":[13096799],"length":1,"stats":{"Line":0}},{"line":834,"address":[14295964],"length":1,"stats":{"Line":0}},{"line":835,"address":[14277684],"length":1,"stats":{"Line":0}},{"line":837,"address":[14296094,14296008],"length":1,"stats":{"Line":0}},{"line":838,"address":[14278823,14277893],"length":1,"stats":{"Line":0}},{"line":841,"address":[18621601,18621676],"length":1,"stats":{"Line":0}},{"line":842,"address":[13728560,13727470],"length":1,"stats":{"Line":0}},{"line":844,"address":[18622811],"length":1,"stats":{"Line":0}},{"line":847,"address":[18621785],"length":1,"stats":{"Line":0}},{"line":848,"address":[18621826],"length":1,"stats":{"Line":0}},{"line":849,"address":[14296673],"length":1,"stats":{"Line":0}},{"line":853,"address":[13745596,13745170,13745065,13746385,13745378,13746947,13746545,13745498,13745024,13746911],"length":1,"stats":{"Line":0}},{"line":857,"address":[18639697],"length":1,"stats":{"Line":0}},{"line":858,"address":[14314974],"length":1,"stats":{"Line":0}},{"line":859,"address":[12477041],"length":1,"stats":{"Line":0}},{"line":860,"address":[14316109],"length":1,"stats":{"Line":0}},{"line":863,"address":[14296719,14296781,14297093],"length":1,"stats":{"Line":0}},{"line":864,"address":[14297004],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":412},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","bin","test_dates.rs"],"content":"// Quick test to verify registry date fetching\nuse dependi_lsp::registries::{\n    Registry, crates_io::CratesIoRegistry, npm::NpmRegistry, pypi::PyPiRegistry,\n};\n\n/// Quick async test program that fetches and prints version information from multiple package registries.\n///\n/// The program queries crates.io for \"serde\", npm for \"express\", and PyPI for \"flask\".\n/// For each registry it prints a sample of the first three version strings, the total\n/// count of release dates, and a sample of the first three release dates. Errors are\n/// printed to standard output.\n///\n/// # Examples\n///\n/// ```no_run\n/// // Run the compiled binary to see registry outputs:\n/// // cargo run --bin registry_test\n/// ```\n#[tokio::main]\nasync fn main() {\n    println!(\"=== Testing crates.io (serde) ===\");\n    let registry = CratesIoRegistry::default();\n    match registry.get_version_info(\"serde\").await {\n        Ok(info) =\u003e {\n            println!(\n                \"Versions: {:?}\",\n                info.versions.iter().take(3).collect::\u003cVec\u003c_\u003e\u003e()\n            );\n            println!(\"Release dates count: {}\", info.release_dates.len());\n            println!(\n                \"Sample dates: {:?}\",\n                info.release_dates.iter().take(3).collect::\u003cVec\u003c_\u003e\u003e()\n            );\n        }\n        Err(e) =\u003e println!(\"Error: {}\", e),\n    }\n\n    println!(\"\\n=== Testing npm (express) ===\");\n    let registry = NpmRegistry::default();\n    match registry.get_version_info(\"express\").await {\n        Ok(info) =\u003e {\n            println!(\n                \"Versions: {:?}\",\n                info.versions.iter().take(3).collect::\u003cVec\u003c_\u003e\u003e()\n            );\n            println!(\"Release dates count: {}\", info.release_dates.len());\n            println!(\n                \"Sample dates: {:?}\",\n                info.release_dates.iter().take(3).collect::\u003cVec\u003c_\u003e\u003e()\n            );\n        }\n        Err(e) =\u003e println!(\"Error: {}\", e),\n    }\n\n    println!(\"\\n=== Testing PyPI (flask) ===\");\n    let registry = PyPiRegistry::default();\n    match registry.get_version_info(\"flask\").await {\n        Ok(info) =\u003e {\n            println!(\n                \"Versions: {:?}\",\n                info.versions.iter().take(3).collect::\u003cVec\u003c_\u003e\u003e()\n            );\n            println!(\"Release dates count: {}\", info.release_dates.len());\n            println!(\n                \"Sample dates: {:?}\",\n                info.release_dates.iter().take(3).collect::\u003cVec\u003c_\u003e\u003e()\n            );\n        }\n        Err(e) =\u003e println!(\"Error: {}\", e),\n    }\n}\n","traces":[{"line":20,"address":[12410672,12411056,12411062],"length":1,"stats":{"Line":0}},{"line":21,"address":[12397363,12397524],"length":1,"stats":{"Line":0}},{"line":22,"address":[12397551],"length":1,"stats":{"Line":0}},{"line":23,"address":[12397645,12397422,12397767,12397570],"length":1,"stats":{"Line":0}},{"line":24,"address":[12398096],"length":1,"stats":{"Line":0}},{"line":25,"address":[12398106,12398193],"length":1,"stats":{"Line":0}},{"line":29,"address":[12398438],"length":1,"stats":{"Line":0}},{"line":30,"address":[12398575],"length":1,"stats":{"Line":0}},{"line":35,"address":[12398006,12398858],"length":1,"stats":{"Line":0}},{"line":38,"address":[12398823,12398993],"length":1,"stats":{"Line":0}},{"line":39,"address":[12399020],"length":1,"stats":{"Line":0}},{"line":40,"address":[12399219,12399043,12397443,12399126],"length":1,"stats":{"Line":0}},{"line":41,"address":[12399542],"length":1,"stats":{"Line":0}},{"line":42,"address":[12399549,12399624],"length":1,"stats":{"Line":0}},{"line":46,"address":[12399857],"length":1,"stats":{"Line":0}},{"line":47,"address":[12400076],"length":1,"stats":{"Line":0}},{"line":52,"address":[12400271,12399455],"length":1,"stats":{"Line":0}},{"line":55,"address":[12400242,12400406],"length":1,"stats":{"Line":0}},{"line":56,"address":[12400433],"length":1,"stats":{"Line":0}},{"line":57,"address":[12397464,12400456,12400539,12400632],"length":1,"stats":{"Line":0}},{"line":58,"address":[12400955],"length":1,"stats":{"Line":0}},{"line":59,"address":[12400962,12401037],"length":1,"stats":{"Line":0}},{"line":63,"address":[12401270],"length":1,"stats":{"Line":0}},{"line":64,"address":[12401489],"length":1,"stats":{"Line":0}},{"line":69,"address":[12401681,12400868],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":25},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","cache","mod.rs"],"content":"//! Cache layer for package version information\n//!\n//! This module provides traits and implementations for caching package\n//! metadata. The cache layer uses a trait hierarchy:\n//!\n//! - **ReadCache**: For read-only cache operations\n//! - **WriteCache**: Extends ReadCache with write operations\n//!\n//! This separation allows for:\n//! - Read-only cache views for providers that don't need to write\n//! - Dependency injection with minimal interface requirements\n//! - Clear separation of concerns\n\nuse std::fmt::Display;\nuse std::sync::Arc;\nuse std::time::{Duration, Instant};\n\nuse dashmap::DashMap;\n\nuse crate::registries::VersionInfo;\n\npub mod sqlite;\n\npub use sqlite::SqliteCache;\n\n/// Trait for read-only cache operations\n///\n/// This trait defines the minimal interface for reading cached values.\n/// Implementations can provide additional write operations via the\n/// [`WriteCache`] trait.\npub trait ReadCache: Send + Sync {\n    /// Get a value from the cache\n    ///\n    /// Returns `None` if the key doesn't exist or the entry is expired.\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cVersionInfo\u003e;\n\n    /// Check if a key exists in the cache (without fetching the value)\n    #[allow(dead_code)]\n    fn contains(\u0026self, key: \u0026str) -\u003e bool {\n        self.get(key).is_some()\n    }\n}\n\n/// Trait for writeable cache operations\n///\n/// This trait extends [`ReadCache`] with the ability to insert and update\n/// cache entries. Caches that support both read and write operations should\n/// implement this trait.\npub trait WriteCache: ReadCache {\n    /// Insert a value into the cache\n    ///\n    /// If a value with the same key already exists, it will be overwritten.\n    fn insert(\u0026self, key: String, value: VersionInfo);\n\n    /// Remove a value from the cache\n    #[allow(dead_code)]\n    fn remove(\u0026self, key: \u0026str);\n\n    /// Clear all entries from the cache\n    #[allow(dead_code)]\n    fn clear(\u0026self);\n}\n\n#[deprecated(since = \"0.1.0\", note = \"Use ReadCache instead\")]\npub use ReadCache as Cache;\n\nimpl\u003cT: ReadCache\u003e ReadCache for Arc\u003cT\u003e {\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cVersionInfo\u003e {\n        (**self).get(key)\n    }\n\n    fn contains(\u0026self, key: \u0026str) -\u003e bool {\n        (**self).contains(key)\n    }\n}\n\nimpl\u003cT: WriteCache\u003e WriteCache for Arc\u003cT\u003e {\n    fn insert(\u0026self, key: String, value: VersionInfo) {\n        (**self).insert(key, value)\n    }\n\n    fn remove(\u0026self, key: \u0026str) {\n        (**self).remove(key)\n    }\n\n    fn clear(\u0026self) {\n        (**self).clear()\n    }\n}\n\n/// Default TTL for cache entries (1 hour)\nconst DEFAULT_TTL: Duration = Duration::from_secs(3600);\n\n/// Cache entry with expiration\n#[derive(Debug, Clone)]\nstruct CacheEntry {\n    data: VersionInfo,\n    inserted_at: Instant,\n    ttl: Duration,\n}\n\nimpl CacheEntry {\n    fn is_expired(\u0026self) -\u003e bool {\n        self.inserted_at.elapsed() \u003e self.ttl\n    }\n}\n\n/// In-memory cache using DashMap for thread-safety\n#[derive(Clone)]\npub struct MemoryCache {\n    entries: Arc\u003cDashMap\u003cString, CacheEntry\u003e\u003e,\n    ttl: Duration,\n}\n\nimpl Default for MemoryCache {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl MemoryCache {\n    /// Create a new cache with default TTL\n    pub fn new() -\u003e Self {\n        Self {\n            entries: Arc::new(DashMap::new()),\n            ttl: DEFAULT_TTL,\n        }\n    }\n}\n\nimpl ReadCache for MemoryCache {\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cVersionInfo\u003e {\n        self.entries.get(key).and_then(|entry| {\n            if entry.is_expired() {\n                None\n            } else {\n                Some(entry.data.clone())\n            }\n        })\n    }\n}\n\nimpl WriteCache for MemoryCache {\n    fn insert(\u0026self, key: String, value: VersionInfo) {\n        self.entries.insert(\n            key,\n            CacheEntry {\n                data: value,\n                inserted_at: Instant::now(),\n                ttl: self.ttl,\n            },\n        );\n    }\n\n    fn remove(\u0026self, key: \u0026str) {\n        self.entries.remove(key);\n    }\n\n    fn clear(\u0026self) {\n        self.entries.clear();\n    }\n}\n\nimpl MemoryCache {\n    /// Remove all expired entries from the cache\n    ///\n    /// Returns the number of entries removed.\n    pub fn cleanup_expired(\u0026self) -\u003e usize {\n        let before = self.entries.len();\n        self.entries.retain(|_, entry| !entry.is_expired());\n        let removed = before - self.entries.len();\n        if removed \u003e 0 {\n            tracing::debug!(\n                \"Cleaned up {} expired cache entries ({} remaining)\",\n                removed,\n                self.entries.len()\n            );\n        }\n        removed\n    }\n\n    /// Get statistics about the cache contents\n    ///\n    /// Returns counts of total, expired, and valid entries.\n    pub fn stats(\u0026self) -\u003e CacheStats {\n        let total = self.entries.len();\n        let expired = self.entries.iter().filter(|e| e.is_expired()).count();\n        CacheStats {\n            total_entries: total,\n            expired_entries: expired,\n            valid_entries: total.saturating_sub(expired),\n        }\n    }\n\n    /// Get the number of entries in the cache (including expired)\n    #[cfg(test)]\n    pub fn len(\u0026self) -\u003e usize {\n        self.entries.len()\n    }\n\n    /// Check if the cache is empty\n    #[cfg(test)]\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.entries.is_empty()\n    }\n\n    /// Create a new cache with custom TTL\n    #[cfg(test)]\n    pub fn with_ttl(ttl: Duration) -\u003e Self {\n        Self {\n            entries: Arc::new(DashMap::new()),\n            ttl,\n        }\n    }\n}\n\n/// Statistics about cache contents\n#[derive(Debug, Clone)]\npub struct CacheStats {\n    /// Total number of entries in the cache\n    pub total_entries: usize,\n    /// Number of expired entries\n    pub expired_entries: usize,\n    /// Number of valid (non-expired) entries\n    pub valid_entries: usize,\n}\n\nimpl Display for CacheStats {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        write!(\n            f,\n            \"CacheStats {{ total: {}, expired: {}, valid: {} }}\",\n            self.total_entries, self.expired_entries, self.valid_entries\n        )\n    }\n}\n\n/// Hybrid cache that uses memory for fast access and SQLite for persistence\npub struct HybridCache {\n    memory: MemoryCache,\n    sqlite: Option\u003cArc\u003cSqliteCache\u003e\u003e,\n}\n\nimpl Default for HybridCache {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// Cleanup interval for background task (30 minutes)\nconst CLEANUP_INTERVAL: Duration = Duration::from_secs(30 * 60);\n\nimpl HybridCache {\n    /// Create a new hybrid cache\n    pub fn new() -\u003e Self {\n        let sqlite = match SqliteCache::new() {\n            Ok(cache) =\u003e {\n                tracing::info!(\"SQLite cache initialized\");\n                Some(Arc::new(cache))\n            }\n            Err(e) =\u003e {\n                tracing::warn!(\n                    \"Failed to initialize SQLite cache, using memory only: {}\",\n                    e\n                );\n                None\n            }\n        };\n\n        let memory = MemoryCache::new();\n        Self::spawn_cleanup_task(memory.clone(), sqlite.clone());\n\n        Self { memory, sqlite }\n    }\n\n    /// Spawn a background task that periodically cleans up expired entries\n    fn spawn_cleanup_task(memory: MemoryCache, sqlite: Option\u003cArc\u003cSqliteCache\u003e\u003e) {\n        tokio::spawn(async move {\n            let mut interval = tokio::time::interval(CLEANUP_INTERVAL);\n            interval.tick().await; // Skip immediate first tick\n\n            loop {\n                interval.tick().await;\n\n                let stats = memory.stats();\n                let removed = memory.cleanup_expired();\n                if removed \u003e 0 {\n                    tracing::info!(\n                        \"Background cleanup: removed {} expired entries from memory cache (was: {})\",\n                        removed,\n                        stats\n                    );\n                }\n\n                if let Some(ref sqlite) = sqlite\n                    \u0026\u0026 let Ok(rows) = sqlite.cleanup_expired()\n                    \u0026\u0026 rows \u003e 0\n                {\n                    tracing::info!(\n                        \"Background cleanup: removed {} expired entries from SQLite cache\",\n                        rows\n                    );\n                }\n            }\n        });\n    }\n}\n\nimpl ReadCache for HybridCache {\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cVersionInfo\u003e {\n        // Fast path: check memory cache first\n        if let Some(value) = self.memory.get(key) {\n            return Some(value);\n        }\n\n        // Slow path: check SQLite cache\n        if let Some(ref sqlite) = self.sqlite\n            \u0026\u0026 let Some(value) = sqlite.get(key)\n        {\n            // Populate memory cache for future fast access\n            self.memory.insert(key.to_string(), value.clone());\n            return Some(value);\n        }\n\n        None\n    }\n}\n\nimpl WriteCache for HybridCache {\n    fn insert(\u0026self, key: String, value: VersionInfo) {\n        self.memory.insert(key.clone(), value.clone());\n        if let Some(ref sqlite) = self.sqlite {\n            sqlite.insert(key, value);\n        }\n    }\n\n    fn remove(\u0026self, key: \u0026str) {\n        self.memory.remove(key);\n        if let Some(ref sqlite) = self.sqlite {\n            sqlite.remove(key);\n        }\n    }\n\n    fn clear(\u0026self) {\n        self.memory.clear();\n        if let Some(ref sqlite) = self.sqlite {\n            sqlite.clear();\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    fn create_test_version_info() -\u003e VersionInfo {\n        VersionInfo {\n            latest: Some(\"1.0.0\".to_string()),\n            latest_prerelease: None,\n            versions: vec![\"1.0.0\".to_string()],\n            description: None,\n            homepage: None,\n            repository: None,\n            license: None,\n            vulnerabilities: vec![],\n            deprecated: false,\n            yanked: false,\n            yanked_versions: vec![],\n            release_dates: Default::default(),\n        }\n    }\n\n    #[test]\n    fn test_memory_cache_cleanup_expired() {\n        let cache = MemoryCache::with_ttl(Duration::from_millis(10));\n\n        cache.insert(\"key1\".to_string(), create_test_version_info());\n        cache.insert(\"key2\".to_string(), create_test_version_info());\n\n        assert_eq!(cache.len(), 2);\n\n        // Wait for entries to expire\n        std::thread::sleep(Duration::from_millis(20));\n\n        let removed = cache.cleanup_expired();\n        assert_eq!(removed, 2);\n        assert_eq!(cache.len(), 0);\n    }\n\n    #[test]\n    fn test_memory_cache_cleanup_partial() {\n        let cache = MemoryCache::with_ttl(Duration::from_millis(200));\n\n        cache.insert(\"key1\".to_string(), create_test_version_info());\n\n        // Wait for first entry to almost expire\n        std::thread::sleep(Duration::from_millis(150));\n\n        // Insert second entry\n        cache.insert(\"key2\".to_string(), create_test_version_info());\n\n        // Wait for first to expire but not second\n        std::thread::sleep(Duration::from_millis(100));\n\n        let removed = cache.cleanup_expired();\n        assert_eq!(removed, 1);\n        assert_eq!(cache.len(), 1);\n        assert!(cache.get(\"key2\").is_some());\n    }\n\n    #[test]\n    fn test_memory_cache_stats() {\n        let cache = MemoryCache::with_ttl(Duration::from_millis(100));\n\n        cache.insert(\"key1\".to_string(), create_test_version_info());\n        cache.insert(\"key2\".to_string(), create_test_version_info());\n\n        let stats = cache.stats();\n        assert_eq!(stats.total_entries, 2);\n        assert_eq!(stats.expired_entries, 0);\n        assert_eq!(stats.valid_entries, 2);\n\n        // Wait for expiration\n        std::thread::sleep(Duration::from_millis(150));\n\n        let stats = cache.stats();\n        assert_eq!(stats.total_entries, 2);\n        assert_eq!(stats.expired_entries, 2);\n        assert_eq!(stats.valid_entries, 0);\n    }\n\n    #[test]\n    fn test_cache_stats_display() {\n        let stats = CacheStats {\n            total_entries: 10,\n            expired_entries: 3,\n            valid_entries: 7,\n        };\n        let display = format!(\"{}\", stats);\n        assert!(display.contains(\"total: 10\"));\n        assert!(display.contains(\"expired: 3\"));\n        assert!(display.contains(\"valid: 7\"));\n    }\n\n    #[test]\n    fn test_memory_cache_is_empty() {\n        let cache = MemoryCache::with_ttl(Duration::from_secs(60));\n        assert!(cache.is_empty());\n        cache.insert(\"key\".to_string(), create_test_version_info());\n        assert!(!cache.is_empty());\n    }\n}\n","traces":[{"line":39,"address":[13497218,13497378,13497212,13497072,13497232,13497372],"length":1,"stats":{"Line":0}},{"line":40,"address":[13479544],"length":1,"stats":{"Line":0}},{"line":68,"address":[13835088,13834992],"length":1,"stats":{"Line":3}},{"line":69,"address":[13835044,13835140],"length":1,"stats":{"Line":3}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[14951248,14951474,14951746,14951520],"length":1,"stats":{"Line":5}},{"line":79,"address":[14951637,14951365,14951545,14951273],"length":1,"stats":{"Line":7}},{"line":82,"address":[14951792],"length":1,"stats":{"Line":0}},{"line":83,"address":[17476364],"length":1,"stats":{"Line":0}},{"line":86,"address":[17475760],"length":1,"stats":{"Line":0}},{"line":87,"address":[13835189],"length":1,"stats":{"Line":0}},{"line":103,"address":[12987680],"length":1,"stats":{"Line":3}},{"line":104,"address":[13829534],"length":1,"stats":{"Line":3}},{"line":116,"address":[13851728],"length":1,"stats":{"Line":0}},{"line":117,"address":[19727784],"length":1,"stats":{"Line":0}},{"line":123,"address":[19726224],"length":1,"stats":{"Line":3}},{"line":125,"address":[13832029],"length":1,"stats":{"Line":3}},{"line":132,"address":[13852400],"length":1,"stats":{"Line":3}},{"line":133,"address":[13852450],"length":1,"stats":{"Line":6}},{"line":134,"address":[13497790,13497852,13497911],"length":1,"stats":{"Line":6}},{"line":135,"address":[13468970],"length":1,"stats":{"Line":0}},{"line":137,"address":[17957422,17957462],"length":1,"stats":{"Line":6}},{"line":144,"address":[13853835,13853296,13853779],"length":1,"stats":{"Line":3}},{"line":145,"address":[13835390,13835038],"length":1,"stats":{"Line":6}},{"line":146,"address":[13853433],"length":1,"stats":{"Line":3}},{"line":147,"address":[19729627],"length":1,"stats":{"Line":3}},{"line":148,"address":[19729484],"length":1,"stats":{"Line":3}},{"line":149,"address":[13835214],"length":1,"stats":{"Line":3}},{"line":150,"address":[13853571],"length":1,"stats":{"Line":3}},{"line":155,"address":[12993824],"length":1,"stats":{"Line":0}},{"line":156,"address":[13853913],"length":1,"stats":{"Line":0}},{"line":159,"address":[13853264],"length":1,"stats":{"Line":0}},{"line":160,"address":[13834981],"length":1,"stats":{"Line":0}},{"line":168,"address":[13831376],"length":1,"stats":{"Line":2}},{"line":169,"address":[12989524],"length":1,"stats":{"Line":2}},{"line":170,"address":[12989555],"length":1,"stats":{"Line":6}},{"line":171,"address":[13849737,13849796],"length":1,"stats":{"Line":2}},{"line":172,"address":[13831498],"length":1,"stats":{"Line":2}},{"line":173,"address":[19725878],"length":1,"stats":{"Line":0}},{"line":185,"address":[13850384],"length":1,"stats":{"Line":2}},{"line":186,"address":[19726342],"length":1,"stats":{"Line":2}},{"line":187,"address":[19726373],"length":1,"stats":{"Line":6}},{"line":191,"address":[13832235],"length":1,"stats":{"Line":2}},{"line":197,"address":[19726192],"length":1,"stats":{"Line":2}},{"line":198,"address":[19726197],"length":1,"stats":{"Line":2}},{"line":203,"address":[19726496],"length":1,"stats":{"Line":2}},{"line":204,"address":[12990453],"length":1,"stats":{"Line":2}},{"line":209,"address":[19726528],"length":1,"stats":{"Line":2}},{"line":211,"address":[19726559],"length":1,"stats":{"Line":2}},{"line":229,"address":[12991280],"length":1,"stats":{"Line":2}},{"line":230,"address":[19727359],"length":1,"stats":{"Line":2}},{"line":245,"address":[19727744],"length":1,"stats":{"Line":0}},{"line":246,"address":[19727752],"length":1,"stats":{"Line":0}},{"line":255,"address":[13848718,13847984,13848750],"length":1,"stats":{"Line":0}},{"line":256,"address":[19723927],"length":1,"stats":{"Line":0}},{"line":257,"address":[13829824],"length":1,"stats":{"Line":0}},{"line":258,"address":[13829934,13829864,13830200],"length":1,"stats":{"Line":0}},{"line":259,"address":[13848680,13848445],"length":1,"stats":{"Line":0}},{"line":261,"address":[13848068],"length":1,"stats":{"Line":0}},{"line":262,"address":[13829796,13830767,13830513],"length":1,"stats":{"Line":0}},{"line":266,"address":[19724931],"length":1,"stats":{"Line":0}},{"line":270,"address":[19724619],"length":1,"stats":{"Line":0}},{"line":271,"address":[12989284,12989212,12989256,12989485],"length":1,"stats":{"Line":0}},{"line":277,"address":[13847888],"length":1,"stats":{"Line":0}},{"line":278,"address":[13467790,13465749,13465478,13465376,13465510,13466015,13465407],"length":1,"stats":{"Line":0}},{"line":279,"address":[13494381],"length":1,"stats":{"Line":0}},{"line":280,"address":[13494575,13494515,13494698,13494425],"length":1,"stats":{"Line":0}},{"line":283,"address":[17953701,17953764,17955363,17953246,17953737],"length":1,"stats":{"Line":0}},{"line":285,"address":[17953979],"length":1,"stats":{"Line":0}},{"line":286,"address":[17954006],"length":1,"stats":{"Line":0}},{"line":287,"address":[14934761],"length":1,"stats":{"Line":0}},{"line":288,"address":[14934816],"length":1,"stats":{"Line":0}},{"line":295,"address":[17954060,17954662],"length":1,"stats":{"Line":0}},{"line":296,"address":[13466990,13467094],"length":1,"stats":{"Line":0}},{"line":297,"address":[13467110],"length":1,"stats":{"Line":0}},{"line":299,"address":[14935823,14935582,14935513],"length":1,"stats":{"Line":0}},{"line":310,"address":[19727808,19728411,19728405],"length":1,"stats":{"Line":0}},{"line":312,"address":[19727864],"length":1,"stats":{"Line":0}},{"line":313,"address":[13851901],"length":1,"stats":{"Line":0}},{"line":317,"address":[19728029,19727973],"length":1,"stats":{"Line":0}},{"line":318,"address":[19728037,19728135],"length":1,"stats":{"Line":0}},{"line":321,"address":[13834057,13833890,13833921,13833818],"length":1,"stats":{"Line":0}},{"line":322,"address":[12992281],"length":1,"stats":{"Line":0}},{"line":325,"address":[13833758],"length":1,"stats":{"Line":0}},{"line":330,"address":[13852592,13853118,13853096],"length":1,"stats":{"Line":0}},{"line":331,"address":[13834789,13834445,13834334],"length":1,"stats":{"Line":0}},{"line":332,"address":[19728866],"length":1,"stats":{"Line":0}},{"line":333,"address":[19729016,19728915],"length":1,"stats":{"Line":0}},{"line":337,"address":[13834864],"length":1,"stats":{"Line":0}},{"line":338,"address":[19729201],"length":1,"stats":{"Line":0}},{"line":339,"address":[12993167],"length":1,"stats":{"Line":0}},{"line":340,"address":[19729260],"length":1,"stats":{"Line":0}},{"line":344,"address":[13852512],"length":1,"stats":{"Line":0}},{"line":345,"address":[13834237],"length":1,"stats":{"Line":0}},{"line":346,"address":[13834251],"length":1,"stats":{"Line":0}},{"line":347,"address":[13834286],"length":1,"stats":{"Line":0}}],"covered":36,"coverable":97},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","cache","sqlite.rs"],"content":"//! SQLite persistent cache for package version information with connection pooling\n\nuse std::path::PathBuf;\nuse std::sync::Arc;\n#[cfg(test)]\nuse std::sync::atomic::{AtomicU64, Ordering};\nuse std::time::{Duration, SystemTime, UNIX_EPOCH};\n\nuse r2d2::{Pool, PooledConnection};\nuse r2d2_sqlite::SqliteConnectionManager;\nuse rusqlite::params;\n\nuse crate::cache::{ReadCache, WriteCache};\nuse crate::registries::VersionInfo;\n\n/// Default TTL for cache entries (1 hour)\nconst DEFAULT_TTL_SECS: i64 = 3600;\n\n#[cfg(test)]\nstatic TEST_DB_COUNTER: AtomicU64 = AtomicU64::new(0);\n\n/// Configuration for SQLite cache pool\n#[derive(Debug, Clone)]\npub struct SqliteCacheConfig {\n    /// Maximum number of connections in the pool\n    pub max_pool_size: u32,\n    /// Minimum number of idle connections to maintain\n    pub min_idle_connections: u32,\n    /// Timeout in seconds for acquiring a connection\n    pub connection_timeout_secs: u64,\n    /// SQLite busy timeout in milliseconds\n    pub busy_timeout_ms: u32,\n    /// SQLite cache size in kilobytes\n    pub cache_size_kb: i64,\n    /// Time-to-live for cache entries in seconds\n    pub ttl_secs: i64,\n}\n\nimpl Default for SqliteCacheConfig {\n    fn default() -\u003e Self {\n        Self {\n            max_pool_size: 10,\n            min_idle_connections: 2,\n            connection_timeout_secs: 5,\n            busy_timeout_ms: 5000,\n            cache_size_kb: 64000,\n            ttl_secs: DEFAULT_TTL_SECS,\n        }\n    }\n}\n\n/// SQLite-based persistent cache with connection pooling\npub struct SqliteCache {\n    pool: Arc\u003cPool\u003cSqliteConnectionManager\u003e\u003e,\n    ttl_secs: i64,\n}\n\nimpl SqliteCache {\n    /// Create a new SQLite cache at the default location (~/.cache/dependi/cache.db)\n    pub fn new() -\u003e anyhow::Result\u003cSelf\u003e {\n        Self::with_config(SqliteCacheConfig::default())\n    }\n\n    /// Create a new SQLite cache with custom configuration\n    pub fn with_config(config: SqliteCacheConfig) -\u003e anyhow::Result\u003cSelf\u003e {\n        let cache_dir = Self::cache_dir()?;\n        std::fs::create_dir_all(\u0026cache_dir)?;\n        let db_path = cache_dir.join(\"cache.db\");\n        Self::with_path_and_config(db_path, config)\n    }\n\n    /// Create a new SQLite cache at a custom path with custom configuration\n    pub fn with_path_and_config(path: PathBuf, config: SqliteCacheConfig) -\u003e anyhow::Result\u003cSelf\u003e {\n        let busy_timeout_ms = config.busy_timeout_ms;\n        let cache_size_kb = config.cache_size_kb;\n\n        let manager = SqliteConnectionManager::file(\u0026path).with_init(move |conn| {\n            let pragmas = format!(\n                \"PRAGMA busy_timeout={};\n                 PRAGMA synchronous=NORMAL;\n                 PRAGMA cache_size=-{};\",\n                busy_timeout_ms, cache_size_kb\n            );\n            conn.execute_batch(\u0026pragmas)?;\n            Ok(())\n        });\n\n        let pool = Pool::builder()\n            .max_size(config.max_pool_size)\n            .min_idle(Some(config.min_idle_connections))\n            .connection_timeout(Duration::from_secs(config.connection_timeout_secs))\n            .idle_timeout(Some(Duration::from_secs(600)))\n            .max_lifetime(Some(Duration::from_secs(1800)))\n            .build(manager)?;\n\n        let cache = Self {\n            pool: Arc::new(pool),\n            ttl_secs: config.ttl_secs,\n        };\n\n        cache.init_schema()?;\n        cache.cleanup_expired()?;\n\n        let state = cache.pool_state();\n        tracing::debug!(\n            connections = state.connections,\n            idle = state.idle_connections,\n            \"SQLite cache pool initialized\"\n        );\n\n        Ok(cache)\n    }\n\n    /// Create an in-memory cache (for testing)\n    ///\n    /// Uses a shared in-memory database URI so all pooled connections access\n    /// the same database. Each call generates a unique database name to avoid\n    /// conflicts between tests.\n    #[cfg(test)]\n    pub fn in_memory() -\u003e anyhow::Result\u003cSelf\u003e {\n        let db_id = TEST_DB_COUNTER.fetch_add(1, Ordering::SeqCst);\n        let uri = format!(\"file:memdb{}?mode=memory\u0026cache=shared\", db_id);\n        let config = SqliteCacheConfig::default();\n\n        let manager = SqliteConnectionManager::file(\u0026uri).with_init(|conn| {\n            conn.execute_batch(\n                \"PRAGMA busy_timeout=5000;\n                 PRAGMA synchronous=NORMAL;\n                 PRAGMA cache_size=-64000;\",\n            )?;\n            Ok(())\n        });\n\n        let pool = Pool::builder().max_size(5).build(manager)?;\n\n        let cache = Self {\n            pool: Arc::new(pool),\n            ttl_secs: config.ttl_secs,\n        };\n\n        cache.init_schema_memory()?;\n        Ok(cache)\n    }\n\n    /// Initialize schema for in-memory database (no WAL mode)\n    #[cfg(test)]\n    fn init_schema_memory(\u0026self) -\u003e anyhow::Result\u003c()\u003e {\n        let conn = self.pool.get()?;\n\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS packages (\n                key TEXT PRIMARY KEY,\n                data TEXT NOT NULL,\n                inserted_at INTEGER NOT NULL,\n                ttl_secs INTEGER NOT NULL\n            )\",\n            [],\n        )?;\n        conn.execute(\n            \"CREATE INDEX IF NOT EXISTS idx_expiry ON packages(inserted_at, ttl_secs)\",\n            [],\n        )?;\n        Ok(())\n    }\n\n    /// Get the cache directory\n    fn cache_dir() -\u003e anyhow::Result\u003cPathBuf\u003e {\n        let cache_dir = dirs::cache_dir()\n            .ok_or_else(|| anyhow::anyhow!(\"Could not determine cache directory\"))?;\n        Ok(cache_dir.join(\"dependi\"))\n    }\n\n    /// Get a connection from the pool, returning None if unavailable\n    fn get_conn(\u0026self) -\u003e Option\u003cPooledConnection\u003cSqliteConnectionManager\u003e\u003e {\n        self.pool.get().ok()\n    }\n\n    /// Initialize the database schema with WAL mode\n    ///\n    /// Note: Per-connection PRAGMAs (busy_timeout, synchronous, cache_size)\n    /// are applied via with_init() on every new connection from the pool.\n    /// Only WAL mode (database-level) is set here.\n    fn init_schema(\u0026self) -\u003e anyhow::Result\u003c()\u003e {\n        let conn = self.pool.get()?;\n\n        conn.execute_batch(\"PRAGMA journal_mode=WAL;\")?;\n\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS packages (\n                key TEXT PRIMARY KEY,\n                data TEXT NOT NULL,\n                inserted_at INTEGER NOT NULL,\n                ttl_secs INTEGER NOT NULL\n            )\",\n            [],\n        )?;\n        conn.execute(\n            \"CREATE INDEX IF NOT EXISTS idx_expiry ON packages(inserted_at, ttl_secs)\",\n            [],\n        )?;\n        Ok(())\n    }\n}\n\nimpl ReadCache for SqliteCache {\n    fn get(\u0026self, key: \u0026str) -\u003e Option\u003cVersionInfo\u003e {\n        let conn = self.get_conn()?;\n        let now = current_timestamp();\n\n        let result: Result\u003c(String, i64, i64), _\u003e = conn.query_row(\n            \"SELECT data, inserted_at, ttl_secs FROM packages WHERE key = ?\",\n            [key],\n            |row| Ok((row.get(0)?, row.get(1)?, row.get(2)?)),\n        );\n\n        match result {\n            Ok((data, inserted_at, ttl_secs)) =\u003e {\n                if now \u003e inserted_at + ttl_secs {\n                    let _ = conn.execute(\"DELETE FROM packages WHERE key = ?\", [key]);\n                    None\n                } else {\n                    serde_json::from_str(\u0026data).ok()\n                }\n            }\n            Err(_) =\u003e None,\n        }\n    }\n}\n\nimpl WriteCache for SqliteCache {\n    fn insert(\u0026self, key: String, value: VersionInfo) {\n        let Some(conn) = self.get_conn() else {\n            return;\n        };\n        let now = current_timestamp();\n        let data = match serde_json::to_string(\u0026value) {\n            Ok(d) =\u003e d,\n            Err(_) =\u003e return,\n        };\n\n        let _ = conn.execute(\n            \"INSERT OR REPLACE INTO packages (key, data, inserted_at, ttl_secs) VALUES (?, ?, ?, ?)\",\n            params![key, data, now, self.ttl_secs],\n        );\n    }\n\n    fn remove(\u0026self, key: \u0026str) {\n        let Some(conn) = self.get_conn() else {\n            return;\n        };\n        let _ = conn.execute(\"DELETE FROM packages WHERE key = ?\", [key]);\n    }\n\n    fn clear(\u0026self) {\n        let Some(conn) = self.get_conn() else {\n            return;\n        };\n        let _ = conn.execute(\"DELETE FROM packages\", []);\n    }\n}\n\nimpl SqliteCache {\n    /// Insert multiple values in a single transaction\n    #[cfg(test)]\n    pub fn insert_batch(\u0026self, entries: Vec\u003c(String, VersionInfo)\u003e) -\u003e anyhow::Result\u003cusize\u003e {\n        if entries.is_empty() {\n            return Ok(0);\n        }\n\n        let mut conn = self.pool.get()?;\n        let tx = conn.transaction()?;\n        let now = current_timestamp();\n        let mut count = 0;\n\n        for (key, value) in entries {\n            let data = serde_json::to_string(\u0026value)?;\n            tx.execute(\n                \"INSERT OR REPLACE INTO packages (key, data, inserted_at, ttl_secs) VALUES (?, ?, ?, ?)\",\n                params![key, data, now, self.ttl_secs],\n            )?;\n            count += 1;\n        }\n\n        tx.commit()?;\n        Ok(count)\n    }\n\n    /// Remove a value from the cache, returning whether it existed\n    #[cfg(test)]\n    pub fn remove_with_result(\u0026self, key: \u0026str) -\u003e bool {\n        let Some(conn) = self.get_conn() else {\n            return false;\n        };\n        conn.execute(\"DELETE FROM packages WHERE key = ?\", [key])\n            .map(|rows| rows \u003e 0)\n            .unwrap_or(false)\n    }\n\n    /// Clear all entries from the cache, returning the count\n    #[cfg(test)]\n    pub fn clear_with_count(\u0026self) -\u003e anyhow::Result\u003cusize\u003e {\n        let conn = self.pool.get()?;\n        let rows = conn.execute(\"DELETE FROM packages\", [])?;\n        Ok(rows)\n    }\n\n    /// Remove expired entries from the cache\n    pub fn cleanup_expired(\u0026self) -\u003e anyhow::Result\u003cusize\u003e {\n        let conn = self.pool.get()?;\n        let now = current_timestamp();\n        let rows = conn.execute(\n            \"DELETE FROM packages WHERE inserted_at + ttl_secs \u003c ?\",\n            [now],\n        )?;\n        Ok(rows)\n    }\n\n    /// Get pool statistics for monitoring\n    pub fn pool_state(\u0026self) -\u003e PoolState {\n        let state = self.pool.state();\n        PoolState {\n            connections: state.connections,\n            idle_connections: state.idle_connections,\n        }\n    }\n}\n\n/// Pool statistics for monitoring\n#[derive(Debug, Clone, Copy)]\npub struct PoolState {\n    /// Total number of connections in the pool\n    pub connections: u32,\n    /// Number of idle connections available\n    pub idle_connections: u32,\n}\n\n/// Get current Unix timestamp\nfn current_timestamp() -\u003e i64 {\n    SystemTime::now()\n        .duration_since(UNIX_EPOCH)\n        .unwrap_or_default()\n        .as_secs() as i64\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    fn create_test_version_info() -\u003e VersionInfo {\n        VersionInfo {\n            latest: Some(\"1.0.0\".to_string()),\n            latest_prerelease: None,\n            versions: vec![\"1.0.0\".to_string(), \"0.9.0\".to_string()],\n            description: Some(\"Test package\".to_string()),\n            homepage: None,\n            repository: None,\n            license: Some(\"MIT\".to_string()),\n            vulnerabilities: vec![],\n            deprecated: false,\n            yanked: false,\n            yanked_versions: vec![],\n            release_dates: Default::default(),\n        }\n    }\n\n    #[test]\n    fn test_insert_and_get() {\n        let cache = SqliteCache::in_memory().unwrap();\n        let info = create_test_version_info();\n\n        cache.insert(\"test:package\".to_string(), info.clone());\n        let retrieved = cache.get(\"test:package\");\n\n        assert!(retrieved.is_some());\n        let retrieved = retrieved.unwrap();\n        assert_eq!(retrieved.latest, info.latest);\n        assert_eq!(retrieved.versions, info.versions);\n    }\n\n    #[test]\n    fn test_get_nonexistent() {\n        let cache = SqliteCache::in_memory().unwrap();\n        let retrieved = cache.get(\"nonexistent\");\n        assert!(retrieved.is_none());\n    }\n\n    #[test]\n    fn test_overwrite() {\n        let cache = SqliteCache::in_memory().unwrap();\n\n        let info1 = VersionInfo {\n            latest: Some(\"1.0.0\".to_string()),\n            ..create_test_version_info()\n        };\n        let info2 = VersionInfo {\n            latest: Some(\"2.0.0\".to_string()),\n            ..create_test_version_info()\n        };\n\n        cache.insert(\"test:package\".to_string(), info1);\n        cache.insert(\"test:package\".to_string(), info2);\n\n        let retrieved = cache.get(\"test:package\").unwrap();\n        assert_eq!(retrieved.latest, Some(\"2.0.0\".to_string()));\n    }\n\n    #[test]\n    fn test_pool_state() {\n        let cache = SqliteCache::in_memory().unwrap();\n        let state = cache.pool_state();\n        assert!(state.connections \u003e 0);\n    }\n\n    #[test]\n    fn test_remove() {\n        let cache = SqliteCache::in_memory().unwrap();\n        let info = create_test_version_info();\n\n        cache.insert(\"test:package\".to_string(), info);\n        assert!(cache.get(\"test:package\").is_some());\n\n        let removed = cache.remove_with_result(\"test:package\");\n        assert!(removed);\n        assert!(cache.get(\"test:package\").is_none());\n\n        let removed_again = cache.remove_with_result(\"test:package\");\n        assert!(!removed_again);\n    }\n\n    #[test]\n    fn test_clear() {\n        let cache = SqliteCache::in_memory().unwrap();\n        let info = create_test_version_info();\n\n        cache.insert(\"pkg1\".to_string(), info.clone());\n        cache.insert(\"pkg2\".to_string(), info.clone());\n        cache.insert(\"pkg3\".to_string(), info);\n\n        let cleared = cache.clear_with_count().unwrap();\n        assert_eq!(cleared, 3);\n\n        assert!(cache.get(\"pkg1\").is_none());\n        assert!(cache.get(\"pkg2\").is_none());\n        assert!(cache.get(\"pkg3\").is_none());\n    }\n\n    #[test]\n    fn test_insert_batch() {\n        let cache = SqliteCache::in_memory().unwrap();\n\n        let entries: Vec\u003c(String, VersionInfo)\u003e = (0..10)\n            .map(|i| {\n                let mut info = create_test_version_info();\n                info.latest = Some(format!(\"{}.0.0\", i));\n                (format!(\"pkg{}\", i), info)\n            })\n            .collect();\n\n        let count = cache.insert_batch(entries).unwrap();\n        assert_eq!(count, 10);\n\n        for i in 0..10 {\n            let retrieved = cache.get(\u0026format!(\"pkg{}\", i)).unwrap();\n            assert_eq!(retrieved.latest, Some(format!(\"{}.0.0\", i)));\n        }\n    }\n\n    #[test]\n    fn test_insert_batch_empty() {\n        let cache = SqliteCache::in_memory().unwrap();\n        let count = cache.insert_batch(vec![]).unwrap();\n        assert_eq!(count, 0);\n    }\n\n    #[test]\n    fn test_concurrent_reads() {\n        use std::sync::Arc;\n        use std::thread;\n\n        let cache = Arc::new(SqliteCache::in_memory().unwrap());\n\n        for i in 0..20 {\n            let mut info = create_test_version_info();\n            info.latest = Some(format!(\"{}.0.0\", i));\n            cache.insert(format!(\"pkg{}\", i), info);\n        }\n\n        let handles: Vec\u003c_\u003e = (0..10)\n            .map(|thread_id| {\n                let cache = Arc::clone(\u0026cache);\n                thread::spawn(move || {\n                    for i in 0..20 {\n                        let key = format!(\"pkg{}\", i);\n                        let result = cache.get(\u0026key);\n                        assert!(\n                            result.is_some(),\n                            \"Thread {} failed to read {}\",\n                            thread_id,\n                            key\n                        );\n                    }\n                })\n            })\n            .collect();\n\n        for handle in handles {\n            handle.join().expect(\"Thread panicked\");\n        }\n    }\n\n    #[test]\n    fn test_concurrent_writes() {\n        use std::sync::Arc;\n        use std::thread;\n\n        let cache = Arc::new(SqliteCache::in_memory().unwrap());\n\n        let handles: Vec\u003c_\u003e = (0..5)\n            .map(|thread_id| {\n                let cache = Arc::clone(\u0026cache);\n                thread::spawn(move || {\n                    for i in 0..10 {\n                        let key = format!(\"thread{}:pkg{}\", thread_id, i);\n                        let mut info = create_test_version_info();\n                        info.latest = Some(format!(\"{}.{}.0\", thread_id, i));\n                        cache.insert(key, info);\n                    }\n                })\n            })\n            .collect();\n\n        for handle in handles {\n            handle.join().expect(\"Thread panicked\");\n        }\n\n        for thread_id in 0..5 {\n            for i in 0..10 {\n                let key = format!(\"thread{}:pkg{}\", thread_id, i);\n                let result = cache.get(\u0026key);\n                assert!(result.is_some(), \"Missing key: {}\", key);\n            }\n        }\n    }\n\n    #[test]\n    fn test_concurrent_mixed_operations() {\n        use std::sync::Arc;\n        use std::thread;\n\n        let cache = Arc::new(SqliteCache::in_memory().unwrap());\n\n        for i in 0..50 {\n            let mut info = create_test_version_info();\n            info.latest = Some(format!(\"{}.0.0\", i));\n            cache.insert(format!(\"pkg{}\", i), info);\n        }\n\n        let handles: Vec\u003c_\u003e = (0..10)\n            .map(|thread_id| {\n                let cache = Arc::clone(\u0026cache);\n                thread::spawn(move || {\n                    for i in 0..50 {\n                        match thread_id % 3 {\n                            0 =\u003e {\n                                let _ = cache.get(\u0026format!(\"pkg{}\", i));\n                            }\n                            1 =\u003e {\n                                let mut info = create_test_version_info();\n                                info.latest = Some(format!(\"updated-{}-{}\", thread_id, i));\n                                cache.insert(format!(\"pkg{}\", i), info);\n                            }\n                            _ =\u003e {\n                                let mut info = create_test_version_info();\n                                info.latest = Some(format!(\"new-{}-{}\", thread_id, i));\n                                cache.insert(format!(\"new-pkg-{}-{}\", thread_id, i), info);\n                            }\n                        }\n                    }\n                })\n            })\n            .collect();\n\n        for handle in handles {\n            handle.join().expect(\"Thread panicked\");\n        }\n    }\n\n    #[test]\n    fn test_config_default() {\n        let config = SqliteCacheConfig::default();\n        assert_eq!(config.max_pool_size, 10);\n        assert_eq!(config.min_idle_connections, 2);\n        assert_eq!(config.busy_timeout_ms, 5000);\n        assert_eq!(config.cache_size_kb, 64000);\n        assert_eq!(config.ttl_secs, DEFAULT_TTL_SECS);\n    }\n}\n","traces":[{"line":40,"address":[13626640],"length":1,"stats":{"Line":2}},{"line":60,"address":[13596592],"length":1,"stats":{"Line":0}},{"line":61,"address":[19267885],"length":1,"stats":{"Line":0}},{"line":65,"address":[13622048,13622514],"length":1,"stats":{"Line":0}},{"line":66,"address":[13622070],"length":1,"stats":{"Line":0}},{"line":67,"address":[13622218,13622285],"length":1,"stats":{"Line":0}},{"line":68,"address":[13622389],"length":1,"stats":{"Line":0}},{"line":69,"address":[13622458],"length":1,"stats":{"Line":0}},{"line":73,"address":[13625374,13625492,13623232],"length":1,"stats":{"Line":0}},{"line":74,"address":[19265735],"length":1,"stats":{"Line":0}},{"line":75,"address":[19265792],"length":1,"stats":{"Line":0}},{"line":77,"address":[13594420,13594498],"length":1,"stats":{"Line":0}},{"line":78,"address":[14521118],"length":1,"stats":{"Line":0}},{"line":84,"address":[13450130,13450203],"length":1,"stats":{"Line":0}},{"line":85,"address":[12659874],"length":1,"stats":{"Line":0}},{"line":88,"address":[19267779,19266532,19266400,19266616,19266140,19266270,19265925],"length":1,"stats":{"Line":0}},{"line":89,"address":[13623529],"length":1,"stats":{"Line":0}},{"line":90,"address":[19266012],"length":1,"stats":{"Line":0}},{"line":91,"address":[19266059,19266164,19267825],"length":1,"stats":{"Line":0}},{"line":92,"address":[19267807,19266294,19266192],"length":1,"stats":{"Line":0}},{"line":93,"address":[19266424,19266322,19267789],"length":1,"stats":{"Line":0}},{"line":94,"address":[19266439,19266584],"length":1,"stats":{"Line":0}},{"line":97,"address":[12836257],"length":1,"stats":{"Line":0}},{"line":98,"address":[12836339],"length":1,"stats":{"Line":0}},{"line":101,"address":[12836421,12837305,12836367],"length":1,"stats":{"Line":0}},{"line":102,"address":[12836526,12837288],"length":1,"stats":{"Line":0}},{"line":104,"address":[19267091],"length":1,"stats":{"Line":0}},{"line":105,"address":[13595815,13596133],"length":1,"stats":{"Line":0}},{"line":111,"address":[12836980],"length":1,"stats":{"Line":0}},{"line":120,"address":[19269342,19269390,19268384],"length":1,"stats":{"Line":22}},{"line":121,"address":[19268401],"length":1,"stats":{"Line":22}},{"line":122,"address":[12838033],"length":1,"stats":{"Line":14}},{"line":123,"address":[19268574],"length":1,"stats":{"Line":22}},{"line":125,"address":[19268635],"length":1,"stats":{"Line":26}},{"line":126,"address":[14521891,14521790],"length":1,"stats":{"Line":8}},{"line":131,"address":[12660191],"length":1,"stats":{"Line":17}},{"line":134,"address":[12838265,12838331,12838950],"length":1,"stats":{"Line":44}},{"line":137,"address":[19268979],"length":1,"stats":{"Line":3}},{"line":138,"address":[19269053],"length":1,"stats":{"Line":9}},{"line":141,"address":[12838723,12838669],"length":1,"stats":{"Line":9}},{"line":142,"address":[19269235],"length":1,"stats":{"Line":12}},{"line":147,"address":[19265331,19265325,19264544],"length":1,"stats":{"Line":11}},{"line":148,"address":[12834143],"length":1,"stats":{"Line":5}},{"line":150,"address":[19264840,19265318,19264995,19264786],"length":1,"stats":{"Line":17}},{"line":159,"address":[19265218,19265296,19265046],"length":1,"stats":{"Line":11}},{"line":163,"address":[19265260],"length":1,"stats":{"Line":6}},{"line":167,"address":[13597101,13597107,13596752],"length":1,"stats":{"Line":0}},{"line":168,"address":[13625724,13625697,13625792],"length":1,"stats":{"Line":0}},{"line":169,"address":[12659952,12659956],"length":1,"stats":{"Line":0}},{"line":170,"address":[13625933,13625867],"length":1,"stats":{"Line":0}},{"line":174,"address":[13625584],"length":1,"stats":{"Line":3}},{"line":175,"address":[13596694],"length":1,"stats":{"Line":4}},{"line":183,"address":[13593094,13592048,13593100],"length":1,"stats":{"Line":0}},{"line":184,"address":[13592063],"length":1,"stats":{"Line":0}},{"line":186,"address":[19259490,19259544,19260245],"length":1,"stats":{"Line":0}},{"line":188,"address":[13593075,13592549,13592734],"length":1,"stats":{"Line":0}},{"line":197,"address":[13592969,13593052,13592784],"length":1,"stats":{"Line":0}},{"line":201,"address":[13593015],"length":1,"stats":{"Line":0}},{"line":206,"address":[19270936,19270048,19270998],"length":1,"stats":{"Line":2}},{"line":207,"address":[13626739],"length":1,"stats":{"Line":2}},{"line":208,"address":[12839883,12839829],"length":1,"stats":{"Line":4}},{"line":210,"address":[13598025,13598077],"length":1,"stats":{"Line":7}},{"line":212,"address":[12839923],"length":1,"stats":{"Line":3}},{"line":213,"address":[13479838,13479808],"length":1,"stats":{"Line":11}},{"line":216,"address":[13627044],"length":1,"stats":{"Line":4}},{"line":217,"address":[19270450],"length":1,"stats":{"Line":6}},{"line":218,"address":[12840114,12840416],"length":1,"stats":{"Line":6}},{"line":219,"address":[13598486,13598375],"length":1,"stats":{"Line":0}},{"line":220,"address":[19270819],"length":1,"stats":{"Line":0}},{"line":222,"address":[19270632,19270683],"length":1,"stats":{"Line":19}},{"line":225,"address":[13598158],"length":1,"stats":{"Line":2}},{"line":231,"address":[19271264,19272067,19272116],"length":1,"stats":{"Line":6}},{"line":232,"address":[13599084,13599132],"length":1,"stats":{"Line":11}},{"line":235,"address":[12841067,12840993],"length":1,"stats":{"Line":17}},{"line":236,"address":[13628207],"length":1,"stats":{"Line":7}},{"line":237,"address":[13628309],"length":1,"stats":{"Line":11}},{"line":241,"address":[12841495,12841326],"length":1,"stats":{"Line":23}},{"line":243,"address":[13628541],"length":1,"stats":{"Line":10}},{"line":247,"address":[19272425,19272419,19272144],"length":1,"stats":{"Line":0}},{"line":248,"address":[12841775],"length":1,"stats":{"Line":0}},{"line":251,"address":[13629021,13629101],"length":1,"stats":{"Line":0}},{"line":254,"address":[13599010,13598784,13599016],"length":1,"stats":{"Line":0}},{"line":255,"address":[13598802],"length":1,"stats":{"Line":0}},{"line":258,"address":[13598880,13598947],"length":1,"stats":{"Line":0}},{"line":265,"address":[12832606,12830336,12832836],"length":1,"stats":{"Line":4}},{"line":266,"address":[19260802,19260888],"length":1,"stats":{"Line":8}},{"line":267,"address":[12830501],"length":1,"stats":{"Line":2}},{"line":270,"address":[12830546,12830486,12832800],"length":1,"stats":{"Line":4}},{"line":271,"address":[19263167,19261246,19261175],"length":1,"stats":{"Line":4}},{"line":272,"address":[19261465,19261531],"length":1,"stats":{"Line":4}},{"line":273,"address":[19261539],"length":1,"stats":{"Line":2}},{"line":275,"address":[19261551,19261732],"length":1,"stats":{"Line":4}},{"line":276,"address":[12831433,12832622,12831816],"length":1,"stats":{"Line":4}},{"line":277,"address":[12832170,12831995,12832556,12832339],"length":1,"stats":{"Line":4}},{"line":279,"address":[12832064],"length":1,"stats":{"Line":2}},{"line":281,"address":[19262806,19262861],"length":1,"stats":{"Line":2}},{"line":284,"address":[12831458,12831741],"length":1,"stats":{"Line":2}},{"line":285,"address":[19262072],"length":1,"stats":{"Line":2}},{"line":290,"address":[19265344,19265674,19265680],"length":1,"stats":{"Line":2}},{"line":291,"address":[19265391],"length":1,"stats":{"Line":2}},{"line":292,"address":[12835067],"length":1,"stats":{"Line":0}},{"line":294,"address":[19265644,19265545,19265471],"length":1,"stats":{"Line":6}},{"line":295,"address":[19265612],"length":1,"stats":{"Line":6}},{"line":301,"address":[19264512,19264518,19263936],"length":1,"stats":{"Line":2}},{"line":302,"address":[19263951],"length":1,"stats":{"Line":2}},{"line":303,"address":[19264490,19264183,19264237],"length":1,"stats":{"Line":4}},{"line":304,"address":[19264439],"length":1,"stats":{"Line":2}},{"line":308,"address":[13594279,13593616,13594273],"length":1,"stats":{"Line":0}},{"line":309,"address":[19263295],"length":1,"stats":{"Line":0}},{"line":310,"address":[19263517,19263571],"length":1,"stats":{"Line":0}},{"line":311,"address":[13594250,13593923,13594145,13593962],"length":1,"stats":{"Line":0}},{"line":313,"address":[13593954],"length":1,"stats":{"Line":0}},{"line":315,"address":[13594197],"length":1,"stats":{"Line":0}},{"line":319,"address":[13592000],"length":1,"stats":{"Line":2}},{"line":320,"address":[12828793],"length":1,"stats":{"Line":2}},{"line":338,"address":[19269408],"length":1,"stats":{"Line":10}},{"line":339,"address":[13597124],"length":1,"stats":{"Line":5}},{"line":340,"address":[13626067],"length":1,"stats":{"Line":10}},{"line":341,"address":[13597161],"length":1,"stats":{"Line":12}},{"line":342,"address":[13597180],"length":1,"stats":{"Line":7}}],"covered":67,"coverable":120},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","config.rs"],"content":"//! Configuration management for Dependi LSP\n\nuse serde::Deserialize;\n\n/// Default cache TTL (1 hour)\nconst DEFAULT_CACHE_TTL_SECS: u64 = 3600;\n\n/// Default vulnerability cache TTL (6 hours)\nconst DEFAULT_VULN_CACHE_TTL_SECS: u64 = 6 * 3600;\n\n/// LSP configuration\n#[derive(Debug, Clone, Deserialize, Default)]\n#[serde(default)]\npub struct Config {\n    /// Inlay hints configuration\n    pub inlay_hints: InlayHintsConfig,\n    /// Diagnostics configuration\n    pub diagnostics: DiagnosticsConfig,\n    /// Cache configuration\n    pub cache: CacheConfig,\n    /// Security/vulnerability configuration\n    pub security: SecurityConfig,\n    /// Packages to ignore (glob patterns)\n    #[serde(default)]\n    pub ignore: Vec\u003cString\u003e,\n}\n\n/// Inlay hints configuration\n#[derive(Debug, Clone, Deserialize)]\n#[serde(default)]\npub struct InlayHintsConfig {\n    /// Enable inlay hints\n    pub enabled: bool,\n    /// Show hints for up-to-date packages\n    pub show_up_to_date: bool,\n}\n\nimpl Default for InlayHintsConfig {\n    fn default() -\u003e Self {\n        Self {\n            enabled: true,\n            show_up_to_date: true,\n        }\n    }\n}\n\n/// Diagnostics configuration\n#[derive(Debug, Clone, Deserialize)]\n#[serde(default)]\npub struct DiagnosticsConfig {\n    /// Enable diagnostics\n    pub enabled: bool,\n}\n\nimpl Default for DiagnosticsConfig {\n    fn default() -\u003e Self {\n        Self { enabled: true }\n    }\n}\n\n/// Cache configuration\n#[derive(Debug, Clone, Deserialize)]\n#[serde(default)]\npub struct CacheConfig {\n    /// Cache TTL in seconds\n    pub ttl_secs: u64,\n}\n\nimpl Default for CacheConfig {\n    fn default() -\u003e Self {\n        Self {\n            ttl_secs: DEFAULT_CACHE_TTL_SECS,\n        }\n    }\n}\n\n/// Security/vulnerability scanning configuration\n#[derive(Debug, Clone, Deserialize)]\n#[serde(default)]\npub struct SecurityConfig {\n    /// Enable vulnerability scanning\n    pub enabled: bool,\n    /// Show vulnerabilities in inlay hints\n    pub show_in_hints: bool,\n    /// Show vulnerabilities as diagnostics\n    pub show_diagnostics: bool,\n    /// Minimum severity level to display (\"low\", \"medium\", \"high\", \"critical\")\n    pub min_severity: String,\n    /// Vulnerability cache TTL in seconds (default: 6 hours)\n    pub cache_ttl_secs: u64,\n}\n\nimpl Default for SecurityConfig {\n    fn default() -\u003e Self {\n        Self {\n            enabled: true,\n            show_in_hints: true,\n            show_diagnostics: true,\n            min_severity: \"low\".to_string(),\n            cache_ttl_secs: DEFAULT_VULN_CACHE_TTL_SECS,\n        }\n    }\n}\n\nimpl SecurityConfig {\n    /// Parse minimum severity level to VulnerabilitySeverity\n    pub fn min_severity_level(\u0026self) -\u003e crate::registries::VulnerabilitySeverity {\n        crate::registries::VulnerabilitySeverity::from_str_loose(\u0026self.min_severity)\n    }\n}\n\nimpl Config {\n    /// Parse configuration from initialization options\n    pub fn from_init_options(options: Option\u003cserde_json::Value\u003e) -\u003e Self {\n        match options {\n            Some(value) =\u003e serde_json::from_value(value).unwrap_or_default(),\n            None =\u003e Self::default(),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use serde_json::json;\n\n    #[test]\n    fn test_default_config() {\n        let config = Config::default();\n        assert!(config.inlay_hints.enabled);\n        assert!(config.inlay_hints.show_up_to_date);\n        assert!(config.diagnostics.enabled);\n        assert_eq!(config.cache.ttl_secs, DEFAULT_CACHE_TTL_SECS);\n        assert!(config.ignore.is_empty());\n    }\n\n    #[test]\n    fn test_parse_from_json() {\n        let json = json!({\n            \"inlay_hints\": {\n                \"enabled\": false,\n                \"show_up_to_date\": false\n            },\n            \"diagnostics\": {\n                \"enabled\": false\n            },\n            \"cache\": {\n                \"ttl_secs\": 7200\n            },\n            \"ignore\": [\"test-*\", \"internal-pkg\"]\n        });\n\n        let config = Config::from_init_options(Some(json));\n        assert!(!config.inlay_hints.enabled);\n        assert!(!config.inlay_hints.show_up_to_date);\n        assert!(!config.diagnostics.enabled);\n        assert_eq!(config.cache.ttl_secs, 7200);\n        assert_eq!(config.ignore.len(), 2);\n    }\n\n    #[test]\n    fn test_partial_config() {\n        let json = json!({\n            \"inlay_hints\": {\n                \"enabled\": false\n            }\n        });\n\n        let config = Config::from_init_options(Some(json));\n        assert!(!config.inlay_hints.enabled);\n        // Other fields should use defaults\n        assert!(config.inlay_hints.show_up_to_date);\n        assert!(config.diagnostics.enabled);\n    }\n\n    #[test]\n    fn test_security_config_defaults() {\n        let config = SecurityConfig::default();\n        assert!(config.enabled);\n        assert!(config.show_in_hints);\n        assert!(config.show_diagnostics);\n        assert_eq!(config.min_severity, \"low\");\n        assert_eq!(config.cache_ttl_secs, DEFAULT_VULN_CACHE_TTL_SECS);\n    }\n\n    #[test]\n    fn test_security_config_from_json() {\n        let json = json!({\n            \"security\": {\n                \"enabled\": false,\n                \"show_in_hints\": false,\n                \"show_diagnostics\": false,\n                \"min_severity\": \"high\",\n                \"cache_ttl_secs\": 3600\n            }\n        });\n\n        let config = Config::from_init_options(Some(json));\n        assert!(!config.security.enabled);\n        assert!(!config.security.show_in_hints);\n        assert!(!config.security.show_diagnostics);\n        assert_eq!(config.security.min_severity, \"high\");\n        assert_eq!(config.security.cache_ttl_secs, 3600);\n    }\n\n    #[test]\n    fn test_min_severity_level_parsing() {\n        use crate::registries::VulnerabilitySeverity;\n\n        let config = SecurityConfig {\n            min_severity: \"low\".to_string(),\n            ..Default::default()\n        };\n        assert_eq!(config.min_severity_level(), VulnerabilitySeverity::Low);\n\n        let config = SecurityConfig {\n            min_severity: \"medium\".to_string(),\n            ..Default::default()\n        };\n        assert_eq!(config.min_severity_level(), VulnerabilitySeverity::Medium);\n\n        let config = SecurityConfig {\n            min_severity: \"high\".to_string(),\n            ..Default::default()\n        };\n        assert_eq!(config.min_severity_level(), VulnerabilitySeverity::High);\n\n        let config = SecurityConfig {\n            min_severity: \"critical\".to_string(),\n            ..Default::default()\n        };\n        assert_eq!(config.min_severity_level(), VulnerabilitySeverity::Critical);\n    }\n\n    #[test]\n    fn test_from_init_options_none() {\n        let config = Config::from_init_options(None);\n        assert!(config.inlay_hints.enabled);\n        assert!(config.diagnostics.enabled);\n    }\n\n    #[test]\n    fn test_from_init_options_invalid_json() {\n        let json = json!(\"invalid\");\n        let config = Config::from_init_options(Some(json));\n        assert!(config.inlay_hints.enabled);\n    }\n\n    #[test]\n    fn test_cache_config_defaults() {\n        let config = CacheConfig::default();\n        assert_eq!(config.ttl_secs, DEFAULT_CACHE_TTL_SECS);\n    }\n\n    #[test]\n    fn test_diagnostics_config_defaults() {\n        let config = DiagnosticsConfig::default();\n        assert!(config.enabled);\n    }\n\n    #[test]\n    fn test_inlay_hints_config_defaults() {\n        let config = InlayHintsConfig::default();\n        assert!(config.enabled);\n        assert!(config.show_up_to_date);\n    }\n}\n","traces":[{"line":39,"address":[13362960],"length":1,"stats":{"Line":2}},{"line":55,"address":[29957150],"length":1,"stats":{"Line":7}},{"line":69,"address":[29957152],"length":1,"stats":{"Line":2}},{"line":93,"address":[25956385],"length":1,"stats":{"Line":0}},{"line":94,"address":[13714720],"length":1,"stats":{"Line":2}},{"line":99,"address":[13714733],"length":1,"stats":{"Line":2}},{"line":105,"address":[29956480,29956485],"length":1,"stats":{"Line":0}},{"line":107,"address":[13683120],"length":1,"stats":{"Line":2}},{"line":108,"address":[14614565],"length":1,"stats":{"Line":2}},{"line":114,"address":[13683152],"length":1,"stats":{"Line":3}},{"line":115,"address":[13683173],"length":1,"stats":{"Line":3}},{"line":116,"address":[13683199],"length":1,"stats":{"Line":2}},{"line":117,"address":[13683273],"length":1,"stats":{"Line":2}}],"covered":11,"coverable":13},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","document.rs"],"content":"//! Document state and parsing logic\n//!\n//! This module handles document state management and dependency parsing\n//! for different file types.\n\nuse crate::file_types::FileType;\nuse crate::parsers::Dependency;\n\n/// State of a parsed dependency document.\n///\n/// Stores the parsed dependencies and detected file type for a document\n/// that has been opened in the editor.\npub struct DocumentState {\n    /// List of dependencies extracted from the document.\n    pub dependencies: Vec\u003cDependency\u003e,\n    /// The detected file type (determines which parser/registry to use).\n    pub file_type: FileType,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","file_types.rs"],"content":"//! File type detection and ecosystem mapping\n//!\n//! This module handles detection of dependency file types from URIs\n//! and provides mappings to ecosystems and cache keys.\n\nuse tower_lsp::lsp_types::Url;\n\nuse crate::vulnerabilities::Ecosystem;\n\n/// Supported dependency file types.\n///\n/// Each variant corresponds to a specific package manager ecosystem\n/// and determines which parser and registry client to use.\n#[derive(Debug, Clone, Copy, PartialEq)]\npub enum FileType {\n    /// Rust packages (Cargo.toml)\n    Cargo,\n    /// JavaScript/Node.js packages (package.json)\n    Npm,\n    /// Python packages (requirements.txt, pyproject.toml)\n    Python,\n    /// Go modules (go.mod)\n    Go,\n    /// PHP packages (composer.json)\n    Php,\n    /// Dart/Flutter packages (pubspec.yaml)\n    Dart,\n    /// C#/.NET packages (*.csproj)\n    Csharp,\n    /// Ruby gems (Gemfile)\n    Ruby,\n}\n\nimpl FileType {\n    /// Detect the file type from a document URI.\n    ///\n    /// Returns `Some(FileType)` if the URI matches a known dependency file pattern,\n    /// or `None` if the file type is not recognized.\n    pub fn detect(uri: \u0026Url) -\u003e Option\u003cSelf\u003e {\n        let path = uri.path();\n        if path.ends_with(\"Cargo.toml\") {\n            Some(FileType::Cargo)\n        } else if path.ends_with(\"package.json\") {\n            Some(FileType::Npm)\n        } else if path.ends_with(\"requirements.txt\")\n            || path.ends_with(\"requirements-dev.txt\")\n            || path.ends_with(\"requirements-test.txt\")\n            || path.ends_with(\"pyproject.toml\")\n        {\n            Some(FileType::Python)\n        } else if path.ends_with(\"go.mod\") {\n            Some(FileType::Go)\n        } else if path.ends_with(\"composer.json\") {\n            Some(FileType::Php)\n        } else if path.ends_with(\"pubspec.yaml\") {\n            Some(FileType::Dart)\n        } else if path.ends_with(\".csproj\") {\n            Some(FileType::Csharp)\n        } else if path.ends_with(\"Gemfile\") {\n            Some(FileType::Ruby)\n        } else {\n            None\n        }\n    }\n\n    /// Convert to the corresponding vulnerability ecosystem identifier.\n    ///\n    /// Used for querying the OSV.dev API with the correct ecosystem.\n    pub fn to_ecosystem(self) -\u003e Ecosystem {\n        match self {\n            FileType::Cargo =\u003e Ecosystem::CratesIo,\n            FileType::Npm =\u003e Ecosystem::Npm,\n            FileType::Python =\u003e Ecosystem::PyPI,\n            FileType::Go =\u003e Ecosystem::Go,\n            FileType::Php =\u003e Ecosystem::Packagist,\n            FileType::Dart =\u003e Ecosystem::Pub,\n            FileType::Csharp =\u003e Ecosystem::NuGet,\n            FileType::Ruby =\u003e Ecosystem::RubyGems,\n        }\n    }\n\n    /// Generate a cache key for a package.\n    ///\n    /// The cache key includes the registry prefix (e.g., \"crates:\", \"npm:\")\n    /// to avoid collisions between packages with the same name in different ecosystems.\n    pub fn cache_key(self, package_name: \u0026str) -\u003e String {\n        match self {\n            FileType::Cargo =\u003e format!(\"crates:{}\", package_name),\n            FileType::Npm =\u003e format!(\"npm:{}\", package_name),\n            FileType::Python =\u003e format!(\"pypi:{}\", package_name),\n            FileType::Go =\u003e format!(\"go:{}\", package_name),\n            FileType::Php =\u003e format!(\"packagist:{}\", package_name),\n            FileType::Dart =\u003e format!(\"pub:{}\", package_name),\n            FileType::Csharp =\u003e format!(\"nuget:{}\", package_name),\n            FileType::Ruby =\u003e format!(\"rubygems:{}\", package_name),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_detect_cargo() {\n        let uri = Url::parse(\"file:///project/Cargo.toml\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Cargo));\n    }\n\n    #[test]\n    fn test_detect_npm() {\n        let uri = Url::parse(\"file:///project/package.json\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Npm));\n    }\n\n    #[test]\n    fn test_detect_python_requirements() {\n        let uri = Url::parse(\"file:///project/requirements.txt\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Python));\n\n        let uri = Url::parse(\"file:///project/requirements-dev.txt\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Python));\n    }\n\n    #[test]\n    fn test_detect_pyproject() {\n        let uri = Url::parse(\"file:///project/pyproject.toml\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Python));\n    }\n\n    #[test]\n    fn test_detect_go() {\n        let uri = Url::parse(\"file:///project/go.mod\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Go));\n    }\n\n    #[test]\n    fn test_detect_php() {\n        let uri = Url::parse(\"file:///project/composer.json\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Php));\n    }\n\n    #[test]\n    fn test_detect_dart() {\n        let uri = Url::parse(\"file:///project/pubspec.yaml\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Dart));\n    }\n\n    #[test]\n    fn test_detect_csharp() {\n        let uri = Url::parse(\"file:///project/MyProject.csproj\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Csharp));\n    }\n\n    #[test]\n    fn test_detect_ruby() {\n        let uri = Url::parse(\"file:///project/Gemfile\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), Some(FileType::Ruby));\n    }\n\n    #[test]\n    fn test_detect_unknown() {\n        let uri = Url::parse(\"file:///project/unknown.txt\").unwrap();\n        assert_eq!(FileType::detect(\u0026uri), None);\n    }\n\n    #[test]\n    fn test_to_ecosystem() {\n        assert_eq!(FileType::Cargo.to_ecosystem(), Ecosystem::CratesIo);\n        assert_eq!(FileType::Npm.to_ecosystem(), Ecosystem::Npm);\n        assert_eq!(FileType::Python.to_ecosystem(), Ecosystem::PyPI);\n        assert_eq!(FileType::Go.to_ecosystem(), Ecosystem::Go);\n        assert_eq!(FileType::Php.to_ecosystem(), Ecosystem::Packagist);\n        assert_eq!(FileType::Dart.to_ecosystem(), Ecosystem::Pub);\n        assert_eq!(FileType::Csharp.to_ecosystem(), Ecosystem::NuGet);\n        assert_eq!(FileType::Ruby.to_ecosystem(), Ecosystem::RubyGems);\n    }\n\n    #[test]\n    fn test_cache_key() {\n        assert_eq!(FileType::Cargo.cache_key(\"serde\"), \"crates:serde\");\n        assert_eq!(FileType::Npm.cache_key(\"lodash\"), \"npm:lodash\");\n        assert_eq!(FileType::Python.cache_key(\"requests\"), \"pypi:requests\");\n        assert_eq!(\n            FileType::Go.cache_key(\"github.com/gin-gonic/gin\"),\n            \"go:github.com/gin-gonic/gin\"\n        );\n    }\n}\n","traces":[{"line":39,"address":[17113376],"length":1,"stats":{"Line":2}},{"line":40,"address":[14315913],"length":1,"stats":{"Line":4}},{"line":41,"address":[14315945,14316006],"length":1,"stats":{"Line":6}},{"line":42,"address":[17113473],"length":1,"stats":{"Line":2}},{"line":43,"address":[14315977,14316050],"length":1,"stats":{"Line":4}},{"line":44,"address":[14334333],"length":1,"stats":{"Line":2}},{"line":45,"address":[12949397,12949470],"length":1,"stats":{"Line":7}},{"line":46,"address":[12949441],"length":1,"stats":{"Line":3}},{"line":47,"address":[14334397],"length":1,"stats":{"Line":3}},{"line":48,"address":[14334429],"length":1,"stats":{"Line":3}},{"line":50,"address":[14334377],"length":1,"stats":{"Line":2}},{"line":51,"address":[17113645,17113706],"length":1,"stats":{"Line":5}},{"line":52,"address":[14334517],"length":1,"stats":{"Line":2}},{"line":53,"address":[14334493,14334566],"length":1,"stats":{"Line":5}},{"line":54,"address":[14316273],"length":1,"stats":{"Line":2}},{"line":55,"address":[17113721,17113791],"length":1,"stats":{"Line":5}},{"line":56,"address":[14334602],"length":1,"stats":{"Line":2}},{"line":57,"address":[12949666,12949736],"length":1,"stats":{"Line":5}},{"line":58,"address":[14316355],"length":1,"stats":{"Line":2}},{"line":59,"address":[14334655,14334619],"length":1,"stats":{"Line":5}},{"line":60,"address":[17113841],"length":1,"stats":{"Line":2}},{"line":62,"address":[14334650],"length":1,"stats":{"Line":2}},{"line":69,"address":[12949168],"length":1,"stats":{"Line":2}},{"line":70,"address":[14334087],"length":1,"stats":{"Line":2}},{"line":71,"address":[17113302],"length":1,"stats":{"Line":2}},{"line":72,"address":[17113309],"length":1,"stats":{"Line":2}},{"line":73,"address":[14315844],"length":1,"stats":{"Line":2}},{"line":74,"address":[14315851],"length":1,"stats":{"Line":2}},{"line":75,"address":[14315858],"length":1,"stats":{"Line":2}},{"line":76,"address":[14334153],"length":1,"stats":{"Line":2}},{"line":77,"address":[17113344],"length":1,"stats":{"Line":2}},{"line":78,"address":[14334167],"length":1,"stats":{"Line":2}},{"line":86,"address":[17113856],"length":1,"stats":{"Line":2}},{"line":87,"address":[14334709],"length":1,"stats":{"Line":2}},{"line":88,"address":[17113924],"length":1,"stats":{"Line":2}},{"line":89,"address":[14316572],"length":1,"stats":{"Line":2}},{"line":90,"address":[17114182],"length":1,"stats":{"Line":2}},{"line":91,"address":[14316848],"length":1,"stats":{"Line":2}},{"line":92,"address":[14316986],"length":1,"stats":{"Line":0}},{"line":93,"address":[14317124],"length":1,"stats":{"Line":0}},{"line":94,"address":[14317262],"length":1,"stats":{"Line":0}},{"line":95,"address":[14317400],"length":1,"stats":{"Line":0}}],"covered":38,"coverable":42},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","lib.rs"],"content":"//! Dependi LSP - Language Server for dependency management\n//!\n//! This crate provides a Language Server Protocol implementation for\n//! managing dependencies in various package managers (Cargo, npm, etc.)\n\npub mod backend;\npub mod cache;\npub mod config;\npub mod document;\npub mod file_types;\npub mod parsers;\npub mod providers;\npub mod registries;\npub mod reports;\npub mod utils;\npub mod vulnerabilities;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","main.rs"],"content":"mod backend;\nmod cache;\nmod config;\nmod document;\nmod file_types;\nmod parsers;\nmod providers;\nmod registries;\nmod reports;\nmod utils;\nmod vulnerabilities;\n\nuse std::path::PathBuf;\nuse std::process::ExitCode;\n\nuse clap::{Parser, Subcommand};\nuse tower_lsp::{LspService, Server};\nuse tracing_subscriber::{EnvFilter, layer::SubscriberExt, util::SubscriberInitExt};\n\nuse crate::backend::DependiBackend;\n\n#[derive(Parser)]\n#[command(name = \"dependi-lsp\")]\n#[command(about = \"Language server for dependency management\", long_about = None)]\n#[command(version)]\nstruct Cli {\n    #[command(subcommand)]\n    command: Option\u003cCommands\u003e,\n}\n\n#[derive(Subcommand)]\nenum Commands {\n    /// Start the LSP server (default behavior)\n    Lsp,\n    /// Scan a file for vulnerabilities and exit with code 1 if found\n    Scan {\n        /// Path to the dependency file to scan\n        #[arg(short, long)]\n        file: PathBuf,\n\n        /// Output format: json, markdown, or summary\n        #[arg(short, long, default_value = \"summary\")]\n        output: String,\n\n        /// Minimum severity level to report (low, medium, high, critical)\n        #[arg(short, long, default_value = \"low\")]\n        min_severity: String,\n\n        /// Exit with code 1 if vulnerabilities are found\n        #[arg(long, default_value = \"true\")]\n        fail_on_vulns: bool,\n    },\n}\n\n#[tokio::main]\nasync fn main() -\u003e ExitCode {\n    let cli = Cli::parse();\n\n    // Initialize tracing\n    tracing_subscriber::registry()\n        .with(EnvFilter::try_from_default_env().unwrap_or_else(|_| EnvFilter::new(\"info\")))\n        .with(tracing_subscriber::fmt::layer().with_writer(std::io::stderr))\n        .init();\n\n    match cli.command {\n        Some(Commands::Scan {\n            file,\n            output,\n            min_severity,\n            fail_on_vulns,\n        }) =\u003e run_scan(file, output, min_severity, fail_on_vulns).await,\n        Some(Commands::Lsp) | None =\u003e {\n            run_lsp().await;\n            ExitCode::SUCCESS\n        }\n    }\n}\n\nasync fn run_lsp() {\n    tracing::info!(\"Starting Dependi LSP server\");\n\n    let stdin = tokio::io::stdin();\n    let stdout = tokio::io::stdout();\n\n    let (service, socket) = LspService::new(DependiBackend::new);\n    Server::new(stdin, stdout, socket).serve(service).await;\n}\n\nasync fn run_scan(\n    file: PathBuf,\n    output: String,\n    min_severity: String,\n    fail_on_vulns: bool,\n) -\u003e ExitCode {\n    use crate::parsers::{\n        Parser, cargo::CargoParser, csharp::CsharpParser, dart::DartParser, go::GoParser,\n        npm::NpmParser, php::PhpParser, python::PythonParser,\n    };\n    use crate::registries::VulnerabilitySeverity;\n    use crate::vulnerabilities::{Ecosystem, VulnerabilityQuery, osv::OsvClient};\n\n    // Read file (using async I/O)\n    let content = match tokio::fs::read_to_string(\u0026file).await {\n        Ok(c) =\u003e c,\n        Err(e) =\u003e {\n            eprintln!(\"Error reading file: {}\", e);\n            return ExitCode::FAILURE;\n        }\n    };\n\n    let file_name = file.file_name().and_then(|n| n.to_str()).unwrap_or(\"\");\n\n    // Detect file type and parse\n    let (dependencies, ecosystem) = if file_name == \"Cargo.toml\" {\n        (CargoParser::new().parse(\u0026content), Ecosystem::CratesIo)\n    } else if file_name == \"package.json\" {\n        (NpmParser::new().parse(\u0026content), Ecosystem::Npm)\n    } else if file_name == \"requirements.txt\" || file_name == \"pyproject.toml\" {\n        (PythonParser::new().parse(\u0026content), Ecosystem::PyPI)\n    } else if file_name == \"go.mod\" {\n        (GoParser::new().parse(\u0026content), Ecosystem::Go)\n    } else if file_name == \"composer.json\" {\n        (PhpParser::new().parse(\u0026content), Ecosystem::Packagist)\n    } else if file_name == \"pubspec.yaml\" {\n        (DartParser::new().parse(\u0026content), Ecosystem::Pub)\n    } else if file_name.ends_with(\".csproj\") {\n        (CsharpParser::new().parse(\u0026content), Ecosystem::NuGet)\n    } else {\n        eprintln!(\"Unsupported file type: {}\", file_name);\n        return ExitCode::FAILURE;\n    };\n\n    if dependencies.is_empty() {\n        println!(\"No dependencies found in {}\", file.display());\n        return ExitCode::SUCCESS;\n    }\n\n    eprintln!(\n        \"Scanning {} dependencies in {}...\",\n        dependencies.len(),\n        file.display()\n    );\n\n    // Build vulnerability queries\n    let queries: Vec\u003cVulnerabilityQuery\u003e = dependencies\n        .iter()\n        .map(|dep| VulnerabilityQuery {\n            ecosystem,\n            package_name: dep.name.clone(),\n            version: dep.version.clone(),\n        })\n        .collect();\n\n    // Query OSV.dev\n    let osv_client = OsvClient::default();\n    let results = match osv_client.query_batch(\u0026queries).await {\n        Ok(r) =\u003e r,\n        Err(e) =\u003e {\n            eprintln!(\"Error querying OSV.dev: {}\", e);\n            return ExitCode::FAILURE;\n        }\n    };\n\n    // Parse minimum severity using shared method\n    let min_sev = VulnerabilitySeverity::from_str_loose(\u0026min_severity);\n\n    // Filter and collect vulnerabilities\n    let mut total_vulns = 0;\n    let mut critical_count = 0;\n    let mut high_count = 0;\n    let mut medium_count = 0;\n    let mut low_count = 0;\n    let mut vuln_details: Vec\u003cserde_json::Value\u003e = Vec::new();\n\n    for (dep, result) in dependencies.iter().zip(results.iter()) {\n        for vuln in \u0026result.vulnerabilities {\n            // Filter by severity using shared method\n            if !vuln.severity.meets_threshold(\u0026min_sev) {\n                continue;\n            }\n\n            total_vulns += 1;\n            match vuln.severity {\n                VulnerabilitySeverity::Critical =\u003e critical_count += 1,\n                VulnerabilitySeverity::High =\u003e high_count += 1,\n                VulnerabilitySeverity::Medium =\u003e medium_count += 1,\n                VulnerabilitySeverity::Low =\u003e low_count += 1,\n            }\n\n            vuln_details.push(serde_json::json!({\n                \"package\": dep.name,\n                \"version\": dep.version,\n                \"id\": vuln.id,\n                \"severity\": vuln.severity.as_str(),\n                \"description\": vuln.description,\n                \"url\": vuln.url\n            }));\n        }\n    }\n\n    // Output results\n    match output.as_str() {\n        \"json\" =\u003e {\n            let report = serde_json::json!({\n                \"file\": file.display().to_string(),\n                \"summary\": {\n                    \"total\": total_vulns,\n                    \"critical\": critical_count,\n                    \"high\": high_count,\n                    \"medium\": medium_count,\n                    \"low\": low_count\n                },\n                \"vulnerabilities\": vuln_details\n            });\n            println!(\"{}\", serde_json::to_string_pretty(\u0026report).unwrap());\n        }\n        \"markdown\" =\u003e {\n            println!(\"# Vulnerability Report\\n\");\n            println!(\"**File**: {}\", file.display());\n            println!(\"**Date**: {}\\n\", chrono::Local::now().format(\"%Y-%m-%d\"));\n            println!(\"## Summary\\n\");\n            println!(\"| Severity | Count |\");\n            println!(\"|----------|-------|\");\n            println!(\"| ⚠ Critical | {} |\", critical_count);\n            println!(\"| ▲ High | {} |\", high_count);\n            println!(\"| ● Medium | {} |\", medium_count);\n            println!(\"| ○ Low | {} |\", low_count);\n            println!(\"| **Total** | **{}** |\\n\", total_vulns);\n\n            if !vuln_details.is_empty() {\n                println!(\"## Vulnerabilities\\n\");\n                for vuln in \u0026vuln_details {\n                    let severity_icon = match vuln[\"severity\"].as_str().unwrap_or(\"low\") {\n                        \"critical\" =\u003e \"⚠\",\n                        \"high\" =\u003e \"▲\",\n                        \"medium\" =\u003e \"●\",\n                        _ =\u003e \"○\",\n                    };\n                    println!(\n                        \"### {}@{}\\n\",\n                        vuln[\"package\"].as_str().unwrap_or(\"\"),\n                        vuln[\"version\"].as_str().unwrap_or(\"\")\n                    );\n                    if let Some(url) = vuln[\"url\"].as_str() {\n                        println!(\n                            \"- **[{}]({})** ({} {}): {}\",\n                            vuln[\"id\"].as_str().unwrap_or(\"\"),\n                            url,\n                            severity_icon,\n                            vuln[\"severity\"].as_str().unwrap_or(\"\").to_uppercase(),\n                            vuln[\"description\"].as_str().unwrap_or(\"\")\n                        );\n                    } else {\n                        println!(\n                            \"- **{}** ({} {}): {}\",\n                            vuln[\"id\"].as_str().unwrap_or(\"\"),\n                            severity_icon,\n                            vuln[\"severity\"].as_str().unwrap_or(\"\").to_uppercase(),\n                            vuln[\"description\"].as_str().unwrap_or(\"\")\n                        );\n                    }\n                    println!();\n                }\n            }\n        }\n        _ =\u003e {\n            // Summary format\n            println!(\"Vulnerability Scan Results for {}\\n\", file.display());\n            println!(\"  ⚠ Critical: {}\", critical_count);\n            println!(\"  ▲ High:     {}\", high_count);\n            println!(\"  ● Medium:   {}\", medium_count);\n            println!(\"  ○ Low:      {}\", low_count);\n            println!(\"  ─────────────\");\n            println!(\"  Total:      {}\\n\", total_vulns);\n\n            if total_vulns == 0 {\n                println!(\"[OK] No vulnerabilities found!\");\n            } else {\n                println!(\"⚠ {} vulnerabilities found!\", total_vulns);\n            }\n        }\n    }\n\n    // Exit code\n    if fail_on_vulns \u0026\u0026 total_vulns \u003e 0 {\n        ExitCode::FAILURE\n    } else {\n        ExitCode::SUCCESS\n    }\n}\n","traces":[{"line":56,"address":[20283542,20283152,20283548],"length":1,"stats":{"Line":0}},{"line":57,"address":[15511627],"length":1,"stats":{"Line":0}},{"line":60,"address":[15512082,15511783,15511948],"length":1,"stats":{"Line":0}},{"line":61,"address":[15511818,15512617,15513280,15511980,15511880,15513264,15511853],"length":1,"stats":{"Line":0}},{"line":62,"address":[15512111,15512018,15512011,15512583],"length":1,"stats":{"Line":0}},{"line":65,"address":[15512209],"length":1,"stats":{"Line":0}},{"line":66,"address":[15512384],"length":1,"stats":{"Line":0}},{"line":73,"address":[15512286,15511708,15512454,15512894],"length":1,"stats":{"Line":0}},{"line":74,"address":[15513030],"length":1,"stats":{"Line":0}},{"line":79,"address":[15513494,15514689,15513401,15513536,15514908,15513376],"length":1,"stats":{"Line":0}},{"line":80,"address":[15513441,15513582,15513796],"length":1,"stats":{"Line":0}},{"line":82,"address":[15513774],"length":1,"stats":{"Line":0}},{"line":83,"address":[15514027],"length":1,"stats":{"Line":0}},{"line":85,"address":[15514107,15514176],"length":1,"stats":{"Line":0}},{"line":86,"address":[15514720,15514524,15513521,15514286],"length":1,"stats":{"Line":0}},{"line":89,"address":[20283600],"length":1,"stats":{"Line":0}},{"line":103,"address":[15341916],"length":1,"stats":{"Line":0}},{"line":104,"address":[15515928],"length":1,"stats":{"Line":0}},{"line":105,"address":[15515866],"length":1,"stats":{"Line":0}},{"line":106,"address":[15519049,15515890],"length":1,"stats":{"Line":0}},{"line":107,"address":[15519118],"length":1,"stats":{"Line":0}},{"line":111,"address":[15531680,15515990,15531694,15516084],"length":1,"stats":{"Line":0}},{"line":114,"address":[15516261,15517045,15517938],"length":1,"stats":{"Line":0}},{"line":115,"address":[15517813,15516346],"length":1,"stats":{"Line":0}},{"line":116,"address":[15516363,15516314,15517800],"length":1,"stats":{"Line":0}},{"line":117,"address":[15516409,15517675],"length":1,"stats":{"Line":0}},{"line":118,"address":[15516426,15516377,15517662,15516489],"length":1,"stats":{"Line":0}},{"line":119,"address":[15516472,15517537],"length":1,"stats":{"Line":0}},{"line":120,"address":[15517524,15516503],"length":1,"stats":{"Line":0}},{"line":121,"address":[15517399,15516588],"length":1,"stats":{"Line":0}},{"line":122,"address":[15516556,15517386,15516605],"length":1,"stats":{"Line":0}},{"line":123,"address":[15517261,15516651],"length":1,"stats":{"Line":0}},{"line":124,"address":[15516668,15516619,15517248],"length":1,"stats":{"Line":0}},{"line":125,"address":[15516726,15517123],"length":1,"stats":{"Line":0}},{"line":126,"address":[15516743,15516682],"length":1,"stats":{"Line":0}},{"line":127,"address":[15516791,15516912],"length":1,"stats":{"Line":0}},{"line":129,"address":[15516757,15516798],"length":1,"stats":{"Line":0}},{"line":130,"address":[15516867],"length":1,"stats":{"Line":0}},{"line":133,"address":[15517098,15517997],"length":1,"stats":{"Line":0}},{"line":134,"address":[15518041,15518817],"length":1,"stats":{"Line":0}},{"line":135,"address":[15518972],"length":1,"stats":{"Line":0}},{"line":138,"address":[15518201],"length":1,"stats":{"Line":0}},{"line":145,"address":[15518360,15518483],"length":1,"stats":{"Line":0}},{"line":147,"address":[15531655,15518453,15531588,15531649,15531456],"length":1,"stats":{"Line":0}},{"line":148,"address":[15531492],"length":1,"stats":{"Line":0}},{"line":149,"address":[15531501],"length":1,"stats":{"Line":0}},{"line":150,"address":[15531530],"length":1,"stats":{"Line":0}},{"line":155,"address":[15518513],"length":1,"stats":{"Line":0}},{"line":156,"address":[15341937],"length":1,"stats":{"Line":0}},{"line":157,"address":[15519486],"length":1,"stats":{"Line":0}},{"line":158,"address":[15519428],"length":1,"stats":{"Line":0}},{"line":159,"address":[15519452,15531252],"length":1,"stats":{"Line":0}},{"line":160,"address":[15531321],"length":1,"stats":{"Line":0}},{"line":165,"address":[15519633,15519550],"length":1,"stats":{"Line":0}},{"line":168,"address":[15519661],"length":1,"stats":{"Line":0}},{"line":169,"address":[15519672],"length":1,"stats":{"Line":0}},{"line":170,"address":[15519683],"length":1,"stats":{"Line":0}},{"line":171,"address":[15519694],"length":1,"stats":{"Line":0}},{"line":172,"address":[15519705],"length":1,"stats":{"Line":0}},{"line":173,"address":[15519716],"length":1,"stats":{"Line":0}},{"line":175,"address":[15519833,15519743],"length":1,"stats":{"Line":0}},{"line":176,"address":[15520188,15528891],"length":1,"stats":{"Line":0}},{"line":178,"address":[15528996],"length":1,"stats":{"Line":0}},{"line":182,"address":[15529093,15529029],"length":1,"stats":{"Line":0}},{"line":183,"address":[15529063],"length":1,"stats":{"Line":0}},{"line":184,"address":[15529173,15529315],"length":1,"stats":{"Line":0}},{"line":185,"address":[15529153,15529281],"length":1,"stats":{"Line":0}},{"line":186,"address":[15529133,15529247],"length":1,"stats":{"Line":0}},{"line":187,"address":[15529201,15529113],"length":1,"stats":{"Line":0}},{"line":190,"address":[15529345,15529453,15529752,15530490,15530816,15529936,15529236,15530561,15530255,15530337,15530003,15529681,15530187,15529383,15530745],"length":1,"stats":{"Line":0}},{"line":194,"address":[15530305,15530235],"length":1,"stats":{"Line":0}},{"line":202,"address":[15520222],"length":1,"stats":{"Line":0}},{"line":203,"address":[15520287],"length":1,"stats":{"Line":0}},{"line":204,"address":[15526250,15525681,15525571,15526544,15520376,15525609,15527291,15527753,15528676,15527687,15525801,15527357,15525828,15526316,15526791,15526857,15527107,15526607,15526174,15527041,15526119],"length":1,"stats":{"Line":0}},{"line":205,"address":[15525660,15525735],"length":1,"stats":{"Line":0}},{"line":215,"address":[15528038,15527987],"length":1,"stats":{"Line":0}},{"line":217,"address":[15520393,15520342],"length":1,"stats":{"Line":0}},{"line":218,"address":[15520434,15521388],"length":1,"stats":{"Line":0}},{"line":219,"address":[15521415],"length":1,"stats":{"Line":0}},{"line":220,"address":[15521613],"length":1,"stats":{"Line":0}},{"line":221,"address":[15521822],"length":1,"stats":{"Line":0}},{"line":222,"address":[15521867],"length":1,"stats":{"Line":0}},{"line":223,"address":[15521912],"length":1,"stats":{"Line":0}},{"line":224,"address":[15521965],"length":1,"stats":{"Line":0}},{"line":225,"address":[15522069],"length":1,"stats":{"Line":0}},{"line":226,"address":[15522173],"length":1,"stats":{"Line":0}},{"line":227,"address":[15522277],"length":1,"stats":{"Line":0}},{"line":228,"address":[15522381],"length":1,"stats":{"Line":0}},{"line":230,"address":[15522485],"length":1,"stats":{"Line":0}},{"line":231,"address":[15522516],"length":1,"stats":{"Line":0}},{"line":232,"address":[15522561],"length":1,"stats":{"Line":0}},{"line":233,"address":[15522730],"length":1,"stats":{"Line":0}},{"line":234,"address":[15522973,15522892],"length":1,"stats":{"Line":0}},{"line":235,"address":[15522947,15523060,15523012],"length":1,"stats":{"Line":0}},{"line":236,"address":[15523096,15523131,15523034],"length":1,"stats":{"Line":0}},{"line":237,"address":[15523102],"length":1,"stats":{"Line":0}},{"line":239,"address":[15523484],"length":1,"stats":{"Line":0}},{"line":244,"address":[15523647],"length":1,"stats":{"Line":0}},{"line":245,"address":[15524023],"length":1,"stats":{"Line":0}},{"line":254,"address":[15525145,15525059],"length":1,"stats":{"Line":0}},{"line":262,"address":[15525547,15524743],"length":1,"stats":{"Line":0}},{"line":268,"address":[15520479,15520407],"length":1,"stats":{"Line":0}},{"line":269,"address":[15520642],"length":1,"stats":{"Line":0}},{"line":270,"address":[15520746],"length":1,"stats":{"Line":0}},{"line":271,"address":[15520850],"length":1,"stats":{"Line":0}},{"line":272,"address":[15520954],"length":1,"stats":{"Line":0}},{"line":273,"address":[15521050],"length":1,"stats":{"Line":0}},{"line":274,"address":[15521103],"length":1,"stats":{"Line":0}},{"line":276,"address":[15521199],"length":1,"stats":{"Line":0}},{"line":277,"address":[15521209,15521270],"length":1,"stats":{"Line":0}},{"line":279,"address":[15521243,15521317],"length":1,"stats":{"Line":0}},{"line":285,"address":[15528262,15521299],"length":1,"stats":{"Line":0}},{"line":286,"address":[15528274],"length":1,"stats":{"Line":0}},{"line":288,"address":[15528254],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":114},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","cargo.rs"],"content":"//! Parser for Cargo.toml files using structured TOML parsing\n\nuse super::{Dependency, Parser};\nuse taplo::dom::Node;\nuse taplo::parser::parse;\n\n/// Parser for Rust Cargo.toml dependency files\n#[derive(Debug, Default)]\npub struct CargoParser;\n\nimpl CargoParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for CargoParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let parsed = parse(content);\n\n        // If there are critical parse errors, return empty\n        if parsed.errors.iter().any(|e| e.message.contains(\"expected\")) {\n            return Vec::new();\n        }\n\n        let dom = parsed.into_dom();\n\n        let mut dependencies = Vec::new();\n\n        // Define dependency sections to parse: (section_name, is_dev)\n        let sections = [\n            (\"dependencies\", false),\n            (\"dev-dependencies\", true),\n            (\"build-dependencies\", false),\n        ];\n\n        for (section_name, is_dev) in sections {\n            // Parse regular section dependencies (e.g., [dependencies])\n            if let Some(section) = dom.get(section_name).as_table() {\n                let entries = section.entries().read();\n                for (key, value) in entries.iter() {\n                    let name = key.value().to_string();\n                    if let Some(dep) = parse_dependency(\u0026name, value, content, is_dev) {\n                        dependencies.push(dep);\n                    }\n                }\n            }\n\n            // Parse table-style dependencies (e.g., [dependencies.reqwest])\n            let pattern = format!(\"{}.*\", section_name);\n            if let Ok(keys) = pattern.parse::\u003ctaplo::dom::Keys\u003e()\n                \u0026\u0026 let Ok(matches) = dom.find_all_matches(keys, false)\n            {\n                for (key_path, node) in matches {\n                    // Extract the dependency name from the key path\n                    let key_str = key_path.to_string();\n                    let name = key_str\n                        .split('.')\n                        .next_back()\n                        .unwrap_or(\u0026key_str)\n                        .to_string();\n\n                    // For table dependencies, look for the version key\n                    if let Some(table) = node.as_table()\n                        \u0026\u0026 let Some(version_node) = table.get(\"version\")\n                        \u0026\u0026 let Some(version_str) = version_node.as_str()\n                    {\n                        let version = version_str.value().to_string();\n                        let optional = table\n                            .get(\"optional\")\n                            .and_then(|n| n.as_bool().map(|b| b.value()))\n                            .unwrap_or(false);\n\n                        if let Some((line, name_start, name_end, version_start, version_end)) =\n                            find_table_dependency_positions(content, \u0026name, \u0026version)\n                        {\n                            dependencies.push(Dependency {\n                                name,\n                                version,\n                                line,\n                                name_start,\n                                name_end,\n                                version_start,\n                                version_end,\n                                dev: is_dev,\n                                optional,\n                            });\n                        }\n                    }\n                }\n            }\n        }\n\n        dependencies\n    }\n}\n\n/// Parse a single dependency from a TOML node\nfn parse_dependency(name: \u0026str, node: \u0026Node, content: \u0026str, is_dev: bool) -\u003e Option\u003cDependency\u003e {\n    match node {\n        Node::Str(s) =\u003e {\n            // Simple dependency: name = \"1.0.0\"\n            let version = s.value().to_string();\n            let (line, name_start, name_end, version_start, version_end) =\n                find_simple_dependency_positions(content, name, \u0026version)?;\n\n            Some(Dependency {\n                name: name.to_string(),\n                version,\n                line,\n                name_start,\n                name_end,\n                version_start,\n                version_end,\n                dev: is_dev,\n                optional: false,\n            })\n        }\n        Node::Table(table) =\u003e {\n            // Inline table: name = { version = \"1.0.0\", ... }\n            let version_node = table.get(\"version\")?;\n            let version_str = version_node.as_str()?;\n            let version = version_str.value().to_string();\n\n            let optional = table\n                .get(\"optional\")\n                .and_then(|n| n.as_bool().map(|b| b.value()))\n                .unwrap_or(false);\n\n            let (line, name_start, name_end, version_start, version_end) =\n                find_inline_table_positions(content, name, \u0026version)?;\n\n            Some(Dependency {\n                name: name.to_string(),\n                version,\n                line,\n                name_start,\n                name_end,\n                version_start,\n                version_end,\n                dev: is_dev,\n                optional,\n            })\n        }\n        _ =\u003e None,\n    }\n}\n\n/// Find positions for a simple dependency: `name = \"version\"`\nfn find_simple_dependency_positions(\n    content: \u0026str,\n    name: \u0026str,\n    version: \u0026str,\n) -\u003e Option\u003c(u32, u32, u32, u32, u32)\u003e {\n    for (line_idx, line) in content.lines().enumerate() {\n        // Look for pattern: name = \"version\" or name = 'version'\n        let trimmed = line.trim();\n        if !trimmed.starts_with(name) {\n            continue;\n        }\n\n        // Check if this line has the exact name followed by =\n        let after_name = trimmed[name.len()..].trim_start();\n        if !after_name.starts_with('=') {\n            continue;\n        }\n\n        // Check for simple string value (not inline table)\n        let after_eq = after_name[1..].trim_start();\n        if after_eq.starts_with('{') {\n            continue; // This is an inline table, skip\n        }\n\n        // Check if version is in this line\n        if !line.contains(version) {\n            continue;\n        }\n\n        // Calculate positions\n        let name_start = line.find(name)? as u32;\n        let name_end = name_start + name.len() as u32;\n\n        // Find version position (inside quotes)\n        let version_start = line.find(version)? as u32;\n        let version_end = version_start + version.len() as u32;\n\n        return Some((\n            line_idx as u32,\n            name_start,\n            name_end,\n            version_start,\n            version_end,\n        ));\n    }\n    None\n}\n\n/// Find positions for an inline table dependency: `name = { version = \"1.0.0\", ... }`\nfn find_inline_table_positions(\n    content: \u0026str,\n    name: \u0026str,\n    version: \u0026str,\n) -\u003e Option\u003c(u32, u32, u32, u32, u32)\u003e {\n    for (line_idx, line) in content.lines().enumerate() {\n        let trimmed = line.trim();\n        if !trimmed.starts_with(name) {\n            continue;\n        }\n\n        // Check if this line has the name followed by = and {\n        let after_name = trimmed[name.len()..].trim_start();\n        if !after_name.starts_with('=') {\n            continue;\n        }\n\n        let after_eq = after_name[1..].trim_start();\n        if !after_eq.starts_with('{') {\n            continue;\n        }\n\n        // Check if version is in this line\n        if !line.contains(version) {\n            continue;\n        }\n\n        // Calculate positions\n        let name_start = line.find(name)? as u32;\n        let name_end = name_start + name.len() as u32;\n\n        // Find version position (inside quotes after \"version =\")\n        let version_start = line.find(version)? as u32;\n        let version_end = version_start + version.len() as u32;\n\n        return Some((\n            line_idx as u32,\n            name_start,\n            name_end,\n            version_start,\n            version_end,\n        ));\n    }\n    None\n}\n\n/// Find positions for a table dependency: `[dependencies.name]` with `version = \"x.y.z\"`\nfn find_table_dependency_positions(\n    content: \u0026str,\n    name: \u0026str,\n    version: \u0026str,\n) -\u003e Option\u003c(u32, u32, u32, u32, u32)\u003e {\n    let mut found_table = false;\n    let mut name_start = 0u32;\n    let mut name_end = 0u32;\n\n    for (line_idx, line) in content.lines().enumerate() {\n        let trimmed = line.trim();\n\n        // Look for the table header containing the dependency name\n        if trimmed.starts_with('[') \u0026\u0026 trimmed.ends_with(']') \u0026\u0026 trimmed.contains(name) {\n            // Check if this is a dependencies table\n            let inner = \u0026trimmed[1..trimmed.len() - 1];\n            if inner.contains(\"dependencies.\") \u0026\u0026 inner.ends_with(name) {\n                found_table = true;\n                // Name position is in the header after the last dot\n                if let Some(dot_pos) = line.rfind('.') {\n                    name_start = (dot_pos + 1) as u32;\n                    name_end = (line.len() - 1) as u32; // Before the closing ]\n                }\n                continue;\n            }\n        }\n\n        // If we found the table, look for version = \"x.y.z\"\n        if found_table {\n            // Check if we hit a new section\n            if trimmed.starts_with('[') {\n                break;\n            }\n\n            if trimmed.starts_with(\"version\") \u0026\u0026 line.contains(version) {\n                let version_start = line.find(version)? as u32;\n                let version_end = version_start + version.len() as u32;\n                return Some((\n                    line_idx as u32,\n                    name_start,\n                    name_end,\n                    version_start,\n                    version_end,\n                ));\n            }\n        }\n    }\n    None\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_simple_dependency() {\n        let parser = CargoParser::new();\n        let content = r#\"\n[dependencies]\nserde = \"1.0.0\"\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"serde\");\n        assert_eq!(deps[0].version, \"1.0.0\");\n        assert!(!deps[0].dev);\n    }\n\n    #[test]\n    fn test_inline_table_dependency() {\n        let parser = CargoParser::new();\n        let content = r#\"\n[dependencies]\nserde = { version = \"1.0.0\", features = [\"derive\"] }\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"serde\");\n        assert_eq!(deps[0].version, \"1.0.0\");\n    }\n\n    #[test]\n    fn test_dev_dependencies() {\n        let parser = CargoParser::new();\n        let content = r#\"\n[dev-dependencies]\ntokio-test = \"0.4\"\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"tokio-test\");\n        assert!(deps[0].dev);\n    }\n\n    #[test]\n    fn test_multiple_sections() {\n        let parser = CargoParser::new();\n        let content = r#\"\n[package]\nname = \"test\"\n\n[dependencies]\nserde = \"1.0\"\ntokio = { version = \"1.0\", features = [\"full\"] }\n\n[dev-dependencies]\ncriterion = \"0.5\"\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 3);\n\n        let serde = deps.iter().find(|d| d.name == \"serde\").unwrap();\n        assert_eq!(serde.version, \"1.0\");\n        assert!(!serde.dev);\n\n        let tokio = deps.iter().find(|d| d.name == \"tokio\").unwrap();\n        assert_eq!(tokio.version, \"1.0\");\n        assert!(!tokio.dev);\n\n        let criterion = deps.iter().find(|d| d.name == \"criterion\").unwrap();\n        assert_eq!(criterion.version, \"0.5\");\n        assert!(criterion.dev);\n    }\n\n    #[test]\n    fn test_table_dependency() {\n        let parser = CargoParser::new();\n        let content = r#\"\n[dependencies.reqwest]\nversion = \"0.12\"\nfeatures = [\"json\"]\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"reqwest\");\n        assert_eq!(deps[0].version, \"0.12\");\n    }\n\n    #[test]\n    fn test_optional_dependency() {\n        let parser = CargoParser::new();\n        let content = r#\"\n[dependencies]\noptional-dep = { version = \"1.0\", optional = true }\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert!(deps[0].optional);\n    }\n}\n","traces":[{"line":18,"address":[13778658,13775816,13773568],"length":1,"stats":{"Line":6}},{"line":19,"address":[14459109],"length":1,"stats":{"Line":7}},{"line":22,"address":[13024553,13024528],"length":1,"stats":{"Line":12}},{"line":23,"address":[13773983],"length":1,"stats":{"Line":0}},{"line":26,"address":[12892168,12892277],"length":1,"stats":{"Line":13}},{"line":28,"address":[12892301],"length":1,"stats":{"Line":6}},{"line":31,"address":[12892457],"length":1,"stats":{"Line":10}},{"line":32,"address":[18576512],"length":1,"stats":{"Line":5}},{"line":33,"address":[13774127],"length":1,"stats":{"Line":8}},{"line":34,"address":[14459618],"length":1,"stats":{"Line":8}},{"line":37,"address":[18576713,18576942,18576856],"length":1,"stats":{"Line":37}},{"line":39,"address":[18577174,18577269,18577022],"length":1,"stats":{"Line":36}},{"line":40,"address":[18577324,18577373],"length":1,"stats":{"Line":21}},{"line":41,"address":[14460571,14460492],"length":1,"stats":{"Line":21}},{"line":42,"address":[13775481,13775362],"length":1,"stats":{"Line":21}},{"line":43,"address":[18578018,18577904],"length":1,"stats":{"Line":21}},{"line":44,"address":[18578206,18578177],"length":1,"stats":{"Line":16}},{"line":50,"address":[14461278,14460891],"length":1,"stats":{"Line":8}},{"line":51,"address":[13775930,13776115,13776013],"length":1,"stats":{"Line":15}},{"line":52,"address":[13776333,13776147,13776250],"length":1,"stats":{"Line":12}},{"line":54,"address":[12894825,12894690,12894597],"length":1,"stats":{"Line":10}},{"line":56,"address":[18579093],"length":1,"stats":{"Line":4}},{"line":57,"address":[18579300],"length":1,"stats":{"Line":4}},{"line":60,"address":[18579475],"length":1,"stats":{"Line":4}},{"line":64,"address":[13777300,13777224],"length":1,"stats":{"Line":10}},{"line":65,"address":[18579736,18579798],"length":1,"stats":{"Line":6}},{"line":66,"address":[14462954,14463027],"length":1,"stats":{"Line":7}},{"line":68,"address":[13777679,13777626],"length":1,"stats":{"Line":6}},{"line":69,"address":[18580210],"length":1,"stats":{"Line":5}},{"line":71,"address":[13024592,13024729,13024720,13024606],"length":1,"stats":{"Line":11}},{"line":74,"address":[14463437],"length":1,"stats":{"Line":4}},{"line":77,"address":[18580530,18580685],"length":1,"stats":{"Line":4}},{"line":78,"address":[14463534],"length":1,"stats":{"Line":2}},{"line":79,"address":[12896330],"length":1,"stats":{"Line":2}},{"line":94,"address":[18577092],"length":1,"stats":{"Line":6}},{"line":99,"address":[14453536,14454997,14454989],"length":1,"stats":{"Line":10}},{"line":100,"address":[13768206],"length":1,"stats":{"Line":11}},{"line":101,"address":[14453838],"length":1,"stats":{"Line":6}},{"line":103,"address":[18570841],"length":1,"stats":{"Line":6}},{"line":104,"address":[13769643,13768439],"length":1,"stats":{"Line":13}},{"line":107,"address":[14455424],"length":1,"stats":{"Line":8}},{"line":108,"address":[18572282],"length":1,"stats":{"Line":8}},{"line":109,"address":[18572338],"length":1,"stats":{"Line":8}},{"line":119,"address":[13768278],"length":1,"stats":{"Line":7}},{"line":121,"address":[14453929,14453754],"length":1,"stats":{"Line":7}},{"line":122,"address":[14454061,14453988,14454995],"length":1,"stats":{"Line":14}},{"line":123,"address":[13768703],"length":1,"stats":{"Line":7}},{"line":125,"address":[14454347],"length":1,"stats":{"Line":5}},{"line":127,"address":[14454304],"length":1,"stats":{"Line":15}},{"line":130,"address":[18571342],"length":1,"stats":{"Line":5}},{"line":133,"address":[13769297],"length":1,"stats":{"Line":6}},{"line":134,"address":[13769188],"length":1,"stats":{"Line":5}},{"line":135,"address":[14454705],"length":1,"stats":{"Line":6}},{"line":145,"address":[13768252],"length":1,"stats":{"Line":0}},{"line":150,"address":[18574880],"length":1,"stats":{"Line":7}},{"line":155,"address":[14458080,14457997],"length":1,"stats":{"Line":14}},{"line":157,"address":[14458196],"length":1,"stats":{"Line":8}},{"line":158,"address":[18575219],"length":1,"stats":{"Line":8}},{"line":163,"address":[18575268],"length":1,"stats":{"Line":8}},{"line":164,"address":[14458366],"length":1,"stats":{"Line":8}},{"line":169,"address":[14458396],"length":1,"stats":{"Line":8}},{"line":170,"address":[14458447],"length":1,"stats":{"Line":8}},{"line":175,"address":[18575462],"length":1,"stats":{"Line":8}},{"line":180,"address":[14458521],"length":1,"stats":{"Line":8}},{"line":181,"address":[18575701,18575597],"length":1,"stats":{"Line":8}},{"line":184,"address":[18575719,18575651],"length":1,"stats":{"Line":8}},{"line":185,"address":[13773473,13773336],"length":1,"stats":{"Line":8}},{"line":187,"address":[12891662],"length":1,"stats":{"Line":8}},{"line":195,"address":[14458263],"length":1,"stats":{"Line":0}},{"line":199,"address":[14455616],"length":1,"stats":{"Line":5}},{"line":204,"address":[12888608,12888525],"length":1,"stats":{"Line":12}},{"line":205,"address":[13770452],"length":1,"stats":{"Line":7}},{"line":206,"address":[13770499],"length":1,"stats":{"Line":7}},{"line":211,"address":[12888820],"length":1,"stats":{"Line":5}},{"line":212,"address":[14456078],"length":1,"stats":{"Line":5}},{"line":216,"address":[12888924],"length":1,"stats":{"Line":5}},{"line":217,"address":[13770703],"length":1,"stats":{"Line":5}},{"line":222,"address":[12889015],"length":1,"stats":{"Line":5}},{"line":227,"address":[14456234],"length":1,"stats":{"Line":5}},{"line":228,"address":[14456335,14456439],"length":1,"stats":{"Line":5}},{"line":231,"address":[12889204,12889272],"length":1,"stats":{"Line":5}},{"line":232,"address":[13771186,13771049],"length":1,"stats":{"Line":5}},{"line":234,"address":[13771105],"length":1,"stats":{"Line":5}},{"line":242,"address":[12888791],"length":1,"stats":{"Line":2}},{"line":246,"address":[13771200],"length":1,"stats":{"Line":5}},{"line":251,"address":[13771296],"length":1,"stats":{"Line":5}},{"line":252,"address":[18573736],"length":1,"stats":{"Line":5}},{"line":253,"address":[13771315],"length":1,"stats":{"Line":5}},{"line":255,"address":[14456865,14456782],"length":1,"stats":{"Line":8}},{"line":256,"address":[14456981],"length":1,"stats":{"Line":3}},{"line":259,"address":[18574056,18573994],"length":1,"stats":{"Line":11}},{"line":261,"address":[13771798,13771683],"length":1,"stats":{"Line":2}},{"line":262,"address":[13771831,13771771],"length":1,"stats":{"Line":4}},{"line":263,"address":[13771856],"length":1,"stats":{"Line":2}},{"line":265,"address":[14457770,14457873,14457320],"length":1,"stats":{"Line":6}},{"line":266,"address":[13772330,13772393],"length":1,"stats":{"Line":2}},{"line":267,"address":[12890693,12890681,12890640],"length":1,"stats":{"Line":4}},{"line":274,"address":[18574027],"length":1,"stats":{"Line":3}},{"line":276,"address":[13771924],"length":1,"stats":{"Line":2}},{"line":280,"address":[18574385],"length":1,"stats":{"Line":2}},{"line":281,"address":[18574473],"length":1,"stats":{"Line":2}},{"line":282,"address":[12890559,12890416],"length":1,"stats":{"Line":2}},{"line":283,"address":[13772210],"length":1,"stats":{"Line":2}},{"line":284,"address":[18574624],"length":1,"stats":{"Line":2}},{"line":285,"address":[14457652],"length":1,"stats":{"Line":2}},{"line":286,"address":[13772203],"length":1,"stats":{"Line":2}},{"line":293,"address":[13771584],"length":1,"stats":{"Line":4}}],"covered":104,"coverable":107},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","csharp.rs"],"content":"//! Parser for C# .csproj files (NuGet PackageReference format)\n\nuse super::{Dependency, Parser};\n\n/// Parser for C# .csproj files\n#[derive(Debug, Default)]\npub struct CsharpParser;\n\nimpl CsharpParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for CsharpParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let mut dependencies = Vec::new();\n\n        for (line_idx, line) in content.lines().enumerate() {\n            let line_num = line_idx as u32;\n            let trimmed = line.trim();\n\n            // Look for PackageReference elements\n            // Format 1: \u003cPackageReference Include=\"Package\" Version=\"1.0.0\" /\u003e\n            // Format 2: \u003cPackageReference Include=\"Package\"\u003e\u003cVersion\u003e1.0.0\u003c/Version\u003e\u003c/PackageReference\u003e\n            if trimmed.contains(\"\u003cPackageReference\")\n                \u0026\u0026 trimmed.contains(\"Include=\")\n                \u0026\u0026 let Some(dep) = parse_package_reference(line, line_num)\n            {\n                dependencies.push(dep);\n            }\n        }\n\n        dependencies\n    }\n}\n\n/// Parse a PackageReference XML element\nfn parse_package_reference(line: \u0026str, line_num: u32) -\u003e Option\u003cDependency\u003e {\n    // Extract Include attribute (package name)\n    let include_start = line.find(\"Include=\\\"\")? + 9;\n    let include_content = \u0026line[include_start..];\n    let include_end = include_content.find('\"')?;\n    let name = \u0026include_content[..include_end];\n\n    // Try to find Version attribute on same line\n    let version = if let Some(version_attr_start) = line.find(\"Version=\\\"\") {\n        let version_content = \u0026line[version_attr_start + 9..];\n        let version_end = version_content.find('\"')?;\n        version_content[..version_end].to_string()\n    } else if let Some(version_elem_start) = line.find(\"\u003cVersion\u003e\") {\n        // Format: \u003cVersion\u003e1.0.0\u003c/Version\u003e\n        let version_content = \u0026line[version_elem_start + 9..];\n        let version_end = version_content.find('\u003c')?;\n        version_content[..version_end].to_string()\n    } else {\n        // Version might be centrally managed (Directory.Packages.props)\n        // Skip for now\n        return None;\n    };\n\n    // Calculate positions\n    let name_pattern = format!(\"\\\"{}\\\"\", name);\n    let name_pos = line.find(\u0026name_pattern)?;\n    let name_start = (name_pos + 1) as u32;\n    let name_end = name_start + name.len() as u32;\n\n    let version_start = line.find(\u0026version)? as u32;\n    let version_end = version_start + version.len() as u32;\n\n    Some(Dependency {\n        name: name.to_string(),\n        version,\n        line: line_num,\n        name_start,\n        name_end,\n        version_start,\n        version_end,\n        dev: false, // NuGet doesn't have explicit dev dependencies in .csproj\n        optional: false,\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_self_closing() {\n        let content = r#\"\n\u003cProject Sdk=\"Microsoft.NET.Sdk\"\u003e\n  \u003cPropertyGroup\u003e\n    \u003cTargetFramework\u003enet8.0\u003c/TargetFramework\u003e\n  \u003c/PropertyGroup\u003e\n  \u003cItemGroup\u003e\n    \u003cPackageReference Include=\"Newtonsoft.Json\" Version=\"13.0.3\" /\u003e\n    \u003cPackageReference Include=\"Serilog\" Version=\"3.1.1\" /\u003e\n  \u003c/ItemGroup\u003e\n\u003c/Project\u003e\n\"#;\n        let parser = CsharpParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n\n        let newtonsoft = deps.iter().find(|d| d.name == \"Newtonsoft.Json\").unwrap();\n        assert_eq!(newtonsoft.version, \"13.0.3\");\n\n        let serilog = deps.iter().find(|d| d.name == \"Serilog\").unwrap();\n        assert_eq!(serilog.version, \"3.1.1\");\n    }\n\n    #[test]\n    fn test_parse_expanded_format() {\n        let content = r#\"\n\u003cProject Sdk=\"Microsoft.NET.Sdk\"\u003e\n  \u003cItemGroup\u003e\n    \u003cPackageReference Include=\"Microsoft.Extensions.Logging\" Version=\"8.0.0\" /\u003e\n  \u003c/ItemGroup\u003e\n\u003c/Project\u003e\n\"#;\n        let parser = CsharpParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"Microsoft.Extensions.Logging\");\n        assert_eq!(deps[0].version, \"8.0.0\");\n    }\n\n    #[test]\n    fn test_version_positions() {\n        let content = r#\"\n\u003cProject\u003e\n  \u003cItemGroup\u003e\n    \u003cPackageReference Include=\"Serilog\" Version=\"3.1.1\" /\u003e\n  \u003c/ItemGroup\u003e\n\u003c/Project\u003e\n\"#;\n        let parser = CsharpParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 1);\n        let dep = \u0026deps[0];\n        assert!(dep.version_start \u003e dep.name_end);\n    }\n\n    #[test]\n    fn test_skip_no_version() {\n        let content = r#\"\n\u003cProject Sdk=\"Microsoft.NET.Sdk\"\u003e\n  \u003cItemGroup\u003e\n    \u003cPackageReference Include=\"Newtonsoft.Json\" /\u003e\n    \u003cPackageReference Include=\"Serilog\" Version=\"3.1.1\" /\u003e\n  \u003c/ItemGroup\u003e\n\u003c/Project\u003e\n\"#;\n        let parser = CsharpParser::new();\n        let deps = parser.parse(content);\n\n        // Should only find Serilog (Newtonsoft.Json has no version)\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"Serilog\");\n    }\n\n    #[test]\n    fn test_multiple_item_groups() {\n        let content = r#\"\n\u003cProject Sdk=\"Microsoft.NET.Sdk\"\u003e\n  \u003cItemGroup\u003e\n    \u003cPackageReference Include=\"Package1\" Version=\"1.0.0\" /\u003e\n  \u003c/ItemGroup\u003e\n  \u003cItemGroup Condition=\"'$(Configuration)'=='Debug'\"\u003e\n    \u003cPackageReference Include=\"Package2\" Version=\"2.0.0\" /\u003e\n  \u003c/ItemGroup\u003e\n\u003c/Project\u003e\n\"#;\n        let parser = CsharpParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n    }\n}\n","traces":[{"line":16,"address":[14832608,14833315,14833309],"length":1,"stats":{"Line":2}},{"line":17,"address":[14455523],"length":1,"stats":{"Line":2}},{"line":19,"address":[14455555,14455603],"length":1,"stats":{"Line":6}},{"line":20,"address":[14455803],"length":1,"stats":{"Line":4}},{"line":21,"address":[14484738,14484812],"length":1,"stats":{"Line":6}},{"line":26,"address":[14527684],"length":1,"stats":{"Line":3}},{"line":27,"address":[14527734],"length":1,"stats":{"Line":3}},{"line":28,"address":[14833156],"length":1,"stats":{"Line":4}},{"line":30,"address":[14485084],"length":1,"stats":{"Line":5}},{"line":34,"address":[14832965],"length":1,"stats":{"Line":8}},{"line":39,"address":[14484268,14484274,14482000],"length":1,"stats":{"Line":3}},{"line":41,"address":[14453163,14453428],"length":1,"stats":{"Line":4}},{"line":42,"address":[14453322],"length":1,"stats":{"Line":3}},{"line":43,"address":[14522428,14522504],"length":1,"stats":{"Line":4}},{"line":44,"address":[14453492],"length":1,"stats":{"Line":4}},{"line":47,"address":[14830703],"length":1,"stats":{"Line":4}},{"line":48,"address":[14453830,14453724,14453601],"length":1,"stats":{"Line":6}},{"line":49,"address":[14522905,14522829],"length":1,"stats":{"Line":3}},{"line":50,"address":[14522944],"length":1,"stats":{"Line":3}},{"line":51,"address":[14482571,14482908],"length":1,"stats":{"Line":2}},{"line":53,"address":[14523116,14523216,14523049],"length":1,"stats":{"Line":0}},{"line":54,"address":[14483112,14483036],"length":1,"stats":{"Line":0}},{"line":55,"address":[14483149],"length":1,"stats":{"Line":0}},{"line":59,"address":[14831192],"length":1,"stats":{"Line":2}},{"line":63,"address":[14454305,14453937],"length":1,"stats":{"Line":8}},{"line":64,"address":[14831593,14831664,14832467],"length":1,"stats":{"Line":8}},{"line":65,"address":[14483531,14483592],"length":1,"stats":{"Line":4}},{"line":66,"address":[14454693,14454763,14454636],"length":1,"stats":{"Line":11}},{"line":68,"address":[14484226,14483662,14483719],"length":1,"stats":{"Line":12}},{"line":69,"address":[14524024,14523945],"length":1,"stats":{"Line":5}},{"line":71,"address":[14524116],"length":1,"stats":{"Line":7}},{"line":72,"address":[14454953],"length":1,"stats":{"Line":7}},{"line":73,"address":[14455040],"length":1,"stats":{"Line":5}}],"covered":30,"coverable":33},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","dart.rs"],"content":"//! Parser for Dart/Flutter pubspec.yaml files\n\nuse super::{Dependency, Parser};\n\n/// Parser for Dart pubspec.yaml dependency files\n#[derive(Debug, Default)]\npub struct DartParser;\n\nimpl DartParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for DartParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let mut dependencies = Vec::new();\n        let mut current_section: Option\u003cDependencySection\u003e = None;\n        let mut in_nested_block = false;\n\n        for (line_idx, line) in content.lines().enumerate() {\n            let line_num = line_idx as u32;\n            let trimmed = line.trim();\n\n            // Skip comments and empty lines\n            if trimmed.is_empty() || trimmed.starts_with('#') {\n                continue;\n            }\n\n            // Check for section headers (no indentation, ends with :)\n            if !line.starts_with(' ') \u0026\u0026 !line.starts_with('\\t') \u0026\u0026 trimmed.ends_with(':') {\n                let section_name = trimmed.trim_end_matches(':');\n                current_section = match section_name {\n                    \"dependencies\" =\u003e Some(DependencySection::Dependencies),\n                    \"dev_dependencies\" =\u003e Some(DependencySection::DevDependencies),\n                    \"dependency_overrides\" =\u003e Some(DependencySection::DependencyOverrides),\n                    _ =\u003e None,\n                };\n                in_nested_block = false;\n                continue;\n            }\n\n            // Only process if we're in a dependency section\n            let Some(section) = \u0026current_section else {\n                continue;\n            };\n\n            // Check if we're exiting the section (new top-level key)\n            if !line.starts_with(' ') \u0026\u0026 !line.starts_with('\\t') {\n                current_section = None;\n                continue;\n            }\n\n            // Skip if we're in a nested block (git, path, sdk dependencies)\n            if in_nested_block {\n                // Check if this line is less indented than before (exit nested)\n                let indent = line.len() - line.trim_start().len();\n                if indent \u003c= 2 {\n                    in_nested_block = false;\n                } else {\n                    continue;\n                }\n            }\n\n            // Parse dependency line\n            if let Some(dep) = parse_dart_dependency_line(line, line_num, section.is_dev()) {\n                // Check if this is a complex dependency (sdk, git, path)\n                if is_complex_dependency(trimmed) {\n                    in_nested_block = true;\n                    continue;\n                }\n\n                // Skip Flutter SDK dependencies\n                if is_flutter_sdk_dependency(\u0026dep.name) {\n                    continue;\n                }\n\n                dependencies.push(dep);\n            } else if trimmed.ends_with(':') \u0026\u0026 !trimmed.contains(' ') {\n                // This is a package name without version on same line\n                // Could be a complex dependency\n                in_nested_block = true;\n            }\n        }\n\n        dependencies\n    }\n}\n\n#[derive(Debug, Clone, Copy)]\nenum DependencySection {\n    Dependencies,\n    DevDependencies,\n    DependencyOverrides,\n}\n\nimpl DependencySection {\n    fn is_dev(\u0026self) -\u003e bool {\n        matches!(self, DependencySection::DevDependencies)\n    }\n}\n\n/// Parse a single dependency line in YAML format\nfn parse_dart_dependency_line(line: \u0026str, line_num: u32, dev: bool) -\u003e Option\u003cDependency\u003e {\n    let trimmed = line.trim();\n\n    // Skip if it doesn't contain a colon\n    if !trimmed.contains(':') {\n        return None;\n    }\n\n    let colon_pos = trimmed.find(':')?;\n    let name = trimmed[..colon_pos].trim();\n    let version_part = trimmed[colon_pos + 1..].trim();\n\n    // Skip if no version (could be a complex dependency)\n    if version_part.is_empty() {\n        return None;\n    }\n\n    // Skip if it's a complex dependency (starts with { or contains special keys)\n    if version_part.starts_with('{') || !version_part.starts_with('^') \u0026\u0026 version_part.contains(':')\n    {\n        return None;\n    }\n\n    // Clean the version (remove quotes if present)\n    let version = version_part\n        .trim_matches('\"')\n        .trim_matches('\\'')\n        .to_string();\n\n    // Skip if version is empty or looks like a path/git/sdk reference\n    if version.is_empty() || version.starts_with('/') || version.starts_with('.') {\n        return None;\n    }\n\n    // Calculate positions\n    let name_start = line.find(name)? as u32;\n    let name_end = name_start + name.len() as u32;\n    let version_start = line.find(\u0026version)? as u32;\n    let version_end = version_start + version.len() as u32;\n\n    Some(Dependency {\n        name: name.to_string(),\n        version,\n        line: line_num,\n        name_start,\n        name_end,\n        version_start,\n        version_end,\n        dev,\n        optional: false,\n    })\n}\n\n/// Check if a line indicates a complex dependency (git, path, sdk)\nfn is_complex_dependency(line: \u0026str) -\u003e bool {\n    let trimmed = line.trim();\n    trimmed.ends_with(':') \u0026\u0026 !trimmed.contains(' ')\n        || trimmed.contains(\"sdk:\")\n        || trimmed.contains(\"git:\")\n        || trimmed.contains(\"path:\")\n        || trimmed.contains(\"hosted:\")\n}\n\n/// Check if a package is a Flutter SDK dependency\nfn is_flutter_sdk_dependency(name: \u0026str) -\u003e bool {\n    matches!(\n        name,\n        \"flutter\"\n            | \"flutter_test\"\n            | \"flutter_localizations\"\n            | \"flutter_driver\"\n            | \"flutter_web_plugins\"\n    )\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_simple_dependencies() {\n        let content = r#\"\nname: my_app\nversion: 1.0.0\n\ndependencies:\n  http: ^1.0.0\n  provider: ^6.0.0\n\ndev_dependencies:\n  mockito: ^5.4.0\n\"#;\n        let parser = DartParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 3);\n\n        let http = deps.iter().find(|d| d.name == \"http\").unwrap();\n        assert_eq!(http.version, \"^1.0.0\");\n        assert!(!http.dev);\n\n        let mockito = deps.iter().find(|d| d.name == \"mockito\").unwrap();\n        assert!(mockito.dev);\n    }\n\n    #[test]\n    fn test_skip_flutter_sdk() {\n        let content = r#\"\ndependencies:\n  flutter:\n    sdk: flutter\n  http: ^1.0.0\n\ndev_dependencies:\n  flutter_test:\n    sdk: flutter\n  mockito: ^5.4.0\n\"#;\n        let parser = DartParser::new();\n        let deps = parser.parse(content);\n\n        // Should only find http and mockito, not flutter or flutter_test\n        assert_eq!(deps.len(), 2);\n        assert!(deps.iter().any(|d| d.name == \"http\"));\n        assert!(deps.iter().any(|d| d.name == \"mockito\"));\n        assert!(!deps.iter().any(|d| d.name == \"flutter\"));\n        assert!(!deps.iter().any(|d| d.name == \"flutter_test\"));\n    }\n\n    #[test]\n    fn test_skip_git_dependencies() {\n        let content = r#\"\ndependencies:\n  http: ^1.0.0\n  custom_pkg:\n    git:\n      url: https://github.com/user/repo.git\n      ref: main\n  provider: ^6.0.0\n\"#;\n        let parser = DartParser::new();\n        let deps = parser.parse(content);\n\n        // Should only find http and provider\n        assert_eq!(deps.len(), 2);\n        assert!(deps.iter().any(|d| d.name == \"http\"));\n        assert!(deps.iter().any(|d| d.name == \"provider\"));\n    }\n\n    #[test]\n    fn test_version_positions() {\n        let content = r#\"\ndependencies:\n  http: ^1.0.0\n\"#;\n        let parser = DartParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 1);\n        let http = \u0026deps[0];\n        assert_eq!(http.name, \"http\");\n        assert!(http.version_start \u003e http.name_end);\n    }\n\n    #[test]\n    fn test_quoted_versions() {\n        let content = r#\"\ndependencies:\n  http: \"^1.0.0\"\n  provider: '^6.0.0'\n\"#;\n        let parser = DartParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n        assert_eq!(deps[0].version, \"^1.0.0\");\n        assert_eq!(deps[1].version, \"^6.0.0\");\n    }\n\n    #[test]\n    fn test_dependency_overrides() {\n        let content = r#\"\ndependencies:\n  http: ^1.0.0\n\ndependency_overrides:\n  http: ^1.1.0\n\"#;\n        let parser = DartParser::new();\n        let deps = parser.parse(content);\n\n        // Should find both (override and regular)\n        assert_eq!(deps.len(), 2);\n    }\n}\n","traces":[{"line":16,"address":[13856560,13858560,13858478],"length":1,"stats":{"Line":2}},{"line":17,"address":[17186255],"length":1,"stats":{"Line":3}},{"line":18,"address":[13856664],"length":1,"stats":{"Line":5}},{"line":19,"address":[13856672],"length":1,"stats":{"Line":6}},{"line":21,"address":[13856739,13856688],"length":1,"stats":{"Line":12}},{"line":22,"address":[17186572],"length":1,"stats":{"Line":5}},{"line":23,"address":[17186677,17186579],"length":1,"stats":{"Line":12}},{"line":26,"address":[13838803],"length":1,"stats":{"Line":7}},{"line":31,"address":[13839006,13838900],"length":1,"stats":{"Line":10}},{"line":32,"address":[13857362],"length":1,"stats":{"Line":3}},{"line":33,"address":[13857587],"length":1,"stats":{"Line":5}},{"line":34,"address":[13857496,13857430],"length":1,"stats":{"Line":7}},{"line":35,"address":[13857473,13857549,13857510],"length":1,"stats":{"Line":7}},{"line":36,"address":[13857526,13857563,13857579],"length":1,"stats":{"Line":6}},{"line":37,"address":[17187193],"length":1,"stats":{"Line":0}},{"line":39,"address":[12956409],"length":1,"stats":{"Line":4}},{"line":44,"address":[12956446,12956062],"length":1,"stats":{"Line":7}},{"line":49,"address":[17187270,17187352],"length":1,"stats":{"Line":4}},{"line":50,"address":[17187358],"length":1,"stats":{"Line":0}},{"line":55,"address":[17187554,17187336],"length":1,"stats":{"Line":7}},{"line":57,"address":[13857902,13857785],"length":1,"stats":{"Line":2}},{"line":58,"address":[17187515],"length":1,"stats":{"Line":2}},{"line":59,"address":[13839634],"length":1,"stats":{"Line":2}},{"line":66,"address":[17187586,17187379,17188054],"length":1,"stats":{"Line":18}},{"line":68,"address":[13858221,13858126],"length":1,"stats":{"Line":8}},{"line":69,"address":[13858252],"length":1,"stats":{"Line":0}},{"line":74,"address":[12957083,12957043],"length":1,"stats":{"Line":17}},{"line":78,"address":[13858296],"length":1,"stats":{"Line":8}},{"line":79,"address":[13840200,13840155,13840267,13840123,13839865,13839888,13840142],"length":1,"stats":{"Line":16}},{"line":82,"address":[13858547],"length":1,"stats":{"Line":2}},{"line":86,"address":[17186618],"length":1,"stats":{"Line":3}},{"line":98,"address":[12952832],"length":1,"stats":{"Line":6}},{"line":99,"address":[12952837],"length":1,"stats":{"Line":4}},{"line":104,"address":[13837986,13837992,13836160],"length":1,"stats":{"Line":4}},{"line":105,"address":[13854558],"length":1,"stats":{"Line":6}},{"line":108,"address":[12953449],"length":1,"stats":{"Line":4}},{"line":109,"address":[13836336],"length":1,"stats":{"Line":0}},{"line":112,"address":[13836367,13836446],"length":1,"stats":{"Line":6}},{"line":113,"address":[17184013],"length":1,"stats":{"Line":4}},{"line":114,"address":[17184194,17184077],"length":1,"stats":{"Line":4}},{"line":117,"address":[13836664],"length":1,"stats":{"Line":5}},{"line":118,"address":[17184248],"length":1,"stats":{"Line":2}},{"line":122,"address":[12953898,12953957,12953839],"length":1,"stats":{"Line":9}},{"line":124,"address":[17184307],"length":1,"stats":{"Line":0}},{"line":134,"address":[17184578,17184434,17184499],"length":1,"stats":{"Line":10}},{"line":135,"address":[13855330],"length":1,"stats":{"Line":0}},{"line":139,"address":[13837207,13837984],"length":1,"stats":{"Line":4}},{"line":140,"address":[12954571,12954484],"length":1,"stats":{"Line":4}},{"line":141,"address":[12954601,12954554,12955078],"length":1,"stats":{"Line":9}},{"line":142,"address":[12954796,12954715],"length":1,"stats":{"Line":5}},{"line":144,"address":[17185289],"length":1,"stats":{"Line":5}},{"line":145,"address":[13837663],"length":1,"stats":{"Line":5}},{"line":146,"address":[17185241],"length":1,"stats":{"Line":5}},{"line":158,"address":[17183248],"length":1,"stats":{"Line":5}},{"line":159,"address":[12952878],"length":1,"stats":{"Line":5}},{"line":160,"address":[13854132,13854117,13854060],"length":1,"stats":{"Line":6}},{"line":161,"address":[13835796],"length":1,"stats":{"Line":3}},{"line":162,"address":[13854148],"length":1,"stats":{"Line":7}},{"line":163,"address":[13854179],"length":1,"stats":{"Line":3}},{"line":164,"address":[13835922],"length":1,"stats":{"Line":8}},{"line":168,"address":[13835968],"length":1,"stats":{"Line":10}},{"line":169,"address":[13836044],"length":1,"stats":{"Line":0}}],"covered":55,"coverable":62},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","go.rs"],"content":"//! Parser for Go module files (go.mod)\n\nuse super::{Dependency, Parser};\n\n/// Parser for Go go.mod dependency files\n#[derive(Debug, Default)]\npub struct GoParser;\n\nimpl GoParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for GoParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let mut dependencies = Vec::new();\n        let mut in_require_block = false;\n\n        for (line_idx, line) in content.lines().enumerate() {\n            let line_num = line_idx as u32;\n            let trimmed = line.trim();\n\n            // Skip empty lines and comments\n            if trimmed.is_empty() || trimmed.starts_with(\"//\") {\n                continue;\n            }\n\n            // Check for require block start\n            if trimmed == \"require (\" {\n                in_require_block = true;\n                continue;\n            }\n\n            // Check for block end\n            if trimmed == \")\" {\n                in_require_block = false;\n                continue;\n            }\n\n            // Parse single-line require: require github.com/pkg/errors v0.9.1\n            if trimmed.starts_with(\"require \") \u0026\u0026 !trimmed.contains(\"(\") {\n                let rest = \u0026trimmed[8..]; // Skip \"require \"\n                if let Some(dep) = parse_require_line(line, rest, line_num) {\n                    dependencies.push(dep);\n                }\n                continue;\n            }\n\n            // Parse lines inside require block\n            if in_require_block \u0026\u0026 let Some(dep) = parse_require_line(line, trimmed, line_num) {\n                dependencies.push(dep);\n            }\n        }\n\n        dependencies\n    }\n}\n\n/// Parse a require line (either standalone or inside a block)\n/// Format: module/path v1.2.3 [// indirect]\nfn parse_require_line(line: \u0026str, content: \u0026str, line_num: u32) -\u003e Option\u003cDependency\u003e {\n    let trimmed = content.trim();\n\n    // Skip empty lines, comments, and replace directives\n    if trimmed.is_empty() || trimmed.starts_with(\"//\") || trimmed.starts_with(\"replace\") {\n        return None;\n    }\n\n    // Remove inline comment (// indirect or other comments)\n    let is_indirect = trimmed.contains(\"// indirect\");\n    let without_comment = if let Some(pos) = trimmed.find(\"//\") {\n        trimmed[..pos].trim()\n    } else {\n        trimmed\n    };\n\n    // Split into module path and version\n    let parts: Vec\u003c\u0026str\u003e = without_comment.split_whitespace().collect();\n    if parts.len() \u003c 2 {\n        return None;\n    }\n\n    let module_path = parts[0];\n    let version = parts[1];\n\n    // Version must start with 'v'\n    if !version.starts_with('v') {\n        return None;\n    }\n\n    // Calculate positions in the original line\n    let name_start = line.find(module_path)? as u32;\n    let name_end = name_start + module_path.len() as u32;\n    let version_start = line.find(version)? as u32;\n    let version_end = version_start + version.len() as u32;\n\n    Some(Dependency {\n        name: module_path.to_string(),\n        version: version.to_string(),\n        line: line_num,\n        name_start,\n        name_end,\n        version_start,\n        version_end,\n        dev: false,\n        optional: is_indirect, // Mark indirect dependencies as optional\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_simple_require() {\n        let parser = GoParser::new();\n        let content = r#\"\nmodule example.com/mymodule\n\ngo 1.21\n\nrequire github.com/pkg/errors v0.9.1\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"github.com/pkg/errors\");\n        assert_eq!(deps[0].version, \"v0.9.1\");\n        assert!(!deps[0].optional);\n    }\n\n    #[test]\n    fn test_require_block() {\n        let parser = GoParser::new();\n        let content = r#\"\nmodule example.com/mymodule\n\ngo 1.21\n\nrequire (\n    github.com/gin-gonic/gin v1.9.1\n    golang.org/x/text v0.14.0\n)\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 2);\n\n        let gin = deps.iter().find(|d| d.name.contains(\"gin\")).unwrap();\n        assert_eq!(gin.version, \"v1.9.1\");\n\n        let text = deps.iter().find(|d| d.name.contains(\"text\")).unwrap();\n        assert_eq!(text.version, \"v0.14.0\");\n    }\n\n    #[test]\n    fn test_indirect_dependency() {\n        let parser = GoParser::new();\n        let content = r#\"\nrequire (\n    github.com/direct/dep v1.0.0\n    github.com/indirect/dep v2.0.0 // indirect\n)\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 2);\n\n        let direct = deps.iter().find(|d| d.name.contains(\"direct\")).unwrap();\n        assert!(!direct.optional);\n\n        let indirect = deps.iter().find(|d| d.name.contains(\"indirect\")).unwrap();\n        assert!(indirect.optional);\n    }\n\n    #[test]\n    fn test_multiple_require_blocks() {\n        let parser = GoParser::new();\n        let content = r#\"\nrequire (\n    github.com/pkg/a v1.0.0\n)\n\nrequire (\n    github.com/pkg/b v2.0.0\n)\n\nrequire github.com/pkg/c v3.0.0\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 3);\n    }\n\n    #[test]\n    fn test_version_position() {\n        let parser = GoParser::new();\n        let content = \"require github.com/pkg/errors v0.9.1\";\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n\n        let dep = \u0026deps[0];\n        // \"require \" is 8 chars (0-7)\n        // \"github.com/pkg/errors\" is 21 chars (8-28), so name_end = 29\n        // \" \" is at position 29\n        // \"v0.9.1\" is 6 chars (30-35), so version_end = 36\n        assert_eq!(dep.name_start, 8);\n        assert_eq!(dep.name_end, 29);\n        assert_eq!(dep.version_start, 30);\n        assert_eq!(dep.version_end, 36);\n    }\n\n    #[test]\n    fn test_skip_replace_directives() {\n        let parser = GoParser::new();\n        let content = r#\"\nrequire github.com/old/pkg v1.0.0\n\nreplace github.com/old/pkg =\u003e github.com/new/pkg v2.0.0\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"github.com/old/pkg\");\n    }\n}\n","traces":[{"line":16,"address":[18232976,18234173,18234179],"length":1,"stats":{"Line":2}},{"line":17,"address":[14451875],"length":1,"stats":{"Line":2}},{"line":18,"address":[14451899],"length":1,"stats":{"Line":2}},{"line":20,"address":[14451915,14451963],"length":1,"stats":{"Line":4}},{"line":21,"address":[14481091],"length":1,"stats":{"Line":2}},{"line":22,"address":[14481098,14481169],"length":1,"stats":{"Line":4}},{"line":25,"address":[14452257],"length":1,"stats":{"Line":2}},{"line":30,"address":[12980683],"length":1,"stats":{"Line":2}},{"line":31,"address":[14481353],"length":1,"stats":{"Line":2}},{"line":36,"address":[12980723,12980770],"length":1,"stats":{"Line":4}},{"line":37,"address":[12980819],"length":1,"stats":{"Line":3}},{"line":42,"address":[12980776,12980861,12980836],"length":1,"stats":{"Line":6}},{"line":43,"address":[14481514],"length":1,"stats":{"Line":2}},{"line":44,"address":[14452684],"length":1,"stats":{"Line":4}},{"line":45,"address":[14452812],"length":1,"stats":{"Line":4}},{"line":51,"address":[14481442,14481784],"length":1,"stats":{"Line":4}},{"line":52,"address":[12981345],"length":1,"stats":{"Line":4}},{"line":56,"address":[18233341],"length":1,"stats":{"Line":2}},{"line":62,"address":[14449920,14451684,14451700],"length":1,"stats":{"Line":3}},{"line":63,"address":[14450045],"length":1,"stats":{"Line":3}},{"line":66,"address":[18229736,18229827],"length":1,"stats":{"Line":5}},{"line":67,"address":[12978497],"length":1,"stats":{"Line":0}},{"line":71,"address":[14479145],"length":1,"stats":{"Line":2}},{"line":72,"address":[18229915],"length":1,"stats":{"Line":5}},{"line":73,"address":[14450347],"length":1,"stats":{"Line":2}},{"line":75,"address":[14450405],"length":1,"stats":{"Line":3}},{"line":79,"address":[18230069],"length":1,"stats":{"Line":6}},{"line":80,"address":[14450570,14450499],"length":1,"stats":{"Line":7}},{"line":81,"address":[14479550],"length":1,"stats":{"Line":0}},{"line":84,"address":[14479504,14479576],"length":1,"stats":{"Line":10}},{"line":85,"address":[14479615],"length":1,"stats":{"Line":6}},{"line":88,"address":[12979115],"length":1,"stats":{"Line":6}},{"line":89,"address":[14479733],"length":1,"stats":{"Line":0}},{"line":93,"address":[14450902,14450852,14451695],"length":1,"stats":{"Line":7}},{"line":94,"address":[18230668,18230761],"length":1,"stats":{"Line":6}},{"line":95,"address":[14451151,14451100,14451690],"length":1,"stats":{"Line":10}},{"line":96,"address":[18230988,18230907],"length":1,"stats":{"Line":4}},{"line":98,"address":[14480414],"length":1,"stats":{"Line":7}},{"line":99,"address":[14451333],"length":1,"stats":{"Line":7}},{"line":100,"address":[14451383],"length":1,"stats":{"Line":5}}],"covered":37,"coverable":40},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","mod.rs"],"content":"//! Parsers for dependency files (Cargo.toml, package.json, etc.)\n\nuse serde::{Deserialize, Serialize};\n\n/// Represents a dependency extracted from a manifest file\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Dependency {\n    /// Package name\n    pub name: String,\n    /// Version specifier (e.g., \"1.0.0\", \"^1.0\", \"\u003e=1,\u003c2\")\n    pub version: String,\n    /// Line number in the file (0-indexed)\n    pub line: u32,\n    /// Column where the package name starts\n    pub name_start: u32,\n    /// Column where the package name ends\n    pub name_end: u32,\n    /// Column where the version string starts\n    pub version_start: u32,\n    /// Column where the version string ends\n    pub version_end: u32,\n    /// Whether this is a dev dependency\n    pub dev: bool,\n    /// Whether this dependency is optional\n    pub optional: bool,\n}\n\n/// Trait for parsing dependency files\npub trait Parser: Send + Sync {\n    /// Parse the given file content and extract dependencies\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e;\n}\n\npub mod cargo;\npub mod csharp;\npub mod dart;\npub mod go;\npub mod npm;\npub mod php;\npub mod python;\npub mod ruby;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","npm.rs"],"content":"//! Parser for package.json files\n\nuse super::{Dependency, Parser};\n\n/// Parser for npm package.json dependency files\n#[derive(Debug, Default)]\npub struct NpmParser;\n\nimpl NpmParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for NpmParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let mut dependencies = Vec::new();\n\n        // Track which section we're in\n        let mut current_section: Option\u003cDependencyType\u003e = None;\n        let mut section_brace_depth = 0;\n        let mut in_section_object = false;\n\n        for (line_idx, line) in content.lines().enumerate() {\n            let line_num = line_idx as u32;\n            let trimmed = line.trim();\n\n            // Check for section headers first\n            if let Some(section) = detect_section(trimmed) {\n                current_section = Some(section);\n                // Count braces after the section name to determine if we're in the object\n                let section_start = if trimmed.contains(\"devDependencies\") {\n                    trimmed.find(\"devDependencies\").unwrap() + \"devDependencies\".len()\n                } else if trimmed.contains(\"peerDependencies\") {\n                    trimmed.find(\"peerDependencies\").unwrap() + \"peerDependencies\".len()\n                } else if trimmed.contains(\"optionalDependencies\") {\n                    trimmed.find(\"optionalDependencies\").unwrap() + \"optionalDependencies\".len()\n                } else if trimmed.contains(\"dependencies\") {\n                    trimmed.find(\"dependencies\").unwrap() + \"dependencies\".len()\n                } else {\n                    0\n                };\n\n                let after_section = \u0026trimmed[section_start..];\n                if after_section.contains('{') {\n                    in_section_object = true;\n                    section_brace_depth = 1;\n\n                    // Handle inline dependencies on the same line as section header\n                    // e.g., {\"dependencies\": {\"pkg\": \"1.0.0\"}}\n                    if let Some(brace_pos) = after_section.find('{') {\n                        let deps_content = \u0026after_section[brace_pos + 1..];\n                        // Try to parse dependencies from this content\n                        for dep in parse_inline_dependencies(deps_content, line_num, section) {\n                            dependencies.push(dep);\n                        }\n                    }\n                }\n                continue;\n            }\n\n            // If we're looking for the opening brace of a section\n            if current_section.is_some()\n                \u0026\u0026 !in_section_object\n                \u0026\u0026 (trimmed.starts_with('{') || trimmed == \"{\")\n            {\n                in_section_object = true;\n                section_brace_depth = 1;\n                continue;\n            }\n\n            // Track brace depth within section\n            if in_section_object {\n                for ch in trimmed.chars() {\n                    match ch {\n                        '{' =\u003e section_brace_depth += 1,\n                        '}' =\u003e {\n                            section_brace_depth -= 1;\n                            if section_brace_depth == 0 {\n                                current_section = None;\n                                in_section_object = false;\n                            }\n                        }\n                        _ =\u003e {}\n                    }\n                }\n            }\n\n            // Parse dependency lines within sections\n            if let Some(section) = current_section\n                \u0026\u0026 in_section_object\n                \u0026\u0026 let Some(dep) = parse_dependency_line(line, line_num, section)\n            {\n                dependencies.push(dep);\n            }\n        }\n\n        dependencies\n    }\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\nenum DependencyType {\n    Normal,\n    Dev,\n    Peer,\n    Optional,\n}\n\n/// Parse inline dependencies from a single line content\n/// e.g., \"pkg\": \"1.0.0\", \"pkg2\": \"2.0.0\"}}\nfn parse_inline_dependencies(\n    content: \u0026str,\n    line_num: u32,\n    dep_type: DependencyType,\n) -\u003e Vec\u003cDependency\u003e {\n    let mut deps = Vec::new();\n    let mut remaining = content;\n\n    while let Some(first_quote) = remaining.find('\"') {\n        let after_first = \u0026remaining[first_quote + 1..];\n        let Some(name_end) = after_first.find('\"') else {\n            break;\n        };\n        let name = \u0026after_first[..name_end];\n\n        // Skip if it looks like a section header or closing\n        if name.ends_with(\"ependencies\") || name.is_empty() {\n            remaining = \u0026after_first[name_end + 1..];\n            continue;\n        }\n\n        // Find colon and version\n        let after_name = \u0026after_first[name_end + 1..];\n        let Some(colon_pos) = after_name.find(':') else {\n            remaining = after_name;\n            continue;\n        };\n\n        let after_colon = \u0026after_name[colon_pos + 1..];\n        let Some(version_quote_start) = after_colon.find('\"') else {\n            remaining = after_colon;\n            continue;\n        };\n\n        let version_content = \u0026after_colon[version_quote_start + 1..];\n        let Some(version_end) = version_content.find('\"') else {\n            remaining = version_content;\n            continue;\n        };\n\n        let version = \u0026version_content[..version_end];\n\n        deps.push(Dependency {\n            name: name.to_string(),\n            version: version.to_string(),\n            line: line_num,\n            name_start: 0, // Approximate for inline\n            name_end: 0,\n            version_start: 0,\n            version_end: 0,\n            dev: dep_type == DependencyType::Dev,\n            optional: dep_type == DependencyType::Optional || dep_type == DependencyType::Peer,\n        });\n\n        remaining = \u0026version_content[version_end + 1..];\n    }\n\n    deps\n}\n\nfn detect_section(line: \u0026str) -\u003e Option\u003cDependencyType\u003e {\n    let line = line.trim();\n\n    if line.contains(\"\\\"dependencies\\\"\") \u0026\u0026 !line.contains(\"\\\"devDependencies\\\"\") {\n        Some(DependencyType::Normal)\n    } else if line.contains(\"\\\"devDependencies\\\"\") {\n        Some(DependencyType::Dev)\n    } else if line.contains(\"\\\"peerDependencies\\\"\") {\n        Some(DependencyType::Peer)\n    } else if line.contains(\"\\\"optionalDependencies\\\"\") {\n        Some(DependencyType::Optional)\n    } else {\n        None\n    }\n}\n\nfn parse_dependency_line(\n    line: \u0026str,\n    line_num: u32,\n    dep_type: DependencyType,\n) -\u003e Option\u003cDependency\u003e {\n    // Match pattern: \"package-name\": \"version\"\n    // Find the first quoted string (package name)\n    let first_quote = line.find('\"')?;\n    let after_first = \u0026line[first_quote + 1..];\n    let name_end = after_first.find('\"')?;\n    let name = \u0026after_first[..name_end];\n\n    // Skip if it looks like a section header\n    if name.ends_with(\"ependencies\") {\n        return None;\n    }\n\n    // Find the colon\n    let colon_pos = line.find(':')?;\n\n    // Find the version string (after the colon)\n    let after_colon = \u0026line[colon_pos + 1..];\n    let version_first_quote = after_colon.find('\"')?;\n    let version_start_in_after = version_first_quote + 1;\n    let after_version_quote = \u0026after_colon[version_start_in_after..];\n    let version_end_in_after = after_version_quote.find('\"')?;\n    let version = \u0026after_version_quote[..version_end_in_after];\n\n    // Calculate absolute positions\n    let name_start = (first_quote + 1) as u32;\n    let name_end_pos = name_start + name.len() as u32;\n\n    let version_abs_start = (colon_pos + 1 + version_start_in_after) as u32;\n    let version_abs_end = version_abs_start + version.len() as u32;\n\n    Some(Dependency {\n        name: name.to_string(),\n        version: version.to_string(),\n        line: line_num,\n        name_start,\n        name_end: name_end_pos,\n        version_start: version_abs_start,\n        version_end: version_abs_end,\n        dev: dep_type == DependencyType::Dev,\n        optional: dep_type == DependencyType::Optional || dep_type == DependencyType::Peer,\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_simple_dependencies() {\n        let parser = NpmParser::new();\n        let content = r#\"{\n  \"name\": \"my-app\",\n  \"dependencies\": {\n    \"react\": \"^18.2.0\",\n    \"lodash\": \"4.17.21\"\n  }\n}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 2);\n\n        let react = deps.iter().find(|d| d.name == \"react\").unwrap();\n        assert_eq!(react.version, \"^18.2.0\");\n        assert!(!react.dev);\n\n        let lodash = deps.iter().find(|d| d.name == \"lodash\").unwrap();\n        assert_eq!(lodash.version, \"4.17.21\");\n    }\n\n    #[test]\n    fn test_dev_dependencies() {\n        let parser = NpmParser::new();\n        let content = r#\"{\n  \"devDependencies\": {\n    \"typescript\": \"^5.0.0\",\n    \"jest\": \"^29.0.0\"\n  }\n}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 2);\n\n        for dep in \u0026deps {\n            assert!(dep.dev);\n        }\n    }\n\n    #[test]\n    fn test_multiple_sections() {\n        let parser = NpmParser::new();\n        let content = r#\"{\n  \"name\": \"test\",\n  \"dependencies\": {\n    \"express\": \"^4.18.0\"\n  },\n  \"devDependencies\": {\n    \"nodemon\": \"^3.0.0\"\n  },\n  \"peerDependencies\": {\n    \"react\": \"^18.0.0\"\n  }\n}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 3);\n\n        let express = deps.iter().find(|d| d.name == \"express\").unwrap();\n        assert!(!express.dev);\n        assert!(!express.optional);\n\n        let nodemon = deps.iter().find(|d| d.name == \"nodemon\").unwrap();\n        assert!(nodemon.dev);\n\n        let react = deps.iter().find(|d| d.name == \"react\").unwrap();\n        assert!(react.optional); // peer deps marked as optional\n    }\n\n    #[test]\n    fn test_scoped_packages() {\n        let parser = NpmParser::new();\n        let content = r#\"{\n  \"dependencies\": {\n    \"@types/node\": \"^20.0.0\",\n    \"@babel/core\": \"^7.22.0\"\n  }\n}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 2);\n\n        let types_node = deps.iter().find(|d| d.name == \"@types/node\").unwrap();\n        assert_eq!(types_node.version, \"^20.0.0\");\n\n        let babel = deps.iter().find(|d| d.name == \"@babel/core\").unwrap();\n        assert_eq!(babel.version, \"^7.22.0\");\n    }\n\n    #[test]\n    fn test_version_ranges() {\n        let parser = NpmParser::new();\n        let content = r#\"{\n  \"dependencies\": {\n    \"pkg1\": \"^1.0.0\",\n    \"pkg2\": \"~2.0.0\",\n    \"pkg3\": \"\u003e=3.0.0 \u003c4.0.0\",\n    \"pkg4\": \"1.0.0 - 2.0.0\",\n    \"pkg5\": \"*\"\n  }\n}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 5);\n\n        assert_eq!(\n            deps.iter().find(|d| d.name == \"pkg1\").unwrap().version,\n            \"^1.0.0\"\n        );\n        assert_eq!(\n            deps.iter().find(|d| d.name == \"pkg3\").unwrap().version,\n            \"\u003e=3.0.0 \u003c4.0.0\"\n        );\n        assert_eq!(deps.iter().find(|d| d.name == \"pkg5\").unwrap().version, \"*\");\n    }\n\n    #[test]\n    fn test_inline_format() {\n        let parser = NpmParser::new();\n        let content = r#\"{\"dependencies\": {\"pkg\": \"1.0.0\"}}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"pkg\");\n        assert_eq!(deps[0].version, \"1.0.0\");\n    }\n}\n","traces":[{"line":16,"address":[14686576,14689746,14688982],"length":1,"stats":{"Line":5}},{"line":17,"address":[14177935],"length":1,"stats":{"Line":5}},{"line":20,"address":[19939260],"length":1,"stats":{"Line":5}},{"line":21,"address":[14196264],"length":1,"stats":{"Line":5}},{"line":22,"address":[19939279],"length":1,"stats":{"Line":5}},{"line":24,"address":[14178003,14178054],"length":1,"stats":{"Line":12}},{"line":25,"address":[19939551],"length":1,"stats":{"Line":4}},{"line":26,"address":[19939558,19939656],"length":1,"stats":{"Line":13}},{"line":29,"address":[14196672],"length":1,"stats":{"Line":8}},{"line":30,"address":[14178476],"length":1,"stats":{"Line":4}},{"line":32,"address":[19939849,19939771,19940893],"length":1,"stats":{"Line":14}},{"line":33,"address":[14197793,14197902,14196905],"length":1,"stats":{"Line":6}},{"line":34,"address":[14196970,14197751,14196859],"length":1,"stats":{"Line":15}},{"line":35,"address":[19940752,19940018,19940643],"length":1,"stats":{"Line":6}},{"line":36,"address":[14688009,14687380,14687491],"length":1,"stats":{"Line":13}},{"line":37,"address":[14197139,14197501,14197610],"length":1,"stats":{"Line":0}},{"line":38,"address":[19940089,19940456,19940218,19940200],"length":1,"stats":{"Line":22}},{"line":39,"address":[19940352,19940220,19940461],"length":1,"stats":{"Line":14}},{"line":41,"address":[14178922],"length":1,"stats":{"Line":0}},{"line":44,"address":[14178991,14179651],"length":1,"stats":{"Line":11}},{"line":45,"address":[14688375],"length":1,"stats":{"Line":11}},{"line":46,"address":[14198020],"length":1,"stats":{"Line":5}},{"line":47,"address":[14198028],"length":1,"stats":{"Line":11}},{"line":51,"address":[14198039],"length":1,"stats":{"Line":5}},{"line":52,"address":[14688529],"length":1,"stats":{"Line":11}},{"line":54,"address":[14198246,14198427],"length":1,"stats":{"Line":14}},{"line":55,"address":[14180305,14180256],"length":1,"stats":{"Line":4}},{"line":63,"address":[14196817,14198611],"length":1,"stats":{"Line":14}},{"line":64,"address":[19941609],"length":1,"stats":{"Line":5}},{"line":65,"address":[14180459,14180355],"length":1,"stats":{"Line":0}},{"line":67,"address":[14180431],"length":1,"stats":{"Line":0}},{"line":68,"address":[14198727],"length":1,"stats":{"Line":0}},{"line":73,"address":[14198617],"length":1,"stats":{"Line":8}},{"line":74,"address":[14180504],"length":1,"stats":{"Line":9}},{"line":75,"address":[14689348],"length":1,"stats":{"Line":5}},{"line":76,"address":[14199265,14199221],"length":1,"stats":{"Line":0}},{"line":78,"address":[19942296,19942274,19942213],"length":1,"stats":{"Line":12}},{"line":79,"address":[14689689,14689741],"length":1,"stats":{"Line":12}},{"line":80,"address":[19942317],"length":1,"stats":{"Line":8}},{"line":81,"address":[19942325],"length":1,"stats":{"Line":4}},{"line":90,"address":[14198756,14198990],"length":1,"stats":{"Line":15}},{"line":91,"address":[14180720],"length":1,"stats":{"Line":5}},{"line":92,"address":[14689433],"length":1,"stats":{"Line":9}},{"line":94,"address":[14199189],"length":1,"stats":{"Line":8}},{"line":98,"address":[14178309],"length":1,"stats":{"Line":4}},{"line":112,"address":[19936384,19938704,19938812],"length":1,"stats":{"Line":11}},{"line":117,"address":[14175151],"length":1,"stats":{"Line":5}},{"line":118,"address":[14175181],"length":1,"stats":{"Line":11}},{"line":120,"address":[14175197,14177396,14175305],"length":1,"stats":{"Line":18}},{"line":121,"address":[19936658,19936795],"length":1,"stats":{"Line":4}},{"line":122,"address":[14175596],"length":1,"stats":{"Line":2}},{"line":125,"address":[14175718],"length":1,"stats":{"Line":2}},{"line":128,"address":[14194211,14194094],"length":1,"stats":{"Line":4}},{"line":129,"address":[14684602,14686142],"length":1,"stats":{"Line":0}},{"line":134,"address":[14194225],"length":1,"stats":{"Line":2}},{"line":135,"address":[14176090],"length":1,"stats":{"Line":2}},{"line":136,"address":[19937529],"length":1,"stats":{"Line":0}},{"line":137,"address":[14176238],"length":1,"stats":{"Line":0}},{"line":140,"address":[14194472,14194555],"length":1,"stats":{"Line":4}},{"line":141,"address":[14685091],"length":1,"stats":{"Line":2}},{"line":142,"address":[14176508],"length":1,"stats":{"Line":0}},{"line":143,"address":[19937831],"length":1,"stats":{"Line":0}},{"line":146,"address":[14685268,14685185],"length":1,"stats":{"Line":4}},{"line":147,"address":[19937957],"length":1,"stats":{"Line":2}},{"line":148,"address":[14685500],"length":1,"stats":{"Line":0}},{"line":152,"address":[14685547,14685462],"length":1,"stats":{"Line":4}},{"line":154,"address":[19938426],"length":1,"stats":{"Line":2}},{"line":155,"address":[14195152],"length":1,"stats":{"Line":2}},{"line":156,"address":[14685608],"length":1,"stats":{"Line":2}},{"line":162,"address":[19938263],"length":1,"stats":{"Line":2}},{"line":163,"address":[14177023],"length":1,"stats":{"Line":2}},{"line":166,"address":[14177289],"length":1,"stats":{"Line":2}},{"line":169,"address":[14193709],"length":1,"stats":{"Line":5}},{"line":172,"address":[14191280],"length":1,"stats":{"Line":6}},{"line":173,"address":[14173006],"length":1,"stats":{"Line":7}},{"line":175,"address":[19934412,19934348],"length":1,"stats":{"Line":11}},{"line":176,"address":[14173122],"length":1,"stats":{"Line":4}},{"line":177,"address":[14173067,14173174],"length":1,"stats":{"Line":9}},{"line":178,"address":[14173169],"length":1,"stats":{"Line":3}},{"line":179,"address":[14191502,14191433],"length":1,"stats":{"Line":11}},{"line":180,"address":[14681929],"length":1,"stats":{"Line":3}},{"line":181,"address":[14681905,14681941,14681948],"length":1,"stats":{"Line":12}},{"line":182,"address":[14173223],"length":1,"stats":{"Line":0}},{"line":184,"address":[19934528],"length":1,"stats":{"Line":8}},{"line":188,"address":[14191520,14193342,14193336],"length":1,"stats":{"Line":5}},{"line":195,"address":[14191621],"length":1,"stats":{"Line":9}},{"line":196,"address":[14191871,14191717],"length":1,"stats":{"Line":5}},{"line":197,"address":[19934915,19934839],"length":1,"stats":{"Line":9}},{"line":198,"address":[14191935],"length":1,"stats":{"Line":5}},{"line":201,"address":[14173698],"length":1,"stats":{"Line":9}},{"line":202,"address":[14192087],"length":1,"stats":{"Line":0}},{"line":206,"address":[14192113,14192024],"length":1,"stats":{"Line":5}},{"line":209,"address":[14173857,14174001],"length":1,"stats":{"Line":9}},{"line":210,"address":[14174022,14173946],"length":1,"stats":{"Line":5}},{"line":211,"address":[14174189,14174049],"length":1,"stats":{"Line":9}},{"line":212,"address":[19935397],"length":1,"stats":{"Line":5}},{"line":213,"address":[14682850,14682926],"length":1,"stats":{"Line":9}},{"line":214,"address":[14174247],"length":1,"stats":{"Line":5}},{"line":217,"address":[14174368,14174294],"length":1,"stats":{"Line":9}},{"line":218,"address":[14192704,14192631,14192678],"length":1,"stats":{"Line":12}},{"line":220,"address":[14174439,14174521,14174397],"length":1,"stats":{"Line":12}},{"line":221,"address":[14683325,14683269,14683211],"length":1,"stats":{"Line":12}},{"line":223,"address":[19936163],"length":1,"stats":{"Line":4}},{"line":224,"address":[14174561],"length":1,"stats":{"Line":4}},{"line":225,"address":[14174606],"length":1,"stats":{"Line":8}},{"line":231,"address":[14174667],"length":1,"stats":{"Line":4}},{"line":232,"address":[14174734],"length":1,"stats":{"Line":8}}],"covered":93,"coverable":107},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","php.rs"],"content":"//! Parser for PHP Composer files (composer.json)\n\nuse super::{Dependency, Parser};\n\n/// Parser for PHP composer.json dependency files\n#[derive(Debug, Default)]\npub struct PhpParser;\n\nimpl PhpParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for PhpParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let mut dependencies = Vec::new();\n        let mut current_section: Option\u003cDependencyType\u003e = None;\n        let mut section_brace_depth = 0;\n        let mut in_section_object = false;\n\n        for (line_idx, line) in content.lines().enumerate() {\n            let line_num = line_idx as u32;\n            let trimmed = line.trim();\n\n            // Detect section start\n            if let Some(section) = detect_section(trimmed) {\n                current_section = Some(section);\n                // Check if the object starts on the same line\n                if trimmed.contains('{') {\n                    in_section_object = true;\n                    section_brace_depth = 1;\n\n                    // Try to parse inline dependencies on the same line\n                    if let Some(brace_pos) = trimmed.find('{') {\n                        let after_brace = \u0026trimmed[brace_pos + 1..];\n                        if let Some(deps) =\n                            parse_inline_dependencies(after_brace, line_num, section, line)\n                        {\n                            dependencies.extend(deps);\n                        }\n                    }\n                }\n                continue;\n            }\n\n            // Track brace depth for current section\n            if in_section_object {\n                for ch in trimmed.chars() {\n                    match ch {\n                        '{' =\u003e section_brace_depth += 1,\n                        '}' =\u003e {\n                            section_brace_depth -= 1;\n                            if section_brace_depth == 0 {\n                                current_section = None;\n                                in_section_object = false;\n                            }\n                        }\n                        _ =\u003e {}\n                    }\n                }\n            }\n\n            // Skip if not in a dependency section\n            let dep_type = match current_section {\n                Some(dt) =\u003e dt,\n                None =\u003e continue,\n            };\n\n            // Parse dependency line\n            if let Some(dep) = parse_dependency_line(line, line_num, dep_type) {\n                dependencies.push(dep);\n            }\n        }\n\n        dependencies\n    }\n}\n\n#[derive(Debug, Clone, Copy, PartialEq)]\nenum DependencyType {\n    Normal,\n    Dev,\n}\n\n/// Detect which section we're entering\nfn detect_section(line: \u0026str) -\u003e Option\u003cDependencyType\u003e {\n    if line.contains(\"\\\"require\\\"\") \u0026\u0026 !line.contains(\"\\\"require-dev\\\"\") {\n        Some(DependencyType::Normal)\n    } else if line.contains(\"\\\"require-dev\\\"\") {\n        Some(DependencyType::Dev)\n    } else {\n        None\n    }\n}\n\n/// Parse inline dependencies (multiple on same line)\nfn parse_inline_dependencies(\n    content: \u0026str,\n    line_num: u32,\n    dep_type: DependencyType,\n    full_line: \u0026str,\n) -\u003e Option\u003cVec\u003cDependency\u003e\u003e {\n    let mut deps = Vec::new();\n\n    // Simple parsing for inline format: \"pkg\": \"^1.0\", \"pkg2\": \"^2.0\"\n    let parts: Vec\u003c\u0026str\u003e = content.split(',').collect();\n\n    for part in parts {\n        if let Some(dep) = parse_dependency_from_pair(part.trim(), line_num, dep_type, full_line) {\n            deps.push(dep);\n        }\n    }\n\n    if deps.is_empty() { None } else { Some(deps) }\n}\n\n/// Parse a single dependency line: \"vendor/package\": \"^1.0.0\"\nfn parse_dependency_line(\n    line: \u0026str,\n    line_num: u32,\n    dep_type: DependencyType,\n) -\u003e Option\u003cDependency\u003e {\n    let trimmed = line.trim();\n\n    // Must contain a colon (key: value)\n    if !trimmed.contains(':') {\n        return None;\n    }\n\n    parse_dependency_from_pair(trimmed, line_num, dep_type, line)\n}\n\n/// Parse a \"name\": \"version\" pair\nfn parse_dependency_from_pair(\n    pair: \u0026str,\n    line_num: u32,\n    dep_type: DependencyType,\n    full_line: \u0026str,\n) -\u003e Option\u003cDependency\u003e {\n    // Find the colon separator\n    let colon_pos = pair.find(':')?;\n\n    let name_part = \u0026pair[..colon_pos];\n    let version_part = \u0026pair[colon_pos + 1..];\n\n    // Extract name from quotes\n    let name = extract_quoted_string(name_part)?;\n\n    // Skip PHP extensions and PHP itself\n    if name == \"php\" || name.starts_with(\"ext-\") {\n        return None;\n    }\n\n    // Extract version from quotes\n    let version = extract_quoted_string(version_part)?;\n\n    // Calculate positions in the original line\n    let name_start = full_line.find(\u0026name)? as u32;\n    let name_end = name_start + name.len() as u32;\n    let version_start = full_line.rfind(\u0026version)? as u32;\n    let version_end = version_start + version.len() as u32;\n\n    Some(Dependency {\n        name,\n        version,\n        line: line_num,\n        name_start,\n        name_end,\n        version_start,\n        version_end,\n        dev: dep_type == DependencyType::Dev,\n        optional: false,\n    })\n}\n\n/// Extract a string value from a quoted string\nfn extract_quoted_string(s: \u0026str) -\u003e Option\u003cString\u003e {\n    let trimmed = s.trim();\n\n    // Find the first quote\n    let start_quote = trimmed.find('\"')?;\n    let after_quote = \u0026trimmed[start_quote + 1..];\n\n    // Find the closing quote\n    let end_quote = after_quote.find('\"')?;\n\n    Some(after_quote[..end_quote].to_string())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_simple_dependencies() {\n        let parser = PhpParser::new();\n        let content = r#\"\n{\n    \"name\": \"myproject\",\n    \"require\": {\n        \"php\": \"\u003e=8.1\",\n        \"laravel/framework\": \"^10.0\",\n        \"guzzlehttp/guzzle\": \"^7.0\"\n    }\n}\n\"#;\n        let deps = parser.parse(content);\n        // Should have laravel and guzzle, not php\n        assert_eq!(deps.len(), 2);\n\n        let laravel = deps.iter().find(|d| d.name.contains(\"laravel\")).unwrap();\n        assert_eq!(laravel.version, \"^10.0\");\n        assert!(!laravel.dev);\n    }\n\n    #[test]\n    fn test_dev_dependencies() {\n        let parser = PhpParser::new();\n        let content = r#\"\n{\n    \"require\": {\n        \"laravel/framework\": \"^10.0\"\n    },\n    \"require-dev\": {\n        \"phpunit/phpunit\": \"^10.0\",\n        \"mockery/mockery\": \"^1.5\"\n    }\n}\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 3);\n\n        let laravel = deps.iter().find(|d| d.name.contains(\"laravel\")).unwrap();\n        assert!(!laravel.dev);\n\n        let phpunit = deps.iter().find(|d| d.name.contains(\"phpunit\")).unwrap();\n        assert!(phpunit.dev);\n\n        let mockery = deps.iter().find(|d| d.name.contains(\"mockery\")).unwrap();\n        assert!(mockery.dev);\n    }\n\n    #[test]\n    fn test_skip_extensions() {\n        let parser = PhpParser::new();\n        let content = r#\"\n{\n    \"require\": {\n        \"php\": \"\u003e=8.1\",\n        \"ext-json\": \"*\",\n        \"ext-mbstring\": \"*\",\n        \"laravel/framework\": \"^10.0\"\n    }\n}\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"laravel/framework\");\n    }\n\n    #[test]\n    fn test_version_constraints() {\n        let parser = PhpParser::new();\n        let content = r#\"\n{\n    \"require\": {\n        \"vendor/exact\": \"1.0.0\",\n        \"vendor/caret\": \"^1.0\",\n        \"vendor/tilde\": \"~1.0\",\n        \"vendor/range\": \"\u003e=1.0 \u003c2.0\"\n    }\n}\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 4);\n\n        let exact = deps.iter().find(|d| d.name.contains(\"exact\")).unwrap();\n        assert_eq!(exact.version, \"1.0.0\");\n\n        let caret = deps.iter().find(|d| d.name.contains(\"caret\")).unwrap();\n        assert_eq!(caret.version, \"^1.0\");\n    }\n\n    #[test]\n    fn test_version_position() {\n        let parser = PhpParser::new();\n        let content = r#\"{\n    \"require\": {\n        \"vendor/pkg\": \"^1.0.0\"\n    }\n}\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n\n        let dep = \u0026deps[0];\n        assert_eq!(dep.name, \"vendor/pkg\");\n        assert_eq!(dep.version, \"^1.0.0\");\n    }\n}\n","traces":[{"line":16,"address":[19294787,19294781,19293168],"length":1,"stats":{"Line":4}},{"line":17,"address":[13764815],"length":1,"stats":{"Line":3}},{"line":18,"address":[13793776],"length":1,"stats":{"Line":4}},{"line":19,"address":[12564212],"length":1,"stats":{"Line":3}},{"line":20,"address":[19293279],"length":1,"stats":{"Line":4}},{"line":22,"address":[12564286,12564239],"length":1,"stats":{"Line":6}},{"line":23,"address":[19293551],"length":1,"stats":{"Line":2}},{"line":24,"address":[19293558,19293656],"length":1,"stats":{"Line":7}},{"line":27,"address":[19293688],"length":1,"stats":{"Line":5}},{"line":28,"address":[12564709],"length":1,"stats":{"Line":5}},{"line":30,"address":[13765407,13765364],"length":1,"stats":{"Line":10}},{"line":31,"address":[13765426],"length":1,"stats":{"Line":5}},{"line":32,"address":[12564786],"length":1,"stats":{"Line":5}},{"line":35,"address":[13794373],"length":1,"stats":{"Line":5}},{"line":36,"address":[19293939],"length":1,"stats":{"Line":5}},{"line":37,"address":[12565016],"length":1,"stats":{"Line":2}},{"line":40,"address":[19294190],"length":1,"stats":{"Line":0}},{"line":48,"address":[19293792],"length":1,"stats":{"Line":5}},{"line":49,"address":[13765844],"length":1,"stats":{"Line":5}},{"line":50,"address":[19294404],"length":1,"stats":{"Line":5}},{"line":51,"address":[19294680,19294636],"length":1,"stats":{"Line":0}},{"line":53,"address":[13766339,13766256,13766317],"length":1,"stats":{"Line":10}},{"line":54,"address":[19294776,19294724],"length":1,"stats":{"Line":10}},{"line":55,"address":[13795288],"length":1,"stats":{"Line":8}},{"line":56,"address":[13766368],"length":1,"stats":{"Line":2}},{"line":65,"address":[13794726],"length":1,"stats":{"Line":5}},{"line":66,"address":[19294453],"length":1,"stats":{"Line":5}},{"line":71,"address":[19294480],"length":1,"stats":{"Line":5}},{"line":72,"address":[13766204],"length":1,"stats":{"Line":8}},{"line":76,"address":[19293597],"length":1,"stats":{"Line":2}},{"line":87,"address":[12560080],"length":1,"stats":{"Line":5}},{"line":88,"address":[19289015,19288951],"length":1,"stats":{"Line":10}},{"line":89,"address":[13760797],"length":1,"stats":{"Line":5}},{"line":90,"address":[13760742,13760823,13760816],"length":1,"stats":{"Line":12}},{"line":91,"address":[13789746],"length":1,"stats":{"Line":2}},{"line":93,"address":[13789739],"length":1,"stats":{"Line":5}},{"line":98,"address":[13762405,13762399,13761456],"length":1,"stats":{"Line":8}},{"line":104,"address":[12560976],"length":1,"stats":{"Line":2}},{"line":107,"address":[19289860,19289921],"length":1,"stats":{"Line":10}},{"line":109,"address":[12561274,12561100],"length":1,"stats":{"Line":10}},{"line":110,"address":[13762220,13761969],"length":1,"stats":{"Line":10}},{"line":111,"address":[19290610],"length":1,"stats":{"Line":0}},{"line":115,"address":[13790936],"length":1,"stats":{"Line":8}},{"line":119,"address":[12560640],"length":1,"stats":{"Line":5}},{"line":124,"address":[19289559],"length":1,"stats":{"Line":5}},{"line":127,"address":[12560742],"length":1,"stats":{"Line":5}},{"line":128,"address":[13761370],"length":1,"stats":{"Line":0}},{"line":131,"address":[19289658],"length":1,"stats":{"Line":5}},{"line":135,"address":[19290656,19292535,19292644],"length":1,"stats":{"Line":8}},{"line":142,"address":[12561952],"length":1,"stats":{"Line":2}},{"line":144,"address":[13791632],"length":1,"stats":{"Line":5}},{"line":145,"address":[12562132,12562321],"length":1,"stats":{"Line":5}},{"line":148,"address":[12562342,12562247],"length":1,"stats":{"Line":5}},{"line":151,"address":[13792055,13791978,13792128],"length":1,"stats":{"Line":16}},{"line":152,"address":[19291391],"length":1,"stats":{"Line":3}},{"line":156,"address":[12562635,12563770],"length":1,"stats":{"Line":2}},{"line":159,"address":[12563736,12562888,12562820],"length":1,"stats":{"Line":10}},{"line":160,"address":[13792568,13792659],"length":1,"stats":{"Line":8}},{"line":161,"address":[19291920,19292563,19291967],"length":1,"stats":{"Line":10}},{"line":162,"address":[13792959,13792807],"length":1,"stats":{"Line":2}},{"line":164,"address":[13793061],"length":1,"stats":{"Line":2}},{"line":165,"address":[12563279],"length":1,"stats":{"Line":8}},{"line":166,"address":[13763965],"length":1,"stats":{"Line":2}},{"line":172,"address":[13792933],"length":1,"stats":{"Line":8}},{"line":178,"address":[19289072],"length":1,"stats":{"Line":5}},{"line":179,"address":[19289131],"length":1,"stats":{"Line":5}},{"line":182,"address":[19289168],"length":1,"stats":{"Line":5}},{"line":183,"address":[13790051,13789929],"length":1,"stats":{"Line":5}},{"line":186,"address":[13761141,13761077],"length":1,"stats":{"Line":5}},{"line":188,"address":[13761171],"length":1,"stats":{"Line":5}}],"covered":66,"coverable":70},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","python.rs"],"content":"//! Parser for Python dependency files (requirements.txt, pyproject.toml)\n\nuse super::{Dependency, Parser};\n\n/// Parser for Python dependency files\n#[derive(Debug, Default)]\npub struct PythonParser;\n\nimpl PythonParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for PythonParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        // Detect file type based on content\n        if content.trim_start().starts_with('[')\n            || content.contains(\"[project]\")\n            || content.contains(\"[tool.poetry\")\n        {\n            parse_pyproject_toml(content)\n        } else {\n            parse_requirements_txt(content)\n        }\n    }\n}\n\n/// Parse requirements.txt format\n/// Format: package==1.0.0, package\u003e=1.0.0, package~=1.0.0, etc.\nfn parse_requirements_txt(content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n    let mut dependencies = Vec::new();\n\n    for (line_idx, line) in content.lines().enumerate() {\n        let line_num = line_idx as u32;\n        let trimmed = line.trim();\n\n        // Skip empty lines, comments, and special directives\n        if trimmed.is_empty()\n            || trimmed.starts_with('#')\n            || trimmed.starts_with('-')  // -r, -e, -c, etc.\n            || trimmed.starts_with(\"--\")\n        // --index-url, etc.\n        {\n            continue;\n        }\n\n        // Skip URL dependencies (package @ https://...)\n        if trimmed.contains(\" @ \") {\n            continue;\n        }\n\n        if let Some(dep) = parse_requirement_line(line, line_num, false) {\n            dependencies.push(dep);\n        }\n    }\n\n    dependencies\n}\n\n/// Parse a single requirement line\nfn parse_requirement_line(line: \u0026str, line_num: u32, dev: bool) -\u003e Option\u003cDependency\u003e {\n    let trimmed = line.trim();\n\n    // Remove inline comments\n    let without_comment = if let Some(pos) = trimmed.find('#') {\n        \u0026trimmed[..pos]\n    } else {\n        trimmed\n    };\n    let without_comment = without_comment.trim();\n\n    if without_comment.is_empty() {\n        return None;\n    }\n\n    // Extract package name (before version specifier or extras)\n    // Operators: ==, \u003e=, \u003c=, !=, ~=, \u003e, \u003c, ===\n    let operators = [\"===\", \"==\", \"\u003e=\", \"\u003c=\", \"!=\", \"~=\", \"\u003e\", \"\u003c\"];\n\n    let mut name_end_pos = without_comment.len();\n    let mut version_op_pos = None;\n    let mut version_op_len = 0;\n\n    for op in \u0026operators {\n        if let Some(pos) = without_comment.find(op)\n            \u0026\u0026 pos \u003c name_end_pos\n        {\n            name_end_pos = pos;\n            version_op_pos = Some(pos);\n            version_op_len = op.len();\n        }\n    }\n\n    // Handle extras: package[extra1,extra2]\u003e=1.0\n    let name_part = \u0026without_comment[..name_end_pos];\n    let name = if let Some(bracket_pos) = name_part.find('[') {\n        \u0026name_part[..bracket_pos]\n    } else {\n        name_part\n    };\n    let name = name.trim();\n\n    if name.is_empty() {\n        return None;\n    }\n\n    // Extract version\n    let version = if let Some(op_pos) = version_op_pos {\n        let version_part = \u0026without_comment[op_pos + version_op_len..];\n        // Handle comma-separated version constraints: \u003e=1.0,\u003c2.0\n        let version = if let Some(comma_pos) = version_part.find(',') {\n            \u0026version_part[..comma_pos]\n        } else {\n            version_part\n        };\n        // Remove environment markers: ; python_version \u003e= \"3.8\"\n        let version = if let Some(semi_pos) = version.find(';') {\n            \u0026version[..semi_pos]\n        } else {\n            version\n        };\n        version.trim().to_string()\n    } else {\n        // No version specified\n        return None;\n    };\n\n    if version.is_empty() {\n        return None;\n    }\n\n    // Calculate positions\n    let name_start = line.find(name)? as u32;\n    let name_end = name_start + name.len() as u32;\n\n    // Find version position in the original line\n    let version_start = line.find(\u0026version)? as u32;\n    let version_end = version_start + version.len() as u32;\n\n    Some(Dependency {\n        name: name.to_string(),\n        version,\n        line: line_num,\n        name_start,\n        name_end,\n        version_start,\n        version_end,\n        dev,\n        optional: false,\n    })\n}\n\n/// Parse pyproject.toml format (PEP 621 + Poetry)\nfn parse_pyproject_toml(content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n    let mut dependencies = Vec::new();\n\n    // Parse using toml crate for structure, but we need line positions\n    // So we'll do a hybrid approach: parse TOML for structure, then find positions manually\n\n    let table: toml::Table = match content.parse() {\n        Ok(t) =\u003e t,\n        Err(_) =\u003e return dependencies,\n    };\n\n    // PEP 621: [project.dependencies] array of strings\n    if let Some(project) = table.get(\"project\").and_then(|v| v.as_table()) {\n        // [project.dependencies]\n        if let Some(deps) = project.get(\"dependencies\").and_then(|v| v.as_array()) {\n            for dep_str in deps.iter().filter_map(|v| v.as_str()) {\n                if let Some((name, version)) = parse_pep508_dependency(dep_str)\n                    \u0026\u0026 let Some(dep) = find_dependency_position(content, \u0026name, \u0026version, false)\n                {\n                    dependencies.push(dep);\n                }\n            }\n        }\n\n        // [project.optional-dependencies]\n        if let Some(optional_deps) = project\n            .get(\"optional-dependencies\")\n            .and_then(|v| v.as_table())\n        {\n            for (_group, deps) in optional_deps {\n                if let Some(deps_array) = deps.as_array() {\n                    for dep_str in deps_array.iter().filter_map(|v| v.as_str()) {\n                        if let Some((name, version)) = parse_pep508_dependency(dep_str)\n                            \u0026\u0026 let Some(dep) =\n                                find_dependency_position(content, \u0026name, \u0026version, true)\n                        {\n                            dependencies.push(dep);\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    // Poetry: [tool.poetry.dependencies] table\n    if let Some(tool) = table.get(\"tool\").and_then(|v| v.as_table())\n        \u0026\u0026 let Some(poetry) = tool.get(\"poetry\").and_then(|v| v.as_table())\n    {\n        // [tool.poetry.dependencies]\n        if let Some(deps) = poetry.get(\"dependencies\").and_then(|v| v.as_table()) {\n            for (name, value) in deps {\n                // Skip python itself\n                if name == \"python\" {\n                    continue;\n                }\n                if let Some(version) = extract_poetry_version(value)\n                    \u0026\u0026 let Some(dep) =\n                        find_poetry_dependency_position(content, name, \u0026version, false)\n                {\n                    dependencies.push(dep);\n                }\n            }\n        }\n\n        // [tool.poetry.dev-dependencies] (Poetry \u003c 1.2)\n        if let Some(deps) = poetry.get(\"dev-dependencies\").and_then(|v| v.as_table()) {\n            for (name, value) in deps {\n                if let Some(version) = extract_poetry_version(value)\n                    \u0026\u0026 let Some(dep) =\n                        find_poetry_dependency_position(content, name, \u0026version, true)\n                {\n                    dependencies.push(dep);\n                }\n            }\n        }\n\n        // [tool.poetry.group.dev.dependencies] (Poetry \u003e= 1.2)\n        if let Some(groups) = poetry.get(\"group\").and_then(|v| v.as_table()) {\n            for (group_name, group_value) in groups {\n                let is_dev = group_name == \"dev\" || group_name == \"test\";\n                if let Some(group_table) = group_value.as_table()\n                    \u0026\u0026 let Some(deps) = group_table.get(\"dependencies\").and_then(|v| v.as_table())\n                {\n                    for (name, value) in deps {\n                        if let Some(version) = extract_poetry_version(value)\n                            \u0026\u0026 let Some(dep) =\n                                find_poetry_dependency_position(content, name, \u0026version, is_dev)\n                        {\n                            dependencies.push(dep);\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    dependencies\n}\n\n/// Parse PEP 508 dependency string: \"package\u003e=1.0.0\" or \"package[extra]\u003e=1.0.0\"\nfn parse_pep508_dependency(dep_str: \u0026str) -\u003e Option\u003c(String, String)\u003e {\n    let trimmed = dep_str.trim();\n\n    // Remove environment markers\n    let without_markers = if let Some(semi_pos) = trimmed.find(';') {\n        \u0026trimmed[..semi_pos]\n    } else {\n        trimmed\n    };\n    let without_markers = without_markers.trim();\n\n    // Find version operator\n    let operators = [\"===\", \"==\", \"\u003e=\", \"\u003c=\", \"!=\", \"~=\", \"\u003e\", \"\u003c\"];\n    let mut op_pos = None;\n    let mut op_len = 0;\n\n    for op in \u0026operators {\n        if let Some(pos) = without_markers.find(op)\n            \u0026\u0026 (op_pos.is_none() || pos \u003c op_pos.unwrap())\n        {\n            op_pos = Some(pos);\n            op_len = op.len();\n        }\n    }\n\n    let op_pos = op_pos?;\n\n    // Extract name (handle extras)\n    let name_part = \u0026without_markers[..op_pos];\n    let name = if let Some(bracket_pos) = name_part.find('[') {\n        \u0026name_part[..bracket_pos]\n    } else {\n        name_part\n    };\n    let name = name.trim();\n\n    // Extract version\n    let version_part = \u0026without_markers[op_pos + op_len..];\n    let version = if let Some(comma_pos) = version_part.find(',') {\n        \u0026version_part[..comma_pos]\n    } else {\n        version_part\n    };\n    let version = version.trim();\n\n    if name.is_empty() || version.is_empty() {\n        return None;\n    }\n\n    Some((name.to_string(), version.to_string()))\n}\n\n/// Extract version from Poetry dependency value\nfn extract_poetry_version(value: \u0026toml::Value) -\u003e Option\u003cString\u003e {\n    match value {\n        toml::Value::String(s) =\u003e Some(s.clone()),\n        toml::Value::Table(t) =\u003e t\n            .get(\"version\")\n            .and_then(|v| v.as_str())\n            .map(|s| s.to_string()),\n        _ =\u003e None,\n    }\n}\n\n/// Find position of a dependency in PEP 621 format (array of strings)\nfn find_dependency_position(\n    content: \u0026str,\n    name: \u0026str,\n    version: \u0026str,\n    dev: bool,\n) -\u003e Option\u003cDependency\u003e {\n    for (line_idx, line) in content.lines().enumerate() {\n        // Look for the dependency string in an array\n        if line.contains(name) \u0026\u0026 line.contains(version) {\n            // Check it's likely a dependency line (contains quotes and version operator)\n            if line.contains('\"') || line.contains('\\'') {\n                let line_num = line_idx as u32;\n\n                // Find name position\n                let name_start = line.find(name)? as u32;\n                let name_end = name_start + name.len() as u32;\n\n                // Find version position\n                let version_start = line.find(version)? as u32;\n                let version_end = version_start + version.len() as u32;\n\n                return Some(Dependency {\n                    name: name.to_string(),\n                    version: version.to_string(),\n                    line: line_num,\n                    name_start,\n                    name_end,\n                    version_start,\n                    version_end,\n                    dev,\n                    optional: dev, // optional-dependencies are optional\n                });\n            }\n        }\n    }\n    None\n}\n\n/// Find position of a Poetry dependency (table format)\nfn find_poetry_dependency_position(\n    content: \u0026str,\n    name: \u0026str,\n    version: \u0026str,\n    dev: bool,\n) -\u003e Option\u003cDependency\u003e {\n    for (line_idx, line) in content.lines().enumerate() {\n        let trimmed = line.trim();\n\n        // Poetry format: name = \"version\" or name = { version = \"...\" }\n        if trimmed.starts_with(name) \u0026\u0026 trimmed.contains('=') {\n            // Check this line contains the version\n            if line.contains(version) {\n                let line_num = line_idx as u32;\n\n                // Find name position\n                let name_start = line.find(name)? as u32;\n                let name_end = name_start + name.len() as u32;\n\n                // Find version position (inside quotes)\n                let version_start = line.find(version)? as u32;\n                let version_end = version_start + version.len() as u32;\n\n                return Some(Dependency {\n                    name: name.to_string(),\n                    version: version.to_string(),\n                    line: line_num,\n                    name_start,\n                    name_end,\n                    version_start,\n                    version_end,\n                    dev,\n                    optional: false,\n                });\n            }\n        }\n    }\n    None\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_requirements_simple() {\n        let parser = PythonParser::new();\n        let content = r#\"\nflask==2.0.0\nrequests\u003e=2.25.0\ndjango~=4.0\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 3);\n\n        let flask = deps.iter().find(|d| d.name == \"flask\").unwrap();\n        assert_eq!(flask.version, \"2.0.0\");\n\n        let requests = deps.iter().find(|d| d.name == \"requests\").unwrap();\n        assert_eq!(requests.version, \"2.25.0\");\n\n        let django = deps.iter().find(|d| d.name == \"django\").unwrap();\n        assert_eq!(django.version, \"4.0\");\n    }\n\n    #[test]\n    fn test_requirements_with_extras() {\n        let parser = PythonParser::new();\n        let content = \"uvicorn[standard]\u003e=0.20.0\";\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"uvicorn\");\n        assert_eq!(deps[0].version, \"0.20.0\");\n    }\n\n    #[test]\n    fn test_requirements_with_comments() {\n        let parser = PythonParser::new();\n        let content = r#\"\n# This is a comment\nflask==2.0.0  # inline comment\n# Another comment\nrequests\u003e=2.25.0\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 2);\n    }\n\n    #[test]\n    fn test_requirements_skip_special() {\n        let parser = PythonParser::new();\n        let content = r#\"\n-r other.txt\n-e git+https://github.com/user/repo.git\n--index-url https://pypi.org/simple\nflask==2.0.0\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"flask\");\n    }\n\n    #[test]\n    fn test_pyproject_pep621() {\n        let parser = PythonParser::new();\n        let content = r#\"\n[project]\nname = \"myproject\"\ndependencies = [\n    \"flask\u003e=2.0.0\",\n    \"requests~=2.25.0\",\n]\n\n[project.optional-dependencies]\ndev = [\n    \"pytest\u003e=7.0.0\",\n]\n\"#;\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 3);\n\n        let flask = deps.iter().find(|d| d.name == \"flask\").unwrap();\n        assert_eq!(flask.version, \"2.0.0\");\n        assert!(!flask.dev);\n\n        let pytest = deps.iter().find(|d| d.name == \"pytest\").unwrap();\n        assert_eq!(pytest.version, \"7.0.0\");\n        assert!(pytest.dev);\n    }\n\n    #[test]\n    fn test_pyproject_poetry() {\n        let parser = PythonParser::new();\n        let content = r#\"\n[tool.poetry]\nname = \"myproject\"\n\n[tool.poetry.dependencies]\npython = \"^3.9\"\nflask = \"^2.0.0\"\nrequests = { version = \"^2.25.0\", optional = true }\n\n[tool.poetry.dev-dependencies]\npytest = \"^7.0.0\"\n\"#;\n        let deps = parser.parse(content);\n        // Should have flask, requests, pytest (python is skipped)\n        assert_eq!(deps.len(), 3);\n\n        let flask = deps.iter().find(|d| d.name == \"flask\").unwrap();\n        assert_eq!(flask.version, \"^2.0.0\");\n        assert!(!flask.dev);\n\n        let pytest = deps.iter().find(|d| d.name == \"pytest\").unwrap();\n        assert_eq!(pytest.version, \"^7.0.0\");\n        assert!(pytest.dev);\n    }\n\n    #[test]\n    fn test_version_position() {\n        let parser = PythonParser::new();\n        let content = \"flask==2.0.0\";\n        let deps = parser.parse(content);\n        assert_eq!(deps.len(), 1);\n\n        let dep = \u0026deps[0];\n        assert_eq!(dep.name_start, 0);\n        assert_eq!(dep.name_end, 5);\n        assert_eq!(dep.version_start, 7);\n        assert_eq!(dep.version_end, 12);\n    }\n}\n","traces":[{"line":16,"address":[14478640],"length":1,"stats":{"Line":2}},{"line":18,"address":[14449765],"length":1,"stats":{"Line":2}},{"line":19,"address":[14449800],"length":1,"stats":{"Line":6}},{"line":20,"address":[14449854],"length":1,"stats":{"Line":8}},{"line":22,"address":[19036142],"length":1,"stats":{"Line":2}},{"line":24,"address":[14449890],"length":1,"stats":{"Line":8}},{"line":31,"address":[14444672,14445511,14445505],"length":1,"stats":{"Line":8}},{"line":32,"address":[14444715],"length":1,"stats":{"Line":8}},{"line":34,"address":[19031063,19031107],"length":1,"stats":{"Line":19}},{"line":35,"address":[14444995],"length":1,"stats":{"Line":10}},{"line":36,"address":[19031388,19031314],"length":1,"stats":{"Line":20}},{"line":39,"address":[14445108],"length":1,"stats":{"Line":10}},{"line":40,"address":[14474071],"length":1,"stats":{"Line":10}},{"line":41,"address":[19031499],"length":1,"stats":{"Line":10}},{"line":42,"address":[14445231],"length":1,"stats":{"Line":10}},{"line":49,"address":[14445282],"length":1,"stats":{"Line":10}},{"line":53,"address":[19031660],"length":1,"stats":{"Line":10}},{"line":54,"address":[14474404],"length":1,"stats":{"Line":10}},{"line":58,"address":[14473957],"length":1,"stats":{"Line":10}},{"line":62,"address":[13404681,13402128,13404675],"length":1,"stats":{"Line":10}},{"line":63,"address":[13402238],"length":1,"stats":{"Line":10}},{"line":66,"address":[14471065,14471167],"length":1,"stats":{"Line":12}},{"line":67,"address":[14471138],"length":1,"stats":{"Line":2}},{"line":69,"address":[14471185],"length":1,"stats":{"Line":8}},{"line":71,"address":[19028609],"length":1,"stats":{"Line":8}},{"line":73,"address":[13402476],"length":1,"stats":{"Line":10}},{"line":74,"address":[14442654],"length":1,"stats":{"Line":0}},{"line":79,"address":[19028697],"length":1,"stats":{"Line":10}},{"line":81,"address":[14471505],"length":1,"stats":{"Line":10}},{"line":82,"address":[13402734],"length":1,"stats":{"Line":10}},{"line":83,"address":[14471530],"length":1,"stats":{"Line":10}},{"line":85,"address":[19028950,19029007],"length":1,"stats":{"Line":20}},{"line":86,"address":[14471693,14473492,14473588],"length":1,"stats":{"Line":30}},{"line":87,"address":[14473513],"length":1,"stats":{"Line":10}},{"line":89,"address":[14444612],"length":1,"stats":{"Line":10}},{"line":90,"address":[14473548],"length":1,"stats":{"Line":10}},{"line":91,"address":[14473568],"length":1,"stats":{"Line":10}},{"line":96,"address":[14471754],"length":1,"stats":{"Line":10}},{"line":97,"address":[13403027,13403129],"length":1,"stats":{"Line":12}},{"line":98,"address":[19029292],"length":1,"stats":{"Line":2}},{"line":100,"address":[13403147],"length":1,"stats":{"Line":8}},{"line":102,"address":[14471949],"length":1,"stats":{"Line":8}},{"line":104,"address":[14472008],"length":1,"stats":{"Line":10}},{"line":105,"address":[14443113],"length":1,"stats":{"Line":0}},{"line":109,"address":[13403273,13403231],"length":1,"stats":{"Line":20}},{"line":110,"address":[19029481,19029655,19029561],"length":1,"stats":{"Line":20}},{"line":112,"address":[19029684,19029612,19029729],"length":1,"stats":{"Line":10}},{"line":113,"address":[14443366],"length":1,"stats":{"Line":0}},{"line":115,"address":[14443413],"length":1,"stats":{"Line":10}},{"line":118,"address":[19029763,19029881],"length":1,"stats":{"Line":10}},{"line":119,"address":[14472430],"length":1,"stats":{"Line":0}},{"line":121,"address":[19029883],"length":1,"stats":{"Line":10}},{"line":123,"address":[19029915],"length":1,"stats":{"Line":10}},{"line":126,"address":[19029519],"length":1,"stats":{"Line":0}},{"line":129,"address":[14472619,14472560],"length":1,"stats":{"Line":20}},{"line":130,"address":[14472686],"length":1,"stats":{"Line":0}},{"line":134,"address":[14473471,14472657,14472714],"length":1,"stats":{"Line":20}},{"line":135,"address":[13404137,13404050],"length":1,"stats":{"Line":10}},{"line":138,"address":[19030847,19030312,19030359],"length":1,"stats":{"Line":20}},{"line":139,"address":[14444151,14444232],"length":1,"stats":{"Line":10}},{"line":141,"address":[14444341],"length":1,"stats":{"Line":10}},{"line":142,"address":[14473141],"length":1,"stats":{"Line":10}},{"line":143,"address":[19030615],"length":1,"stats":{"Line":10}},{"line":155,"address":[14466031,14470664,14464176],"length":1,"stats":{"Line":2}},{"line":156,"address":[19021751],"length":1,"stats":{"Line":2}},{"line":161,"address":[14435412,14435352],"length":1,"stats":{"Line":4}},{"line":162,"address":[14435528],"length":1,"stats":{"Line":2}},{"line":163,"address":[19021888],"length":1,"stats":{"Line":0}},{"line":167,"address":[14464722,14464631],"length":1,"stats":{"Line":8}},{"line":169,"address":[13508096,13508105],"length":1,"stats":{"Line":8}},{"line":170,"address":[13557497,13557472],"length":1,"stats":{"Line":8}},{"line":171,"address":[14436419],"length":1,"stats":{"Line":2}},{"line":172,"address":[14436535,14436688],"length":1,"stats":{"Line":4}},{"line":174,"address":[14465832],"length":1,"stats":{"Line":2}},{"line":180,"address":[13397356],"length":1,"stats":{"Line":2}},{"line":182,"address":[19023525],"length":1,"stats":{"Line":6}},{"line":184,"address":[14437203],"length":1,"stats":{"Line":2}},{"line":185,"address":[14466310],"length":1,"stats":{"Line":2}},{"line":186,"address":[13557264,13557289],"length":1,"stats":{"Line":6}},{"line":187,"address":[14437798],"length":1,"stats":{"Line":2}},{"line":188,"address":[14467123],"length":1,"stats":{"Line":2}},{"line":189,"address":[13398110,13398263],"length":1,"stats":{"Line":4}},{"line":191,"address":[14467211],"length":1,"stats":{"Line":2}},{"line":200,"address":[19024874,19022347],"length":1,"stats":{"Line":8}},{"line":201,"address":[13537065,13537056],"length":1,"stats":{"Line":8}},{"line":204,"address":[14438766],"length":1,"stats":{"Line":6}},{"line":205,"address":[14438948,14438887],"length":1,"stats":{"Line":4}},{"line":207,"address":[19025488],"length":1,"stats":{"Line":2}},{"line":210,"address":[13399362],"length":1,"stats":{"Line":2}},{"line":211,"address":[14439505],"length":1,"stats":{"Line":2}},{"line":212,"address":[14439262,14439377],"length":1,"stats":{"Line":4}},{"line":214,"address":[13399789],"length":1,"stats":{"Line":2}},{"line":220,"address":[19588928,19588937],"length":1,"stats":{"Line":8}},{"line":221,"address":[19026179,19026118],"length":1,"stats":{"Line":4}},{"line":222,"address":[14468919],"length":1,"stats":{"Line":2}},{"line":223,"address":[19026678],"length":1,"stats":{"Line":2}},{"line":224,"address":[14469007,14469114],"length":1,"stats":{"Line":4}},{"line":226,"address":[14440402],"length":1,"stats":{"Line":2}},{"line":232,"address":[14469409,14468709],"length":1,"stats":{"Line":4}},{"line":233,"address":[14469495],"length":1,"stats":{"Line":0}},{"line":234,"address":[19027110],"length":1,"stats":{"Line":0}},{"line":235,"address":[14469789],"length":1,"stats":{"Line":0}},{"line":236,"address":[14469869],"length":1,"stats":{"Line":0}},{"line":238,"address":[13401214],"length":1,"stats":{"Line":0}},{"line":239,"address":[14470162],"length":1,"stats":{"Line":0}},{"line":240,"address":[19027876],"length":1,"stats":{"Line":0}},{"line":241,"address":[14470336,14470247],"length":1,"stats":{"Line":0}},{"line":243,"address":[14441612],"length":1,"stats":{"Line":0}},{"line":251,"address":[13398799],"length":1,"stats":{"Line":2}},{"line":255,"address":[13407247,13405648,13407241],"length":1,"stats":{"Line":2}},{"line":256,"address":[19031917],"length":1,"stats":{"Line":2}},{"line":259,"address":[19031960,19032062],"length":1,"stats":{"Line":2}},{"line":260,"address":[14445729],"length":1,"stats":{"Line":0}},{"line":262,"address":[14474704],"length":1,"stats":{"Line":2}},{"line":264,"address":[14474720],"length":1,"stats":{"Line":2}},{"line":267,"address":[14445839],"length":1,"stats":{"Line":2}},{"line":268,"address":[13406167],"length":1,"stats":{"Line":2}},{"line":269,"address":[13406179],"length":1,"stats":{"Line":2}},{"line":271,"address":[14446079,14446109],"length":1,"stats":{"Line":4}},{"line":272,"address":[19032496,19033587,19033452],"length":1,"stats":{"Line":6}},{"line":273,"address":[19033473],"length":1,"stats":{"Line":2}},{"line":275,"address":[14447246],"length":1,"stats":{"Line":2}},{"line":276,"address":[14447266],"length":1,"stats":{"Line":2}},{"line":280,"address":[13406345],"length":1,"stats":{"Line":2}},{"line":283,"address":[14446337],"length":1,"stats":{"Line":2}},{"line":284,"address":[14475406,14475310],"length":1,"stats":{"Line":2}},{"line":285,"address":[14446449],"length":1,"stats":{"Line":0}},{"line":287,"address":[14446490],"length":1,"stats":{"Line":2}},{"line":289,"address":[14475434],"length":1,"stats":{"Line":2}},{"line":292,"address":[13406791,13406667],"length":1,"stats":{"Line":2}},{"line":293,"address":[14446639,14446705,14446750],"length":1,"stats":{"Line":2}},{"line":294,"address":[14446721],"length":1,"stats":{"Line":0}},{"line":296,"address":[19033063],"length":1,"stats":{"Line":2}},{"line":298,"address":[14475706],"length":1,"stats":{"Line":2}},{"line":300,"address":[14446835],"length":1,"stats":{"Line":2}},{"line":301,"address":[14475801],"length":1,"stats":{"Line":0}},{"line":304,"address":[14446901],"length":1,"stats":{"Line":2}},{"line":308,"address":[13401920],"length":1,"stats":{"Line":2}},{"line":309,"address":[14441800],"length":1,"stats":{"Line":2}},{"line":310,"address":[14470800],"length":1,"stats":{"Line":2}},{"line":311,"address":[14441926],"length":1,"stats":{"Line":2}},{"line":313,"address":[13537120,13537129],"length":1,"stats":{"Line":6}},{"line":314,"address":[13557670,13557648],"length":1,"stats":{"Line":6}},{"line":315,"address":[13401996],"length":1,"stats":{"Line":0}},{"line":320,"address":[19033600,19034723,19034729],"length":1,"stats":{"Line":2}},{"line":326,"address":[14447417,14447494],"length":1,"stats":{"Line":4}},{"line":328,"address":[14447620,14447686],"length":1,"stats":{"Line":4}},{"line":330,"address":[13407823],"length":1,"stats":{"Line":2}},{"line":331,"address":[14476713],"length":1,"stats":{"Line":2}},{"line":334,"address":[14476720],"length":1,"stats":{"Line":2}},{"line":335,"address":[14476925,14476821],"length":1,"stats":{"Line":2}},{"line":338,"address":[14448015,14447947],"length":1,"stats":{"Line":2}},{"line":339,"address":[14477084,14476991],"length":1,"stats":{"Line":2}},{"line":341,"address":[14477172],"length":1,"stats":{"Line":2}},{"line":342,"address":[19034409],"length":1,"stats":{"Line":2}},{"line":343,"address":[14477080],"length":1,"stats":{"Line":2}},{"line":355,"address":[19033944],"length":1,"stats":{"Line":0}},{"line":359,"address":[14449602,14448448,14449608],"length":1,"stats":{"Line":2}},{"line":365,"address":[19034876,19034959],"length":1,"stats":{"Line":4}},{"line":366,"address":[14448771],"length":1,"stats":{"Line":2}},{"line":369,"address":[14448874,14448818],"length":1,"stats":{"Line":4}},{"line":371,"address":[14477845],"length":1,"stats":{"Line":2}},{"line":372,"address":[14477889],"length":1,"stats":{"Line":2}},{"line":375,"address":[13409080],"length":1,"stats":{"Line":2}},{"line":376,"address":[19035479,19035372],"length":1,"stats":{"Line":2}},{"line":379,"address":[14449194,14449126],"length":1,"stats":{"Line":2}},{"line":380,"address":[14449245,14449341],"length":1,"stats":{"Line":2}},{"line":382,"address":[19035731],"length":1,"stats":{"Line":2}},{"line":383,"address":[19035591],"length":1,"stats":{"Line":2}},{"line":384,"address":[14449337],"length":1,"stats":{"Line":2}},{"line":396,"address":[14448838],"length":1,"stats":{"Line":0}}],"covered":148,"coverable":171},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","parsers","ruby.rs"],"content":"//! Parser for Ruby Gemfile files\n//!\n//! Supports:\n//! - Gemfile format (Bundler)\n//! - gem declarations with version constraints\n//! - group blocks for development dependencies\n\nuse super::{Dependency, Parser};\n\n/// Parser for Ruby Gemfile dependency files\n#[derive(Debug, Default)]\npub struct RubyParser;\n\nimpl RubyParser {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\nimpl Parser for RubyParser {\n    fn parse(\u0026self, content: \u0026str) -\u003e Vec\u003cDependency\u003e {\n        let mut dependencies = Vec::new();\n        let mut in_dev_group = false;\n        let mut group_depth = 0;\n\n        for (line_idx, line) in content.lines().enumerate() {\n            let line_num = line_idx as u32;\n            let trimmed = line.trim();\n\n            // Skip comments and empty lines\n            if trimmed.is_empty() || trimmed.starts_with('#') {\n                continue;\n            }\n\n            // Track group blocks for dev dependencies\n            if trimmed.starts_with(\"group\") {\n                let is_dev = trimmed.contains(\":development\")\n                    || trimmed.contains(\":test\")\n                    || trimmed.contains(\"'development'\")\n                    || trimmed.contains(\"\\\"development\\\"\")\n                    || trimmed.contains(\"'test'\")\n                    || trimmed.contains(\"\\\"test\\\"\");\n\n                if trimmed.contains(\"do\") {\n                    group_depth += 1;\n                    if is_dev {\n                        in_dev_group = true;\n                    }\n                }\n                continue;\n            }\n\n            // Track end of blocks\n            if trimmed == \"end\" {\n                if group_depth \u003e 0 {\n                    group_depth -= 1;\n                    if group_depth == 0 {\n                        in_dev_group = false;\n                    }\n                }\n                continue;\n            }\n\n            // Parse gem declarations\n            if let Some(dep) = parse_gem_declaration(line, line_num, in_dev_group) {\n                dependencies.push(dep);\n            }\n        }\n\n        dependencies\n    }\n}\n\n/// Parse a gem declaration from a line\nfn parse_gem_declaration(line: \u0026str, line_num: u32, dev: bool) -\u003e Option\u003cDependency\u003e {\n    let trimmed = line.trim();\n\n    // Must start with 'gem'\n    if !trimmed.starts_with(\"gem \") \u0026\u0026 !trimmed.starts_with(\"gem(\") {\n        return None;\n    }\n\n    // Extract the part after 'gem'\n    let after_gem = if trimmed.starts_with(\"gem(\") {\n        trimmed.strip_prefix(\"gem(\")?.trim_end_matches(')')\n    } else {\n        trimmed.strip_prefix(\"gem \")?\n    };\n\n    // Split by comma to get arguments\n    let args: Vec\u003c\u0026str\u003e = split_gem_args(after_gem);\n\n    if args.is_empty() {\n        return None;\n    }\n\n    // First argument is the gem name (quoted)\n    let name = args[0].trim().trim_matches(|c| c == '\\'' || c == '\"');\n\n    // Second argument (if present) is the version constraint\n    let version = if args.len() \u003e 1 {\n        let version_arg = args[1].trim();\n        // Skip if it's a hash option (like require: false, git: ...)\n        if version_arg.contains(':')\n            \u0026\u0026 !version_arg.starts_with('\\'')\n            \u0026\u0026 !version_arg.starts_with('\"')\n        {\n            return None; // No version, has options like git: or path:\n        }\n        version_arg\n            .trim_matches(|c| c == '\\'' || c == '\"')\n            .to_string()\n    } else {\n        return None; // No version specified\n    };\n\n    // Skip if version looks like a hash key (path, git, etc.)\n    if version.is_empty() || version.contains(':') {\n        return None;\n    }\n\n    // Calculate positions in the original line\n    let name_start = find_string_position(line, name)? as u32;\n    let name_end = name_start + name.len() as u32;\n    let version_start = find_string_position(line, \u0026version)? as u32;\n    let version_end = version_start + version.len() as u32;\n\n    Some(Dependency {\n        name: name.to_string(),\n        version,\n        line: line_num,\n        name_start,\n        name_end,\n        version_start,\n        version_end,\n        dev,\n        optional: false,\n    })\n}\n\n/// Split gem arguments respecting quotes\nfn split_gem_args(s: \u0026str) -\u003e Vec\u003c\u0026str\u003e {\n    let mut args = Vec::new();\n    let mut start = 0;\n    let mut in_quotes = false;\n    let mut quote_char = ' ';\n\n    for (i, c) in s.char_indices() {\n        match c {\n            '\\'' | '\"' if !in_quotes =\u003e {\n                in_quotes = true;\n                quote_char = c;\n            }\n            c if c == quote_char \u0026\u0026 in_quotes =\u003e {\n                in_quotes = false;\n            }\n            ',' if !in_quotes =\u003e {\n                let arg = s[start..i].trim();\n                if !arg.is_empty() {\n                    args.push(arg);\n                }\n                start = i + 1;\n            }\n            _ =\u003e {}\n        }\n    }\n\n    // Don't forget the last argument\n    let last_arg = s[start..].trim();\n    if !last_arg.is_empty() {\n        // Stop at hash options\n        if let Some(hash_start) = last_arg.find([':', '{']) {\n            let before_hash = last_arg[..hash_start].trim();\n            if !before_hash.is_empty()\n                \u0026\u0026 (before_hash.starts_with('\\'') || before_hash.starts_with('\"'))\n            {\n                args.push(before_hash);\n            }\n        } else {\n            args.push(last_arg);\n        }\n    }\n\n    args\n}\n\n/// Find the position of a string in a line (accounting for quotes)\nfn find_string_position(line: \u0026str, needle: \u0026str) -\u003e Option\u003cusize\u003e {\n    // Look for the string within quotes\n    for quote in \u0026['\\'', '\"'] {\n        let quoted = format!(\"{}{}{}\", quote, needle, quote);\n        if let Some(pos) = line.find(\u0026quoted) {\n            return Some(pos + 1); // Skip the opening quote\n        }\n    }\n    // Fallback to direct search\n    line.find(needle)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_simple_gem() {\n        let parser = RubyParser::new();\n        let content = r#\"\nsource 'https://rubygems.org'\n\ngem 'rails', '~\u003e 7.0'\ngem 'pg', '~\u003e 1.4'\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n        assert_eq!(deps[0].name, \"rails\");\n        assert_eq!(deps[0].version, \"~\u003e 7.0\");\n        assert!(!deps[0].dev);\n        assert_eq!(deps[1].name, \"pg\");\n        assert_eq!(deps[1].version, \"~\u003e 1.4\");\n    }\n\n    #[test]\n    fn test_gem_with_version_operators() {\n        let parser = RubyParser::new();\n        let content = r#\"\ngem 'devise', '\u003e= 4.0'\ngem 'rspec', '~\u003e 3.0'\ngem 'rails', '~\u003e 7.0.0'\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 3);\n        assert_eq!(deps[0].name, \"devise\");\n        assert_eq!(deps[0].version, \"\u003e= 4.0\");\n        assert_eq!(deps[1].name, \"rspec\");\n        assert_eq!(deps[1].version, \"~\u003e 3.0\");\n        assert_eq!(deps[2].name, \"rails\");\n        assert_eq!(deps[2].version, \"~\u003e 7.0.0\");\n    }\n\n    #[test]\n    fn test_dev_dependencies_in_group() {\n        let parser = RubyParser::new();\n        let content = r#\"\nsource 'https://rubygems.org'\n\ngem 'rails', '~\u003e 7.0'\n\ngroup :development, :test do\n  gem 'rspec-rails', '~\u003e 6.0'\n  gem 'factory_bot_rails', '~\u003e 6.2'\nend\n\ngem 'pg', '~\u003e 1.4'\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 4);\n\n        let rails = deps.iter().find(|d| d.name == \"rails\").unwrap();\n        assert!(!rails.dev);\n\n        let rspec = deps.iter().find(|d| d.name == \"rspec-rails\").unwrap();\n        assert!(rspec.dev);\n\n        let factory_bot = deps.iter().find(|d| d.name == \"factory_bot_rails\").unwrap();\n        assert!(factory_bot.dev);\n\n        let pg = deps.iter().find(|d| d.name == \"pg\").unwrap();\n        assert!(!pg.dev);\n    }\n\n    #[test]\n    fn test_skip_git_and_path_gems() {\n        let parser = RubyParser::new();\n        let content = r#\"\ngem 'rails', '~\u003e 7.0'\ngem 'my_gem', git: 'https://github.com/user/my_gem.git'\ngem 'local_gem', path: '../local_gem'\ngem 'pg', '~\u003e 1.4'\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n        assert_eq!(deps[0].name, \"rails\");\n        assert_eq!(deps[1].name, \"pg\");\n    }\n\n    #[test]\n    fn test_skip_comments_and_empty_lines() {\n        let parser = RubyParser::new();\n        let content = r#\"\n# This is a comment\nsource 'https://rubygems.org'\n\n# Another comment\ngem 'rails', '~\u003e 7.0'\n\n# gem 'old_gem', '1.0'\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"rails\");\n    }\n\n    #[test]\n    fn test_gem_with_require_option() {\n        let parser = RubyParser::new();\n        let content = r#\"\ngem 'rails', '~\u003e 7.0'\ngem 'bootsnap', '~\u003e 1.16', require: false\ngem 'pg', '~\u003e 1.4'\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 3);\n        assert_eq!(deps[0].name, \"rails\");\n        assert_eq!(deps[1].name, \"bootsnap\");\n        assert_eq!(deps[1].version, \"~\u003e 1.16\");\n        assert_eq!(deps[2].name, \"pg\");\n    }\n\n    #[test]\n    fn test_double_quoted_gems() {\n        let parser = RubyParser::new();\n        let content = r#\"\ngem \"rails\", \"~\u003e 7.0\"\ngem \"pg\", \"~\u003e 1.4\"\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n        assert_eq!(deps[0].name, \"rails\");\n        assert_eq!(deps[0].version, \"~\u003e 7.0\");\n    }\n\n    #[test]\n    fn test_version_positions() {\n        let parser = RubyParser::new();\n        let content = \"gem 'rails', '~\u003e 7.0'\\n\";\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 1);\n        let dep = \u0026deps[0];\n\n        // Verify positions are valid\n        assert!(dep.name_start \u003c dep.name_end);\n        assert!(dep.version_start \u003c dep.version_end);\n        assert!(dep.name_end \u003c dep.version_start);\n\n        // Verify name position\n        let name_slice = \u0026content[dep.name_start as usize..dep.name_end as usize];\n        assert_eq!(name_slice, \"rails\");\n\n        // Verify version position\n        let version_slice = \u0026content[dep.version_start as usize..dep.version_end as usize];\n        assert_eq!(version_slice, \"~\u003e 7.0\");\n    }\n\n    #[test]\n    fn test_exact_version() {\n        let parser = RubyParser::new();\n        let content = \"gem 'nokogiri', '1.15.4'\\n\";\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 1);\n        assert_eq!(deps[0].name, \"nokogiri\");\n        assert_eq!(deps[0].version, \"1.15.4\");\n    }\n\n    #[test]\n    fn test_test_group() {\n        let parser = RubyParser::new();\n        let content = r#\"\ngem 'rails', '~\u003e 7.0'\n\ngroup :test do\n  gem 'rspec', '~\u003e 3.12'\nend\n\"#;\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 2);\n\n        let rspec = deps.iter().find(|d| d.name == \"rspec\").unwrap();\n        assert!(rspec.dev);\n    }\n}\n","traces":[{"line":21,"address":[14462350,14462344,14460992],"length":1,"stats":{"Line":4}},{"line":22,"address":[14461043],"length":1,"stats":{"Line":4}},{"line":23,"address":[14489995],"length":1,"stats":{"Line":4}},{"line":24,"address":[17962892],"length":1,"stats":{"Line":4}},{"line":26,"address":[14461136,14461088],"length":1,"stats":{"Line":10}},{"line":27,"address":[14490264],"length":1,"stats":{"Line":6}},{"line":28,"address":[12654311,12654382],"length":1,"stats":{"Line":13}},{"line":31,"address":[14490358],"length":1,"stats":{"Line":9}},{"line":36,"address":[17963337],"length":1,"stats":{"Line":6}},{"line":37,"address":[14490532,14490858,14490907],"length":1,"stats":{"Line":9}},{"line":38,"address":[17963748,17963808],"length":1,"stats":{"Line":4}},{"line":39,"address":[12654966],"length":1,"stats":{"Line":0}},{"line":40,"address":[14490983],"length":1,"stats":{"Line":0}},{"line":41,"address":[12655072],"length":1,"stats":{"Line":0}},{"line":42,"address":[17963977],"length":1,"stats":{"Line":0}},{"line":44,"address":[17964033],"length":1,"stats":{"Line":3}},{"line":45,"address":[17964125,17964089],"length":1,"stats":{"Line":2}},{"line":46,"address":[14462298,14462339],"length":1,"stats":{"Line":7}},{"line":47,"address":[14462334],"length":1,"stats":{"Line":3}},{"line":54,"address":[14461654,14461574],"length":1,"stats":{"Line":15}},{"line":55,"address":[14490623],"length":1,"stats":{"Line":4}},{"line":56,"address":[14461896,14461861],"length":1,"stats":{"Line":4}},{"line":57,"address":[14461884,14461921],"length":1,"stats":{"Line":8}},{"line":58,"address":[17963728],"length":1,"stats":{"Line":4}},{"line":65,"address":[17963527,17963490],"length":1,"stats":{"Line":11}},{"line":66,"address":[12654813],"length":1,"stats":{"Line":14}},{"line":70,"address":[14490298],"length":1,"stats":{"Line":7}},{"line":75,"address":[14487360,14489825,14489819],"length":1,"stats":{"Line":6}},{"line":76,"address":[17959870],"length":1,"stats":{"Line":9}},{"line":79,"address":[14458585],"length":1,"stats":{"Line":6}},{"line":80,"address":[14458699],"length":1,"stats":{"Line":2}},{"line":84,"address":[14487591],"length":1,"stats":{"Line":7}},{"line":85,"address":[14458839,14459063],"length":1,"stats":{"Line":0}},{"line":87,"address":[14458933,14458744],"length":1,"stats":{"Line":5}},{"line":91,"address":[12651983],"length":1,"stats":{"Line":8}},{"line":93,"address":[17960364,17960515],"length":1,"stats":{"Line":15}},{"line":94,"address":[12652227],"length":1,"stats":{"Line":0}},{"line":98,"address":[17960521,17960593],"length":1,"stats":{"Line":33}},{"line":101,"address":[17960716],"length":1,"stats":{"Line":10}},{"line":102,"address":[17960846,17960780],"length":1,"stats":{"Line":17}},{"line":104,"address":[14488536],"length":1,"stats":{"Line":7}},{"line":105,"address":[17961024],"length":1,"stats":{"Line":0}},{"line":106,"address":[17961076],"length":1,"stats":{"Line":0}},{"line":108,"address":[12652784],"length":1,"stats":{"Line":0}},{"line":111,"address":[14459660],"length":1,"stats":{"Line":27}},{"line":114,"address":[14488371],"length":1,"stats":{"Line":2}},{"line":118,"address":[14488795,14488939,14488860],"length":1,"stats":{"Line":30}},{"line":119,"address":[14459977],"length":1,"stats":{"Line":0}},{"line":123,"address":[17962199,17961391],"length":1,"stats":{"Line":14}},{"line":124,"address":[14489225,14489154],"length":1,"stats":{"Line":11}},{"line":125,"address":[14460280,14460343,14460865],"length":1,"stats":{"Line":25}},{"line":126,"address":[14460569,14460488],"length":1,"stats":{"Line":14}},{"line":128,"address":[17961988],"length":1,"stats":{"Line":11}},{"line":129,"address":[14489478],"length":1,"stats":{"Line":11}},{"line":130,"address":[17961940],"length":1,"stats":{"Line":14}},{"line":142,"address":[14486658,14486652,14485152],"length":1,"stats":{"Line":6}},{"line":143,"address":[12649279],"length":1,"stats":{"Line":9}},{"line":144,"address":[17957640],"length":1,"stats":{"Line":6}},{"line":145,"address":[14456324],"length":1,"stats":{"Line":9}},{"line":146,"address":[12649320],"length":1,"stats":{"Line":6}},{"line":148,"address":[17957730,17957679],"length":1,"stats":{"Line":15}},{"line":149,"address":[12650414,12649593],"length":1,"stats":{"Line":15}},{"line":150,"address":[17958705,17958749,17958717],"length":1,"stats":{"Line":16}},{"line":151,"address":[14457399],"length":1,"stats":{"Line":6}},{"line":152,"address":[17958735],"length":1,"stats":{"Line":9}},{"line":154,"address":[12650331,12650429],"length":1,"stats":{"Line":18}},{"line":155,"address":[12650439],"length":1,"stats":{"Line":6}},{"line":157,"address":[17958792],"length":1,"stats":{"Line":9}},{"line":158,"address":[14486430],"length":1,"stats":{"Line":6}},{"line":159,"address":[14486535],"length":1,"stats":{"Line":9}},{"line":160,"address":[17958966,17959012],"length":1,"stats":{"Line":15}},{"line":162,"address":[14457704,14457691,14457665],"length":1,"stats":{"Line":15}},{"line":169,"address":[12649655],"length":1,"stats":{"Line":6}},{"line":170,"address":[17958130],"length":1,"stats":{"Line":9}},{"line":172,"address":[14485773,14485921],"length":1,"stats":{"Line":15}},{"line":173,"address":[14457055,14457137],"length":1,"stats":{"Line":7}},{"line":174,"address":[17958524],"length":1,"stats":{"Line":2}},{"line":175,"address":[14457231,14457324],"length":1,"stats":{"Line":6}},{"line":177,"address":[12650321,12650289],"length":1,"stats":{"Line":0}},{"line":180,"address":[14457338,14457102],"length":1,"stats":{"Line":15}},{"line":184,"address":[14485862],"length":1,"stats":{"Line":6}},{"line":188,"address":[14458405,14458411,14457744],"length":1,"stats":{"Line":11}},{"line":190,"address":[17959137,17959115],"length":1,"stats":{"Line":25}},{"line":191,"address":[17959206],"length":1,"stats":{"Line":14}},{"line":192,"address":[14487064,14487193],"length":1,"stats":{"Line":25}},{"line":193,"address":[14458352,14458385,14458311],"length":1,"stats":{"Line":25}},{"line":197,"address":[14458167],"length":1,"stats":{"Line":0}}],"covered":75,"coverable":87},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","providers","code_actions.rs"],"content":"//! Code actions provider for updating dependencies\n\nuse std::collections::HashMap;\n\nuse tower_lsp::lsp_types::*;\n\nuse crate::cache::ReadCache;\nuse crate::file_types::FileType;\nuse crate::parsers::Dependency;\nuse crate::providers::inlay_hints::{VersionStatus, compare_versions};\n\n/// Type of semantic version update\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum VersionUpdateType {\n    Major,\n    Minor,\n    Patch,\n    PreRelease,\n}\n\nimpl VersionUpdateType {\n    pub fn prefix(\u0026self) -\u003e \u0026'static str {\n        match self {\n            VersionUpdateType::Major =\u003e \"⚠ MAJOR\",\n            VersionUpdateType::Minor =\u003e \"+ minor\",\n            VersionUpdateType::Patch =\u003e \"· patch\",\n            VersionUpdateType::PreRelease =\u003e \"* prerelease\",\n        }\n    }\n\n    pub fn is_preferred(\u0026self) -\u003e bool {\n        !matches!(self, VersionUpdateType::Major)\n    }\n}\n\n/// Determine the type of version update between current and new version\npub fn compare_update_type(current: \u0026str, new: \u0026str) -\u003e VersionUpdateType {\n    let current_normalized = normalize_version(current);\n    let new_normalized = normalize_version(new);\n\n    match (\n        semver::Version::parse(\u0026current_normalized),\n        semver::Version::parse(\u0026new_normalized),\n    ) {\n        (Ok(current_ver), Ok(new_ver)) =\u003e {\n            if !new_ver.pre.is_empty() \u0026\u0026 current_ver.pre.is_empty() {\n                VersionUpdateType::PreRelease\n            } else if current_ver.major != new_ver.major {\n                VersionUpdateType::Major\n            } else if current_ver.minor != new_ver.minor {\n                VersionUpdateType::Minor\n            } else if current_ver.patch != new_ver.patch {\n                VersionUpdateType::Patch\n            } else {\n                VersionUpdateType::PreRelease\n            }\n        }\n        _ =\u003e VersionUpdateType::Patch,\n    }\n}\n\nfn normalize_version(version: \u0026str) -\u003e String {\n    let version = version.trim();\n    let version = version\n        .strip_prefix(\"~\u003e\")\n        .or_else(|| version.strip_prefix('^'))\n        .or_else(|| version.strip_prefix('~'))\n        .or_else(|| version.strip_prefix(\"\u003e=\"))\n        .or_else(|| version.strip_prefix(\"\u003c=\"))\n        .or_else(|| version.strip_prefix('\u003e'))\n        .or_else(|| version.strip_prefix('\u003c'))\n        .or_else(|| version.strip_prefix('='))\n        .or_else(|| version.strip_prefix('v'))\n        .unwrap_or(version)\n        .trim();\n\n    let version = version.split(',').next().unwrap_or(version).trim();\n\n    let parts: Vec\u003c\u0026str\u003e = version.split('.').collect();\n    match parts.len() {\n        1 =\u003e format!(\"{}.0.0\", parts[0]),\n        2 =\u003e format!(\"{}.{}.0\", parts[0], parts[1]),\n        _ =\u003e version.to_string(),\n    }\n}\n\n/// Create code actions for dependencies in the given range\npub fn create_code_actions(\n    dependencies: \u0026[Dependency],\n    cache: \u0026impl ReadCache,\n    uri: \u0026Url,\n    range: Range,\n    file_type: FileType,\n    cache_key_fn: impl Fn(\u0026str) -\u003e String,\n) -\u003e Vec\u003cCodeActionOrCommand\u003e {\n    let mut actions: Vec\u003cCodeActionOrCommand\u003e = dependencies\n        .iter()\n        .filter(|dep| dep.line \u003e= range.start.line \u0026\u0026 dep.line \u003c= range.end.line)\n        .filter_map(|dep| create_update_action(dep, cache, uri, file_type, \u0026cache_key_fn))\n        .collect();\n\n    if let Some(update_all) =\n        create_update_all_action(dependencies, cache, uri, file_type, \u0026cache_key_fn)\n    {\n        actions.insert(0, update_all);\n    }\n\n    actions\n}\n\n/// Create an \"Update to X.Y.Z\" code action for a dependency\nfn create_update_action(\n    dep: \u0026Dependency,\n    cache: \u0026impl ReadCache,\n    uri: \u0026Url,\n    file_type: FileType,\n    cache_key_fn: impl Fn(\u0026str) -\u003e String,\n) -\u003e Option\u003cCodeActionOrCommand\u003e {\n    let cache_key = cache_key_fn(\u0026dep.name);\n    let version_info = cache.get(\u0026cache_key)?;\n\n    match compare_versions(\u0026dep.version, \u0026version_info) {\n        VersionStatus::UpdateAvailable(new_version) =\u003e {\n            let update_type = compare_update_type(\u0026dep.version, \u0026new_version);\n            let new_text = format_version(\u0026new_version, file_type);\n\n            let edit = TextEdit {\n                range: Range {\n                    start: Position {\n                        line: dep.line,\n                        character: dep.version_start,\n                    },\n                    end: Position {\n                        line: dep.line,\n                        character: dep.version_end,\n                    },\n                },\n                new_text,\n            };\n\n            let mut changes = HashMap::new();\n            changes.insert(uri.clone(), vec![edit]);\n\n            let title = format!(\n                \"{}: Update {} to {}\",\n                update_type.prefix(),\n                dep.name,\n                new_version\n            );\n\n            Some(CodeActionOrCommand::CodeAction(CodeAction {\n                title,\n                kind: Some(CodeActionKind::QUICKFIX),\n                diagnostics: None,\n                edit: Some(WorkspaceEdit {\n                    changes: Some(changes),\n                    document_changes: None,\n                    change_annotations: None,\n                }),\n                command: None,\n                is_preferred: Some(update_type.is_preferred()),\n                disabled: None,\n                data: None,\n            }))\n        }\n        VersionStatus::UpToDate | VersionStatus::Unknown =\u003e None,\n    }\n}\n\n/// Create an \"Update All Dependencies\" code action when 2+ updates are available\nfn create_update_all_action(\n    dependencies: \u0026[Dependency],\n    cache: \u0026impl ReadCache,\n    uri: \u0026Url,\n    file_type: FileType,\n    cache_key_fn: impl Fn(\u0026str) -\u003e String,\n) -\u003e Option\u003cCodeActionOrCommand\u003e {\n    let outdated_deps: Vec\u003c(\u0026Dependency, String)\u003e = dependencies\n        .iter()\n        .filter_map(|dep| {\n            let cache_key = cache_key_fn(\u0026dep.name);\n            let version_info = cache.get(\u0026cache_key)?;\n\n            match compare_versions(\u0026dep.version, \u0026version_info) {\n                VersionStatus::UpdateAvailable(new_version) =\u003e Some((dep, new_version)),\n                _ =\u003e None,\n            }\n        })\n        .collect();\n\n    if outdated_deps.len() \u003c 2 {\n        return None;\n    }\n\n    let edits: Vec\u003cTextEdit\u003e = outdated_deps\n        .iter()\n        .map(|(dep, new_version)| {\n            let new_text = format_version(new_version, file_type);\n            TextEdit {\n                range: Range {\n                    start: Position {\n                        line: dep.line,\n                        character: dep.version_start,\n                    },\n                    end: Position {\n                        line: dep.line,\n                        character: dep.version_end,\n                    },\n                },\n                new_text,\n            }\n        })\n        .collect();\n\n    let mut changes = HashMap::new();\n    changes.insert(uri.clone(), edits);\n\n    let count = outdated_deps.len();\n    let title = format!(\"Update all {} dependencies\", count);\n\n    Some(CodeActionOrCommand::CodeAction(CodeAction {\n        title,\n        kind: Some(CodeActionKind::QUICKFIX),\n        diagnostics: None,\n        edit: Some(WorkspaceEdit {\n            changes: Some(changes),\n            document_changes: None,\n            change_annotations: None,\n        }),\n        command: None,\n        is_preferred: Some(false),\n        disabled: None,\n        data: None,\n    }))\n}\n\n/// Format version string based on file type\nfn format_version(version: \u0026str, file_type: FileType) -\u003e String {\n    match file_type {\n        FileType::Cargo | FileType::Npm | FileType::Php =\u003e {\n            // Keep the version as-is - the range already includes the quotes in these formats\n            version.to_string()\n        }\n        FileType::Python =\u003e {\n            // Python uses operators like == or \u003e=\n            // Just replace the version number\n            version.to_string()\n        }\n        FileType::Go =\u003e {\n            // Go versions start with 'v'\n            if version.starts_with('v') {\n                version.to_string()\n            } else {\n                format!(\"v{}\", version)\n            }\n        }\n        FileType::Dart =\u003e {\n            // Dart pubspec.yaml uses caret syntax (^1.0.0) or simple versions\n            version.to_string()\n        }\n        FileType::Csharp =\u003e {\n            // C# .csproj uses simple version strings\n            version.to_string()\n        }\n        FileType::Ruby =\u003e {\n            // Ruby Gemfile uses operators like ~\u003e or \u003e=\n            version.to_string()\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::cache::{MemoryCache, WriteCache};\n    use crate::registries::VersionInfo;\n\n    fn create_test_dependency(name: \u0026str, version: \u0026str, line: u32) -\u003e Dependency {\n        Dependency {\n            name: name.to_string(),\n            version: version.to_string(),\n            line,\n            name_start: 0,\n            name_end: name.len() as u32,\n            version_start: name.len() as u32 + 4,\n            version_end: name.len() as u32 + 4 + version.len() as u32,\n            dev: false,\n            optional: false,\n        }\n    }\n\n    #[test]\n    fn test_create_update_action() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 1);\n        match \u0026actions[0] {\n            CodeActionOrCommand::CodeAction(action) =\u003e {\n                assert!(action.title.contains(\"Update serde to 2.0.0\"));\n                assert_eq!(action.kind, Some(CodeActionKind::QUICKFIX));\n            }\n            _ =\u003e panic!(\"Expected CodeAction\"),\n        }\n    }\n\n    #[test]\n    fn test_no_action_when_up_to_date() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 0);\n    }\n\n    #[test]\n    fn test_format_version() {\n        assert_eq!(format_version(\"1.0.0\", FileType::Cargo), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Npm), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Python), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Go), \"v1.0.0\");\n        assert_eq!(format_version(\"v1.0.0\", FileType::Go), \"v1.0.0\");\n    }\n\n    #[test]\n    fn test_update_all_action_with_multiple_outdated() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n        cache.insert(\n            \"test:tokio\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.36.0\".to_string()),\n                ..Default::default()\n            },\n        );\n        cache.insert(\n            \"test:reqwest\".to_string(),\n            VersionInfo {\n                latest: Some(\"0.12.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![\n            create_test_dependency(\"serde\", \"1.0.0\", 5),\n            create_test_dependency(\"tokio\", \"1.35.0\", 6),\n            create_test_dependency(\"reqwest\", \"0.11.0\", 7),\n        ];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 4);\n        match \u0026actions[0] {\n            CodeActionOrCommand::CodeAction(action) =\u003e {\n                assert!(action.title.contains(\"Update all 3 dependencies\"));\n                assert_eq!(action.kind, Some(CodeActionKind::QUICKFIX));\n                assert_eq!(action.is_preferred, Some(false));\n\n                if let Some(edit) = \u0026action.edit {\n                    if let Some(changes) = \u0026edit.changes {\n                        let edits = changes.get(\u0026uri).unwrap();\n                        assert_eq!(edits.len(), 3);\n                    } else {\n                        panic!(\"Expected changes in workspace edit\");\n                    }\n                } else {\n                    panic!(\"Expected edit in code action\");\n                }\n            }\n            _ =\u003e panic!(\"Expected CodeAction\"),\n        }\n    }\n\n    #[test]\n    fn test_update_all_action_not_shown_for_single_outdated() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n        cache.insert(\n            \"test:tokio\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.35.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![\n            create_test_dependency(\"serde\", \"1.0.0\", 5),\n            create_test_dependency(\"tokio\", \"1.35.0\", 6),\n        ];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 1);\n        match \u0026actions[0] {\n            CodeActionOrCommand::CodeAction(action) =\u003e {\n                assert!(!action.title.contains(\"Update all\"));\n                assert!(action.title.contains(\"Update serde to 2.0.0\"));\n            }\n            _ =\u003e panic!(\"Expected CodeAction\"),\n        }\n    }\n\n    #[test]\n    fn test_update_all_action_not_shown_when_all_up_to_date() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n        cache.insert(\n            \"test:tokio\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.35.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![\n            create_test_dependency(\"serde\", \"1.0.0\", 5),\n            create_test_dependency(\"tokio\", \"1.35.0\", 6),\n        ];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 0);\n    }\n\n    #[test]\n    fn test_version_update_type_major() {\n        let update_type = compare_update_type(\"1.0.0\", \"2.0.0\");\n        assert_eq!(update_type, VersionUpdateType::Major);\n        assert_eq!(update_type.prefix(), \"⚠ MAJOR\");\n        assert!(!update_type.is_preferred());\n    }\n\n    #[test]\n    fn test_version_update_type_minor() {\n        let update_type = compare_update_type(\"1.5.0\", \"1.6.0\");\n        assert_eq!(update_type, VersionUpdateType::Minor);\n        assert_eq!(update_type.prefix(), \"+ minor\");\n        assert!(update_type.is_preferred());\n    }\n\n    #[test]\n    fn test_version_update_type_patch() {\n        let update_type = compare_update_type(\"1.5.0\", \"1.5.1\");\n        assert_eq!(update_type, VersionUpdateType::Patch);\n        assert_eq!(update_type.prefix(), \"· patch\");\n        assert!(update_type.is_preferred());\n    }\n\n    #[test]\n    fn test_version_update_type_prerelease() {\n        let update_type = compare_update_type(\"1.5.0\", \"1.5.1-alpha.1\");\n        assert_eq!(update_type, VersionUpdateType::PreRelease);\n        assert_eq!(update_type.prefix(), \"* prerelease\");\n        assert!(update_type.is_preferred());\n    }\n\n    #[test]\n    fn test_version_update_type_with_prefixes() {\n        assert_eq!(\n            compare_update_type(\"^1.0.0\", \"2.0.0\"),\n            VersionUpdateType::Major\n        );\n        assert_eq!(\n            compare_update_type(\"~1.5.0\", \"1.6.0\"),\n            VersionUpdateType::Minor\n        );\n        assert_eq!(\n            compare_update_type(\"\u003e=1.5.0\", \"1.5.1\"),\n            VersionUpdateType::Patch\n        );\n        // Ruby pessimistic constraint\n        assert_eq!(\n            compare_update_type(\"~\u003e 7.0\", \"8.1.1\"),\n            VersionUpdateType::Major\n        );\n        assert_eq!(\n            compare_update_type(\"~\u003e 4.9\", \"4.9.4\"),\n            VersionUpdateType::Patch\n        );\n    }\n\n    #[test]\n    fn test_version_update_type_invalid_semver() {\n        let update_type = compare_update_type(\"invalid\", \"also-invalid\");\n        assert_eq!(update_type, VersionUpdateType::Patch);\n    }\n\n    #[test]\n    fn test_code_action_title_with_major_update() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 1);\n        match \u0026actions[0] {\n            CodeActionOrCommand::CodeAction(action) =\u003e {\n                assert!(action.title.contains(\"⚠ MAJOR\"));\n                assert!(action.title.contains(\"Update serde to 2.0.0\"));\n                assert_eq!(action.is_preferred, Some(false));\n            }\n            _ =\u003e panic!(\"Expected CodeAction\"),\n        }\n    }\n\n    #[test]\n    fn test_code_action_title_with_minor_update() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:tokio\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.36.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"tokio\", \"1.35.0\", 5)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 1);\n        match \u0026actions[0] {\n            CodeActionOrCommand::CodeAction(action) =\u003e {\n                assert!(action.title.contains(\"+ minor\"));\n                assert!(action.title.contains(\"Update tokio to 1.36.0\"));\n                assert_eq!(action.is_preferred, Some(true));\n            }\n            _ =\u003e panic!(\"Expected CodeAction\"),\n        }\n    }\n\n    #[test]\n    fn test_code_action_title_with_patch_update() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:reqwest\".to_string(),\n            VersionInfo {\n                latest: Some(\"0.12.1\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"reqwest\", \"0.12.0\", 5)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 1);\n        match \u0026actions[0] {\n            CodeActionOrCommand::CodeAction(action) =\u003e {\n                assert!(action.title.contains(\"· patch\"));\n                assert!(action.title.contains(\"Update reqwest to 0.12.1\"));\n                assert_eq!(action.is_preferred, Some(true));\n            }\n            _ =\u003e panic!(\"Expected CodeAction\"),\n        }\n    }\n\n    #[test]\n    fn test_format_version_all_file_types() {\n        assert_eq!(format_version(\"1.0.0\", FileType::Cargo), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Npm), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Python), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Go), \"v1.0.0\");\n        assert_eq!(format_version(\"v1.0.0\", FileType::Go), \"v1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Php), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Dart), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Csharp), \"1.0.0\");\n        assert_eq!(format_version(\"1.0.0\", FileType::Ruby), \"1.0.0\");\n    }\n\n    #[test]\n    fn test_normalize_version_with_partial_versions() {\n        let normalized = super::normalize_version(\"1\");\n        assert_eq!(normalized, \"1.0.0\");\n\n        let normalized = super::normalize_version(\"1.2\");\n        assert_eq!(normalized, \"1.2.0\");\n\n        let normalized = super::normalize_version(\"1.2.3\");\n        assert_eq!(normalized, \"1.2.3\");\n    }\n\n    #[test]\n    fn test_normalize_version_with_range_operators() {\n        let normalized = super::normalize_version(\"\u003e=1.0.0, \u003c2.0.0\");\n        assert_eq!(normalized, \"1.0.0\");\n\n        let normalized = super::normalize_version(\"\u003c=1.5.0\");\n        assert_eq!(normalized, \"1.5.0\");\n\n        let normalized = super::normalize_version(\"\u003e1.0.0\");\n        assert_eq!(normalized, \"1.0.0\");\n\n        let normalized = super::normalize_version(\"\u003c2.0.0\");\n        assert_eq!(normalized, \"2.0.0\");\n\n        let normalized = super::normalize_version(\"=1.0.0\");\n        assert_eq!(normalized, \"1.0.0\");\n    }\n\n    #[test]\n    fn test_filter_deps_outside_range() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 50)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 0);\n    }\n\n    #[test]\n    fn test_no_action_when_cache_empty() {\n        let cache = MemoryCache::new();\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let uri = Url::parse(\"file:///test/Cargo.toml\").unwrap();\n        let range = Range {\n            start: Position {\n                line: 0,\n                character: 0,\n            },\n            end: Position {\n                line: 10,\n                character: 0,\n            },\n        };\n\n        let actions = create_code_actions(\u0026deps, \u0026cache, \u0026uri, range, FileType::Cargo, |name| {\n            format!(\"test:{}\", name)\n        });\n\n        assert_eq!(actions.len(), 0);\n    }\n}\n","traces":[{"line":22,"address":[13021376],"length":1,"stats":{"Line":5}},{"line":23,"address":[13021381],"length":1,"stats":{"Line":5}},{"line":24,"address":[13050340],"length":1,"stats":{"Line":2}},{"line":25,"address":[13050363],"length":1,"stats":{"Line":2}},{"line":26,"address":[13050386],"length":1,"stats":{"Line":2}},{"line":27,"address":[19609593],"length":1,"stats":{"Line":2}},{"line":31,"address":[13050272],"length":1,"stats":{"Line":7}},{"line":32,"address":[13050277],"length":1,"stats":{"Line":8}},{"line":37,"address":[13052519,13051632,13052763],"length":1,"stats":{"Line":2}},{"line":38,"address":[14541018],"length":1,"stats":{"Line":7}},{"line":39,"address":[13051731],"length":1,"stats":{"Line":6}},{"line":41,"address":[13052064,13051960],"length":1,"stats":{"Line":16}},{"line":42,"address":[13051849,13051784],"length":1,"stats":{"Line":15}},{"line":43,"address":[13051873,13051941],"length":1,"stats":{"Line":18}},{"line":45,"address":[13052095],"length":1,"stats":{"Line":3}},{"line":46,"address":[13052204,13052275,13052328],"length":1,"stats":{"Line":23}},{"line":47,"address":[13023406],"length":1,"stats":{"Line":2}},{"line":48,"address":[13023455,13023376],"length":1,"stats":{"Line":14}},{"line":49,"address":[19611526],"length":1,"stats":{"Line":7}},{"line":50,"address":[19611506,19611558],"length":1,"stats":{"Line":10}},{"line":51,"address":[19611553],"length":1,"stats":{"Line":3}},{"line":52,"address":[13023496,13023457,13023489],"length":1,"stats":{"Line":8}},{"line":53,"address":[19611567],"length":1,"stats":{"Line":4}},{"line":55,"address":[19611560],"length":1,"stats":{"Line":0}},{"line":58,"address":[19611202],"length":1,"stats":{"Line":2}},{"line":62,"address":[14540936,14539808,14540942],"length":1,"stats":{"Line":2}},{"line":63,"address":[13021579],"length":1,"stats":{"Line":3}},{"line":66,"address":[14539941],"length":1,"stats":{"Line":10}},{"line":67,"address":[14443600,14443614],"length":1,"stats":{"Line":12}},{"line":68,"address":[13014014,13014000],"length":1,"stats":{"Line":12}},{"line":69,"address":[13021728],"length":1,"stats":{"Line":8}},{"line":70,"address":[14540025],"length":1,"stats":{"Line":6}},{"line":71,"address":[14535376,14535390],"length":1,"stats":{"Line":6}},{"line":72,"address":[13050731],"length":1,"stats":{"Line":6}},{"line":73,"address":[13013712,13013726],"length":1,"stats":{"Line":9}},{"line":74,"address":[13021853],"length":1,"stats":{"Line":2}},{"line":77,"address":[13050835],"length":1,"stats":{"Line":2}},{"line":79,"address":[14540307],"length":1,"stats":{"Line":2}},{"line":80,"address":[14540350,14540421],"length":1,"stats":{"Line":8}},{"line":81,"address":[14540555,14540477],"length":1,"stats":{"Line":5}},{"line":82,"address":[14540512,14540708],"length":1,"stats":{"Line":4}},{"line":83,"address":[19610755,19610287],"length":1,"stats":{"Line":7}},{"line":88,"address":[13014048,13014174,13014603],"length":1,"stats":{"Line":20}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[13014224,13014644,13014624],"length":1,"stats":{"Line":60}},{"line":99,"address":[14542419,14542384,14542259,14542224,14541984,14542304,14537028,14542099,14543219,14537556,14538612,14543059,14543299,14542579,14542019,14541779,14542739,14540196,14542339,14541744,14542544,14539140,14538084,14543264,14536492,14542704,14543184,14539668,14542064,14541252,14540724,14543024,14535956],"length":1,"stats":{"Line":56}},{"line":102,"address":[14444670,14448910,14445198,14447324,14448382,14444142,14447854,14446254,14449438,14446782,14445726],"length":1,"stats":{"Line":20}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[13014601,13014532],"length":1,"stats":{"Line":4}},{"line":108,"address":[13043495],"length":1,"stats":{"Line":20}},{"line":112,"address":[14469952,14457312,14476160,14479264,14482144,14479418,14467002,14485248,14469728,14473210,14454586,14460416,14457690,14454432,14457536,14482522,14451482,14466624,14475936,14451328,14482368,14470106,14454208,14463520,14460794,14463898,14466848,14479040,14476314,14472832,14473056,14460640,14463744],"length":1,"stats":{"Line":18}},{"line":119,"address":[13043819,13043917],"length":1,"stats":{"Line":36}},{"line":120,"address":[13043952,13044040],"length":1,"stats":{"Line":36}},{"line":122,"address":[14479876,14476772,14476673,14467361,14470465,14461252,14470564,14467460,14464257,14473569,14451940,14458049,14455044,14454945,14458148,14461153,14464356,14473668,14451841,14479777,14482980,14482881],"length":1,"stats":{"Line":32}},{"line":123,"address":[14467566,14452046,14458254,14476878,14479982,14464462,14473774,14483086,14455150,14461358,14470670],"length":1,"stats":{"Line":12}},{"line":124,"address":[13015558,13015657],"length":1,"stats":{"Line":24}},{"line":125,"address":[13015728],"length":1,"stats":{"Line":12}},{"line":128,"address":[13015801],"length":1,"stats":{"Line":12}},{"line":141,"address":[13015885],"length":1,"stats":{"Line":12}},{"line":142,"address":[13017805,13016014,13016044,13015953],"length":1,"stats":{"Line":24}},{"line":144,"address":[13016402],"length":1,"stats":{"Line":12}},{"line":146,"address":[14554167,14569687,14551063,14557271,14572791,14547959,14560375,14566583,14575895,14544855,14563479],"length":1,"stats":{"Line":12}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[13017218],"length":1,"stats":{"Line":12}},{"line":152,"address":[13016647],"length":1,"stats":{"Line":12}},{"line":153,"address":[13016679],"length":1,"stats":{"Line":12}},{"line":154,"address":[14557647,14548335,14576271,14566959,14573167,14545231,14560751,14570063,14551439,14563855,14554543],"length":1,"stats":{"Line":12}},{"line":155,"address":[14545367,14576407,14560887,14548471,14551575,14554679,14567095,14563991,14557783,14570199,14573303],"length":1,"stats":{"Line":12}},{"line":156,"address":[13016727],"length":1,"stats":{"Line":12}},{"line":157,"address":[13045759],"length":1,"stats":{"Line":12}},{"line":158,"address":[14567083,14576395,14545355,14548459,14573291,14557771,14563979,14554667,14570187,14551563,14560875],"length":1,"stats":{"Line":12}},{"line":160,"address":[14472231,14462919,14456711,14484647,14466023,14481543,14459815,14469127,14475335,14453607,14478439],"length":1,"stats":{"Line":12}},{"line":161,"address":[14561218,14558114,14561159,14558055,14551906,14545698,14573575,14567367,14551847,14570530,14576679,14576738,14564263,14573634,14564322,14570471,14554951,14567426,14545639,14548802,14548743,14555010],"length":1,"stats":{"Line":24}},{"line":162,"address":[13017202],"length":1,"stats":{"Line":12}},{"line":163,"address":[14463014,14459910,14481638,14475430,14466118,14456806,14478534,14472326,14484742,14453702,14469222],"length":1,"stats":{"Line":12}},{"line":166,"address":[13044434],"length":1,"stats":{"Line":6}},{"line":171,"address":[14581104,14595568,14586528,14584720,14583046,14577488,14577622,14586485,14591909,14588293,14579253,14590278,14593717,14581061,14581238,14584854,14584677,14595702,14582869,14586662,14590144,14597333,14579430,14591952,14593894,14579296,14593760,14595525,14588470,14592086,14582912,14588336,14590101],"length":1,"stats":{"Line":20}},{"line":178,"address":[14581207,14588439,14584823,14583015,14593863,14592055,14577591,14595671,14579399,14590247,14586631],"length":1,"stats":{"Line":20}},{"line":180,"address":[14509968,14496526,14498334,14510710,14485678,14514358,14508771,14506320,14492910,14510736,14514960,14515702,14514339,14507043,14509750,14513571,14513590,14489294,14507062,14494718,14507830,14511504,14491102,14501950,14505360,14506102,14506083,14511459,14507088,14500142,14508790,14515683,14512848,14509731,14503758,14487486,14513616,14510691,14507811,14512227,14508048,14511478,14509008,14512246],"length":1,"stats":{"Line":40}},{"line":181,"address":[13020035],"length":1,"stats":{"Line":20}},{"line":182,"address":[13020177,13020095],"length":1,"stats":{"Line":40}},{"line":184,"address":[14508487,14505712,14506759,14511856,14506672,14509360,14511088,14510320,14510407,14511175,14514055,14515399,14513200,14505799,14513287,14507440,14508400,14509447,14511943,14507527,14515312,14513968],"length":1,"stats":{"Line":36}},{"line":185,"address":[14512016,14513360,14507600,14505872,14515472,14508560,14509520,14506832,14510480,14514128,14511248],"length":1,"stats":{"Line":14}},{"line":186,"address":[14601502,14606110,14600350,14599582,14603998,14607838,14604766,14602270,14598046,14606878,14603038],"length":1,"stats":{"Line":6}},{"line":191,"address":[13047112,13047185],"length":1,"stats":{"Line":40}},{"line":192,"address":[14586865,14588673,14577825,14579633,14581441,14583249,14595905,14590481,14594097,14585057,14592289],"length":1,"stats":{"Line":18}},{"line":195,"address":[13047191],"length":1,"stats":{"Line":2}},{"line":197,"address":[13018367,13019792,13019833],"length":1,"stats":{"Line":6}},{"line":198,"address":[13048775],"length":1,"stats":{"Line":2}},{"line":199,"address":[13019933],"length":1,"stats":{"Line":2}},{"line":200,"address":[13048844],"length":1,"stats":{"Line":2}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[14603234,14604962,14598434,14598242,14598626,14607074,14600546,14605154,14598818,14605346,14600738],"length":1,"stats":{"Line":2}},{"line":203,"address":[13048826],"length":1,"stats":{"Line":2}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[13048832],"length":1,"stats":{"Line":2}},{"line":207,"address":[14506245,14509893,14512581,14508933,14507973,14512773,14512389,14515845,14514885,14514501,14514693],"length":1,"stats":{"Line":2}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[14504013,14489549,14494973,14491357,14498589,14487741,14500397,14496781,14493165,14485933,14502205],"length":1,"stats":{"Line":2}},{"line":216,"address":[13047478,13047430],"length":1,"stats":{"Line":4}},{"line":218,"address":[14589012,14585396,14583588,14594436,14579972,14596244,14581780,14592628,14578164,14587204,14590820],"length":1,"stats":{"Line":2}},{"line":219,"address":[13018697],"length":1,"stats":{"Line":2}},{"line":221,"address":[14486756,14488564,14499412,14490372,14492180,14493988,14497604,14501220,14503028,14495796,14504836],"length":1,"stats":{"Line":2}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[14498964,14502580,14495348,14486308,14488116,14493540,14489924,14500772,14504388,14491732,14497156],"length":1,"stats":{"Line":2}},{"line":224,"address":[13018864],"length":1,"stats":{"Line":2}},{"line":225,"address":[13047920],"length":1,"stats":{"Line":2}},{"line":226,"address":[13018872],"length":1,"stats":{"Line":2}},{"line":227,"address":[13018968],"length":1,"stats":{"Line":2}},{"line":228,"address":[14486464,14499120,14490080,14488272,14491888,14497312,14500928,14504544,14493696,14495504,14502736],"length":1,"stats":{"Line":2}},{"line":230,"address":[14587788,14582364,14589596,14595020,14584172,14596828,14578748,14580556,14591404,14585980,14593212],"length":1,"stats":{"Line":2}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[13019256],"length":1,"stats":{"Line":2}},{"line":233,"address":[13048192],"length":1,"stats":{"Line":2}},{"line":238,"address":[19609072],"length":1,"stats":{"Line":2}},{"line":239,"address":[19609108],"length":1,"stats":{"Line":4}},{"line":242,"address":[19609144],"length":1,"stats":{"Line":4}},{"line":247,"address":[13049983],"length":1,"stats":{"Line":4}},{"line":251,"address":[13021073],"length":1,"stats":{"Line":4}},{"line":252,"address":[13021309],"length":1,"stats":{"Line":4}},{"line":254,"address":[13021184],"length":1,"stats":{"Line":4}},{"line":259,"address":[13050037],"length":1,"stats":{"Line":2}},{"line":263,"address":[13021132],"length":1,"stats":{"Line":2}},{"line":267,"address":[13021155],"length":1,"stats":{"Line":2}}],"covered":115,"coverable":125},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","providers","completion.rs"],"content":"//! Completion provider for version suggestions\n\nuse chrono::{DateTime, Utc};\nuse tower_lsp::lsp_types::*;\n\nuse crate::cache::ReadCache;\nuse crate::parsers::Dependency;\n\n/// Format a release date as a human-readable age string\npub fn format_release_age(released_at: DateTime\u003cUtc\u003e) -\u003e String {\n    let now = Utc::now();\n    let duration = now.signed_duration_since(released_at);\n\n    let days = duration.num_days();\n    if days \u003c 0 {\n        return \"just now\".to_string();\n    }\n\n    if days == 0 {\n        let hours = duration.num_hours();\n        if hours == 0 {\n            let mins = duration.num_minutes();\n            if mins \u003c 1 {\n                return \"just now\".to_string();\n            }\n            return format!(\"{} min{} ago\", mins, if mins == 1 { \"\" } else { \"s\" });\n        }\n        return format!(\"{} hour{} ago\", hours, if hours == 1 { \"\" } else { \"s\" });\n    }\n\n    if days == 1 {\n        return \"yesterday\".to_string();\n    }\n\n    if days \u003c 7 {\n        return format!(\"{} days ago\", days);\n    }\n\n    if days \u003c 30 {\n        let weeks = days / 7;\n        return format!(\"{} week{} ago\", weeks, if weeks == 1 { \"\" } else { \"s\" });\n    }\n\n    if days \u003c 365 {\n        let months = days / 30;\n        return format!(\"{} month{} ago\", months, if months == 1 { \"\" } else { \"s\" });\n    }\n\n    let years = days / 365;\n    format!(\"{} year{} ago\", years, if years == 1 { \"\" } else { \"s\" })\n}\n\n/// Get completions for a position in the document\npub fn get_completions(\n    dependencies: \u0026[Dependency],\n    position: Position,\n    cache: \u0026impl ReadCache,\n    cache_key_fn: impl Fn(\u0026str) -\u003e String,\n) -\u003e Option\u003cVec\u003cCompletionItem\u003e\u003e {\n    // Find if we're inside a version field\n    let dep = dependencies.iter().find(|d| {\n        d.line == position.line\n            \u0026\u0026 position.character \u003e= d.version_start\n            \u0026\u0026 position.character \u003c= d.version_end\n    })?;\n\n    let cache_key = cache_key_fn(\u0026dep.name);\n    let version_info = cache.get(\u0026cache_key)?;\n\n    // Return the last 10 versions as completions\n    let items: Vec\u003cCompletionItem\u003e = version_info\n        .versions\n        .iter()\n        .take(10)\n        .enumerate()\n        .map(|(i, version)| {\n            let is_latest = i == 0;\n            let release_date = version_info.get_release_date(version);\n\n            // Build detail string with version and optional release age\n            let detail = match release_date {\n                Some(dt) =\u003e {\n                    let age = format_release_age(dt);\n                    if is_latest {\n                        format!(\"{} [Latest] - {}\", version, age)\n                    } else {\n                        format!(\"{} - {}\", version, age)\n                    }\n                }\n                None =\u003e {\n                    if is_latest {\n                        format!(\"{} [Latest]\", version)\n                    } else {\n                        format!(\"Version {}\", version)\n                    }\n                }\n            };\n\n            // Build documentation with more details\n            let documentation = {\n                let mut doc = String::new();\n                if is_latest {\n                    doc.push_str(\"**Latest stable version**\\n\\n\");\n                }\n                if let Some(dt) = release_date {\n                    let date_str = dt.format(\"%Y-%m-%d\").to_string();\n                    let age = format_release_age(dt);\n                    doc.push_str(\u0026format!(\"Released: {} ({})\", date_str, age));\n                }\n                if doc.is_empty() {\n                    None\n                } else {\n                    Some(Documentation::MarkupContent(MarkupContent {\n                        kind: MarkupKind::Markdown,\n                        value: doc,\n                    }))\n                }\n            };\n\n            CompletionItem {\n                label: version.clone(),\n                kind: Some(CompletionItemKind::CONSTANT),\n                detail: Some(detail),\n                documentation,\n                sort_text: Some(format!(\"{:04}\", i)), // Ensures correct ordering\n                insert_text: Some(version.clone()),\n                insert_text_format: Some(InsertTextFormat::PLAIN_TEXT),\n                ..Default::default()\n            }\n        })\n        .collect();\n\n    Some(items)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::cache::{MemoryCache, WriteCache};\n    use crate::registries::VersionInfo;\n    use chrono::Duration;\n    use std::collections::HashMap;\n\n    fn create_test_dependency(name: \u0026str, version: \u0026str, line: u32) -\u003e Dependency {\n        Dependency {\n            name: name.to_string(),\n            version: version.to_string(),\n            line,\n            name_start: 0,\n            name_end: name.len() as u32,\n            version_start: name.len() as u32 + 4,\n            version_end: name.len() as u32 + 4 + version.len() as u32,\n            dev: false,\n            optional: false,\n        }\n    }\n\n    #[test]\n    fn test_format_release_age_minutes() {\n        let now = Utc::now();\n        let released = now - Duration::minutes(30);\n        let age = format_release_age(released);\n        assert_eq!(age, \"30 mins ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_hours() {\n        let now = Utc::now();\n        let released = now - Duration::hours(5);\n        let age = format_release_age(released);\n        assert_eq!(age, \"5 hours ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_yesterday() {\n        let now = Utc::now();\n        let released = now - Duration::days(1);\n        let age = format_release_age(released);\n        assert_eq!(age, \"yesterday\");\n    }\n\n    #[test]\n    fn test_format_release_age_days() {\n        let now = Utc::now();\n        let released = now - Duration::days(5);\n        let age = format_release_age(released);\n        assert_eq!(age, \"5 days ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_weeks() {\n        let now = Utc::now();\n        let released = now - Duration::days(14);\n        let age = format_release_age(released);\n        assert_eq!(age, \"2 weeks ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_months() {\n        let now = Utc::now();\n        let released = now - Duration::days(60);\n        let age = format_release_age(released);\n        assert_eq!(age, \"2 months ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_years() {\n        let now = Utc::now();\n        let released = now - Duration::days(400);\n        let age = format_release_age(released);\n        assert_eq!(age, \"1 year ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_just_now() {\n        let now = Utc::now();\n        let age = format_release_age(now);\n        assert_eq!(age, \"just now\");\n    }\n\n    #[test]\n    fn test_get_completions() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.200\".to_string()),\n                versions: vec![\n                    \"1.0.200\".to_string(),\n                    \"1.0.199\".to_string(),\n                    \"1.0.198\".to_string(),\n                ],\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        // Position inside the version field\n        let position = Position {\n            line: 5,\n            character: 13, // Within version_start to version_end\n        };\n\n        let completions = get_completions(\u0026deps, position, \u0026cache, |name| format!(\"test:{}\", name));\n\n        assert!(completions.is_some());\n        let items = completions.unwrap();\n        assert_eq!(items.len(), 3);\n        assert_eq!(items[0].label, \"1.0.200\");\n        assert_eq!(items[1].label, \"1.0.199\");\n    }\n\n    #[test]\n    fn test_get_completions_with_release_dates() {\n        let cache = MemoryCache::new();\n        let now = Utc::now();\n        let mut release_dates = HashMap::new();\n        release_dates.insert(\"1.0.200\".to_string(), now - Duration::days(2));\n        release_dates.insert(\"1.0.199\".to_string(), now - Duration::days(10));\n\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.200\".to_string()),\n                versions: vec![\n                    \"1.0.200\".to_string(),\n                    \"1.0.199\".to_string(),\n                    \"1.0.198\".to_string(),\n                ],\n                release_dates,\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let position = Position {\n            line: 5,\n            character: 13,\n        };\n\n        let completions = get_completions(\u0026deps, position, \u0026cache, |name| format!(\"test:{}\", name));\n\n        assert!(completions.is_some());\n        let items = completions.unwrap();\n        assert_eq!(items.len(), 3);\n\n        // First item should have [Latest] and release date\n        assert!(items[0].detail.as_ref().unwrap().contains(\"[Latest]\"));\n        assert!(items[0].detail.as_ref().unwrap().contains(\"2 days ago\"));\n\n        // Second item should have release date but not [Latest]\n        assert!(!items[1].detail.as_ref().unwrap().contains(\"[Latest]\"));\n        assert!(items[1].detail.as_ref().unwrap().contains(\"1 week ago\"));\n\n        // Third item has no release date\n        assert!(!items[2].detail.as_ref().unwrap().contains(\"[Latest]\"));\n        assert_eq!(items[2].detail.as_ref().unwrap(), \"Version 1.0.198\");\n    }\n\n    #[test]\n    fn test_no_completions_outside_version() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.200\".to_string()),\n                versions: vec![\"1.0.200\".to_string()],\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        // Position outside the version field\n        let position = Position {\n            line: 5,\n            character: 0, // At the start, not in version\n        };\n\n        let completions = get_completions(\u0026deps, position, \u0026cache, |name| format!(\"test:{}\", name));\n\n        assert!(completions.is_none());\n    }\n\n    #[test]\n    fn test_no_completions_wrong_line() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.200\".to_string()),\n                versions: vec![\"1.0.200\".to_string()],\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let position = Position {\n            line: 10, // Wrong line\n            character: 13,\n        };\n\n        let completions = get_completions(\u0026deps, position, \u0026cache, |name| format!(\"test:{}\", name));\n\n        assert!(completions.is_none());\n    }\n\n    #[test]\n    fn test_no_completions_no_cache() {\n        let cache = MemoryCache::new();\n        let deps = vec![create_test_dependency(\"unknown\", \"1.0.0\", 5)];\n        let position = Position {\n            line: 5,\n            character: 13,\n        };\n\n        let completions = get_completions(\u0026deps, position, \u0026cache, |name| format!(\"test:{}\", name));\n\n        assert!(completions.is_none());\n    }\n\n    #[test]\n    fn test_format_release_age_1_hour() {\n        let now = Utc::now();\n        let released = now - Duration::hours(1);\n        let age = format_release_age(released);\n        assert_eq!(age, \"1 hour ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_1_minute() {\n        let now = Utc::now();\n        let released = now - Duration::minutes(1);\n        let age = format_release_age(released);\n        assert_eq!(age, \"1 min ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_1_week() {\n        let now = Utc::now();\n        let released = now - Duration::days(7);\n        let age = format_release_age(released);\n        assert_eq!(age, \"1 week ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_1_month() {\n        let now = Utc::now();\n        let released = now - Duration::days(30);\n        let age = format_release_age(released);\n        assert_eq!(age, \"1 month ago\");\n    }\n\n    #[test]\n    fn test_format_release_age_future_date() {\n        let now = Utc::now();\n        let released = now + Duration::days(5);\n        let age = format_release_age(released);\n        assert_eq!(age, \"just now\");\n    }\n\n    #[test]\n    fn test_completions_many_versions() {\n        let cache = MemoryCache::new();\n        let versions: Vec\u003cString\u003e = (0..20).map(|i| format!(\"1.0.{}\", 20 - i)).collect();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.20\".to_string()),\n                versions,\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let position = Position {\n            line: 5,\n            character: 13,\n        };\n\n        let completions = get_completions(\u0026deps, position, \u0026cache, |name| format!(\"test:{}\", name));\n\n        assert!(completions.is_some());\n        let items = completions.unwrap();\n        assert_eq!(items.len(), 10);\n    }\n}\n","traces":[{"line":10,"address":[12937456],"length":1,"stats":{"Line":2}},{"line":11,"address":[14187445],"length":1,"stats":{"Line":3}},{"line":12,"address":[14169173],"length":1,"stats":{"Line":5}},{"line":14,"address":[14187537],"length":1,"stats":{"Line":8}},{"line":15,"address":[14187552],"length":1,"stats":{"Line":9}},{"line":16,"address":[12937605],"length":1,"stats":{"Line":0}},{"line":19,"address":[14187560],"length":1,"stats":{"Line":10}},{"line":20,"address":[14169309],"length":1,"stats":{"Line":6}},{"line":21,"address":[14187612],"length":1,"stats":{"Line":6}},{"line":22,"address":[14169351],"length":1,"stats":{"Line":4}},{"line":23,"address":[14949717],"length":1,"stats":{"Line":4}},{"line":24,"address":[14169407],"length":1,"stats":{"Line":2}},{"line":26,"address":[14169393,14169430],"length":1,"stats":{"Line":2}},{"line":28,"address":[12938006,12937695],"length":1,"stats":{"Line":2}},{"line":31,"address":[14949685],"length":1,"stats":{"Line":5}},{"line":32,"address":[14169952],"length":1,"stats":{"Line":2}},{"line":35,"address":[12938294],"length":1,"stats":{"Line":5}},{"line":36,"address":[14188288],"length":1,"stats":{"Line":2}},{"line":39,"address":[12938302],"length":1,"stats":{"Line":3}},{"line":40,"address":[14170910,14170150,14170874],"length":1,"stats":{"Line":4}},{"line":41,"address":[14170897,14170923],"length":1,"stats":{"Line":4}},{"line":44,"address":[12938456],"length":1,"stats":{"Line":2}},{"line":45,"address":[14170594,14170558,14170209],"length":1,"stats":{"Line":4}},{"line":46,"address":[14950958,14950932],"length":1,"stats":{"Line":2}},{"line":49,"address":[14170242,14170278,14170183],"length":1,"stats":{"Line":4}},{"line":50,"address":[14188579,14188553],"length":1,"stats":{"Line":4}},{"line":54,"address":[19061963,19060096,19060232,19062000,19062122,19059115,19061056,19061178,19062907,19060059,19061019,19059274,19059152,19058330,19058208],"length":1,"stats":{"Line":8}},{"line":61,"address":[19061155,19059325,19071008,19058381,19060086,19060209,19062934,19062099,19062173,19061046,19058307,19059251,19061229,19059142,19061990,19082992,19066864,19075040,19070896,19060283],"length":1,"stats":{"Line":28}},{"line":62,"address":[19066884,19070916,19070929,19075073,19083012,19066897,19071041,19083025,19071028,19075060],"length":1,"stats":{"Line":12}},{"line":63,"address":[14187362],"length":1,"stats":{"Line":6}},{"line":64,"address":[19075114,19071082,19070970,19066938,19083066],"length":1,"stats":{"Line":4}},{"line":67,"address":[14182718],"length":1,"stats":{"Line":4}},{"line":68,"address":[19061518,19061434,19059614,19059530,19058586,19058670,19060572,19060488,19062462,19062378],"length":1,"stats":{"Line":8}},{"line":71,"address":[14183037],"length":1,"stats":{"Line":4}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[19075152,19066976,19071161,19082948,19074996,19059002,19071120,19080960,19059946,19068864,19079072,19075193,19077040,19062794,19066820,19062985,19061850,19067017,19070852,19060906,19079028,19064832,19073008,19062944,19079113],"length":1,"stats":{"Line":12}},{"line":77,"address":[14165203],"length":1,"stats":{"Line":4}},{"line":78,"address":[14897961,14902329,14894041,14906249,14890121],"length":1,"stats":{"Line":4}},{"line":81,"address":[14183560],"length":1,"stats":{"Line":4}},{"line":82,"address":[19067183,19063151,19071327,19075359,19079279],"length":1,"stats":{"Line":2}},{"line":83,"address":[19067207,19079303,19063175,19071351,19075383],"length":1,"stats":{"Line":2}},{"line":84,"address":[14898110,14894190,14894980,14890270,14906398,14898900,14907188,14902478,14891060,14903268],"length":1,"stats":{"Line":4}},{"line":85,"address":[14907040,14894575,14902863,14890655,14898752,14906783,14890912,14898495,14903120,14894832],"length":1,"stats":{"Line":4}},{"line":87,"address":[14184001,14184139],"length":1,"stats":{"Line":4}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[14165393,14165544],"length":1,"stats":{"Line":8}},{"line":92,"address":[14165549],"length":1,"stats":{"Line":2}},{"line":94,"address":[14890297,14898137,14902505,14894217,14906425],"length":1,"stats":{"Line":4}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[19063552,19079680,19075760,19071728,19067584],"length":1,"stats":{"Line":4}},{"line":102,"address":[19068102,19064070,19080198,19076278,19072246],"length":1,"stats":{"Line":4}},{"line":103,"address":[19076390,19068214,19080310,19072287,19080239,19064182,19076319,19068143,19072358,19064111],"length":1,"stats":{"Line":8}},{"line":105,"address":[14166228,14166330],"length":1,"stats":{"Line":6}},{"line":106,"address":[14899088,14903456,14907449,14903529,14891248,14907376,14895241,14895168,14899161,14891321],"length":1,"stats":{"Line":4}},{"line":107,"address":[14166549],"length":1,"stats":{"Line":2}},{"line":108,"address":[14903783,14907616,14907703,14903696,14891575,14899415,14895408,14895495,14891488,14899328],"length":1,"stats":{"Line":4}},{"line":110,"address":[14166401,14167008,14167266],"length":1,"stats":{"Line":12}},{"line":111,"address":[14185556],"length":1,"stats":{"Line":4}},{"line":113,"address":[19068940,19077116,19073084,19081036,19064908],"length":1,"stats":{"Line":4}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[14167018],"length":1,"stats":{"Line":4}},{"line":120,"address":[19069790,19073934,19077966,19065758,19081886],"length":1,"stats":{"Line":4}},{"line":121,"address":[19073406,19069262,19065230,19077438,19065146,19077354,19081358,19069178,19073322,19081274],"length":1,"stats":{"Line":8}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[19073414,19065238,19069270,19077446,19081366],"length":1,"stats":{"Line":4}},{"line":124,"address":[14185766],"length":1,"stats":{"Line":4}},{"line":125,"address":[14185887,14185819],"length":1,"stats":{"Line":8}},{"line":126,"address":[14186114,14186049],"length":1,"stats":{"Line":8}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[14167874],"length":1,"stats":{"Line":4}},{"line":133,"address":[14164976],"length":1,"stats":{"Line":4}}],"covered":64,"coverable":71},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","providers","diagnostics.rs"],"content":"//! Diagnostics provider for outdated dependencies and vulnerabilities\n\nuse tower_lsp::lsp_types::*;\n\nuse crate::cache::ReadCache;\nuse crate::parsers::Dependency;\nuse crate::providers::inlay_hints::{VersionStatus, compare_versions, is_local_dependency};\nuse crate::registries::{VersionInfo, Vulnerability, VulnerabilitySeverity};\nuse crate::utils::truncate_string;\n\n/// Create diagnostics for a list of dependencies\n///\n/// The `min_severity` parameter filters vulnerabilities to only show those\n/// at or above the specified severity level.\npub fn create_diagnostics(\n    dependencies: \u0026[Dependency],\n    cache: \u0026impl ReadCache,\n    cache_key_fn: impl Fn(\u0026str) -\u003e String,\n    min_severity: Option\u003cVulnerabilitySeverity\u003e,\n) -\u003e Vec\u003cDiagnostic\u003e {\n    let mut diagnostics = Vec::new();\n\n    for dep in dependencies {\n        // Show informational diagnostic for local/path dependencies\n        if is_local_dependency(\u0026dep.version) {\n            diagnostics.push(create_local_dependency_diagnostic(dep));\n            continue;\n        }\n\n        // Add outdated version diagnostic\n        if let Some(diag) = create_outdated_diagnostic(dep, cache, \u0026cache_key_fn) {\n            diagnostics.push(diag);\n        }\n\n        let cache_key = cache_key_fn(\u0026dep.name);\n        if let Some(version_info) = cache.get(\u0026cache_key) {\n            // Add yanked version diagnostic (highest priority)\n            if version_info.is_version_yanked(\u0026dep.version) {\n                tracing::debug!(\n                    \"Package {} {} is yanked, creating diagnostic\",\n                    dep.name,\n                    dep.version\n                );\n                diagnostics.push(create_yanked_diagnostic(dep, \u0026version_info));\n            } else if version_info.deprecated {\n                // Add deprecation diagnostic\n                tracing::debug!(\n                    \"Package {} {} is deprecated, creating diagnostic\",\n                    dep.name,\n                    dep.version\n                );\n                diagnostics.push(create_deprecation_diagnostic(dep, \u0026version_info));\n            } else {\n                // Add vulnerability diagnostic (summary) only if not deprecated or yanked\n                let filtered_vulns: Vec\u003c_\u003e = version_info\n                    .vulnerabilities\n                    .iter()\n                    .filter(|vuln| {\n                        min_severity\n                            .as_ref()\n                            .map(|min| meets_severity_threshold(\u0026vuln.severity, min))\n                            .unwrap_or(true)\n                    })\n                    .collect();\n\n                if !filtered_vulns.is_empty() {\n                    diagnostics.push(create_vulnerability_summary_diagnostic(\n                        dep,\n                        \u0026filtered_vulns,\n                    ));\n                }\n            }\n        }\n    }\n\n    diagnostics\n}\n\n/// Check if a vulnerability severity meets the minimum threshold\nfn meets_severity_threshold(severity: \u0026VulnerabilitySeverity, min: \u0026VulnerabilitySeverity) -\u003e bool {\n    severity.meets_threshold(min)\n}\n\n/// Create a diagnostic for an outdated dependency\nfn create_outdated_diagnostic(\n    dep: \u0026Dependency,\n    cache: \u0026impl ReadCache,\n    cache_key_fn: impl Fn(\u0026str) -\u003e String,\n) -\u003e Option\u003cDiagnostic\u003e {\n    let cache_key = cache_key_fn(\u0026dep.name);\n    let version_info = cache.get(\u0026cache_key)?;\n\n    match compare_versions(\u0026dep.version, \u0026version_info) {\n        VersionStatus::UpdateAvailable(new_version) =\u003e Some(Diagnostic {\n            range: Range {\n                start: Position {\n                    line: dep.line,\n                    character: dep.version_start,\n                },\n                end: Position {\n                    line: dep.line,\n                    character: dep.version_end,\n                },\n            },\n            severity: Some(DiagnosticSeverity::HINT),\n            code: Some(NumberOrString::String(\"outdated\".to_string())),\n            source: Some(\"dependi\".to_string()),\n            message: format!(\"Update available: {} -\u003e {}\", dep.version, new_version),\n            related_information: None,\n            tags: None,\n            code_description: None,\n            data: None,\n        }),\n        VersionStatus::UpToDate | VersionStatus::Unknown =\u003e None,\n    }\n}\n\n/// Create a diagnostic for a local/path dependency\nfn create_local_dependency_diagnostic(dep: \u0026Dependency) -\u003e Diagnostic {\n    Diagnostic {\n        range: Range {\n            start: Position {\n                line: dep.line,\n                character: dep.version_start,\n            },\n            end: Position {\n                line: dep.line,\n                character: dep.version_end,\n            },\n        },\n        severity: Some(DiagnosticSeverity::HINT),\n        code: Some(NumberOrString::String(\"local\".to_string())),\n        source: Some(\"dependi\".to_string()),\n        message: \"→ Local\".to_string(),\n        related_information: None,\n        tags: None,\n        code_description: None,\n        data: None,\n    }\n}\n\n/// Create a diagnostic for a deprecated package\nfn create_deprecation_diagnostic(dep: \u0026Dependency, version_info: \u0026VersionInfo) -\u003e Diagnostic {\n    let mut message = format!(\n        \"The package '{}' is deprecated. Consider migrating to an alternative.\",\n        dep.name\n    );\n\n    if let Some(latest) = \u0026version_info.latest {\n        message.push_str(\u0026format!(\n            \" Latest version: {} (may not be deprecated).\",\n            latest\n        ));\n    }\n\n    let mut related_info = Vec::new();\n\n    if let Some(homepage) = \u0026version_info.homepage {\n        related_info.push(DiagnosticRelatedInformation {\n            location: Location {\n                uri: Url::parse(homepage).unwrap_or_else(|_| {\n                    Url::parse(\"https://example.com\").expect(\"Invalid fallback URL\")\n                }),\n                range: Range::default(),\n            },\n            message: \"Visit package homepage\".to_string(),\n        });\n    }\n\n    if let Some(repo) = \u0026version_info.repository {\n        related_info.push(DiagnosticRelatedInformation {\n            location: Location {\n                uri: Url::parse(repo).unwrap_or_else(|_| {\n                    Url::parse(\"https://github.com\").expect(\"Invalid fallback URL\")\n                }),\n                range: Range::default(),\n            },\n            message: \"View repository for migration guide\".to_string(),\n        });\n    }\n\n    Diagnostic {\n        range: Range {\n            start: Position {\n                line: dep.line,\n                character: dep.version_start,\n            },\n            end: Position {\n                line: dep.line,\n                character: dep.version_end,\n            },\n        },\n        severity: Some(DiagnosticSeverity::WARNING),\n        code: Some(NumberOrString::String(\"deprecated-package\".to_string())),\n        source: Some(\"dependi\".to_string()),\n        message,\n        related_information: if related_info.is_empty() {\n            None\n        } else {\n            Some(related_info)\n        },\n        tags: None,\n        code_description: None,\n        data: None,\n    }\n}\n\n/// Create a diagnostic for a yanked version\nfn create_yanked_diagnostic(dep: \u0026Dependency, version_info: \u0026VersionInfo) -\u003e Diagnostic {\n    let mut message = format!(\n        \"The version '{}' of '{}' has been yanked from crates.io and should not be used.\",\n        dep.version, dep.name\n    );\n\n    if let Some(latest) = \u0026version_info.latest {\n        message.push_str(\u0026format!(\" Update to {}.\", latest));\n    }\n\n    let crates_io_url = format!(\"https://crates.io/crates/{}\", dep.name);\n    let mut related_info = vec![DiagnosticRelatedInformation {\n        location: Location {\n            uri: Url::parse(\u0026crates_io_url)\n                .unwrap_or_else(|_| Url::parse(\"https://crates.io\").expect(\"Invalid fallback URL\")),\n            range: Range::default(),\n        },\n        message: \"View package on crates.io\".to_string(),\n    }];\n\n    if let Some(repo) = \u0026version_info.repository {\n        related_info.push(DiagnosticRelatedInformation {\n            location: Location {\n                uri: Url::parse(repo).unwrap_or_else(|_| {\n                    Url::parse(\"https://github.com\").expect(\"Invalid fallback URL\")\n                }),\n                range: Range::default(),\n            },\n            message: \"View repository for more information\".to_string(),\n        });\n    }\n\n    Diagnostic {\n        range: Range {\n            start: Position {\n                line: dep.line,\n                character: dep.version_start,\n            },\n            end: Position {\n                line: dep.line,\n                character: dep.version_end,\n            },\n        },\n        severity: Some(DiagnosticSeverity::WARNING),\n        code: Some(NumberOrString::String(\"yanked-version\".to_string())),\n        source: Some(\"dependi\".to_string()),\n        message,\n        related_information: Some(related_info),\n        tags: None,\n        code_description: Some(CodeDescription {\n            href: Url::parse(\u0026crates_io_url)\n                .unwrap_or_else(|_| Url::parse(\"https://crates.io\").expect(\"Invalid fallback URL\")),\n        }),\n        data: None,\n    }\n}\n\n/// Create a summary diagnostic for multiple vulnerabilities\nfn create_vulnerability_summary_diagnostic(\n    dep: \u0026Dependency,\n    vulns: \u0026[\u0026Vulnerability],\n) -\u003e Diagnostic {\n    let count = vulns.len();\n\n    // Use the highest severity among all vulnerabilities\n    let severity_to_num = |s: \u0026VulnerabilitySeverity| match s {\n        VulnerabilitySeverity::Critical =\u003e 4,\n        VulnerabilitySeverity::High =\u003e 3,\n        VulnerabilitySeverity::Medium =\u003e 2,\n        VulnerabilitySeverity::Low =\u003e 1,\n    };\n    let max_severity = vulns\n        .iter()\n        .map(|v| \u0026v.severity)\n        .max_by_key(|s| severity_to_num(s))\n        .unwrap_or(\u0026VulnerabilitySeverity::Low);\n\n    let diagnostic_severity = match max_severity {\n        VulnerabilitySeverity::Critical | VulnerabilitySeverity::High =\u003e DiagnosticSeverity::ERROR,\n        VulnerabilitySeverity::Medium =\u003e DiagnosticSeverity::WARNING,\n        VulnerabilitySeverity::Low =\u003e DiagnosticSeverity::HINT,\n    };\n\n    // Build summary message\n    let vuln_word = if count == 1 { \"vuln\" } else { \"vulns\" };\n    let vuln_ids: Vec\u003c_\u003e = vulns.iter().map(|v| v.id.as_str()).collect();\n    let message = format!(\"⚠ {} {}: {}\", count, vuln_word, vuln_ids.join(\", \"));\n\n    // Collect related information for all vulnerabilities\n    let related_info: Vec\u003c_\u003e = vulns\n        .iter()\n        .filter_map(|vuln| {\n            vuln.url.as_ref().map(|url| DiagnosticRelatedInformation {\n                location: Location {\n                    uri: Url::parse(url).unwrap_or_else(|_| {\n                        Url::parse(\"https://osv.dev\").expect(\"Invalid fallback URL\")\n                    }),\n                    range: Range::default(),\n                },\n                message: format!(\"{}: {}\", vuln.id, truncate_string(\u0026vuln.description, 80)),\n            })\n        })\n        .collect();\n\n    Diagnostic {\n        range: Range {\n            start: Position {\n                line: dep.line,\n                character: dep.version_start,\n            },\n            end: Position {\n                line: dep.line,\n                character: dep.version_end,\n            },\n        },\n        severity: Some(diagnostic_severity),\n        code: Some(NumberOrString::String(format!(\"{}-vulns\", count))),\n        source: Some(\"dependi-security\".to_string()),\n        message,\n        related_information: if related_info.is_empty() {\n            None\n        } else {\n            Some(related_info)\n        },\n        tags: None,\n        code_description: vulns.first().and_then(|v| {\n            v.url\n                .as_ref()\n                .and_then(|url| Url::parse(url).ok().map(|href| CodeDescription { href }))\n        }),\n        data: None,\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::cache::{MemoryCache, WriteCache};\n    use crate::registries::VersionInfo;\n\n    fn create_test_dependency(name: \u0026str, version: \u0026str, line: u32) -\u003e Dependency {\n        Dependency {\n            name: name.to_string(),\n            version: version.to_string(),\n            line,\n            name_start: 0,\n            name_end: name.len() as u32,\n            version_start: name.len() as u32 + 4,\n            version_end: name.len() as u32 + 4 + version.len() as u32,\n            dev: false,\n            optional: false,\n        }\n    }\n\n    #[test]\n    fn test_create_diagnostic_outdated() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        assert_eq!(diagnostics.len(), 1);\n        assert!(diagnostics[0].message.contains(\"2.0.0\"));\n        assert_eq!(diagnostics[0].severity, Some(DiagnosticSeverity::HINT));\n    }\n\n    #[test]\n    fn test_no_diagnostic_up_to_date() {\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        assert_eq!(diagnostics.len(), 0);\n    }\n\n    #[test]\n    fn test_no_diagnostic_no_cache() {\n        let cache = MemoryCache::new();\n        let deps = vec![create_test_dependency(\"unknown\", \"1.0.0\", 5)];\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        assert_eq!(diagnostics.len(), 0);\n    }\n\n    #[test]\n    fn test_severity_filtering() {\n        assert!(meets_severity_threshold(\n            \u0026VulnerabilitySeverity::Critical,\n            \u0026VulnerabilitySeverity::Low\n        ));\n        assert!(meets_severity_threshold(\n            \u0026VulnerabilitySeverity::High,\n            \u0026VulnerabilitySeverity::Medium\n        ));\n        assert!(!meets_severity_threshold(\n            \u0026VulnerabilitySeverity::Low,\n            \u0026VulnerabilitySeverity::High\n        ));\n        assert!(meets_severity_threshold(\n            \u0026VulnerabilitySeverity::Medium,\n            \u0026VulnerabilitySeverity::Medium\n        ));\n    }\n\n    #[test]\n    fn test_deprecated_diagnostic() {\n        let deps = vec![create_test_dependency(\"old-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:old-dep\".to_string(),\n            VersionInfo {\n                deprecated: true,\n                latest: Some(\"2.0.0\".to_string()),\n                homepage: Some(\"https://example.com\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let deprecation_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"deprecated\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(deprecation_diags.len(), 1);\n        assert!(deprecation_diags[0].message.contains(\"deprecated\"));\n        assert_eq!(\n            deprecation_diags[0].severity,\n            Some(DiagnosticSeverity::WARNING)\n        );\n        assert!(deprecation_diags[0].related_information.is_some());\n    }\n\n    #[test]\n    fn test_no_deprecated_diagnostic_for_active() {\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                deprecated: false,\n                latest: Some(\"1.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let deprecation_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"deprecated\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(deprecation_diags.len(), 0);\n    }\n\n    #[test]\n    fn test_deprecated_with_vulnerabilities() {\n        let deps = vec![create_test_dependency(\"vuln-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:vuln-dep\".to_string(),\n            VersionInfo {\n                deprecated: true,\n                vulnerabilities: vec![Vulnerability {\n                    id: \"CVE-2024-1234\".to_string(),\n                    severity: VulnerabilitySeverity::High,\n                    description: \"Test vulnerability\".to_string(),\n                    url: None,\n                }],\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let deprecation_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"deprecated\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.starts_with(\"CVE\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(deprecation_diags.len(), 1);\n        assert_eq!(\n            vuln_diags.len(),\n            0,\n            \"Deprecated packages should not show individual vulnerability diagnostics\"\n        );\n    }\n\n    #[test]\n    fn test_yanked_diagnostic() {\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                yanked_versions: vec![\"1.0.0\".to_string()],\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let yanked_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"yanked\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(yanked_diags.len(), 1);\n        assert!(yanked_diags[0].message.contains(\"yanked\"));\n        assert_eq!(yanked_diags[0].severity, Some(DiagnosticSeverity::WARNING));\n    }\n\n    #[test]\n    fn test_no_yanked_diagnostic_for_non_yanked() {\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                yanked_versions: vec![\"0.9.0\".to_string()],\n                latest: Some(\"1.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let yanked_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"yanked\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(yanked_diags.len(), 0);\n    }\n\n    #[test]\n    fn test_yanked_priority_over_deprecated_diagnostic() {\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                yanked_versions: vec![\"1.0.0\".to_string()],\n                deprecated: true,\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let yanked_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"yanked\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        let deprecated_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"deprecated\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(yanked_diags.len(), 1, \"Should show yanked diagnostic\");\n        assert_eq!(\n            deprecated_diags.len(),\n            0,\n            \"Yanked packages should not show deprecated diagnostic\"\n        );\n    }\n\n    #[test]\n    fn test_yanked_priority_over_vulnerabilities_diagnostic() {\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                yanked_versions: vec![\"1.0.0\".to_string()],\n                vulnerabilities: vec![Vulnerability {\n                    id: \"CVE-2024-1234\".to_string(),\n                    severity: VulnerabilitySeverity::High,\n                    description: \"Test vulnerability\".to_string(),\n                    url: None,\n                }],\n                latest: Some(\"2.0.0\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let yanked_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.contains(\"yanked\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .and_then(|c| match c {\n                        NumberOrString::String(s) =\u003e Some(s.starts_with(\"CVE\")),\n                        _ =\u003e None,\n                    })\n                    .unwrap_or(false)\n            })\n            .collect();\n\n        assert_eq!(yanked_diags.len(), 1, \"Should show yanked diagnostic\");\n        assert_eq!(\n            vuln_diags.len(),\n            0,\n            \"Yanked packages should not show vulnerability diagnostics\"\n        );\n    }\n\n    #[test]\n    fn test_local_dependency_diagnostic() {\n        let deps = vec![create_test_dependency(\"local-crate\", \"../local\", 5)];\n        let cache = MemoryCache::new();\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        assert_eq!(diagnostics.len(), 1);\n        assert!(diagnostics[0].message.contains(\"Local\"));\n        assert_eq!(diagnostics[0].severity, Some(DiagnosticSeverity::HINT));\n    }\n\n    #[test]\n    fn test_vulnerability_summary_diagnostic() {\n        let deps = vec![create_test_dependency(\"vuln-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:vuln-dep\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                vulnerabilities: vec![\n                    Vulnerability {\n                        id: \"CVE-2024-1234\".to_string(),\n                        severity: VulnerabilitySeverity::High,\n                        description: \"High severity vulnerability\".to_string(),\n                        url: Some(\"https://osv.dev/CVE-2024-1234\".to_string()),\n                    },\n                    Vulnerability {\n                        id: \"CVE-2024-5678\".to_string(),\n                        severity: VulnerabilitySeverity::Medium,\n                        description: \"Medium severity vulnerability\".to_string(),\n                        url: None,\n                    },\n                ],\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"vulns\")))\n            })\n            .collect();\n\n        assert_eq!(vuln_diags.len(), 1);\n        assert!(vuln_diags[0].message.contains(\"2 vulns\"));\n        assert_eq!(vuln_diags[0].severity, Some(DiagnosticSeverity::ERROR));\n        assert!(vuln_diags[0].related_information.is_some());\n    }\n\n    #[test]\n    fn test_vulnerability_severity_filtering() {\n        let deps = vec![create_test_dependency(\"vuln-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:vuln-dep\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                vulnerabilities: vec![\n                    Vulnerability {\n                        id: \"CVE-2024-LOW\".to_string(),\n                        severity: VulnerabilitySeverity::Low,\n                        description: \"Low severity\".to_string(),\n                        url: None,\n                    },\n                    Vulnerability {\n                        id: \"CVE-2024-HIGH\".to_string(),\n                        severity: VulnerabilitySeverity::High,\n                        description: \"High severity\".to_string(),\n                        url: None,\n                    },\n                ],\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\n            \u0026deps,\n            \u0026cache,\n            |name| format!(\"test:{}\", name),\n            Some(VulnerabilitySeverity::High),\n        );\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"vulns\")))\n            })\n            .collect();\n\n        assert_eq!(vuln_diags.len(), 1);\n        assert!(vuln_diags[0].message.contains(\"1 vuln\"));\n    }\n\n    #[test]\n    fn test_deprecation_diagnostic_with_repository() {\n        let deps = vec![create_test_dependency(\"old-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:old-dep\".to_string(),\n            VersionInfo {\n                deprecated: true,\n                latest: Some(\"2.0.0\".to_string()),\n                repository: Some(\"https://github.com/user/old-dep\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let deprecation_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"deprecated\")))\n            })\n            .collect();\n\n        assert_eq!(deprecation_diags.len(), 1);\n        assert!(deprecation_diags[0].related_information.is_some());\n        let related = deprecation_diags[0].related_information.as_ref().unwrap();\n        assert!(!related.is_empty());\n    }\n\n    #[test]\n    fn test_yanked_diagnostic_with_repository() {\n        let deps = vec![create_test_dependency(\"serde\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:serde\".to_string(),\n            VersionInfo {\n                yanked_versions: vec![\"1.0.0\".to_string()],\n                latest: Some(\"2.0.0\".to_string()),\n                repository: Some(\"https://github.com/serde-rs/serde\".to_string()),\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let yanked_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"yanked\")))\n            })\n            .collect();\n\n        assert_eq!(yanked_diags.len(), 1);\n        assert!(yanked_diags[0].related_information.is_some());\n        let related = yanked_diags[0].related_information.as_ref().unwrap();\n        assert_eq!(related.len(), 2);\n    }\n\n    #[test]\n    fn test_vulnerability_low_severity_hint() {\n        let deps = vec![create_test_dependency(\"vuln-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:vuln-dep\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                vulnerabilities: vec![Vulnerability {\n                    id: \"CVE-2024-LOW\".to_string(),\n                    severity: VulnerabilitySeverity::Low,\n                    description: \"Low severity\".to_string(),\n                    url: None,\n                }],\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"vulns\")))\n            })\n            .collect();\n\n        assert_eq!(vuln_diags.len(), 1);\n        assert_eq!(vuln_diags[0].severity, Some(DiagnosticSeverity::HINT));\n    }\n\n    #[test]\n    fn test_vulnerability_medium_severity_warning() {\n        let deps = vec![create_test_dependency(\"vuln-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:vuln-dep\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                vulnerabilities: vec![Vulnerability {\n                    id: \"CVE-2024-MED\".to_string(),\n                    severity: VulnerabilitySeverity::Medium,\n                    description: \"Medium severity\".to_string(),\n                    url: None,\n                }],\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"vulns\")))\n            })\n            .collect();\n\n        assert_eq!(vuln_diags.len(), 1);\n        assert_eq!(vuln_diags[0].severity, Some(DiagnosticSeverity::WARNING));\n    }\n\n    #[test]\n    fn test_vulnerability_critical_severity_error() {\n        let deps = vec![create_test_dependency(\"vuln-dep\", \"1.0.0\", 5)];\n        let cache = MemoryCache::new();\n        cache.insert(\n            \"test:vuln-dep\".to_string(),\n            VersionInfo {\n                latest: Some(\"1.0.0\".to_string()),\n                vulnerabilities: vec![Vulnerability {\n                    id: \"CVE-2024-CRIT\".to_string(),\n                    severity: VulnerabilitySeverity::Critical,\n                    description: \"Critical severity\".to_string(),\n                    url: None,\n                }],\n                ..Default::default()\n            },\n        );\n\n        let diagnostics = create_diagnostics(\u0026deps, \u0026cache, |name| format!(\"test:{}\", name), None);\n\n        let vuln_diags: Vec\u003c_\u003e = diagnostics\n            .iter()\n            .filter(|d| {\n                d.code\n                    .as_ref()\n                    .is_some_and(|c| matches!(c, NumberOrString::String(s) if s.contains(\"vulns\")))\n            })\n            .collect();\n\n        assert_eq!(vuln_diags.len(), 1);\n        assert_eq!(vuln_diags[0].severity, Some(DiagnosticSeverity::ERROR));\n    }\n}\n","traces":[{"line":15,"address":[13061648,13063177,13061756],"length":1,"stats":{"Line":36}},{"line":21,"address":[13585449,13566857,13601401,13590761,13593425,13604057,13582793,13577481,13609369,13588105,13564201,13572169,13569513,13606713,13598745,13574825,13612025,13580137,13596089],"length":1,"stats":{"Line":36}},{"line":23,"address":[13061807,13061891],"length":1,"stats":{"Line":72}},{"line":25,"address":[13090933,13091035],"length":1,"stats":{"Line":72}},{"line":26,"address":[13062189,13064403],"length":1,"stats":{"Line":4}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[13062211,13062154],"length":1,"stats":{"Line":68}},{"line":32,"address":[13580670,13588676,13578052,13609902,13591332,13586020,13583326,13580708,13567428,13612558,13593996,13599316,13593958,13596622,13604590,13596660,13572702,13575358,13591294,13585982,13575396,13612596,13588638,13601972,13607246,13564772,13583364,13567390,13604628,13609940,13599278,13570084,13601934,13572740,13564734,13578014,13570046,13607284],"length":1,"stats":{"Line":28}},{"line":35,"address":[18766157,18734269,18736982,18734326,18731613,18744893,18728957,18768870,18758189,18750221,18755590,18731670,18739581,18750278,18747557,18768813,18755533,18723702,18742294,18771469,18726358,18752877,18760902,18729014,18742237,18744950,18747614,18760845,18736925,18758246,18723645,18739638,18771526,18726301,18763501,18766214,18752934,18763558],"length":1,"stats":{"Line":68}},{"line":36,"address":[18729128,18760917,18739653,18766328,18750392,18758360,18763573,18747629,18737096,18752949,18763672,18731784,18747728,18761016,18753048,18755605,18734341,18768984,18742408,18726472,18726373,18729029,18723816,18723717,18731685,18745064,18744965,18742309,18758261,18739752,18771640,18755704,18771541,18766229,18750293,18768885,18736997,18734440],"length":1,"stats":{"Line":68}},{"line":38,"address":[13091510,13091619],"length":1,"stats":{"Line":64}},{"line":39,"address":[13064061,13062742,13063800],"length":1,"stats":{"Line":16}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[18736247,18767805,18744215,18727949,18773117,18733261,18738903,18746871,18741229,18749543,18746541,18730605,18765479,18762823,18728279,18760167,18762493,18751869,18730935,18773447,18754525,18725293,18770461,18741559,18768135,18754855,18752199,18770791,18749211,18733591,18735917,18757511,18725623,18759837,18765149,18743885,18738573,18757181],"length":1,"stats":{"Line":16}},{"line":45,"address":[13062730],"length":1,"stats":{"Line":24}},{"line":47,"address":[13062808,13063451,13063190],"length":1,"stats":{"Line":12}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[18732663,18735651,18732995,18759239,18743619,18764551,18764883,18737975,18767207,18767539,18753927,18751271,18738307,18743287,18740631,18735319,18770195,18761895,18745943,18769863,18762227,18748945,18754259,18756915,18730339,18740963,18727351,18772519,18751603,18759571,18727683,18748613,18724695,18756583,18730007,18746275,18772851,18725027],"length":1,"stats":{"Line":12}},{"line":55,"address":[13062773],"length":1,"stats":{"Line":18}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[13614832,13597206,13616512,13594542,13616160,13617040,13581254,13613142,13570630,13599862,13616976,13614592,13616720,13575942,13615888,13610486,13602518,13617248,13616000,13615680,13605174,13567974,13591878,13614944,13589222,13583910,13617472,13614704,13607830,13565318,13617360,13578598,13586566,13614768,13573286,13615056,13615376,13615120],"length":1,"stats":{"Line":28}},{"line":59,"address":[18773714,18774274,18773826,18774402,18776210,18775698,18773986,18774162,18775234,18774722,18776482,18775394,18774610,18774882,18774098,18775858,18774338,18776274,18773650],"length":1,"stats":{"Line":10}},{"line":60,"address":[13093493],"length":1,"stats":{"Line":10}},{"line":61,"address":[13093550,13093536,13093506],"length":1,"stats":{"Line":14}},{"line":62,"address":[13093515],"length":1,"stats":{"Line":10}},{"line":66,"address":[13062952,13063029],"length":1,"stats":{"Line":36}},{"line":67,"address":[18727041,18750961,18735009,18764241,18748303,18724385,18740321,18756273,18761585,18753617,18772209,18758929,18769553,18729697,18737665,18742977,18732353,18766897,18745633],"length":1,"stats":{"Line":10}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[13063035],"length":1,"stats":{"Line":10}},{"line":76,"address":[13062048],"length":1,"stats":{"Line":36}},{"line":80,"address":[15094256],"length":1,"stats":{"Line":2}},{"line":81,"address":[13071454],"length":1,"stats":{"Line":2}},{"line":85,"address":[18801664,18800048,18793522,18796889,18788674,18801737,18782345,18780594,18791968,18787193,18791906,18806450,18808066,18787058,18779113,18798505,18806512,18780656,18782210,18803280,18796754,18804834,18800121,18778978,18785577,18799986,18796816,18798370,18803353,18777424,18801602,18792041,18793584,18804969,18783961,18788809,18798432,18788736,18785442,18785504,18804896,18787120,18795138,18806585,18795273,18777497,18790425,18783826,18795200,18783888,18803218,18790352,18790290,18780729,18793657,18782272,18779040],"length":1,"stats":{"Line":34}},{"line":90,"address":[18806568,18782403,18779096,18788867,18803411,18801795,18790408,18787251,18783944,18798488,18780787,18793640,18806643,18790483,18779171,18795256,18782328,18805027,18800104,18780712,18804952,18801720,18788792,18803336,18798563,18796872,18777555,18784019,18787176,18795331,18792024,18792099,18785560,18785635,18793715,18796947,18777480,18800179],"length":1,"stats":{"Line":68}},{"line":91,"address":[18806739,18805042,18792195,18801810,18805123,18788882,18784115,18798659,18777570,18779186,18795346,18798578,18785650,18803426,18793811,18787347,18780802,18800194,18784034,18790498,18806658,18785731,18780883,18779267,18790579,18782418,18787266,18782499,18803507,18788963,18793730,18801891,18797043,18795427,18800275,18796962,18777651,18792114],"length":1,"stats":{"Line":68}},{"line":93,"address":[13630311,13644768,13630224,13620528,13625376,13633543,13633456,13631840,13643152,13627079,13643239,13641536,13626992,13641623,13628695,13618999,13635072,13646384,13639920,13623847,13648000,13640007,13636775,13623760,13625463,13620615,13638304,13618912,13644855,13628608,13636688,13638391,13631927,13622144,13622231,13648087,13646471,13635159],"length":1,"stats":{"Line":64}},{"line":94,"address":[13095052,13094451],"length":1,"stats":{"Line":28}},{"line":95,"address":[13094492],"length":1,"stats":{"Line":14}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[13065555],"length":1,"stats":{"Line":14}},{"line":98,"address":[13094486],"length":1,"stats":{"Line":14}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[18797425,18800657,18789345,18786113,18799041,18805505,18792577,18778033,18802273,18795809,18787729,18807121,18781265,18790961,18803889,18782881,18779649,18784497,18794193],"length":1,"stats":{"Line":14}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[18792608,18787760,18784528,18787835,18779680,18807152,18807227,18789376,18800688,18799147,18778064,18805536,18789451,18786219,18792683,18784603,18779755,18797456,18797531,18786144,18794224,18782912,18790992,18794299,18795915,18803995,18778139,18799072,18802379,18802304,18781371,18791067,18781296,18795840,18782987,18805611,18800763,18803920],"length":1,"stats":{"Line":28}},{"line":107,"address":[18794363,18807291,18802443,18802523,18787979,18805675,18794443,18786283,18804059,18789515,18792747,18797595,18797675,18805755,18796059,18781435,18795979,18791131,18800827,18781515,18779899,18789595,18792827,18786363,18787899,18778283,18783051,18799291,18784667,18804139,18784747,18778203,18799211,18807371,18783131,18800907,18779819,18791211],"length":1,"stats":{"Line":28}},{"line":108,"address":[18804171,18807494,18799414,18794566,18801030,18778406,18779931,18789627,18805878,18800939,18791243,18804262,18796091,18802646,18807403,18786395,18799323,18781638,18783163,18796182,18792950,18780022,18794475,18783254,18786486,18802555,18778315,18791334,18784779,18792859,18789718,18788102,18797707,18805787,18784870,18788011,18797798,18781547],"length":1,"stats":{"Line":28}},{"line":109,"address":[13095020],"length":1,"stats":{"Line":14}},{"line":110,"address":[18794732,18806044,18783420,18788268,18791500,18807660,18796348,18799580,18804428,18797964,18789884,18781804,18780188,18785036,18786652,18801196,18778572,18802812,18793116],"length":1,"stats":{"Line":14}},{"line":111,"address":[13626148,13627764,13634228,13648772,13637460,13624532,13629380,13622916,13630996,13645540,13639076,13621300,13647156,13632612,13640692,13619684,13643924,13642308,13635844],"length":1,"stats":{"Line":14}},{"line":112,"address":[13626156,13631004,13647164,13632620,13624540,13640700,13648780,13637468,13642316,13639084,13621308,13627772,13643932,13635852,13622924,13619692,13629388,13645548,13634236],"length":1,"stats":{"Line":14}},{"line":114,"address":[13094428],"length":1,"stats":{"Line":18}},{"line":119,"address":[15097736,15097024,15097730],"length":1,"stats":{"Line":2}},{"line":121,"address":[13074258],"length":1,"stats":{"Line":2}},{"line":132,"address":[13074274],"length":1,"stats":{"Line":2}},{"line":133,"address":[13103278,13103343],"length":1,"stats":{"Line":4}},{"line":134,"address":[15097247],"length":1,"stats":{"Line":2}},{"line":143,"address":[13072036,13071472,13074195],"length":1,"stats":{"Line":6}},{"line":144,"address":[13100443],"length":1,"stats":{"Line":6}},{"line":149,"address":[13100595],"length":1,"stats":{"Line":6}},{"line":150,"address":[13022939,13022853,13023123],"length":1,"stats":{"Line":12}},{"line":156,"address":[13100688],"length":1,"stats":{"Line":2}},{"line":158,"address":[13072047],"length":1,"stats":{"Line":2}},{"line":159,"address":[15095356],"length":1,"stats":{"Line":2}},{"line":160,"address":[15095169],"length":1,"stats":{"Line":2}},{"line":161,"address":[13649328],"length":1,"stats":{"Line":4}},{"line":162,"address":[13095621],"length":1,"stats":{"Line":0}},{"line":164,"address":[13072310],"length":1,"stats":{"Line":2}},{"line":166,"address":[15095281],"length":1,"stats":{"Line":2}},{"line":170,"address":[13023837,13023256],"length":1,"stats":{"Line":4}},{"line":171,"address":[13024239],"length":1,"stats":{"Line":2}},{"line":172,"address":[13101876],"length":1,"stats":{"Line":2}},{"line":173,"address":[13095504],"length":1,"stats":{"Line":4}},{"line":174,"address":[13066597],"length":1,"stats":{"Line":0}},{"line":176,"address":[13072897],"length":1,"stats":{"Line":2}},{"line":178,"address":[13073060],"length":1,"stats":{"Line":2}},{"line":183,"address":[13072768],"length":1,"stats":{"Line":2}},{"line":194,"address":[13101724,13102239],"length":1,"stats":{"Line":4}},{"line":195,"address":[13024475,13024550],"length":1,"stats":{"Line":4}},{"line":197,"address":[13024686,13024627,13024796],"length":1,"stats":{"Line":10}},{"line":209,"address":[13097746,13097088,13100332],"length":1,"stats":{"Line":2}},{"line":210,"address":[13068206],"length":1,"stats":{"Line":3}},{"line":215,"address":[13068427],"length":1,"stats":{"Line":3}},{"line":216,"address":[13019738,13019635],"length":1,"stats":{"Line":10}},{"line":219,"address":[15091363,15091656],"length":1,"stats":{"Line":11}},{"line":220,"address":[13069028,13069377,13071399,13068995,13068934],"length":1,"stats":{"Line":19}},{"line":221,"address":[13098118],"length":1,"stats":{"Line":7}},{"line":222,"address":[13069090,13069011],"length":1,"stats":{"Line":12}},{"line":223,"address":[15091925],"length":1,"stats":{"Line":7}},{"line":224,"address":[13069139],"length":1,"stats":{"Line":5}},{"line":226,"address":[13069302],"length":1,"stats":{"Line":5}},{"line":229,"address":[15092500],"length":1,"stats":{"Line":5}},{"line":230,"address":[13070182],"length":1,"stats":{"Line":2}},{"line":231,"address":[13098923],"length":1,"stats":{"Line":2}},{"line":232,"address":[13093568],"length":1,"stats":{"Line":4}},{"line":233,"address":[13093589],"length":1,"stats":{"Line":0}},{"line":235,"address":[15092760],"length":1,"stats":{"Line":2}},{"line":237,"address":[13021227],"length":1,"stats":{"Line":2}},{"line":242,"address":[13069774],"length":1,"stats":{"Line":5}},{"line":253,"address":[13069802,13070358],"length":1,"stats":{"Line":9}},{"line":254,"address":[13099350,13099425],"length":1,"stats":{"Line":9}},{"line":256,"address":[13099497],"length":1,"stats":{"Line":4}},{"line":258,"address":[13021904],"length":1,"stats":{"Line":6}},{"line":267,"address":[15099921,15097760,15099827],"length":1,"stats":{"Line":2}},{"line":271,"address":[13075032],"length":1,"stats":{"Line":2}},{"line":274,"address":[13066858,13066848],"length":1,"stats":{"Line":6}},{"line":275,"address":[13066919],"length":1,"stats":{"Line":2}},{"line":276,"address":[18808621],"length":1,"stats":{"Line":2}},{"line":277,"address":[18808611],"length":1,"stats":{"Line":2}},{"line":278,"address":[13066889],"length":1,"stats":{"Line":2}},{"line":282,"address":[13096010,13096000],"length":1,"stats":{"Line":9}},{"line":283,"address":[18808429,18808416],"length":1,"stats":{"Line":9}},{"line":284,"address":[13026195],"length":1,"stats":{"Line":2}},{"line":286,"address":[13026215],"length":1,"stats":{"Line":3}},{"line":287,"address":[13104113],"length":1,"stats":{"Line":2}},{"line":288,"address":[13026260],"length":1,"stats":{"Line":2}},{"line":289,"address":[15097943],"length":1,"stats":{"Line":2}},{"line":293,"address":[13104124],"length":1,"stats":{"Line":2}},{"line":294,"address":[15098054],"length":1,"stats":{"Line":9}},{"line":295,"address":[13075399,13075324],"length":1,"stats":{"Line":7}},{"line":300,"address":[13066768],"length":1,"stats":{"Line":8}},{"line":301,"address":[13067729,13067798,13067804,13066796,13067104],"length":1,"stats":{"Line":7}},{"line":302,"address":[13649926],"length":1,"stats":{"Line":2}},{"line":303,"address":[13067155,13067936],"length":1,"stats":{"Line":2}},{"line":304,"address":[13067957],"length":1,"stats":{"Line":0}},{"line":306,"address":[13096146],"length":1,"stats":{"Line":2}},{"line":308,"address":[18809119,18809034],"length":1,"stats":{"Line":4}},{"line":314,"address":[13075914],"length":1,"stats":{"Line":4}},{"line":324,"address":[15098702],"length":1,"stats":{"Line":3}},{"line":325,"address":[13104954,13104886],"length":1,"stats":{"Line":8}},{"line":326,"address":[15099025,15098950],"length":1,"stats":{"Line":8}},{"line":328,"address":[13076518,13076337,13076408],"length":1,"stats":{"Line":10}},{"line":334,"address":[13067008],"length":1,"stats":{"Line":12}}],"covered":121,"coverable":138},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","providers","inlay_hints.rs"],"content":"//! Inlay hints provider for dependency versions\n\nuse tower_lsp::lsp_types::{InlayHint, InlayHintKind, InlayHintLabel, Position};\n\nuse crate::parsers::Dependency;\nuse crate::registries::{VersionInfo, VulnerabilitySeverity};\nuse crate::utils::truncate_string;\n\n/// Result of comparing a dependency version with the latest available\n#[derive(Debug, Clone)]\npub enum VersionStatus {\n    /// Version is up to date\n    UpToDate,\n    /// Update available to the given version\n    UpdateAvailable(String),\n    /// Could not determine version status\n    Unknown,\n}\n\n/// Generate an inlay hint for a dependency\npub fn create_inlay_hint(dep: \u0026Dependency, version_info: Option\u003c\u0026VersionInfo\u003e) -\u003e InlayHint {\n    let status = match version_info {\n        Some(info) =\u003e compare_versions(\u0026dep.version, info),\n        None =\u003e VersionStatus::Unknown,\n    };\n\n    // Check for vulnerabilities and deprecation\n    let vuln_count = version_info\n        .map(|info| info.vulnerabilities.len())\n        .unwrap_or(0);\n\n    let is_deprecated = version_info.map(|info| info.deprecated).unwrap_or(false);\n\n    if is_deprecated {\n        tracing::debug!(\"Package {} {} is deprecated\", dep.name, dep.version);\n    }\n\n    let (label, tooltip) = create_hint_label_and_tooltip(\u0026status, vuln_count, dep, version_info);\n\n    InlayHint {\n        position: Position {\n            line: dep.line,\n            character: dep.version_end + 1,\n        },\n        label: InlayHintLabel::String(format!(\" {}\", label)),\n        kind: Some(InlayHintKind::PARAMETER),\n        text_edits: None,\n        tooltip: tooltip.map(tower_lsp::lsp_types::InlayHintTooltip::String),\n        padding_left: Some(true),\n        padding_right: None,\n        data: None,\n    }\n}\n\n/// Create label and tooltip based on version status and vulnerabilities\nfn create_hint_label_and_tooltip(\n    status: \u0026VersionStatus,\n    vuln_count: usize,\n    dep: \u0026Dependency,\n    version_info: Option\u003c\u0026VersionInfo\u003e,\n) -\u003e (String, Option\u003cString\u003e) {\n    // Handle local dependencies first (highest priority - no registry lookup needed)\n    if is_local_dependency(\u0026dep.version) {\n        let tooltip = format!(\n            \"**Local Dependency**\\n\\n\\\n            \\\"{}\\\" is a local/path dependency.\\n\\n\\\n            Version info is not available for local packages.\\n\\n\\\n            This is expected for dependencies using:\\n\\\n            • path = \\\"./...\\\"\\n\\\n            • git = \\\"https://...\\\"\\n\\\n            • git = \\\"git@...\\\"\\n\\\n            • github:owner/repo\",\n            dep.name\n        );\n        return (\"→ Local\".to_string(), Some(tooltip));\n    }\n\n    tracing::debug!(\n        \"Not a local dependency: {} with version '{}'\",\n        dep.name,\n        dep.version\n    );\n\n    // Handle yanked versions (highest priority - critical issue)\n    if let Some(info) = version_info\n        \u0026\u0026 info.is_version_yanked(\u0026dep.version)\n    {\n        let yanked_label = \"⊘ Yanked\".to_string();\n        let yanked_tooltip = format_yanked_tooltip(dep, info);\n\n        return match status {\n            VersionStatus::UpdateAvailable(latest) =\u003e {\n                let label = format!(\"{} -\u003e {}\", yanked_label, latest);\n                let tooltip = format!(\n                    \"{}\\n\\n---\\n**Update available:** {} -\u003e {}\",\n                    yanked_tooltip, dep.version, latest\n                );\n                (label, Some(tooltip))\n            }\n            _ =\u003e (yanked_label, Some(yanked_tooltip)),\n        };\n    }\n\n    // Handle deprecation (second highest priority)\n    if let Some(info) = version_info\n        \u0026\u0026 info.deprecated\n    {\n        let dep_label = \"⚠ Deprecated\".to_string();\n        let dep_tooltip = format_deprecation_tooltip(dep, info);\n\n        // Combine with update info if available\n        return match status {\n            VersionStatus::UpdateAvailable(latest) =\u003e {\n                let label = format!(\"{} -\u003e {}\", dep_label, latest);\n                let tooltip = format!(\n                    \"{}\\n\\n---\\n**Update available:** {} -\u003e {}\",\n                    dep_tooltip, dep.version, latest\n                );\n                (label, Some(tooltip))\n            }\n            _ =\u003e (dep_label, Some(dep_tooltip)),\n        };\n    }\n\n    // Handle vulnerabilities\n    if vuln_count \u003e 0 {\n        let vuln_label = format!(\n            \"⚠ {} {}\",\n            vuln_count,\n            if vuln_count == 1 { \"vuln\" } else { \"vulns\" }\n        );\n        let vuln_tooltip = format_vulnerability_tooltip(version_info.unwrap());\n\n        // Combine with update info if available\n        return match status {\n            VersionStatus::UpdateAvailable(latest) =\u003e {\n                let label = format!(\"{} -\u003e {}\", vuln_label, latest);\n                let tooltip = format!(\n                    \"{}\\n\\n---\\n**Update available:** {} -\u003e {}\",\n                    vuln_tooltip, dep.version, latest\n                );\n                (label, Some(tooltip))\n            }\n            _ =\u003e (vuln_label, Some(vuln_tooltip)),\n        };\n    }\n\n    // No vulnerabilities - show version status\n    match status {\n        VersionStatus::UpToDate =\u003e (\"✓\".to_string(), Some(\"Up to date\".to_string())),\n        VersionStatus::UpdateAvailable(latest) =\u003e {\n            let label = format!(\"-\u003e {}\", latest);\n            let tooltip = format!(\"Update available: {} -\u003e {}\", dep.version, latest);\n            (label, Some(tooltip))\n        }\n        VersionStatus::Unknown =\u003e {\n            let tooltip = format!(\n                \"**Could not fetch version info**\\n\\n\\\n                Possible causes:\\n\\\n                • Network error - check internet connection\\n\\\n                • Package not found - verify spelling\\n\\\n                • Rate limiting - wait and retry\\n\\\n                • Registry down - try again later\\n\\n\\\n                **Troubleshooting:**\\n\\\n                1. Check your network connection\\n\\\n                2. Verify the package name \\\"{}\\\" is spelled correctly\\n\\\n                3. Search for the package on the registry\\n\\\n                4. If recently published, wait a few minutes for indexing\",\n                dep.name\n            );\n            (\"? Unknown\".to_string(), Some(tooltip))\n        }\n    }\n}\n\n/// Format vulnerability details for tooltip\nfn format_vulnerability_tooltip(info: \u0026VersionInfo) -\u003e String {\n    let count = info.vulnerabilities.len();\n    let mut lines = vec![format!(\n        \"**⚠ {} {} Found**\\n\",\n        count,\n        if count == 1 {\n            \"Vulnerability\"\n        } else {\n            \"Vulnerabilities\"\n        }\n    )];\n\n    for (i, vuln) in info.vulnerabilities.iter().take(5).enumerate() {\n        let severity_icon = match vuln.severity {\n            VulnerabilitySeverity::Critical =\u003e \"⚠ CRITICAL\",\n            VulnerabilitySeverity::High =\u003e \"▲ HIGH\",\n            VulnerabilitySeverity::Medium =\u003e \"● MEDIUM\",\n            VulnerabilitySeverity::Low =\u003e \"○ LOW\",\n        };\n\n        lines.push(format!(\n            \"{}. **{}** ({})\\n   {}\",\n            i + 1,\n            vuln.id,\n            severity_icon,\n            truncate_string(\u0026vuln.description, 100)\n        ));\n\n        if let Some(url) = \u0026vuln.url {\n            lines.push(format!(\"   [View Advisory]({})\", url));\n        }\n    }\n\n    if info.vulnerabilities.len() \u003e 5 {\n        lines.push(format!(\n            \"\\n... and {} more vulnerabilities\",\n            info.vulnerabilities.len() - 5\n        ));\n    }\n\n    lines.join(\"\\n\")\n}\n\n/// Format deprecation warning for tooltip\nfn format_deprecation_tooltip(dep: \u0026Dependency, info: \u0026VersionInfo) -\u003e String {\n    let mut lines = vec![\n        format!(\n            \"**⚠ PACKAGE DEPRECATED**\\n\\nThe package \\\"{}\\\" is deprecated.\",\n            dep.name\n        ),\n        \"\".to_string(),\n        \"**Why was it deprecated?**\".to_string(),\n        \"• Superseded by a better alternative\".to_string(),\n        \"• Has unresolved critical bugs\".to_string(),\n        \"• Known security vulnerabilities\".to_string(),\n        \"• No longer maintained\".to_string(),\n        \"• Has been renamed\".to_string(),\n        \"\".to_string(),\n        \"**What should you do?**\".to_string(),\n    ];\n\n    if let Some(homepage) = \u0026info.homepage {\n        lines.push(format!(\"• Check the package homepage: {}\", homepage));\n    }\n\n    if let Some(repo) = \u0026info.repository {\n        lines.push(format!(\n            \"• View the repository for more information: {}\",\n            repo\n        ));\n    }\n\n    lines.push(\"• Search for an alternative package on the registry\".to_string());\n\n    if let Some(latest) = \u0026info.latest {\n        lines.push(format!(\n            \"• Consider the latest version: {} (may not be deprecated)\",\n            latest\n        ));\n    }\n\n    lines.join(\"\\n\")\n}\n\n/// Format yanked version warning for tooltip\nfn format_yanked_tooltip(dep: \u0026Dependency, info: \u0026VersionInfo) -\u003e String {\n    let mut lines = vec![\n        format!(\n            \"**⊘ YANKED VERSION**\\n\\nThe version \\\"{}\\\" of \\\"{}\\\" has been yanked from crates.io.\",\n            dep.version, dep.name\n        ),\n        \"\".to_string(),\n        \"**Why was it yanked?**\".to_string(),\n        \"A yanked version typically has:\".to_string(),\n        \"• Critical bugs that break functionality\".to_string(),\n        \"• Security vulnerabilities\".to_string(),\n        \"• Published by mistake\".to_string(),\n        \"• Corrupted or incomplete package\".to_string(),\n        \"\".to_string(),\n        \"**What should you do?**\".to_string(),\n    ];\n\n    if let Some(latest) = \u0026info.latest {\n        lines.push(format!(\"• Update to the latest version: {}\", latest));\n    }\n\n    if let Some(repo) = \u0026info.repository {\n        lines.push(format!(\"• Check the repository for more info: {}\", repo));\n    }\n\n    lines.push(format!(\n        \"• View on crates.io: https://crates.io/crates/{}\",\n        dep.name\n    ));\n\n    lines.join(\"\\n\")\n}\n\n/// Check if a dependency version string indicates a local/path dependency\npub fn is_local_dependency(version: \u0026str) -\u003e bool {\n    // Path-based dependencies\n    version.starts_with(\"./\")\n        || version.starts_with(\"../\")\n        || version.starts_with('/')\n        // File protocol (npm uses \"file:\" not \"file://\")\n        || version.starts_with(\"file:\")\n        // Git dependencies\n        || version.starts_with(\"git+\")\n        || version.starts_with(\"git@\")\n        || version.starts_with(\"git:\")\n        // URL-based (git repos)\n        || version.starts_with(\"https://\")\n        || version.starts_with(\"http://\")\n        // Platform shortcuts (npm/yarn)\n        || version.starts_with(\"github:\")\n        || version.starts_with(\"gitlab:\")\n        || version.starts_with(\"bitbucket:\")\n        // Yarn/pnpm workspace protocols\n        || version.starts_with(\"workspace:\")\n        || version.starts_with(\"link:\")\n        || version.starts_with(\"portal:\")\n        // npm aliases\n        || version.starts_with(\"npm:\")\n}\n\n/// Compare a dependency version with the latest available\npub fn compare_versions(current: \u0026str, info: \u0026VersionInfo) -\u003e VersionStatus {\n    let Some(latest) = \u0026info.latest else {\n        return VersionStatus::Unknown;\n    };\n\n    // Normalize versions for comparison\n    let current_normalized = normalize_version(current);\n    let latest_normalized = normalize_version(latest);\n\n    // Parse as semver for proper comparison\n    match (\n        semver::Version::parse(\u0026current_normalized),\n        semver::Version::parse(\u0026latest_normalized),\n    ) {\n        (Ok(current_ver), Ok(latest_ver)) =\u003e {\n            if current_ver \u003e= latest_ver {\n                VersionStatus::UpToDate\n            } else {\n                VersionStatus::UpdateAvailable(latest.clone())\n            }\n        }\n        _ =\u003e {\n            // Fallback to string comparison if semver parsing fails\n            if current_normalized == latest_normalized {\n                VersionStatus::UpToDate\n            } else {\n                VersionStatus::UpdateAvailable(latest.clone())\n            }\n        }\n    }\n}\n\n/// Normalize a version string for comparison\n/// Handles version specifiers like ^, ~, \u003e=, etc.\nfn normalize_version(version: \u0026str) -\u003e String {\n    let version = version.trim();\n\n    // Remove common prefixes\n    let version = version\n        .strip_prefix('^')\n        .or_else(|| version.strip_prefix('~'))\n        .or_else(|| version.strip_prefix(\"\u003e=\"))\n        .or_else(|| version.strip_prefix(\"\u003c=\"))\n        .or_else(|| version.strip_prefix('\u003e'))\n        .or_else(|| version.strip_prefix('\u003c'))\n        .or_else(|| version.strip_prefix('='))\n        .unwrap_or(version);\n\n    // Handle version ranges like \"\u003e=1.0, \u003c2.0\" - take the first part\n    let version = version.split(',').next().unwrap_or(version).trim();\n\n    // Ensure we have at least major.minor.patch\n    let parts: Vec\u003c\u0026str\u003e = version.split('.').collect();\n    match parts.len() {\n        1 =\u003e format!(\"{}.0.0\", parts[0]),\n        2 =\u003e format!(\"{}.{}.0\", parts[0], parts[1]),\n        _ =\u003e version.to_string(),\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::registries::Vulnerability;\n\n    fn make_version_info(latest: \u0026str) -\u003e VersionInfo {\n        VersionInfo {\n            latest: Some(latest.to_string()),\n            ..Default::default()\n        }\n    }\n\n    fn make_test_dep(name: \u0026str, version: \u0026str) -\u003e Dependency {\n        Dependency {\n            name: name.to_string(),\n            version: version.to_string(),\n            line: 5,\n            name_start: 0,\n            name_end: name.len() as u32,\n            version_start: name.len() as u32 + 4,\n            version_end: name.len() as u32 + 4 + version.len() as u32,\n            dev: false,\n            optional: false,\n        }\n    }\n\n    #[test]\n    fn test_compare_versions_up_to_date() {\n        let info = make_version_info(\"1.0.0\");\n        assert!(matches!(\n            compare_versions(\"1.0.0\", \u0026info),\n            VersionStatus::UpToDate\n        ));\n    }\n\n    #[test]\n    fn test_compare_versions_update_available() {\n        let info = make_version_info(\"2.0.0\");\n        match compare_versions(\"1.0.0\", \u0026info) {\n            VersionStatus::UpdateAvailable(v) =\u003e assert_eq!(v, \"2.0.0\"),\n            _ =\u003e panic!(\"Expected UpdateAvailable\"),\n        }\n    }\n\n    #[test]\n    fn test_compare_versions_with_caret() {\n        let info = make_version_info(\"1.5.0\");\n        match compare_versions(\"^1.0\", \u0026info) {\n            VersionStatus::UpdateAvailable(v) =\u003e assert_eq!(v, \"1.5.0\"),\n            _ =\u003e panic!(\"Expected UpdateAvailable\"),\n        }\n    }\n\n    #[test]\n    fn test_compare_versions_with_tilde() {\n        let info = make_version_info(\"1.0.5\");\n        match compare_versions(\"~1.0.0\", \u0026info) {\n            VersionStatus::UpdateAvailable(v) =\u003e assert_eq!(v, \"1.0.5\"),\n            _ =\u003e panic!(\"Expected UpdateAvailable\"),\n        }\n    }\n\n    #[test]\n    fn test_normalize_version() {\n        assert_eq!(normalize_version(\"1.0.0\"), \"1.0.0\");\n        assert_eq!(normalize_version(\"^1.0\"), \"1.0.0\");\n        assert_eq!(normalize_version(\"~1.0.0\"), \"1.0.0\");\n        assert_eq!(normalize_version(\"\u003e=1.0, \u003c2.0\"), \"1.0.0\");\n        assert_eq!(normalize_version(\"1\"), \"1.0.0\");\n        assert_eq!(normalize_version(\"1.2\"), \"1.2.0\");\n    }\n\n    #[test]\n    fn test_create_inlay_hint_up_to_date() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = make_version_info(\"1.0.0\");\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        assert_eq!(hint.position.line, 5);\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e assert!(s.contains(\"✓\")),\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_create_inlay_hint_update_available() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = make_version_info(\"2.0.0\");\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"-\u003e\"));\n                assert!(s.contains(\"2.0.0\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_deprecated_inlay_hint() {\n        let dep = make_test_dep(\"old-dep\", \"1.0.0\");\n        let info = VersionInfo {\n            deprecated: true,\n            latest: Some(\"2.0.0\".to_string()),\n            description: Some(\"Superseded by new-package\".to_string()),\n            homepage: Some(\"https://example.com\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Deprecated\"));\n                assert!(s.contains(\"⚠\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_deprecated_with_update() {\n        let dep = make_test_dep(\"old-dep\", \"1.0.0\");\n        let info = VersionInfo {\n            deprecated: true,\n            latest: Some(\"2.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Deprecated\"));\n                assert!(s.contains(\"2.0.0\"));\n                assert!(s.contains(\"-\u003e\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_no_deprecated_warning() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            deprecated: false,\n            latest: Some(\"1.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(!s.contains(\"Deprecated\"));\n                assert!(!s.contains(\"⚠\"));\n                assert!(s.contains(\"✓\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_vulnerability_label_singular() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            latest: Some(\"1.0.0\".to_string()),\n            vulnerabilities: vec![Vulnerability {\n                id: \"CVE-2024-1234\".to_string(),\n                severity: VulnerabilitySeverity::High,\n                description: \"Test vulnerability\".to_string(),\n                url: None,\n            }],\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(\n                    s.contains(\"⚠ 1 vuln\"),\n                    \"Expected '⚠ 1 vuln' in label, got: {}\",\n                    s\n                );\n                assert!(\n                    !s.contains(\"vulns\"),\n                    \"Should use singular 'vuln', got: {}\",\n                    s\n                );\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_vulnerability_label_plural() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            latest: Some(\"1.0.0\".to_string()),\n            vulnerabilities: vec![\n                Vulnerability {\n                    id: \"CVE-2024-1234\".to_string(),\n                    severity: VulnerabilitySeverity::High,\n                    description: \"Test vulnerability 1\".to_string(),\n                    url: None,\n                },\n                Vulnerability {\n                    id: \"CVE-2024-5678\".to_string(),\n                    severity: VulnerabilitySeverity::Medium,\n                    description: \"Test vulnerability 2\".to_string(),\n                    url: None,\n                },\n            ],\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(\n                    s.contains(\"⚠ 2 vulns\"),\n                    \"Expected '⚠ 2 vulns' in label, got: {}\",\n                    s\n                );\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_vulnerability_with_update_label() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            latest: Some(\"2.0.0\".to_string()),\n            vulnerabilities: vec![\n                Vulnerability {\n                    id: \"CVE-2024-1234\".to_string(),\n                    severity: VulnerabilitySeverity::High,\n                    description: \"Test vulnerability 1\".to_string(),\n                    url: None,\n                },\n                Vulnerability {\n                    id: \"CVE-2024-5678\".to_string(),\n                    severity: VulnerabilitySeverity::Medium,\n                    description: \"Test vulnerability 2\".to_string(),\n                    url: None,\n                },\n            ],\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(\n                    s.contains(\"⚠ 2 vulns\"),\n                    \"Expected '⚠ 2 vulns' in label, got: {}\",\n                    s\n                );\n                assert!(\n                    s.contains(\"-\u003e 2.0.0\"),\n                    \"Expected '-\u003e 2.0.0' in label, got: {}\",\n                    s\n                );\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_deprecated_priority_over_vulnerabilities() {\n        let dep = make_test_dep(\"dep\", \"1.0.0\");\n        let info = VersionInfo {\n            deprecated: true,\n            latest: None,\n            vulnerabilities: vec![Vulnerability {\n                id: \"CVE-2024-1234\".to_string(),\n                severity: VulnerabilitySeverity::High,\n                description: \"Test vulnerability\".to_string(),\n                url: None,\n            }],\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Deprecated\"));\n                assert!(!s.contains(\"vuln\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_yanked_inlay_hint() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            yanked_versions: vec![\"1.0.0\".to_string()],\n            latest: Some(\"2.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Yanked\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_yanked_with_update() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            yanked_versions: vec![\"1.0.0\".to_string()],\n            latest: Some(\"2.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Yanked\"));\n                assert!(s.contains(\"2.0.0\"));\n                assert!(s.contains(\"-\u003e\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_no_yanked_warning() {\n        let dep = make_test_dep(\"serde\", \"1.0.0\");\n        let info = VersionInfo {\n            yanked_versions: vec![\"0.9.0\".to_string()],\n            latest: Some(\"1.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(!s.contains(\"Yanked\"));\n                assert!(s.contains(\"✓\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_yanked_priority_over_deprecated() {\n        let dep = make_test_dep(\"dep\", \"1.0.0\");\n        let info = VersionInfo {\n            yanked_versions: vec![\"1.0.0\".to_string()],\n            deprecated: true,\n            latest: Some(\"2.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Yanked\"));\n                assert!(!s.contains(\"Deprecated\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_yanked_priority_over_vulnerabilities() {\n        let dep = make_test_dep(\"dep\", \"1.0.0\");\n        let info = VersionInfo {\n            yanked_versions: vec![\"1.0.0\".to_string()],\n            vulnerabilities: vec![Vulnerability {\n                id: \"CVE-2024-1234\".to_string(),\n                severity: VulnerabilitySeverity::High,\n                description: \"Test vulnerability\".to_string(),\n                url: None,\n            }],\n            latest: Some(\"2.0.0\".to_string()),\n            ..Default::default()\n        };\n        let hint = create_inlay_hint(\u0026dep, Some(\u0026info));\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"Yanked\"));\n                assert!(!s.contains(\"⚠\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n\n    #[test]\n    fn test_is_local_dependency() {\n        // Path-based\n        assert!(is_local_dependency(\"./my-lib\"));\n        assert!(is_local_dependency(\"../other-lib\"));\n        assert!(is_local_dependency(\"/absolute/path\"));\n\n        // File protocol (npm style)\n        assert!(is_local_dependency(\"file:./my-local-lib\"));\n        assert!(is_local_dependency(\"file:../shared\"));\n        assert!(is_local_dependency(\"file:///absolute/path\"));\n\n        // Git dependencies\n        assert!(is_local_dependency(\"git+https://github.com/user/repo\"));\n        assert!(is_local_dependency(\"git@github.com:user/repo.git\"));\n        assert!(is_local_dependency(\"git://github.com/user/repo.git\"));\n\n        // URL-based\n        assert!(is_local_dependency(\"https://github.com/user/repo\"));\n        assert!(is_local_dependency(\"http://example.com/repo.tgz\"));\n\n        // Platform shortcuts\n        assert!(is_local_dependency(\"github:user/repo\"));\n        assert!(is_local_dependency(\"gitlab:user/repo\"));\n        assert!(is_local_dependency(\"bitbucket:user/repo\"));\n\n        // Workspace protocols\n        assert!(is_local_dependency(\"workspace:*\"));\n        assert!(is_local_dependency(\"link:./my-lib\"));\n        assert!(is_local_dependency(\"portal:./my-lib\"));\n        assert!(is_local_dependency(\"npm:lodash@^4.0.0\"));\n\n        // Not local - regular versions\n        assert!(!is_local_dependency(\"1.0.0\"));\n        assert!(!is_local_dependency(\"^1.0\"));\n        assert!(!is_local_dependency(\"~1.0.0\"));\n        assert!(!is_local_dependency(\"\u003e=1.0, \u003c2.0\"));\n        assert!(!is_local_dependency(\"*\"));\n        assert!(!is_local_dependency(\"latest\"));\n    }\n\n    #[test]\n    fn test_npm_local_deps_detection() {\n        use crate::parsers::{Parser, npm::NpmParser};\n\n        let content = r#\"{\n  \"dependencies\": {\n    \"express\": \"^4.17.0\",\n    \"my-local-lib\": \"file:./my-local-lib\",\n    \"shared-utils\": \"../shared-utils\",\n    \"git-package\": \"git+https://github.com/user/repo.git\",\n    \"github-dep\": \"github:owner/project\"\n  }\n}\"#;\n\n        let parser = NpmParser::new();\n        let deps = parser.parse(content);\n\n        assert_eq!(deps.len(), 5);\n\n        for dep in \u0026deps {\n            println!(\"Dep: {} @ '{}'\", dep.name, dep.version);\n            let is_local = is_local_dependency(\u0026dep.version);\n            println!(\"  -\u003e is_local: {}\", is_local);\n        }\n\n        let my_local = deps.iter().find(|d| d.name == \"my-local-lib\").unwrap();\n        assert!(\n            is_local_dependency(\u0026my_local.version),\n            \"file:./my-local-lib should be local, got version: '{}'\",\n            my_local.version\n        );\n\n        let shared = deps.iter().find(|d| d.name == \"shared-utils\").unwrap();\n        assert!(\n            is_local_dependency(\u0026shared.version),\n            \"../shared-utils should be local, got version: '{}'\",\n            shared.version\n        );\n\n        let git_pkg = deps.iter().find(|d| d.name == \"git-package\").unwrap();\n        assert!(\n            is_local_dependency(\u0026git_pkg.version),\n            \"git+https://... should be local, got version: '{}'\",\n            git_pkg.version\n        );\n\n        let github = deps.iter().find(|d| d.name == \"github-dep\").unwrap();\n        assert!(\n            is_local_dependency(\u0026github.version),\n            \"github:... should be local, got version: '{}'\",\n            github.version\n        );\n\n        let express = deps.iter().find(|d| d.name == \"express\").unwrap();\n        assert!(\n            !is_local_dependency(\u0026express.version),\n            \"^4.17.0 should NOT be local\"\n        );\n    }\n\n    #[test]\n    fn test_unknown_status_local_dependency() {\n        let dep = make_test_dep(\"my-local-lib\", \"./my-local-lib\");\n        let hint = create_inlay_hint(\u0026dep, None);\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(\n                    s.contains(\"→\") || s.contains(\"Local\"),\n                    \"Expected → Local in label, got: {}\",\n                    s\n                );\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n\n        if let Some(tower_lsp::lsp_types::InlayHintTooltip::String(tooltip)) = hint.tooltip {\n            assert!(tooltip.contains(\"Local Dependency\"));\n            assert!(tooltip.contains(\"my-local-lib\"));\n        } else {\n            panic!(\"Expected string tooltip\");\n        }\n    }\n\n    #[test]\n    fn test_unknown_status_network_error() {\n        let dep = make_test_dep(\"unknown-package\", \"1.0.0\");\n        let hint = create_inlay_hint(\u0026dep, None);\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(s.contains(\"?\"), \"Expected ? in label, got: {}\", s);\n                assert!(!s.contains(\"Local\"));\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n\n        if let Some(tower_lsp::lsp_types::InlayHintTooltip::String(tooltip)) = hint.tooltip {\n            assert!(tooltip.contains(\"Could not fetch version info\"));\n            assert!(tooltip.contains(\"unknown-package\"));\n            assert!(tooltip.contains(\"Troubleshooting\"));\n        } else {\n            panic!(\"Expected string tooltip\");\n        }\n    }\n\n    #[test]\n    fn test_unknown_status_git_dependency() {\n        let dep = make_test_dep(\"git-dep\", \"git@github.com:user/repo.git\");\n        let hint = create_inlay_hint(\u0026dep, None);\n\n        match hint.label {\n            InlayHintLabel::String(s) =\u003e {\n                assert!(\n                    s.contains(\"→\") || s.contains(\"Local\"),\n                    \"Expected → Local in label, got: {}\",\n                    s\n                );\n            }\n            _ =\u003e panic!(\"Expected string label\"),\n        }\n    }\n}\n","traces":[{"line":21,"address":[13077746,13076112,13077815],"length":1,"stats":{"Line":3}},{"line":22,"address":[13076153],"length":1,"stats":{"Line":3}},{"line":23,"address":[14146933],"length":1,"stats":{"Line":5}},{"line":24,"address":[20363386],"length":1,"stats":{"Line":3}},{"line":28,"address":[14147005,14147113],"length":1,"stats":{"Line":14}},{"line":29,"address":[14165301],"length":1,"stats":{"Line":21}},{"line":32,"address":[13530912,13530917],"length":1,"stats":{"Line":21}},{"line":34,"address":[14165472],"length":1,"stats":{"Line":7}},{"line":35,"address":[14147232],"length":1,"stats":{"Line":2}},{"line":38,"address":[20364178,20363585],"length":1,"stats":{"Line":10}},{"line":45,"address":[14147926,14148014],"length":1,"stats":{"Line":11}},{"line":48,"address":[20364563],"length":1,"stats":{"Line":6}},{"line":56,"address":[14159240,14157088,14159327],"length":1,"stats":{"Line":7}},{"line":63,"address":[14157170],"length":1,"stats":{"Line":7}},{"line":64,"address":[13086450],"length":1,"stats":{"Line":2}},{"line":75,"address":[14163505,14157418],"length":1,"stats":{"Line":4}},{"line":78,"address":[14175740,14175531,14175929],"length":1,"stats":{"Line":14}},{"line":85,"address":[20373904,20374289],"length":1,"stats":{"Line":18}},{"line":86,"address":[14158007],"length":1,"stats":{"Line":8}},{"line":88,"address":[20374376],"length":1,"stats":{"Line":2}},{"line":89,"address":[20374434,20374490],"length":1,"stats":{"Line":8}},{"line":91,"address":[14176484],"length":1,"stats":{"Line":7}},{"line":92,"address":[14158251],"length":1,"stats":{"Line":5}},{"line":93,"address":[20374903,20374569],"length":1,"stats":{"Line":12}},{"line":94,"address":[20375054,20375169],"length":1,"stats":{"Line":12}},{"line":98,"address":[20375363],"length":1,"stats":{"Line":7}},{"line":100,"address":[20374623],"length":1,"stats":{"Line":0}},{"line":105,"address":[14176322,14177647],"length":1,"stats":{"Line":14}},{"line":106,"address":[14177668],"length":1,"stats":{"Line":8}},{"line":108,"address":[20375711],"length":1,"stats":{"Line":4}},{"line":109,"address":[14177755,14177811],"length":1,"stats":{"Line":10}},{"line":112,"address":[13088697],"length":1,"stats":{"Line":4}},{"line":113,"address":[20375888],"length":1,"stats":{"Line":4}},{"line":114,"address":[20375904,20376238],"length":1,"stats":{"Line":6}},{"line":115,"address":[13089253,13089368],"length":1,"stats":{"Line":8}},{"line":119,"address":[13089562],"length":1,"stats":{"Line":4}},{"line":121,"address":[14159656],"length":1,"stats":{"Line":2}},{"line":126,"address":[20375691],"length":1,"stats":{"Line":8}},{"line":127,"address":[13091189],"length":1,"stats":{"Line":3}},{"line":130,"address":[14160732,14161959],"length":1,"stats":{"Line":5}},{"line":132,"address":[14180501,14180586],"length":1,"stats":{"Line":8}},{"line":135,"address":[14180609],"length":1,"stats":{"Line":4}},{"line":136,"address":[14180664],"length":1,"stats":{"Line":2}},{"line":137,"address":[13091554,13091888],"length":1,"stats":{"Line":4}},{"line":138,"address":[20379175,20379290],"length":1,"stats":{"Line":4}},{"line":142,"address":[14163186],"length":1,"stats":{"Line":2}},{"line":144,"address":[14162446],"length":1,"stats":{"Line":4}},{"line":149,"address":[14160752,14160671],"length":1,"stats":{"Line":6}},{"line":150,"address":[14179042,14179480],"length":1,"stats":{"Line":6}},{"line":151,"address":[20377130],"length":1,"stats":{"Line":3}},{"line":152,"address":[14179137],"length":1,"stats":{"Line":3}},{"line":153,"address":[14179273,14179700],"length":1,"stats":{"Line":6}},{"line":154,"address":[14161563],"length":1,"stats":{"Line":3}},{"line":157,"address":[20377337],"length":1,"stats":{"Line":3}},{"line":171,"address":[13090324,13090953],"length":1,"stats":{"Line":6}},{"line":177,"address":[20371152,20373371,20373365],"length":1,"stats":{"Line":5}},{"line":178,"address":[13084066],"length":1,"stats":{"Line":4}},{"line":179,"address":[14175373,14173677,14173172,14173270],"length":1,"stats":{"Line":8}},{"line":182,"address":[13084106,13084144],"length":1,"stats":{"Line":6}},{"line":183,"address":[20371253],"length":1,"stats":{"Line":2}},{"line":185,"address":[13084146],"length":1,"stats":{"Line":3}},{"line":189,"address":[14173750,14173646],"length":1,"stats":{"Line":8}},{"line":190,"address":[14155769],"length":1,"stats":{"Line":5}},{"line":191,"address":[14156282],"length":1,"stats":{"Line":0}},{"line":192,"address":[14174541],"length":1,"stats":{"Line":4}},{"line":193,"address":[14174512],"length":1,"stats":{"Line":3}},{"line":194,"address":[14174483],"length":1,"stats":{"Line":0}},{"line":197,"address":[14156438],"length":1,"stats":{"Line":4}},{"line":199,"address":[13085529,13085473],"length":1,"stats":{"Line":5}},{"line":202,"address":[14174689,14174637],"length":1,"stats":{"Line":9}},{"line":205,"address":[13085992],"length":1,"stats":{"Line":5}},{"line":206,"address":[20373206],"length":1,"stats":{"Line":0}},{"line":210,"address":[20372118],"length":1,"stats":{"Line":3}},{"line":211,"address":[14155942,14155989],"length":1,"stats":{"Line":0}},{"line":213,"address":[14155969,14155878],"length":1,"stats":{"Line":0}},{"line":217,"address":[14155838,14156139],"length":1,"stats":{"Line":9}},{"line":221,"address":[14173068,14173074,14170800],"length":1,"stats":{"Line":4}},{"line":222,"address":[14171277,14172221,14171349,14171634,14170895,14171562,14171205,14171133,14171675,14173087,14170853,14171421,14171493,14171061],"length":1,"stats":{"Line":10}},{"line":223,"address":[20368932,20368996],"length":1,"stats":{"Line":9}},{"line":227,"address":[14171033],"length":1,"stats":{"Line":4}},{"line":228,"address":[14152814],"length":1,"stats":{"Line":5}},{"line":229,"address":[20369234],"length":1,"stats":{"Line":4}},{"line":230,"address":[20369306],"length":1,"stats":{"Line":5}},{"line":231,"address":[14171318],"length":1,"stats":{"Line":4}},{"line":232,"address":[13082314],"length":1,"stats":{"Line":5}},{"line":233,"address":[14171462],"length":1,"stats":{"Line":4}},{"line":234,"address":[14171534],"length":1,"stats":{"Line":5}},{"line":235,"address":[14171603],"length":1,"stats":{"Line":4}},{"line":238,"address":[20370229,20370299],"length":1,"stats":{"Line":6}},{"line":239,"address":[14154099,14153967],"length":1,"stats":{"Line":4}},{"line":242,"address":[14154233,14153999],"length":1,"stats":{"Line":3}},{"line":243,"address":[14172537,14172598],"length":1,"stats":{"Line":0}},{"line":249,"address":[14154276,14154439],"length":1,"stats":{"Line":6}},{"line":251,"address":[20370816],"length":1,"stats":{"Line":4}},{"line":252,"address":[14154589,14154534],"length":1,"stats":{"Line":7}},{"line":258,"address":[13083772,13083943],"length":1,"stats":{"Line":4}},{"line":262,"address":[14152482,14150288,14152488],"length":1,"stats":{"Line":4}},{"line":263,"address":[13080035,13081712,13080320,13079557,13080433,13080179,13079963,13080251,13080392,13080973,13079819,13079891,13080107,13079622],"length":1,"stats":{"Line":10}},{"line":264,"address":[20366795,20366711],"length":1,"stats":{"Line":8}},{"line":268,"address":[14168867],"length":1,"stats":{"Line":4}},{"line":269,"address":[14168936],"length":1,"stats":{"Line":4}},{"line":270,"address":[14169008],"length":1,"stats":{"Line":3}},{"line":271,"address":[14169080],"length":1,"stats":{"Line":4}},{"line":272,"address":[13080076],"length":1,"stats":{"Line":3}},{"line":273,"address":[13080148],"length":1,"stats":{"Line":5}},{"line":274,"address":[14151008],"length":1,"stats":{"Line":5}},{"line":275,"address":[13080292],"length":1,"stats":{"Line":6}},{"line":276,"address":[14169437],"length":1,"stats":{"Line":5}},{"line":279,"address":[14151715,14151780],"length":1,"stats":{"Line":12}},{"line":280,"address":[14151796,14151928],"length":1,"stats":{"Line":12}},{"line":283,"address":[13081273,13081039],"length":1,"stats":{"Line":5}},{"line":284,"address":[20368488,20368426],"length":1,"stats":{"Line":0}},{"line":287,"address":[14170557,14170398],"length":1,"stats":{"Line":12}},{"line":292,"address":[13081604],"length":1,"stats":{"Line":7}},{"line":296,"address":[13078928],"length":1,"stats":{"Line":3}},{"line":298,"address":[14168023,14168078],"length":1,"stats":{"Line":6}},{"line":299,"address":[14149766],"length":1,"stats":{"Line":5}},{"line":300,"address":[20366161],"length":1,"stats":{"Line":5}},{"line":302,"address":[14168121],"length":1,"stats":{"Line":5}},{"line":304,"address":[20366216],"length":1,"stats":{"Line":5}},{"line":305,"address":[14168183],"length":1,"stats":{"Line":5}},{"line":306,"address":[13079142],"length":1,"stats":{"Line":6}},{"line":308,"address":[20366313],"length":1,"stats":{"Line":7}},{"line":309,"address":[14149996],"length":1,"stats":{"Line":8}},{"line":311,"address":[13079247],"length":1,"stats":{"Line":9}},{"line":312,"address":[20366418],"length":1,"stats":{"Line":9}},{"line":313,"address":[14150101],"length":1,"stats":{"Line":9}},{"line":315,"address":[20366488],"length":1,"stats":{"Line":9}},{"line":316,"address":[20366523],"length":1,"stats":{"Line":9}},{"line":317,"address":[13079422],"length":1,"stats":{"Line":9}},{"line":319,"address":[20366593],"length":1,"stats":{"Line":9}},{"line":323,"address":[14165122,14163600,14164673],"length":1,"stats":{"Line":3}},{"line":324,"address":[14145376],"length":1,"stats":{"Line":3}},{"line":325,"address":[14145497],"length":1,"stats":{"Line":2}},{"line":329,"address":[14163753],"length":1,"stats":{"Line":3}},{"line":330,"address":[14163862,14163763],"length":1,"stats":{"Line":10}},{"line":333,"address":[14164056,14164186],"length":1,"stats":{"Line":15}},{"line":334,"address":[14163874,14163942],"length":1,"stats":{"Line":12}},{"line":335,"address":[14163969,14164037],"length":1,"stats":{"Line":14}},{"line":337,"address":[14145929],"length":1,"stats":{"Line":7}},{"line":338,"address":[20362437,20362516,20362564],"length":1,"stats":{"Line":19}},{"line":339,"address":[14146155],"length":1,"stats":{"Line":4}},{"line":341,"address":[14146175,14146131],"length":1,"stats":{"Line":14}},{"line":346,"address":[20362280,20362791,20362839,20362881],"length":1,"stats":{"Line":0}},{"line":347,"address":[20362826],"length":1,"stats":{"Line":0}},{"line":349,"address":[14164738,14164694],"length":1,"stats":{"Line":0}},{"line":357,"address":[20366050,20366044,20364976],"length":1,"stats":{"Line":4}},{"line":358,"address":[14148651],"length":1,"stats":{"Line":3}},{"line":363,"address":[16248558,16248544],"length":1,"stats":{"Line":12}},{"line":364,"address":[13077987],"length":1,"stats":{"Line":12}},{"line":365,"address":[13799294,13799280],"length":1,"stats":{"Line":14}},{"line":366,"address":[14148793],"length":1,"stats":{"Line":13}},{"line":367,"address":[14148818],"length":1,"stats":{"Line":14}},{"line":368,"address":[14148843],"length":1,"stats":{"Line":13}},{"line":369,"address":[14148868],"length":1,"stats":{"Line":5}},{"line":372,"address":[14148911],"length":1,"stats":{"Line":4}},{"line":375,"address":[20365415],"length":1,"stats":{"Line":5}},{"line":376,"address":[20365458,20365529],"length":1,"stats":{"Line":10}},{"line":377,"address":[14149303,14149225],"length":1,"stats":{"Line":4}},{"line":378,"address":[14149456,14149260],"length":1,"stats":{"Line":4}},{"line":379,"address":[14149211,14149679],"length":1,"stats":{"Line":10}}],"covered":150,"coverable":161},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","providers","mod.rs"],"content":"//! LSP feature providers (inlay hints, diagnostics, hover, etc.)\n\npub mod code_actions;\npub mod completion;\npub mod diagnostics;\npub mod inlay_hints;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","crates_io.rs"],"content":"//! # crates.io Registry Client\n//!\n//! This module implements a client for the [crates.io](https://crates.io) registry,\n//! the official Rust package registry managed by the Rust Foundation.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://crates.io/api/v1`\n//! - **API Version**: v1 (stable)\n//!\n//! ## Rate Limiting\n//!\n//! The crates.io API enforces **strict rate limits** to protect the service.\n//! This client implements a built-in rate limiter that enforces **1 request per second**.\n//!\n//! **Exceeding the rate limit may result in IP-based blocking.**\n//!\n//! ## API Endpoints Used\n//!\n//! ### Fetch Crate Info\n//!\n//! - **Endpoint**: `GET /api/v1/crates/{crate_name}`\n//! - **Response**: JSON containing crate metadata and all versions\n//! - **Fields**:\n//!   - `crate.max_stable_version`: Latest stable release\n//!   - `crate.description`: Package description\n//!   - `crate.homepage`: Optional homepage URL\n//!   - `crate.repository`: Optional repository URL\n//!   - `versions[]`: Array of all published versions\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: Semver with optional pre-release tags (`-alpha`, `-beta`, `-rc`)\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00Z`)\n//! - **Yanked versions**: Marked with `yanked: true` in versions array\n//! - **License**: Per-version field (SPDX expression)\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Name normalization**: Underscores and hyphens are equivalent (`foo-bar` = `foo_bar`)\n//! - **Case sensitivity**: Names are case-insensitive but stored lowercase\n//! - **404 responses**: Returned for both \"not found\" and \"private crates\"\n//! - **Yanked versions**: Still available but marked; users are warned\n//! - **Features**: `features` field lists Cargo feature flags (not exposed by this client)\n//!\n//! ## Error Handling\n//!\n//! - **Rate limiting**: Client-side enforcement (1 req/s)\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: Non-success status codes return an error\n//!\n//! ## External References\n//!\n//! - [crates.io Data Access](https://crates.io/data-access)\n//! - [crates.io Policies](https://crates.io/policies)\n//! - [Crate Metadata Schema](https://doc.rust-lang.org/cargo/reference/registry-index.html)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\nuse std::time::{Duration, Instant};\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\nuse tokio::sync::Mutex;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_rust;\nuse super::{Registry, VersionInfo};\n\n/// Rate limiter to respect crates.io's 1 request/second limit\nstruct RateLimiter {\n    last_request: Instant,\n    min_interval: Duration,\n}\n\nimpl RateLimiter {\n    fn new(requests_per_second: f64) -\u003e Self {\n        Self {\n            last_request: Instant::now() - Duration::from_secs(10),\n            min_interval: Duration::from_secs_f64(1.0 / requests_per_second),\n        }\n    }\n\n    async fn wait(\u0026mut self) {\n        let elapsed = self.last_request.elapsed();\n        if elapsed \u003c self.min_interval {\n            tokio::time::sleep(self.min_interval - elapsed).await;\n        }\n        self.last_request = Instant::now();\n    }\n}\n\n/// Client for the crates.io registry\npub struct CratesIoRegistry {\n    client: Arc\u003cClient\u003e,\n    rate_limiter: Arc\u003cMutex\u003cRateLimiter\u003e\u003e,\n    base_url: String,\n}\n\nimpl CratesIoRegistry {\n    /// Creates a CratesIoRegistry that uses the provided shared HTTP client.\n    ///\n    /// The registry will use the given `client` for all HTTP requests, enforce a\n    /// default rate limit of 1 request per second, and target the crates.io API\n    /// base URL.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::crates_io::CratesIoRegistry;\n    /// use dependi_lsp::registries::http_client::create_shared_client;\n    ///\n    /// let client = create_shared_client().expect(\"failed to create client\");\n    /// let registry = CratesIoRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            rate_limiter: Arc::new(Mutex::new(RateLimiter::new(1.0))),\n            base_url: \"https://crates.io/api/v1\".to_string(),\n        }\n    }\n}\n\nimpl Default for CratesIoRegistry {\n    /// Creates a `CratesIoRegistry` configured with a shared HTTP client and default rate limiting.\n    ///\n    /// The registry is initialized with a shared `reqwest::Client`, a 1 request/second rate limiter,\n    /// and the default crates.io API base URL.\n    ///\n    /// # Panics\n    ///\n    /// This function will panic if creating the shared HTTP client fails.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::crates_io::CratesIoRegistry;\n    ///\n    /// let _registry = CratesIoRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// API response structures\n#[derive(Debug, Deserialize)]\nstruct CrateResponse {\n    #[serde(rename = \"crate\")]\n    crate_info: CrateInfo,\n    versions: Vec\u003cVersionEntry\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct CrateInfo {\n    description: Option\u003cString\u003e,\n    homepage: Option\u003cString\u003e,\n    repository: Option\u003cString\u003e,\n    max_stable_version: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct VersionEntry {\n    num: String,\n    yanked: bool,\n    license: Option\u003cString\u003e,\n    created_at: Option\u003cString\u003e,\n}\n\nimpl Registry for CratesIoRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // Rate limiting\n        {\n            let mut limiter = self.rate_limiter.lock().await;\n            limiter.wait().await;\n        }\n\n        let url = format!(\"{}/crates/{}\", self.base_url, package_name);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch crate info for {}: {}\",\n                package_name,\n                response.status()\n            );\n        }\n\n        let crate_response: CrateResponse = response.json().await?;\n\n        // Find latest stable version (not yanked, no prerelease)\n        let latest_stable = crate_response\n            .crate_info\n            .max_stable_version\n            .clone()\n            .or_else(|| {\n                crate_response\n                    .versions\n                    .iter()\n                    .find(|v| !v.yanked \u0026\u0026 !is_prerelease_rust(\u0026v.num))\n                    .map(|v| v.num.clone())\n            });\n\n        // Find latest prerelease\n        let latest_prerelease = crate_response\n            .versions\n            .iter()\n            .find(|v| !v.yanked \u0026\u0026 is_prerelease_rust(\u0026v.num))\n            .map(|v| v.num.clone());\n\n        // Get all versions (not yanked)\n        let versions: Vec\u003cString\u003e = crate_response\n            .versions\n            .iter()\n            .filter(|v| !v.yanked)\n            .map(|v| v.num.clone())\n            .collect();\n\n        // Get license from latest version\n        let license = crate_response\n            .versions\n            .first()\n            .and_then(|v| v.license.clone());\n\n        // Collect all yanked versions\n        let yanked_versions: Vec\u003cString\u003e = crate_response\n            .versions\n            .iter()\n            .filter(|v| v.yanked)\n            .map(|v| v.num.clone())\n            .collect();\n\n        // Collect release dates for all versions\n        let release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = crate_response\n            .versions\n            .iter()\n            .filter_map(|v| {\n                v.created_at.as_ref().and_then(|date_str| {\n                    DateTime::parse_from_rfc3339(date_str)\n                        .ok()\n                        .map(|dt| (v.num.clone(), dt.with_timezone(\u0026Utc)))\n                })\n            })\n            .collect();\n\n        // Check if latest version is yanked (kept for backwards compatibility)\n        let yanked = crate_response.versions.first().is_some_and(|v| v.yanked);\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease,\n            versions,\n            description: crate_response.crate_info.description,\n            homepage: crate_response.crate_info.homepage,\n            repository: crate_response.crate_info.repository,\n            license,\n            vulnerabilities: vec![], // Filled by OSV\n            deprecated: false,       // Filled by OSV\n            yanked,\n            yanked_versions,\n            release_dates,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_rust(\"1.0.0-alpha\"));\n        assert!(is_prerelease_rust(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_rust(\"1.0.0-rc1\"));\n        assert!(!is_prerelease_rust(\"1.0.0\"));\n        assert!(!is_prerelease_rust(\"2.3.4\"));\n    }\n}\n","traces":[{"line":78,"address":[14044144],"length":1,"stats":{"Line":3}},{"line":80,"address":[14062458],"length":1,"stats":{"Line":3}},{"line":81,"address":[14062523],"length":1,"stats":{"Line":2}},{"line":85,"address":[19737091,19737049,19737364,19736944,19736969,19737597],"length":1,"stats":{"Line":0}},{"line":86,"address":[14024552,14024688],"length":1,"stats":{"Line":0}},{"line":87,"address":[19737158],"length":1,"stats":{"Line":0}},{"line":88,"address":[13324698,13324548,13324867],"length":1,"stats":{"Line":0}},{"line":90,"address":[19737198,19737561],"length":1,"stats":{"Line":0}},{"line":118,"address":[17407520,17407803,17407797],"length":1,"stats":{"Line":4}},{"line":121,"address":[17407607,17407563],"length":1,"stats":{"Line":5}},{"line":122,"address":[17407658],"length":1,"stats":{"Line":2}},{"line":144,"address":[14064000],"length":1,"stats":{"Line":2}},{"line":145,"address":[14064014],"length":1,"stats":{"Line":2}},{"line":174,"address":[14044064],"length":1,"stats":{"Line":2}},{"line":175,"address":[14044069],"length":1,"stats":{"Line":2}},{"line":178,"address":[13317913,13317657,13317771,13317721,13318323,13317502,13317440,13317700,13317742],"length":1,"stats":{"Line":0}},{"line":181,"address":[15245615],"length":1,"stats":{"Line":0}},{"line":182,"address":[19730865,19730685,19730764,19730236],"length":1,"stats":{"Line":0}},{"line":185,"address":[19731062],"length":1,"stats":{"Line":0}},{"line":187,"address":[13318979,13318819,13317729,13318728,13320025],"length":1,"stats":{"Line":0}},{"line":189,"address":[14019284,14019352],"length":1,"stats":{"Line":0}},{"line":190,"address":[14019514,14019403],"length":1,"stats":{"Line":0}},{"line":197,"address":[12752235],"length":1,"stats":{"Line":0}},{"line":204,"address":[14039048,14042112],"length":1,"stats":{"Line":0}},{"line":205,"address":[14042144],"length":1,"stats":{"Line":0}},{"line":207,"address":[13323595],"length":1,"stats":{"Line":0}},{"line":208,"address":[13323984,13323610,13324003],"length":1,"stats":{"Line":0}},{"line":209,"address":[13323628,13324064,13324080],"length":1,"stats":{"Line":0}},{"line":213,"address":[19733530,19733403],"length":1,"stats":{"Line":0}},{"line":216,"address":[13321026,13323328,13323347],"length":1,"stats":{"Line":0}},{"line":217,"address":[13323520,13321057,13323536],"length":1,"stats":{"Line":0}},{"line":220,"address":[19733608],"length":1,"stats":{"Line":0}},{"line":223,"address":[14023392,14023402,14021167],"length":1,"stats":{"Line":0}},{"line":224,"address":[14023680,14021210,14023715],"length":1,"stats":{"Line":0}},{"line":228,"address":[14021280],"length":1,"stats":{"Line":0}},{"line":231,"address":[14039695,14042048,14042032],"length":1,"stats":{"Line":0}},{"line":234,"address":[13321458],"length":1,"stats":{"Line":0}},{"line":237,"address":[13323712,13323722,13321571],"length":1,"stats":{"Line":0}},{"line":238,"address":[14023424,14021594,14023459],"length":1,"stats":{"Line":0}},{"line":242,"address":[14039932],"length":1,"stats":{"Line":0}},{"line":245,"address":[14041856,14040046],"length":1,"stats":{"Line":0}},{"line":246,"address":[14041892,14042256],"length":1,"stats":{"Line":0}},{"line":247,"address":[19736522],"length":1,"stats":{"Line":0}},{"line":248,"address":[14024029],"length":1,"stats":{"Line":0}},{"line":249,"address":[14042343,14042471,14042448],"length":1,"stats":{"Line":0}},{"line":255,"address":[14042213,14042208,14040096,14040179],"length":1,"stats":{"Line":0}},{"line":257,"address":[19734855],"length":1,"stats":{"Line":0}},{"line":258,"address":[14040228],"length":1,"stats":{"Line":0}},{"line":259,"address":[14040268],"length":1,"stats":{"Line":0}},{"line":260,"address":[13321984],"length":1,"stats":{"Line":0}},{"line":261,"address":[19734552],"length":1,"stats":{"Line":0}},{"line":262,"address":[14040388],"length":1,"stats":{"Line":0}},{"line":263,"address":[14040428],"length":1,"stats":{"Line":0}},{"line":264,"address":[14040468],"length":1,"stats":{"Line":0}},{"line":265,"address":[14022220],"length":1,"stats":{"Line":0}},{"line":268,"address":[14022287],"length":1,"stats":{"Line":0}},{"line":269,"address":[14022319],"length":1,"stats":{"Line":0}}],"covered":10,"coverable":57},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","go_proxy.rs"],"content":"//! # Go Module Proxy Client\n//!\n//! This module implements a client for the [Go Module Proxy](https://proxy.golang.org),\n//! the official module mirror and checksum database for Go modules.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://proxy.golang.org`\n//! - **API Version**: Module Proxy Protocol (stable)\n//! - **Authentication**: Not required for public modules\n//! - **GOPROXY**: Supports custom proxy URLs via environment variable\n//!\n//! ## Rate Limiting\n//!\n//! The Go proxy does not publish official rate limits but implements:\n//!\n//! - **Fair use policy**: No hard limits for normal usage\n//! - **CDN caching**: Most requests are served from cache\n//! - **Best practice**: Respect cache headers\n//!\n//! ## API Endpoints Used\n//!\n//! ### List Versions\n//!\n//! - **Endpoint**: `GET /{module}/@v/list`\n//! - **Response**: Plain text, one version per line\n//! - **Example**: `v1.0.0\\nv1.0.1\\nv1.1.0`\n//!\n//! ### Get Latest Version\n//!\n//! - **Endpoint**: `GET /{module}/@latest`\n//! - **Response**: JSON with version and timestamp\n//! - **Fields**:\n//!   - `Version`: Version string (e.g., `v1.2.3`)\n//!   - `Time`: RFC 3339 timestamp\n//!\n//! ### Get Version Info\n//!\n//! - **Endpoint**: `GET /{module}/@v/{version}.info`\n//! - **Response**: JSON with version metadata\n//! - **Fields**:\n//!   - `Version`: Canonical version string\n//!   - `Time`: RFC 3339 release timestamp\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: Semver with `v` prefix required (`v1.0.0`, `v2.0.0-rc1`)\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00Z`)\n//! - **Module paths**: May contain version suffix for v2+ (`/v2`, `/v3`)\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Module path encoding**: Uppercase letters become `!` + lowercase\n//!   (`github.com/Azure/sdk` → `github.com/!azure/sdk`)\n//! - **Major version suffixes**: v2+ modules have path suffix (`module/v2`)\n//! - **Pseudo-versions**: Auto-generated for commits without tags\n//!   (`v0.0.0-20210101000000-abcdef123456`)\n//! - **Private modules**: Not available on public proxy; require `GOPRIVATE`\n//! - **Checksum database**: `sum.golang.org` verifies module integrity\n//! - **Retracted versions**: Marked in `go.mod` but still listed\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found, 410 for gone/retracted\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [Go Module Proxy Protocol](https://go.dev/ref/mod#module-proxy)\n//! - [Module Version Numbering](https://go.dev/ref/mod#versions)\n//! - [Checksum Database](https://sum.golang.org/)\n//! - [GOPROXY Environment Variable](https://go.dev/ref/mod#environment-variables)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_go;\nuse super::{Registry, VersionInfo};\n\n/// Client for the Go module proxy\npub struct GoProxyRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl GoProxyRegistry {\n    /// Creates a GoProxyRegistry that uses the provided shared HTTP client and the default Go proxy base URL.\n    ///\n    /// `client` is the shared `reqwest::Client` used for all outgoing HTTP requests to the Go proxy.\n    /// The returned registry is configured with `base_url` set to `https://proxy.golang.org`.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::go_proxy::GoProxyRegistry;\n    ///\n    /// let client = Arc::new(reqwest::Client::new());\n    /// let _registry = GoProxyRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://proxy.golang.org\".to_string(),\n        }\n    }\n}\n\nimpl Default for GoProxyRegistry {\n    /// Creates a GoProxyRegistry configured with a shared HTTP client.\n    ///\n    /// The registry's HTTP client is produced by `create_shared_client`.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::go_proxy::GoProxyRegistry;\n    ///\n    /// let registry = GoProxyRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// Go proxy API response for version info\n#[derive(Debug, Deserialize)]\nstruct VersionInfoResponse {\n    #[serde(rename = \"Version\")]\n    version: String,\n    #[serde(rename = \"Time\")]\n    time: Option\u003cString\u003e,\n}\n\nimpl Registry for GoProxyRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, module_path: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // Encode module path for URL\n        // Go proxy requires case-encoding: uppercase letters become ! followed by lowercase\n        let encoded_path = encode_module_path(module_path);\n\n        // Fetch list of versions\n        let versions = self.fetch_versions(\u0026encoded_path).await.unwrap_or_default();\n\n        // Fetch latest version info\n        let latest = self.fetch_latest(\u0026encoded_path).await.ok();\n\n        // Sort versions in descending order\n        let mut sorted_versions = versions.clone();\n        sorted_versions.sort_by(|a, b| compare_go_versions(b, a));\n\n        // Find latest stable version (no prerelease suffix)\n        let latest_stable = latest.as_ref().map(|l| l.version.clone()).or_else(|| {\n            sorted_versions\n                .iter()\n                .find(|v| !is_prerelease_go(v))\n                .cloned()\n        });\n\n        // Find latest prerelease\n        let latest_prerelease = sorted_versions\n            .iter()\n            .find(|v| is_prerelease_go(v))\n            .cloned();\n\n        // Build repository URL for common hosts\n        let repository =\n            if module_path.starts_with(\"github.com/\") || module_path.starts_with(\"gitlab.com/\") {\n                Some(format!(\"https://{}\", module_path))\n            } else {\n                None\n            };\n\n        // Fetch release dates for versions (fetch info for each version in parallel)\n        let release_dates = self\n            .fetch_version_times(\u0026encoded_path, \u0026sorted_versions)\n            .await;\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease,\n            versions: sorted_versions,\n            description: None, // Go proxy doesn't provide descriptions\n            homepage: None,\n            repository,\n            license: None,           // Would need to fetch go.mod or LICENSE file\n            vulnerabilities: vec![], // TODO: Integrate vuln.go.dev\n            deprecated: false,\n            yanked: false,\n            yanked_versions: vec![], // Not applicable to Go\n            release_dates,\n        })\n    }\n}\n\nimpl GoProxyRegistry {\n    /// Fetch list of available versions\n    async fn fetch_versions(\u0026self, encoded_path: \u0026str) -\u003e anyhow::Result\u003cVec\u003cString\u003e\u003e {\n        let url = format!(\"{}/{}/@v/list\", self.base_url, encoded_path);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch versions for {}: {}\",\n                encoded_path,\n                response.status()\n            );\n        }\n\n        let text = response.text().await?;\n        let versions: Vec\u003cString\u003e = text.lines().map(|s| s.trim().to_string()).collect();\n\n        Ok(versions)\n    }\n\n    /// Fetch latest version info\n    async fn fetch_latest(\u0026self, encoded_path: \u0026str) -\u003e anyhow::Result\u003cVersionInfoResponse\u003e {\n        let url = format!(\"{}/{}/@latest\", self.base_url, encoded_path);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch latest for {}: {}\",\n                encoded_path,\n                response.status()\n            );\n        }\n\n        let info: VersionInfoResponse = response.json().await?;\n        Ok(info)\n    }\n\n    /// Fetch version info for a specific version\n    async fn fetch_version_info(\n        \u0026self,\n        encoded_path: \u0026str,\n        version: \u0026str,\n    ) -\u003e Option\u003cVersionInfoResponse\u003e {\n        let url = format!(\"{}/{}/@v/{}.info\", self.base_url, encoded_path, version);\n\n        let response = self.client.get(\u0026url).send().await.ok()?;\n\n        if !response.status().is_success() {\n            return None;\n        }\n\n        response.json().await.ok()\n    }\n\n    /// Fetch release times for a list of versions (limited to first 10 for performance)\n    async fn fetch_version_times(\n        \u0026self,\n        encoded_path: \u0026str,\n        versions: \u0026[String],\n    ) -\u003e HashMap\u003cString, DateTime\u003cUtc\u003e\u003e {\n        use futures::future::join_all;\n\n        let futures: Vec\u003c_\u003e = versions\n            .iter()\n            .take(10)\n            .map(|v| async move {\n                self.fetch_version_info(encoded_path, v)\n                    .await\n                    .and_then(|info| {\n                        info.time.as_ref().and_then(|time_str| {\n                            DateTime::parse_from_rfc3339(time_str)\n                                .ok()\n                                .map(|dt| (v.clone(), dt.with_timezone(\u0026Utc)))\n                        })\n                    })\n            })\n            .collect();\n\n        let results = join_all(futures).await;\n        results.into_iter().flatten().collect()\n    }\n}\n\n/// Encode module path for Go proxy URL\n/// Uppercase letters are replaced with ! followed by lowercase\nfn encode_module_path(path: \u0026str) -\u003e String {\n    let mut result = String::with_capacity(path.len() * 2);\n\n    for ch in path.chars() {\n        if ch.is_ascii_uppercase() {\n            result.push('!');\n            result.push(ch.to_ascii_lowercase());\n        } else {\n            result.push(ch);\n        }\n    }\n\n    result\n}\n\n/// Compare Go versions for sorting\nfn compare_go_versions(a: \u0026str, b: \u0026str) -\u003e std::cmp::Ordering {\n    // Strip 'v' prefix if present\n    let a_stripped = a.strip_prefix('v').unwrap_or(a);\n    let b_stripped = b.strip_prefix('v').unwrap_or(b);\n\n    // Try parsing as semver\n    match (\n        semver::Version::parse(a_stripped),\n        semver::Version::parse(b_stripped),\n    ) {\n        (Ok(va), Ok(vb)) =\u003e va.cmp(\u0026vb),\n        _ =\u003e {\n            // Fallback to string comparison\n            compare_version_strings(a_stripped, b_stripped)\n        }\n    }\n}\n\n/// Simple version string comparison\nfn compare_version_strings(a: \u0026str, b: \u0026str) -\u003e std::cmp::Ordering {\n    let parse_parts = |s: \u0026str| -\u003e Vec\u003cu64\u003e {\n        s.split(|c: char| !c.is_ascii_digit())\n            .filter_map(|p| p.parse().ok())\n            .collect()\n    };\n\n    let parts_a = parse_parts(a);\n    let parts_b = parse_parts(b);\n\n    for (pa, pb) in parts_a.iter().zip(parts_b.iter()) {\n        match pa.cmp(pb) {\n            std::cmp::Ordering::Equal =\u003e continue,\n            other =\u003e return other,\n        }\n    }\n\n    parts_a.len().cmp(\u0026parts_b.len())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_encode_module_path() {\n        assert_eq!(\n            encode_module_path(\"github.com/Azure/azure-sdk-for-go\"),\n            \"github.com/!azure/azure-sdk-for-go\"\n        );\n        assert_eq!(\n            encode_module_path(\"github.com/gin-gonic/gin\"),\n            \"github.com/gin-gonic/gin\"\n        );\n        assert_eq!(encode_module_path(\"golang.org/x/text\"), \"golang.org/x/text\");\n    }\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_go(\"v1.0.0-rc1\"));\n        assert!(is_prerelease_go(\"v2.0.0-beta.1\"));\n        assert!(is_prerelease_go(\"v3.0.0-alpha\"));\n        assert!(!is_prerelease_go(\"v1.0.0\"));\n        assert!(!is_prerelease_go(\"v2.3.4\"));\n    }\n\n    #[test]\n    fn test_compare_go_versions() {\n        use std::cmp::Ordering;\n\n        assert_eq!(compare_go_versions(\"v1.0.0\", \"v2.0.0\"), Ordering::Less);\n        assert_eq!(compare_go_versions(\"v2.0.0\", \"v1.0.0\"), Ordering::Greater);\n        assert_eq!(compare_go_versions(\"v1.0.0\", \"v1.0.0\"), Ordering::Equal);\n        assert_eq!(compare_go_versions(\"v1.10.0\", \"v1.9.0\"), Ordering::Greater);\n    }\n}\n","traces":[{"line":107,"address":[14336388,14336256,14336394],"length":1,"stats":{"Line":2}},{"line":110,"address":[12998615],"length":1,"stats":{"Line":2}},{"line":127,"address":[20305200],"length":1,"stats":{"Line":0}},{"line":128,"address":[14339518],"length":1,"stats":{"Line":0}},{"line":142,"address":[20300336],"length":1,"stats":{"Line":2}},{"line":143,"address":[14336181],"length":1,"stats":{"Line":2}},{"line":146,"address":[14496268,14496204,14497066,14496297,14496559,14496247,14496032,14496094],"length":1,"stats":{"Line":0}},{"line":149,"address":[14496179],"length":1,"stats":{"Line":0}},{"line":152,"address":[15243823],"length":1,"stats":{"Line":0}},{"line":155,"address":[15243838],"length":1,"stats":{"Line":0}},{"line":158,"address":[20329214,20329295],"length":1,"stats":{"Line":0}},{"line":159,"address":[13101696,13099356,13099267,13101733],"length":1,"stats":{"Line":0}},{"line":162,"address":[13101936,13099371,13101792,13101952,13099439],"length":1,"stats":{"Line":0}},{"line":163,"address":[14471120],"length":1,"stats":{"Line":0}},{"line":164,"address":[14500060],"length":1,"stats":{"Line":0}},{"line":165,"address":[13101852,13101982,13101968],"length":1,"stats":{"Line":0}},{"line":166,"address":[20331982],"length":1,"stats":{"Line":0}},{"line":170,"address":[14497852,14497684,14497799],"length":1,"stats":{"Line":0}},{"line":172,"address":[13101902,13099631,13101888],"length":1,"stats":{"Line":0}},{"line":176,"address":[14498289,14497969,14498056,14497882],"length":1,"stats":{"Line":0}},{"line":178,"address":[14498132,14498025],"length":1,"stats":{"Line":0}},{"line":180,"address":[20329902],"length":1,"stats":{"Line":0}},{"line":184,"address":[14498099,14498698,14498471],"length":1,"stats":{"Line":0}},{"line":185,"address":[20329940,20330199],"length":1,"stats":{"Line":0}},{"line":186,"address":[14498794,14498436,14498535,14496276,14498504],"length":1,"stats":{"Line":0}},{"line":188,"address":[14499155],"length":1,"stats":{"Line":0}},{"line":189,"address":[14498820],"length":1,"stats":{"Line":0}},{"line":190,"address":[20330662],"length":1,"stats":{"Line":0}},{"line":191,"address":[14498888],"length":1,"stats":{"Line":0}},{"line":192,"address":[20330734],"length":1,"stats":{"Line":0}},{"line":193,"address":[13100710],"length":1,"stats":{"Line":0}},{"line":194,"address":[20330750],"length":1,"stats":{"Line":0}},{"line":195,"address":[14498976],"length":1,"stats":{"Line":0}},{"line":196,"address":[14470056],"length":1,"stats":{"Line":0}},{"line":199,"address":[14499047],"length":1,"stats":{"Line":0}},{"line":200,"address":[14499107],"length":1,"stats":{"Line":0}},{"line":207,"address":[20300946,20300928],"length":1,"stats":{"Line":0}},{"line":208,"address":[20334436,20334590],"length":1,"stats":{"Line":0}},{"line":210,"address":[12462767],"length":1,"stats":{"Line":0}},{"line":212,"address":[14503723,14503661],"length":1,"stats":{"Line":0}},{"line":213,"address":[20335579],"length":1,"stats":{"Line":0}},{"line":220,"address":[14475345,14476032,14473866,14475208,14474864],"length":1,"stats":{"Line":0}},{"line":221,"address":[14504750,14505024,14505077,14504673],"length":1,"stats":{"Line":0}},{"line":223,"address":[14504811],"length":1,"stats":{"Line":0}},{"line":227,"address":[13103694,13102271,13102228,13102300,13102064,13102697,13102111],"length":1,"stats":{"Line":0}},{"line":228,"address":[14471505,14471659],"length":1,"stats":{"Line":0}},{"line":230,"address":[20332290,20332604,20332763,20333694,20332523],"length":1,"stats":{"Line":0}},{"line":232,"address":[20333145,20333207],"length":1,"stats":{"Line":0}},{"line":233,"address":[14501591],"length":1,"stats":{"Line":0}},{"line":240,"address":[14502508,14501988,14501852,14500519,14501508],"length":1,"stats":{"Line":0}},{"line":241,"address":[20334119],"length":1,"stats":{"Line":0}},{"line":245,"address":[14336512],"length":1,"stats":{"Line":0}},{"line":250,"address":[13106898,13107057],"length":1,"stats":{"Line":0}},{"line":252,"address":[20337506,20337011,20337281,20337356,20338173],"length":1,"stats":{"Line":0}},{"line":254,"address":[13107847,13107906],"length":1,"stats":{"Line":0}},{"line":255,"address":[14477426],"length":1,"stats":{"Line":0}},{"line":258,"address":[15205109],"length":1,"stats":{"Line":0}},{"line":262,"address":[14336576],"length":1,"stats":{"Line":0}},{"line":272,"address":[14507194,14508431,14507712,14507811,14507898,14507776,14507940,14508099,14507728],"length":1,"stats":{"Line":0}},{"line":273,"address":[13109535,13109567,13109784,13109371],"length":1,"stats":{"Line":0}},{"line":274,"address":[14479151,14479404,14478997,14479202,14479098],"length":1,"stats":{"Line":0}},{"line":275,"address":[14479656,14479520,14479424],"length":1,"stats":{"Line":0}},{"line":276,"address":[13110080,13109973,13110036],"length":1,"stats":{"Line":0}},{"line":277,"address":[20340154],"length":1,"stats":{"Line":0}},{"line":278,"address":[20340173],"length":1,"stats":{"Line":0}},{"line":279,"address":[14479815,14479767,14479792],"length":1,"stats":{"Line":0}},{"line":285,"address":[14507383,14507250,14507098],"length":1,"stats":{"Line":0}},{"line":286,"address":[13109125],"length":1,"stats":{"Line":0}},{"line":292,"address":[14336640,14337100,14337094],"length":1,"stats":{"Line":2}},{"line":293,"address":[20301163,20301228],"length":1,"stats":{"Line":2}},{"line":295,"address":[20301211,20301292],"length":1,"stats":{"Line":4}},{"line":296,"address":[20301471,20301412],"length":1,"stats":{"Line":4}},{"line":297,"address":[20301506],"length":1,"stats":{"Line":2}},{"line":298,"address":[14318774],"length":1,"stats":{"Line":2}},{"line":300,"address":[14337049,14337013],"length":1,"stats":{"Line":4}},{"line":304,"address":[20301433],"length":1,"stats":{"Line":2}},{"line":308,"address":[14318832,14319740,14319891],"length":1,"stats":{"Line":2}},{"line":310,"address":[12999499],"length":1,"stats":{"Line":2}},{"line":311,"address":[14319027],"length":1,"stats":{"Line":2}},{"line":314,"address":[14337497,14337634],"length":1,"stats":{"Line":4}},{"line":315,"address":[14319110],"length":1,"stats":{"Line":2}},{"line":316,"address":[20301913],"length":1,"stats":{"Line":2}},{"line":318,"address":[14319377],"length":1,"stats":{"Line":2}},{"line":321,"address":[13000354,12999936],"length":1,"stats":{"Line":0}},{"line":327,"address":[20303642,20303648,20302832],"length":1,"stats":{"Line":0}},{"line":328,"address":[14480032],"length":1,"stats":{"Line":0}},{"line":329,"address":[14509025,14509165,14509152],"length":1,"stats":{"Line":0}},{"line":330,"address":[14509036,14509107,14509088],"length":1,"stats":{"Line":0}},{"line":334,"address":[13000792],"length":1,"stats":{"Line":0}},{"line":335,"address":[14320237],"length":1,"stats":{"Line":0}},{"line":337,"address":[20303104,20303024],"length":1,"stats":{"Line":0}},{"line":338,"address":[20303581,20303403],"length":1,"stats":{"Line":0}},{"line":340,"address":[14320876],"length":1,"stats":{"Line":0}},{"line":344,"address":[14320693],"length":1,"stats":{"Line":0}}],"covered":19,"coverable":94},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","http_client.rs"],"content":"//! Shared HTTP client for all registry clients.\n//!\n//! This module provides a shared HTTP client with proper configuration\n//! for connection pooling, HTTP/2, and timeout handling. Sharing a single\n//! client across all registries enables:\n//!\n//! - Connection reuse across different registries\n//! - HTTP/2 multiplexing where supported\n//! - Reduced TLS handshake overhead\n//! - Shared DNS cache\n//! - Lower memory footprint\n\nuse std::sync::Arc;\nuse std::time::Duration;\n\nuse reqwest::Client;\n\nconst USER_AGENT: \u0026str = concat!(\n    \"dependi-lsp/\",\n    env!(\"CARGO_PKG_VERSION\"),\n    \" (https://github.com/mpiton/zed-dependi)\"\n);\n\nconst DEFAULT_TIMEOUT: Duration = Duration::from_secs(10);\nconst POOL_IDLE_TIMEOUT: Duration = Duration::from_secs(90);\nconst CONNECT_TIMEOUT: Duration = Duration::from_secs(5);\n\npub fn create_shared_client() -\u003e anyhow::Result\u003cArc\u003cClient\u003e\u003e {\n    let client = Client::builder()\n        .user_agent(USER_AGENT)\n        .timeout(DEFAULT_TIMEOUT)\n        .connect_timeout(CONNECT_TIMEOUT)\n        .pool_idle_timeout(POOL_IDLE_TIMEOUT)\n        .pool_max_idle_per_host(10)\n        .tcp_keepalive(Duration::from_secs(60))\n        .build()?;\n\n    Ok(Arc::new(client))\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::registries::Registry;\n    use crate::registries::crates_io::CratesIoRegistry;\n    use crate::registries::go_proxy::GoProxyRegistry;\n    use crate::registries::npm::NpmRegistry;\n    use crate::registries::nuget::NuGetRegistry;\n    use crate::registries::packagist::PackagistRegistry;\n    use crate::registries::pub_dev::PubDevRegistry;\n    use crate::registries::pypi::PyPiRegistry;\n    use crate::registries::rubygems::RubyGemsRegistry;\n\n    #[test]\n    fn test_create_shared_client() {\n        let client = create_shared_client().expect(\"Failed to create client\");\n        assert!(Arc::strong_count(\u0026client) == 1);\n    }\n\n    #[test]\n    fn test_client_can_be_cloned() {\n        let client = create_shared_client().expect(\"Failed to create client\");\n        let client2 = Arc::clone(\u0026client);\n        assert!(Arc::strong_count(\u0026client) == 2);\n        drop(client2);\n        assert!(Arc::strong_count(\u0026client) == 1);\n    }\n\n    #[test]\n    fn test_registries_share_client_instance() {\n        let shared_client = create_shared_client().expect(\"Failed to create client\");\n        let client_ptr = Arc::as_ptr(\u0026shared_client);\n\n        let crates_io = CratesIoRegistry::with_client(Arc::clone(\u0026shared_client));\n        let npm = NpmRegistry::with_client(Arc::clone(\u0026shared_client));\n        let pypi = PyPiRegistry::with_client(Arc::clone(\u0026shared_client));\n        let go_proxy = GoProxyRegistry::with_client(Arc::clone(\u0026shared_client));\n        let packagist = PackagistRegistry::with_client(Arc::clone(\u0026shared_client));\n        let pub_dev = PubDevRegistry::with_client(Arc::clone(\u0026shared_client));\n        let nuget = NuGetRegistry::with_client(Arc::clone(\u0026shared_client));\n        let rubygems = RubyGemsRegistry::with_client(Arc::clone(\u0026shared_client));\n\n        assert_eq!(Arc::as_ptr(\u0026crates_io.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026npm.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026pypi.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026go_proxy.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026packagist.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026pub_dev.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026nuget.http_client()), client_ptr);\n        assert_eq!(Arc::as_ptr(\u0026rubygems.http_client()), client_ptr);\n\n        assert_eq!(Arc::strong_count(\u0026shared_client), 9);\n    }\n\n    #[test]\n    fn test_default_registries_create_separate_clients() {\n        let crates_io = CratesIoRegistry::default();\n        let npm = NpmRegistry::default();\n\n        assert_ne!(\n            Arc::as_ptr(\u0026crates_io.http_client()),\n            Arc::as_ptr(\u0026npm.http_client())\n        );\n    }\n}\n","traces":[{"line":28,"address":[13012294,13012323,13011712],"length":1,"stats":{"Line":2}},{"line":29,"address":[13012162,13012129,13012032,13012089,13011734],"length":1,"stats":{"Line":21}},{"line":30,"address":[19036289],"length":1,"stats":{"Line":3}},{"line":31,"address":[13011816],"length":1,"stats":{"Line":3}},{"line":32,"address":[13011863],"length":1,"stats":{"Line":4}},{"line":33,"address":[13011899],"length":1,"stats":{"Line":5}},{"line":35,"address":[13012329,13011982,13012040,13011966],"length":1,"stats":{"Line":10}},{"line":38,"address":[13012188,13012254],"length":1,"stats":{"Line":12}}],"covered":8,"coverable":8},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","mod.rs"],"content":"//! # Package Registry Clients\n//!\n//! This module provides clients for fetching package version information from\n//! various package registries across different programming ecosystems.\n//!\n//! ## Supported Registries\n//!\n//! | Registry | Ecosystem | Module |\n//! |----------|-----------|--------|\n//! | [crates.io](https://crates.io) | Rust | [`crates_io`] |\n//! | [npm](https://www.npmjs.com) | Node.js/JavaScript | [`npm`] |\n//! | [PyPI](https://pypi.org) | Python | [`pypi`] |\n//! | [Go Proxy](https://proxy.golang.org) | Go | [`go_proxy`] |\n//! | [Packagist](https://packagist.org) | PHP/Composer | [`packagist`] |\n//! | [pub.dev](https://pub.dev) | Dart/Flutter | [`pub_dev`] |\n//! | [NuGet](https://www.nuget.org) | .NET | [`nuget`] |\n//! | [RubyGems](https://rubygems.org) | Ruby | [`rubygems`] |\n//!\n//! ## Architecture\n//!\n//! All registry clients implement the [`Registry`] trait, providing a unified\n//! interface for fetching package metadata:\n//!\n//! ```ignore\n//! pub trait Registry: Send + Sync {\n//!     async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e;\n//!     fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e;\n//! }\n//! ```\n//!\n//! ## Shared HTTP Client\n//!\n//! Registry clients share a single HTTP client via [`http_client::create_shared_client`]\n//! for connection pooling, HTTP/2 multiplexing, and reduced memory footprint.\n//!\n//! ## Common Return Type\n//!\n//! All registries return [`VersionInfo`] containing:\n//!\n//! - **Latest stable version**: The most recent non-prerelease version\n//! - **Latest prerelease**: The most recent prerelease version (if any)\n//! - **All versions**: Complete list of available versions\n//! - **Metadata**: Description, homepage, repository, license\n//! - **Status**: Deprecated, yanked flags\n//! - **Release dates**: Publish timestamps for each version\n//!\n//! ## Vulnerability Detection\n//!\n//! Vulnerability information is populated separately via the OSV API\n//! (see `vulnerabilities` module), not by the registry clients themselves.\n//!\n//! ## Rate Limiting\n//!\n//! Each registry has different rate limiting policies:\n//!\n//! | Registry | Rate Limit | Notes |\n//! |----------|------------|-------|\n//! | crates.io | 1 req/s | **Strict** - client-side enforced |\n//! | npm | ≤1 req/s recommended | No official limit; IP blocking for abuse |\n//! | PyPI | No official limit | CDN-cached; be respectful |\n//! | Go Proxy | Fair use | No hard limit |\n//! | Packagist | ~60/min | CDN-cached |\n//! | pub.dev | ~100/min | CDN-cached |\n//! | NuGet | Fair use | CDN-cached |\n//! | RubyGems | Varies by endpoint | ~10 req/s typical; blocking for abuse |\n//!\n//! ## Usage\n//!\n//! ```ignore\n//! use dependi_lsp::registries::{Registry, crates_io::CratesIoRegistry};\n//!\n//! let registry = CratesIoRegistry::default();\n//! let info = registry.get_version_info(\"serde\").await?;\n//! println!(\"Latest: {:?}\", info.latest);\n//! ```\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::{Deserialize, Serialize};\n\n/// Information about a package version from a registry\n#[derive(Debug, Clone, Serialize, Deserialize, Default)]\npub struct VersionInfo {\n    /// Latest stable version\n    pub latest: Option\u003cString\u003e,\n    /// Latest prerelease version\n    pub latest_prerelease: Option\u003cString\u003e,\n    /// All available versions\n    pub versions: Vec\u003cString\u003e,\n    /// Package description\n    pub description: Option\u003cString\u003e,\n    /// Homepage URL\n    pub homepage: Option\u003cString\u003e,\n    /// Repository URL (GitHub, etc.)\n    pub repository: Option\u003cString\u003e,\n    /// SPDX license identifier\n    pub license: Option\u003cString\u003e,\n    /// Known vulnerabilities\n    pub vulnerabilities: Vec\u003cVulnerability\u003e,\n    /// Whether the package is deprecated\n    pub deprecated: bool,\n    /// Whether the version is yanked (Rust specific) - deprecated, use yanked_versions instead\n    pub yanked: bool,\n    /// List of yanked version numbers (Rust specific)\n    pub yanked_versions: Vec\u003cString\u003e,\n    /// Release dates for each version (version string -\u003e DateTime)\n    #[serde(default)]\n    pub release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e,\n}\n\nimpl VersionInfo {\n    /// Check if a specific version is yanked\n    pub fn is_version_yanked(\u0026self, version: \u0026str) -\u003e bool {\n        let normalized = normalize_version_for_yanked_check(version);\n        self.yanked_versions\n            .iter()\n            .any(|v| normalize_version_for_yanked_check(v) == normalized)\n    }\n\n    /// Get the release date for a specific version\n    pub fn get_release_date(\u0026self, version: \u0026str) -\u003e Option\u003cDateTime\u003cUtc\u003e\u003e {\n        self.release_dates.get(version).copied()\n    }\n}\n\n/// Normalize version for yanked check comparison\n/// Removes common prefixes like ^, ~, \u003e=, etc.\nfn normalize_version_for_yanked_check(version: \u0026str) -\u003e String {\n    let version = version.trim();\n    version\n        .strip_prefix('^')\n        .or_else(|| version.strip_prefix('~'))\n        .or_else(|| version.strip_prefix(\"\u003e=\"))\n        .or_else(|| version.strip_prefix(\"\u003c=\"))\n        .or_else(|| version.strip_prefix('\u003e'))\n        .or_else(|| version.strip_prefix('\u003c'))\n        .or_else(|| version.strip_prefix('='))\n        .unwrap_or(version)\n        .split(',')\n        .next()\n        .unwrap_or(version)\n        .trim()\n        .to_string()\n}\n\n/// Vulnerability information\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Vulnerability {\n    /// CVE or advisory ID\n    pub id: String,\n    /// Severity level\n    pub severity: VulnerabilitySeverity,\n    /// Description of the vulnerability\n    pub description: String,\n    /// URL for more information\n    pub url: Option\u003cString\u003e,\n}\n\n/// Vulnerability severity levels\n#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq)]\npub enum VulnerabilitySeverity {\n    Low,\n    Medium,\n    High,\n    Critical,\n}\n\nimpl VulnerabilitySeverity {\n    /// Get numeric rank for severity comparison (higher = more severe)\n    pub fn rank(\u0026self) -\u003e u8 {\n        match self {\n            VulnerabilitySeverity::Low =\u003e 1,\n            VulnerabilitySeverity::Medium =\u003e 2,\n            VulnerabilitySeverity::High =\u003e 3,\n            VulnerabilitySeverity::Critical =\u003e 4,\n        }\n    }\n\n    /// Check if this severity meets or exceeds a minimum threshold\n    pub fn meets_threshold(\u0026self, min: \u0026Self) -\u003e bool {\n        self.rank() \u003e= min.rank()\n    }\n\n    /// Parse severity from string (case-insensitive)\n    pub fn from_str_loose(s: \u0026str) -\u003e Self {\n        match s.to_lowercase().as_str() {\n            \"critical\" =\u003e VulnerabilitySeverity::Critical,\n            \"high\" =\u003e VulnerabilitySeverity::High,\n            \"medium\" =\u003e VulnerabilitySeverity::Medium,\n            _ =\u003e VulnerabilitySeverity::Low,\n        }\n    }\n\n    /// Get lowercase string representation\n    pub fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            VulnerabilitySeverity::Low =\u003e \"low\",\n            VulnerabilitySeverity::Medium =\u003e \"medium\",\n            VulnerabilitySeverity::High =\u003e \"high\",\n            VulnerabilitySeverity::Critical =\u003e \"critical\",\n        }\n    }\n}\n\n/// Trait for registry clients\n/// Note: async_fn_in_trait is allowed because this trait is internal and already bounds Send + Sync\n#[allow(async_fn_in_trait)]\npub trait Registry: Send + Sync {\n    /// Get version information for a package\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e;\n\n    /// Get a reference to the HTTP client used by this registry\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e;\n}\n\npub mod crates_io;\npub mod go_proxy;\npub mod http_client;\npub mod npm;\npub mod nuget;\npub mod packagist;\npub mod pub_dev;\npub mod pypi;\npub mod rubygems;\npub mod version_utils;\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_severity_rank() {\n        assert_eq!(VulnerabilitySeverity::Low.rank(), 1);\n        assert_eq!(VulnerabilitySeverity::Medium.rank(), 2);\n        assert_eq!(VulnerabilitySeverity::High.rank(), 3);\n        assert_eq!(VulnerabilitySeverity::Critical.rank(), 4);\n    }\n\n    #[test]\n    fn test_severity_meets_threshold() {\n        // Critical meets all thresholds\n        assert!(VulnerabilitySeverity::Critical.meets_threshold(\u0026VulnerabilitySeverity::Low));\n        assert!(VulnerabilitySeverity::Critical.meets_threshold(\u0026VulnerabilitySeverity::Medium));\n        assert!(VulnerabilitySeverity::Critical.meets_threshold(\u0026VulnerabilitySeverity::High));\n        assert!(VulnerabilitySeverity::Critical.meets_threshold(\u0026VulnerabilitySeverity::Critical));\n\n        // Low only meets Low threshold\n        assert!(VulnerabilitySeverity::Low.meets_threshold(\u0026VulnerabilitySeverity::Low));\n        assert!(!VulnerabilitySeverity::Low.meets_threshold(\u0026VulnerabilitySeverity::Medium));\n        assert!(!VulnerabilitySeverity::Low.meets_threshold(\u0026VulnerabilitySeverity::High));\n        assert!(!VulnerabilitySeverity::Low.meets_threshold(\u0026VulnerabilitySeverity::Critical));\n\n        // High meets Low, Medium, and High thresholds\n        assert!(VulnerabilitySeverity::High.meets_threshold(\u0026VulnerabilitySeverity::Low));\n        assert!(VulnerabilitySeverity::High.meets_threshold(\u0026VulnerabilitySeverity::Medium));\n        assert!(VulnerabilitySeverity::High.meets_threshold(\u0026VulnerabilitySeverity::High));\n        assert!(!VulnerabilitySeverity::High.meets_threshold(\u0026VulnerabilitySeverity::Critical));\n    }\n\n    #[test]\n    fn test_severity_from_str_loose() {\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"critical\"),\n            VulnerabilitySeverity::Critical\n        );\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"CRITICAL\"),\n            VulnerabilitySeverity::Critical\n        );\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"high\"),\n            VulnerabilitySeverity::High\n        );\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"HIGH\"),\n            VulnerabilitySeverity::High\n        );\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"medium\"),\n            VulnerabilitySeverity::Medium\n        );\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"low\"),\n            VulnerabilitySeverity::Low\n        );\n        // Unknown strings default to Low\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"unknown\"),\n            VulnerabilitySeverity::Low\n        );\n        assert_eq!(\n            VulnerabilitySeverity::from_str_loose(\"\"),\n            VulnerabilitySeverity::Low\n        );\n    }\n\n    #[test]\n    fn test_severity_as_str() {\n        assert_eq!(VulnerabilitySeverity::Low.as_str(), \"low\");\n        assert_eq!(VulnerabilitySeverity::Medium.as_str(), \"medium\");\n        assert_eq!(VulnerabilitySeverity::High.as_str(), \"high\");\n        assert_eq!(VulnerabilitySeverity::Critical.as_str(), \"critical\");\n    }\n\n    #[test]\n    fn test_is_version_yanked() {\n        let info = VersionInfo {\n            yanked_versions: vec![\"1.0.0\".to_string(), \"1.0.1\".to_string()],\n            ..Default::default()\n        };\n\n        assert!(info.is_version_yanked(\"1.0.0\"));\n        assert!(info.is_version_yanked(\"1.0.1\"));\n        assert!(!info.is_version_yanked(\"1.0.2\"));\n        assert!(!info.is_version_yanked(\"2.0.0\"));\n    }\n\n    #[test]\n    fn test_is_version_yanked_with_prefixes() {\n        let info = VersionInfo {\n            yanked_versions: vec![\"1.0.0\".to_string()],\n            ..Default::default()\n        };\n\n        assert!(info.is_version_yanked(\"^1.0.0\"));\n        assert!(info.is_version_yanked(\"~1.0.0\"));\n        assert!(info.is_version_yanked(\"\u003e=1.0.0\"));\n        assert!(info.is_version_yanked(\"=1.0.0\"));\n    }\n\n    #[test]\n    fn test_is_version_yanked_empty() {\n        let info = VersionInfo::default();\n\n        assert!(!info.is_version_yanked(\"1.0.0\"));\n    }\n}\n","traces":[{"line":116,"address":[14819591,14819597,14819392],"length":1,"stats":{"Line":3}},{"line":117,"address":[13055872],"length":1,"stats":{"Line":3}},{"line":118,"address":[14819535,14819434],"length":1,"stats":{"Line":23}},{"line":120,"address":[13716446,13716416],"length":1,"stats":{"Line":18}},{"line":124,"address":[13084656],"length":1,"stats":{"Line":3}},{"line":125,"address":[18694132],"length":1,"stats":{"Line":3}},{"line":131,"address":[13056656],"length":1,"stats":{"Line":3}},{"line":132,"address":[13085638],"length":1,"stats":{"Line":3}},{"line":135,"address":[13692062,13692048],"length":1,"stats":{"Line":9}},{"line":136,"address":[13085724],"length":1,"stats":{"Line":9}},{"line":137,"address":[13414640,13414654],"length":1,"stats":{"Line":10}},{"line":138,"address":[14820389],"length":1,"stats":{"Line":15}},{"line":139,"address":[13692110,13692096],"length":1,"stats":{"Line":30}},{"line":140,"address":[13414688,13414702],"length":1,"stats":{"Line":29}},{"line":141,"address":[13085834],"length":1,"stats":{"Line":14}},{"line":144,"address":[13085886],"length":1,"stats":{"Line":9}},{"line":173,"address":[13085360],"length":1,"stats":{"Line":2}},{"line":174,"address":[18694773],"length":1,"stats":{"Line":2}},{"line":175,"address":[13085396],"length":1,"stats":{"Line":2}},{"line":176,"address":[18694811],"length":1,"stats":{"Line":2}},{"line":177,"address":[13085410],"length":1,"stats":{"Line":2}},{"line":178,"address":[13085417],"length":1,"stats":{"Line":2}},{"line":183,"address":[13085296],"length":1,"stats":{"Line":2}},{"line":184,"address":[13056387],"length":1,"stats":{"Line":2}},{"line":188,"address":[13056357,13056351,13056064],"length":1,"stats":{"Line":2}},{"line":189,"address":[13056170,13056084],"length":1,"stats":{"Line":4}},{"line":190,"address":[13056186,13056252],"length":1,"stats":{"Line":4}},{"line":191,"address":[13085191,13085157,13085230],"length":1,"stats":{"Line":6}},{"line":192,"address":[13056313,13056326,13056279],"length":1,"stats":{"Line":6}},{"line":193,"address":[18694655],"length":1,"stats":{"Line":2}},{"line":198,"address":[18694848],"length":1,"stats":{"Line":2}},{"line":199,"address":[13085445],"length":1,"stats":{"Line":2}},{"line":200,"address":[13085476],"length":1,"stats":{"Line":2}},{"line":201,"address":[13056571],"length":1,"stats":{"Line":2}},{"line":202,"address":[13056594],"length":1,"stats":{"Line":2}},{"line":203,"address":[13056617],"length":1,"stats":{"Line":2}}],"covered":36,"coverable":36},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","npm.rs"],"content":"//! # npm Registry Client\n//!\n//! This module implements a client for the [npm](https://www.npmjs.com) registry,\n//! the default package registry for Node.js and JavaScript packages.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://registry.npmjs.org`\n//! - **API Version**: Registry API (stable)\n//! - **Authentication**: Bearer token from `.npmrc` (optional)\n//! - **CORS**: Enabled for browser-based access\n//!\n//! ## Rate Limiting\n//!\n//! npm does **not** enforce hard rate limits on read operations, but implements:\n//!\n//! - **IP-based blocking**: For abusive behavior patterns\n//! - **Cloudflare protection**: May trigger CAPTCHA for suspicious traffic\n//! - **Best practice**: Keep requests under 100/minute for bulk operations\n//!\n//! ## API Endpoints Used\n//!\n//! ### Fetch Package Info\n//!\n//! - **Endpoint**: `GET /{package-name}`\n//! - **Scoped packages**: `GET /@scope%2fpackage-name` (URL encoded `/`)\n//! - **Response**: JSON with full package metadata\n//! - **Fields**:\n//!   - `dist-tags.latest`: Current stable version\n//!   - `dist-tags.next`: Latest prerelease (if exists)\n//!   - `versions{}`: Map of version string to version metadata\n//!   - `time{}`: Map of version string to publish timestamp\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: Semver with optional prerelease (`-alpha`, `-beta`, `-canary`)\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00.000Z`)\n//! - **Deprecated packages**: `deprecated` field in version metadata (string message)\n//! - **License**: Can be string or object with `type` field\n//! - **Repository**: Can be string or object with `url` field\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Scoped packages**: Must URL-encode the slash (`@scope/pkg` → `@scope%2fpkg`)\n//! - **Repository URL formats**: May include `git+https://`, `git://`, or `.git` suffix\n//! - **Large packages**: May have thousands of versions (e.g., lodash)\n//! - **Unpublished packages**: Return 404 but may have been available previously\n//! - **Private packages**: Require authentication; return 401/403 without token\n//! - **Engines field**: Contains Node.js version constraints (not exposed by this client)\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found, 401/403 for auth issues\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [npm Registry API](https://github.com/npm/registry/blob/main/docs/REGISTRY-API.md)\n//! - [Package Metadata Specification](https://github.com/npm/registry/blob/main/docs/responses/package-metadata.md)\n//! - [npm CLI Documentation](https://docs.npmjs.com/cli)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_npm;\nuse super::{Registry, VersionInfo};\n\n/// Client for the npm registry\npub struct NpmRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl NpmRegistry {\n    /// Constructs an NpmRegistry that uses the provided shared HTTP client and the default npm registry base URL.\n    ///\n    /// The supplied `client` is used for all HTTP requests performed by the registry; the base URL is set to\n    /// `https://registry.npmjs.org`.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::npm::NpmRegistry;\n    ///\n    /// let client = Arc::new(reqwest::Client::new());\n    /// let registry = NpmRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://registry.npmjs.org\".to_string(),\n        }\n    }\n}\n\nimpl Default for NpmRegistry {\n    /// Creates a default NpmRegistry configured with a shared HTTP client and the standard npm registry base URL.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::npm::NpmRegistry;\n    ///\n    /// let registry = NpmRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// API response structures\n#[derive(Debug, Deserialize)]\nstruct PackageResponse {\n    description: Option\u003cString\u003e,\n    homepage: Option\u003cString\u003e,\n    repository: Option\u003cRepository\u003e,\n    license: Option\u003cLicenseField\u003e,\n    #[serde(rename = \"dist-tags\")]\n    dist_tags: Option\u003cDistTags\u003e,\n    versions: Option\u003cHashMap\u003cString, VersionMetadata\u003e\u003e,\n    time: Option\u003cHashMap\u003cString, String\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\n#[serde(untagged)]\nenum Repository {\n    String(String),\n    Object { url: Option\u003cString\u003e },\n}\n\nimpl Repository {\n    fn url(\u0026self) -\u003e Option\u003cString\u003e {\n        match self {\n            Repository::String(s) =\u003e Some(normalize_repo_url(s)),\n            Repository::Object { url } =\u003e url.as_ref().map(|u| normalize_repo_url(u)),\n        }\n    }\n}\n\n#[derive(Debug, Deserialize)]\n#[serde(untagged)]\nenum LicenseField {\n    String(String),\n    Object { r#type: Option\u003cString\u003e },\n}\n\nimpl LicenseField {\n    fn as_string(\u0026self) -\u003e Option\u003cString\u003e {\n        match self {\n            LicenseField::String(s) =\u003e Some(s.clone()),\n            LicenseField::Object { r#type } =\u003e r#type.clone(),\n        }\n    }\n}\n\n#[derive(Debug, Deserialize)]\nstruct DistTags {\n    latest: Option\u003cString\u003e,\n    next: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct VersionMetadata {\n    deprecated: Option\u003cString\u003e,\n}\n\nfn normalize_repo_url(url: \u0026str) -\u003e String {\n    // Convert git+https://github.com/user/repo.git to https://github.com/user/repo\n    let url = url\n        .strip_prefix(\"git+\")\n        .unwrap_or(url)\n        .strip_suffix(\".git\")\n        .unwrap_or(url);\n\n    // Convert git://github.com to https://github.com\n    if url.starts_with(\"git://\") {\n        return url.replace(\"git://\", \"https://\");\n    }\n\n    url.to_string()\n}\n\nimpl Registry for NpmRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // Handle scoped packages (@scope/name -\u003e @scope%2fname)\n        let encoded_name = if package_name.starts_with('@') {\n            package_name.replace('/', \"%2f\")\n        } else {\n            package_name.to_string()\n        };\n\n        let url = format!(\"{}/{}\", self.base_url, encoded_name);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch package info for {}: {}\",\n                package_name,\n                response.status()\n            );\n        }\n\n        let pkg: PackageResponse = response.json().await?;\n\n        // Get latest version from dist-tags\n        let latest = pkg.dist_tags.as_ref().and_then(|t| t.latest.clone());\n\n        // Get all versions\n        let versions: Vec\u003cString\u003e = pkg\n            .versions\n            .as_ref()\n            .map(|v| {\n                let mut versions: Vec\u003cString\u003e = v.keys().cloned().collect();\n                // Sort versions in descending order (newest first)\n                versions.sort_by(|a, b| {\n                    match (semver::Version::parse(a), semver::Version::parse(b)) {\n                        (Ok(va), Ok(vb)) =\u003e vb.cmp(\u0026va),\n                        _ =\u003e b.cmp(a),\n                    }\n                });\n                versions\n            })\n            .unwrap_or_default();\n\n        // Find latest prerelease\n        let latest_prerelease = pkg\n            .dist_tags\n            .as_ref()\n            .and_then(|t| t.next.clone())\n            .or_else(|| versions.iter().find(|v| is_prerelease_npm(v)).cloned());\n\n        // Check if latest version is deprecated\n        let deprecated = pkg\n            .versions\n            .as_ref()\n            .and_then(|v| latest.as_ref().and_then(|l| v.get(l)))\n            .is_some_and(|m| m.deprecated.is_some());\n\n        // Get repository URL\n        let repository = pkg.repository.as_ref().and_then(|r| r.url());\n\n        // Parse release dates from the time field (excluding \"created\" and \"modified\" keys)\n        let release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = pkg\n            .time\n            .as_ref()\n            .map(|time_map| {\n                time_map\n                    .iter()\n                    .filter(|(k, _)| *k != \"created\" \u0026\u0026 *k != \"modified\")\n                    .filter_map(|(version, date_str)| {\n                        DateTime::parse_from_rfc3339(date_str)\n                            .ok()\n                            .map(|dt| (version.clone(), dt.with_timezone(\u0026Utc)))\n                    })\n                    .collect()\n            })\n            .unwrap_or_default();\n\n        Ok(VersionInfo {\n            latest,\n            latest_prerelease,\n            versions,\n            description: pkg.description,\n            homepage: pkg.homepage,\n            repository,\n            license: pkg.license.and_then(|l| l.as_string()),\n            vulnerabilities: vec![], // TODO: Integrate npm audit\n            deprecated,\n            yanked: false,\n            yanked_versions: vec![], // Not applicable to npm\n            release_dates,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_npm(\"1.0.0-alpha\"));\n        assert!(is_prerelease_npm(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_npm(\"1.0.0-rc.1\"));\n        assert!(is_prerelease_npm(\"18.3.0-canary\"));\n        assert!(!is_prerelease_npm(\"1.0.0\"));\n        assert!(!is_prerelease_npm(\"2.3.4\"));\n    }\n\n    #[test]\n    fn test_normalize_repo_url() {\n        assert_eq!(\n            normalize_repo_url(\"git+https://github.com/user/repo.git\"),\n            \"https://github.com/user/repo\"\n        );\n        assert_eq!(\n            normalize_repo_url(\"git://github.com/user/repo\"),\n            \"https://github.com/user/repo\"\n        );\n        assert_eq!(\n            normalize_repo_url(\"https://github.com/user/repo\"),\n            \"https://github.com/user/repo\"\n        );\n    }\n\n    #[test]\n    fn test_repository_string_variant() {\n        let repo = Repository::String(\"git+https://github.com/user/repo.git\".to_string());\n        assert_eq!(repo.url(), Some(\"https://github.com/user/repo\".to_string()));\n    }\n\n    #[test]\n    fn test_repository_object_variant() {\n        let repo = Repository::Object {\n            url: Some(\"git://github.com/user/repo\".to_string()),\n        };\n        assert_eq!(repo.url(), Some(\"https://github.com/user/repo\".to_string()));\n    }\n\n    #[test]\n    fn test_repository_object_none() {\n        let repo = Repository::Object { url: None };\n        assert_eq!(repo.url(), None);\n    }\n\n    #[test]\n    fn test_license_field_string() {\n        let license = LicenseField::String(\"MIT\".to_string());\n        assert_eq!(license.as_string(), Some(\"MIT\".to_string()));\n    }\n\n    #[test]\n    fn test_license_field_object() {\n        let license = LicenseField::Object {\n            r#type: Some(\"Apache-2.0\".to_string()),\n        };\n        assert_eq!(license.as_string(), Some(\"Apache-2.0\".to_string()));\n    }\n\n    #[test]\n    fn test_license_field_object_none() {\n        let license = LicenseField::Object { r#type: None };\n        assert_eq!(license.as_string(), None);\n    }\n\n    #[test]\n    fn test_scoped_package_url_encoding() {\n        let package_name = \"@types/node\";\n        let encoded = if package_name.starts_with('@') {\n            package_name.replace('/', \"%2f\")\n        } else {\n            package_name.to_string()\n        };\n        assert_eq!(encoded, \"@types%2fnode\");\n    }\n\n    #[test]\n    fn test_normal_package_no_encoding() {\n        let package_name = \"lodash\";\n        let encoded = if package_name.starts_with('@') {\n            package_name.replace('/', \"%2f\")\n        } else {\n            package_name.to_string()\n        };\n        assert_eq!(encoded, \"lodash\");\n    }\n}\n","traces":[{"line":95,"address":[13844992,13845120,13845126],"length":1,"stats":{"Line":2}},{"line":98,"address":[14230279],"length":1,"stats":{"Line":2}},{"line":113,"address":[14214128],"length":1,"stats":{"Line":2}},{"line":114,"address":[17181886],"length":1,"stats":{"Line":2}},{"line":139,"address":[13844800],"length":1,"stats":{"Line":2}},{"line":140,"address":[17178055],"length":1,"stats":{"Line":2}},{"line":141,"address":[17178102],"length":1,"stats":{"Line":2}},{"line":142,"address":[13844836],"length":1,"stats":{"Line":6}},{"line":155,"address":[13845184],"length":1,"stats":{"Line":2}},{"line":156,"address":[14212199],"length":1,"stats":{"Line":2}},{"line":157,"address":[13845246],"length":1,"stats":{"Line":2}},{"line":158,"address":[14212217],"length":1,"stats":{"Line":2}},{"line":174,"address":[14212304],"length":1,"stats":{"Line":2}},{"line":178,"address":[14212388],"length":1,"stats":{"Line":2}},{"line":180,"address":[14212434],"length":1,"stats":{"Line":2}},{"line":183,"address":[13845474],"length":1,"stats":{"Line":2}},{"line":184,"address":[14212526],"length":1,"stats":{"Line":2}},{"line":187,"address":[14212503],"length":1,"stats":{"Line":3}},{"line":191,"address":[14232496],"length":1,"stats":{"Line":2}},{"line":192,"address":[14232501],"length":1,"stats":{"Line":2}},{"line":195,"address":[13461374,13463381,13462272,13461312,13461545,13461617,13461588],"length":1,"stats":{"Line":0}},{"line":197,"address":[15987115,15987263],"length":1,"stats":{"Line":0}},{"line":198,"address":[13432884,13432779],"length":1,"stats":{"Line":0}},{"line":200,"address":[13432749,13432819],"length":1,"stats":{"Line":0}},{"line":203,"address":[13432942,13432837],"length":1,"stats":{"Line":0}},{"line":205,"address":[15237423],"length":1,"stats":{"Line":0}},{"line":207,"address":[15988367,15988299],"length":1,"stats":{"Line":0}},{"line":208,"address":[13462935,13462836],"length":1,"stats":{"Line":0}},{"line":215,"address":[13434330,13433932,13434467,13432668],"length":1,"stats":{"Line":0}},{"line":218,"address":[15992176,15989419,15992160,15989337],"length":1,"stats":{"Line":0}},{"line":221,"address":[15989434],"length":1,"stats":{"Line":0}},{"line":224,"address":[13463980,13466256,13466486,13466480],"length":1,"stats":{"Line":0}},{"line":225,"address":[14359174],"length":1,"stats":{"Line":0}},{"line":227,"address":[15993103,15993238,15992432,15992077,15992008],"length":1,"stats":{"Line":0}},{"line":228,"address":[14359856,14359606],"length":1,"stats":{"Line":0}},{"line":229,"address":[14359884],"length":1,"stats":{"Line":0}},{"line":230,"address":[13467542,13467933],"length":1,"stats":{"Line":0}},{"line":233,"address":[13466446],"length":1,"stats":{"Line":0}},{"line":238,"address":[15989551],"length":1,"stats":{"Line":0}},{"line":241,"address":[14356705,14359424,14359408],"length":1,"stats":{"Line":0}},{"line":242,"address":[13464131,13468240,13466848,13466880,13468254],"length":1,"stats":{"Line":0}},{"line":245,"address":[14356857,14356751],"length":1,"stats":{"Line":0}},{"line":248,"address":[15991744,15993520,15989753,15991762,15993534],"length":1,"stats":{"Line":0}},{"line":249,"address":[15989770,15991673,15991664],"length":1,"stats":{"Line":0}},{"line":252,"address":[14356931,14358992,14356874,14358976],"length":1,"stats":{"Line":0}},{"line":255,"address":[14356946],"length":1,"stats":{"Line":0}},{"line":258,"address":[13464459,13466656],"length":1,"stats":{"Line":0}},{"line":260,"address":[14358760],"length":1,"stats":{"Line":0}},{"line":261,"address":[14359488,14358770,14359456],"length":1,"stats":{"Line":0}},{"line":262,"address":[13467165,13467120,13466707],"length":1,"stats":{"Line":0}},{"line":263,"address":[13438247],"length":1,"stats":{"Line":0}},{"line":264,"address":[13438266],"length":1,"stats":{"Line":0}},{"line":265,"address":[13468311,13467220,13468288],"length":1,"stats":{"Line":0}},{"line":267,"address":[15992356],"length":1,"stats":{"Line":0}},{"line":271,"address":[13436100],"length":1,"stats":{"Line":0}},{"line":272,"address":[15989975],"length":1,"stats":{"Line":0}},{"line":273,"address":[15990015],"length":1,"stats":{"Line":0}},{"line":274,"address":[14357127],"length":1,"stats":{"Line":0}},{"line":275,"address":[13464625],"length":1,"stats":{"Line":0}},{"line":276,"address":[15990135],"length":1,"stats":{"Line":0}},{"line":277,"address":[13435777],"length":1,"stats":{"Line":0}},{"line":278,"address":[15991840,15990215,15991824],"length":1,"stats":{"Line":0}},{"line":279,"address":[13464856],"length":1,"stats":{"Line":0}},{"line":282,"address":[13435988],"length":1,"stats":{"Line":0}},{"line":283,"address":[13436052],"length":1,"stats":{"Line":0}}],"covered":20,"coverable":65},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","nuget.rs"],"content":"//! # NuGet Registry Client\n//!\n//! This module implements a client for [NuGet Gallery](https://www.nuget.org),\n//! the package manager for .NET packages.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://api.nuget.org/v3`\n//! - **API Version**: v3 (NuGet Server API)\n//! - **Authentication**: API key for publishing (not needed for reading)\n//! - **CORS**: Limited support\n//!\n//! ## Rate Limiting\n//!\n//! NuGet does not publish hard rate limits but implements:\n//!\n//! - **Fair use policy**: No hard limits for normal usage\n//! - **CDN caching**: Most responses served from Azure CDN\n//! - **Best practice**: Use conditional requests\n//!\n//! ## API Endpoints Used\n//!\n//! ### Package Registration (Metadata)\n//!\n//! - **Endpoint**: `GET /registration5-semver1/{package-id-lower}/index.json`\n//! - **Response**: JSON with registration pages containing version metadata\n//! - **Fields**:\n//!   - `items[]`: Array of registration pages\n//!   - `items[].items[]`: Array of version entries (may require fetching page)\n//!   - `catalogEntry.version`: Version string\n//!   - `catalogEntry.description`: Package description\n//!   - `catalogEntry.projectUrl`: Project homepage\n//!   - `catalogEntry.licenseExpression`: SPDX license\n//!   - `catalogEntry.listed`: Whether version is listed (unlisted = hidden)\n//!   - `catalogEntry.deprecation`: Deprecation info if deprecated\n//!   - `catalogEntry.published`: RFC 3339 publish timestamp\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: Semver with optional prerelease (`1.0.0`, `2.0.0-preview.1`)\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00+00:00`)\n//! - **Unlisted packages**: `listed: false` (hidden from search but downloadable)\n//! - **Deprecated packages**: `deprecation` object present\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Package ID case**: IDs are case-insensitive but URLs use lowercase\n//! - **Paged responses**: Large packages may have items in separate pages\n//! - **Version ranges**: Uses NuGet version range syntax `[1.0.0,2.0.0)`\n//! - **Framework targeting**: Packages may target multiple .NET versions\n//! - **Dependency groups**: Dependencies organized by target framework\n//! - **Unlisted vs deprecated**: Unlisted hides from search; deprecated shows warning\n//! - **License**: Either `licenseExpression` (SPDX) or `licenseUrl` (legacy)\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [NuGet Server API](https://learn.microsoft.com/en-us/nuget/api/overview)\n//! - [Package Metadata Resource](https://learn.microsoft.com/en-us/nuget/api/registration-base-url-resource)\n//! - [NuGet Versioning](https://learn.microsoft.com/en-us/nuget/concepts/package-versioning)\n//! - [Version Ranges](https://learn.microsoft.com/en-us/nuget/concepts/package-versioning#version-ranges)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_nuget;\nuse super::{Registry, VersionInfo};\n\n/// Client for the NuGet registry\npub struct NuGetRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl NuGetRegistry {\n    /// Constructs a NuGetRegistry configured to use the NuGet v3 API with the provided shared HTTP client.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::nuget::NuGetRegistry;\n    ///\n    /// let client = Arc::new(reqwest::Client::new());\n    /// let _registry = NuGetRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://api.nuget.org/v3\".to_string(),\n        }\n    }\n}\n\nimpl Default for NuGetRegistry {\n    /// Creates a `NuGetRegistry` configured with a shared HTTP client targeting the NuGet v3 API.\n    ///\n    /// Panics if creating the shared HTTP client fails.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::nuget::NuGetRegistry;\n    ///\n    /// let _reg = NuGetRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// NuGet API response structures\n#[derive(Debug, Deserialize)]\nstruct NuGetRegistrationResponse {\n    items: Vec\u003cNuGetRegistrationPage\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct NuGetRegistrationPage {\n    items: Option\u003cVec\u003cNuGetRegistrationLeaf\u003e\u003e,\n    #[serde(rename = \"@id\")]\n    id: String,\n}\n\n#[derive(Debug, Deserialize, Clone)]\nstruct NuGetRegistrationLeaf {\n    #[serde(rename = \"catalogEntry\")]\n    catalog_entry: NuGetCatalogEntry,\n}\n\n#[derive(Debug, Deserialize, Clone)]\nstruct NuGetCatalogEntry {\n    version: String,\n    description: Option\u003cString\u003e,\n    #[serde(rename = \"projectUrl\")]\n    project_url: Option\u003cString\u003e,\n    #[serde(rename = \"licenseExpression\")]\n    license_expression: Option\u003cString\u003e,\n    #[serde(rename = \"licenseUrl\")]\n    license_url: Option\u003cString\u003e,\n    #[serde(default)]\n    listed: Option\u003cbool\u003e,\n    #[serde(default)]\n    deprecation: Option\u003cNuGetDeprecation\u003e,\n    published: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize, Clone)]\nstruct NuGetDeprecation {\n    #[serde(rename = \"message\")]\n    _message: Option\u003cString\u003e,\n    #[serde(rename = \"reasons\")]\n    _reasons: Option\u003cVec\u003cString\u003e\u003e,\n}\n\nimpl Registry for NuGetRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // NuGet uses lowercase package IDs in URLs\n        let package_id = package_name.to_lowercase();\n\n        // Get registration index\n        let url = format!(\n            \"{}/registration5-semver1/{}/index.json\",\n            self.base_url, package_id\n        );\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch package info for {}: {}\",\n                package_name,\n                response.status()\n            );\n        }\n\n        let registration: NuGetRegistrationResponse = response.json().await?;\n\n        // Collect all versions from all pages\n        let mut all_versions: Vec\u003cNuGetCatalogEntry\u003e = Vec::new();\n\n        for page in \u0026registration.items {\n            if let Some(items) = \u0026page.items {\n                for leaf in items {\n                    all_versions.push(leaf.catalog_entry.clone());\n                }\n            } else {\n                // Need to fetch the page content\n                let page_response = self.client.get(\u0026page.id).send().await?;\n                if page_response.status().is_success() {\n                    let page_data: NuGetRegistrationPage = page_response.json().await?;\n                    if let Some(items) = page_data.items {\n                        for leaf in items {\n                            all_versions.push(leaf.catalog_entry.clone());\n                        }\n                    }\n                }\n            }\n        }\n\n        // Sort versions descending\n        all_versions.sort_by(|a, b| {\n            match (\n                semver::Version::parse(\u0026a.version),\n                semver::Version::parse(\u0026b.version),\n            ) {\n                (Ok(va), Ok(vb)) =\u003e vb.cmp(\u0026va),\n                _ =\u003e b.version.cmp(\u0026a.version),\n            }\n        });\n\n        // Filter listed versions\n        let versions: Vec\u003cString\u003e = all_versions\n            .iter()\n            .filter(|entry| entry.listed.unwrap_or(true))\n            .map(|entry| entry.version.clone())\n            .collect();\n\n        // Find latest stable version\n        let latest_stable = versions.iter().find(|v| !is_prerelease_nuget(v)).cloned();\n\n        // Find latest prerelease\n        let latest_prerelease = versions.iter().find(|v| is_prerelease_nuget(v)).cloned();\n\n        // Get metadata from latest version\n        let latest_entry = all_versions.first();\n\n        // Check deprecation\n        let deprecated = latest_entry.and_then(|e| e.deprecation.as_ref()).is_some();\n\n        // Collect release dates\n        let release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = all_versions\n            .iter()\n            .filter_map(|e| {\n                e.published.as_ref().and_then(|time_str| {\n                    DateTime::parse_from_rfc3339(time_str)\n                        .ok()\n                        .map(|dt| (e.version.clone(), dt.with_timezone(\u0026Utc)))\n                })\n            })\n            .collect();\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease,\n            versions,\n            description: latest_entry.and_then(|e| e.description.clone()),\n            homepage: latest_entry.and_then(|e| e.project_url.clone()),\n            repository: None, // NuGet doesn't expose repository URL directly\n            license: latest_entry\n                .and_then(|e| e.license_expression.clone().or(e.license_url.clone())),\n            vulnerabilities: vec![], // Will be filled by OSV\n            deprecated,\n            yanked: false,\n            yanked_versions: vec![], // Not applicable to NuGet\n            release_dates,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_nuget(\"1.0.0-alpha\"));\n        assert!(is_prerelease_nuget(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_nuget(\"1.0.0-preview\"));\n        assert!(is_prerelease_nuget(\"1.0.0-rc.1\"));\n        assert!(is_prerelease_nuget(\"1.0.0-Alpha\"));\n        assert!(!is_prerelease_nuget(\"1.0.0\"));\n        assert!(!is_prerelease_nuget(\"2.0.0\"));\n    }\n}\n","traces":[{"line":97,"address":[13503280,13503412,13503418],"length":1,"stats":{"Line":2}},{"line":100,"address":[13532231],"length":1,"stats":{"Line":2}},{"line":117,"address":[13534432],"length":1,"stats":{"Line":0}},{"line":118,"address":[15080654],"length":1,"stats":{"Line":0}},{"line":167,"address":[15082672],"length":1,"stats":{"Line":2}},{"line":168,"address":[13506005],"length":1,"stats":{"Line":2}},{"line":171,"address":[14015714,14017395,14015643,14015454,14015392,14015685,14016289,14015664,14015600],"length":1,"stats":{"Line":0}},{"line":173,"address":[13997287],"length":1,"stats":{"Line":0}},{"line":176,"address":[14015764,14015871],"length":1,"stats":{"Line":0}},{"line":181,"address":[12749252],"length":1,"stats":{"Line":0}},{"line":183,"address":[14016823,14016752],"length":1,"stats":{"Line":0}},{"line":184,"address":[19677186,19677296],"length":1,"stats":{"Line":0}},{"line":191,"address":[12749275],"length":1,"stats":{"Line":0}},{"line":194,"address":[14723689],"length":1,"stats":{"Line":0}},{"line":196,"address":[19678272,19678158,19678256,19679497],"length":1,"stats":{"Line":0}},{"line":197,"address":[14021803,14019220,14019364],"length":1,"stats":{"Line":0}},{"line":198,"address":[14003589,14003523],"length":1,"stats":{"Line":0}},{"line":199,"address":[19682065],"length":1,"stats":{"Line":0}},{"line":203,"address":[12799349],"length":1,"stats":{"Line":0}},{"line":204,"address":[19682645,19682710],"length":1,"stats":{"Line":0}},{"line":205,"address":[19678370,19682758,19676029,19678650,19678340],"length":1,"stats":{"Line":0}},{"line":206,"address":[14000279],"length":1,"stats":{"Line":0}},{"line":207,"address":[14018759,14018894,14018644],"length":1,"stats":{"Line":0}},{"line":208,"address":[19679201,19679304],"length":1,"stats":{"Line":0}},{"line":216,"address":[14024259,14024394,14023584,14019429],"length":1,"stats":{"Line":0}},{"line":217,"address":[14729322,14729190,14729440],"length":1,"stats":{"Line":0}},{"line":218,"address":[14023654],"length":1,"stats":{"Line":0}},{"line":219,"address":[14729303,14729236],"length":1,"stats":{"Line":0}},{"line":221,"address":[19683676],"length":1,"stats":{"Line":0}},{"line":222,"address":[19683634,19684025],"length":1,"stats":{"Line":0}},{"line":227,"address":[14001210],"length":1,"stats":{"Line":0}},{"line":229,"address":[14019626,14023536,14023550],"length":1,"stats":{"Line":0}},{"line":230,"address":[14001381,14004803,14004768],"length":1,"stats":{"Line":0}},{"line":234,"address":[14019739,14019839,14023168,14023182],"length":1,"stats":{"Line":0}},{"line":237,"address":[14725720,14728720,14728734,14725820],"length":1,"stats":{"Line":0}},{"line":240,"address":[14726028,14725941],"length":1,"stats":{"Line":0}},{"line":243,"address":[14728825,14726059,14728816],"length":1,"stats":{"Line":0}},{"line":246,"address":[14020400],"length":1,"stats":{"Line":0}},{"line":248,"address":[14020493,14023456],"length":1,"stats":{"Line":0}},{"line":249,"address":[14730212,14730256],"length":1,"stats":{"Line":0}},{"line":250,"address":[19684698],"length":1,"stats":{"Line":0}},{"line":251,"address":[14730317],"length":1,"stats":{"Line":0}},{"line":252,"address":[19684742,19684768,19684791],"length":1,"stats":{"Line":0}},{"line":257,"address":[14002790],"length":1,"stats":{"Line":0}},{"line":258,"address":[19680683],"length":1,"stats":{"Line":0}},{"line":259,"address":[14020603],"length":1,"stats":{"Line":0}},{"line":260,"address":[14726363],"length":1,"stats":{"Line":0}},{"line":261,"address":[14726411,14728768,14728784],"length":1,"stats":{"Line":0}},{"line":262,"address":[14002466,14004848,14004832],"length":1,"stats":{"Line":0}},{"line":263,"address":[14020832],"length":1,"stats":{"Line":0}},{"line":265,"address":[19683056,19680960,19683080,19683136],"length":1,"stats":{"Line":0}},{"line":266,"address":[14020903],"length":1,"stats":{"Line":0}},{"line":269,"address":[14002675],"length":1,"stats":{"Line":0}},{"line":270,"address":[14002742],"length":1,"stats":{"Line":0}}],"covered":4,"coverable":54},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","packagist.rs"],"content":"//! # Packagist Registry Client\n//!\n//! This module implements a client for [Packagist](https://packagist.org),\n//! the main Composer repository for PHP packages.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://repo.packagist.org`\n//! - **API Version**: p2 (Package API v2)\n//! - **Authentication**: Optional API token for private packages\n//! - **CORS**: Enabled for browser-based access\n//!\n//! ## Rate Limiting\n//!\n//! Packagist enforces rate limits to protect the service:\n//!\n//! - **Standard limit**: ~60 requests per minute per IP\n//! - **CDN caching**: Most package data served from CDN\n//! - **Best practice**: Use `If-Modified-Since` headers\n//!\n//! ## API Endpoints Used\n//!\n//! ### Fetch Package Info (p2 API)\n//!\n//! - **Endpoint**: `GET /p2/{vendor}/{package}.json`\n//! - **Response**: JSON with package metadata and all versions\n//! - **Fields**:\n//!   - `packages.{name}[]`: Array of version entries\n//!   - `version`: Version string\n//!   - `description`: Package description\n//!   - `homepage`: Homepage URL\n//!   - `license[]`: Array of license identifiers\n//!   - `source.url`: Repository URL\n//!   - `abandoned`: Deprecation status (bool or replacement package name)\n//!   - `time`: RFC 3339 release timestamp\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: Semver with optional `v` prefix and stability flags\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00+00:00`)\n//! - **Dev versions**: `dev-master`, `dev-main`, `1.0.x-dev` (filtered out)\n//! - **Abandoned packages**: `abandoned` field is truthy (bool or string)\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Package naming**: Must be `vendor/package` format (e.g., `laravel/framework`)\n//! - **Dev branches**: Prefixed with `dev-` or suffixed with `-dev` (excluded)\n//! - **Stability flags**: `@stable`, `@RC`, `@beta`, `@alpha`, `@dev`\n//! - **Version aliases**: May have `branch-alias` in `extra` field\n//! - **Abandoned packages**: Can specify replacement package name as string\n//! - **Multiple licenses**: Array of SPDX identifiers\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found\n//! - **Invalid names**: Error returned if not `vendor/package` format\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [Packagist API](https://packagist.org/apidoc)\n//! - [Composer Version Constraints](https://getcomposer.org/doc/articles/versions.md)\n//! - [Composer Repositories](https://getcomposer.org/doc/05-repositories.md)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_php;\nuse super::{Registry, VersionInfo};\n\n/// Client for the Packagist registry\npub struct PackagistRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl PackagistRegistry {\n    /// Creates a PackagistRegistry configured with the given shared HTTP client and the default Packagist API base URL.\n    ///\n    /// The registry's base URL is set to `https://repo.packagist.org`.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::packagist::PackagistRegistry;\n    ///\n    /// let client = Arc::new(reqwest::Client::new());\n    /// let registry = PackagistRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://repo.packagist.org\".to_string(),\n        }\n    }\n}\n\nimpl Default for PackagistRegistry {\n    /// Create a PackagistRegistry configured with a shared HTTP client and the default Packagist API base URL.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::packagist::PackagistRegistry;\n    ///\n    /// let _registry = PackagistRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// Packagist API response structures\n#[derive(Debug, Deserialize)]\nstruct PackagistResponse {\n    packages: HashMap\u003cString, Vec\u003cVersionEntry\u003e\u003e,\n}\n\n#[derive(Debug, Clone, Deserialize)]\nstruct VersionEntry {\n    version: String,\n    description: Option\u003cString\u003e,\n    homepage: Option\u003cString\u003e,\n    license: Option\u003cVec\u003cString\u003e\u003e,\n    source: Option\u003cSourceInfo\u003e,\n    /// Can be bool or string (replacement package name). We only care if it's truthy.\n    abandoned: Option\u003cserde_json::Value\u003e,\n    /// Release time\n    time: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Deserialize)]\nstruct SourceInfo {\n    url: Option\u003cString\u003e,\n}\n\nimpl Registry for PackagistRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // Package name format: vendor/package\n        if !package_name.contains('/') {\n            anyhow::bail!(\n                \"Invalid package name: {} (expected vendor/package)\",\n                package_name\n            );\n        }\n\n        let url = format!(\"{}/p2/{}.json\", self.base_url, package_name);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch package info for {}: {}\",\n                package_name,\n                response.status()\n            );\n        }\n\n        let packagist_response: PackagistResponse = response.json().await?;\n\n        // Get versions for this package\n        let entries = packagist_response\n            .packages\n            .get(package_name)\n            .cloned()\n            .unwrap_or_default();\n\n        // Filter out dev versions and sort\n        let mut versions: Vec\u003cString\u003e = entries\n            .iter()\n            .filter(|e| !is_dev_version(\u0026e.version))\n            .map(|e| e.version.clone())\n            .collect();\n\n        // Sort versions in descending order\n        versions.sort_by(|a, b| compare_packagist_versions(b, a));\n\n        // Find latest stable version\n        let latest_stable = versions.iter().find(|v| !is_prerelease_php(v)).cloned();\n\n        // Find latest prerelease\n        let latest_prerelease = versions.iter().find(|v| is_prerelease_php(v)).cloned();\n\n        // Get metadata from first (latest) entry\n        let latest_entry = entries.first();\n\n        let description = latest_entry.and_then(|e| e.description.clone());\n        let homepage = latest_entry.and_then(|e| e.homepage.clone());\n        let license = latest_entry\n            .and_then(|e| e.license.as_ref())\n            .and_then(|l| l.first())\n            .cloned();\n        let repository = latest_entry\n            .and_then(|e| e.source.as_ref())\n            .and_then(|s| s.url.clone())\n            .map(|url| normalize_repo_url(\u0026url));\n\n        // Check if deprecated/abandoned (truthy value = abandoned)\n        let deprecated = latest_entry\n            .and_then(|e| e.abandoned.as_ref())\n            .is_some_and(|v| !matches!(v, serde_json::Value::Bool(false)));\n\n        // Collect release dates\n        let release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = entries\n            .iter()\n            .filter_map(|e| {\n                e.time.as_ref().and_then(|time_str| {\n                    DateTime::parse_from_rfc3339(time_str)\n                        .ok()\n                        .map(|dt| (e.version.clone(), dt.with_timezone(\u0026Utc)))\n                })\n            })\n            .collect();\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease,\n            versions,\n            description,\n            homepage,\n            repository,\n            license,\n            vulnerabilities: vec![], // TODO: Check PHP Security Advisories\n            deprecated,\n            yanked: false,\n            yanked_versions: vec![], // Not applicable to Packagist\n            release_dates,\n        })\n    }\n}\n\n/// Check if a version is a dev version (e.g., dev-master, dev-main)\nfn is_dev_version(version: \u0026str) -\u003e bool {\n    version.starts_with(\"dev-\") || version.ends_with(\"-dev\")\n}\n\n/// Compare Packagist versions for sorting\nfn compare_packagist_versions(a: \u0026str, b: \u0026str) -\u003e std::cmp::Ordering {\n    // Strip 'v' prefix if present\n    let a_stripped = a.strip_prefix('v').unwrap_or(a);\n    let b_stripped = b.strip_prefix('v').unwrap_or(b);\n\n    // Try parsing as semver\n    match (\n        semver::Version::parse(a_stripped),\n        semver::Version::parse(b_stripped),\n    ) {\n        (Ok(va), Ok(vb)) =\u003e va.cmp(\u0026vb),\n        _ =\u003e {\n            // Fallback to string comparison\n            compare_version_strings(a_stripped, b_stripped)\n        }\n    }\n}\n\n/// Simple version string comparison\nfn compare_version_strings(a: \u0026str, b: \u0026str) -\u003e std::cmp::Ordering {\n    let parse_parts = |s: \u0026str| -\u003e Vec\u003cu64\u003e {\n        s.split(|c: char| !c.is_ascii_digit())\n            .filter_map(|p| p.parse().ok())\n            .collect()\n    };\n\n    let parts_a = parse_parts(a);\n    let parts_b = parse_parts(b);\n\n    for (pa, pb) in parts_a.iter().zip(parts_b.iter()) {\n        match pa.cmp(pb) {\n            std::cmp::Ordering::Equal =\u003e continue,\n            other =\u003e return other,\n        }\n    }\n\n    parts_a.len().cmp(\u0026parts_b.len())\n}\n\n/// Normalize repository URL\nfn normalize_repo_url(url: \u0026str) -\u003e String {\n    let url = url\n        .strip_prefix(\"git+\")\n        .unwrap_or(url)\n        .strip_suffix(\".git\")\n        .unwrap_or(url);\n\n    if url.starts_with(\"git://\") {\n        url.replace(\"git://\", \"https://\")\n    } else {\n        url.to_string()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_is_dev_version() {\n        assert!(is_dev_version(\"dev-master\"));\n        assert!(is_dev_version(\"dev-main\"));\n        assert!(is_dev_version(\"1.0.x-dev\"));\n        assert!(!is_dev_version(\"1.0.0\"));\n        assert!(!is_dev_version(\"v2.3.4\"));\n    }\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_php(\"1.0.0-alpha\"));\n        assert!(is_prerelease_php(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_php(\"1.0.0-RC1\"));\n        assert!(is_prerelease_php(\"dev-master\"));\n        assert!(!is_prerelease_php(\"1.0.0\"));\n        assert!(!is_prerelease_php(\"v2.3.4\"));\n    }\n\n    #[test]\n    fn test_compare_packagist_versions() {\n        use std::cmp::Ordering;\n\n        assert_eq!(compare_packagist_versions(\"1.0.0\", \"2.0.0\"), Ordering::Less);\n        assert_eq!(\n            compare_packagist_versions(\"v2.0.0\", \"v1.0.0\"),\n            Ordering::Greater\n        );\n        assert_eq!(\n            compare_packagist_versions(\"1.0.0\", \"1.0.0\"),\n            Ordering::Equal\n        );\n    }\n\n    #[test]\n    fn test_normalize_repo_url() {\n        assert_eq!(\n            normalize_repo_url(\"git+https://github.com/user/repo.git\"),\n            \"https://github.com/user/repo\"\n        );\n        assert_eq!(\n            normalize_repo_url(\"git://github.com/user/repo\"),\n            \"https://github.com/user/repo\"\n        );\n        assert_eq!(\n            normalize_repo_url(\"https://github.com/user/repo\"),\n            \"https://github.com/user/repo\"\n        );\n    }\n}\n","traces":[{"line":97,"address":[14025642,14025636,14025504],"length":1,"stats":{"Line":2}},{"line":100,"address":[14007239],"length":1,"stats":{"Line":2}},{"line":115,"address":[14011472],"length":1,"stats":{"Line":0}},{"line":116,"address":[14011486],"length":1,"stats":{"Line":0}},{"line":145,"address":[14007040],"length":1,"stats":{"Line":2}},{"line":146,"address":[12572005],"length":1,"stats":{"Line":2}},{"line":149,"address":[12572016,12572034],"length":1,"stats":{"Line":0}},{"line":151,"address":[15546171,15546319],"length":1,"stats":{"Line":0}},{"line":152,"address":[14405165,14405246],"length":1,"stats":{"Line":0}},{"line":158,"address":[14423496,14423757],"length":1,"stats":{"Line":0}},{"line":160,"address":[13366833,13365655,13365841,13365568,13365015],"length":1,"stats":{"Line":0}},{"line":162,"address":[15547466,15547534],"length":1,"stats":{"Line":0}},{"line":163,"address":[15547692,15547585],"length":1,"stats":{"Line":0}},{"line":170,"address":[14424756,14425255,14425115,14423372,14428544],"length":1,"stats":{"Line":0}},{"line":175,"address":[13367281],"length":1,"stats":{"Line":0}},{"line":180,"address":[14407521],"length":1,"stats":{"Line":0}},{"line":182,"address":[14407667,14411086,14411072],"length":1,"stats":{"Line":0}},{"line":183,"address":[14425998,14429008,14429043],"length":1,"stats":{"Line":0}},{"line":187,"address":[13370133,13367724,13367632,13370096],"length":1,"stats":{"Line":0}},{"line":190,"address":[14426171,14426254,14429422,14429408],"length":1,"stats":{"Line":0}},{"line":193,"address":[14410798,14410784,14408187,14408087],"length":1,"stats":{"Line":0}},{"line":196,"address":[13368136,13368204],"length":1,"stats":{"Line":0}},{"line":198,"address":[14408461,14410480,14408405,14410464],"length":1,"stats":{"Line":0}},{"line":199,"address":[13370208,13370192,13368355,13368297],"length":1,"stats":{"Line":0}},{"line":201,"address":[14411049,14411040,14408547],"length":1,"stats":{"Line":0}},{"line":202,"address":[14408614,14410688,14410697],"length":1,"stats":{"Line":0}},{"line":205,"address":[14408667,14410832,14410841],"length":1,"stats":{"Line":0}},{"line":206,"address":[14427025,14428880,14428864],"length":1,"stats":{"Line":0}},{"line":207,"address":[14427044,14428608,14428635],"length":1,"stats":{"Line":0}},{"line":210,"address":[14427165],"length":1,"stats":{"Line":0}},{"line":211,"address":[14408796,14410608,14410617],"length":1,"stats":{"Line":0}},{"line":212,"address":[13370816,13370826,13368646],"length":1,"stats":{"Line":0}},{"line":215,"address":[15549894],"length":1,"stats":{"Line":0}},{"line":217,"address":[14410864,14408956],"length":1,"stats":{"Line":0}},{"line":218,"address":[14429188,14429456],"length":1,"stats":{"Line":0}},{"line":219,"address":[15552170],"length":1,"stats":{"Line":0}},{"line":220,"address":[14429517],"length":1,"stats":{"Line":0}},{"line":221,"address":[15552263,15552240,15552214],"length":1,"stats":{"Line":0}},{"line":226,"address":[13369219],"length":1,"stats":{"Line":0}},{"line":227,"address":[14427292],"length":1,"stats":{"Line":0}},{"line":228,"address":[15550028],"length":1,"stats":{"Line":0}},{"line":229,"address":[13368852],"length":1,"stats":{"Line":0}},{"line":230,"address":[14427412],"length":1,"stats":{"Line":0}},{"line":231,"address":[14409164],"length":1,"stats":{"Line":0}},{"line":232,"address":[15550188],"length":1,"stats":{"Line":0}},{"line":233,"address":[14409244],"length":1,"stats":{"Line":0}},{"line":234,"address":[14409284],"length":1,"stats":{"Line":0}},{"line":237,"address":[14427635],"length":1,"stats":{"Line":0}},{"line":238,"address":[13369171],"length":1,"stats":{"Line":0}},{"line":244,"address":[12572064],"length":1,"stats":{"Line":2}},{"line":245,"address":[14007143],"length":1,"stats":{"Line":2}},{"line":249,"address":[15816624,15817528,15817679],"length":1,"stats":{"Line":2}},{"line":251,"address":[15816683],"length":1,"stats":{"Line":2}},{"line":252,"address":[12573603],"length":1,"stats":{"Line":2}},{"line":255,"address":[15816997,15817134],"length":1,"stats":{"Line":4}},{"line":256,"address":[14008774],"length":1,"stats":{"Line":2}},{"line":257,"address":[12573737],"length":1,"stats":{"Line":2}},{"line":259,"address":[15817165],"length":1,"stats":{"Line":2}},{"line":262,"address":[14008996,14009414],"length":1,"stats":{"Line":0}},{"line":268,"address":[14008470,14008476,14007648],"length":1,"stats":{"Line":0}},{"line":269,"address":[14411792],"length":1,"stats":{"Line":0}},{"line":270,"address":[15552817,15552957,15552944],"length":1,"stats":{"Line":0}},{"line":271,"address":[14430156,14430259,14430240],"length":1,"stats":{"Line":0}},{"line":275,"address":[14026040],"length":1,"stats":{"Line":0}},{"line":276,"address":[15815933],"length":1,"stats":{"Line":0}},{"line":278,"address":[14007840,14007920],"length":1,"stats":{"Line":0}},{"line":279,"address":[14008409,14008231],"length":1,"stats":{"Line":0}},{"line":281,"address":[12573344],"length":1,"stats":{"Line":0}},{"line":285,"address":[14026533],"length":1,"stats":{"Line":0}},{"line":289,"address":[14007376],"length":1,"stats":{"Line":2}},{"line":292,"address":[14025748],"length":1,"stats":{"Line":2}},{"line":294,"address":[15815650],"length":1,"stats":{"Line":2}},{"line":296,"address":[15815682],"length":1,"stats":{"Line":2}},{"line":297,"address":[14007598],"length":1,"stats":{"Line":2}},{"line":299,"address":[14007575],"length":1,"stats":{"Line":2}}],"covered":19,"coverable":75},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","pub_dev.rs"],"content":"//! # pub.dev Registry Client\n//!\n//! This module implements a client for [pub.dev](https://pub.dev),\n//! the official package repository for Dart and Flutter packages.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://pub.dev/api`\n//! - **API Version**: REST API (stable)\n//! - **Authentication**: OAuth2 for private packages (not implemented)\n//! - **CORS**: Enabled for browser-based access\n//!\n//! ## Rate Limiting\n//!\n//! pub.dev enforces rate limits:\n//!\n//! - **Standard limit**: ~100 requests per minute per IP\n//! - **CDN caching**: Responses cached at edge\n//! - **Best practice**: Respect `Cache-Control` headers\n//!\n//! ## API Endpoints Used\n//!\n//! ### Fetch Package Info\n//!\n//! - **Endpoint**: `GET /api/packages/{package-name}`\n//! - **Response**: JSON with package metadata and all versions\n//! - **Fields**:\n//!   - `name`: Package name\n//!   - `latest`: Latest version info with pubspec\n//!   - `versions[]`: Array of all versions\n//!   - `versions[].version`: Version string\n//!   - `versions[].pubspec`: Parsed pubspec.yaml contents\n//!   - `versions[].retracted`: Whether version is retracted\n//!   - `versions[].published`: RFC 3339 publish timestamp\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: Semver (`1.0.0`, `2.0.0-dev.1`)\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00.000Z`)\n//! - **Retracted versions**: `retracted: true` (equivalent to yanked)\n//! - **Discontinued packages**: `discontinued: true` in pubspec\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **SDK constraints**: `environment.sdk` in pubspec specifies Dart version\n//! - **Flutter constraints**: `environment.flutter` for Flutter SDK version\n//! - **Retracted versions**: Similar to yanked; still downloadable with warning\n//! - **Discontinued packages**: Marked in pubspec, may suggest replacement\n//! - **Null safety**: Packages may indicate null-safety migration status\n//! - **Platform support**: Flutter packages may specify platform compatibility\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [pub.dev API](https://pub.dev/help/api)\n//! - [Pubspec Format](https://dart.dev/tools/pub/pubspec)\n//! - [Version Constraints](https://dart.dev/tools/pub/dependencies#version-constraints)\n//! - [Package Scoring](https://pub.dev/help/scoring)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_dart;\nuse super::{Registry, VersionInfo};\n\n/// Client for the pub.dev registry\npub struct PubDevRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl PubDevRegistry {\n    /// Creates a `PubDevRegistry` configured to use the given shared HTTP client.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::pub_dev::PubDevRegistry;\n    ///\n    /// let client = Arc::new(reqwest::Client::new());\n    /// let _registry = PubDevRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://pub.dev/api\".to_string(),\n        }\n    }\n}\n\nimpl Default for PubDevRegistry {\n    /// Constructs a PubDevRegistry using a shared HTTP client created by `create_shared_client`.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::pub_dev::PubDevRegistry;\n    ///\n    /// let registry = PubDevRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// pub.dev API response structures\n#[derive(Debug, Deserialize)]\nstruct PubPackageResponse {\n    #[serde(rename = \"name\")]\n    _name: String,\n    latest: PubVersionInfo,\n    versions: Vec\u003cPubVersionInfo\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct PubVersionInfo {\n    version: String,\n    pubspec: PubPubspec,\n    #[serde(default)]\n    retracted: bool,\n    published: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct PubPubspec {\n    description: Option\u003cString\u003e,\n    homepage: Option\u003cString\u003e,\n    repository: Option\u003cString\u003e,\n    #[serde(default)]\n    discontinued: bool,\n}\n\nimpl Registry for PubDevRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        let url = format!(\"{}/packages/{}\", self.base_url, package_name);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch package info for {}: {}\",\n                package_name,\n                response.status()\n            );\n        }\n\n        let pkg: PubPackageResponse = response.json().await?;\n\n        // Get all versions (not retracted)\n        let versions: Vec\u003cString\u003e = pkg\n            .versions\n            .iter()\n            .filter(|v| !v.retracted)\n            .map(|v| v.version.clone())\n            .collect();\n\n        // Find latest stable version\n        let latest_stable = versions\n            .iter()\n            .find(|v| !is_prerelease_dart(v))\n            .cloned()\n            .or_else(|| Some(pkg.latest.version.clone()));\n\n        // Find latest prerelease\n        let latest_prerelease = versions.iter().find(|v| is_prerelease_dart(v)).cloned();\n\n        // Collect release dates\n        let release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = pkg\n            .versions\n            .iter()\n            .filter_map(|v| {\n                v.published.as_ref().and_then(|time_str| {\n                    DateTime::parse_from_rfc3339(time_str)\n                        .ok()\n                        .map(|dt| (v.version.clone(), dt.with_timezone(\u0026Utc)))\n                })\n            })\n            .collect();\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease,\n            versions,\n            description: pkg.latest.pubspec.description,\n            homepage: pkg.latest.pubspec.homepage,\n            repository: pkg.latest.pubspec.repository,\n            license: None,           // pub.dev doesn't expose license in API\n            vulnerabilities: vec![], // Will be filled by OSV\n            deprecated: pkg.latest.pubspec.discontinued,\n            yanked: pkg.latest.retracted,\n            yanked_versions: vec![], // Not applicable to pub.dev\n            release_dates,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_dart(\"1.0.0-dev.1\"));\n        assert!(is_prerelease_dart(\"1.0.0-alpha\"));\n        assert!(is_prerelease_dart(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_dart(\"1.0.0-rc.1\"));\n        assert!(!is_prerelease_dart(\"1.0.0\"));\n        assert!(!is_prerelease_dart(\"2.0.0\"));\n    }\n}\n","traces":[{"line":94,"address":[12610672,12610544,12610678],"length":1,"stats":{"Line":2}},{"line":97,"address":[18921911],"length":1,"stats":{"Line":2}},{"line":112,"address":[13402688],"length":1,"stats":{"Line":0}},{"line":113,"address":[13402702],"length":1,"stats":{"Line":0}},{"line":145,"address":[13401344],"length":1,"stats":{"Line":2}},{"line":146,"address":[13401349],"length":1,"stats":{"Line":2}},{"line":149,"address":[13430304,13430322],"length":1,"stats":{"Line":0}},{"line":150,"address":[19235357,19235203],"length":1,"stats":{"Line":0}},{"line":152,"address":[13407327,13405968,13406257,13405732,13406059],"length":1,"stats":{"Line":0}},{"line":154,"address":[13406674,13406742],"length":1,"stats":{"Line":0}},{"line":155,"address":[19236412,19236305],"length":1,"stats":{"Line":0}},{"line":162,"address":[12486786],"length":1,"stats":{"Line":0}},{"line":165,"address":[19237290],"length":1,"stats":{"Line":0}},{"line":168,"address":[13407960,13410410,13410400],"length":1,"stats":{"Line":0}},{"line":169,"address":[13381584,13379075,13381619],"length":1,"stats":{"Line":0}},{"line":173,"address":[13408198,13408073],"length":1,"stats":{"Line":0}},{"line":175,"address":[13410318,13410304,13408214],"length":1,"stats":{"Line":0}},{"line":177,"address":[13381667,13379334,13381648],"length":1,"stats":{"Line":0}},{"line":180,"address":[13379465,13381424,13381438,13379377],"length":1,"stats":{"Line":0}},{"line":183,"address":[12582860],"length":1,"stats":{"Line":0}},{"line":186,"address":[13379679,13381504],"length":1,"stats":{"Line":0}},{"line":187,"address":[13410656,13410468],"length":1,"stats":{"Line":0}},{"line":188,"address":[13381770],"length":1,"stats":{"Line":0}},{"line":189,"address":[19240109],"length":1,"stats":{"Line":0}},{"line":190,"address":[13381840,13381863,13381815],"length":1,"stats":{"Line":0}},{"line":195,"address":[19238528],"length":1,"stats":{"Line":0}},{"line":196,"address":[19238077],"length":1,"stats":{"Line":0}},{"line":197,"address":[13379769],"length":1,"stats":{"Line":0}},{"line":198,"address":[13379809],"length":1,"stats":{"Line":0}},{"line":199,"address":[12583125],"length":1,"stats":{"Line":0}},{"line":200,"address":[13408817],"length":1,"stats":{"Line":0}},{"line":201,"address":[13379929],"length":1,"stats":{"Line":0}},{"line":202,"address":[13408907],"length":1,"stats":{"Line":0}},{"line":203,"address":[13379987],"length":1,"stats":{"Line":0}},{"line":204,"address":[19238394],"length":1,"stats":{"Line":0}},{"line":205,"address":[13408989],"length":1,"stats":{"Line":0}},{"line":206,"address":[13380072],"length":1,"stats":{"Line":0}},{"line":207,"address":[13380140],"length":1,"stats":{"Line":0}}],"covered":4,"coverable":38},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","pypi.rs"],"content":"//! # PyPI Registry Client\n//!\n//! This module implements a client for [PyPI](https://pypi.org) (Python Package Index),\n//! the official third-party software repository for Python packages.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://pypi.org/pypi`\n//! - **API Version**: JSON API (stable)\n//! - **Authentication**: Not required for public packages\n//! - **CORS**: Enabled for browser-based access\n//!\n//! ## Rate Limiting\n//!\n//! PyPI enforces rate limits to protect the service:\n//!\n//! - **Standard limit**: ~20 requests per second per IP\n//! - **Blocking**: Aggressive crawlers may be blocked\n//! - **Best practice**: Use `If-Modified-Since` headers for caching\n//! - **CDN**: Responses are served via Fastly CDN\n//!\n//! ## API Endpoints Used\n//!\n//! ### Fetch Package Info\n//!\n//! - **Endpoint**: `GET /pypi/{package-name}/json`\n//! - **Response**: JSON with project metadata and all releases\n//! - **Fields**:\n//!   - `info.version`: Latest version\n//!   - `info.summary`: Package description\n//!   - `info.home_page`: Homepage URL\n//!   - `info.license`: License string\n//!   - `info.project_urls`: Map of URL types to URLs\n//!   - `info.classifiers`: Trove classifiers for categorization\n//!   - `releases{}`: Map of version string to release files\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: PEP 440 compliant (`1.0.0`, `1.0.0a1`, `1.0.0.dev1`)\n//! - **Date format**: ISO 8601 without timezone (`2024-01-15T10:30:00`)\n//! - **Yanked releases**: `yanked: true` in release file info\n//! - **Deprecated projects**: `Development Status :: 7 - Inactive` classifier\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Name normalization**: Case-insensitive; underscores, hyphens, and dots\n//!   are all equivalent per [PEP 503](https://peps.python.org/pep-0503/)\n//!   (`Flask` = `flask` = `FLASK`, `typing_extensions` = `typing-extensions`)\n//! - **Project vs release metadata**: Some fields are project-level, others per-release\n//! - **Classifiers**: Used for deprecation status, Python version support, etc.\n//! - **requires_python**: Version constraint for Python interpreter (not exposed)\n//! - **Yanked releases**: Still downloadable but with warning\n//! - **Version ordering**: Uses PEP 440 ordering, not simple semver\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [PyPI JSON API](https://docs.pypi.org/api/json/)\n//! - [PEP 503 - Simple Repository API](https://peps.python.org/pep-0503/)\n//! - [PEP 440 - Version Identification](https://peps.python.org/pep-0440/)\n//! - [Trove Classifiers](https://pypi.org/classifiers/)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, NaiveDateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::version_utils::is_prerelease_python;\nuse super::{Registry, VersionInfo};\n\n/// Client for the PyPI registry\npub struct PyPiRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl PyPiRegistry {\n    /// Constructs a PyPiRegistry using the provided shared HTTP client.\n    ///\n    /// The returned registry is configured with the default PyPI API base URL (`https://pypi.org/pypi`).\n    ///\n    /// # Parameters\n    ///\n    /// - `client` — shared HTTP client used for performing requests to the PyPI API.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::pypi::PyPiRegistry;\n    /// use dependi_lsp::registries::http_client::create_shared_client;\n    ///\n    /// let client = create_shared_client().expect(\"failed to create client\");\n    /// let registry = PyPiRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://pypi.org/pypi\".to_string(),\n        }\n    }\n}\n\nimpl Default for PyPiRegistry {\n    /// Creates a PyPiRegistry configured with a shared HTTP client and the default PyPI base URL.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::pypi::PyPiRegistry;\n    ///\n    /// let _registry = PyPiRegistry::default();\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n// PyPI API response structures\n#[derive(Debug, Deserialize)]\nstruct PyPiResponse {\n    info: PackageInfo,\n    releases: HashMap\u003cString, Vec\u003cReleaseFile\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct PackageInfo {\n    /// Latest version\n    version: String,\n    /// Package description\n    summary: Option\u003cString\u003e,\n    /// Homepage URL\n    home_page: Option\u003cString\u003e,\n    /// License string\n    license: Option\u003cString\u003e,\n    /// Project URLs (may contain Repository, Homepage, etc.)\n    project_urls: Option\u003cHashMap\u003cString, String\u003e\u003e,\n    /// Classifiers (can be used to detect deprecated packages)\n    classifiers: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct ReleaseFile {\n    /// Whether this file has been yanked\n    yanked: Option\u003cbool\u003e,\n    /// Upload time for this file (ISO 8601 format without timezone)\n    upload_time: Option\u003cString\u003e,\n}\n\nimpl Registry for PyPiRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // Normalize package name (PyPI is case-insensitive, uses lowercase)\n        let normalized_name = normalize_package_name(package_name);\n\n        let url = format!(\"{}/{}/json\", self.base_url, normalized_name);\n\n        let response = self.client.get(\u0026url).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch package info for {}: {}\",\n                package_name,\n                response.status()\n            );\n        }\n\n        let pypi_response: PyPiResponse = response.json().await?;\n\n        // Get all versions sorted by semver (newest first)\n        let mut versions: Vec\u003cString\u003e = pypi_response\n            .releases\n            .iter()\n            .filter(|(_, files)| {\n                // Filter out yanked versions\n                !files.iter().any(|f| f.yanked.unwrap_or(false))\n            })\n            .map(|(version, _)| version.clone())\n            .collect();\n\n        // Sort versions in descending order\n        versions.sort_by(|a, b| compare_python_versions(b, a));\n\n        // Find latest stable version (non-prerelease)\n        let latest_stable = versions\n            .iter()\n            .find(|v| !is_prerelease_python(v))\n            .cloned()\n            .or_else(|| Some(pypi_response.info.version.clone()));\n\n        // Find latest prerelease\n        let latest_prerelease = versions.iter().find(|v| is_prerelease_python(v)).cloned();\n\n        // Extract repository URL from project_urls\n        let repository = pypi_response.info.project_urls.as_ref().and_then(|urls| {\n            urls.get(\"Repository\")\n                .or_else(|| urls.get(\"Source\"))\n                .or_else(|| urls.get(\"Source Code\"))\n                .or_else(|| urls.get(\"GitHub\"))\n                .cloned()\n        });\n\n        // Extract homepage\n        let homepage = pypi_response.info.home_page.clone().or_else(|| {\n            pypi_response\n                .info\n                .project_urls\n                .as_ref()\n                .and_then(|urls| urls.get(\"Homepage\").cloned())\n        });\n\n        // Check if deprecated (via classifiers)\n        let deprecated = pypi_response\n            .info\n            .classifiers\n            .as_ref()\n            .is_some_and(|classifiers| {\n                classifiers\n                    .iter()\n                    .any(|c| c.contains(\"Development Status :: 7 - Inactive\"))\n            });\n\n        // Extract release dates from releases (use the first file's upload_time for each version)\n        let release_dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = pypi_response\n            .releases\n            .iter()\n            .filter_map(|(version, files)| {\n                files\n                    .first()\n                    .and_then(|f| f.upload_time.as_ref())\n                    .and_then(|time_str| parse_pypi_datetime(time_str))\n                    .map(|dt| (version.clone(), dt))\n            })\n            .collect();\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease,\n            versions,\n            description: pypi_response.info.summary,\n            homepage,\n            repository,\n            license: pypi_response.info.license,\n            vulnerabilities: vec![], // TODO: Integrate Safety/OSV\n            deprecated,\n            yanked: false,\n            yanked_versions: vec![], // Not applicable to PyPI\n            release_dates,\n        })\n    }\n}\n\n/// Parse PyPI datetime format (ISO 8601 without timezone, assumed UTC)\nfn parse_pypi_datetime(s: \u0026str) -\u003e Option\u003cDateTime\u003cUtc\u003e\u003e {\n    NaiveDateTime::parse_from_str(s, \"%Y-%m-%dT%H:%M:%S\")\n        .or_else(|_| NaiveDateTime::parse_from_str(s, \"%Y-%m-%d %H:%M:%S\"))\n        .ok()\n        .map(|naive| naive.and_utc())\n}\n\n/// Normalize Python package name according to PEP 503\n/// - Lowercase\n/// - Replace underscores and dots with hyphens\nfn normalize_package_name(name: \u0026str) -\u003e String {\n    name.to_lowercase().replace(['_', '.'], \"-\")\n}\n\n/// Compare Python versions for sorting\n/// Returns Ordering for descending sort (newer versions first)\nfn compare_python_versions(a: \u0026str, b: \u0026str) -\u003e std::cmp::Ordering {\n    // Try parsing as semver first\n    match (semver::Version::parse(a), semver::Version::parse(b)) {\n        (Ok(va), Ok(vb)) =\u003e va.cmp(\u0026vb),\n        _ =\u003e {\n            // Fallback to simple string comparison with version-aware logic\n            compare_version_strings(a, b)\n        }\n    }\n}\n\n/// Simple version string comparison\nfn compare_version_strings(a: \u0026str, b: \u0026str) -\u003e std::cmp::Ordering {\n    let parse_parts = |s: \u0026str| -\u003e Vec\u003cu64\u003e {\n        s.split(|c: char| !c.is_ascii_digit())\n            .filter_map(|p| p.parse().ok())\n            .collect()\n    };\n\n    let parts_a = parse_parts(a);\n    let parts_b = parse_parts(b);\n\n    for (pa, pb) in parts_a.iter().zip(parts_b.iter()) {\n        match pa.cmp(pb) {\n            std::cmp::Ordering::Equal =\u003e continue,\n            other =\u003e return other,\n        }\n    }\n\n    parts_a.len().cmp(\u0026parts_b.len())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_normalize_package_name() {\n        assert_eq!(normalize_package_name(\"Flask\"), \"flask\");\n        assert_eq!(normalize_package_name(\"ruamel.yaml\"), \"ruamel-yaml\");\n        assert_eq!(\n            normalize_package_name(\"typing_extensions\"),\n            \"typing-extensions\"\n        );\n        assert_eq!(normalize_package_name(\"Pillow\"), \"pillow\");\n    }\n\n    #[test]\n    fn test_is_prerelease() {\n        assert!(is_prerelease_python(\"1.0.0a1\"));\n        assert!(is_prerelease_python(\"1.0.0b2\"));\n        assert!(is_prerelease_python(\"1.0.0rc1\"));\n        assert!(is_prerelease_python(\"1.0.0.dev1\"));\n        assert!(is_prerelease_python(\"2.0.0alpha\"));\n        assert!(is_prerelease_python(\"2.0.0beta\"));\n        assert!(!is_prerelease_python(\"1.0.0\"));\n        assert!(!is_prerelease_python(\"2.3.4\"));\n    }\n\n    #[test]\n    fn test_compare_python_versions() {\n        use std::cmp::Ordering;\n\n        assert_eq!(compare_python_versions(\"1.0.0\", \"2.0.0\"), Ordering::Less);\n        assert_eq!(compare_python_versions(\"2.0.0\", \"1.0.0\"), Ordering::Greater);\n        assert_eq!(compare_python_versions(\"1.0.0\", \"1.0.0\"), Ordering::Equal);\n        assert_eq!(\n            compare_python_versions(\"1.10.0\", \"1.9.0\"),\n            Ordering::Greater\n        );\n    }\n}\n","traces":[{"line":104,"address":[12939654,12939648,12939520],"length":1,"stats":{"Line":2}},{"line":107,"address":[17405063],"length":1,"stats":{"Line":2}},{"line":122,"address":[13011248],"length":1,"stats":{"Line":0}},{"line":123,"address":[13011262],"length":1,"stats":{"Line":0}},{"line":159,"address":[17410480],"length":1,"stats":{"Line":2}},{"line":160,"address":[13040261],"length":1,"stats":{"Line":2}},{"line":163,"address":[13054485,13054192,13054456,13055029,13054254,13056133,13054413],"length":1,"stats":{"Line":0}},{"line":165,"address":[12997595],"length":1,"stats":{"Line":0}},{"line":167,"address":[12969671,12969568],"length":1,"stats":{"Line":0}},{"line":169,"address":[15240767],"length":1,"stats":{"Line":0}},{"line":171,"address":[12970524,12970592],"length":1,"stats":{"Line":0}},{"line":172,"address":[12970762],"length":1,"stats":{"Line":0}},{"line":179,"address":[12748658],"length":1,"stats":{"Line":0}},{"line":182,"address":[12971648],"length":1,"stats":{"Line":0}},{"line":185,"address":[12971727,12975040,12975054],"length":1,"stats":{"Line":0}},{"line":187,"address":[12975066,12975361,12975344],"length":1,"stats":{"Line":0}},{"line":189,"address":[14517202,14520104,14520064],"length":1,"stats":{"Line":0}},{"line":193,"address":[12974816,12971816,12974853,12971896],"length":1,"stats":{"Line":0}},{"line":196,"address":[13000083,13000185],"length":1,"stats":{"Line":0}},{"line":198,"address":[13000201,13002944,13002958],"length":1,"stats":{"Line":0}},{"line":200,"address":[13059891,13059872,13056981],"length":1,"stats":{"Line":0}},{"line":203,"address":[13059838,13059824,13057084,13056996],"length":1,"stats":{"Line":0}},{"line":206,"address":[13002768,13000483,13000561],"length":1,"stats":{"Line":0}},{"line":207,"address":[14519822],"length":1,"stats":{"Line":0}},{"line":208,"address":[14520757,14519846,14520752],"length":1,"stats":{"Line":0}},{"line":209,"address":[13002836,13003776,13003781],"length":1,"stats":{"Line":0}},{"line":210,"address":[13003568,13003573,13002849],"length":1,"stats":{"Line":0}},{"line":211,"address":[13002863],"length":1,"stats":{"Line":0}},{"line":215,"address":[12972488,12972412,12974528],"length":1,"stats":{"Line":0}},{"line":219,"address":[12974560],"length":1,"stats":{"Line":0}},{"line":220,"address":[14520910,14519949,14520880],"length":1,"stats":{"Line":0}},{"line":224,"address":[13000707,13000796],"length":1,"stats":{"Line":0}},{"line":228,"address":[13059760,13057455],"length":1,"stats":{"Line":0}},{"line":229,"address":[12974473],"length":1,"stats":{"Line":0}},{"line":230,"address":[14520357],"length":1,"stats":{"Line":0}},{"line":231,"address":[14520841,14520373,14520816],"length":1,"stats":{"Line":0}},{"line":235,"address":[13000805],"length":1,"stats":{"Line":0}},{"line":238,"address":[13003296,13000832,13003341],"length":1,"stats":{"Line":0}},{"line":239,"address":[14520183],"length":1,"stats":{"Line":0}},{"line":240,"address":[13059522],"length":1,"stats":{"Line":0}},{"line":241,"address":[13059530,13060121,13060112],"length":1,"stats":{"Line":0}},{"line":242,"address":[13060462,13060432,13059538],"length":1,"stats":{"Line":0}},{"line":243,"address":[12975226,12975271,12975248],"length":1,"stats":{"Line":0}},{"line":247,"address":[13001341],"length":1,"stats":{"Line":0}},{"line":248,"address":[13000886],"length":1,"stats":{"Line":0}},{"line":249,"address":[13000926],"length":1,"stats":{"Line":0}},{"line":250,"address":[13000966],"length":1,"stats":{"Line":0}},{"line":251,"address":[13001006],"length":1,"stats":{"Line":0}},{"line":252,"address":[12972870],"length":1,"stats":{"Line":0}},{"line":253,"address":[13001086],"length":1,"stats":{"Line":0}},{"line":254,"address":[14518316],"length":1,"stats":{"Line":0}},{"line":255,"address":[13001166],"length":1,"stats":{"Line":0}},{"line":258,"address":[12973053],"length":1,"stats":{"Line":0}},{"line":259,"address":[13057947],"length":1,"stats":{"Line":0}},{"line":265,"address":[17405184],"length":1,"stats":{"Line":0}},{"line":266,"address":[17405217],"length":1,"stats":{"Line":0}},{"line":267,"address":[12950720,12950748],"length":1,"stats":{"Line":0}},{"line":269,"address":[12939765],"length":1,"stats":{"Line":0}},{"line":275,"address":[17405506,17405500,17405312],"length":1,"stats":{"Line":2}},{"line":276,"address":[13037192],"length":1,"stats":{"Line":2}},{"line":281,"address":[12940668,12940000,12940803],"length":1,"stats":{"Line":2}},{"line":283,"address":[13008516,13008753],"length":1,"stats":{"Line":4}},{"line":284,"address":[13008781],"length":1,"stats":{"Line":2}},{"line":287,"address":[13037667,13038058],"length":1,"stats":{"Line":0}},{"line":293,"address":[13039196,13038368,13039190],"length":1,"stats":{"Line":0}},{"line":294,"address":[13036512],"length":1,"stats":{"Line":0}},{"line":295,"address":[12979373,12979360,12979297],"length":1,"stats":{"Line":0}},{"line":296,"address":[12979308,12979411,12979392],"length":1,"stats":{"Line":0}},{"line":300,"address":[13038472],"length":1,"stats":{"Line":0}},{"line":301,"address":[13038509],"length":1,"stats":{"Line":0}},{"line":303,"address":[17406768,17406688],"length":1,"stats":{"Line":0}},{"line":304,"address":[17407245,17407067],"length":1,"stats":{"Line":0}},{"line":306,"address":[13010220],"length":1,"stats":{"Line":0}},{"line":310,"address":[13010037],"length":1,"stats":{"Line":0}}],"covered":9,"coverable":74},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","rubygems.rs"],"content":"//! # RubyGems Registry Client\n//!\n//! This module implements a client for [RubyGems.org](https://rubygems.org),\n//! the Ruby community's gem hosting service.\n//!\n//! ## API Details\n//!\n//! - **Base URL**: `https://rubygems.org/api/v1`\n//! - **API Version**: v1 (stable)\n//! - **Authentication**: API key for publishing (not needed for reading)\n//! - **CORS**: Enabled for browser-based access\n//!\n//! ## Rate Limiting\n//!\n//! RubyGems enforces rate limits:\n//!\n//! - **Standard limit**: ~10 requests per second per IP\n//! - **Blocking**: Aggressive crawlers may be blocked\n//! - **Best practice**: Use `If-Modified-Since` headers\n//!\n//! ## API Endpoints Used\n//!\n//! ### Fetch Gem Info\n//!\n//! - **Endpoint**: `GET /api/v1/gems/{gem-name}.json`\n//! - **Response**: JSON with gem metadata (latest version)\n//! - **Fields**:\n//!   - `version`: Latest version string\n//!   - `info`: Gem description\n//!   - `licenses[]`: Array of license identifiers\n//!   - `homepage_uri`: Homepage URL\n//!   - `source_code_uri`: Repository URL\n//!   - `project_uri`: RubyGems project page\n//!   - `version_created_at`: RFC 3339 release timestamp\n//!\n//! ### Fetch All Versions\n//!\n//! - **Endpoint**: `GET /api/v1/versions/{gem-name}.json`\n//! - **Response**: JSON array of version entries\n//! - **Fields**:\n//!   - `number`: Version string\n//!   - `created_at`: RFC 3339 publish timestamp\n//!\n//! ## Response Parsing\n//!\n//! - **Version format**: RubyGems versioning (`1.0.0`, `2.0.0.pre.1`)\n//! - **Date format**: RFC 3339 (`2024-01-15T10:30:00.000Z`)\n//! - **Prerelease**: Versions containing `.pre`, `.alpha`, `.beta`, `.rc`\n//!\n//! ## Edge Cases and Quirks\n//!\n//! - **Version ordering**: RubyGems uses its own ordering (not strictly semver)\n//! - **Yanked gems**: Available via separate endpoint (not implemented)\n//! - **Platform gems**: May have platform suffix (`-java`, `-x86_64-linux`)\n//! - **Prerelease format**: Uses `.pre.1` format (not `-pre.1`)\n//! - **No deprecation flag**: RubyGems API doesn't expose deprecation status\n//!\n//! ## Error Handling\n//!\n//! - **Network errors**: Returned as `anyhow::Error`\n//! - **API errors**: 404 for not found\n//! - **Timeouts**: 10 second default timeout\n//!\n//! ## External References\n//!\n//! - [RubyGems API](https://guides.rubygems.org/rubygems-org-api/)\n//! - [Gem Specification](https://guides.rubygems.org/specification-reference/)\n//! - [Version Format](https://guides.rubygems.org/patterns/#semantic-versioning)\n\nuse std::collections::HashMap;\nuse std::sync::Arc;\n\nuse chrono::{DateTime, Utc};\nuse reqwest::Client;\nuse serde::Deserialize;\n\nuse super::http_client::create_shared_client;\nuse super::{Registry, VersionInfo};\n\n/// Client for the RubyGems.org registry\npub struct RubyGemsRegistry {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl RubyGemsRegistry {\n    /// Creates a RubyGemsRegistry that uses the provided shared HTTP client.\n    ///\n    /// The provided `client` will be used for all HTTP requests to the RubyGems API. The registry's\n    /// base API URL is set to `https://rubygems.org/api/v1`.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use std::sync::Arc;\n    /// use dependi_lsp::registries::rubygems::RubyGemsRegistry;\n    ///\n    /// let client = Arc::new(reqwest::Client::new());\n    /// let _registry = RubyGemsRegistry::with_client(client);\n    /// ```\n    pub fn with_client(client: Arc\u003cClient\u003e) -\u003e Self {\n        Self {\n            client,\n            base_url: \"https://rubygems.org/api/v1\".to_string(),\n        }\n    }\n}\n\nimpl Default for RubyGemsRegistry {\n    /// Creates a `RubyGemsRegistry` configured with the shared HTTP client used by the module.\n    ///\n    /// # Examples\n    ///\n    /// ```ignore\n    /// use dependi_lsp::registries::rubygems::RubyGemsRegistry;\n    ///\n    /// let registry = RubyGemsRegistry::default();\n    /// // `registry` is ready to query the RubyGems API.\n    /// ```\n    fn default() -\u003e Self {\n        Self::with_client(create_shared_client().expect(\"Failed to create HTTP client\"))\n    }\n}\n\n/// RubyGems API response for a gem\n#[derive(Debug, Deserialize)]\nstruct GemResponse {\n    #[serde(rename = \"name\")]\n    _name: String,\n    version: String,\n    info: Option\u003cString\u003e,\n    licenses: Option\u003cVec\u003cString\u003e\u003e,\n    homepage_uri: Option\u003cString\u003e,\n    source_code_uri: Option\u003cString\u003e,\n    project_uri: Option\u003cString\u003e,\n    version_created_at: Option\u003cString\u003e,\n}\n\n/// RubyGems API response for version list\n#[derive(Debug, Deserialize)]\nstruct VersionResponse {\n    number: String,\n    created_at: Option\u003cString\u003e,\n}\n\nimpl Registry for RubyGemsRegistry {\n    fn http_client(\u0026self) -\u003e Arc\u003cClient\u003e {\n        Arc::clone(\u0026self.client)\n    }\n\n    async fn get_version_info(\u0026self, package_name: \u0026str) -\u003e anyhow::Result\u003cVersionInfo\u003e {\n        // Fetch gem info (contains latest version)\n        let gem_url = format!(\"{}/gems/{}.json\", self.base_url, package_name);\n        let gem_response = self.client.get(\u0026gem_url).send().await?;\n\n        if !gem_response.status().is_success() {\n            anyhow::bail!(\n                \"Failed to fetch gem info for {}: {}\",\n                package_name,\n                gem_response.status()\n            );\n        }\n\n        let gem: GemResponse = gem_response.json().await?;\n\n        // Fetch all versions with dates\n        let versions_url = format!(\"{}/versions/{}.json\", self.base_url, package_name);\n        let (versions, release_dates) = match self.client.get(\u0026versions_url).send().await {\n            Ok(response) if response.status().is_success() =\u003e {\n                let version_list: Vec\u003cVersionResponse\u003e = response.json().await.unwrap_or_default();\n                let versions: Vec\u003cString\u003e = version_list.iter().map(|v| v.number.clone()).collect();\n                let dates: HashMap\u003cString, DateTime\u003cUtc\u003e\u003e = version_list\n                    .into_iter()\n                    .filter_map(|v| {\n                        v.created_at.as_ref().and_then(|time_str| {\n                            DateTime::parse_from_rfc3339(time_str)\n                                .ok()\n                                .map(|dt| (v.number.clone(), dt.with_timezone(\u0026Utc)))\n                        })\n                    })\n                    .collect();\n                (versions, dates)\n            }\n            _ =\u003e {\n                // Fallback to just latest version with its date\n                let mut dates = HashMap::new();\n                if let Some(time_str) = \u0026gem.version_created_at\n                    \u0026\u0026 let Ok(dt) = DateTime::parse_from_rfc3339(time_str)\n                {\n                    dates.insert(gem.version.clone(), dt.with_timezone(\u0026Utc));\n                }\n                (vec![gem.version.clone()], dates)\n            }\n        };\n\n        // Use the latest version from gem info\n        let latest_stable = Some(gem.version.clone());\n\n        // Get license (first one if multiple)\n        let license = gem.licenses.and_then(|l| l.into_iter().next());\n\n        // Get repository URL (prefer source_code_uri, fallback to homepage)\n        let repository = gem.source_code_uri.or_else(|| gem.homepage_uri.clone());\n\n        Ok(VersionInfo {\n            latest: latest_stable,\n            latest_prerelease: None,\n            versions,\n            description: gem.info,\n            homepage: gem.homepage_uri.or(gem.project_uri),\n            repository,\n            license,\n            vulnerabilities: vec![], // Will be filled by OSV\n            deprecated: false,       // RubyGems doesn't have a deprecation flag in API\n            yanked: false,\n            yanked_versions: vec![], // Not applicable to RubyGems\n            release_dates,\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    #[test]\n    fn test_rubygems_url_format() {\n        let base_url = \"https://rubygems.org/api/v1\";\n        let name = \"rails\";\n        let url = format!(\"{}/gems/{}.json\", base_url, name);\n        assert_eq!(url, \"https://rubygems.org/api/v1/gems/rails.json\");\n    }\n}\n","traces":[{"line":101,"address":[19089056,19089062,19088928],"length":1,"stats":{"Line":2}},{"line":104,"address":[19088951],"length":1,"stats":{"Line":2}},{"line":120,"address":[14210880],"length":1,"stats":{"Line":0}},{"line":121,"address":[14210894],"length":1,"stats":{"Line":0}},{"line":147,"address":[19088112],"length":1,"stats":{"Line":2}},{"line":148,"address":[14209893],"length":1,"stats":{"Line":2}},{"line":151,"address":[14200936,14200560,14200872,14200957,14200915,14201466,14202674,14200986,14200622],"length":1,"stats":{"Line":0}},{"line":153,"address":[14201036,14200827],"length":1,"stats":{"Line":0}},{"line":154,"address":[18270902,18270802,18271100,18272212,18270518],"length":1,"stats":{"Line":0}},{"line":156,"address":[13803995,13803924],"length":1,"stats":{"Line":0}},{"line":157,"address":[14183783,14183903],"length":1,"stats":{"Line":0}},{"line":164,"address":[14182635,14183813,14184400,14184254],"length":1,"stats":{"Line":0}},{"line":167,"address":[13805215,13805107],"length":1,"stats":{"Line":0}},{"line":168,"address":[12487937],"length":1,"stats":{"Line":0}},{"line":169,"address":[18273789,18273693],"length":1,"stats":{"Line":0}},{"line":170,"address":[14204347,14204401,14200965,14205436],"length":1,"stats":{"Line":0}},{"line":171,"address":[18278208,18275201,18278243,18275269],"length":1,"stats":{"Line":0}},{"line":172,"address":[14205852],"length":1,"stats":{"Line":0}},{"line":174,"address":[18278064,18278181,18275459],"length":1,"stats":{"Line":0}},{"line":175,"address":[14190559,14190494,14190608],"length":1,"stats":{"Line":0}},{"line":176,"address":[13810746],"length":1,"stats":{"Line":0}},{"line":177,"address":[14190669],"length":1,"stats":{"Line":0}},{"line":178,"address":[18278432,18278455,18278406],"length":1,"stats":{"Line":0}},{"line":182,"address":[14187729],"length":1,"stats":{"Line":0}},{"line":186,"address":[14204127],"length":1,"stats":{"Line":0}},{"line":187,"address":[14204923,14204503],"length":1,"stats":{"Line":0}},{"line":188,"address":[14204662,14204566],"length":1,"stats":{"Line":0}},{"line":190,"address":[13806844,13806675,13806750,13806652],"length":1,"stats":{"Line":0}},{"line":192,"address":[18274489,18274117,18274939],"length":1,"stats":{"Line":0}},{"line":197,"address":[14206348,14206214],"length":1,"stats":{"Line":0}},{"line":200,"address":[14190350,14188100,14188215,14190336],"length":1,"stats":{"Line":0}},{"line":203,"address":[18278289,18278272,18275975,18276093],"length":1,"stats":{"Line":0}},{"line":205,"address":[14207168],"length":1,"stats":{"Line":0}},{"line":206,"address":[18276101],"length":1,"stats":{"Line":0}},{"line":207,"address":[14188403],"length":1,"stats":{"Line":0}},{"line":208,"address":[14188411],"length":1,"stats":{"Line":0}},{"line":209,"address":[14188451],"length":1,"stats":{"Line":0}},{"line":210,"address":[13808622],"length":1,"stats":{"Line":0}},{"line":211,"address":[14206917],"length":1,"stats":{"Line":0}},{"line":212,"address":[14188669],"length":1,"stats":{"Line":0}},{"line":213,"address":[14188709],"length":1,"stats":{"Line":0}},{"line":216,"address":[14188772],"length":1,"stats":{"Line":0}},{"line":217,"address":[14188832],"length":1,"stats":{"Line":0}}],"covered":4,"coverable":43},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","registries","version_utils.rs"],"content":"//! Version parsing and comparison utilities for registry clients.\n//!\n//! This module provides common version-related functions used across\n//! different package registries, with support for registry-specific\n//! behavior where needed.\n\n/// Checks if a Rust crate version is a prerelease.\n///\n/// Uses semver-compatible prerelease detection. A version is considered\n/// a prerelease if it contains a hyphen (prerelease separator) or common\n/// prerelease identifiers.\npub fn is_prerelease_rust(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains('-') || v.contains(\"alpha\") || v.contains(\"beta\") || v.contains(\"rc\")\n}\n\n/// Checks if an npm package version is a prerelease.\n///\n/// npm-specific prerelease identifiers include `canary` and `next` tags\n/// in addition to common patterns.\npub fn is_prerelease_npm(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains('-')\n        || v.contains(\"alpha\")\n        || v.contains(\"beta\")\n        || v.contains(\"rc\")\n        || v.contains(\"canary\")\n        || v.contains(\"next\")\n}\n\n/// Checks if a PyPI package version is a prerelease.\n///\n/// Python-specific prerelease identifiers per PEP 440, including\n/// shorthand notation like `a1` for alpha and `b2` for beta.\n/// Note: Post-releases (`.postN`) are stable releases per PEP 440.\npub fn is_prerelease_python(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains(\"dev\")\n        || v.contains(\"alpha\")\n        || v.contains(\"beta\")\n        || v.contains(\"rc\")\n        || (v.contains('a') \u0026\u0026 v.chars().last().is_some_and(|c| c.is_ascii_digit()))\n        || (v.contains('b') \u0026\u0026 v.chars().last().is_some_and(|c| c.is_ascii_digit()))\n        || v.contains(\".dev\")\n}\n\n/// Checks if a Go module version is a prerelease.\n///\n/// Go uses semver-like versions with hyphenated prerelease suffixes.\npub fn is_prerelease_go(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains(\"-rc\") || v.contains(\"-alpha\") || v.contains(\"-beta\") || v.contains(\"-pre\")\n}\n\n/// Checks if a PHP Composer package version is a prerelease.\n///\n/// Composer-specific stability flags including `dev` and common\n/// prerelease identifiers.\npub fn is_prerelease_php(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains(\"alpha\")\n        || v.contains(\"beta\")\n        || v.contains(\"rc\")\n        || v.contains(\"-rc\")\n        || v.contains(\"dev\")\n}\n\n/// Checks if a Dart/Flutter package version is a prerelease.\n///\n/// Dart uses semver with hyphenated prerelease suffixes and common\n/// prerelease identifiers.\npub fn is_prerelease_dart(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains('-')\n        || v.contains(\"dev\")\n        || v.contains(\"alpha\")\n        || v.contains(\"beta\")\n        || v.contains(\"rc\")\n}\n\n/// Checks if a NuGet package version is a prerelease.\n///\n/// NuGet-specific prerelease identifiers include `preview` in addition\n/// to common patterns.\npub fn is_prerelease_nuget(version: \u0026str) -\u003e bool {\n    let v = version.to_lowercase();\n    v.contains('-')\n        || v.contains(\"alpha\")\n        || v.contains(\"beta\")\n        || v.contains(\"preview\")\n        || v.contains(\"rc\")\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_is_prerelease_rust() {\n        assert!(is_prerelease_rust(\"1.0.0-alpha\"));\n        assert!(is_prerelease_rust(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_rust(\"1.0.0-rc1\"));\n        assert!(is_prerelease_rust(\"1.0.0-ALPHA\"));\n        assert!(!is_prerelease_rust(\"1.0.0\"));\n        assert!(!is_prerelease_rust(\"2.3.4\"));\n    }\n\n    #[test]\n    fn test_is_prerelease_npm() {\n        assert!(is_prerelease_npm(\"1.0.0-alpha\"));\n        assert!(is_prerelease_npm(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_npm(\"1.0.0-rc.1\"));\n        assert!(is_prerelease_npm(\"18.3.0-canary\"));\n        assert!(is_prerelease_npm(\"1.0.0-next.0\"));\n        assert!(!is_prerelease_npm(\"1.0.0\"));\n        assert!(!is_prerelease_npm(\"2.3.4\"));\n    }\n\n    #[test]\n    fn test_is_prerelease_python() {\n        assert!(is_prerelease_python(\"1.0.0a1\"));\n        assert!(is_prerelease_python(\"1.0.0b2\"));\n        assert!(is_prerelease_python(\"1.0.0rc1\"));\n        assert!(is_prerelease_python(\"1.0.0.dev1\"));\n        assert!(is_prerelease_python(\"2.0.0alpha\"));\n        assert!(is_prerelease_python(\"2.0.0beta\"));\n        assert!(!is_prerelease_python(\"1.0.0.post1\")); // post-releases are stable per PEP 440\n        assert!(!is_prerelease_python(\"1.0.0\"));\n        assert!(!is_prerelease_python(\"2.3.4\"));\n    }\n\n    #[test]\n    fn test_is_prerelease_go() {\n        assert!(is_prerelease_go(\"v1.0.0-rc1\"));\n        assert!(is_prerelease_go(\"v2.0.0-beta.1\"));\n        assert!(is_prerelease_go(\"v3.0.0-alpha\"));\n        assert!(is_prerelease_go(\"v1.0.0-pre.1\"));\n        assert!(!is_prerelease_go(\"v1.0.0\"));\n        assert!(!is_prerelease_go(\"v2.3.4\"));\n    }\n\n    #[test]\n    fn test_is_prerelease_php() {\n        assert!(is_prerelease_php(\"1.0.0-alpha\"));\n        assert!(is_prerelease_php(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_php(\"1.0.0-RC1\"));\n        assert!(is_prerelease_php(\"dev-master\"));\n        assert!(!is_prerelease_php(\"1.0.0\"));\n        assert!(!is_prerelease_php(\"v2.3.4\"));\n    }\n\n    #[test]\n    fn test_is_prerelease_dart() {\n        assert!(is_prerelease_dart(\"1.0.0-dev.1\"));\n        assert!(is_prerelease_dart(\"1.0.0-alpha\"));\n        assert!(is_prerelease_dart(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_dart(\"1.0.0-rc.1\"));\n        assert!(!is_prerelease_dart(\"1.0.0\"));\n        assert!(!is_prerelease_dart(\"2.0.0\"));\n    }\n\n    #[test]\n    fn test_is_prerelease_nuget() {\n        assert!(is_prerelease_nuget(\"1.0.0-alpha\"));\n        assert!(is_prerelease_nuget(\"1.0.0-beta.1\"));\n        assert!(is_prerelease_nuget(\"1.0.0-preview\"));\n        assert!(is_prerelease_nuget(\"1.0.0-rc.1\"));\n        assert!(is_prerelease_nuget(\"1.0.0-Alpha\"));\n        assert!(!is_prerelease_nuget(\"1.0.0\"));\n        assert!(!is_prerelease_nuget(\"2.0.0\"));\n    }\n}\n","traces":[{"line":12,"address":[14662160,14662559,14662553],"length":1,"stats":{"Line":2}},{"line":13,"address":[14662189],"length":1,"stats":{"Line":2}},{"line":14,"address":[13006153,13006085],"length":1,"stats":{"Line":4}},{"line":21,"address":[12977712,12978312,12978306],"length":1,"stats":{"Line":2}},{"line":22,"address":[12977741],"length":1,"stats":{"Line":2}},{"line":23,"address":[12977774,12977857,12977912],"length":1,"stats":{"Line":6}},{"line":24,"address":[14430615,14430655],"length":1,"stats":{"Line":4}},{"line":25,"address":[12977980],"length":1,"stats":{"Line":2}},{"line":26,"address":[12978056],"length":1,"stats":{"Line":2}},{"line":27,"address":[14660884],"length":1,"stats":{"Line":2}},{"line":28,"address":[14660960],"length":1,"stats":{"Line":2}},{"line":36,"address":[14664035,14663104,14664041],"length":1,"stats":{"Line":2}},{"line":37,"address":[14433101],"length":1,"stats":{"Line":2}},{"line":38,"address":[13007121,13007038,13007195],"length":1,"stats":{"Line":6}},{"line":39,"address":[12980548,12980600],"length":1,"stats":{"Line":4}},{"line":40,"address":[14663403],"length":1,"stats":{"Line":2}},{"line":41,"address":[13007369],"length":1,"stats":{"Line":2}},{"line":42,"address":[12863140,12863136],"length":1,"stats":{"Line":9}},{"line":43,"address":[14663797,14663668,14663860],"length":1,"stats":{"Line":14}},{"line":44,"address":[14663835,14663964],"length":1,"stats":{"Line":7}},{"line":50,"address":[12977686,12977680,12977280],"length":1,"stats":{"Line":2}},{"line":51,"address":[14660061],"length":1,"stats":{"Line":2}},{"line":52,"address":[12977401,12977333],"length":1,"stats":{"Line":4}},{"line":59,"address":[14431056,14431569,14431575],"length":1,"stats":{"Line":2}},{"line":60,"address":[14431085],"length":1,"stats":{"Line":2}},{"line":61,"address":[14661283,14661144,14661221],"length":1,"stats":{"Line":6}},{"line":62,"address":[14661306,14661266],"length":1,"stats":{"Line":4}},{"line":63,"address":[13005223],"length":1,"stats":{"Line":2}},{"line":64,"address":[14661427],"length":1,"stats":{"Line":2}},{"line":65,"address":[13005375],"length":1,"stats":{"Line":2}},{"line":72,"address":[13005504,13006016,13006010],"length":1,"stats":{"Line":2}},{"line":73,"address":[13005533],"length":1,"stats":{"Line":2}},{"line":74,"address":[12978936,12979013,12979068],"length":1,"stats":{"Line":6}},{"line":75,"address":[13005715,13005675],"length":1,"stats":{"Line":4}},{"line":76,"address":[12979136],"length":1,"stats":{"Line":2}},{"line":77,"address":[14661964],"length":1,"stats":{"Line":2}},{"line":78,"address":[13005912],"length":1,"stats":{"Line":2}},{"line":85,"address":[14662576,14663088,14663082],"length":1,"stats":{"Line":2}},{"line":86,"address":[14432573],"length":1,"stats":{"Line":2}},{"line":87,"address":[14662764,14662709,14662632],"length":1,"stats":{"Line":6}},{"line":88,"address":[14662747,14662787],"length":1,"stats":{"Line":4}},{"line":89,"address":[14662832],"length":1,"stats":{"Line":2}},{"line":90,"address":[13006780],"length":1,"stats":{"Line":2}},{"line":91,"address":[13006856],"length":1,"stats":{"Line":2}}],"covered":44,"coverable":44},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","reports.rs"],"content":"//! Vulnerability report generation\n//!\n//! This module handles the generation of vulnerability reports\n//! in various formats (JSON, Markdown).\n\nuse serde::{Deserialize, Serialize};\nuse tower_lsp::lsp_types::Url;\n\n/// Summary of vulnerabilities grouped by severity level.\n///\n/// Used to provide an overview of the vulnerability scan results.\n#[derive(Debug, Clone, Default, Serialize, Deserialize)]\npub struct VulnerabilitySummary {\n    /// Total number of vulnerabilities found.\n    pub total: u32,\n    /// Number of critical severity vulnerabilities.\n    pub critical: u32,\n    /// Number of high severity vulnerabilities.\n    pub high: u32,\n    /// Number of medium severity vulnerabilities.\n    pub medium: u32,\n    /// Number of low severity vulnerabilities.\n    pub low: u32,\n}\n\n/// A single vulnerability entry in a report.\n///\n/// Contains all relevant information about a vulnerability affecting a package.\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct VulnerabilityReportEntry {\n    /// Name of the affected package.\n    pub package: String,\n    /// Version of the affected package.\n    pub version: String,\n    /// Vulnerability identifier (e.g., CVE-2021-1234, GHSA-xxxx).\n    pub id: String,\n    /// Severity level (critical, high, medium, low).\n    pub severity: String,\n    /// Human-readable description of the vulnerability.\n    pub description: String,\n    /// URL for more information about the vulnerability.\n    pub url: Option\u003cString\u003e,\n}\n\n/// Generate a Markdown-formatted vulnerability report.\n///\n/// Creates a human-readable report with a summary table and detailed\n/// vulnerability entries grouped by package.\npub fn generate_markdown_report(\n    uri: \u0026Url,\n    summary: \u0026VulnerabilitySummary,\n    vulnerabilities: \u0026[VulnerabilityReportEntry],\n) -\u003e String {\n    let mut lines = vec![\n        \"# Vulnerability Report\".to_string(),\n        String::new(),\n        format!(\"**File**: {}\", uri.path()),\n        format!(\"**Date**: {}\", chrono::Local::now().format(\"%Y-%m-%d\")),\n        String::new(),\n        \"## Summary\".to_string(),\n        \"| Severity | Count |\".to_string(),\n        \"|----------|-------|\".to_string(),\n        format!(\"| ⚠ Critical | {} |\", summary.critical),\n        format!(\"| ▲ High | {} |\", summary.high),\n        format!(\"| ● Medium | {} |\", summary.medium),\n        format!(\"| ○ Low | {} |\", summary.low),\n        format!(\"| **Total** | **{}** |\", summary.total),\n        String::new(),\n    ];\n\n    if !vulnerabilities.is_empty() {\n        lines.push(\"## Vulnerabilities\".to_string());\n        lines.push(String::new());\n\n        let mut current_package = String::new();\n        let mut current_version = String::new();\n        for vuln in vulnerabilities {\n            if vuln.package != current_package || vuln.version != current_version {\n                current_package = vuln.package.clone();\n                current_version = vuln.version.clone();\n                lines.push(format!(\"### {}@{}\", vuln.package, vuln.version));\n                lines.push(String::new());\n            }\n\n            let severity_icon = match vuln.severity.as_str() {\n                \"critical\" =\u003e \"⚠\",\n                \"high\" =\u003e \"▲\",\n                \"medium\" =\u003e \"●\",\n                _ =\u003e \"○\",\n            };\n\n            if let Some(url) = \u0026vuln.url {\n                lines.push(format!(\n                    \"- **[{}]({})** ({} {}): {}\",\n                    vuln.id,\n                    url,\n                    severity_icon,\n                    vuln.severity.to_uppercase(),\n                    vuln.description\n                ));\n            } else {\n                lines.push(format!(\n                    \"- **{}** ({} {}): {}\",\n                    vuln.id,\n                    severity_icon,\n                    vuln.severity.to_uppercase(),\n                    vuln.description\n                ));\n            }\n        }\n    } else {\n        lines.push(\"## No vulnerabilities found\".to_string());\n        lines.push(String::new());\n        lines.push(\"✅ All dependencies are free of known security vulnerabilities.\".to_string());\n    }\n\n    lines.join(\"\\n\")\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_generate_markdown_report_with_vulnerabilities() {\n        let uri = Url::parse(\"file:///project/Cargo.toml\").unwrap();\n        let summary = VulnerabilitySummary {\n            total: 2,\n            critical: 1,\n            high: 1,\n            medium: 0,\n            low: 0,\n        };\n        let vulnerabilities = vec![\n            VulnerabilityReportEntry {\n                package: \"serde\".to_string(),\n                version: \"1.0.0\".to_string(),\n                id: \"CVE-2021-1234\".to_string(),\n                severity: \"critical\".to_string(),\n                description: \"Critical vulnerability\".to_string(),\n                url: Some(\"https://example.com/cve\".to_string()),\n            },\n            VulnerabilityReportEntry {\n                package: \"tokio\".to_string(),\n                version: \"1.0.0\".to_string(),\n                id: \"CVE-2021-5678\".to_string(),\n                severity: \"high\".to_string(),\n                description: \"High vulnerability\".to_string(),\n                url: None,\n            },\n        ];\n\n        let report = generate_markdown_report(\u0026uri, \u0026summary, \u0026vulnerabilities);\n\n        assert!(report.contains(\"# Vulnerability Report\"));\n        assert!(report.contains(\"**File**: /project/Cargo.toml\"));\n        assert!(report.contains(\"| ⚠ Critical | 1 |\"));\n        assert!(report.contains(\"| ▲ High | 1 |\"));\n        assert!(report.contains(\"### serde@1.0.0\"));\n        assert!(report.contains(\"### tokio@1.0.0\"));\n        assert!(report.contains(\"CVE-2021-1234\"));\n        assert!(report.contains(\"CVE-2021-5678\"));\n    }\n\n    #[test]\n    fn test_generate_markdown_report_same_package_different_versions() {\n        let uri = Url::parse(\"file:///project/Cargo.toml\").unwrap();\n        let summary = VulnerabilitySummary {\n            total: 2,\n            critical: 1,\n            high: 1,\n            medium: 0,\n            low: 0,\n        };\n        let vulnerabilities = vec![\n            VulnerabilityReportEntry {\n                package: \"serde\".to_string(),\n                version: \"1.0.0\".to_string(),\n                id: \"CVE-2021-1111\".to_string(),\n                severity: \"critical\".to_string(),\n                description: \"Old version vulnerability\".to_string(),\n                url: None,\n            },\n            VulnerabilityReportEntry {\n                package: \"serde\".to_string(),\n                version: \"2.0.0\".to_string(),\n                id: \"CVE-2021-2222\".to_string(),\n                severity: \"high\".to_string(),\n                description: \"New version vulnerability\".to_string(),\n                url: None,\n            },\n        ];\n\n        let report = generate_markdown_report(\u0026uri, \u0026summary, \u0026vulnerabilities);\n\n        assert!(report.contains(\"### serde@1.0.0\"));\n        assert!(report.contains(\"### serde@2.0.0\"));\n        assert!(report.contains(\"CVE-2021-1111\"));\n        assert!(report.contains(\"CVE-2021-2222\"));\n    }\n\n    #[test]\n    fn test_generate_markdown_report_no_vulnerabilities() {\n        let uri = Url::parse(\"file:///project/Cargo.toml\").unwrap();\n        let summary = VulnerabilitySummary::default();\n        let vulnerabilities = vec![];\n\n        let report = generate_markdown_report(\u0026uri, \u0026summary, \u0026vulnerabilities);\n\n        assert!(report.contains(\"# Vulnerability Report\"));\n        assert!(report.contains(\"## No vulnerabilities found\"));\n        assert!(report.contains(\"✅ All dependencies are free of known security vulnerabilities.\"));\n    }\n}\n","traces":[{"line":49,"address":[14587705,14588362,14583008],"length":1,"stats":{"Line":2}},{"line":54,"address":[13928940,13928574,13928095,13929278,13927572,13927799,13927393,13929119,13928394,13929322,13927437,13929860,13932706,13927496,13928242,13928314,13928170,13928757],"length":1,"stats":{"Line":9}},{"line":55,"address":[13927406],"length":1,"stats":{"Line":4}},{"line":56,"address":[17170509],"length":1,"stats":{"Line":5}},{"line":57,"address":[17170565,17170649],"length":1,"stats":{"Line":9}},{"line":58,"address":[13946068,13946131],"length":1,"stats":{"Line":9}},{"line":59,"address":[17171089],"length":1,"stats":{"Line":4}},{"line":60,"address":[13946427],"length":1,"stats":{"Line":5}},{"line":61,"address":[13928211],"length":1,"stats":{"Line":4}},{"line":62,"address":[13946571],"length":1,"stats":{"Line":5}},{"line":63,"address":[13928435,13928363],"length":1,"stats":{"Line":9}},{"line":64,"address":[14584232,14584307],"length":1,"stats":{"Line":9}},{"line":65,"address":[17171802,17171727],"length":1,"stats":{"Line":9}},{"line":66,"address":[13947197,13947272],"length":1,"stats":{"Line":9}},{"line":67,"address":[17172164,17172093],"length":1,"stats":{"Line":9}},{"line":68,"address":[13929271],"length":1,"stats":{"Line":4}},{"line":71,"address":[17172921,17172843],"length":1,"stats":{"Line":9}},{"line":72,"address":[13929930,13929995],"length":1,"stats":{"Line":6}},{"line":73,"address":[13930030],"length":1,"stats":{"Line":2}},{"line":75,"address":[13948360],"length":1,"stats":{"Line":2}},{"line":76,"address":[13930087],"length":1,"stats":{"Line":2}},{"line":77,"address":[13930238,13930154],"length":1,"stats":{"Line":4}},{"line":78,"address":[14586203,14586025,14586131],"length":1,"stats":{"Line":6}},{"line":79,"address":[13930587,13930568,13930507],"length":1,"stats":{"Line":4}},{"line":80,"address":[13949032,13948990],"length":1,"stats":{"Line":2}},{"line":81,"address":[13930859],"length":1,"stats":{"Line":2}},{"line":82,"address":[17174070],"length":1,"stats":{"Line":2}},{"line":85,"address":[13931130,13930544],"length":1,"stats":{"Line":4}},{"line":86,"address":[17174135,17174201],"length":1,"stats":{"Line":4}},{"line":87,"address":[17174237,17174178,17174276],"length":1,"stats":{"Line":6}},{"line":88,"address":[13931320,13931355,13931264],"length":1,"stats":{"Line":0}},{"line":89,"address":[13931326],"length":1,"stats":{"Line":0}},{"line":92,"address":[14587063],"length":1,"stats":{"Line":2}},{"line":93,"address":[13949744,13949862],"length":1,"stats":{"Line":4}},{"line":98,"address":[13931468,13931542],"length":1,"stats":{"Line":4}},{"line":102,"address":[13949785,13950371],"length":1,"stats":{"Line":4}},{"line":106,"address":[13931508,13932052],"length":1,"stats":{"Line":4}},{"line":112,"address":[17172958,17175475],"length":1,"stats":{"Line":4}},{"line":113,"address":[13950809],"length":1,"stats":{"Line":2}},{"line":114,"address":[13932555],"length":1,"stats":{"Line":2}},{"line":117,"address":[13930416,13932639],"length":1,"stats":{"Line":4}}],"covered":39,"coverable":41},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","utils.rs"],"content":"//! Common utility functions used across the LSP implementation.\n\n/// Truncates a string to a maximum character count with ellipsis.\n///\n/// This function properly handles UTF-8 strings by counting characters,\n/// not bytes. If the string needs truncation, an ellipsis (\"...\") is\n/// appended and counted toward the maximum length.\n///\n/// # Arguments\n///\n/// * `s` - The string to truncate\n/// * `max_chars` - Maximum number of characters to display (including ellipsis)\n///\n/// # Returns\n///\n/// The truncated string, or the original string if it fits within `max_chars`.\npub fn truncate_string(s: \u0026str, max_chars: usize) -\u003e String {\n    let char_count = s.chars().count();\n    if char_count \u003c= max_chars {\n        return s.to_string();\n    }\n\n    let keep_chars = max_chars.saturating_sub(3);\n    let truncated: String = s.chars().take(keep_chars).collect();\n    format!(\"{}...\", truncated)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_no_truncation_needed() {\n        assert_eq!(truncate_string(\"hello\", 10), \"hello\");\n        assert_eq!(truncate_string(\"\", 10), \"\");\n        assert_eq!(truncate_string(\"hello\", 5), \"hello\");\n    }\n\n    #[test]\n    fn test_ascii_truncation() {\n        assert_eq!(truncate_string(\"hello world\", 8), \"hello...\");\n        assert_eq!(truncate_string(\"abcdefghij\", 7), \"abcd...\");\n    }\n\n    #[test]\n    fn test_edge_cases() {\n        assert_eq!(truncate_string(\"hello\", 3), \"...\");\n        assert_eq!(truncate_string(\"hello\", 4), \"h...\");\n        assert_eq!(truncate_string(\"ab\", 1), \"...\");\n        assert_eq!(truncate_string(\"a\", 0), \"...\");\n    }\n\n    #[test]\n    fn test_utf8_japanese() {\n        // \"日本語\" = 3 characters, 9 bytes\n        assert_eq!(truncate_string(\"日本語\", 10), \"日本語\");\n        assert_eq!(truncate_string(\"日本語\", 3), \"日本語\");\n        // \"日本語test\" = 7 characters\n        // truncate to 6 means keep 3 + \"...\" = 6 total\n        assert_eq!(truncate_string(\"日本語test\", 6), \"日本語...\");\n        // 7 chars \u003c= 8, so no truncation needed\n        assert_eq!(truncate_string(\"日本語test\", 8), \"日本語test\");\n        // 7 chars \u003c= 7, so no truncation needed\n        assert_eq!(truncate_string(\"日本語test\", 7), \"日本語test\");\n        // truncate to 5 means keep 2 + \"...\" = 5\n        assert_eq!(truncate_string(\"日本語test\", 5), \"日本...\");\n    }\n\n    #[test]\n    fn test_utf8_emoji() {\n        // \"hello\" = 5 characters, fits in 8\n        assert_eq!(truncate_string(\"hello\", 8), \"hello\");\n        // \"hello world\" = 11 characters, truncate to 8 means keep 5 + \"...\"\n        let emoji_str = \"hello world\";\n        assert_eq!(truncate_string(emoji_str, 8), \"hello...\");\n    }\n\n    #[test]\n    fn test_mixed_content() {\n        assert_eq!(truncate_string(\"Hello 日本\", 10), \"Hello 日本\");\n        assert_eq!(truncate_string(\"Hello 日本語 world\", 12), \"Hello 日本語...\");\n    }\n}\n","traces":[{"line":17,"address":[14682186,14681776,14682192],"length":1,"stats":{"Line":2}},{"line":18,"address":[13840856],"length":1,"stats":{"Line":2}},{"line":19,"address":[13840885],"length":1,"stats":{"Line":2}},{"line":20,"address":[13859319],"length":1,"stats":{"Line":2}},{"line":23,"address":[13840900],"length":1,"stats":{"Line":5}},{"line":24,"address":[13840928],"length":1,"stats":{"Line":8}},{"line":25,"address":[13841083,13840989],"length":1,"stats":{"Line":13}}],"covered":7,"coverable":7},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","vulnerabilities","cache.rs"],"content":"//! Vulnerability cache for tracking queried packages\n//!\n//! Tracks which packages have been queried for vulnerabilities to avoid\n//! redundant API calls. The actual vulnerability data is stored in the\n//! version cache alongside version information.\n\nuse std::fmt::Display;\nuse std::sync::Arc;\nuse std::time::{Duration, Instant};\n\nuse dashmap::DashMap;\n\nuse super::Ecosystem;\n\n/// Default TTL for vulnerability cache (6 hours)\nconst DEFAULT_VULN_CACHE_TTL: Duration = Duration::from_secs(6 * 3600);\n\n/// Cache key for vulnerability lookups\n#[derive(Debug, Clone, Hash, PartialEq, Eq)]\npub struct VulnCacheKey {\n    /// Target ecosystem\n    pub ecosystem: Ecosystem,\n    /// Package name\n    pub package_name: String,\n    /// Package version\n    pub version: String,\n}\n\nimpl VulnCacheKey {\n    /// Create a new cache key\n    pub fn new(ecosystem: Ecosystem, package_name: \u0026str, version: \u0026str) -\u003e Self {\n        Self {\n            ecosystem,\n            package_name: package_name.to_string(),\n            version: version.to_string(),\n        }\n    }\n}\n\n/// Tracks when a package was queried for vulnerabilities\nstruct VulnCacheEntry {\n    /// When the entry was inserted\n    inserted_at: Instant,\n}\n\n/// Cleanup interval for background task (30 minutes)\nconst CLEANUP_INTERVAL: Duration = Duration::from_secs(30 * 60);\n\n/// Tracks which packages have been queried for vulnerabilities\n///\n/// This is a \"seen set\" with TTL - it prevents redundant API calls to OSV.dev\n/// by tracking which package@version combinations have already been queried.\n/// The actual vulnerability data is stored in the version cache.\n#[derive(Clone)]\npub struct VulnerabilityCache {\n    /// Cache entries (package key -\u003e query timestamp)\n    entries: Arc\u003cDashMap\u003cVulnCacheKey, VulnCacheEntry\u003e\u003e,\n    /// Cache TTL\n    ttl: Duration,\n}\n\nimpl VulnerabilityCache {\n    /// Create a new cache with default TTL (6 hours) and spawn background cleanup\n    pub fn new() -\u003e Self {\n        let cache = Self {\n            entries: Arc::new(DashMap::new()),\n            ttl: DEFAULT_VULN_CACHE_TTL,\n        };\n        Self::spawn_cleanup_task(cache.clone());\n        cache\n    }\n\n    fn spawn_cleanup_task(cache: VulnerabilityCache) {\n        tokio::spawn(async move {\n            let mut interval = tokio::time::interval(CLEANUP_INTERVAL);\n            interval.tick().await; // Skip immediate first tick\n\n            loop {\n                interval.tick().await;\n\n                let stats = cache.stats();\n                let removed = cache.cleanup_expired();\n                if removed \u003e 0 {\n                    tracing::info!(\n                        \"Background cleanup: removed {} expired entries from vulnerability cache (was: {})\",\n                        removed,\n                        stats\n                    );\n                }\n            }\n        });\n    }\n\n    /// Create a cache with custom TTL in seconds (no background cleanup for tests)\n    #[cfg(test)]\n    pub fn with_ttl(ttl_secs: u64) -\u003e Self {\n        Self {\n            entries: Arc::new(DashMap::new()),\n            ttl: Duration::from_secs(ttl_secs),\n        }\n    }\n\n    /// Mark a package as having been queried for vulnerabilities\n    pub fn insert(\u0026self, key: VulnCacheKey) {\n        self.entries.insert(\n            key,\n            VulnCacheEntry {\n                inserted_at: Instant::now(),\n            },\n        );\n    }\n\n    /// Check if a package has been queried (and the query hasn't expired)\n    pub fn contains(\u0026self, key: \u0026VulnCacheKey) -\u003e bool {\n        self.entries\n            .get(key)\n            .is_some_and(|entry| entry.inserted_at.elapsed() \u003c self.ttl)\n    }\n\n    /// Clear all entries from cache\n    #[cfg(test)]\n    pub fn clear(\u0026self) {\n        self.entries.clear();\n    }\n\n    /// Get the number of entries in the cache\n    #[cfg(test)]\n    pub fn len(\u0026self) -\u003e usize {\n        self.entries.len()\n    }\n\n    /// Check if the cache is empty\n    #[cfg(test)]\n    pub fn is_empty(\u0026self) -\u003e bool {\n        self.entries.is_empty()\n    }\n\n    pub fn cleanup_expired(\u0026self) -\u003e usize {\n        let before = self.entries.len();\n        self.entries\n            .retain(|_, entry| entry.inserted_at.elapsed() \u003c self.ttl);\n        let removed = before - self.entries.len();\n        if removed \u003e 0 {\n            tracing::debug!(\n                \"Cleaned up {} expired vulnerability cache entries ({} remaining)\",\n                removed,\n                self.entries.len()\n            );\n        }\n        removed\n    }\n\n    pub fn stats(\u0026self) -\u003e VulnCacheStats {\n        let total = self.entries.len();\n        let expired = self\n            .entries\n            .iter()\n            .filter(|e| e.inserted_at.elapsed() \u003e= self.ttl)\n            .count();\n        VulnCacheStats {\n            total_entries: total,\n            expired_entries: expired,\n            valid_entries: total.saturating_sub(expired),\n        }\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct VulnCacheStats {\n    pub total_entries: usize,\n    pub expired_entries: usize,\n    pub valid_entries: usize,\n}\n\nimpl Display for VulnCacheStats {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        write!(\n            f,\n            \"VulnCacheStats {{ total: {}, expired: {}, valid: {} }}\",\n            self.total_entries, self.expired_entries, self.valid_entries\n        )\n    }\n}\n\nimpl Default for VulnerabilityCache {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_cache_insert_and_contains() {\n        let cache = VulnerabilityCache::with_ttl(3600);\n        let key = VulnCacheKey::new(Ecosystem::Npm, \"lodash\", \"4.17.0\");\n\n        assert!(!cache.contains(\u0026key));\n        cache.insert(key.clone());\n        assert!(cache.contains(\u0026key));\n    }\n\n    #[test]\n    fn test_cache_clear() {\n        let cache = VulnerabilityCache::with_ttl(3600);\n        let key = VulnCacheKey::new(Ecosystem::PyPI, \"requests\", \"2.28.0\");\n\n        cache.insert(key.clone());\n        assert_eq!(cache.len(), 1);\n\n        cache.clear();\n        assert!(cache.is_empty());\n    }\n\n    #[test]\n    fn test_cache_with_custom_ttl() {\n        let cache = VulnerabilityCache::with_ttl(3600);\n        assert_eq!(cache.ttl, Duration::from_secs(3600));\n    }\n\n    #[test]\n    fn test_vuln_cache_cleanup_expired() {\n        // Use 10ms TTL for fast test\n        let cache = VulnerabilityCache::with_ttl(0); // 0 seconds = immediate expiry\n        let key1 = VulnCacheKey::new(Ecosystem::Npm, \"pkg1\", \"1.0.0\");\n        let key2 = VulnCacheKey::new(Ecosystem::Npm, \"pkg2\", \"1.0.0\");\n\n        cache.insert(key1);\n        cache.insert(key2);\n\n        assert_eq!(cache.len(), 2);\n\n        // Wait for expiration\n        std::thread::sleep(Duration::from_millis(10));\n\n        let removed = cache.cleanup_expired();\n        assert_eq!(removed, 2);\n        assert_eq!(cache.len(), 0);\n    }\n\n    #[test]\n    fn test_vuln_cache_stats() {\n        let cache = VulnerabilityCache::with_ttl(0); // Immediate expiry\n        let key1 = VulnCacheKey::new(Ecosystem::Npm, \"pkg1\", \"1.0.0\");\n        let key2 = VulnCacheKey::new(Ecosystem::Npm, \"pkg2\", \"1.0.0\");\n\n        cache.insert(key1);\n        cache.insert(key2);\n\n        // Wait for expiration\n        std::thread::sleep(Duration::from_millis(10));\n\n        let stats = cache.stats();\n        assert_eq!(stats.total_entries, 2);\n        assert_eq!(stats.expired_entries, 2);\n        assert_eq!(stats.valid_entries, 0);\n    }\n\n    #[test]\n    fn test_vuln_cache_stats_display() {\n        let stats = VulnCacheStats {\n            total_entries: 5,\n            expired_entries: 2,\n            valid_entries: 3,\n        };\n        let display = format!(\"{}\", stats);\n        assert!(display.contains(\"total: 5\"));\n        assert!(display.contains(\"expired: 2\"));\n        assert!(display.contains(\"valid: 3\"));\n    }\n}\n","traces":[{"line":31,"address":[14389046,14388800,14389052],"length":1,"stats":{"Line":3}},{"line":34,"address":[14921879],"length":1,"stats":{"Line":2}},{"line":35,"address":[14388926],"length":1,"stats":{"Line":3}},{"line":64,"address":[13080612,13080618,13080432],"length":1,"stats":{"Line":0}},{"line":66,"address":[13109377],"length":1,"stats":{"Line":0}},{"line":69,"address":[14389898,14389941],"length":1,"stats":{"Line":0}},{"line":70,"address":[13080578],"length":1,"stats":{"Line":0}},{"line":73,"address":[14922704],"length":1,"stats":{"Line":0}},{"line":74,"address":[13109284],"length":1,"stats":{"Line":0}},{"line":75,"address":[17223761],"length":1,"stats":{"Line":0}},{"line":76,"address":[15209945],"length":1,"stats":{"Line":0}},{"line":79,"address":[17224269,17224290,17223826,17224236,17225115],"length":1,"stats":{"Line":0}},{"line":81,"address":[13956753],"length":1,"stats":{"Line":0}},{"line":82,"address":[13975069],"length":1,"stats":{"Line":0}},{"line":83,"address":[13975102],"length":1,"stats":{"Line":0}},{"line":84,"address":[13956829],"length":1,"stats":{"Line":0}},{"line":96,"address":[14923740,14923600,14923746],"length":1,"stats":{"Line":2}},{"line":98,"address":[14923633],"length":1,"stats":{"Line":2}},{"line":99,"address":[14923658],"length":1,"stats":{"Line":3}},{"line":104,"address":[13109996,13109760],"length":1,"stats":{"Line":3}},{"line":105,"address":[13109946,13109774],"length":1,"stats":{"Line":6}},{"line":106,"address":[13109842],"length":1,"stats":{"Line":3}},{"line":108,"address":[13080959],"length":1,"stats":{"Line":3}},{"line":114,"address":[14390496],"length":1,"stats":{"Line":2}},{"line":115,"address":[13081127],"length":1,"stats":{"Line":2}},{"line":116,"address":[14390531],"length":1,"stats":{"Line":2}},{"line":117,"address":[13975952,13975920],"length":1,"stats":{"Line":6}},{"line":122,"address":[14923008],"length":1,"stats":{"Line":2}},{"line":123,"address":[14923013],"length":1,"stats":{"Line":2}},{"line":128,"address":[14922784],"length":1,"stats":{"Line":2}},{"line":129,"address":[14922789],"length":1,"stats":{"Line":2}},{"line":134,"address":[14390576],"length":1,"stats":{"Line":2}},{"line":135,"address":[14923573],"length":1,"stats":{"Line":2}},{"line":138,"address":[13108624],"length":1,"stats":{"Line":2}},{"line":139,"address":[14922084],"length":1,"stats":{"Line":2}},{"line":140,"address":[13108677],"length":1,"stats":{"Line":2}},{"line":141,"address":[13079763],"length":1,"stats":{"Line":6}},{"line":142,"address":[14922195,14922138],"length":1,"stats":{"Line":2}},{"line":143,"address":[14389193],"length":1,"stats":{"Line":2}},{"line":144,"address":[13108961],"length":1,"stats":{"Line":2}},{"line":153,"address":[13080640],"length":1,"stats":{"Line":2}},{"line":154,"address":[13080676],"length":1,"stats":{"Line":2}},{"line":155,"address":[13080708],"length":1,"stats":{"Line":2}},{"line":158,"address":[13109660],"length":1,"stats":{"Line":6}},{"line":163,"address":[13080780],"length":1,"stats":{"Line":2}},{"line":176,"address":[13081968],"length":1,"stats":{"Line":2}},{"line":177,"address":[13081999],"length":1,"stats":{"Line":2}},{"line":186,"address":[13082384],"length":1,"stats":{"Line":0}},{"line":187,"address":[13082392],"length":1,"stats":{"Line":0}}],"covered":34,"coverable":49},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","vulnerabilities","mod.rs"],"content":"//! Vulnerability scanning for dependencies\n//!\n//! This module provides vulnerability detection using OSV.dev API\n//! as the primary source for all ecosystems.\n\npub mod cache;\npub mod osv;\n\n/// Ecosystem identifiers for vulnerability sources\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\npub enum Ecosystem {\n    /// Rust crates (crates.io)\n    CratesIo,\n    /// JavaScript/Node packages (npm)\n    Npm,\n    /// Python packages (PyPI)\n    PyPI,\n    /// Go modules\n    Go,\n    /// PHP packages (Packagist)\n    Packagist,\n    /// Dart/Flutter packages (pub.dev)\n    Pub,\n    /// .NET packages (NuGet)\n    NuGet,\n    /// Ruby gems (RubyGems.org)\n    RubyGems,\n}\n\nimpl Ecosystem {\n    /// Convert to OSV.dev ecosystem string\n    pub fn as_osv_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Ecosystem::CratesIo =\u003e \"crates.io\",\n            Ecosystem::Npm =\u003e \"npm\",\n            Ecosystem::PyPI =\u003e \"PyPI\",\n            Ecosystem::Go =\u003e \"Go\",\n            Ecosystem::Packagist =\u003e \"Packagist\",\n            Ecosystem::Pub =\u003e \"Pub\",\n            Ecosystem::NuGet =\u003e \"NuGet\",\n            Ecosystem::RubyGems =\u003e \"RubyGems\",\n        }\n    }\n}\n\n/// Query for vulnerability lookup\n#[derive(Debug, Clone)]\npub struct VulnerabilityQuery {\n    /// Package name\n    pub package_name: String,\n    /// Package version (normalized, without ^ or ~ prefixes)\n    pub version: String,\n    /// Target ecosystem\n    pub ecosystem: Ecosystem,\n}\n","traces":[{"line":32,"address":[13034880],"length":1,"stats":{"Line":2}},{"line":33,"address":[12976725],"length":1,"stats":{"Line":2}},{"line":34,"address":[14609156],"length":1,"stats":{"Line":2}},{"line":35,"address":[13034942],"length":1,"stats":{"Line":2}},{"line":36,"address":[13034968],"length":1,"stats":{"Line":2}},{"line":37,"address":[12976831],"length":1,"stats":{"Line":2}},{"line":38,"address":[12976854],"length":1,"stats":{"Line":2}},{"line":39,"address":[12976877],"length":1,"stats":{"Line":2}},{"line":40,"address":[12976900],"length":1,"stats":{"Line":2}},{"line":41,"address":[12976923],"length":1,"stats":{"Line":0}}],"covered":9,"coverable":10},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","src","vulnerabilities","osv.rs"],"content":"//! OSV.dev API client for vulnerability data\n//!\n//! OSV (Open Source Vulnerabilities) provides a unified API for querying\n//! vulnerability data across multiple ecosystems.\n\nuse std::sync::Arc;\nuse std::time::Duration;\n\nuse reqwest::Client;\nuse serde::{Deserialize, Serialize};\n\nuse super::VulnerabilityQuery;\nuse crate::registries::{Vulnerability, VulnerabilitySeverity};\n\nconst OSV_API_BASE: \u0026str = \"https://api.osv.dev/v1\";\n\n/// Result of a vulnerability query\n#[derive(Debug, Clone, Default)]\npub struct QueryResult {\n    pub vulnerabilities: Vec\u003cVulnerability\u003e,\n    pub deprecated: bool,\n}\n\n/// OSV.dev API client\npub struct OsvClient {\n    client: Arc\u003cClient\u003e,\n    base_url: String,\n}\n\nimpl OsvClient {\n    pub fn new() -\u003e anyhow::Result\u003cSelf\u003e {\n        let client = Client::builder()\n            .user_agent(\"dependi-lsp (https://github.com/mathieu/zed-dependi)\")\n            .timeout(Duration::from_secs(30))\n            .build()?;\n\n        Ok(Self {\n            client: Arc::new(client),\n            base_url: OSV_API_BASE.to_string(),\n        })\n    }\n\n    fn convert_vulnerability(osv: \u0026OsvVulnerability) -\u003e Vulnerability {\n        let id = osv\n            .aliases\n            .as_ref()\n            .and_then(|a| a.iter().find(|id| id.starts_with(\"CVE-\")))\n            .cloned()\n            .unwrap_or_else(|| osv.id.clone());\n\n        let severity = osv\n            .severity\n            .as_ref()\n            .and_then(|s| s.first())\n            .map(|s| parse_cvss_severity(\u0026s.score))\n            .unwrap_or(VulnerabilitySeverity::Medium);\n\n        let description = osv\n            .summary\n            .clone()\n            .or_else(|| osv.details.clone())\n            .unwrap_or_else(|| format!(\"Vulnerability {}\", osv.id));\n\n        let url = osv.references.as_ref().and_then(|refs| {\n            refs.iter()\n                .find(|r| r._ref_type == \"ADVISORY\" || r._ref_type == \"WEB\")\n                .map(|r| r.url.clone())\n        });\n\n        Vulnerability {\n            id,\n            severity,\n            description,\n            url,\n        }\n    }\n}\n\nimpl Default for OsvClient {\n    fn default() -\u003e Self {\n        Self::new().expect(\"Failed to create OsvClient\")\n    }\n}\n\nfn parse_cvss_severity(score: \u0026str) -\u003e VulnerabilitySeverity {\n    if let Ok(score) = score.parse::\u003cf64\u003e() {\n        return match score {\n            s if s \u003e= 9.0 =\u003e VulnerabilitySeverity::Critical,\n            s if s \u003e= 7.0 =\u003e VulnerabilitySeverity::High,\n            s if s \u003e= 4.0 =\u003e VulnerabilitySeverity::Medium,\n            _ =\u003e VulnerabilitySeverity::Low,\n        };\n    }\n\n    if score.starts_with(\"CVSS:\") {\n        return VulnerabilitySeverity::Medium;\n    }\n\n    VulnerabilitySeverity::Medium\n}\n\nimpl OsvClient {\n    pub async fn query_batch(\n        \u0026self,\n        queries: \u0026[VulnerabilityQuery],\n    ) -\u003e anyhow::Result\u003cVec\u003cQueryResult\u003e\u003e {\n        if queries.is_empty() {\n            return Ok(vec![]);\n        }\n\n        let request = OsvBatchRequest {\n            queries: queries\n                .iter()\n                .map(|q| OsvQueryRequest {\n                    package: OsvPackage {\n                        name: q.package_name.clone(),\n                        ecosystem: q.ecosystem.as_osv_str().to_string(),\n                    },\n                    version: Some(q.version.clone()),\n                })\n                .collect(),\n        };\n\n        let url = format!(\"{}/querybatch\", self.base_url);\n        let response = self.client.post(\u0026url).json(\u0026request).send().await?;\n\n        if !response.status().is_success() {\n            anyhow::bail!(\"OSV API batch error: {}\", response.status());\n        }\n\n        let batch_response: OsvBatchResponse = response.json().await?;\n\n        let mut results = Vec::new();\n\n        for r in \u0026batch_response.results {\n            let vulnerabilities = r\n                .vulns\n                .as_ref()\n                .unwrap_or(\u0026vec![])\n                .iter()\n                .map(Self::convert_vulnerability)\n                .collect();\n\n            let rustsec_ids: Vec\u003cString\u003e = r\n                .vulns\n                .as_ref()\n                .unwrap_or(\u0026vec![])\n                .iter()\n                .filter(|v| v.id.starts_with(\"RUSTSEC-\"))\n                .map(|v| v.id.clone())\n                .collect();\n\n            let has_unmaintained = self.check_rustsec_unmaintained(\u0026rustsec_ids).await;\n\n            results.push(QueryResult {\n                vulnerabilities,\n                deprecated: has_unmaintained,\n            });\n        }\n\n        Ok(results)\n    }\n\n    async fn check_rustsec_unmaintained(\u0026self, ids: \u0026[String]) -\u003e bool {\n        if ids.is_empty() {\n            return false;\n        }\n\n        tracing::debug!(\n            \"Checking {} RUSTSEC advisories for unmaintained status\",\n            ids.len()\n        );\n\n        // Spawn all tasks in parallel\n        let tasks: Vec\u003c_\u003e = ids\n            .iter()\n            .map(|id| {\n                let url = format!(\"{}/vulns/{}\", self.base_url, id);\n                let client = Arc::clone(\u0026self.client);\n                let id_clone = id.clone();\n\n                tokio::spawn(async move {\n                    let response = match client.get(\u0026url).send().await {\n                        Ok(r) =\u003e r,\n                        Err(e) =\u003e {\n                            tracing::warn!(\"Failed to fetch advisory {}: {}\", id_clone, e);\n                            return false;\n                        }\n                    };\n\n                    let details: Option\u003cOsvVulnerabilityDetails\u003e = match response.json().await {\n                        Ok(d) =\u003e d,\n                        Err(e) =\u003e {\n                            tracing::warn!(\"Failed to parse advisory {}: {}\", id_clone, e);\n                            return false;\n                        }\n                    };\n\n                    let is_unmaintained = details.as_ref().is_some_and(|v| {\n                        // Check summary for \"maintained\" or \"deprecated\" keywords\n                        let summary_match = v.summary.as_ref().is_some_and(|s| {\n                            let lower = s.to_lowercase();\n                            lower.contains(\"maintained\") || lower.contains(\"deprecated\")\n                        });\n\n                        // Check database_specific.informational for \"unmaintained\"\n                        let informational_match = v.affected.as_ref().is_some_and(|affected| {\n                            affected.iter().any(|a| {\n                                a.database_specific.as_ref().is_some_and(|db| {\n                                    db.informational\n                                        .as_ref()\n                                        .is_some_and(|i| i == \"unmaintained\")\n                                })\n                            })\n                        });\n\n                        summary_match || informational_match\n                    });\n\n                    if is_unmaintained {\n                        tracing::info!(\n                            \"Advisory {} indicates unmaintained package: {}\",\n                            id_clone,\n                            details\n                                .as_ref()\n                                .and_then(|v| v.summary.as_ref())\n                                .unwrap_or(\u0026String::new())\n                        );\n                    }\n\n                    is_unmaintained\n                })\n            })\n            .collect();\n\n        // Wait for ALL tasks to complete in parallel using join_all\n        let results = futures::future::join_all(tasks).await;\n\n        // Check if any task returned true (found unmaintained package)\n        results.into_iter().any(|r| r.unwrap_or(false))\n    }\n}\n\n#[derive(Debug, Serialize)]\nstruct OsvQueryRequest {\n    package: OsvPackage,\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    version: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Serialize)]\nstruct OsvPackage {\n    name: String,\n    ecosystem: String,\n}\n\n#[derive(Debug, Serialize)]\nstruct OsvBatchRequest {\n    queries: Vec\u003cOsvQueryRequest\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvQueryResponse {\n    vulns: Option\u003cVec\u003cOsvVulnerability\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvBatchResponse {\n    results: Vec\u003cOsvQueryResponse\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvVulnerability {\n    id: String,\n    summary: Option\u003cString\u003e,\n    details: Option\u003cString\u003e,\n    severity: Option\u003cVec\u003cOsvSeverity\u003e\u003e,\n    references: Option\u003cVec\u003cOsvReference\u003e\u003e,\n    aliases: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvSeverity {\n    #[serde(rename = \"type\")]\n    _type: String,\n    score: String,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvReference {\n    #[serde(rename = \"type\")]\n    _ref_type: String,\n    url: String,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvVulnerabilityDetails {\n    summary: Option\u003cString\u003e,\n    affected: Option\u003cVec\u003cOsvAffected\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvAffected {\n    database_specific: Option\u003cOsvDatabaseSpecific\u003e,\n}\n\n#[derive(Debug, Deserialize)]\nstruct OsvDatabaseSpecific {\n    informational: Option\u003cString\u003e,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::vulnerabilities::Ecosystem;\n\n    #[test]\n    fn test_parse_cvss_severity() {\n        assert_eq!(parse_cvss_severity(\"9.8\"), VulnerabilitySeverity::Critical);\n        assert_eq!(parse_cvss_severity(\"9.0\"), VulnerabilitySeverity::Critical);\n        assert_eq!(parse_cvss_severity(\"7.5\"), VulnerabilitySeverity::High);\n        assert_eq!(parse_cvss_severity(\"5.0\"), VulnerabilitySeverity::Medium);\n        assert_eq!(parse_cvss_severity(\"3.0\"), VulnerabilitySeverity::Low);\n        assert_eq!(parse_cvss_severity(\"0.0\"), VulnerabilitySeverity::Low);\n        assert_eq!(\n            parse_cvss_severity(\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H\"),\n            VulnerabilitySeverity::Medium\n        );\n    }\n\n    #[test]\n    fn test_ecosystem_osv_str() {\n        assert_eq!(Ecosystem::CratesIo.as_osv_str(), \"crates.io\");\n        assert_eq!(Ecosystem::Npm.as_osv_str(), \"npm\");\n        assert_eq!(Ecosystem::PyPI.as_osv_str(), \"PyPI\");\n        assert_eq!(Ecosystem::Go.as_osv_str(), \"Go\");\n        assert_eq!(Ecosystem::Packagist.as_osv_str(), \"Packagist\");\n        assert_eq!(Ecosystem::Pub.as_osv_str(), \"Pub\");\n        assert_eq!(Ecosystem::NuGet.as_osv_str(), \"NuGet\");\n    }\n\n    #[test]\n    fn test_convert_vulnerability() {\n        let osv = OsvVulnerability {\n            id: \"GHSA-xxxx-xxxx-xxxx\".to_string(),\n            summary: Some(\"Test vulnerability\".to_string()),\n            details: None,\n            severity: Some(vec![OsvSeverity {\n                _type: \"CVSS_V3\".to_string(),\n                score: \"7.5\".to_string(),\n            }]),\n            references: Some(vec![OsvReference {\n                _ref_type: \"ADVISORY\".to_string(),\n                url: \"https://example.com/advisory\".to_string(),\n            }]),\n            aliases: Some(vec![\"CVE-2021-12345\".to_string()]),\n        };\n\n        let vuln = OsvClient::convert_vulnerability(\u0026osv);\n\n        assert_eq!(vuln.id, \"CVE-2021-12345\");\n        assert_eq!(vuln.severity, VulnerabilitySeverity::High);\n        assert_eq!(vuln.description, \"Test vulnerability\");\n        assert_eq!(vuln.url, Some(\"https://example.com/advisory\".to_string()));\n    }\n\n    #[test]\n    fn test_unmaintained_detection() {\n        let rustsec_vuln = OsvVulnerability {\n            id: \"RUSTSEC-2025-0057\".to_string(),\n            summary: Some(\"fxhash - no longer maintained\".to_string()),\n            details: None,\n            severity: None,\n            references: None,\n            aliases: None,\n        };\n\n        let is_unmaintained = rustsec_vuln.id.starts_with(\"RUSTSEC\")\n            \u0026\u0026 rustsec_vuln.summary.as_ref().is_some_and(|s| {\n                s.to_lowercase().contains(\"maintained\") || s.to_lowercase().contains(\"deprecated\")\n            });\n\n        assert!(is_unmaintained);\n\n        let normal_vuln = OsvVulnerability {\n            id: \"CVE-2024-1234\".to_string(),\n            summary: Some(\"Buffer overflow vulnerability\".to_string()),\n            details: None,\n            severity: None,\n            references: None,\n            aliases: None,\n        };\n\n        let is_not_unmaintained = normal_vuln.id.starts_with(\"RUSTSEC\")\n            \u0026\u0026 normal_vuln.summary.as_ref().is_some_and(|s| {\n                s.to_lowercase().contains(\"maintained\") || s.to_lowercase().contains(\"deprecated\")\n            });\n\n        assert!(!is_not_unmaintained);\n    }\n\n    #[tokio::test]\n    async fn test_fxhash_deprecated_detection() {\n        let client = OsvClient::new().unwrap();\n\n        let query = VulnerabilityQuery {\n            ecosystem: crate::vulnerabilities::Ecosystem::CratesIo,\n            package_name: \"fxhash\".to_string(),\n            version: \"0.2.1\".to_string(),\n        };\n\n        let results = client.query_batch(\u0026[query]).await.unwrap();\n\n        assert!(!results.is_empty());\n\n        let result = \u0026results[0];\n        assert!(!result.vulnerabilities.is_empty());\n        assert!(result.deprecated, \"fxhash should be marked as deprecated\");\n\n        let vuln = \u0026result.vulnerabilities[0];\n        assert!(vuln.id.starts_with(\"RUSTSEC\"));\n    }\n}\n","traces":[{"line":31,"address":[17097958,17097360,17097964],"length":1,"stats":{"Line":2}},{"line":32,"address":[14605422,14605377,14605169,14605448,14605320],"length":1,"stats":{"Line":8}},{"line":34,"address":[14605254,14605799,14605270,14605328],"length":1,"stats":{"Line":4}},{"line":37,"address":[17097826],"length":1,"stats":{"Line":2}},{"line":38,"address":[12995281,12995212],"length":1,"stats":{"Line":4}},{"line":39,"address":[14605555],"length":1,"stats":{"Line":2}},{"line":43,"address":[12994833,12994827,12994208],"length":1,"stats":{"Line":2}},{"line":44,"address":[12994246],"length":1,"stats":{"Line":2}},{"line":47,"address":[14633398],"length":1,"stats":{"Line":10}},{"line":49,"address":[14604511],"length":1,"stats":{"Line":6}},{"line":51,"address":[14633603,14633465],"length":1,"stats":{"Line":4}},{"line":54,"address":[12994379],"length":1,"stats":{"Line":6}},{"line":55,"address":[12773289,12773280],"length":1,"stats":{"Line":6}},{"line":56,"address":[14633571],"length":1,"stats":{"Line":2}},{"line":58,"address":[14604682],"length":1,"stats":{"Line":2}},{"line":61,"address":[12994490],"length":1,"stats":{"Line":6}},{"line":62,"address":[12994502],"length":1,"stats":{"Line":6}},{"line":64,"address":[12933040],"length":1,"stats":{"Line":6}},{"line":65,"address":[12773518],"length":1,"stats":{"Line":2}},{"line":66,"address":[12993011,12992810,12992992],"length":1,"stats":{"Line":6}},{"line":67,"address":[15739616,15739632,15739066],"length":1,"stats":{"Line":6}},{"line":80,"address":[17100720],"length":1,"stats":{"Line":0}},{"line":81,"address":[12997454],"length":1,"stats":{"Line":0}},{"line":85,"address":[14633056],"length":1,"stats":{"Line":2}},{"line":86,"address":[14604222,14604157],"length":1,"stats":{"Line":4}},{"line":88,"address":[17096490,17096552],"length":1,"stats":{"Line":4}},{"line":89,"address":[17096591,17096520],"length":1,"stats":{"Line":4}},{"line":90,"address":[12994141,12994095],"length":1,"stats":{"Line":4}},{"line":91,"address":[12994134],"length":1,"stats":{"Line":2}},{"line":95,"address":[14604194],"length":1,"stats":{"Line":2}},{"line":103,"address":[14633296],"length":1,"stats":{"Line":2}},{"line":107,"address":[15734368,15734527],"length":1,"stats":{"Line":4}},{"line":108,"address":[15734580,15735172],"length":1,"stats":{"Line":0}},{"line":124,"address":[12987912,12987991],"length":1,"stats":{"Line":4}},{"line":125,"address":[12928391,12927907,12928489,12928860,12929838],"length":1,"stats":{"Line":6}},{"line":127,"address":[12929289,12929360],"length":1,"stats":{"Line":4}},{"line":128,"address":[12929411,12929517],"length":1,"stats":{"Line":0}},{"line":131,"address":[12723176],"length":1,"stats":{"Line":4}},{"line":133,"address":[12990003],"length":1,"stats":{"Line":2}},{"line":135,"address":[12931103,12930474,12930368],"length":1,"stats":{"Line":6}},{"line":136,"address":[15737846,15737959],"length":1,"stats":{"Line":4}},{"line":139,"address":[15737763],"length":1,"stats":{"Line":2}},{"line":141,"address":[12991288],"length":1,"stats":{"Line":2}},{"line":144,"address":[12931920,12931788],"length":1,"stats":{"Line":4}},{"line":147,"address":[12991403],"length":1,"stats":{"Line":2}},{"line":149,"address":[15738878,15738864,15738162],"length":1,"stats":{"Line":6}},{"line":150,"address":[12992387,12991593,12992352],"length":1,"stats":{"Line":6}},{"line":153,"address":[12927949,12930590,12931965,12930624],"length":1,"stats":{"Line":6}},{"line":155,"address":[12990666,12990619],"length":1,"stats":{"Line":4}},{"line":156,"address":[15737301],"length":1,"stats":{"Line":2}},{"line":161,"address":[15737585],"length":1,"stats":{"Line":2}},{"line":164,"address":[12994109,12993088,12993281,12994471,12993119,12993230],"length":1,"stats":{"Line":8}},{"line":165,"address":[12933612,12933503],"length":1,"stats":{"Line":4}},{"line":166,"address":[15739931],"length":1,"stats":{"Line":0}},{"line":169,"address":[12933958],"length":1,"stats":{"Line":0}},{"line":177,"address":[15741550,15740487,15741556,15741008],"length":1,"stats":{"Line":4}},{"line":178,"address":[12994505],"length":1,"stats":{"Line":2}},{"line":179,"address":[12994776,12994707],"length":1,"stats":{"Line":4}},{"line":180,"address":[12994792],"length":1,"stats":{"Line":2}},{"line":182,"address":[15741839,15742072,15741727,15741796,15741696,15743374,15744802,15741378],"length":1,"stats":{"Line":8}},{"line":183,"address":[12995598,12995404,12995245,12995302],"length":1,"stats":{"Line":6}},{"line":184,"address":[15742424],"length":1,"stats":{"Line":2}},{"line":185,"address":[12995817],"length":1,"stats":{"Line":0}},{"line":186,"address":[12936823,12936528,12936121],"length":1,"stats":{"Line":0}},{"line":187,"address":[15743001],"length":1,"stats":{"Line":0}},{"line":191,"address":[15742618,15741847,15742512,15743388],"length":1,"stats":{"Line":6}},{"line":192,"address":[12997206],"length":1,"stats":{"Line":2}},{"line":193,"address":[12937447],"length":1,"stats":{"Line":0}},{"line":194,"address":[12998753,12998500,12997175],"length":1,"stats":{"Line":0}},{"line":195,"address":[15745159],"length":1,"stats":{"Line":0}},{"line":199,"address":[12937590,12937669,12939696],"length":1,"stats":{"Line":6}},{"line":201,"address":[12939710,12939920,12940164,12940158],"length":1,"stats":{"Line":4}},{"line":202,"address":[12939929],"length":1,"stats":{"Line":2}},{"line":203,"address":[12939961,12940023],"length":1,"stats":{"Line":4}},{"line":207,"address":[12939740,12939856],"length":1,"stats":{"Line":4}},{"line":208,"address":[12940176,12939865],"length":1,"stats":{"Line":4}},{"line":209,"address":[12940224,12940201],"length":1,"stats":{"Line":4}},{"line":211,"address":[12999945],"length":1,"stats":{"Line":2}},{"line":212,"address":[12940242,12940265,12940256],"length":1,"stats":{"Line":6}},{"line":217,"address":[12999488],"length":1,"stats":{"Line":2}},{"line":220,"address":[12937706],"length":1,"stats":{"Line":2}},{"line":221,"address":[12997859,12997921,12997460],"length":1,"stats":{"Line":2}},{"line":224,"address":[12938201],"length":1,"stats":{"Line":0}},{"line":225,"address":[12997770],"length":1,"stats":{"Line":0}},{"line":226,"address":[12780128,12778475,12780137],"length":1,"stats":{"Line":0}},{"line":227,"address":[12997823],"length":1,"stats":{"Line":0}},{"line":231,"address":[12937717],"length":1,"stats":{"Line":2}},{"line":237,"address":[15739836,15740533,15740695],"length":1,"stats":{"Line":4}},{"line":240,"address":[12934630,12935382,12935360],"length":1,"stats":{"Line":6}}],"covered":73,"coverable":89},{"path":["/","home","matvei","projets","zed-dependi","dependi-lsp","tests","integration_test.rs"],"content":"//! Integration tests for dependi-lsp\n\nuse dependi_lsp::cache::{MemoryCache, ReadCache, WriteCache};\nuse dependi_lsp::parsers::Parser;\nuse dependi_lsp::parsers::cargo::CargoParser;\nuse dependi_lsp::parsers::npm::NpmParser;\nuse dependi_lsp::providers::inlay_hints::create_inlay_hint;\nuse dependi_lsp::registries::VersionInfo;\n\n/// Test parsing a realistic Cargo.toml file\n#[test]\nfn test_parse_realistic_cargo_toml() {\n    let content = r#\"\n[package]\nname = \"my-awesome-app\"\nversion = \"0.1.0\"\nedition = \"2024\"\nlicense = \"MIT\"\n\n[dependencies]\ntokio = { version = \"1.35\", features = [\"full\"] }\nserde = { version = \"1.0\", features = [\"derive\"] }\nserde_json = \"1.0\"\nreqwest = { version = \"0.12\", features = [\"json\", \"rustls-tls\"], default-features = false }\nanyhow = \"1\"\nthiserror = \"2\"\ntracing = \"0.1\"\n\n[dev-dependencies]\ntokio-test = \"0.4\"\ncriterion = { version = \"0.5\", features = [\"html_reports\"] }\n\n[build-dependencies]\ncc = \"1.0\"\n\"#;\n\n    let parser = CargoParser::new();\n    let deps = parser.parse(content);\n\n    // Should find all dependencies\n    assert_eq!(deps.len(), 10);\n\n    // Check regular dependencies\n    let tokio = deps.iter().find(|d| d.name == \"tokio\").unwrap();\n    assert_eq!(tokio.version, \"1.35\");\n    assert!(!tokio.dev);\n\n    let serde_json = deps.iter().find(|d| d.name == \"serde_json\").unwrap();\n    assert_eq!(serde_json.version, \"1.0\");\n\n    // Check dev dependencies\n    let tokio_test = deps.iter().find(|d| d.name == \"tokio-test\").unwrap();\n    assert!(tokio_test.dev);\n\n    let criterion = deps.iter().find(|d| d.name == \"criterion\").unwrap();\n    assert!(criterion.dev);\n    assert_eq!(criterion.version, \"0.5\");\n\n    // Check build dependencies (treated as regular for now)\n    let cc = deps.iter().find(|d| d.name == \"cc\").unwrap();\n    assert_eq!(cc.version, \"1.0\");\n}\n\n/// Test parsing a realistic package.json file\n#[test]\nfn test_parse_realistic_package_json() {\n    let content = r#\"{\n  \"name\": \"my-react-app\",\n  \"version\": \"1.0.0\",\n  \"description\": \"A sample React application\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"start\": \"react-scripts start\",\n    \"build\": \"react-scripts build\",\n    \"test\": \"react-scripts test\"\n  },\n  \"dependencies\": {\n    \"react\": \"^18.2.0\",\n    \"react-dom\": \"^18.2.0\",\n    \"axios\": \"^1.6.0\",\n    \"@tanstack/react-query\": \"^5.0.0\",\n    \"lodash\": \"^4.17.21\"\n  },\n  \"devDependencies\": {\n    \"@types/react\": \"^18.2.0\",\n    \"@types/react-dom\": \"^18.2.0\",\n    \"typescript\": \"^5.3.0\",\n    \"@testing-library/react\": \"^14.0.0\",\n    \"prettier\": \"^3.1.0\"\n  },\n  \"peerDependencies\": {\n    \"react\": \"\u003e=16.8.0\"\n  }\n}\"#;\n\n    let parser = NpmParser::new();\n    let deps = parser.parse(content);\n\n    // Should find all dependencies\n    assert_eq!(deps.len(), 11);\n\n    // Check regular dependencies\n    let react = deps\n        .iter()\n        .find(|d| d.name == \"react\" \u0026\u0026 !d.optional)\n        .unwrap();\n    assert_eq!(react.version, \"^18.2.0\");\n    assert!(!react.dev);\n\n    // Check scoped packages\n    let react_query = deps\n        .iter()\n        .find(|d| d.name == \"@tanstack/react-query\")\n        .unwrap();\n    assert_eq!(react_query.version, \"^5.0.0\");\n\n    // Check dev dependencies\n    let typescript = deps.iter().find(|d| d.name == \"typescript\").unwrap();\n    assert!(typescript.dev);\n    assert_eq!(typescript.version, \"^5.3.0\");\n\n    // Check peer dependencies (marked as optional)\n    let peer_react = deps\n        .iter()\n        .find(|d| d.name == \"react\" \u0026\u0026 d.optional)\n        .unwrap();\n    assert_eq!(peer_react.version, \"\u003e=16.8.0\");\n}\n\n/// Test cache integration\n#[test]\nfn test_cache_integration() {\n    let cache = MemoryCache::new();\n\n    // Insert some version info\n    let serde_info = VersionInfo {\n        latest: Some(\"1.0.200\".to_string()),\n        latest_prerelease: None,\n        versions: vec![\"1.0.200\".to_string(), \"1.0.199\".to_string()],\n        description: Some(\"A serialization framework\".to_string()),\n        homepage: None,\n        repository: Some(\"https://github.com/serde-rs/serde\".to_string()),\n        license: Some(\"MIT OR Apache-2.0\".to_string()),\n        vulnerabilities: vec![],\n        deprecated: false,\n        yanked: false,\n        yanked_versions: vec![],\n        release_dates: Default::default(),\n    };\n\n    cache.insert(\"crates:serde\".to_string(), serde_info.clone());\n\n    // Retrieve and verify\n    let retrieved = cache.get(\"crates:serde\").unwrap();\n    assert_eq!(retrieved.latest, Some(\"1.0.200\".to_string()));\n    assert_eq!(retrieved.license, Some(\"MIT OR Apache-2.0\".to_string()));\n\n    // Test cache miss\n    assert!(cache.get(\"crates:nonexistent\").is_none());\n}\n\n/// Test inlay hint generation with various scenarios\n#[test]\nfn test_inlay_hint_generation() {\n    use dependi_lsp::parsers::Dependency;\n\n    // Up-to-date dependency\n    let dep_up_to_date = Dependency {\n        name: \"serde\".to_string(),\n        version: \"1.0.200\".to_string(),\n        line: 5,\n        name_start: 0,\n        name_end: 5,\n        version_start: 9,\n        version_end: 18,\n        dev: false,\n        optional: false,\n    };\n\n    let info_up_to_date = VersionInfo {\n        latest: Some(\"1.0.200\".to_string()),\n        ..Default::default()\n    };\n\n    let hint = create_inlay_hint(\u0026dep_up_to_date, Some(\u0026info_up_to_date));\n    match hint.label {\n        tower_lsp::lsp_types::InlayHintLabel::String(s) =\u003e {\n            assert!(s.contains(\"✓\"), \"Expected checkmark for up-to-date dep\");\n        }\n        _ =\u003e panic!(\"Expected string label\"),\n    }\n\n    // Outdated dependency\n    let dep_outdated = Dependency {\n        name: \"tokio\".to_string(),\n        version: \"1.0.0\".to_string(),\n        line: 6,\n        name_start: 0,\n        name_end: 5,\n        version_start: 9,\n        version_end: 16,\n        dev: false,\n        optional: false,\n    };\n\n    let info_outdated = VersionInfo {\n        latest: Some(\"1.35.0\".to_string()),\n        ..Default::default()\n    };\n\n    let hint = create_inlay_hint(\u0026dep_outdated, Some(\u0026info_outdated));\n    match hint.label {\n        tower_lsp::lsp_types::InlayHintLabel::String(s) =\u003e {\n            assert!(s.contains(\"-\u003e\"), \"Expected arrow for outdated dep\");\n            assert!(s.contains(\"1.35.0\"), \"Expected latest version in hint\");\n        }\n        _ =\u003e panic!(\"Expected string label\"),\n    }\n\n    // Unknown version (no info) - shows ? Unknown with troubleshooting tooltip\n    let hint = create_inlay_hint(\u0026dep_outdated, None);\n    match hint.label {\n        tower_lsp::lsp_types::InlayHintLabel::String(s) =\u003e {\n            assert!(\n                s.contains(\"? Unknown\"),\n                \"Expected question mark for unknown/error status\"\n            );\n        }\n        _ =\u003e panic!(\"Expected string label\"),\n    }\n}\n\n/// Test parsing dependencies with various version specifiers\n#[test]\nfn test_version_specifier_parsing() {\n    let cargo_content = r#\"\n[dependencies]\ncaret = \"^1.0\"\ntilde = \"~1.0.0\"\nexact = \"=1.0.0\"\nrange = \"\u003e=1.0, \u003c2.0\"\nwildcard = \"1.*\"\n\"#;\n\n    let parser = CargoParser::new();\n    let deps = parser.parse(cargo_content);\n\n    assert_eq!(deps.len(), 5);\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"caret\").unwrap().version,\n        \"^1.0\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"tilde\").unwrap().version,\n        \"~1.0.0\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"exact\").unwrap().version,\n        \"=1.0.0\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"range\").unwrap().version,\n        \"\u003e=1.0, \u003c2.0\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"wildcard\").unwrap().version,\n        \"1.*\"\n    );\n}\n\n/// Test parsing npm packages with various version formats\n#[test]\nfn test_npm_version_formats() {\n    let content = r#\"{\n  \"dependencies\": {\n    \"caret\": \"^1.0.0\",\n    \"tilde\": \"~1.0.0\",\n    \"range\": \"\u003e=1.0.0 \u003c2.0.0\",\n    \"hyphen\": \"1.0.0 - 2.0.0\",\n    \"exact\": \"1.0.0\",\n    \"latest\": \"*\",\n    \"tag\": \"latest\"\n  }\n}\"#;\n\n    let parser = NpmParser::new();\n    let deps = parser.parse(content);\n\n    assert_eq!(deps.len(), 7);\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"caret\").unwrap().version,\n        \"^1.0.0\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"range\").unwrap().version,\n        \"\u003e=1.0.0 \u003c2.0.0\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"latest\").unwrap().version,\n        \"*\"\n    );\n    assert_eq!(\n        deps.iter().find(|d| d.name == \"tag\").unwrap().version,\n        \"latest\"\n    );\n}\n\n/// Test that positions are correctly tracked\n#[test]\nfn test_dependency_positions() {\n    let content = r#\"[dependencies]\nserde = \"1.0.0\"\ntokio = { version = \"1.35\" }\n\"#;\n\n    let parser = CargoParser::new();\n    let deps = parser.parse(content);\n\n    // serde should be on line 1 (0-indexed)\n    let serde = deps.iter().find(|d| d.name == \"serde\").unwrap();\n    assert_eq!(serde.line, 1);\n\n    // tokio should be on line 2\n    let tokio = deps.iter().find(|d| d.name == \"tokio\").unwrap();\n    assert_eq!(tokio.line, 2);\n}\n","traces":[],"covered":0,"coverable":0}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      },
    };
  });

  return [...folders, ...files.filter(file => file.path.length === 1)];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener('hashchange', () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.slice(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(
      ({current}) => {
        return {current: [...current, file.path[0]]};
      },
      () => this.updateHash(),
    );
  }

  back(file) {
    this.setState(
      ({current}) => {
        return {current: current.slice(0, current.length - 1)};
      },
      () => this.updateHash(),
    );
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e(
    'div',
    {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e(
      'table',
      {className: 'files-list'},
      e('thead', {className: 'files-list__head'}, e('tr', null, e('th', null, 'Path'), e('th', null, 'Coverage'))),
      e(
        'tbody',
        {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile})),
      ),
    ),
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? (file.covered / file.coverable) * 100 : -1;
  const coverageDelta =
    file.prevRun && (file.covered / file.coverable) * 100 - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'tr',
    {
      className:
        'files-list__file' +
        (coverage >= 0 && coverage < 50 ? ' files-list__file_low' : '') +
        (coverage >= 50 && coverage < 80 ? ' files-list__file_medium' : '') +
        (coverage >= 80 ? ' files-list__file_high' : '') +
        (file.is_folder ? ' files-list__file_folder' : ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e(
      'td',
      null,
      file.covered + ' / ' + file.coverable + (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
    ),
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'}, e(FileHeader, {file, onBack}), e(FileContent, {file}));
}

function FileHeader({file, onBack}) {
  const coverage = (file.covered / file.coverable) * 100;
  const coverageDelta = file.prevRun && coverage - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'div',
    {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e(
      'div',
      {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable + (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
      e('input', {id: 'theme-toggle', type: 'checkbox', hidden: true}),
      e('label', {for: 'theme-toggle', id: 'theme-toggle-label'}, '🌙'),
    ),
  );
}

function FileContent({file}) {
  return e(
    'pre',
    {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      const nbHit = covered? trace.stats.Line: 0;
      return e(
        'div',
        { className: 'code-text-container' },
        e(
          'code',
          {
            className: 'code-line' + (covered ? ' code-line_covered' : '') + (uncovered ? ' code-line_uncovered' : ''),
          },
          line
        ),
        e(
          'div',
          { className: 'cover-indicator' + (covered? ' check-cover': '') + (uncovered? ' no-cover': '')},
          e(
            'div',
            { className: (covered? 'stat-line-hit': '')},
            covered? nbHit: ""
          )
        )
      );
    }),
  );
}

(function () {
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData &&
    previousData.files.forEach(file => {
      const path = file.path.slice(commonPath.length).join('/');
      prevFilesMap.set(path, file);
    });

  const files = data.files.map(file => {
    const path = file.path.slice(commonPath.length);
    const {covered = 0, coverable = 0} = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: {covered, coverable},
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    },
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));

  const toggle = document.getElementById('theme-toggle');
  const label = document.getElementById('theme-toggle-label');
  label.textContent = '🌙';

  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.documentElement.setAttribute('data-theme', 'dark');
      label.textContent = '☀️';
    } else {
      document.documentElement.removeAttribute('data-theme');
      label.textContent = '🌙';
    }
  });
})();
</script>
</body>
</html>